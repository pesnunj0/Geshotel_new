Imports System.Data.SqlClient
Imports System.Data.OleDb
Imports System.Data
Imports System.Collections.Generic
Imports System.Threading
Imports System.Xml.Serialization
Imports System.Text
Imports System.Security.Cryptography
Imports System.Configuration
Imports MySql.Data.MySqlClient
Imports System.Collections

'******************************************************************************************************************************************************
'Aqui voy As apuntar los cambios que voy haciendo sobre el original
'    1.- Crear provider para saber si es Mysql o SqlServer. Sigo empeñado en intentar que sean compatibles
'    2.- Reemplazar los IFNULL por COALESCE que sirve para las dos BD
'    3.- Namespace se cambia de Geshotel a Geshotelk para diferenciarlo del otro
'    4.- Select scope_identity() para cambiar select last_insert_id segun sea BD
'    5.- Crear la clase añade connectionString
'    6.- Campos añadidos a Reserva y MetaReserva fecha_creacion,adultos,child_50, child_free, bebes,nombre_reserva, pension_id, tipo_habitacion_id
'    7.- Quitar hora_llegada y hora de salida en Metareserva
'    8.- Cambiar las busquedas en base de datos de hora_prevista_llegada y salida por '12:00:00'
'    9.- CrearClase se añade el parámetro de conexion por si hiciera falta en un futuro
'
'******************************************************************************************************************************************************
Namespace geshotelk
    Public Class GesHotelClase
        Inherits GesHotelClaseUtils
        'Public Shared ultimaMetaReserva As MetaReserva = Nothing
        Private Shared isProduccion As Boolean = True     ' True o False segun sea máquina de produccion o no
        Private Shared ConnectionString As String = ConfigurationManager.ConnectionStrings("Default").ConnectionString & ";TreatTinyAsBoolean=false"
        Public provider As String = ConfigurationManager.ConnectionStrings("Default").ProviderName
        'Private Shared ConnectionString As String = "DSN=GeshotelDB"
        Private Shared radiusConnectionString As String = "DSN=radius"
        Private dingus_cancelacion_reserva_servicio_id = "175"
        Private userId As Integer = 0

        Public metaresid As Integer = -1
        Public metaresidhash As Hashtable
        Private Shared sql_last_insert_id As String = "SELECT LAST_INSERT_ID()"

        Private Function permitirCache() As Boolean
            Return False
        End Function

        Private Function convertFecha(ByVal fec As Date) As String
            Return fec.ToString("yyyy-MM-dd")
        End Function
        Private Function convertTime(ByVal fec As Date) As String
            Return fec.ToString("HH:mm:ss")
        End Function
        Private Function startMeasure() As Object
            Dim x As Date = Now
            Return x
        End Function
        Private Sub stopMeasure(ByVal y As Date)
            Console.WriteLine(Now - y)
        End Sub
        Shared calctimeTable As New Hashtable
        Shared calctimeResult As New Hashtable
        Shared calctimeCount As New Hashtable
        Private Sub calcTime(ByVal p1 As String, ByVal p2 As Boolean)
            If p2 Then
                calctimeTable(p1) = Now.Ticks
            Else
                If Not calctimeResult.ContainsKey(p1) Then
                    calctimeResult(p1) = 0
                    calctimeCount(p1) = 0
                End If
                calctimeResult(p1) += (Now.Ticks - calctimeTable(p1))
                calctimeCount(p1) += 1
            End If
        End Sub
        Public Sub dumpCalcTime()
            Dim ienu As IEnumerator = calctimeResult.Keys.GetEnumerator
            While ienu.MoveNext
                Dim y = calctimeResult(ienu.Current)

                Console.WriteLine(ienu.Current & ":" & (y / TimeSpan.TicksPerSecond) & "(" & calctimeCount(ienu.Current) & ")")
            End While

        End Sub

        Shared cachedClase As GesHotelClase
        Public Shared Function CrearClase(ByVal userid As Integer, con As String) As GesHotelClase

            If IsNothing(cachedClase) Then
                cachedClase = New GesHotelClase(userid)
                'ConnectionString = con
            End If
            Return cachedClase
        End Function
        Shared ListaErrores As New ArrayList
        Private Class ErrroClass
            Public funcion As String
            Public mensaje As String
            Public nivel As Integer
            Public fecha As Date
        End Class
        Public Shared Sub AgregaInfo(ByVal funcion As String, ByVal mensaje As String, ByVal nivel As Integer)
            Dim x As New ErrroClass
            x.funcion = funcion
            x.mensaje = mensaje
            x.nivel = nivel
            x.fecha = Now
            ListaErrores.Add(x)
        End Sub
        Shared sqlVolcadoErrores = "select '' as funcion,'' as mensaje,1 as nivel,now() as fecha from(select 1) drv where 1=0"
        Shared Function volcarErrores(ByVal limpiar As Boolean, ByVal formato As Integer) As Object
            'Dim resultadoTabla As DataSet
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0

            Dim Transaccion As MySqlTransaction
            Dim Conn = New MySqlConnection(ConnectionString)
            Dim cmd = New MySqlCommand

            If Not Conn.State = ConnectionState.Open Then
                Conn.Open()
            End If
            Transaccion = Conn.BeginTransaction(IsolationLevel.Serializable)
            cmd.CommandType = CommandType.Text
            cmd.Connection = Conn
            cmd.Transaction = Transaccion
            Dim resultado As New Text.StringBuilder
            Dim resultadoTabla As New DataSet()
            Try



                cmd.CommandText = sqlVolcadoErrores

                Dim da As MySqlDataAdapter = New MySqlDataAdapter(cmd)
                Dim myDataRowsCommandBuilder = New MySqlCommandBuilder(da)
                da.Fill(resultadoTabla)

                'resultadoTabla = getDataSet(cmd, sqlVolcadoErrores)

                Dim x As Integer
                Dim y As Integer = ListaErrores.Count - 1
                Dim z As ErrroClass
                resultado.Append("Fecha:" & Now)
                For x = 0 To y
                    z = ListaErrores(x)
                    If Not IsNothing(z) Then
                        '                If z.nivel < 0 Then
                        resultado.Append(z.fecha & ":" & z.funcion & "-" & z.mensaje)
                        resultado.AppendLine()
                        Dim row As DataRow = resultadoTabla.Tables(0).Rows.Add
                        row.Item("funcion") = z.funcion
                        row.Item("mensaje") = z.mensaje
                        row.Item("nivel") = z.nivel
                        row.Item("fecha") = z.fecha
                        'End If
                    End If
                Next
                If limpiar Then
                    ListaErrores.Clear()
                End If
            Catch ex As Exception

            End Try
            If Not IsNothing(Transaccion) Then
                If errorCode <> 0 Then
                    Transaccion.Rollback()
                Else
                    Transaccion.Commit()
                    ' Transaccion.Rollback()
                End If
                Conn.Close()
            End If

            If formato = 1 Then
                Return resultadoTabla
            Else
                Return resultado.ToString
            End If

        End Function
        Private Sub LogTime(ByVal funcion, ByVal datos)
            cachedHitsMisses += 1
            AgregaInfo(funcion, datos, 0)
            'Console.WriteLine(funcion & ":" & datos)
            'Console.WriteLine(" ")
        End Sub
        Public Shared typeCachedConnections As New Hashtable()
        'Public Shared stacksofConnections As Hashtable = Nothing
        Public stacksofConnections As Hashtable = New Hashtable
        'Shared cachedConections As New Queue()
        Private Function ObtainConnection(ByVal x As IsolationLevel) As MySqlConnection
            'thread safe?
            Dim conn As MySqlConnection
            Dim xx = IsolationLevel.Serializable
            SyncLock typeCachedConnections
                If Not typeCachedConnections.ContainsKey(xx) Then
                    typeCachedConnections(xx) = New Queue
                End If


                If typeCachedConnections(xx).Count = 0 Then
                    conn = New MySqlConnection(ConnectionString)

                    'Console.WriteLine("creo con")

                Else
                    conn = typeCachedConnections(xx).Dequeue
                End If
                If Not IsNothing(stacksofConnections) Then
                    stacksofConnections(conn.GetHashCode().ToString) = Environment.StackTrace.ToString
                End If

            End SyncLock
            Return conn
        End Function
        Private Sub ReleaseConnection(ByVal conn As MySqlConnection)
            SyncLock typeCachedConnections
                If Not IsNothing(stacksofConnections) Then
                    stacksofConnections.Remove(conn.GetHashCode().ToString)
                End If

                typeCachedConnections(IsolationLevel.Serializable).Enqueue(conn)
            End SyncLock
        End Sub
        Private Function prepareConectionOnlyRead() As MySqlCommand
            Return prepareConection(IsolationLevel.RepeatableRead)
        End Function
        'Shared contimers As New LinkedList(Of Date)
        'Private Sub LogConnection()
        '    contimers.AddLast(Now)
        'End Sub
        'Private Sub unLogConnection()
        '    Try
        '        Dim xxl As TimeSpan = (Now - contimers.Last.Value)
        '        contimers.RemoveLast()
        '        AgregaInfo("conex", xxl.ToString, -1)
        '    Catch ex As Exception
        '        AgregaInfo("conex", "error", -1)
        '    End Try
        '
        '       End Sub
        Private Function prepareConection(Optional ByVal x As IsolationLevel = IsolationLevel.RepeatableRead) As MySqlCommand
            'LogConnection()
            Dim conn As MySqlConnection = ObtainConnection(x)
            Dim cmd As New MySqlCommand

            If Not conn.State = ConnectionState.Open Then
                conn.Open()
            End If
            'Dim Transaccion As MysqlTransaction
            'Transaccion = conn.BeginTransaction(x)
            cmd.CommandType = CommandType.Text
            cmd.Connection = conn
            cmd.Transaction = conn.BeginTransaction(x)

            Return cmd
        End Function

        Private Function Obtiene_ultima_id(ByVal cmd As Object) As Integer

            Dim sql_last_insert_id = "SELECT LAST_INSERT_ID()"
            If provider = "System.Data.SqlClient" Then
                sql_last_insert_id = "SELECT SCOPE_IDENTITY()"
            End If
            Return ExecuteScalar(cmd, sql_last_insert_id)
        End Function
        Private Function flushConection(ByVal cmd As MySqlCommand, ByVal errorCode As Integer) As Boolean
            'unLogConnection()
            Dim retval As Boolean
            If Not IsNothing(cmd.Transaction) Then
                If errorCode <> 0 Then
                    cmd.Transaction.Rollback()
                    retval = False
                Else
                    cmd.Transaction.Commit()
                    retval = True
                    ' Transaccion.Rollback()
                End If
            End If
            ReleaseConnection(cmd.Connection)
            Return retval
        End Function
        ''' <summary>
        ''' Ejecuta el command executeNonQuery con control de errores
        ''' </summary>
        ''' <param name="cmd">Control de transacciones</param>
        ''' <param name="sql">Sentencia sql a ejecutar</param>
        ''' <returns>Numero de filas afectadas por la sentencia o 0 si no la pudo hacer</returns>
        ''' <remarks></remarks>
        '''     
        Private Function ExecuteNonQuery(ByVal cmd As MySqlCommand, ByVal sql As String)

            LogTime("ExecuteNonQuery", sql)
            cmd.CommandText = sql
            Dim rowCount As Integer
            Dim previousConnectionState As ConnectionState
            previousConnectionState = cmd.Connection.State
            Try
                If cmd.Connection.State = ConnectionState.Closed Then
                    cmd.Connection.Open()
                End If
                Dim dt As Date = Now
                rowCount = cmd.ExecuteNonQuery()
                queryMicrosecs += (Now - dt).Ticks
            Catch
                AgregaInfo("ExecuteNonQuery", "Error Query:" & sql, -1)
            Finally
                If previousConnectionState = ConnectionState.Closed Then
                    cmd.Connection.Close()
                End If
            End Try
            Return rowCount
        End Function
        ''' <summary>
        ''' Ejecuta el command execute Escalar con control de errores
        ''' </summary>
        ''' <param name="cmd">Control de transacciones</param>
        ''' <param name="sql">Sentencia sql a ejecutar</param>
        ''' <returns>Deveuelve la primera columna de la primera fila. Objeto Nothing en caso de error</returns>
        ''' <remarks></remarks>
        Private Function ExecuteScalar(ByVal cmd As MySqlCommand, ByVal sql As String)

            LogTime("ExecuteScalar", sql)
            Dim tmp = cmd.CommandText
            cmd.CommandText = sql
            Dim valor = Nothing
            Dim previousConnectionState As ConnectionState
            previousConnectionState = cmd.Connection.State
            Try
                If cmd.Connection.State = ConnectionState.Closed Then
                    cmd.Connection.Open()
                End If
                Dim dt As Date = Now
                valor = cmd.ExecuteScalar
                queryMicrosecs += (Now - dt).Ticks
            Catch
                AgregaInfo("ExecuteScalar", "Error Query:" & sql, -1)
            Finally
                If previousConnectionState = ConnectionState.Closed Then
                    cmd.Connection.Close()
                End If
            End Try
            cmd.CommandText = tmp
            Return valor
        End Function
        Public Shared cachedValues As New Hashtable
        Public Shared cachedHits As Integer = 0
        Public Shared cachedHitsMisses As Integer = 0
        Public Shared borrarHits As Integer = 0
        Public Shared queryMicrosecs As Long = 0
        Shared Sub flushCache()
            olddatosReservaActual = Nothing
            cachedClase = Nothing
            SyncLock cachedValues.SyncRoot
                'End SyncLock
                cachedValues.Clear()
            End SyncLock
            cachedHits = 0
            cachedHitsMisses = 0
            borrarHits = 0
            'contimers = New LinkedList(Of Date)
        End Sub
        Private Function findInCache(ByVal cmd As MySqlCommand, ByVal sql As String, Optional ByVal sufix As String = "")
            'Dim newarray(3) As System.Data.MysqlParameter
            'cmd.Parameters.CopyTo(newarray, 0)
            Dim x As Integer = cmd.Parameters.Count - 1
            Dim y As Integer
            Dim key As New Text.StringBuilder(sql)
            For y = 0 To x
                key.Append(";" & cmd.Parameters(y).ParameterName & "=" & cmd.Parameters(y).Value)
            Next
            key.Append(";" & sufix)
            Dim datos(2) As Object
            datos(0) = key.ToString
            SyncLock cachedValues.SyncRoot
                datos(1) = cachedValues(datos(0))
            End SyncLock
            If Not datos(1) Is Nothing Then
                cachedHits += 1
            End If
            'crear clonaciones si es tipo tables
            Return datos
        End Function
        Private Function ExecuteScalar(ByVal cmd As MySqlCommand, ByVal sql As String, ByVal cached As Boolean)
            If cached And Not permitirCache() Then
                cached = False
            End If
            Dim valor As Object
            valor = findInCache(cmd, sql, "XS")
            If cached And (Not valor(1) Is Nothing) Then
                'cachedHits += 1
                Return valor(1)
            Else
                Dim obj As Object = ExecuteScalar(cmd, sql)
                SyncLock cachedValues.SyncRoot
                    cachedValues(valor(0)) = obj
                End SyncLock
                Return obj
            End If
        End Function
        Private Function readerToTable(ByVal reader As MySqlDataReader) As DataTable
            Dim orders As DataTable = New DataTable("dt_tmp")
            'orders.BeginLoadData()
            orders.Load(reader)
            'orders.EndLoadData()
            Return orders
        End Function
        Private Function readerToTable(ByVal reader As DataTableReader) As DataTable
            Dim orders As DataTable = New DataTable("dt_tmp")
            'orders.BeginLoadData()
            orders.Load(reader)
            'orders.EndLoadData()
            Return orders
        End Function
        Private Function readerToDataTable(ByVal reader As MySqlDataReader) As DataTableReader
            Return readerToTable(reader).CreateDataReader()
        End Function
        Private Function getDataSet(ByVal cmd As MySqlCommand, ByVal sql As String, ByVal ds As DataSet, ByVal name As String)
            LogTime("getDataSet", sql)
            cmd.CommandText = sql
            Dim da As MySqlDataAdapter = New MySqlDataAdapter(cmd)
            Dim myDataRowsCommandBuilder = New MySqlCommandBuilder(da) 'esto pa ke sirve
            Dim dt As Date = Now
            da.Fill(ds, name)
            queryMicrosecs += (Now - dt).Ticks
            Return ds
        End Function
        Private Function getDataView(ByVal cmd As MySqlCommand, ByVal sql As String, ByVal cached As Boolean)
            If cached And Not permitirCache() Then
                cached = False
            End If
            Dim valor As Object = findInCache(cmd, sql, "DV")
            Dim dtv As DataView
            If cached And (Not valor(1) Is Nothing) Then
                dtv = valor(1)
            Else
                dtv = New DataView(getDataSet(cmd, sql).Tables(0))
                SyncLock cachedValues.SyncRoot
                    cachedValues(valor(0)) = dtv
                End SyncLock
            End If
            Return dtv
        End Function
        Private Function getDataSet(ByVal cmd As MySqlCommand, ByVal sql As String, ByVal cached As Boolean)
            If cached And Not permitirCache() Then
                cached = False
            End If
            Dim valor As Object = findInCache(cmd, sql, "DS")
            Dim dtr As DataSet
            If cached And (Not valor(1) Is Nothing) Then
                dtr = valor(1)
            Else
                dtr = getDataSet(cmd, sql)
                SyncLock cachedValues.SyncRoot
                    cachedValues(valor(0)) = dtr
                End SyncLock
            End If
            Return dtr.Copy
        End Function
        Private Function getDataSet(ByVal cmd As MySqlCommand, ByVal sql As String) As DataSet
            'Return getDataSet(cmd, sql, New DataSet(), "tmp")
            LogTime("getDataSet", sql)
            cmd.CommandText = sql
            Dim ds As New DataSet()
            Dim da As MySqlDataAdapter = New MySqlDataAdapter(cmd)
            Dim myDataRowsCommandBuilder = New MySqlCommandBuilder(da)
            Dim dt As Date = Now
            da.Fill(ds)
            queryMicrosecs += (Now - dt).Ticks

            Return ds
        End Function
        Private Function getDataAdapter(ByVal cmd As MySqlCommand, ByVal sql As String) As MySqlDataAdapter
            LogTime("getDataAdapter", sql)
            cmd.CommandText = sql
            Dim ds As New DataSet()
            Dim da As MySqlDataAdapter = New MySqlDataAdapter(cmd)
            Dim myDataRowsCommandBuilder As MySqlCommandBuilder = New MySqlCommandBuilder(da)
            myDataRowsCommandBuilder.ConflictOption = ConflictOption.OverwriteChanges
            'da.Fill(ds, "tmp")
            Return da
        End Function
        Private Function getTable(ByVal cmd As MySqlCommand, ByVal sql As String) As DataTable
            LogTime("getTable", sql)
            Dim reader As DataTable = Nothing
            cmd.CommandText = sql
            Dim previousConnectionState As ConnectionState = cmd.Connection.State

            Try
                If cmd.Connection.State = ConnectionState.Closed Then
                    cmd.Connection.Open()
                End If
                Dim dt As Date = Now
                reader = readerToTable(cmd.ExecuteReader())
                queryMicrosecs += (Now - dt).Ticks
            Catch ex As Exception
                AgregaInfo("getTable", "Error Query:" & sql, -1)
            Finally
                If previousConnectionState = ConnectionState.Closed Then
                    cmd.Connection.Close()
                End If
            End Try



            Return reader
        End Function
        Private Function getTable(ByVal cmd As MySqlCommand, ByVal sql As String, ByVal cached As Boolean) As DataTable
            If cached And Not permitirCache() Then
                cached = False
            End If
            Dim valor As Object = findInCache(cmd, sql, "TA")
            Dim dtr As DataTable
            If cached And (Not valor(1) Is Nothing) Then
                'Console.WriteLine("hit-" & cachedHits)
                dtr = valor(1)
                Return dtr.Copy() 'error grave del copon..deberia ser copy
            Else
                dtr = getTable(cmd, sql)
                SyncLock cachedValues.SyncRoot
                    cachedValues(valor(0)) = dtr
                End SyncLock
                Return dtr.Copy()
            End If
        End Function
        Private Function getDataTable(ByVal cmd As MySqlCommand, ByVal sql As String) As DataTableReader
            'Console.WriteLine(sql)
            LogTime("getDataTableSinCache", sql)
            Dim reader As DataTableReader = Nothing
            cmd.CommandText = sql
            Dim previousConnectionState As ConnectionState = cmd.Connection.State
            Try
                If cmd.Connection.State = ConnectionState.Closed Then
                    cmd.Connection.Open()
                End If
                Dim dt As Date = Now
                reader = readerToDataTable(cmd.ExecuteReader())
                queryMicrosecs += (Now - dt).Ticks
            Catch
                AgregaInfo("getDataTable", "Error Query:" & sql, -1)
            Finally
                If previousConnectionState = ConnectionState.Closed Then
                    cmd.Connection.Close()
                End If
            End Try
            Return reader
        End Function
        Private Function getDataTable(ByVal cmd As MySqlCommand, ByVal sql As String, ByVal cached As Boolean) As DataTableReader
            If cached And Not permitirCache() Then
                cached = False
            End If
            Dim valor As Object = findInCache(cmd, sql, "DT")
            Dim dtr As DataTable
            If cached And (Not valor(1) Is Nothing) Then
                dtr = valor(1)
            Else
                dtr = getTable(cmd, sql)
                SyncLock cachedValues.SyncRoot
                    cachedValues(valor(0)) = dtr
                End SyncLock
            End If

            Return dtr.CreateDataReader
        End Function
        Public Sub ObtieneDatosScannerConnect(ByVal state As System.IAsyncResult)

        End Sub
        Public Function ObtieneDatosScanner(ByVal hotel_id As Integer, ByVal tipo As String, Optional ByVal hosti As String = Nothing) As String






            Dim xmlEnvio As String = "" _
& "<?xml version='1.0' encoding='UTF-8'?>" _
& "<NAH>" _
& "<version>1.0</version>" _
& "<Request id='2'>" _
& "<Operation>" _
& "<Type>READ_DOCUMENT</Type>" _
& "<Data encoding='UTF-8' hexadecimal='false' name='TypeOfDocument'>" & tipo & "</Data>" _
& "</Operation>" _
& "</Request>" _
& "</NAH>"
            xmlEnvio = xmlEnvio.Replace("'", Chr(34))
            Dim returndata As String = ""
            Dim host As String = "10.0.0.74"
            If Not IsNothing(hosti) Then
                host = hosti
            End If
            'abrir socket
            Dim state As AutoResetEvent = New AutoResetEvent(False)
            Dim tcpClient As New System.Net.Sockets.TcpClient()
            Dim IPs() As Net.IPAddress = Net.Dns.GetHostAddresses(host)
            state.Reset()
            tcpClient.BeginConnect(IPs, 5254, New AsyncCallback(AddressOf ObtieneDatosScannerConnect), state)
            state.WaitOne(3000)

            If tcpClient.Connected Then
                Dim networkStream As Net.Sockets.NetworkStream = tcpClient.GetStream()
                If networkStream.CanWrite And networkStream.CanRead Then
                    'enviar peticion
                    Dim sendBytes As [Byte]() = Text.Encoding.ASCII.GetBytes(xmlEnvio)
                    networkStream.Write(sendBytes, 0, sendBytes.Length)

                    Dim bytes(tcpClient.ReceiveBufferSize) As Byte
                    'leer respuesta en un timeout
                    Dim readed As Integer = networkStream.Read(bytes, 0, CInt(tcpClient.ReceiveBufferSize))
                    ' Output the data received from the host to the console.
                    returndata = Text.Encoding.ASCII.GetString(bytes, 0, readed)
                    'Console.WriteLine(("Host returned: " + returndata))

                End If
                'cerrar socket
                tcpClient.Close()
            End If
            '            System.Diagnostics.Process.Start("lanzador", "")
            Return returndata
        End Function
        Dim sqlInsertaFicheroReserva = "insert into ficheros_reserva(titulo,url_fichero,user_id,fecha_modificacion,reserva_id) values(?,?,?,now(),?)"
        Dim sqlInsertaFicheroContrato = "insert into ficheros_contrato(titulo,url_fichero,user_id,fecha_modificacion,contrato_id) values(?,?,?,now(),?)"
        Public Function importaFicheroScanner(ByVal tabla As String, ByVal valor As Integer, ByVal titulo As String, ByVal file As String)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                Dim tituloParam As New MySqlParameter("@titulo", titulo)
                Dim url_ficheroParam As New MySqlParameter("@url_fichero", file)
                Dim user_idParam As New MySqlParameter("@user_id", userId)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(tituloParam)
                cmd.Parameters.Add(url_ficheroParam)
                cmd.Parameters.Add(user_idParam)
                Dim sqlquery As String = ""
                If tabla = "reserva" Then
                    Dim reserva_idParam As New MySqlParameter("@reserva_id", valor)
                    cmd.Parameters.Add(reserva_idParam)
                    sqlquery = sqlInsertaFicheroReserva
                End If
                If tabla = "contrato" Then
                    Dim contrato_idParam As New MySqlParameter("@contrato_id", valor)
                    cmd.Parameters.Add(contrato_idParam)
                    sqlquery = sqlInsertaFicheroContrato
                End If
                If sqlquery <> "" Then
                    If ExecuteNonQuery(cmd, sqlquery) = 1 Then
                        retVal = True
                    End If
                Else
                    errorCode = -3
                End If
            Catch ex As Exception
                errorCode = -1
            End Try
            If Not retVal Then
                errorCode = -2
            End If
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Public Class UCS
            Public unidad_calculo_id As Integer
            Public cantidad As Single
        End Class
        Public Class MetaHuesped
            'Public reserva_id As Integer
            Public empresa_id As Integer
            Public cliente_id As Integer
            Public razon As String
            Public sexo_id As Char
            Public tipo_documento_id As Char
            Public nif As String
            Public fecha_documento As Object = Nothing
            Public fecha_nacimiento As Object = Nothing
            Public nacion_id As Integer
            Public tipo_huesped_id As Integer
            Public habitacion_id As Object
            Public fecha_llegada As Date
            Public fecha_salida As Object = Nothing
            Public agregado As Boolean = False
            Public habitacion As Object
            Public acepta_lopd As Boolean = False
            Public direccion As Object = Nothing
            Public poblacion As Object = Nothing
            Public provincia_id As Object = Nothing
            Public foto1 As Object = Nothing
            Public foto2 As Object = Nothing

            Public email As String

            Public telefono As String
            Public contacto As String

        End Class
        Public Class MetaReserva
            Public errores As String
            Public habitacion As Object
            Public habitacion_id As Object
            Public hotel_id As Integer
            Public cliente_id As Integer
            Public cliente_id_factura As Integer
            Public fecha_reserva As Date
            Public canal_reserva_id As Integer
            Public bloquear_tarifa As Boolean
            Public vip As Boolean
            Public fecha_prevista_llegada As DateTime
            'Public hora_prevista_llegada As String
            Public fecha_prevista_salida As DateTime
            'Public hora_prevista_salida As String
            Public bono_referencia As String
            Public bono_online As String
            Public permite_devolucion As Boolean
            Public habitacion_servicio_id As Integer
            Public numero_habitaciones As Integer
            Public pension_servicio_id As Integer
            'Public unidades_calculos As List(Of UCS)
            Public unidades_calculos() As UCS
            Public observaciones As String
            Public codigo_oferta As String = ""
            Public contract_id As String = ""
            Public huespedes() As MetaHuesped
            'datos tarjeta
            Public tipo_tarjeta_id As Integer
            Public tarjeta_credito As String
            Public caducidad As String
            Public cod_seguridad As String
            Public email As String
            'check_reservas
            Public paro_ventas As Boolean
            Public cupos As String
            Public release As Boolean
            Public valor As Double
            Public reserva_Dingus As Dingus.BookingRS
            Friend reserva_Dingus_tipo As Integer

            Friend reserva_Dingus_impuestos_incluidos As Integer

            Friend reserva_Dingus_comision As Decimal

            Public num_camas_extras As Integer
            ' Añadidos nuevo Geshotel
            Public nombre_reserva As String
            Public fecha_llegada As Date
            Public fecha_salida As Date
            Public fecha_creacion As DateTime
            Public tipo_habitacion_id As Integer
            Public pension_id As Int16
            Public adultos As Int16
            Public child_50 As Int16
            Public child_free As Int16
            Public bebes As Int16
            Public estado_reserva_id As Int16
            Public ficheros As String
            ' Fin añadidos nuevo geshotel
        End Class

        Shared sqlBaseDatasetMetaHuesped = "" _
& " SELECT 0 as reserva_id, 0 as cliente_id, 0 as  tipo_huesped_id," _
& " '' as razon, 0 AS clientes_cliente_id, 0 AS habitacion_id_defecto," _
& " '' as nif, now() as fecha_documento,now() AS fecha_llegada, '' as sexo_id, 0 as nacion_id, now() as fecha_nacimiento"
        Public Function ObtieneDataSetMetaHuespedes(ByVal huespedes() As MetaHuesped) As DataSet
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim datos As DataSet = Me.getDataSet(cmd, sqlBaseDatasetMetaHuesped)
            datos.Tables(0).Rows(0).Delete()
            datos.Tables(0).AcceptChanges()
            Try
                Dim x
                For x = 0 To huespedes.Length '- 1
                    Dim row As DataRow = datos.Tables(0).Rows.Add()
                    row.Item("reserva_id") = 0
                    row.Item("razon") = huespedes(x).razon
                    row.Item("cliente_id") = huespedes(x).cliente_id
                    row.Item("tipo_huesped_id") = huespedes(x).tipo_huesped_id
                    row.Item("clientes_cliente_id") = huespedes(x).cliente_id
                    row.Item("habitacion_id_defecto") = 0
                    If Not IsNothing(huespedes(x).habitacion_id) Then
                        If IsNumeric(huespedes(x).habitacion_id) Then
                            row.Item("habitacion_id_defecto") = huespedes(x).habitacion_id
                        End If
                    End If

                    row.Item("nif") = huespedes(x).nif
                    If IsDate(huespedes(x).fecha_documento) Then
                        row.Item("fecha_documento") = CDate(huespedes(x).fecha_documento)
                    End If
                    row.Item("sexo_id") = huespedes(x).sexo_id
                    row.Item("nacion_id") = huespedes(x).nacion_id
                    If IsDate(huespedes(x).fecha_nacimiento) Then
                        row.Item("fecha_nacimiento") = CDate(huespedes(x).fecha_nacimiento)
                    End If
                    If IsDate(huespedes(x).fecha_llegada) Then
                        row.Item("fecha_llegada") = CDate(huespedes(x).fecha_llegada)
                    End If
                Next
            Catch ex As Exception

            End Try
            flushConection(cmd, errorCode)
            'AgregaInfo("actualizaHuespedesReserva", "sali", -1)
            Return datos


        End Function
        Shared sqlObtieneGrupoHuespedPorEmpresa = "" _
& " SELECT grupos_de_cliente.empresa_Id," _
& " grupos_de_cliente.grupo_cliente_id " _
& " FROM " _
& " grupos_de_cliente " _
& " WHERE " _
& " grupos_de_cliente.huesped =  1 "
        Shared sqlCabHuespedes = "SELECT * FROM reservas_huespedes WHERE reserva_id=?"
        Private Function volcarHuesped(ByVal huesped As MetaHuesped) As String
            Dim tmp As New ArrayList
            tmp.Add("cliente_id:" & huesped.cliente_id)
            tmp.Add("empresa_id:" & huesped.empresa_id)
            tmp.Add("fecha_documento:" & huesped.fecha_documento)
            tmp.Add("fecha_llegada:" & huesped.fecha_llegada)
            tmp.Add("fecha_nacimiento:" & huesped.fecha_nacimiento)
            tmp.Add("fecha_salida:" & huesped.fecha_salida)
            tmp.Add("habitacion_id:" & huesped.habitacion_id)
            tmp.Add("nacion_id:" & huesped.nacion_id)
            tmp.Add("nif:" & huesped.nif)
            tmp.Add("razon:" & huesped.razon)
            tmp.Add("sexo_id:" & huesped.sexo_id)
            tmp.Add("tipo_huesped_id:" & huesped.tipo_huesped_id)

            Dim tmp1 As String = ""
            Dim x As Integer
            For x = 0 To tmp.Count - 1
                tmp1 += tmp(x) & "<br>"
            Next
            Return tmp1
        End Function
        Public Function actualizaHuespedesReserva(ByVal reserva_id As Integer, ByVal huespedes() As MetaHuesped)
            Dim errorCode As Integer = 0
            Dim retVal As Boolean = False
            Dim cmd As MySqlCommand = prepareConection()
            retVal = actualizaHuespedesReserva(cmd, reserva_id, huespedes)
            If retVal = False Then
                errorCode = 1
            End If
            flushConection(cmd, errorCode)
            Return retVal
        End Function

        Private Function actualizaHuespedesReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal huespedes() As MetaHuesped) As Boolean
            'AgregaInfo("actualizaHuespedesReserva", "entre", -1)

            Dim retVal As Boolean = True
            Dim errorCode As Integer = 0

            Dim grupos_clientes As DataSet = Me.getDataSet(cmd, sqlObtieneGrupoHuespedPorEmpresa)

            Dim cliente_idParam As New MySqlParameter("@cliente_id", 0)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(cliente_idParam)
            Dim clientes As DataSet = getDataSet(cmd, sqlCabCliente)
            getDataSet(cmd, sqlCabCliente, clientes, "clientesold")
            Try
                Dim x As Integer
                Dim writer As MySqlDataAdapter
                For x = 0 To huespedes.Length - 1
                    Dim row As DataRow
                    If errorCode = 0 And Not IsNothing(huespedes(x).razon) Then
                        'And Not (huespedes(x).cliente_id = 0 And huespedes(x).razon = "") Then
                        row = Nothing
                        'AgregaInfo("actualizaHuespedesReserva", "Reserva:" & reserva_id & "<br>" & volcarHuesped(huespedes(x)), -1)
                        If huespedes(x).razon <> "" And huespedes(x).nif <> "" Then
                            'comprueba_cliente_duplicado(cmd, huespedes, x, reserva_id)
                        End If
                        If huespedes(x).cliente_id = 0 And huespedes(x).razon <> "" Then
                            'no hay id de cliente asi que crea el registro en la tabla de clientes
                            row = clientes.Tables(0).Rows.Add
                            huespedes(x).agregado = True
                        Else
                            cliente_idParam.Value = huespedes(x).cliente_id
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente_idParam)
                            Dim tmp As DataSet = getDataSet(cmd, sqlCabCliente, clientes, "clientesold")
                            Dim clitmp() As DataRow = tmp.Tables("clientesold").Select("cliente_id=" & huespedes(x).cliente_id)
                            If clitmp.Length > 0 Then
                                row = clitmp(0)
                            Else
                                errorCode = 3
                                AgregaInfo("actualizaHuespedesReserva", "No encuentro el cliente:" & huespedes(x).cliente_id, -errorCode)
                            End If
                            'row = tmp.Tables("clientesold").Rows(tmp.Tables("clientesold").Rows.Count)
                        End If
                        'actualiza campos cliente
                        If Not IsNothing(row) Then
                            Dim grupos() As DataRow = grupos_clientes.Tables(0).Select("empresa_id=" & huespedes(x).empresa_id)
                            If grupos.Length > 0 Then
                                row.Item("grupo_cliente_id") = grupos(0).Item("grupo_cliente_id")
                                row.Item("empresa_id") = huespedes(x).empresa_id
                                row.Item("razon") = huespedes(x).razon
                                Try
                                    row.Item("contacto") = huespedes(x).contacto
                                Catch ex As Exception

                                End Try

                                row.Item("Cliente_huesped") = 0 'sino peta
                                If Not IsNothing(huespedes(x).foto1) Then
                                    If huespedes(x).foto1 <> "" Then
                                        row.Item("foto1") = huespedes(x).foto1
                                    End If
                                End If
                                If Not IsNothing(huespedes(x).foto2) Then
                                    If huespedes(x).foto2 <> "" Then
                                        row.Item("foto2") = huespedes(x).foto2
                                    End If
                                End If

                                If Not IsDBNull(huespedes(x).direccion) AndAlso IsNothing(huespedes(x).direccion) Then
                                    If huespedes(x).direccion <> "" Then
                                        row.Item("direccion") = huespedes(x).direccion
                                    End If
                                End If

                                If Not IsDBNull(huespedes(x).poblacion) AndAlso Not IsNothing(huespedes(x).poblacion) Then
                                    If huespedes(x).poblacion <> "" Then
                                        row.Item("poblacion") = huespedes(x).poblacion
                                    End If
                                End If

                                If Not IsNothing(huespedes(x).provincia_id) Then
                                    'If huespedes(x).provincia_id <> "" Then
                                    row.Item("provincia_id") = huespedes(x).provincia_id
                                    'End If
                                End If

                                If Not IsDBNull(huespedes(x).sexo_id) AndAlso Not IsNothing(huespedes(x).sexo_id) Then
                                    If huespedes(x).sexo_id <> "" Then
                                        row.Item("sexo_id") = huespedes(x).sexo_id
                                    End If
                                End If
                                If Not IsDBNull(huespedes(x).tipo_documento_id) AndAlso Not IsNothing(huespedes(x).tipo_documento_id) Then
                                    If huespedes(x).tipo_documento_id <> "" Then
                                        row.Item("tipo_documento_id") = huespedes(x).tipo_documento_id
                                    End If

                                End If
                                'cambio para hdhotels pezuñas de tano
                                Try
                                    If Not IsDBNull(huespedes(x).email) AndAlso Not IsNothing(huespedes(x).email) Then
                                        If huespedes(x).email <> "" Then
                                            row.Item("email") = huespedes(x).email
                                        End If

                                    End If
                                Catch ex As Exception

                                End Try
                                row.Item("nif") = huespedes(x).nif
                                row.Item("fecha_documento") = DBNull.Value
                                row.Item("fecha_nacimiento") = DBNull.Value
                                If Not IsDBNull(huespedes(x).fecha_documento) AndAlso Not IsNothing(huespedes(x).fecha_documento) Then
                                    row.Item("fecha_documento") = huespedes(x).fecha_documento
                                End If
                                If Not IsDBNull(huespedes(x).fecha_nacimiento) AndAlso Not IsNothing(huespedes(x).fecha_nacimiento) Then
                                    row.Item("fecha_nacimiento") = huespedes(x).fecha_nacimiento
                                End If
                                If huespedes(x).nacion_id <> 0 Then
                                    row.Item("nacion_id") = huespedes(x).nacion_id
                                End If
                                'acepta_lopd
                                If Not IsDBNull(huespedes(x).acepta_lopd) Then
                                    If huespedes(x).acepta_lopd Then
                                        If row.IsNull("acepta_lopd") Then
                                            row.Item("acepta_lopd") = Now()
                                        Else
                                            'ya tenia fecha de aceptacion.
                                        End If
                                    Else
                                        If Not row.IsNull("acepta_lopd") Then
                                            row.Item("acepta_lopd") = DBNull.Value
                                        End If
                                    End If
                                End If
                                row.Item("user_id") = userId
                                row.Item("fecha_modificacion") = Now
                                If row.RowState = DataRowState.Added Then
                                    'crear el registro y obtener el id

                                    writer = getDataAdapter(cmd, sqlCabCliente)
                                    writer.Fill(clientes.Tables(0))
                                    writer.Update(clientes.Tables(0))
                                    row.AcceptChanges()
                                    'obtener el ultimo registro insertado
                                    Dim cliente_id As Integer = Obtiene_ultima_id(cmd)
                                    If cliente_id <> 0 Then
                                        row.Item("cliente_id") = cliente_id
                                        huespedes(x).cliente_id = cliente_id
                                        'row.SetModified()
                                        'cambiar el estado a updated
                                    Else
                                        errorCode = 4
                                        AgregaInfo("actualizaHuespedesReserva", "No puedo crear cliente:", -errorCode)

                                    End If

                                End If
                            Else
                                errorCode = 2
                                AgregaInfo("actualizaHuespedesReserva", "Empresa no tiene al menos un grupo de cliente Huesped:" & huespedes(x).empresa_id, -errorCode)
                            End If
                        End If
                    End If
                Next
                'actualizar campos clientes ya existentes
                If errorCode = 0 Then


                    writer = getDataAdapter(cmd, sqlCabCliente)
                    writer.Fill(clientes.Tables("clientesold"))
                    writer.Update(clientes.Tables("clientesold"))

                    'actualiza campos reservas_huespedes
                    'crea lineas nuevas de clientes creados
                    Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(reserva_idParam)
                    'obtiene hotel de la reserva
                    Dim hotel_id As Integer = 0
                    Try
                        Dim DSreserva As DataSet = getDataSet(cmd, sqlCabReserva)
                        hotel_id = DSreserva.Tables(0).Rows(0)("hotel_id")
                    Catch ex As Exception

                    End Try
                    Dim DShuespedes As DataSet = getDataSet(cmd, sqlCabHuespedes)  'SELECT * FROM reservas_huespedes WHERE reserva_id=?

                    Dim y As Integer
                    For y = 0 To huespedes.Length - 1
                        Dim row As DataRow = Nothing
                        If huespedes(y).agregado Then
                            row = DShuespedes.Tables(0).Rows.Add()
                        Else
                            'encuentra la posile fila...cliente_id,fecha_llegada
                            Dim rows() As DataRow = DShuespedes.Tables(0).Select("cliente_id=" & huespedes(y).cliente_id)
                            If rows.Length = 1 Then
                                'solo hay uno..asi ke es ese
                                row = rows(0)
                            Else
                                If rows.Length = 0 Then
                                    'no hay nada que agregar
                                    row = DShuespedes.Tables(0).Rows.Add()
                                Else
                                    'hay mas de uno...buscar por fecha llegad y quedarse con el ultimo
                                    Dim z As Integer
                                    For z = 0 To rows.Length - 1
                                        If rows(z).Item("fecha_llegada") = huespedes(y).fecha_llegada Then
                                            row = rows(z)
                                        End If
                                    Next
                                End If
                            End If
                        End If
                        If Not IsNothing(row) And huespedes(y).tipo_huesped_id > 0 Then
                            row("reserva_id") = reserva_id
                            row("cliente_id") = huespedes(y).cliente_id
                            row("fecha_llegada") = huespedes(y).fecha_llegada
                            row("fecha_salida") = DBNull.Value
                            If Not IsNothing(huespedes(y).fecha_salida) Then
                                row("fecha_salida") = huespedes(y).fecha_salida
                            End If
                            row("habitacion_id") = DBNull.Value
                            If Not IsNothing(huespedes(y).habitacion) Then
                                huespedes(y).habitacion_id = ObtieneHabitacion_Id(cmd, hotel_id, huespedes(y).habitacion)
                            End If

                            If Not IsNothing(huespedes(y).habitacion_id) Then
                                If huespedes(y).habitacion_id > 0 Then
                                    row("habitacion_id") = huespedes(y).habitacion_id
                                End If
                            End If
                            row("tipo_huesped_id") = huespedes(y).tipo_huesped_id
                        Else
                            errorCode = 5
                            AgregaInfo("actualizaHuespedesReserva", "Fallo al asignar huespedes:", -errorCode)
                        End If
                    Next
                    If errorCode = 0 Then
                        writer = getDataAdapter(cmd, sqlCabHuespedes) ' Parece que aqui hay que borrar el data adapter
                        writer.Fill(DShuespedes.Tables(0))
                        writer.Update(DShuespedes.Tables(0))
                    End If
                End If
                'actualiza los clientes que ya existian
            Catch ex As Exception
                errorCode = 1
                'ex.Message
                AgregaInfo("actualizaHuespedesReserva", "Error al actualizar huespedes en reservas:" + ex.Message, -errorCode)
            End Try
            If errorCode <> 0 Then
                retVal = False
            End If
            Return retVal

        End Function
        Shared sqlObtieneClienteFacturaReserva = "" _
& " SELECT" _
& " Coalesce(reservas.cliente_id_factura,case clientes.permite_credito when 1 then reservas.cliente_id else Coalesce((Select Min(reservas_huespedes.cliente_id) From reservas_huespedes where reservas_huespedes.reserva_id=reservas.reserva_id),reservas.cliente_id) end   ) as cliente_id" _
& " FROM " _
& " reservas " _
& " Left Join clientes ON reservas.cliente_id = clientes.cliente_id " _
& " WHERE " _
& " reservas.reserva_id =  ?"
        Shared sqlObtieneClienteFacturaReservaLenta = "" _
& " SELECT" _
& " Coalesce(reservas.cliente_id_factura,case clientes.permite_credito when 1 then reservas.cliente_id else Coalesce(reservas_primer_huesped.cliente_id,reservas.cliente_id) end   ) as cliente_id" _
& " FROM " _
& " reservas " _
& " Left Join reservas_primer_huesped ON reservas.reserva_id = reservas_primer_huesped.reserva_id " _
& " Left Join clientes ON reservas.cliente_id = clientes.cliente_id " _
& " WHERE " _
& " reservas.reserva_id =  ?"

        Function ObtieneClienteFacturaReserva(ByVal reserva_id As Integer) As Integer
            Dim retVal As Integer = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                retVal = ExecuteScalar(cmd, sqlObtieneClienteFacturaReserva)
            Catch ex As Exception
                errorCode = 1
                AgregaInfo("ObtienePendienteAnticipoReserva", "Error al obtener el pendiente de la reserva:" & reserva_id, -errorCode)
            End Try
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        '        Shared sqlObtienePendienteAnticiposReserva = "" _
        '& " select sum(tot)" _
        '& "  from (" _
        '& " select anticipos.importe " _
        '& " -(select Coalesce(sum(importe),0) from lineas_anticipo l where l.anticipo_id=anticipos.anticipo_id) " _
        '& " -(select Coalesce(sum(importe),0) from anticipos a where a.anticipo_padre_id=anticipos.anticipo_id)  " _
        '& " as tot  " _
        '& " from anticipos  " _
        '& " where anticipos.reserva_id=?  " _
        '& " group by anticipos.anticipo_id)  " _
        '& " drvanti "
        ' Javier Nuñez ENERO 2012
        Shared sqlObtienePendienteAnticiposReserva = " SELECT Importe_Total as facturado, " _
        & "(SELECT SUM(lineas_cobro.importe) FROM lineas_cobro Where lineas_cobro.factura_id=facturas.factura_id) As cobrado " _
        & "FROM facturas WHERE facturas.reserva_id =? AND facturas.serie_id IN (4, 5) "



        Public Function ObtienePendienteAnticipoReserva(ByVal reserva_id As String) As Single
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                retVal = ObtienePendienteAnticipoReserva(cmd, reserva_id)
            Catch ex As Exception
                errorCode = 1
                AgregaInfo("ObtienePendienteAnticipoReserva", "Error al obtener el pendiente de la reserva:" & reserva_id, -errorCode)
            End Try
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Private Function ObtienePendienteAnticipoReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As String) As Single
            Dim retVal As Single = 0
            Dim res As Integer = reserva_id
            Dim reserva_idParam As New MySqlParameter("@reserva_id", res)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Try
                Dim reader As DataTableReader = getDataTable(cmd, sqlObtienePendienteAnticiposReserva)

                While reader.Read
                    Dim facturado As Single = 0
                    Dim cobrado As Single = 0
                    If Not IsDBNull(reader.Item("facturado")) Then
                        facturado = reader.Item("facturado")
                    End If
                    If Not IsDBNull(reader.Item("cobrado")) Then
                        cobrado = reader.Item("cobrado")
                    End If
                    retVal += facturado - cobrado
                End While
                'retVal = Me.ExecuteScalar(cmd, sqlObtienePendienteAnticiposReserva)
            Catch ex As Exception
                AgregaInfo("ObtienePendienteAnticipoReserva", "Error al obtener el pendiente de la reserva:" & reserva_id, -2)
            End Try

            Return retVal
        End Function
        Shared sqlObtieneMovAnticipos = "" _
& " SELECT tipos_anticipo.serie_id," _
& " tipos_anticipo.tipo_movimiento_id,anticipos.reserva_id, " _
& " anticipos.hotel_id,anticipos.cliente_id,anticipos.fecha, anticipos.descripcion,anticipos.tipo_anticipo_id," _
& " anticipos.caja_id, " _
& " anticipos.importe, " _
& " anticipos.anticipo_id, " _
& " anticipos.forma_pago_id " _
& " FROM " _
& " anticipos " _
& " Inner Join tipos_anticipo ON anticipos.tipo_anticipo_id = tipos_anticipo.tipo_anticipo_id " _
& " WHERE " _
& " anticipos.anticipo_id =  ? AND " _
& " anticipos.estado_id is null "

        Shared sqlAnticipoReserva = "" _
& " SELECT" _
& " reservas.hotel_id," _
& " reservas.cliente_id," _
& " reservas.cliente_id_factura," _
& " cajas.caja_id" _
& " FROM " _
& " reservas" _
& " Inner Join cajas ON reservas.hotel_id = cajas.hotel_id" _
& " WHERE" _
& " cajas.cierre_dia = 1 AND" _
& " reservas.reserva_id = ?"
        Shared sqlObtieneAnticiposReservaDingus = "" _
& " SELECT " _
& " sum(anticipos.importe) as total" _
& " FROM " _
& " anticipos " _
& " WHERE " _
& " anticipos.reserva_id =  ? " 'todo filtrar por tipo o por ke?
        Shared sqlFormasDePagoDingus As String = "" _
& " SELECT " _
& " min(formas_de_pago.forma_pago_id)" _
& " FROM" _
& " formas_de_pago" _
& " Inner Join formas_pago_hotel ON formas_de_pago.forma_pago_id = formas_pago_hotel.forma_pago_id" _
& " WHERE" _
& " formas_de_pago.sw_dingus = 1 AND" _
& " formas_pago_hotel.hotel_id = ?"
        Public Function CrearAnticipoReserva(ByVal reserva_id As Integer, ByVal importe As Decimal)
            Dim retVal As Integer = -1
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            errorCode = CrearAnticipoReserva(cmd, reserva_id, importe)
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Public Function CrearAnticipoReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal importe As Decimal)
            'sacar de la reserva..hotel_id,cliente_id,caja_id
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Add(reserva_idParam)
            Dim total As Object = ExecuteScalar(cmd, sqlObtieneAnticiposReservaDingus) 'obtener la suma de todos los anticipos
            If IsNothing(total) Or IsDBNull(total) Then
                total = 0
            End If
            If total <> importe Then
                Dim reader As DataTableReader = getDataTable(cmd, sqlAnticipoReserva)
                While reader.Read
                    'al menos un registro
                    Dim fecha As Date = FechaHotel(cmd, reader("hotel_id"))
                    If EstaCajaAbierta(cmd, reader("caja_id"), fecha) Then

                        'obtiene forma pago dingus
                        cmd.Parameters.Clear()
                        Dim hotel_idParam As New MySqlParameter("@hotel_id", reader("hotel_id"))
                        cmd.Parameters.Add(hotel_idParam)
                        Dim forma_pago_id = ExecuteScalar(cmd, sqlFormasDePagoDingus, True)
                        If Not (IsNothing(forma_pago_id) Or IsDBNull(forma_pago_id)) Then


                            'generar anticipo de ajustes

                            Dim ds As DataSet = getDataSet(cmd, sqlAnticipos)
                            'crear anticipo
                            Dim row As DataRow = ds.Tables(0).Rows.Add
                            row("hotel_id") = reader("hotel_id")
                            row("tipo_anticipo_id") = 1 'cual sera?
                            row("reserva_id") = reserva_id
                            row("cliente_id") = reader("cliente_id")
                            row("caja_id") = reader("caja_id")
                            row("importe") = importe - total

                            row("forma_pago_id") = forma_pago_id
                            'row("estado_id") = 1
                            'row("anticipo_padre_id") = readerAnticipos("anticipo_id")
                            row("user_id") = Me.userId
                            row("fecha_modificacion") = Now
                            'acelerar
                            row("fecha") = fecha

                            Dim writer As MySqlDataAdapter
                            writer = getDataAdapter(cmd, sqlAnticipos)
                            writer.Fill(ds.Tables(0))
                            writer.Update(ds.Tables(0))

                            'actualizar el anticipo
                            Dim anticipo_id As Integer = Obtiene_ultima_id(cmd)
                            If anticipo_id <> 0 Then
                                'actualizar anticipo
                                errorCode = ActualizarAnticipo(cmd, anticipo_id)
                            Else
                                errorCode = 10 'no inserto el registro
                            End If
                        Else
                            'no encuentra forma de pago dingus para ese hotel
                            errorCode = 2
                        End If
                    Else
                        'la caja esta cerrada
                        errorCode = 1
                    End If
                End While
            Else
                'ya tiene los anticipos ke le corresponden
            End If
            Return errorCode
        End Function
        Shared sqlActualizaAnticipoEstadoNulo = "update anticipos set estado_id=0 where anticipo_id=? and estado_id is null"
        Public Function ActualizarAnticipo(ByVal anticipo_id As Integer)
            Dim retVal As Integer = -1
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            errorCode = ActualizarAnticipo(cmd, anticipo_id)
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Shared sqlDatosLineasSeries = "" _
& " SELECT " _
& " series.servicio_id," _
& " series.impuesto_id, " _
& " servicios.nombre_servicio, " _
& " impuestos.porcentaje " _
& " FROM " _
& " series " _
& " Inner Join servicios ON series.servicio_id = servicios.servicio_id " _
& " Inner Join impuestos ON series.impuesto_id = impuestos.impuesto_id " _
& " WHERE " _
& " series.serie_id =  ? "
        Public Function CrearFacturaSencilla(ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal serie_id As Integer, ByVal referencia2 As String, ByVal cantidad As Integer, ByVal precio As Single, Optional ByVal fecha As Object = Nothing, Optional ByVal referencia1 As Object = Nothing) As Factura
            Dim retVal As Integer = -1
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim fac As Factura = CrearFacturaSencilla(cmd, hotel_id, cliente_id, serie_id, referencia2, cantidad, precio, fecha, referencia1)
            If IsNothing(fac) Then
                errorCode = 1
            End If
            flushConection(cmd, errorCode)
            Return fac
        End Function
        '***************************************
        ' Garra Javier 27/02/2012  Referencia1
        ' **************************************
        Private Function CrearFacturaSencilla(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal serie_id As Integer, ByVal reserva_id As Object, ByVal referencia2 As Object, ByVal cantidad As Integer, ByVal precio As Single, Optional ByVal fecha As Object = Nothing, Optional ByVal referencia1 As Object = Nothing) As Factura
            cmd.Parameters.Clear()
            Dim serie_idParam As New MySqlParameter("@serie_id", serie_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(serie_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sqlDatosLineasSeries)
            Dim fac As Factura = Nothing
            Try
                While reader.Read
                    If IsNothing(fecha) Then
                        fecha = FechaHotel(cmd, hotel_id)
                    End If
                    'todo obtiene datos serie
                    fac = preparaFactura(cmd, -1, cliente_id, 1, fecha, hotel_id, serie_id, referencia2, referencia1)
                    Dim dtcab As DataTable = fac.ds.Tables(0)
                    'dtcab.Rows(0)("ref_fra2") = referencia2
                    'TODO crear lineas de facturas
                    Dim row As DataRow = agregaLineaFactura(fac)
                    row.Item("fecha") = fecha
                    If IsNothing(reserva_id) Then
                        row.Item("reserva_id") = System.DBNull.Value
                    Else
                        row.Item("reserva_id") = reserva_id
                    End If

                    If fac.factura_id = 0 Then
                        row.Item("factura_id") = System.DBNull.Value
                    Else
                        row.Item("factura_id") = fac.factura_id
                    End If
                    row.Item("contrato_id") = System.DBNull.Value
                    row.Item("descripcion") = reader("nombre_servicio")
                    row.Item("cantidad") = cantidad
                    row.Item("hotel_id") = hotel_id
                    row.Item("precio") = precio
                    row.Item("precio_produccion") = 0
                    row.Item("impuesto_id") = reader("impuesto_id")
                    row.Item("porc_impuesto") = reader("porcentaje")
                    row.Item("servicio_id") = reader("servicio_id")
                    row.Item("unidad_calculo_id") = 1
                    row.Item("tipo_linea_factura") = "M"

                    actualizarLineas(fac)
                End While
            Catch ex As Exception
                fac = Nothing
            End Try
            Return fac
        End Function
        Private Function cambia_ref1_facturas(ByVal cmd As MySqlCommand, ByVal ref1 As String, ByVal serie_id As Integer, ByVal fecha As Date, ByVal reserva_id As Integer, ByVal importe As Double) As Integer
            Dim serie_idParam As New MySqlParameter("@serie_id", serie_id)
            Dim ref1_Param As New MySqlParameter("@ref_fra1", ref1)
            Dim fechaParam As New MySqlParameter("@fecha_factura", fecha)
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            Dim importeParam As New MySqlParameter("@importe_total", importe)
            Dim sql_update = "UPDATE facturas SET ref_fra1 = ? WHERE serie_id = ? AND reserva_id = ? And importe_total= ? And fecha_factura = ?"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(ref1_Param)
            cmd.Parameters.Add(serie_idParam)
            cmd.Parameters.Add(reserva_idParam)
            cmd.Parameters.Add(importeParam)
            cmd.Parameters.Add(fechaParam)
            Try
                Dim retorno_valor = ExecuteNonQuery(cmd, sql_update)
                If retorno_valor = 1 Then
                    importeParam.Value = -importe
                    retorno_valor = ExecuteNonQuery(cmd, sql_update)
                    Return 0
                End If
            Catch ex As Exception
                flushConection(cmd, 1)
                Throw New Exception(ex.Message & " " & ref1 & " " & serie_id & " " & fecha & " " & reserva_id & " " & " " & importe)
                Return 1
            End Try
            Return 0
        End Function
        Public Function cambia_ref1_facturas(ByVal ref1 As String, ByVal serie_id As Integer, ByVal fecha As Date, ByVal reserva_id As Integer, ByVal importe As Double) As Integer
            Dim cmd As MySqlCommand = prepareConection()
            'Throw New Exception("Parametros=" & ref1 & " " & serie_id & " " & fecha & " " & reserva_id & " " & " " & importe)
            Dim errorcode As Integer = cambia_ref1_facturas(cmd, ref1, serie_id, fecha, reserva_id, importe)
            flushConection(cmd, errorcode)
            Return errorcode
        End Function
        Private Function ActualizarAnticipo(ByVal cmd As MySqlCommand, ByVal anticipo_id As Integer)
            '***********************************************
            ' Garra Javier 27/02 ref1 en depositos         *
            ' **********************************************
            Dim retVal As Integer = -1
            Dim errorCode As Integer = 0

            Dim anticipo_idParam As New MySqlParameter("@anticipo_id", anticipo_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(anticipo_idParam)

            Dim ref2 As Object
            Dim ref1 As Object = Nothing
            Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneMovAnticipos)
            While reader.Read And errorCode = 0
                If CrearMovimientoCaja(cmd, reader("tipo_movimiento_id"), reader("fecha"), reader("caja_id"), reader("importe"), reader("anticipo_id"), reader("forma_pago_id")) Then
                    'todo crear factura con los datos de ese anticipo                   
                    ref2 = reader("descripcion")
                    ref1 = reader("descripcion")
                    Dim fac As Factura = CrearFacturaSencilla(cmd, reader("hotel_id"), reader("cliente_id"), reader("serie_id"), reader("reserva_id"), reader("descripcion"), 1, reader("importe"))
                    If Not IsNothing(fac) Then
                        'cobrar esa factura con lo ke krea movimiento de caja
                        If CambiarEstadoFactura(cmd, fac.factura_id, 1, False) Then
                            'actualiza el anticipo de nulo a cero
                            'que pasa si no era de reserva?
                            'If reader("serie_id") = 5 And Not reader.IsDBNull(reader.GetOrdinal("reserva_id")) Then
                            ' Garra de Javier.....Cambio ref2 a los anticipos y depositos de las reservas
                            If Not reader.IsDBNull(reader.GetOrdinal("reserva_id")) Then
                                Dim dr As DatosReserva = obtieneReservaDatosListados(cmd, reader("reserva_id"))
                                Dim fact As Factura = abreFactura(cmd, fac.factura_id, reader("reserva_id"))
                                ref2 = fact.ds.Tables(0).Rows(0)("numero_factura") & " " & reader("reserva_id")
                                If Not IsNothing(dr) Then
                                    ref2 &= " " & dr.fecha_desde.ToShortDateString & " " & dr.primer_huesped
                                End If
                                fact.ds.Tables(0).Rows(0)("ref_fra2") = ref2

                                If Not (reader.IsDBNull(reader.GetOrdinal("descripcion"))) Then
                                    fact.ds.Tables(0).Rows(0)("ref_fra1") = reader("descripcion")
                                End If

                                Dim writer As MySqlDataAdapter
                                writer = getDataAdapter(fact.cmd, sqlCabAbreFactura)
                                writer.Fill(fact.ds.Tables(0))
                                writer.Update(fact.ds.Tables(0))
                            End If

                            Dim tmpret As Boolean = True
                            ' Garra de Javier. En vez de mirar si el tipo de anticipo es = 3 miro si es anticipo o depósito y entonces no va acontabilidad
                            If reader("serie_id") = 4 Then
                                tmpret = CambiarEstadoFactura(cmd, fac.factura_id, 2, False)
                            End If
                            If tmpret Then
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(anticipo_idParam)
                                If ExecuteNonQuery(cmd, sqlActualizaAnticipoEstadoNulo) = 1 Then
                                    If AsignarFacturaAnticipo(cmd, anticipo_id, fac.factura_id, reader("importe")) Then
                                        If ActualizarLineasAnticipo(cmd, anticipo_id) > 0 Then
                                            'crear factura negativa del anticipo...y dejarla en un estado contabilizado
                                            Dim fac2 As Factura = CrearFacturaSencilla(cmd, reader("hotel_id"), reader("cliente_id"), reader("serie_id"), reader("reserva_id"), ref2, -1, reader("importe"), Nothing, ref1)
                                            If Not IsNothing(fac2) Then
                                                If CambiarEstadoFactura(cmd, fac2.factura_id, 1, False) Then
                                                    If CambiarEstadoFactura(cmd, fac2.factura_id, 2, False) Then
                                                        'todo oks
                                                    Else
                                                        errorCode = 1
                                                        AgregaInfo("ActualizarAnticipo", "No puedo contabilizar segunda factura del anticipo:" & anticipo_id, -errorCode)

                                                    End If
                                                Else
                                                    errorCode = 2
                                                    AgregaInfo("ActualizarAnticipo", "No puedo actualizar segunda factura del anticipo:" & anticipo_id, -errorCode)

                                                End If
                                            Else
                                                errorCode = 3
                                                AgregaInfo("ActualizarAnticipo", "No puedo crear segunda factura del anticipo:" & anticipo_id, -errorCode)
                                            End If
                                        Else
                                            errorCode = 4
                                            AgregaInfo("ActualizarAnticipo", "No puedo asignar factura al anticipo:" & anticipo_id, -errorCode)
                                        End If
                                    Else
                                        errorCode = 5
                                        AgregaInfo("ActualizarAnticipo", "No puedo asignar factura al anticipo:" & anticipo_id, -errorCode)
                                    End If
                                Else
                                    'no pude cambiar el estado del anticipo
                                    errorCode = 6
                                    AgregaInfo("ActualizarAnticipo", "No puedo cambiar el estado del anticipo:" & anticipo_id, -errorCode)
                                End If
                            Else
                                errorCode = 7
                                AgregaInfo("ActualizarAnticipo", "No puedo contabilizar factura del anticipo:" & anticipo_id, -errorCode)
                            End If
                        Else
                            errorCode = 8
                            AgregaInfo("ActualizarAnticipo", "No puedo actualizar factura del anticipo:" & anticipo_id, -errorCode)
                        End If
                    Else
                        'no pude cambiar el estado del anticipo
                        errorCode = 9
                        AgregaInfo("ActualizarAnticipo", "No puedo crear factura del anticipo:" & anticipo_id, -errorCode)

                    End If


                Else
                    'no puedo crear movimiento de caja
                    'caja ya cerrada para esa fecha
                    errorCode = 9
                    AgregaInfo("ActualizarAnticipo", "No puedo crear movimiento de caja:" & anticipo_id, -errorCode)
                End If
            End While


            Return errorCode
        End Function
        Private Function ActualizarAnticipoOld(ByVal cmd As MySqlCommand, ByVal anticipo_id As Integer)
            Dim retVal As Integer = -1
            Dim errorCode As Integer = 0

            Dim anticipo_idParam As New MySqlParameter("@anticipo_id", anticipo_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(anticipo_idParam)


            Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneMovAnticipos)
            While reader.Read And errorCode = 0
                If CrearMovimientoCaja(cmd, reader("tipo_movimiento_id"), reader("fecha"), reader("caja_id"), reader("importe"), reader("anticipo_id"), reader("forma_pago_id")) Then
                    'actualiza el anticipo de nulo a cero
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(anticipo_idParam)
                    If ExecuteNonQuery(cmd, sqlActualizaAnticipoEstadoNulo) = 1 Then
                    Else
                        'no pude cambiar el estado del anticipo
                        errorCode = 2
                        AgregaInfo("ActualizarAnticipo", "No puedo cambiar el estado del anticipo:" & anticipo_id, -errorCode)
                    End If
                Else
                    'no puedo crear movimiento de caja
                    'caja ya cerrada para esa fecha
                    errorCode = 1
                    AgregaInfo("ActualizarAnticipo", "No puedo crear movimiento de caja:" & anticipo_id, -errorCode)
                End If
            End While


            Return errorCode
        End Function
        Public Function ActualizarLineasAnticipo(ByVal anticipo_id As Integer)
            Dim retVal As Integer = -1
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = ActualizarLineasAnticipo(cmd, anticipo_id)
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Private Function ActualizarLineasAnticipo(ByVal cmd As MySqlCommand, ByVal anticipo_id As Integer) As Integer
            Dim retVal As Integer = -1
            Dim errorCode As Integer = 0
            Dim cobro_id As Integer = CrearCobro(cmd, anticipo_id)
            If cobro_id > 0 Then
                Dim pudoactualizarcobro As Boolean = CambiarEstadoCobro(cmd, cobro_id, 1, False)
                If pudoactualizarcobro Then
                    'todo correcto
                    retVal = cobro_id
                Else
                    'no se pudo actualizar el cobro
                    errorCode = 1
                    AgregaInfo("ActualizarLineasAnticipo", "No se pudo actualizar el cobro:" & anticipo_id, -errorCode)
                End If
            Else
                'no se pudo crear cobro
                errorCode = 2
                AgregaInfo("ActualizarLineasAnticipo", "No se pudo crear cobro:" & anticipo_id, -errorCode)
            End If


            Return retVal
        End Function
        Shared sqlObtieneFacturasReserva = "" _
& " SELECT DISTINCT" _
& " lineas_factura.factura_id, " _
& " facturas.Cliente_Id, " _
& " formas_de_pago.credito " _
& " FROM " _
& " lineas_factura " _
& " Inner Join facturas ON lineas_factura.factura_id = facturas.Factura_Id " _
& " Inner Join formas_de_pago ON facturas.Forma_Pago_Id = formas_de_pago.forma_pago_id " _
& " WHERE " _
& " lineas_factura.reserva_id = ? AND " _
& " facturas.Estado_Factura_Id >=  1 " _
& " group by  lineas_factura.factura_id,  facturas.Cliente_Id,  formas_de_pago.credito" _
& " order by  sum(lineas_factura.cantidad*lineas_factura.precio) asc "

        Shared sqlObtieneAnticiposReserva = "" _
& " SELECT " _
& " anticipos.anticipo_id,anticipos.hotel_id,anticipos.caja_id,anticipos.forma_pago_id, " _
& " anticipos.cliente_id, " _
& " Coalesce((anticipos.importe*(anticipos.tipo_anticipo_id=1))-Coalesce((select sum(l.Importe) from lineas_anticipo l where l.anticipo_id=anticipos.anticipo_id ),0)-Coalesce((select sum(a.importe) from anticipos a where a.anticipo_padre_id=anticipos.anticipo_id),0),0) as pendiente " _
& " FROM " _
& " anticipos " _
& " WHERE " _
& " anticipos.reserva_id =  ? "
        Shared sqlLineaAnticipos = "select * from lineas_anticipo where anticipo_id=?"
        Shared sqlAnticipos = "select * from anticipos where 1=0"
        Function DevolverAnticiposReserva(ByVal reserva_id As Integer)
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            'retVal = ObtienePendienteAnticipoReserva(cmd, reserva_id)
            'If retVal > 0 Then
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Dim readerAnticipos As DataTableReader = getDataTable(cmd, sqlObtieneAnticiposReserva)
            Dim ds As DataSet = getDataSet(cmd, sqlAnticipos)
            Dim fecha As Date
            Dim fechaset As Boolean = False
            While readerAnticipos.Read And errorCode = 0
                Dim pend As Single = readerAnticipos("pendiente")
                If pend > 0 Then
                    'crear anticipo
                    Dim row As DataRow = ds.Tables(0).Rows.Add
                    If fechaset = False Then
                        'carga la fecha del hotel una sola vez
                        fecha = FechaHotel(cmd, readerAnticipos("hotel_id"))
                        fechaset = True
                    End If
                    row("hotel_id") = readerAnticipos("hotel_id")
                    row("tipo_anticipo_id") = 2
                    row("reserva_id") = reserva_id
                    row("cliente_id") = readerAnticipos("cliente_id")
                    row("caja_id") = readerAnticipos("caja_id")
                    row("importe") = pend

                    row("forma_pago_id") = readerAnticipos("forma_pago_id")
                    'row("estado_id") = 1
                    row("anticipo_padre_id") = readerAnticipos("anticipo_id")
                    row("user_id") = Me.userId
                    row("fecha_modificacion") = Now
                    'acelerar
                    row("fecha") = fecha

                    Dim writer As MySqlDataAdapter
                    writer = getDataAdapter(cmd, sqlAnticipos)
                    writer.Fill(ds.Tables(0))
                    writer.Update(ds.Tables(0))

                    Dim anticipo_id As Integer = Obtiene_ultima_id(cmd)
                    If anticipo_id <> 0 Then
                        'actualizar anticipo
                        errorCode = ActualizarAnticipo(cmd, anticipo_id)
                        AgregaInfo("DevolverAnticiposReserva", "Actualizando Anticipo:" & anticipo_id, -errorCode)
                    Else
                        errorCode = 10 'no inserto el registro
                        AgregaInfo("DevolverAnticiposReserva", "No pudo crear la devolucion:" & anticipo_id, -errorCode)
                    End If

                End If
            End While
            'End If
            flushConection(cmd, errorCode)
            Return retVal

        End Function
        Private Function AsignarFacturaAnticipo(ByVal cmd As MySqlCommand, ByVal anticipo_id As Integer, ByVal factura_id As Integer, ByVal importe As Single) As Boolean
            Dim retval As Boolean = False
            Try
                Dim anticipo_idParam As New MySqlParameter("@anticipo_id", anticipo_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(anticipo_idParam)
                Dim ds As DataSet = getDataSet(cmd, sqlLineaAnticipos)
                Dim row As DataRow = ds.Tables(0).Rows.Add
                row.Item("Anticipo_Id") = anticipo_idParam.Value
                row.Item("Factura_Id") = factura_id
                row.Item("Importe") = importe 'obtieneImportePendienteFactura(cmd, factura_id)
                row.Item("estado") = 0
                row.Item("user_id") = userId
                row.Item("fecha_actualizacion") = Now
                Dim writer As MySqlDataAdapter
                writer = getDataAdapter(cmd, sqlLineaAnticipos)
                writer.Fill(ds.Tables(0))
                writer.Update(ds.Tables(0))
                retval = True
            Catch ex As Exception

            End Try
            Return retval
        End Function
        Private Function ObtieneFacturasPendientesReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, Optional ByVal contado As Boolean = False) As String
            Dim retVal As String = ""
            Dim errorCode As Integer = 0

            Try
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneFacturasReserva)
                Dim puedo As Boolean = True
                While reader.Read
                    If reader.Item("credito") And contado Then
                        puedo = False
                    Else
                        puedo = True
                    End If
                    If puedo And obtieneImportePendienteFactura(cmd, CInt(reader.Item("factura_id"))) <> 0 Then
                        If retVal = "" Then
                            retVal = (reader.Item("factura_id"))
                        Else
                            retVal &= "," & (reader.Item("factura_id"))
                        End If
                    End If
                End While

            Catch ex As Exception
                retVal = Nothing
                errorCode = 1
            End Try

            Return retVal
        End Function
        Public Function ObtieneFacturasPendientesReserva(ByVal reserva_id As Integer, Optional ByVal contado As Boolean = False) As String
            Dim retVal As String = ""
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = ObtieneFacturasPendientesReserva(cmd, reserva_id, contado)
            If IsNothing(retVal) Then
                errorCode = 1
                retVal = ""
            End If
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Public Sub ValidarReserva(ByVal reserva_id As Integer)
            Dim errorCode As Integer = 0
            Dim importe_reserva As Double
            Dim cmd As MySqlCommand = prepareConection()
            importe_reserva = obtieneImporteTotalReserva(reserva_id)
            errorCode = ValidarReserva(cmd, reserva_id, importe_reserva)
            flushConection(cmd, errorCode)
        End Sub
        Public Function ValidarReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal importe_reserva As Double) As Integer
            Dim RowCount As Integer = -1
            Dim errorCode As Integer = 0
            Dim sqlupdate As String = "UPDATE reservas SET valor_validado = ? , fecha_validacion = now(), usuario_validacion = ? WHERE reserva_id = ? "
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            Dim importe_Param As New MySqlParameter("@importe", importe_reserva)
            Dim usuario_idParam As New MySqlParameter("@usuario", userId)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(importe_Param)
            cmd.Parameters.Add(usuario_idParam)
            cmd.Parameters.Add(reserva_idParam)
            RowCount = ExecuteNonQuery(cmd, sqlupdate)
            If RowCount <> 1 Then
                errorCode = 1
            End If
            Return errorCode
        End Function
        Public Sub AsignarAnticiposReserva(ByVal reserva_id As Integer)
            Dim retVal As Integer = -1
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()


            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Dim readerAnticipos As DataTableReader = getDataTable(cmd, sqlObtieneAnticiposReserva)
            Dim dsreader As DataSet = getDataSet(cmd, sqlObtieneFacturasReserva)

            Dim anticipo_idParam As New MySqlParameter("@anticipo_id", 0)
            Dim totalasignado As Single = 0
            While readerAnticipos.Read
                Dim pend As Single = readerAnticipos.Item("pendiente")
                If pend > 0 Then
                    anticipo_idParam.Value = readerAnticipos.Item("anticipo_id")
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(anticipo_idParam)
                    Dim ds As DataSet = getDataSet(cmd, sqlLineaAnticipos)
                    Dim reader As DataTableReader = dsreader.Tables(0).CreateDataReader
                    While pend > 0 And reader.Read
                        If reader.Item("cliente_id") = readerAnticipos.Item("cliente_id") Then
                            Dim importe As Single = obtieneImportePendienteFactura(cmd, CInt(reader.Item("factura_id")))
                            If importe > 0 Then
                                If importe > pend Then
                                    importe = pend
                                End If
                                'meter una linea al anticipo
                                Dim row As DataRow = ds.Tables(0).Rows.Add
                                row.Item("Anticipo_Id") = anticipo_idParam.Value
                                row.Item("Factura_Id") = reader.Item("factura_id")
                                row.Item("Importe") = importe
                                row.Item("estado") = 0
                                row.Item("user_id") = userId
                                row.Item("fecha_actualizacion") = Now
                                pend -= importe
                                totalasignado += importe
                            End If
                        End If
                    End While
                    Dim writer As MySqlDataAdapter
                    writer = getDataAdapter(cmd, sqlLineaAnticipos)
                    writer.Fill(ds.Tables(0))
                    writer.Update(ds.Tables(0))

                    If ActualizarLineasAnticipo(cmd, readerAnticipos.Item("anticipo_id")) > 0 Then
                    Else
                        errorCode = 1
                    End If
                End If
            End While
            If totalasignado = 0 Then
                AgregaInfo("AsignarAnticiposReserva", "No asigno los anticipos a reserva(falta de facturas=" & reserva_id, -errorCode)
            End If
            If errorCode <> 0 Then
                AgregaInfo("AsignarAnticiposReserva", "Fallo al asignar los anticipos de la reserva:" & reserva_id, -errorCode)
            End If
            flushConection(cmd, errorCode)
        End Sub
        Shared sqlLimpiezas = "select * from limpiezas where 1=0"
        Public Function crearLimpiezas(ByVal hotel_id As Integer, ByVal fecha As Date) As Boolean
            Dim retval As Boolean = True
            fecha = DateAdd(DateInterval.Day, 1, fecha) ' Como se hizo el cierre de ayer, calculo las limpiezas de mañana
            Dim dssource As DataSet = ObtieneLimpiezas(hotel_id, fecha, 0)
            Return retval
        End Function
        Shared sqlObtieneLimpiezasPorHabitacionVacias = "" _
& " SELECT Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada) as llegada,Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida) as salida,'14:00:00' as hora_llegada,'12:00:00' as hora_salida,'razon' as razon,0 as pax,0 as bebes,0 AS estado,1 as cliente_id,reservas.cliente_id as cliente_id_limpieza," _
& "   habitaciones.habitacion_id,  " _
& "   -1 as reserva_id,  " _
& "   0 as item_limpieza_id,   " _
& "         'VACIA' as item_limpieza, " _
& "   habitaciones.numero_habitacion, Coalesce(convert(habitaciones.numero_habitacion , unsigned),0) as nhab, " _
& "  7 as cambios_semana,   " _
& "   0 as primer_dia,   " _
& "   0 as sucesivos_cambios,   " _
& "   1 as lunes,  " _
& "   1 as martes,   " _
& "   1 as miercoles,   " _
& "  1 as  jueves,   " _
& "   1 as viernes,   " _
& "   1 as sabado,   " _
& "   1 as domingo,   " _
& "   reservas.fecha_prevista_llegada   " _
& "   FROM   " _
& " 	habitaciones left join habitaciones_bloqueos ON habitaciones_bloqueos.tipo_bloqueo_id = 1 and habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id and ? between habitaciones_bloqueos.fecha_desde and (habitaciones_bloqueos.fecha_hasta- interval 1 day) " _
& "     	left Join reservas ON habitaciones_bloqueos.reserva_id = reservas.reserva_id  and  reservas.estado_reserva_id=3 " _
& "         INNER JOIN tipos_habitacion ON habitaciones.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id " _
& "   WHERE  habitaciones.hotel_id=? AND tipos_habitacion.desvios <> 1" _
& "    and reservas.reserva_id is null " _
& "   order by nhab  "

        Shared sqlObtieneLimpiezasPorHabitacionDiaLlegadasSalidas = "" _
& "SELECT Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada) as llegada,Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida) as salida,'14:00:00' as hora_llegada,'12:00:00' as hora_salida,'razon' as razon,0 as pax,0 as bebes,0 AS estado,1 as cliente_id,reservas.cliente_id as cliente_id_limpieza," _
& "  habitaciones_bloqueos.habitacion_id, " _
& "  habitaciones_bloqueos.reserva_id, " _
& "  items_limpieza.item_limpieza_id,  " _
& "  items_limpieza.item_limpieza,  " _
& "  habitaciones.numero_habitacion, Coalesce(convert(habitaciones.numero_habitacion , unsigned),0) as nhab,  " _
& " 7 as cambios_semana,  " _
& "  0 as primer_dia,  " _
& "  0 as sucesivos_cambios, " _
& "  1 as lunes, " _
& "  1 as martes,  " _
& "  1 as miercoles,  " _
& " 1 as  jueves,  " _
& "  1 as viernes,  " _
& "  1 as sabado,  " _
& "  1 as domingo,  " _
& "  reservas.fecha_prevista_llegada  " _
& "  FROM  " _
& "  habitaciones_bloqueos  " _
& "  Inner Join reservas ON habitaciones_bloqueos.reserva_id = reservas.reserva_id  " _
& "  Inner Join items_limpieza ON items_limpieza.sw_llegada=1 or items_limpieza.sw_salida=1 " _
& "  Inner Join habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id " _
& "  WHERE  " _
& " reservas.estado_reserva_id<>2 and  " _
& "  habitaciones_bloqueos.tipo_bloqueo_id = 1 AND  " _
& "  (       ? =  habitaciones_bloqueos.fecha_desde and items_limpieza.sw_llegada=1 " _
& " or " _
& "         ? =  habitaciones_bloqueos.fecha_hasta and items_limpieza.sw_salida=1 )" _
& "  and habitaciones.hotel_id=? " _
& "  and ? in (0,items_limpieza.item_limpieza_id)" _
& "  and ? in (0,habitaciones_bloqueos.habitacion_id) order by nhab "

        Shared sqlObtieneLimpiezasPorHabitacionDia = "" _
& " SELECT Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada) as llegada,Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida) as salida,'14:00:00' as hora_llegada,'12:00:00' as hora_salida,'razon' as razon,0 as pax,0 as bebes,0 AS estado,1 as cliente_id,clientes_limpieza.cliente_id as cliente_id_limpieza," _
& " habitaciones_bloqueos.habitacion_id," _
& " habitaciones_bloqueos.reserva_id," _
& " items_limpieza.item_limpieza_id, " _
& " items_limpieza.item_limpieza, " _
& " habitaciones.numero_habitacion, Coalesce(convert(habitaciones.numero_habitacion , unsigned),0) as nhab, " _
& " clientes_limpieza.cambios_semana, " _
& " clientes_limpieza.primer_dia, " _
& " clientes_limpieza.sucesivos_cambios," _
& " clientes_limpieza.lunes," _
& " clientes_limpieza.martes, " _
& " clientes_limpieza.miercoles, " _
& " clientes_limpieza.jueves, " _
& " clientes_limpieza.viernes, " _
& " clientes_limpieza.sabado, " _
& " clientes_limpieza.domingo, " _
& " reservas.fecha_prevista_llegada " _
& " FROM " _
& " habitaciones_bloqueos " _
& " Inner Join reservas ON habitaciones_bloqueos.reserva_id = reservas.reserva_id " _
& " Inner Join clientes_limpieza ON reservas.hotel_id = clientes_limpieza.hotel_id AND (reservas.cliente_id = clientes_limpieza.cliente_id or clientes_limpieza.cliente_id=? )  " _
& " Inner Join items_limpieza ON items_limpieza.item_limpieza_id = clientes_limpieza.item_limpieza_id " _
& " Inner Join habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id AND habitaciones.tipo_habitacion_id = clientes_limpieza.tipo_habitacion_id " _
& " WHERE " _
& " habitaciones_bloqueos.tipo_bloqueo_id = 1 AND " _
& "         ? BETWEEN  habitaciones_bloqueos.fecha_desde AND  habitaciones_bloqueos.fecha_hasta " _
& " and habitaciones.hotel_id=? " _
& " and ? in (0,items_limpieza.item_limpieza_id)" _
& " and ? in (0,habitaciones_bloqueos.habitacion_id) order by nhab"
        Shared sqlObtieneLimpiezasHechas = "" _
& " SELECT " _
& " limpiezas.fecha" _
& " FROM " _
& " limpiezas " _
        & " WHERE " _
        & " yearweek(limpiezas.fecha)=yearweek(?) and " _
        & " limpiezas.habitacion_id =  ? AND " _
        & " limpiezas.reserva_id =  ? AND  " _
        & " limpiezas.item_limpieza_id =  ?"
        Shared sqlObtieneLimpiezasHechasReservas = "" _
& " SELECT " _
& " limpiezas.*" _
& " FROM " _
& " limpiezas " _
& " WHERE " _
& " yearweek(limpiezas.fecha)=yearweek(?) "


        Public Function obtienenLimpiezas(ByVal hotel_id As Integer, ByVal fecha As Date, ByVal estado As Integer, Optional ByVal item_limpieza_id As Integer = 0, Optional ByVal habitacion_id As Integer = 0, Optional ByVal habitacion_desde As Integer = 0, Optional ByVal habitacion_hasta As Integer = 0) As DataSet
            'Dim retVal As Integer

            Dim cacheDR As New Hashtable
            Dim errorCode As Integer = 0
            Dim ds As DataSet
            Dim cmd As MySqlCommand = prepareConection()
            Try


                Dim cliente_defecto_id As Integer = 16 'obtener el cliente extra contado?
                Dim fechaParam As New MySqlParameter("@fecha", fecha)
                Dim fecha1Param As New MySqlParameter("@fecha1", fecha)
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim habitacion_idParam As New MySqlParameter("@habitacion_id", habitacion_id)
                Dim reserva_idParam As New MySqlParameter("@reserva_id", 1)
                Dim item_limpieza_idParam As New MySqlParameter("@item_limpieza_id", item_limpieza_id)
                Dim cliente_defecto_idParam As New MySqlParameter("@cliente_defecto_id", cliente_defecto_id)
                'Dim item_limpieza_idParam1 As New MysqlParameter("@item_limpieza_id1", item_limpieza_id)

                cmd.Parameters.Clear()
                'cmd.Parameters.Add(fecha1Param)
                cmd.Parameters.Add(cliente_defecto_idParam)
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(item_limpieza_idParam)
                cmd.Parameters.Add(habitacion_idParam)
                'cmd.Parameters.Add(item_limpieza_idParam1)
                ds = getDataSet(cmd, sqlObtieneLimpiezasPorHabitacionDia)
                cmd.Parameters.Clear()
                'cmd.Parameters.Add(fecha1Param)
                'cmd.Parameters.Add(cliente_defecto_idParam)
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(fecha1Param)
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(item_limpieza_idParam)
                cmd.Parameters.Add(habitacion_idParam)
                'cmd.Parameters.Add(item_limpieza_idParam1)
                Dim dsls As DataSet = getDataSet(cmd, sqlObtieneLimpiezasPorHabitacionDiaLlegadasSalidas)

                cmd.Parameters.Clear()
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(hotel_idParam)
                Dim dsvac As DataSet = getDataSet(cmd, sqlObtieneLimpiezasPorHabitacionVacias)

                Dim x As Integer = 0
                Dim hab As Integer

                Dim filas As DataRowCollection
                Dim xc As Integer
                'todo en vez de borrar..mezclar y usar la id mas grande
                Dim ultstr As String = ""

                filas = dsvac.Tables(0).Rows
                xc = filas.Count - 1

                For x = 0 To xc
                    hab = filas(x).Item("habitacion_id")
                    filas(x)("item_limpieza") = concatenarColumna(ds.Tables(0), "reserva_id<>0 and habitacion_id=" & hab, "item_limpieza", "item_limpieza_id desc", filas(x)("item_limpieza"), filas(x)("item_limpieza_id"))
                    borrarDeTabla(ds.Tables(0), "reserva_id<>0 and habitacion_id=" & hab, True)

                    ds.Tables(0).Rows.Add(filas(x).ItemArray)
                Next

                filas = dsls.Tables(0).Rows
                xc = filas.Count - 1
                For x = 0 To xc
                    hab = filas(x).Item("habitacion_id")
                    filas(x)("item_limpieza") = concatenarColumna(ds.Tables(0), "reserva_id<>0 and habitacion_id=" & hab, "item_limpieza", "item_limpieza_id desc", filas(x)("item_limpieza"), filas(x)("item_limpieza_id"))
                    borrarDeTabla(ds.Tables(0), "reserva_id<>0 and habitacion_id=" & hab, True)

                    ds.Tables(0).Rows.Add(filas(x).ItemArray)
                Next


                Dim camposDias() As String = {"Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado", "Domingo"}


                If habitacion_desde <> 0 Or habitacion_hasta <> 0 Then
                    'todo habitacion desde-habitacion hasta
                    If habitacion_desde > habitacion_hasta Then
                        Dim tmp = habitacion_hasta
                        habitacion_hasta = habitacion_desde
                        habitacion_desde = tmp
                    End If
                    borrarDeTabla(ds.Tables(0), "not (nhab>=" & habitacion_desde & " and nhab<=" & habitacion_hasta & ")", False)
                    ds.Tables(0).AcceptChanges()
                End If
                ds.Tables(0).AcceptChanges()
                'quitar del resultado cuando existan 2 lineas iguales la que tiene el cliente por defecto

                'procesa linea a linea si se puede usar
                filas = ds.Tables(0).Rows

                Dim tipof As Integer = 0
                Dim tablahabs As New Hashtable
                Dim tablahabsele As New Hashtable
                'todo si cliente no tiene limpieza...usar el cliente por defecto
                xc = filas.Count - 1


                For x = 0 To xc
                    If filas(x)("reserva_id") <> 0 Then
                        Dim eliminar As Integer = 0
                        hab = filas(x).Item("habitacion_id")
                        If tablahabs.ContainsKey(hab) Then
                            If tablahabs(hab) = cliente_defecto_id Then

                                'si cliente es distinto de cliente defecto
                                'me cepillo todos los clientes distintos 
                                If (tablahabs(hab) <> filas(x).Item("cliente_id_limpieza")) Then
                                    eliminar = cliente_defecto_id
                                End If
                                tablahabs(hab) = filas(x).Item("cliente_id_limpieza")
                            Else
                                If (tablahabs(hab) <> filas(x).Item("cliente_id_limpieza")) Then
                                    eliminar = filas(x).Item("cliente_id_limpieza")
                                End If
                            End If
                            If eliminar <> 0 Then
                                borrarDeTabla(ds.Tables(0), "reserva_id<>0 and habitacion_id=" & hab & " and cliente_id_limpieza=" & eliminar, False, "reserva_id", 0)
                            End If
                        Else
                            tablahabs(hab) = filas(x).Item("cliente_id_limpieza")
                        End If
                    End If
                Next
                borrarDeTabla(ds.Tables(0), "reserva_id=0", False)
                ds.Tables(0).AcceptChanges()
                If 1 = 0 Then


                    Dim enu As IEnumerator = tablahabs.Keys.GetEnumerator()
                    Dim borrarkeys As String = ""
                    While enu.MoveNext
                        If borrarkeys <> "" Then
                            borrarkeys &= " or "
                        End If
                        borrarkeys &= "(habitacion_id=" & enu.Current & " and cliente_id_limpieza=" & tablahabs(enu.Current) & ")"
                    End While
                    If Not borrarkeys = "" Then
                        Console.WriteLine(borrarkeys.Length)
                        borrarDeTabla(ds.Tables(0), "not (" & borrarkeys & ")", False)
                        ds.Tables(0).AcceptChanges()
                        'Console.WriteLine(borrarkeys)
                    End If
                End If

                cmd.Parameters.Clear()
                cmd.Parameters.Add(fechaParam)
                Dim datoslimp As DataSet = getDataSet(cmd, sqlObtieneLimpiezasHechasReservas)
                'cmd.Parameters.Add(habitacion_idParam)
                'cmd.Parameters.Add(reserva_idParam)
                'cmd.Parameters.Add(item_limpieza_idParam)


                Dim dv As New DataView(datoslimp.Tables(0), "", "", DataViewRowState.CurrentRows)
                xc = filas.Count - 1
                For x = 0 To xc


                    'leer esa semana completa para la primera fila
                    'Console.WriteLine(cmd.Parameters.Count)
                    Dim borrar As Boolean = False
                    Dim nreg As Integer = 0
                    If 0 = 0 Then
                        dv.RowFilter = "habitacion_id=" & filas(x).Item("habitacion_id") & " and reserva_id=" & filas(x).Item("reserva_id") & " and item_limpieza_id=" & filas(x).Item("item_limpieza_id")
                        Dim datos As New DataTableReader(dv.ToTable)
                        'habitacion_idParam.Value = CInt(filas(x).Item("habitacion_id"))
                        'reserva_idParam.Value = filas(x).Item("reserva_id")
                        'item_limpieza_idParam.Value = filas(x).Item("item_limpieza_id")
                        'Dim datos As DataTableReader = getDataTable(cmd, sqlObtieneLimpiezasHechas)

                        'Dim matDias(7) As Boolean
                        'Dim fd As Date
                        While datos.Read
                            'fd = 
                            If datos("fecha") = fecha Then
                                filas(x).Item("estado") = 1
                                borrar = True
                            End If
                            'todo solo de la semana en curso
                            'matDias(Weekday(fd, FirstDayOfWeek.Monday)) = True
                            'todo solo de la semana en curso
                            nreg += 1
                        End While
                        datos.Close()
                        datos = Nothing
                        'dv.Dispose()
                        'dv = Nothing
                    End If
                    'si para el dia de hoy ya existe registro borrarlo
                    'comprobar tipo de fechas
                    If Not borrar Then
                        If filas(x).IsNull("cambios_semana") OrElse filas(x)("cambios_semana") = 0 Then
                            If filas(x).IsNull("primer_dia") OrElse filas(x)("primer_dia") = 0 Then
                                tipof = 2   'lun-dom
                            Else
                                tipof = 1   'prim-suce
                            End If
                        Else
                            tipof = 0   'semana
                        End If
                        Select Case tipof
                            Case 0
                                If nreg >= filas(x)("cambios_semana") Then
                                    borrar = True
                                Else
                                    borrar = False
                                End If
                            Case 1
                                Dim dlleg As Date = filas(x)("fecha_prevista_llegada")
                                If dlleg.AddDays(filas(x)("primer_dia")) = fecha Then
                                    borrar = False
                                Else
                                    borrar = True
                                    'cambiar while por modulo
                                    While dlleg < fecha And filas(x)("sucesivos_cambios") > 0
                                        dlleg = dlleg.AddDays(filas(x)("sucesivos_cambios"))
                                        If dlleg = fecha Then
                                            borrar = False
                                        End If
                                    End While
                                End If
                            Case 2
                                If filas(x)(camposDias(Weekday(fecha, Microsoft.VisualBasic.FirstDayOfWeek.Monday) - 1)) = 0 Then
                                    borrar = True
                                End If
                        End Select
                        If filas(x)(camposDias(Weekday(fecha, Microsoft.VisualBasic.FirstDayOfWeek.Monday) - 1)) = 0 Then
                            borrar = True
                        End If
                    End If
                    'si es la ultima linea ke existe de esa habitacion
                    'en vez de borrarla poner "NADA" y dejarla para ke la gobernanta lo vea...
                    If borrar And Not (filas(x).Item("estado") = 1 And estado = 0) Then
                        Dim num = ds.Tables(0).Compute("count(habitacion_id)", "habitacion_id=" & filas(x)("habitacion_id") & " and reserva_id<>0")
                        If num <> 1 Then
                            filas(x)("reserva_id") = 0
                        Else
                            filas(x)("item_limpieza") = " "
                            filas(x)("item_limpieza_id") = "0"
                        End If

                    Else
                    End If
                    If filas(x)("reserva_id") <> 0 Then
                        'todo cachear o usar funcion de cacheo
                        filas(x)("razon") = " "
                        filas(x)("pax") = 0
                        filas(x)("bebes") = 0
                        ' Lo calculo de otra forma FEBRERO 2013 Javier NUÑEZ porque los pax y tal no cuadran

                        'Dim dr As DatosReserva
                        'If cacheDR.ContainsKey(filas(x).Item("reserva_id")) Then
                        '    dr = cacheDR(filas(x).Item("reserva_id"))
                        'Else
                        '    dr = obtieneReservaDatosListados(cmd, filas(x).Item("reserva_id"), fecha)
                        '    cacheDR(filas(x).Item("reserva_id")) = dr
                        'End If
                        Dim sql As String = "SELECT razon from clientes WHERE cliente_id=(Select Min(reservas_huespedes.cliente_id) " _
                        & "FROM reservas_huespedes WHERE reservas_huespedes.reserva_id=?)"
                        cmd.Parameters.Clear()
                        reserva_idParam.Value = filas(x)("reserva_id")
                        cmd.Parameters.Add(reserva_idParam)
                        filas(x)("razon") = ExecuteScalar(cmd, sql)
                        sql = "SELECT sum(cantidad) AS pax FROM reservas_servicios " _
                        & "INNER JOIN servicios ON servicios.servicio_id = reservas_servicios.servicio_id AND servicios.concepto_acelerador_reservas_id = 99 " _
                        & "WHERE(reservas_servicios.reserva_id = ? And reservas_servicios.unidad_calculo_id <> 5)"
                        filas(x)("pax") = ExecuteScalar(cmd, sql)
                        sql = "SELECT sum(cantidad) AS pax FROM reservas_servicios " _
                        & "INNER JOIN servicios ON servicios.servicio_id = reservas_servicios.servicio_id AND servicios.concepto_acelerador_reservas_id = 99 " _
                        & "WHERE(reservas_servicios.reserva_id = ? And reservas_servicios.unidad_calculo_id = 5)"
                        filas(x)("bebes") = ExecuteScalar(cmd, sql)

                    End If
                    'ds.Tables(0).AcceptChanges()
                Next
                borrarDeTabla(ds.Tables(0), "reserva_id=0", False)
                ds.Tables(0).AcceptChanges()

                Dim dvk As New DataView(ds.Tables(0), "", "nhab", DataViewRowState.CurrentRows)
                ds = New DataSet()

                ds.Tables.Add(dvk.ToTable())

                Dim campos As New ArrayList()
                campos.Add("nhab")
                campos.Add("item_limpieza")
                dumpDataTable(ds.Tables(0).Select(""), campos)
            Catch ex As Exception
                errorCode = 1
                ds = Nothing
            End Try
            flushConection(cmd, errorCode)
            'todo eliminar las filas borradas?
            'ds = Nothing
            Return ds

        End Function
        Public Sub carga_paro_ventas_tipo_habitacion_id()
            Dim cmd As MySqlCommand = prepareConection()
            Dim paro_ventas_idParam As New MySqlParameter("paro_ventas_id", 0)
            Dim tipo_habitacion_idParam As New MySqlParameter("tipo_habitacion_id", 0)
            Dim hotel_id As Integer = 0
            Dim sql As String = "SELECT * FROM paro_ventas"
            Dim sql_insert As String = "INSERT INTO paro_ventas_tipo_habitacion_id (paro_ventas_id,tipo_habitacion_id) VALUES (?,?)"
            Dim Reader As DataTableReader = getDataTable(cmd, sql)
            Dim sql_tipos_habitacion_hotel As String = "SELECT * FROM tipos_habitacion_hotel " _
            & "INNER JOIN tipos_habitacion ON tipos_habitacion_hotel.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id WHERE desvios = 0"
            Dim Ds As DataSet = getDataSet(cmd, sql_tipos_habitacion_hotel)
            Dim i As Integer
            While Reader.Read
                paro_ventas_idParam.Value = Reader.Item("paro_ventas_id")
                Dim tipo_habitacion_id = Reader.Item("tipo_habitacion_id")
                If IsDBNull(tipo_habitacion_id) Then

                    hotel_id = Reader.Item("hotel_id")
                    Dim foundRows() As DataRow = Ds.Tables(0).Select("hotel_id=" & hotel_id)
                    For i = 0 To foundRows.GetUpperBound(0)
                        Dim row As DataRow = foundRows(i)    ' Aqui he cargado todos los campos de la fila
                        tipo_habitacion_idParam.Value = row.Item("tipo_habitacion_id")
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(paro_ventas_idParam)
                        cmd.Parameters.Add(tipo_habitacion_idParam)
                        Dim j = ExecuteNonQuery(cmd, sql_insert)
                    Next
                Else
                    tipo_habitacion_idParam.Value = tipo_habitacion_id
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(paro_ventas_idParam)
                    cmd.Parameters.Add(tipo_habitacion_idParam)
                    Dim j = ExecuteNonQuery(cmd, sql_insert)
                End If
            End While
            flushConection(cmd, 0)
        End Sub
        Public Sub Obtiene_paro_ventas(ByVal hotel_id As Integer, ByRef Ds As DataSet)
            Dim cmd As MySqlCommand = prepareConection()
            Obtiene_paro_ventas(cmd, hotel_id, Ds)
            flushConection(cmd, 0)
        End Sub
        Private Sub Obtiene_paro_ventas(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByRef Ds As DataSet)
            ' Esta Rutina recibe el dataset de codecharge y rellena los campos cliente_id y tipo_habitacion_id según sea
            ' Si son todos los tipos de habitación pondrá "todas" si es una sola, pondrá esa y en el resto de casos, pondrá "Varias"
            ' Lo mismo para los clientes
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim paro_ventas_idParam As New MySqlParameter("paro_ventas_id", 0)
            Dim desdeParam As New MySqlParameter("desde", Now())
            Dim HastaParam As New MySqlParameter("hasta", Now())
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            Dim sql As String = ""
            ' A Eliminar despues de pruebas
            'sql = "SELECT DISTINCT(paro_ventas.paro_ventas_id) AS paro_ventas_id, motivo, fecha_parada, desde, hasta, paro_ventas.user_id AS paro_ventas_user_id," _
            '& "paro_ventas.fecha_modificacion AS paro_ventas_fecha_modificacion, 'tipo' AS tipo_habitacion, 'cliente' As cliente " _
            '& "FROM paro_ventas LEFT JOIN paro_ventas_tipo_habitacion_id ON paro_ventas.paro_ventas_id = paro_ventas_tipo_habitacion_id.paro_ventas_id " _
            '& "LEFT JOIN lineas_paro_ventas ON paro_ventas.paro_ventas_id = lineas_paro_ventas.paro_ventas_id " _
            '& "INNER JOIN usuarios ON usuarios.User_Id = paro_ventas.User_Id " _
            '& "WHERE paro_ventas.hotel_id = ? AND  paro_ventas.paro_ventas_id<40"
            'Ds = getDataSet(cmd, sql)
            '' Fin de a eliminar despues de pruebas

            Dim TmpTable As DataTable
            TmpTable = Ds.Tables(0).Copy
            Dim x As Integer
            Dim i As Integer
            Dim filas As DataRowCollection = Ds.Tables(0).Rows

            Dim sql_tipos_habitacion_hotel As String = "SELECT COUNT(*) FROM tipos_habitacion_hotel " _
            & "INNER JOIN tipos_habitacion ON tipos_habitacion_hotel.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id WHERE hotel_id =? AND desvios = 0"
            Dim sql_num_ttoo As String = "SELECT COUNT(DISTINCT(cliente_id)) FROM contratos " _
            & "WHERE contratos.hotel_id = ? AND (? BETWEEN contratos.fecha_desde AND  contratos.fecha_hasta OR ? BETWEEN contratos.fecha_desde AND  contratos.fecha_hasta)"
            Try

                Dim num_tipos_hab = ExecuteScalar(cmd, sql_tipos_habitacion_hotel)
                For x = 0 To filas.Count - 1  ' Para cada fila
                    Dim row As DataRow = filas(x)
                    paro_ventas_idParam.Value = filas(x).Item("paro_ventas_id")
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(paro_ventas_idParam)
                    ' Tratamos los tipos de habitacion
                    sql = "SELECT COUNT(*) FROM paro_ventas_tipo_habitacion_id WHERE paro_ventas_id =?"
                    i = ExecuteScalar(cmd, sql)
                    Select Case i
                        Case 0
                            row.Item("tipo_habitacion") = "Ninguna"
                        Case num_tipos_hab
                            row.Item("tipo_habitacion") = "Todas"
                        Case 1  ' Una sola
                            sql = "SELECT desc_corta FROM paro_ventas_tipo_habitacion_id " _
                            & "INNER JOIN tipos_habitacion ON paro_ventas_tipo_habitacion_id.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id " _
                            & "WHERE paro_ventas_id = ?"
                            row.Item("tipo_habitacion") = ExecuteScalar(cmd, sql)
                        Case Else
                            row.Item("tipo_habitacion") = "Varias"
                    End Select
                    ' Ahora vamos por los ttoo
                    sql = "SELECT COUNT(*) FROM lineas_paro_ventas WHERE paro_ventas_id =?"
                    i = ExecuteScalar(cmd, sql)
                    desdeParam.Value = row.Item("desde")
                    HastaParam.Value = row.Item("hasta")
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(hotel_idParam)
                    cmd.Parameters.Add(desdeParam)
                    cmd.Parameters.Add(HastaParam)
                    Dim num_ttoo = ExecuteScalar(cmd, sql_num_ttoo)
                    Select Case i
                        Case 0
                            row.Item("cliente") = "Ninguno"
                        Case num_ttoo
                            row.Item("cliente") = "Todos"
                        Case 1  ' Uno sola
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(paro_ventas_idParam)
                            sql = "SELECT razon FROM clientes " _
                            & "INNER JOIN lineas_paro_ventas ON paro_ventas.cliente_id= clientes.tipo_habitacion_id " _
                            & "WHERE paro_ventas_id = ?"
                            row.Item("cliente") = ExecuteScalar(cmd, sql)
                        Case Else
                            row.Item("cliente") = "Varios"
                    End Select
                    Ds.Tables(0).AcceptChanges()
                Next
            Catch ex As Exception

            End Try
            i = i + 1
        End Sub
        ' Funcion que sustituye a la de Tano que afortuandamente se llama ObtienenLimpiezas
        Public Function ObtieneLimpiezas(ByVal cmd As MySqlCommand, hotel_id As Integer, ByVal fecha As Date, Optional ByVal zona As Integer = 0, Optional ByVal Desde As Integer = 0, Optional ByVal Hasta As Integer = 0) As DataSet

            Dim Fecha_Hotel As Date = FechaHotel(cmd, hotel_id)
            Dim errorcode As Integer = 0
            Dim cliente_defecto_id As Integer = 16 'obtener el cliente extra contado?
            Dim fechaParam As New MySqlParameter("@fecha", fecha)
            Dim fecha1Param As New MySqlParameter("@fecha1", fecha)
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim hotel_idParam1 As New MySqlParameter("@hotel_id", hotel_id)
            Dim reserva_idParam As New MySqlParameter("@reserva_id", 0)
            Dim situacion_idParam As New MySqlParameter("@situacion_id", 0)
            Dim habitacion_idParam As New MySqlParameter("@habitacion_id", 0)
            Dim item_limpieza_idParam As New MySqlParameter("@item_limpieza_id", 0)
            Dim zonaParam As New MySqlParameter("zona_limpieza_id", zona)
            Dim zona_id As Integer = zona
            If zona = -1 Then  ' Las quiere todas pero separadas
                zona_id = 0
            End If
            Dim update_situacion As String = ""
            Dim inserta_limpieza As String = "INSERT INTO limpiezas (habitacion_id,reserva_id,item_limpieza_id,fecha) VALUES (?,?,?,?)"
            Dim selec_habitaciones_zona_limpieza = "SELECT habitacion_id,zona_limpieza_id FROM habitaciones WHERE hotel_id=?"

            Dim selec_habitaciones As String = "SELECT habitacion_id, RIGHT(CONCAT('000',habitaciones.numero_habitacion),4) AS numero, " _
            & "'' as llegada,'' as salida,'' hora_llegada,'' as hora_salida,'' as tipo_hab, NULL as bebes,NULL as pax, '' AS ttoo, " _
            & "NULL as reserva_id,'VACIA' as item_limpieza, 0 As vip, NULL As Observaciones, zona_limpieza_id " _
            & "FROM habitaciones " _
            & "WHERE hotel_id = ? And tipo_habitacion_id <>10 " _
            & "AND ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) " _
            & "AND ({desde}=0 OR numero_habitacion >={desde}) " _
            & "AND ({hasta}=0 OR numero_habitacion<={hasta}) " _
            & "ORDER BY RIGHT(CONCAT('000',habitaciones.numero_habitacion),4) "
            If zona = 0 Then
                selec_habitaciones = "SELECT habitacion_id, RIGHT(CONCAT('000',habitaciones.numero_habitacion),4) AS numero, " _
                & "'' as llegada,'' as salida,'' hora_llegada,'' as hora_salida,'' as tipo_hab, NULL as bebes,NULL as pax, '' AS ttoo, " _
                & "NULL as reserva_id,'VACIA' as item_limpieza, 0 As vip, NULL As Observaciones, 0 As zona_limpieza_id " _
                & "FROM habitaciones " _
                & "WHERE hotel_id = ? And tipo_habitacion_id <>10 " _
                & "AND ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) " _
                & "AND ({desde}=0 OR numero_habitacion >={desde}) " _
                & "AND ({hasta}=0 OR numero_habitacion<={hasta}) " _
                & "ORDER BY RIGHT(CONCAT('000',habitaciones.numero_habitacion),4) "
            End If
            Dim insertar As Boolean = False
            If fecha = Fecha_Hotel Then
                insertar = True
            End If
            Dim contador As Integer = 0
            If insertar Then ' borro las limpiezas de hoy que no estén hechas y las vuelvo a cargar
                Dim sql_borra_limpiezas As String = "DELETE FROM limpiezas  WHERE hora_validacion IS NULL AND hora_limpieza IS NULL AND fecha = ? AND habitacion_id IN " _
                & "(SELECT habitacion_id FROM habitaciones " _
                & "WHERE hotel_id = ? " _
                & "AND ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) " _
                & "AND ({desde}=0 OR numero_habitacion >={desde}) " _
                & "AND ({hasta}=0 OR numero_habitacion<={hasta})) "
                ' Inicialmente, marco todas las habitaciones como vacías
                update_situacion = "UPDATE habitaciones SET situacion_id=0 " _
                & "WHERE hotel_id = ? " _
                & "AND ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) " _
                & "AND ({desde}=0 OR numero_habitacion >={desde}) " _
                & "AND ({hasta}=0 OR numero_habitacion<={hasta}) "

                update_situacion = update_situacion.Replace("{zona_limpieza_id}", CStr(zonaParam.Value))
                update_situacion = update_situacion.Replace("{desde}", CStr(Desde))
                update_situacion = update_situacion.Replace("{hasta}", CStr(Hasta))

                sql_borra_limpiezas = sql_borra_limpiezas.Replace("{zona_limpieza_id}", CStr(zonaParam.Value))
                sql_borra_limpiezas = sql_borra_limpiezas.Replace("{desde}", CStr(Desde))
                sql_borra_limpiezas = sql_borra_limpiezas.Replace("{hasta}", CStr(Hasta))
                cmd.Parameters.Clear()
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(hotel_idParam)
                Dim kk = ExecuteNonQuery(cmd, sql_borra_limpiezas)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                kk = ExecuteNonQuery(cmd, update_situacion)
            End If
            selec_habitaciones = selec_habitaciones.Replace("{zona_limpieza_id}", CStr(zona_id))
            selec_habitaciones = selec_habitaciones.Replace("{desde}", CStr(Desde))
            selec_habitaciones = selec_habitaciones.Replace("{hasta}", CStr(Hasta))
            Dim item_limpieza As String = ""
            cmd.Parameters.Clear()
            Dim ds_items_limpieza As DataSet = getDataSet(cmd, "SELECT * FROM items_limpieza")
            cmd.Parameters.Add(hotel_idParam)
            Dim ds_zonas_limpieza As DataSet = getDataSet(cmd, selec_habitaciones_zona_limpieza)
            Dim ds As DataSet = getDataSet(cmd, selec_habitaciones) ' Aqui en el dataset tenemos las habitaciones que tocan pero todo vacio
            update_situacion = "UPDATE habitaciones SET situacion_id =? WHERE habitacion_id =? AND situacion_id <2 "  ' Solo cambio la situacion de la habitacione si está libre
            Try
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fechaParam)
                Dim x As Integer = 0
                Dim i As Integer
                Dim hab As Integer

                Dim filas As DataRowCollection
                Dim TmpTable As DataTable
                If fecha < Fecha_Hotel Then ' Cargo ds de la tabla limpiezas. Si no hubiera nada, no tiene sentido
                    Dim selec_limpiezas As String = "SELECT limpiezas.habitacion_id,limpiezas.reserva_id,limpiezas.item_limpieza_id,fecha_prevista_llegada,'14:00:00'As hora_prevista_llegada, " _
                    & "fecha_prevista_salida, '12:00:00' As hora_prevista_salida,reservas.vip,clientes.desc_corta As ttoo,items_limpieza.item_limpieza,observaciones,habitaciones.zona_limpieza_id " _
                    & "FROM habitaciones " _
                    & "INNER JOIN limpiezas ON limpiezas.habitacion_id = habitaciones.habitacion_id AND limpiezas.habitacion_id = habitaciones.habitacion_id " _
                    & "INNER JOIN reservas ON limpiezas.reserva_id = reservas.reserva_id " _
                    & "Inner Join clientes ON Coalesce(reservas.cliente_id_factura,reservas.cliente_id) = clientes.cliente_id " _
                    & "INNER JOIN items_limpieza ON limpiezas.item_limpieza_id = items_limpieza.item_limpieza_id " _
                    & "WHERE habitaciones.hotel_id = ? AND limpiezas.fecha = ? " _
                    & "AND ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) "
                    selec_limpiezas = selec_limpiezas.Replace("{zona_limpieza_id}", CStr(zona_id))
                    Dim ds_limpiezas As DataSet = getDataSet(cmd, selec_limpiezas)
                    filas = ds_limpiezas.Tables(0).Rows
                    TmpTable = ds.Tables(0).Copy
                    For x = 0 To filas.Count - 1  ' Para cada item de limpieza
                        hab = filas(x).Item("habitacion_id")
                        habitacion_idParam.Value = hab
                        Dim foundRows() As DataRow = TmpTable.Select("habitacion_id=" & hab)
                        For i = 0 To foundRows.GetUpperBound(0)  ' En teoría solo encuentra 1 sería un error otra cosa
                            Dim row As DataRow = foundRows(i)    ' Aqui he cargado todos los campos de la fila
                            If row.Item("item_limpieza") = "VACIA" Then
                                row.Item("item_limpieza") = filas(x).Item("item_limpieza")
                            Else
                                row.Item("item_limpieza") &= " ," & filas(x).Item("item_limpieza")
                            End If
                            row.Item("reserva_id") = filas(x).Item("reserva_id")
                            row.Item("llegada") = filas(x).Item("fecha_prevista_llegada")
                            row.Item("salida") = filas(x).Item("fecha_prevista_salida")
                            row.Item("hora_llegada") = filas(x).Item("hora_prevista_llegada")
                            row.Item("hora_salida") = filas(x).Item("hora_prevista_salida")
                            row.Item("ttoo") = filas(x).Item("ttoo")
                            row.Item("vip") = filas(x).Item("vip")
                            row.Item("observaciones") = filas(x).Item("observaciones")
                            If zona = 0 Then
                                row.Item("zona_limpieza_id") = 0
                            Else
                                row.Item("zona_limpieza_id") = filas(x).Item("zona_limpieza_id")
                            End If
                            borrarDeTabla(ds.Tables(0), "habitacion_id=" & hab, True)
                            ds.Tables(0).AcceptChanges()
                            ds.Tables(0).Rows.Add(row.ItemArray)
                        Next
                    Next
                    ' Al final borro de DS todo lo que no tenga limpieza. Es absurdo cargar los de checkin de días pasados etc
                    borrarDeTabla(ds.Tables(0), "item_limpieza='VACIA'", True)
                    ds.Tables(0).AcceptChanges()
                Else ' para la fecha de hoy o posteriores...........
                    ' Primero busco las Salidas
                    Dim selec_salidas As String = "SELECT habitaciones_bloqueos.habitacion_id,habitaciones_bloqueos.reserva_id,clientes.desc_corta As ttoo, " _
                    & "fecha_prevista_llegada, '14:00:00' As hora_prevista_llegada,fecha_prevista_salida, '12:00:00' As hora_prevista_salida,reservas.vip,reservas.observaciones,zona_limpieza_id,estado_reserva_id " _
                    & "FROM habitaciones_bloqueos " _
                    & "Inner Join reservas ON habitaciones_bloqueos.reserva_id = reservas.reserva_id " _
                    & "Inner Join habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id " _
                    & "Inner Join clientes ON Coalesce(reservas.cliente_id_factura,reservas.cliente_id) = clientes.cliente_id " _
                    & "WHERE reservas.hotel_id=? AND habitaciones_bloqueos.fecha_hasta = ? " _
                    & "AND ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) "
                    selec_salidas = selec_salidas.Replace("{zona_limpieza_id}", CStr(zona_id))
                    Dim ds_salidas As DataSet = getDataSet(cmd, selec_salidas)


                    filas = ds_salidas.Tables(0).Rows
                    TmpTable = ds.Tables(0).Copy
                    For x = 0 To filas.Count - 1 ' Para todas las salidas 
                        hab = filas(x).Item("habitacion_id")
                        habitacion_idParam.Value = hab
                        Dim foundRows() As DataRow = TmpTable.Select("habitacion_id=" & hab)
                        For i = 0 To foundRows.GetUpperBound(0)  ' En teoría solo encuentra 1 sería un error otra cosa
                            Dim row As DataRow = foundRows(i)    ' Aqui he cargado todos los campos de la fila
                            If filas(x).Item("fecha_prevista_salida") = fecha Then
                                row.Item("item_limpieza") = ds_items_limpieza.Tables(0).Select("sw_salida=1")(0).Item("item_limpieza")
                                item_limpieza_idParam.Value = ds_items_limpieza.Tables(0).Select("sw_salida=1")(0).Item("item_limpieza_id")
                            Else
                                row.Item("item_limpieza") = "CAMBIO SALIDA"
                                item_limpieza_idParam.Value = ds_items_limpieza.Tables(0).Select("sw_cambio_salida=1")(0).Item("item_limpieza_id")
                            End If
                            reserva_idParam.Value = filas(x).Item("reserva_id")
                            row.Item("reserva_id") = filas(x).Item("reserva_id")
                            row.Item("llegada") = filas(x).Item("fecha_prevista_llegada")
                            row.Item("salida") = filas(x).Item("fecha_prevista_salida")
                            row.Item("hora_llegada") = filas(x).Item("hora_prevista_llegada")
                            row.Item("hora_salida") = filas(x).Item("hora_prevista_salida")
                            row.Item("ttoo") = filas(x).Item("ttoo")
                            row.Item("vip") = filas(x).Item("vip")
                            row.Item("observaciones") = filas(x).Item("observaciones")
                            If zona = 0 Then
                                row.Item("zona_limpieza_id") = 0
                            Else
                                row.Item("zona_limpieza_id") = filas(x).Item("zona_limpieza_id")
                            End If

                            borrarDeTabla(ds.Tables(0), "habitacion_id=" & hab, True)
                            ds.Tables(0).AcceptChanges()
                            ds.Tables(0).Rows.Add(row.ItemArray)
                            If insertar Then ' Inserto la fila en limpiezas
                                zonaParam.Value = ds_zonas_limpieza.Tables(0).Select("habitacion_id=" & hab)(0).Item("zona_limpieza_id")
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(habitacion_idParam)
                                cmd.Parameters.Add(reserva_idParam)
                                cmd.Parameters.Add(item_limpieza_idParam)
                                cmd.Parameters.Add(fechaParam)
                                'cmd.Parameters.Add(hotel_idParam)
                                'cmd.Parameters.Add(zonaParam)
                                Dim kk = ExecuteNonQuery(cmd, inserta_limpieza)
                                contador += kk
                                If kk = 0 Then
                                    kk = -1
                                End If
                                ' Como son salidas las pongo en estado pendiente de salir situacion_id = 2
                                situacion_idParam.Value = 2
                                If filas(x).Item("estado_reserva_id") = 5 Then ' ya se piró por lo tanto está libre
                                    situacion_idParam.Value = 1
                                End If
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(situacion_idParam)
                                cmd.Parameters.Add(habitacion_idParam)
                                kk = ExecuteNonQuery(cmd, update_situacion)
                            End If
                        Next i
                    Next x
                    ds.Tables(0).AcceptChanges()
                    Dim selec_llegadas As String = "SELECT habitaciones_bloqueos.habitacion_id,habitaciones_bloqueos.reserva_id,clientes.desc_corta As ttoo, " _
                    & "fecha_prevista_llegada, '14:00:00' As hora_prevista_llegada,fecha_prevista_salida, '12:00:00' As hora_prevista_salida,vip,reservas.observaciones, zona_limpieza_id,estado_reserva_id " _
                    & "FROM habitaciones_bloqueos " _
                    & "Inner Join reservas ON habitaciones_bloqueos.reserva_id = reservas.reserva_id " _
                    & "Inner Join habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id " _
                    & "Inner Join clientes ON Coalesce(reservas.cliente_id_factura,reservas.cliente_id) = clientes.cliente_id " _
                    & "WHERE reservas.hotel_id =? AND habitaciones_bloqueos.fecha_desde = ? " _
                    & "AND ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) "
                    selec_llegadas = selec_llegadas.Replace("{zona_limpieza_id}", CStr(zona_id))
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(hotel_idParam)
                    cmd.Parameters.Add(fechaParam)
                    Dim ds_llegadas As DataSet = getDataSet(cmd, selec_llegadas)
                    filas = ds_llegadas.Tables(0).Rows
                    TmpTable = ds.Tables(0).Copy
                    For x = 0 To filas.Count - 1 ' Para todas las llegadas 
                        hab = filas(x).Item("habitacion_id")
                        habitacion_idParam.Value = hab
                        Dim foundRows() As DataRow = TmpTable.Select("habitacion_id=" & hab, "numero")
                        For i = 0 To foundRows.GetUpperBound(0)  ' En teoría solo encuentra 1 sería un error otra cosa
                            Dim row As DataRow = foundRows(i)    ' Aqui he cargado todos los campos de la fila
                            If filas(x).Item("fecha_prevista_llegada") = fecha Then
                                item_limpieza = "LLEGADA"
                                item_limpieza_idParam.Value = ds_items_limpieza.Tables(0).Select("sw_llegada=1")(0).Item("item_limpieza_id")
                            Else
                                item_limpieza = "CAMBIO ENTRADA"
                                item_limpieza_idParam.Value = ds_items_limpieza.Tables(0).Select("sw_cambio_llegada=1")(0).Item("item_limpieza_id")
                            End If

                            If row.Item("item_limpieza") = "VACIA" Then
                                row.Item("item_limpieza") = item_limpieza
                            Else
                                row.Item("item_limpieza") &= " ," & item_limpieza
                            End If
                            reserva_idParam.Value = filas(x).Item("reserva_id")
                            row.Item("reserva_id") = filas(x).Item("reserva_id")
                            row.Item("llegada") = filas(x).Item("fecha_prevista_llegada")
                            row.Item("salida") = filas(x).Item("fecha_prevista_salida")
                            row.Item("hora_llegada") = filas(x).Item("hora_prevista_llegada")
                            row.Item("hora_salida") = filas(x).Item("hora_prevista_salida")
                            row.Item("ttoo") = filas(x).Item("ttoo")
                            row.Item("vip") = filas(x).Item("vip")
                            row.Item("observaciones") = filas(x).Item("observaciones")
                            If zona = 0 Then
                                row.Item("zona_limpieza_id") = 0
                            Else
                                row.Item("zona_limpieza_id") = filas(x).Item("zona_limpieza_id")
                            End If

                            borrarDeTabla(ds.Tables(0), "habitacion_id=" & hab, True)
                            ds.Tables(0).AcceptChanges()
                            ds.Tables(0).Rows.Add(row.ItemArray)

                            If fecha = Fecha_Hotel Then ' Inserto la fila en limpiezas
                                zonaParam.Value = ds_zonas_limpieza.Tables(0).Select("habitacion_id=" & hab)(0).Item("zona_limpieza_id")
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(habitacion_idParam)
                                cmd.Parameters.Add(reserva_idParam)
                                cmd.Parameters.Add(item_limpieza_idParam)
                                cmd.Parameters.Add(fechaParam)
                                'cmd.Parameters.Add(hotel_idParam)
                                'cmd.Parameters.Add(zonaParam)
                                Dim kk = ExecuteNonQuery(cmd, inserta_limpieza)
                                contador += kk
                                If kk = 0 Then
                                    kk = -1
                                End If
                                ' Como son Llegadas las pongo en estado pendiente de entrar situacion_id = 3 salvo que ya haya entrado
                                situacion_idParam.Value = 3
                                If filas(x).Item("estado_reserva_id") = 3 Then ' ya está en checkin
                                    situacion_idParam.Value = 4
                                End If
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(situacion_idParam)
                                cmd.Parameters.Add(habitacion_idParam)
                                kk = ExecuteNonQuery(cmd, update_situacion)
                            End If
                        Next i
                    Next x
                    ds.Tables(0).AcceptChanges()
                    ' Ahora vamos por las bloqueadas por otros motivos
                    TmpTable = ds.Tables(0).Copy
                    Dim selec_bloqueadas As String = "SELECT habitaciones_bloqueos.habitacion_id,fecha_desde,fecha_hasta,zona_limpieza_id " _
                    & "FROM habitaciones_bloqueos " _
                    & "Inner Join habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id " _
                    & "WHERE habitaciones.hotel_id = ? AND " _
                    & "? BETWEEN habitaciones_bloqueos.fecha_desde AND DATE_SUB(habitaciones_bloqueos.fecha_hasta,INTERVAL 1 day) " _
                    & "AND habitaciones_bloqueos.tipo_bloqueo_id NOT IN (1, 6) " _
                    & "AND ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) "
                    selec_bloqueadas = selec_bloqueadas.Replace("{zona_limpieza_id}", CStr(zona_id))
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(hotel_idParam)
                    cmd.Parameters.Add(fechaParam)
                    Dim ds_bloqueadas As DataSet = getDataSet(cmd, selec_bloqueadas)
                    filas = ds_bloqueadas.Tables(0).Rows
                    For x = 0 To filas.Count - 1 ' Para todas las bloqueadas 
                        hab = filas(x).Item("habitacion_id")
                        Dim foundRows() As DataRow = TmpTable.Select("habitacion_id=" & hab, "numero")
                        For i = 0 To foundRows.GetUpperBound(0)  ' En teoría solo encuentra 1 sería un error otra cosa
                            Dim row As DataRow = foundRows(i)    ' Aqui he cargado todos los campos de la fila
                            row.Item("item_limpieza") = "BLOQUEADA"
                            row.Item("reserva_id") = 0
                            row.Item("ttoo") = ""
                            row.Item("vip") = 0
                            row.Item("observaciones") = ""
                            row.Item("llegada") = filas(x).Item("fecha_desde")
                            row.Item("salida") = filas(x).Item("fecha_hasta")
                            If zona = 0 Then
                                row.Item("zona_limpieza_id") = 0
                            Else
                                row.Item("zona_limpieza_id") = filas(x).Item("zona_limpieza_id")
                            End If
                            borrarDeTabla(ds.Tables(0), "habitacion_id=" & hab, True)
                            ds.Tables(0).AcceptChanges()
                            ds.Tables(0).Rows.Add(row.ItemArray)
                        Next i

                        ' Las pongo en estado bloqueada situacion_id = 5
                        habitacion_idParam.Value = hab
                        situacion_idParam.Value = 5
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(situacion_idParam)
                        cmd.Parameters.Add(habitacion_idParam)
                        Dim kk = ExecuteNonQuery(cmd, update_situacion)
                    Next x

                    ds.Tables(0).AcceptChanges()
                    TmpTable = ds.Tables(0).Copy
                    ' Que yo sepa, solo quedan las limpiezas, esto es para las habitaciones bloqueadas con llegada>s_fecha y con salida<s_fecha
                    ' Lo jodido es saber si toca algo y lo que toca
                    ' dependerá de si el contrato es defecto o contrato especial
                    ' En la tabla temporal tengo DS
                    ' Las susceptibles de limpiarse son las habitaciones en checkin, esto es las que s_fecha > llegada y < salida
                    Dim selec_hab_checkin As String = "SELECT habitaciones_bloqueos.habitacion_id,habitaciones_bloqueos.reserva_id,clientes.desc_corta AS ttoo," _
                    & "Coalesce(reservas.cliente_id_factura,reservas.cliente_id) AS cliente_id,reservas.fecha_prevista_llegada,'14:00:00' As hora_prevista_llegada," _
                    & "reservas.fecha_prevista_salida, '12:00:00' As hora_prevista_salida,Coalesce(clientes_limpieza.cliente_id,16) AS cliente_limpieza_id,Coalesce(eco_limpieza,0) as eco_limpieza," _
                    & "items_limpieza.item_limpieza,items_limpieza.item_limpieza_id,clientes_limpieza.cambios_semana,clientes_limpieza.tipo_habitacion_id,clientes_limpieza.primer_dia," _
                    & "clientes_limpieza.sucesivos_cambios,clientes_limpieza.lunes,clientes_limpieza.martes,clientes_limpieza.miercoles,clientes_limpieza.jueves," _
                    & "clientes_limpieza.viernes, clientes_limpieza.sabado,clientes_limpieza.domingo,vip,reservas.observaciones,clientes_limpieza.eco_dias,zona_limpieza_id,habitaciones_bloqueos.fecha_desde " _
                    & "FROM reservas " _
                    & "Inner Join habitaciones_bloqueos ON habitaciones_bloqueos.reserva_id = reservas.reserva_id AND ? BETWEEN DATE_ADD(fecha_desde,INTERVAL 1 DAY) AND DATE_SUB(fecha_hasta,INTERVAL 1 day)  " _
                    & "Inner Join habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id And habitaciones.hotel_id = ? " _
                    & "Inner Join clientes_limpieza ON (Coalesce(reservas.cliente_id_factura,reservas.cliente_id)=clientes_limpieza.cliente_id Or clientes_limpieza.cliente_id =16) AND " _
                    & "clientes_limpieza.hotel_id = ? And clientes_limpieza.tipo_habitacion_id = habitaciones.tipo_habitacion_id " _
                    & "Inner Join clientes ON Coalesce(reservas.cliente_id_factura,reservas.cliente_id)= clientes.cliente_id " _
                    & "Inner Join items_limpieza ON clientes_limpieza.item_limpieza_id = items_limpieza.item_limpieza_id " _
                    & "WHERE ({zona_limpieza_id}=0 OR zona_limpieza_id = {zona_limpieza_id}) " _
                    & "ORDER BY habitaciones_bloqueos.habitacion_id,items_limpieza.item_limpieza_id "
                    selec_hab_checkin = selec_hab_checkin.Replace("{zona_limpieza_id}", CStr(zona_id))
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(fechaParam)
                    cmd.Parameters.Add(hotel_idParam)
                    cmd.Parameters.Add(hotel_idParam1)
                    Dim ds_checkin As DataSet = getDataSet(cmd, selec_hab_checkin)
                    filas = ds_checkin.Tables(0).Rows
                    Dim dia_semana As Integer = 0
                    For x = 0 To filas.Count - 1 ' Para todas ellas miramos el turrón. Tener en cuenta que una misma habitación puede tener varios items de limpieza en el dia
                        hab = filas(x).Item("habitacion_id")
                        habitacion_idParam.Value = hab
                        ' Las pongo en estado Ocupada = 4 Aunque no toque limpieza
                        situacion_idParam.Value = 4
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(situacion_idParam)
                        cmd.Parameters.Add(habitacion_idParam)
                        Dim kk = ExecuteNonQuery(cmd, update_situacion)

                        TmpTable = ds.Tables(0).Copy ' En cada iteración Ds puede haber cambiado
                        Dim foundRows() As DataRow = TmpTable.Select("habitacion_id=" & hab) ' Solo trato las que estaban VACIAS ya que las otras seran llegadas, salidas o cambios
                        For i = 0 To foundRows.GetUpperBound(0)     ' Puede que no haya ninguna o 1
                            Dim row As DataRow = foundRows(i)       ' Aqui he cargado todos los campos de la fila
                            Select Case fecha.DayOfWeek
                                Case DayOfWeek.Monday
                                    dia_semana = filas(x).Item("lunes")
                                Case DayOfWeek.Tuesday
                                    dia_semana = filas(x).Item("martes")
                                Case DayOfWeek.Wednesday
                                    dia_semana = filas(x).Item("miercoles")
                                Case DayOfWeek.Thursday
                                    dia_semana = filas(x).Item("jueves")
                                Case DayOfWeek.Friday
                                    dia_semana = filas(x).Item("viernes")
                                Case DayOfWeek.Saturday
                                    dia_semana = filas(x).Item("sabado")
                                Case DayOfWeek.Sunday
                                    dia_semana = filas(x).Item("domingo")
                            End Select
                            Dim limpiar As Boolean = False  ' Considero que no hay que limpiar
                            If dia_semana = 1 Then ' Toca ese día de la semana ese item otra cosa es que segun cadencia vaya o no
                                ' Hay que mirar la ultima vez que se hizo ese item en esa reserva
                                item_limpieza_idParam.Value = filas(x).Item("item_limpieza_id")
                                reserva_idParam.Value = filas(x).Item("reserva_id")
                                habitacion_idParam.Value = hab
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(reserva_idParam)
                                cmd.Parameters.Add(item_limpieza_idParam)
                                cmd.Parameters.Add(habitacion_idParam)
                                cmd.Parameters.Add(fechaParam)
                                Dim fecha_desde As Date = filas(x).Item("fecha_desde")
                                If item_limpieza_idParam.Value = 1 Then
                                    item_limpieza = 1
                                End If
                                Dim selecc_ultima_limpieza As String = "SELECT fecha FROM limpiezas WHERE reserva_id = ? AND item_limpieza_id =? AND habitacion_id =? And fecha <> ? ORDER BY fecha DESC LIMIT 0,1"
                                Dim fecha_ult_limpieza As Object = ExecuteScalar(cmd, selecc_ultima_limpieza)
                                Dim fecha_llegada As Date = filas(x).Item("fecha_prevista_llegada")
                                Dim fecha_salida As Date = filas(x).Item("fecha_prevista_salida")
                                Dim cambios_sucesivos As Integer = filas(x).Item("sucesivos_cambios")
                                Dim limpieza As String = filas(x).Item("item_limpieza")
                                Dim primer_dia As Integer = filas(x).Item("primer_dia")
                                If IsDate(fecha_ult_limpieza) Then  ' Si hay ultima limpieza entonces busco cambios sucesivos
                                    If fecha_desde > fecha_ult_limpieza Then  ' Si ha habido cambio de habitación desde la ultima limpieza, se considera que lo han limpiado
                                        fecha_ult_limpieza = fecha_desde
                                    End If
                                    Dim n_dias As Integer = DateDiff(DateInterval.Day, fecha_ult_limpieza, fecha)

                                    If filas(x).Item("eco_limpieza") And filas(x).Item("eco_dias") Then ' Si la reserva esta marcada como eco_limpieza y el item lo permite,
                                        cambios_sucesivos += filas(x).Item("eco_dias") ' sumamos lo que diga dia_adicional a cambios_sucesivos 
                                        primer_dia += filas(x).Item("eco_dias")
                                    End If
                                    If IsDate(fecha_ult_limpieza) Then
                                        If n_dias >= cambios_sucesivos Then
                                            limpiar = True  ' Por defecto limpio, pero si se va mañana y los sucesivoss cambios es mayor a 1 entonces no limpio

                                            If cambios_sucesivos > 1 And DateDiff(DateInterval.Day, fecha, fecha_salida) = 1 Then
                                                limpiar = False
                                            End If

                                        End If
                                    End If
                                Else
                                    ' ----------------------------------------------------------------------------------------------------------------------------------------------------
                                    ' Si no hay anteriores, será la primera y entonces miro la diferencia en dias entre hoy y la llegada (cojo el bloqueo de la habitacion ya que ha podido haber cambio
                                    ' y en ese caso, se considera una limpieza comprobando que el primer dia sea menor o igual
                                    ' Tambien compruebo que si se va mañana y cambios_sucesivos >1 no lo limpie
                                    ' ----------------------------------------------------------------------------------------------------------------------------------------------------
                                    If DateDiff(DateInterval.Day, filas(x).Item("fecha_desde"), fecha) >= primer_dia Then
                                        limpiar = True
                                        If cambios_sucesivos > 1 And DateDiff(DateInterval.Day, fecha, fecha_salida) = 1 Then
                                            limpiar = False
                                        End If
                                    End If

                                End If
                            End If
                            If limpiar Then
                                If row.Item("item_limpieza") = "VACIA" Or row.Item("item_limpieza") = "" Then
                                    row.Item("item_limpieza") = filas(x).Item("item_limpieza")
                                Else
                                    row.Item("item_limpieza") &= " ," & filas(x).Item("item_limpieza")
                                End If
                            Else
                                If row.Item("item_limpieza") = "VACIA" Then ' la tenía como limpieza ahora no toca nada y sino, dejo lo que estaba
                                    row.Item("item_limpieza") = ""
                                End If
                            End If
                            row.Item("reserva_id") = filas(x).Item("reserva_id")
                            row.Item("ttoo") = filas(x).Item("ttoo")
                            row.Item("llegada") = filas(x).Item("fecha_prevista_llegada")
                            row.Item("salida") = filas(x).Item("fecha_prevista_salida")
                            row.Item("hora_llegada") = filas(x).Item("hora_prevista_llegada")
                            row.Item("hora_salida") = filas(x).Item("hora_prevista_salida")
                            row.Item("vip") = filas(x).Item("vip")
                            row.Item("observaciones") = filas(x).Item("observaciones")
                            If zona = 0 Then
                                row.Item("zona_limpieza_id") = 0
                            Else
                                row.Item("zona_limpieza_id") = filas(x).Item("zona_limpieza_id")
                            End If
                            borrarDeTabla(ds.Tables(0), "habitacion_id=" & hab, True)
                            ds.Tables(0).AcceptChanges()
                            ds.Tables(0).Rows.Add(row.ItemArray)

                            If fecha = Fecha_Hotel And limpiar Then ' Inserto la fila en limpiezas
                                zonaParam.Value = ds_zonas_limpieza.Tables(0).Select("habitacion_id=" & hab)(0).Item("zona_limpieza_id")
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(habitacion_idParam)
                                cmd.Parameters.Add(reserva_idParam)
                                cmd.Parameters.Add(item_limpieza_idParam)
                                cmd.Parameters.Add(fechaParam)
                                'cmd.Parameters.Add(hotel_idParam)
                                'cmd.Parameters.Add(zonaParam)
                                kk = ExecuteNonQuery(cmd, inserta_limpieza)
                                contador += kk
                                If kk = 0 Then
                                    kk = -1
                                End If

                            End If
                        Next i
                    Next x
                End If
                ' Ahora queda poner el Nombre del cliente, numero de pax y de Bebes. Lo copio de Tano aunque podría hacerlo ccs
                filas = ds.Tables(0).Rows
                For x = 0 To filas.Count - 1
                    If Not IsDBNull(filas(x)("reserva_id")) Then
                        'todo cachear o usar funcion de cacheo
                        cmd.Parameters.Clear()
                        reserva_idParam.Value = CInt(filas(x)("reserva_id"))
                        cmd.Parameters.Add(reserva_idParam)
                        filas(x)("tipo_hab") = ""
                        filas(x)("pax") = 0
                        filas(x)("bebes") = 0
                        Dim sql As String = "SELECT sum(cantidad) AS pax FROM reservas_servicios " _
                        & "INNER JOIN servicios ON servicios.servicio_id = reservas_servicios.servicio_id AND servicios.concepto_acelerador_reservas_id = 99 " _
                        & "WHERE reservas_servicios.reserva_id = ? And reservas_servicios.unidad_calculo_id <> 5"
                        filas(x)("pax") = ExecuteScalar(cmd, sql)
                        sql = "SELECT sum(cantidad) AS pax FROM reservas_servicios " _
                        & "INNER JOIN servicios ON servicios.servicio_id = reservas_servicios.servicio_id AND servicios.concepto_acelerador_reservas_id = 99 " _
                        & "WHERE reservas_servicios.reserva_id = ? And reservas_servicios.unidad_calculo_id = 5"
                        filas(x)("bebes") = ExecuteScalar(cmd, sql)
                        sql = "Select Coalesce(abreviatura, '') From reservas Left Join reservas_tipo_habitacion ON " _
                        & "reservas.reserva_id = reservas_tipo_habitacion.reserva_id where reservas.reserva_id=? "
                        filas(x)("tipo_hab") = ExecuteScalar(cmd, sql)
                    End If
                Next x
            Catch ex As Exception
                errorcode = 1
            End Try
            ds.Tables(0).AcceptChanges()
            ' Ahora solo queda ordenar el DataTable y volver.
            ' Para ello creamos un Dataview Ordenado. El constructor del Dataview tiene (DataTable,Filtro,Sort,DataViewRowState)
            Dim dvk As New DataView(ds.Tables(0), "", "zona_limpieza_id,numero", DataViewRowState.CurrentRows)
            ds = New DataSet()
            ds.Tables.Add(dvk.ToTable())
            Return ds
        End Function
        ' Funcion que sustituye a la de Tano que afortuandamente se llama ObtienenLimpiezas
        Public Function ObtieneLimpiezas(ByVal hotel_id As Integer, ByVal fecha As Date, Optional ByVal zona As Integer = 0, Optional ByVal Desde As Integer = 0, Optional ByVal Hasta As Integer = 0) As DataSet
            Dim cmd As MySqlCommand = prepareConection()
            Dim ds As DataSet = ObtieneLimpiezas(cmd, hotel_id, fecha, zona, Desde, Hasta)
            flushConection(cmd, 0)
            Return ds
        End Function

        Shared sqlObtienetHabitacionesDisponibles = "" _
& " SELECT count(habitaciones.habitacion_id) as habitaciones_disponibles,sum(tipos_habitacion.numero_personas) as CapacidadHotel " _
& " FROM  " _
& " habitaciones inner join tipos_habitacion on habitaciones.tipo_habitacion_id=tipos_habitacion.tipo_habitacion_id " _
& " Left Join habitaciones_bloqueos ON habitaciones.habitacion_id = habitaciones_bloqueos.habitacion_id  " _
& " and (? between habitaciones_bloqueos.fecha_desde and habitaciones_bloqueos.fecha_hasta  and habitaciones_bloqueos.reserva_id is null) " _
& " WHERE " _
& " habitaciones.hotel_id =  ? AND " _
& " ( " _
& " habitaciones.fecha_inicio <=  ? " _
& " or habitaciones.fecha_inicio is null) and (habitaciones.tipo_habitacion_id=? or ?=0) and (tipos_habitacion.desvios=0 or 1=?) and habitaciones_bloqueos.tipo_bloqueo_id is null"
        Private Function ObtieneHabitacionesDisponiblesHotelDia(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal fechaini As Date, Optional ByVal tipo_habitacion_id As Integer = 0, Optional ByVal sindesvios As Boolean = False) As Integer()
            Dim errorCode As Integer = 0
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim fechainiParam As New MySqlParameter("@fechaini", convertFecha(fechaini))
            Dim fechaini1Param As New MySqlParameter("@fechaini1", convertFecha(fechaini))
            Dim tipo_habitacion_idParam As New MySqlParameter("@tipo_habitacion_id", tipo_habitacion_id)
            Dim tipo_habitacion_id1Param As New MySqlParameter("@tipo_habitacion_id1", tipo_habitacion_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(fechainiParam)
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(fechaini1Param)
            cmd.Parameters.Add(tipo_habitacion_idParam)
            cmd.Parameters.Add(tipo_habitacion_id1Param)
            Dim todosParam As New MySqlParameter("@todos", 0)
            If sindesvios Then
                todosParam.Value = 0
            Else
                todosParam.Value = 1
            End If
            cmd.Parameters.Add(todosParam)
            Dim datos As DataTableReader = Me.getDataTable(cmd, sqlObtienetHabitacionesDisponibles)
            Dim dev(1) As Integer
            dev(0) = 0
            dev(1) = 0
            While datos.Read
                'Return Me.ExecuteScalar(cmd, sqlObtienetHabitacionesDisponibles)
                dev(0) = datos.Item("habitaciones_disponibles")
                Try
                    dev(1) = datos.Item("CapacidadHotel")
                Catch ex As Exception

                End Try

            End While
            Return dev

        End Function
        Private Function ObtieneHabitacionesLibresHotel(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal fechaini As Date, Optional ByVal fechafin As Date = Nothing, Optional ByVal reserva_id As Integer = 0, Optional ByVal todas As Boolean = False) As DataSet
            Dim errorCode As Integer = 0

            'todo falta reserva

            If fechafin = #12:00:00 AM# Then
                fechafin = fechaini
            End If
            If fechaini > fechafin Then
                Dim ft As Date = fechaini
                fechaini = fechafin
                fechafin = ft
            End If
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim fechainiParam As New MySqlParameter("@fechaini", convertFecha(fechaini))
            Dim fechafinParam As New MySqlParameter("@fechafin", convertFecha(fechafin))
            Dim fechaini1Param As New MySqlParameter("@fechaini1", convertFecha(fechaini))
            Dim fechafin1Param As New MySqlParameter("@fechafin1", convertFecha(fechafin))
            Dim fechaini2Param As New MySqlParameter("@fechaini2", convertFecha(fechaini))
            Dim fechafin2Param As New MySqlParameter("@fechafin2", convertFecha(fechafin))
            Dim todasParam As New MySqlParameter("@todas", todas)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(fechainiParam)
            cmd.Parameters.Add(fechafinParam)
            cmd.Parameters.Add(fechaini1Param)
            cmd.Parameters.Add(fechafin1Param)
            cmd.Parameters.Add(fechaini2Param)
            cmd.Parameters.Add(fechafin2Param)
            cmd.Parameters.Add(todasParam)
            cmd.Parameters.Add(hotel_idParam)
            Dim lectorDisp As DataTable = getDataSet(cmd, sqlObtieneHabitacionesDispHotelEntreFechas).Tables(0)
            If Not todas Then
                lectorDisp = getDataSet(cmd, sqlObtieneHabitacionesDispHotelEntreFechas).Tables(0)
                Dim filtroBorrado As String = "fecha_inicio>'" & fechaini & "' or "
                Dim fil1 As String = "  not fecha_desde is null "
                If (reserva_id > 0) Then
                    fil1 = " (( reserva_id is null or reserva_id<>" & reserva_id & ") and " & fil1 & ")"
                End If
                filtroBorrado = filtroBorrado & fil1
                borrarDeTabla(lectorDisp, filtroBorrado)
                lectorDisp.AcceptChanges()
            Else
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                lectorDisp = getDataSet(cmd, sqlObtieneHabitacionesHotel).Tables(0)
            End If
            Return lectorDisp.DataSet
        End Function
        Public Function ObtieneHabitacionesLibresHotel(ByVal reserva_id As Integer, Optional ByVal todas As Boolean = False) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim ds As DataSet = Nothing
            Try
                'todo falta reserva
                'busca hotel de una reserva
                'obtiene fecha inicial,final de una reserva
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                Dim row As DataRow = getDataSet(cmd, sqlCabReserva).Tables(0).Rows(0)
                ds = ObtieneHabitacionesLibresHotel(cmd, row.Item("hotel_id"), row.Item("fecha_prevista_llegada"), row.Item("fecha_prevista_salida"), reserva_id, todas)
            Catch ex As Exception
                errorCode = -1
            End Try
            flushConection(cmd, errorCode)
            Return ds
        End Function
        Public Function ObtieneHabitacionesLibresHotel(ByVal hotel_id As Integer, ByVal fechaini As Date, Optional ByVal fechafin As Date = Nothing, Optional ByVal reserva_id As Integer = Nothing) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            'todo falta reserva
            Dim ds As DataSet = ObtieneHabitacionesLibresHotel(cmd, hotel_id, fechaini, fechafin, reserva_id)
            flushConection(cmd, errorCode)
            Return ds
        End Function
        '        concatenarColumna(ds.Tables(0), "reserva_id<>0 and habitacion_id=" & hab, "item_limpieza")
        Private Function concatenarColumna(ByVal servicios As DataTable, ByVal filtro As String, ByVal columna As String, ByVal order As String, ByVal extra As String, ByVal idstr As Object) As String
            Dim trows() As DataRow = servicios.Select(filtro, order)
            Dim row As DataRow
            Dim retValue As String = ""
            With servicios.Rows
                For Each row In trows
                    If retValue = "" Then
                        retValue = row(columna)
                    Else
                        If retValue.IndexOf(row(columna)) < 0 Then
                            If idstr = 0 Then
                                retValue = row(columna)
                            Else
                                retValue = retValue & "," & row(columna)
                            End If

                        End If

                    End If
                Next
            End With
            If extra <> "" Then
                If retValue = "" Then
                    retValue = extra
                Else
                    If retValue.IndexOf(extra) < 0 Then
                        If idstr = 0 Then
                            retValue = extra
                        Else
                            retValue = retValue & "," & extra
                        End If

                    End If
                End If
            End If
            Return retValue
        End Function
        Private Sub borrarDeTabla(ByVal servicios As DataTable, ByVal filtro As String, Optional ByVal borrar As Boolean = False, Optional ByVal columna As String = "", Optional ByVal valor As Object = Nothing)
            Dim trows() As DataRow = servicios.Select(filtro)
            Dim Altrow As DataRow
            With servicios.Rows
                If columna <> "" And Not IsNothing(valor) Then
                    For Each Altrow In trows
                        Altrow(columna) = valor
                    Next
                Else
                    If borrar Then
                        For Each Altrow In trows
                            Altrow.Delete()
                        Next
                    Else
                        For Each Altrow In trows
                            .Remove(Altrow)
                        Next
                    End If
                End If
            End With
        End Sub
        Shared sqlHabitacionEstaBlokeada = "" _
        & "SELECT habitacion_bloqueo_id,habitacion_id,habitaciones_bloqueos.tipo_bloqueo_id,fecha_desde,fecha_hasta,Coalesce(habitaciones_bloqueos.reserva_id,0)As reserva_id,habitaciones_bloqueos.observaciones As observaciones,habitaciones_bloqueos.user_id, habitaciones_bloqueos.fecha_modificacion," _
& " reservas.estado_reserva_id as estado_reserva_id,tipos_bloqueo.descriptivo " _
& " FROM habitaciones_bloqueos LEFT JOIN reservas ON habitaciones_bloqueos.reserva_id=reservas.reserva_id " _
& " INNER JOIN tipos_bloqueo ON habitaciones_bloqueos.tipo_bloqueo_id = tipos_bloqueo.tipo_bloqueo_id" _
& " WHERE " _
& " (habitaciones_bloqueos.habitacion_id =? or 0=? ) AND " _
& " (? BETWEEN  habitaciones_bloqueos.fecha_desde AND  habitaciones_bloqueos.fecha_hasta " _
& " OR ? BETWEEN  habitaciones_bloqueos.fecha_desde AND  habitaciones_bloqueos.fecha_hasta " _
& " OR habitaciones_bloqueos.fecha_desde BETWEEN ? AND ? " _
& " OR habitaciones_bloqueos.fecha_hasta BETWEEN ? AND ?) "

        Shared sqlObtieneHabitacionBloqueada = "select * from habitaciones_bloqueos where habitacion_bloqueo_id=?"
        Shared sqlObietneHotelPorHabitacion = "SELECT hotel_id FROM habitaciones WHERE habitaciones.habitacion_id =  ?"
        Shared sqlObtineDatosHabitacion = "SELECT * FROM habitaciones WHERE habitaciones.habitacion_id =  ?"
        Shared sqlObtieneDatosReseAsignaHabREserva = "" _
& "         SELECT reservas.idioma_id," _
& " reservas.fecha_prevista_llegada as fecha_desde, " _
& " reservas.fecha_prevista_salida as fecha_hasta," _
& " (select max(habitacion_id) from habitaciones_bloqueos where habitaciones_bloqueos.reserva_id=reservas.reserva_id) as oldhabid" _
& " FROM" _
& " reservas " _
& " Inner Join habitaciones ON reservas.hotel_id = habitaciones.hotel_id " _
& " WHERE " _
& " reservas.reserva_id =  ? AND " _
& " habitaciones.habitacion_id =  ? "
        Shared sqlBorrarHabitacionesBloqueadasReserva = "delete from habitaciones_bloqueos where reserva_id=?"
        Public Function AsignaHabitacionReserva(ByVal reserva_id As Integer, ByVal habitacion_id As Integer, Optional sinemail As Boolean = False) As Boolean
            'todo comprobar habitacion y reserva_id es del mismo hotel
            Dim cansend As Boolean = False
            Dim retVal As Boolean = False
            Dim retVal1 As Integer = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim sql_tipo_habitacion_id As String = "SELECT tipo_habitacion_id FROM habitaciones WHERE habitacion_id = " & habitacion_id
            Dim tipo_habitacion_id = 10 ' Por defecto desvio
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            Dim habitacion_idParam As New MySqlParameter("@habitacion_id", habitacion_id)
            Try
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                cmd.Parameters.Add(habitacion_idParam)
                Dim reader As DataTableReader = Me.getDataTable(cmd, sqlObtieneDatosReseAsignaHabREserva)
                While reader.Read And errorCode = 0
                    'crear registro en habitaciones_bloqueos
                    'borrar habitacion cero?
                    'comprobar si habitacion_id ya esta asignada en esa reserva
                    'si no esta asignanda puede manda email

                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(reserva_idParam)
                    Me.ExecuteNonQuery(cmd, sqlBorrarHabitacionesBloqueadasReserva)
                    retVal1 = bloqueaHabitacion(cmd, habitacion_id, reader.Item("fecha_desde"), reader.Item("fecha_hasta"), False, reserva_id, -1, Nothing, True, sinemail)
                    If retVal1 = 0 Then
                        errorCode = -1
                        AgregaInfo("AsignaHabitacionReserva", "Fallo al intentar bloquer la habitacion " & habitacion_id & " para la reserva " & reserva_id, -errorCode)
                    Else
                        'asignar la habitacion bloqueada a los huespedes
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(reserva_idParam)
                        Dim DShuespedes As DataSet = getDataSet(cmd, sqlCabHuespedes)
                        Dim x As Integer
                        If DShuespedes.Tables(0).Rows.Count > 0 Then
                            For x = 0 To DShuespedes.Tables(0).Rows.Count - 1
                                DShuespedes.Tables(0).Rows(x)("habitacion_id") = habitacion_id
                            Next
                            Dim writer As MySqlDataAdapter
                            writer = getDataAdapter(cmd, sqlCabHuespedes)
                            writer.Fill(DShuespedes.Tables(0))
                            writer.Update(DShuespedes.Tables(0))
                        End If
                        retVal = True
                        retVal1 = 0
                        Try
                            If IsDBNull(reader.Item("idioma_id")) OrElse reader.Item("idioma_id") = "" Then  ' Si no ha hecho checkin on line no le mando asignacion de habitacion
                                retVal1 = 0
                            Else

                                If IsDBNull(reader.Item("oldhabid")) Then ' Si no tenía habitacion anteriormente 
                                    retVal1 = 3 ' Mandamos mail de asignación de habitacion
                                ElseIf reader.Item("oldhabid") <> habitacion_id Then
                                    retVal1 = 2  ' Se le ha cambiado la habitacion
                                End If
                            End If
                            tipo_habitacion_id = ExecuteScalar(cmd, sql_tipo_habitacion_id)
                        Catch ex As Exception
                            tipo_habitacion_id = 10
                            retVal1 = 0
                        End Try
                        If tipo_habitacion_id = 10 Then ' Si habitacion desvio, no mando mail a clientes
                            retVal1 = 0
                        End If
                    End If
                End While

            Catch ex As Exception
                retVal = False
                errorCode = 2
                AgregaInfo("AsignaHabitacionReserva", ex.Message, -errorCode)
            End Try
            flushConection(cmd, errorCode)
            If retVal1 > 1 And Not sinemail Then ' Si hay cambio de habitacion (retval1=2) o no tiene asignada habitacion (retval1=3) y se ha hecho dentro del hotel (sinemail=false)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                If Not IsDBNull(ExecuteScalar(cmd, "SELECT idioma_id FROM reservas WHERE reserva_id = ?")) Then
                    EnviarEmailInternoCheckinonline(retVal1, reserva_id)
                End If

            End If
            Return retVal
        End Function

        Private Function EnviarEmailInternoCheckinonline(retVal As Integer, reserva_id As Integer) As Boolean
            Select Case retVal
                Case 1
                    EmailTraducido(reserva_id, "EMAIL_HOTEL_CREATED_BOOKING", True, False)
                Case 2
                    EmailTraducido(reserva_id, "EMAIL_HOTEL_CHANGED_ROOM", True, False)
                Case 3
                    'EmailTraducido(reserva_id, "EMAIL_HOTEL_CREATED_ROOM", True, False)
            End Select
            Return True
        End Function
        Public Function bloqueaHabitacion(ByVal habitacion_id As Integer, ByVal fecha_desde As Date, ByVal fecha_hasta As Date, ByVal validar As Boolean, Optional ByVal reserva_id As Integer = -1, Optional ByVal habitacion_bloqueo_id As Integer = -1, Optional ByVal observaciones As String = Nothing, Optional ByVal forzar As Boolean = False, Optional sinemail As Boolean = False) As Integer
            Dim retVal As Integer
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                retVal = bloqueaHabitacion(cmd, habitacion_id, fecha_desde, fecha_hasta, validar, reserva_id, habitacion_bloqueo_id, observaciones, forzar, sinemail)
                If retVal = 0 Then
                    errorCode = -1
                End If
            Catch ex As Exception
                errorCode = -2
                retVal = 0
            End Try
            flushConection(cmd, errorCode)
            EnviarEmailInternoCheckinonline(retVal, reserva_id)
            Return retVal
        End Function
        Private Function bloqueaHabitacion(ByVal cmd As MySqlCommand, ByVal habitacion_id As Integer, ByVal fecha_desde As Date, ByVal fecha_hasta As Date, ByVal validar As Boolean, Optional ByVal reserva_id As Integer = -1, Optional ByVal habitacion_bloqueo_id As Integer = -1, Optional ByVal observaciones As String = Nothing, Optional ByVal forzar As Boolean = False, Optional sinemail As Boolean = False) As Integer
            Dim retVal As Integer
            Dim errorCode As Integer = 0

            Try


                Dim habitacion_idParam As New MySqlParameter("@habitacion_id", habitacion_id)
                Dim habitacion_bloqueo_idParam As New MySqlParameter("@habitacion_bloqueo_id", habitacion_bloqueo_id)
                Dim fecha_desdeParam As New MySqlParameter("@fecha_desde", fecha_desde)
                Dim fecha_hastaParam As New MySqlParameter("@fecha_hasta", fecha_hasta)
                Dim fecha_desde1Param As New MySqlParameter("@fecha_desde1", fecha_desde)
                Dim fecha_hasta1Param As New MySqlParameter("@fecha_hasta1", fecha_hasta)
                Dim fecha_desde2Param As New MySqlParameter("@fecha_desde2", fecha_desde)
                Dim fecha_hasta2Param As New MySqlParameter("@fecha_hasta2", fecha_hasta)
                Dim habitacion_id_old As Integer
                cmd.Parameters.Clear()
                cmd.Parameters.Add(habitacion_bloqueo_idParam)
                Dim datosold As DataSet = getDataSet(cmd, sqlObtieneHabitacionBloqueada)
                If datosold.Tables(0).Rows.Count > 0 Then
                    habitacion_id_old = datosold.Tables(0).Rows(0).Item("habitacion_id")
                End If
                Dim habitacion_id_oldParam As New MySqlParameter("@habitacion_id_old", habitacion_id_old)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(habitacion_idParam)
                Dim hotel_id As Integer = ExecuteScalar(cmd, sqlObietneHotelPorHabitacion)
                Dim fechacierrehotel As Date = FechaHotel(cmd, hotel_id)

                cmd.Parameters.Clear()
                cmd.Parameters.Add(habitacion_idParam)
                cmd.Parameters.Add(habitacion_id_oldParam)
                cmd.Parameters.Add(fecha_desdeParam)
                cmd.Parameters.Add(fecha_hastaParam)
                cmd.Parameters.Add(fecha_desde1Param)
                cmd.Parameters.Add(fecha_hasta1Param)
                cmd.Parameters.Add(fecha_desde2Param)
                cmd.Parameters.Add(fecha_hasta2Param)
                Dim datos As DataSet = getDataSet(cmd, sqlHabitacionEstaBlokeada)
                'aadir la fila
                Dim row As DataRow
                Dim tmpCol(0) As DataColumn
                tmpCol(0) = datos.Tables(0).Columns("habitacion_bloqueo_id")

                Dim tmpcol1 = datos.Tables(0).PrimaryKey
                datos.Tables(0).PrimaryKey = tmpCol
                row = datos.Tables(0).Rows.Find(habitacion_bloqueo_id)
                datos.Tables(0).PrimaryKey = tmpcol1
                datos.Tables(0).Columns("habitacion_bloqueo_id").AllowDBNull = True
                'si habitacion es distinta...y la fecha de hotel ya ha pasado..crear 2
                If habitacion_bloqueo_id <> -1 Then
                    retVal = habitacion_bloqueo_id
                End If
                If IsNothing(row) Then
                    row = datos.Tables(0).Rows.Add()
                Else
                    If row.Item("habitacion_id") = habitacion_id Then
                        If fechacierrehotel >= row.Item("fecha_desde") And fechacierrehotel <= row.Item("fecha_hasta") Then
                            If row.Item("fecha_hasta") >= fechacierrehotel And fecha_hasta <= fechacierrehotel Then
                                row.Item("fecha_hasta") = fechacierrehotel
                                fecha_desde = row.Item("fecha_desde")
                                fecha_hasta = row.Item("fecha_hasta")
                            End If
                            If row.Item("fecha_desde") <= fechacierrehotel Then
                                fecha_desde = row.Item("fecha_desde")
                            End If
                        End If
                    Else
                        If fechacierrehotel >= row.Item("fecha_desde") And fechacierrehotel <= row.Item("fecha_hasta") Then
                            'If row.Item("fecha_hasta") >= fechacierrehotel And fecha_hasta <= fechacierrehotel Then
                            row.Item("fecha_hasta") = fechacierrehotel
                            fecha_desde = fechacierrehotel
                            'End If
                            row = datos.Tables(0).Rows.Add()
                        End If
                    End If
                End If

                row.Item("habitacion_id") = habitacion_id
                row.Item("tipo_bloqueo_id") = 1 'si existe reserva
                If reserva_id > 0 Then
                    row.Item("reserva_id") = reserva_id
                End If
                row.Item("observaciones") = observaciones
                row.Item("fecha_desde") = fecha_desde
                row.Item("fecha_hasta") = fecha_hasta
                row.Item("user_id") = userId
                row.Item("fecha_modificacion") = Now

                'comprobar integridad estructural
                Dim x As Integer
                Dim y As Integer
                If Not forzar Or fecha_desde = fecha_hasta Then
                    Dim rows As DataRowCollection = datos.Tables(0).Rows
                    Dim repetir As Boolean = True
                    While repetir
                        repetir = False
                        For x = 0 To (rows.Count - 1) And repetir = False
                            If (repetir = True OrElse rows(x).RowState = DataRowState.Deleted) Then
                            Else
                                If rows(x).Item("fecha_desde") = rows(x).Item("fecha_hasta") Then
                                    rows(x).Delete()
                                    repetir = True
                                    retVal = 0
                                Else
                                    For y = x + 1 To (rows.Count - 1) And repetir = False
                                        If (rows(y).RowState = DataRowState.Deleted) Then
                                        Else
                                            If rows(x).Item("habitacion_id") = rows(y).Item("habitacion_id") Then
                                                If rows(x).Item("reserva_id") = rows(y).Item("reserva_id") And rows(x).Item("fecha_desde") = rows(y).Item("fecha_desde") And rows(x).Item("fecha_hasta") = rows(y).Item("fecha_hasta") Then
                                                    'si fechas,reserva igual...eliminar primer registro
                                                    rows(x).Delete()
                                                    repetir = True
                                                    retVal = 0
                                                Else
                                                    If rows(y).Item("fecha_desde") >= rows(x).Item("fecha_desde") And rows(y).Item("fecha_desde") < rows(x).Item("fecha_hasta") Or rows(x).Item("fecha_desde") >= rows(y).Item("fecha_desde") And rows(x).Item("fecha_desde") < rows(y).Item("fecha_hasta") Then
                                                        rows(y).Delete()
                                                        repetir = True
                                                        retVal = 0
                                                    End If
                                                End If
                                            End If
                                        End If
                                    Next
                                End If
                            End If
                        Next
                    End While
                End If
                'actualiza/inserta datos
                Dim writer As MySqlDataAdapter
                Dim changed As Integer = 0
                Try
                    changed = datos.Tables(0).GetChanges().Rows.Count
                Catch ex As Exception

                End Try
                writer = getDataAdapter(cmd, sqlObtieneHabitacionBloqueada)
                writer.Fill(datos.Tables(0))
                writer.Update(datos.Tables(0))
                'Console.WriteLine()
                Dim tmpretVal = Obtiene_ultima_id(cmd)
                If tmpretVal <> 0 Then
                    retVal = 1
                    'aki llegaria si ha tocado algo
                    If changed = 1 Then
                        'contar filas=1
                        If Not sinemail And habitacion_id <> habitacion_id_old Then
                            'tenia hab antes?
                            If habitacion_id_old Then
                                retVal = 2
                                'EmailTraducido(reserva_id, "EMAIL_HOTEL_CHANGED_ROOM", True, True)
                            Else
                                retVal = 3
                                'EmailTraducido(reserva_id, "EMAIL_HOTEL_CREATED_ROOM", True, True)

                            End If

                        End If
                    End If

                    '
                End If

            Catch ex As Exception
                retVal = 0
                errorCode = 1
                AgregaInfo("bloquaHabitacion", "Fallo al intentar bloquer la habitacion " & habitacion_id & " para la reserva " & reserva_id, -errorCode)
            End Try

            'si existe bloqueid modificar sus fechas hasta permitido
            'si fechas colisionan cancelar


            Return retVal
        End Function
        Public Function CompruebaEstadoHabitacion(ByVal habitacion_bloqueo_id As Integer)
            'Dim retVal As Integer
            Dim errorCode As Integer = 0
            Dim tmp As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            Try


                cmd.Parameters.Clear()
                Dim habitacion_bloqueo_idParam As New MySqlParameter("@habitacion_bloqueo_id", habitacion_bloqueo_id)
                cmd.Parameters.Add(habitacion_bloqueo_idParam)
                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneHabitacionBloqueada)

                While reader.Read
                    tmp = CompruebaEstadoHabitacion(cmd, reader("habitacion_id"), reader("reserva_id"), reader("fecha_desde"), reader("fecha_hasta"))
                End While
            Catch ex As Exception

            End Try
            'If retVal = 0 Then
            ' errorCode = -1
            'End If
            flushConection(cmd, errorCode)
            Return tmp

        End Function
        Public Function CompruebaEstadoHabitacion(ByVal habitacion_id As Integer, ByVal reserva_id As Integer, ByVal fecha_desde As Date, ByVal fecha_hasta As Date) As String
            Dim tmp As String = ""
            If habitacion_id <> 0 Then
                Dim errorCode As Integer = 0
                Dim cmd As MySqlCommand = prepareConection()
                Try
                    tmp = CompruebaEstadoHabitacion(cmd, habitacion_id, reserva_id, fecha_desde, fecha_hasta)
                Catch ex As Exception

                End Try

                flushConection(cmd, errorCode)
            End If
            Return tmp
        End Function
        Shared sqlTipoHabitacionesReserva = "" _
& " SELECT" _
& " habitaciones.habitacion_id, " _
& " tipos_habitacion.desc_corta, " _
& " reservas_tipo_habitacion.abreviatura " _
& " FROM " _
& " habitaciones " _
& " Inner Join tipos_habitacion ON habitaciones.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id , " _
& " reservas_tipo_habitacion " _
& " WHERE " _
& " reservas_tipo_habitacion.reserva_id =  ? AND " _
& " habitaciones.habitacion_id =  ? "

        Private Function CompruebaEstadoHabitacion(ByVal cmd As MySqlCommand, ByVal habitacion_id As Integer, ByVal reserva_id As Integer, ByVal fecha_desde As Date, ByVal fecha_hasta As Date) As String
            Dim tmp As String = ""
            If habitacion_id <> 0 Then

                Try
                    Dim habitacion_idParam As New MySqlParameter("@habitacion_id", habitacion_id)
                    Dim habitacion_id1Param As New MySqlParameter("@habitacion_id1", habitacion_id)
                    Dim fecha_desdeParam As New MySqlParameter("@fecha_desde", fecha_desde)
                    Dim fecha_hastaParam As New MySqlParameter("@fecha_hasta", fecha_hasta)
                    Dim fecha_desde1Param As New MySqlParameter("@fecha_desde1", fecha_desde)
                    Dim fecha_hasta1Param As New MySqlParameter("@fecha_hasta1", fecha_hasta)
                    Dim fecha_desde2Param As New MySqlParameter("@fecha_desde2", fecha_desde)
                    Dim fecha_hasta2Param As New MySqlParameter("@fecha_hasta2", fecha_hasta)
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(habitacion_idParam)
                    cmd.Parameters.Add(habitacion_id1Param)
                    cmd.Parameters.Add(fecha_desdeParam)
                    cmd.Parameters.Add(fecha_hastaParam)
                    cmd.Parameters.Add(fecha_desde1Param)
                    cmd.Parameters.Add(fecha_hasta1Param)
                    cmd.Parameters.Add(fecha_desde2Param)
                    cmd.Parameters.Add(fecha_hasta2Param)
                    Dim datos As DataSet = Me.getDataSet(cmd, sqlHabitacionEstaBlokeada)
                    'Dim cont() As DataRow = datos.Tables(0).Select("reserva_id<>" & reserva_id & " and fecha_hasta<>'" + fecha_desde + "'")
                    Dim cont() As DataRow = datos.Tables(0).Select("reserva_id<>" & reserva_id & " and fecha_hasta<>'" + fecha_desde + "' and fecha_desde<>'" + fecha_hasta + "'")

                    If cont.Length > 0 Then
                        Dim x
                        tmp = "Bloqueada:"
                        For x = 0 To cont.Length - 1
                            If cont(x).Item("reserva_id") <> 0 Then
                                tmp &= (" res:" & cont(x).Item("reserva_id"))
                            Else
                                tmp &= (" " & cont(x).Item("descriptivo"))
                            End If
                        Next
                    End If
                    'todo comprobar que la reserva pide un tipo de hab y se le asigna el mismo tipo hab sino warnin
                    cmd.Parameters.Clear()
                    Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                    cmd.Parameters.Add(reserva_idParam)
                    cmd.Parameters.Add(habitacion_idParam)
                    datos = getDataSet(cmd, sqlTipoHabitacionesReserva)
                    cont = datos.Tables(0).Select("desc_corta=abreviatura")
                    If cont.Length = 0 Then
                        Dim x As Integer
                        cont = datos.Tables(0).Select("desc_corta<>abreviatura")
                        For x = 0 To cont.Length - 1
                            tmp &= (" tipo " & cont(x).Item("desc_corta") & "<>" & cont(x).Item("abreviatura"))
                        Next
                    End If

                Catch ex As Exception

                End Try
            Else
                tmp = "Sin Habitacion asignada"
            End If
            Return tmp
            'CompruebaEstadoHabitacion(habitacion_id, reserva_id, fecha_desde, fecha_hasta)
        End Function
        Private Function ObtieneReservasHabitacion(ByVal cmd As MySqlCommand, ByVal habitacion_id As Integer, ByVal fecha_desde As Date, ByVal fecha_hasta As Date, Optional ByVal reserva_id As Integer = 0) As ArrayList
            Dim tmp As New ArrayList
            'If habitacion_id <> 0 Then
            Try
                Dim habitacion_idParam As New MySqlParameter("@habitacion_id", habitacion_id)
                Dim habitacion_id1Param As New MySqlParameter("@habitacion_id1", habitacion_id)
                Dim fecha_desdeParam As New MySqlParameter("@fecha_desde", (fecha_desde))
                Dim fecha_hastaParam As New MySqlParameter("@fecha_hasta", (fecha_hasta))
                Dim fecha_desde1Param As New MySqlParameter("@fecha_desde1", (fecha_desde))
                Dim fecha_hasta1Param As New MySqlParameter("@fecha_hasta1", (fecha_hasta))
                Dim fecha_desde2Param As New MySqlParameter("@fecha_desde2", (fecha_desde))
                Dim fecha_hasta2Param As New MySqlParameter("@fecha_hasta2", (fecha_hasta))
                cmd.Parameters.Clear()
                cmd.Parameters.Add(habitacion_idParam)
                cmd.Parameters.Add(habitacion_id1Param)
                cmd.Parameters.Add(fecha_desdeParam)
                cmd.Parameters.Add(fecha_hastaParam)
                cmd.Parameters.Add(fecha_desde1Param)
                cmd.Parameters.Add(fecha_hasta1Param)
                cmd.Parameters.Add(fecha_desde2Param)
                cmd.Parameters.Add(fecha_hasta2Param)
                Dim datos As DataSet = Me.getDataSet(cmd, sqlHabitacionEstaBlokeada, True)
                Dim cont() As DataRow = datos.Tables(0).Select(" estado_reserva_id<>0 and estado_reserva_id<>2 and fecha_hasta<>'" + fecha_desde + "'")
                'Dim cont() As DataRow = datos.Tables(0).Select(" estado_reserva_id<>0 and estado_reserva_id<>2")
                If cont.Length > 0 Then
                    Dim x
                    For x = 0 To cont.Length - 1
                        If habitacion_id = 0 Then
                            If Not cont(x).IsNull("habitacion_id") And Not cont(x).IsNull("reserva_id") Then
                                If cont(x).Item("reserva_id") = reserva_id Then
                                    tmp.Add(cont(x).Item("habitacion_id"))
                                End If
                            End If
                        Else
                            If Not cont(x).IsNull("reserva_id") Then
                                tmp.Add(cont(x).Item("reserva_id"))
                            End If
                        End If


                    Next
                End If
            Catch ex As Exception

            End Try
            'Else
            'tmp = New ArraList()
            'End If
            Return tmp
            'CompruebaEstadoHabitacion(habitacion_id, reserva_id, fecha_desde, fecha_hasta)
        End Function
        Shared sqlUlitmaFechaHotel = "SELECT Max(cierres.fecha_cierre) FROM cierres WHERE cierres.hotel_id =  ?"
        Private Function ComparaFechaHotel(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As Boolean
            Dim retVal As Boolean = False
            Try
                cmd.Parameters.Clear()
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                cmd.Parameters.Add(reserva_idParam)
                Dim reserva As DataSet = getDataSet(cmd, sqlCabReserva)
                If reserva.Tables(0).Rows.Count > 0 Then
                    Dim row As DataRow = reserva.Tables(0).Rows(0)
                    Dim fecha_hotel As Date = FechaHotel(cmd, row("hotel_id"))
                    If fecha_hotel = row("fecha_prevista_llegada") Then
                        retVal = True
                    End If
                End If
            Catch ex As Exception
                retVal = False
            End Try
            Return retVal
        End Function
        Private Function FechaHotel(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer) As Date
            Dim retVal As Date
            cmd.Parameters.Clear()
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Add(hotel_idParam)
            Try
                retVal = ExecuteScalar(cmd, sqlUlitmaFechaHotel, True)
                retVal = retVal.AddDays(1)
            Catch ex As Exception
                retVal = Now.Date
            End Try
            Return retVal
        End Function
        Function FechaHotel(ByVal hotel_id As Integer) As Date
            Dim retVal As Date
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = FechaHotel(cmd, hotel_id)
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Shared sqlEstadoCaja = "" _
    & "    SELECT" _
    & " arqueos_caja.arqueo_id " _
    & " FROM " _
    & " arqueos_caja" _
    & " WHERE " _
    & " arqueos_caja.tipo_arqueo_id =  2 AND " _
    & " arqueos_caja.caja_id =  ? AND " _
    & " arqueos_caja.fecha =  ? "
        Function EstaCajaAbierta(ByVal cmd As MySqlCommand, ByVal caja_id As Integer, ByVal fecha As Date) As Boolean
            'todo cache...
            Dim retVal As Boolean = False
            If caja_id <> 0 Then
                cmd.Parameters.Clear()
                Dim caja_idParam As New MySqlParameter("@caja_id", caja_id)
                Dim fechaParam As New MySqlParameter("@fecha", fecha)
                cmd.Parameters.Add(caja_idParam)
                cmd.Parameters.Add(fechaParam)

                Dim existe = ExecuteScalar(cmd, sqlEstadoCaja)
                If IsNothing(existe) Then
                    retVal = True
                Else
                    retVal = False
                End If
            End If
            Return retVal
        End Function
        Function EstaCajaAbierta(ByVal caja_id As Integer, ByVal fecha As Date) As Boolean
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = EstaCajaAbierta(cmd, caja_id, fecha)
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Shared sqlImporteTeoricoNuevo = "" _
    & " SELECT " _
    & " sum(movimientos_caja.importe*tipos_movimiento_caja.signo) as importe " _
    & " FROM " _
    & " movimientos_caja " _
    & " Inner Join tipos_movimiento_caja ON movimientos_caja.tipo_movimiento_id = tipos_movimiento_caja.tpo_movimiento_id " _
    & " WHERE " _
    & " movimientos_caja.caja_id = ? AND " _
    & " movimientos_caja.fecha =  ? "
        Shared sqlImporteRealAnterior = "" _
    & " SELECT " _
    & " arqueos_caja.importe_real " _
    & " FROM " _
    & " arqueos_caja " _
    & " WHERE " _
    & " arqueos_caja.caja_id =  ? and arqueos_caja.fecha<? " _
    & " order by fecha desc " _
    & " limit 0,1 "
        Private Function ObtieneImporteTeoricoCaja(ByVal cmd As MySqlCommand, ByVal caja_id As Integer, ByVal fecha As Date) As Single
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim caja_idParam As New MySqlParameter("@caja_id", caja_id)
            Dim fechaParam As New MySqlParameter("@fecha", fecha)
            cmd.Parameters.Add(caja_idParam)
            cmd.Parameters.Add(fechaParam)

            Dim imp As Single = 0
            Dim impant As Single = 0
            Dim ret As Object = ExecuteScalar(cmd, sqlImporteTeoricoNuevo)
            If Not IsDBNull(ret) Then
                imp = ret
            End If
            ret = ExecuteScalar(cmd, sqlImporteRealAnterior)
            If Not IsDBNull(ret) Then
                impant = ret
            End If
            imp = imp + impant
            Return imp
        End Function
        Function ObtieneImporteTeoricoCaja(ByVal caja_id As Integer, ByVal fecha As Date) As Single
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim imp As Single = ObtieneImporteTeoricoCaja(cmd, caja_id, fecha)
            flushConection(cmd, errorCode)
            Return imp
        End Function
        Class Factura
            Public ds As DataSet
            Public cmd As MySqlCommand
            Public errorCode = 0
            Public factura_id As Integer
            Public excuteTrans As Boolean = True
        End Class

        Shared sqlCabCliente = "select * from clientes where cliente_id=?"
        ' ***********************************************
        ' Garra Javier 27/2/2012
        ' Referencia1 para depositos
        ' ***********************************************
        Function preparaFactura(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal cliente_id As Integer, ByVal forma_pago_id As Integer, ByVal fecha As Date, ByVal hotel_id As Integer, ByVal serie_id As Integer, Optional ByVal referencia2 As Object = Nothing, Optional ByVal referencia1 As Object = Nothing)
            Dim fac As Factura = abreFactura(cmd, -1, reserva_id)
            fac.errorCode = 0
            Dim ds As DataSet = fac.ds
            Dim dtcab As DataTable = ds.Tables(0)
            fac.cmd.Parameters(0).Value = cliente_id
            Dim clires As DataTableReader = getDataTable(fac.cmd, sqlCabCliente)
            fac.cmd.Parameters(0).Value = reserva_id
            While clires.Read

                Dim row As DataRow = dtcab.Rows.Add
                row.Item("cliente_id") = cliente_id
                'relleno los demas campos
                row.Item("Fecha_Factura") = fecha 'todo cambiar fecha hotel+1
                Dim addven = clires.Item("vencimiento_facturas_id")
                If IsDBNull(addven) Then
                    addven = 0
                End If
                row.Item("Fecha_Vencimiento") = fecha.AddDays(addven)
                row.Item("hotel_id") = hotel_id
                row.Item("Estado_Factura_Id") = 0 'generada
                row.Item("user_id") = userId
                row.Item("Fecha_modificacion") = Now
                row.Item("Serie_id") = serie_id 'normal
                'row.Item("Forma_Pago_Id") = 1 'contado
                'obtiene datos de la reserva

                row.Item("Ref_Fra1") = ""
                row.Item("Ref_Fra2") = ""
                Dim dr As DatosReserva = obtieneReservaDatosListados(cmd, reserva_id)
                If Not IsNothing(referencia2) And Not IsDBNull(referencia2) Then
                    row.Item("Ref_Fra2") = referencia2
                Else
                    If Not IsNothing(dr) Then
                        'Ref Fra2               : Bono : xxxxxxxxxxx Habit.: xxx  PAX : xxx  Pension : xx   (si es rectificativa, poner los datos de la que rectifica por defecto)
                        row.Item("Ref_Fra2") = "Bono:" & dr.bono & " Habit.:" & dr.habitacion & " Pax:" & dr.pax & " Pension:" & dr.regimen
                    End If
                End If
                If Not IsNothing(referencia1) And Not IsDBNull(referencia1) Then
                    row.Item("Ref_Fra1") = referencia1
                Else
                    If Not IsNothing(dr) Then
                        'Ref Fra para todos : Nombre del 1er Huesped  Del dd/mm/aaaa Al dd/mm/aaaa (si es rectificativa, poner los datos de la que rectifica por defecto)
                        row.Item("Ref_Fra1") = dr.primer_huesped & " del " & dr.fecha_desde.ToShortDateString & " al " & dr.fecha_hasta.ToShortDateString
                    End If
                End If

                'datos cliente
                row.Item("Forma_Pago_Id") = forma_pago_id ' que hacer?
                row.Item("Direccion_Fra") = clires.Item("Direccion_Fra")
                row.Item("Poblacion_Fra") = clires.Item("Poblacion_Fra")
                row.Item("ZIP") = clires.Item("ZIP")
                row.Item("Provincia_Id") = clires.Item("Provincia_Id")

                Dim writer As MySqlDataAdapter
                writer = getDataAdapter(fac.cmd, sqlCabAbreFactura)
                writer.Fill(fac.ds.Tables(0))
                writer.Update(fac.ds.Tables(0))
                fac.factura_id = Obtiene_ultima_id(fac.cmd)
                row.Item("factura_id") = fac.factura_id
                row.AcceptChanges()

            End While
            Return fac
        End Function
        Shared sqlCabReserva = "select * from reservas where reserva_id=?"
        Shared sqlPrimerHuesped = "SELECT cliente_id FROM reservas_huespedes WHERE reserva_id = ? LIMIT 0, 1"

        Private Function preparaFactura(ByVal cmd As MySqlCommand, ByVal forma_pago_id As Integer, ByVal reserva_id As Integer, Optional ByVal primerHuesped As Boolean = False, Optional ByVal extCliente_id As Integer = 0)
            Dim sw_ajuste As Boolean = False

            Dim fac As Factura = abreFactura(cmd, -1, -1)
            fac.cmd.Parameters(0).Value = reserva_id

            Dim cabres As DataTableReader = getDataTable(fac.cmd, sqlCabReserva, True)
            'Dim res As DataSet = getDataSet(fac.cmd, sqlCabReserva)
            'If res.Tables(0).Rows.Count > 0 Then
            'Dim cabres As DataRow = res.Tables(0).Rows(0)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", 0)
            Dim clientes As DataSet
            If cabres.Read Then
                'fac.cmd.Transaction.Commit()
                'TODO cambiar fecha salida por fecha hotel
                Dim cliente_id_factura As Object = Nothing
                If Not cabres.IsDBNull(cabres.GetOrdinal("cliente_id_factura")) Then
                    cliente_id_factura = cabres("cliente_id_factura")
                End If
                Dim fecha As Date = FechaHotel(fac.cmd, cabres.Item("hotel_id"))
                fac.cmd.Parameters(0).Value = reserva_id
                Dim cliente_id As Integer = 0
                Dim primer_huesped_id = ExecuteScalar(fac.cmd, sqlPrimerHuesped)
                If IsDBNull(primer_huesped_id) Or IsNothing(primer_huesped_id) Then
                    primer_huesped_id = cabres.Item("cliente_id")
                End If

                If primerHuesped Then

                    If IsNothing(cliente_id_factura) Then
                        cliente_id = primer_huesped_id 'Me.ExecuteScalar(fac.cmd, sqlPrimerHuesped)
                    Else
                        'si son las manuales...y ese cliente_id_factura es de touroperador..
                        '...elegir primer huesped
                        If forma_pago_id = 1 Then
                            cliente_idParam = cliente_id_factura
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente_idParam)
                            clientes = getDataSet(cmd, sqlCabCliente, 1)

                            If clientes.Tables(0).Rows(0)("grupo_cliente_id") = 5 Then
                                cliente_id = cliente_id_factura
                            Else
                                cliente_id = primer_huesped_id
                            End If
                        Else
                            cliente_id = cliente_id_factura
                        End If

                    End If
                End If

                If cliente_id = 0 Then
                    If extCliente_id = 0 Then
                        If IsNothing(cliente_id_factura) Then
                            cliente_idParam.Value = cabres.Item("cliente_id")
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente_idParam)
                            clientes = getDataSet(cmd, sqlCabCliente, 1)
                            If clientes.Tables(0).Rows(0)("permite_credito") = 1 Then
                                cliente_id = cabres.Item("cliente_id")
                            Else
                                forma_pago_id = 1   'tiene ke ser contado
                                cliente_id = primer_huesped_id
                            End If
                        Else
                            cliente_idParam.Value = cliente_id_factura
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente_idParam)
                            clientes = getDataSet(cmd, sqlCabCliente, 1)
                            If clientes.Tables(0).Rows(0)("permite_credito") = 0 Then
                                forma_pago_id = 1   'tiene ke ser contado
                            End If
                            cliente_id = cliente_id_factura
                        End If
                    Else
                        cliente_idParam.Value = extCliente_id
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(cliente_idParam)
                        clientes = getDataSet(cmd, sqlCabCliente, 1)
                        If clientes.Tables(0).Rows(0)("permite_credito") = 0 Then
                            forma_pago_id = 1   'tiene ke ser contado
                        End If
                        cliente_id = extCliente_id
                    End If
                End If
                '----------------------------------------------------------------------------------------------------------------
                ' Aqui está el turron para cambiar la serie a Rectificativa si es un ajuste
                ' Si ya hay alguna factura de esa reserva y cliente que tenga mas de 1 minuto, entonces es rectificativa
                ' cambio serie_id de la 1 a la 9
                ' GARRA Javier Nuñez Noviembre 2012
                '---------------------------------------------------------------------------------------------------------------------------------------------
                ' Si existe una factura de esa reserva con forma de pago 2, serie_id = 1 y de ese cliente que tiene mas de 10 seg entonces es rectificativa
                ' --------------------------------------------------------------------------------------------------------------------------------------------
                Dim serie_id As Integer = 1        ' Por defecto es 1
                Try

                    If forma_pago_id = 2 Then      ' Las de contado me la pelan
                        cmd.Parameters.Clear()
                        Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                        cmd.Parameters.Add(reserva_idParam)
                        cmd.Parameters.Add(cliente_idParam)
                        'Dim SqlExisteFacturaReserva = "SELECT factura_id FROM facturas WHERE reserva_id = ? AND cliente_id = ? And serie_id =1 AND forma_pago_id=2 AND fecha_modificacion <DATE_SUB(now(),INTERVAL 10 SECOND) Limit 0,1"
                        Dim SqlExisteFacturaReserva = "SELECT MAX(fecha_modificacion) FROM facturas WHERE reserva_id = ? AND cliente_id = ? And serie_id =1 AND forma_pago_id=2 "
                        Dim fecha_modif As Object = ExecuteScalar(cmd, SqlExisteFacturaReserva)
                        If Not IsDBNull(fecha_modif) And Not IsNothing(fecha_modif) Then
                            If DateDiff(DateInterval.Second, fecha_modif, Now) > 10 Then
                                serie_id = 9
                            End If

                        End If
                    End If

                Catch ex As Exception

                End Try
                fac = preparaFactura(fac.cmd, reserva_id, cliente_id, forma_pago_id, fecha, cabres.Item("hotel_id"), serie_id)
            Else
                fac = Nothing
            End If
            Return fac
        End Function
        Function preparaFactura(ByVal cliente_id As Integer, ByVal forma_pago_id As Integer, ByVal reserva_id As Integer)
            Dim fac As Factura = abreFactura(-1, -1)
            fac.cmd.Parameters(0).Value = reserva_id
            Dim cabres As DataTableReader = getDataTable(fac.cmd, sqlCabReserva, True)
            If cabres.Read Then
                'fac.cmd.Transaction.Commit()
                'TODO cambiar fecha salida por fecha hotel
                'Dim fecha As Date = FechaHotel(fac.cmd, cabres.Item("hotel_id"))
                'fac = preparaFactura(fac.cmd, reserva_id, cliente_id, forma_pago_id, fecha, cabres.Item("hotel_id"), 1)
                cabres.Close()
                fac = preparaFactura(fac.cmd, forma_pago_id, reserva_id, False, cliente_id)
            Else
                fac.cmd.Transaction.Rollback()
                fac = Nothing
            End If
            Return fac
        End Function
        Shared sqlCabAbreFactura = "select * from facturas where factura_id=?"
        Shared sqlCabLineasFactura = "select * from lineas_factura where reserva_id=?"

        Private Function abreFactura(ByVal cmd As MySqlCommand, ByVal factura_id As Integer, ByVal reserva_id As Integer) As Factura
            Dim errorCode As Integer = 0

            cmd.Parameters.Clear()
            Dim factura_idParam As New MySqlParameter("@factura_id", factura_id)
            cmd.Parameters.Add(factura_idParam)
            Dim ds As DataSet = getDataSet(cmd, sqlCabAbreFactura)
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Add(reserva_idParam)
            ds = getDataSet(cmd, sqlCabLineasFactura, ds, "lineas_factura")


            'ds.Relations.Add("rel", ds.Tables(0).Columns("factura_id"), ds.Tables(1).Columns("factura_id"))

            Dim fac As Factura = New Factura
            fac.factura_id = factura_id
            fac.ds = ds
            fac.cmd = cmd
            Return fac
        End Function

        Function abreFactura(ByVal factura_id As Integer, ByVal reserva_id As Integer) As Factura
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Return abreFactura(cmd, factura_id, reserva_id)
        End Function
        Function agregaLineaFactura(ByVal fac As Factura) As DataRow
            Dim dsfac As DataTable = fac.ds.Tables(1)
            Dim row As DataRow = dsfac.Rows.Add
            Return row
        End Function
        Function asignaLineasAFactura(ByVal fac As Factura, ByVal filtro As String, Optional ByVal pag_factura As Object = Nothing) As Integer
            Dim extrafiltro = ""
            Dim reset As Integer = 0
            If Not IsNothing(pag_factura) Then
                If IsDBNull(pag_factura) Then
                    extrafiltro = " and pag_factura is null"
                    reset = 1
                Else

                    If pag_factura = 0 Then
                        'todas las paginas
                    Else
                        extrafiltro = " and pag_factura=" & pag_factura
                    End If
                End If
            End If
            Dim rows As DataRow() = fac.ds.Tables(1).Select(filtro & extrafiltro)
            Dim x As Integer
            Dim contador As Integer = 0
            For x = 0 To rows.Length - 1
                If rows(x).IsNull("factura_id") Then
                    rows(x).Item("factura_id") = fac.factura_id
                    If reset = 1 Then
                        rows(x).Item("pag_factura") = 1
                    End If
                    contador += 1
                End If
            Next
            Return contador
        End Function
        Private Function obtienePag_Factura(ByVal fac As Factura, ByVal tipo As String) As Queue
            Dim rows As DataRow() = fac.ds.Tables(1).Select()
            Dim x As Integer
            Dim nh As New Hashtable
            Dim contador As Integer = 0
            For x = 0 To rows.Length - 1
                If rows(x).IsNull("factura_id") And rows(x).Item("tipo_linea_factura") = tipo Then
                    If Not nh.ContainsKey(rows(x).Item("pag_factura")) Then
                        nh.Add(rows(x).Item("pag_factura"), rows(x).Item("pag_factura"))
                    End If

                End If
            Next

            Return New Queue(nh.Keys)
        End Function
        Function cambiaLineaFactura(ByVal linea_factura_id As Integer, ByVal cantidad As Single, ByVal fac As Factura, Optional ByVal completa As Boolean = False, Optional ByVal permiteCambioFactura As Boolean = True) As Boolean
            Dim row As DataRow
            Dim filtro As String = "linea_factura_id=" & linea_factura_id
            Dim rows As DataRow() = fac.ds.Tables(1).Select(filtro)

            If rows.Length = 0 Then
                Return False
            Else
                row = rows(0)
                If completa Then
                    cantidad = row.Item("cantidad")
                End If
                If row.Item("cantidad") <> cantidad Then
                    If cantidad = 0 Then
                        'hay ke desasignarla de la factura
                        row.Item("factura_id") = System.DBNull.Value
                    Else
                        If cantidad < row.Item("cantidad") Then
                            'ha cambiado cantidad...crear duplicado
                            Dim TempRow As DataRow = fac.ds.Tables(1).Rows.Add(row.ItemArray)
                            TempRow.Item("cantidad") = cantidad
                            TempRow.Item("factura_id") = fac.factura_id
                            row.Item("cantidad") = row.Item("cantidad") - cantidad
                            If Not row.IsNull("factura_id") Then
                                row.Item("factura_id") = System.DBNull.Value
                            End If
                        End If
                    End If
                Else
                    'la linea completa
                    If row.IsNull("factura_id") Then
                        row.Item("factura_id") = fac.factura_id
                    Else
                        If row.Item("factura_id") <> fac.factura_id Then
                            If permiteCambioFactura Then
                                row.Item("factura_id") = fac.factura_id
                            End If
                        End If
                    End If
                End If
                Return True
            End If
            'Return True
        End Function
        'Public Sub OnRowUpdating(ByVal sender As Object, ByVal e As System.Data.MysqlRowUpdatingEventArgs)
        '    Dim tmp() As String = e.Command.CommandText.Split("?")
        '    Dim res As String = ""
        '    Dim x As Integer
        '    For x = 0 To e.Command.Parameters.Count - 1
        '        res = res & tmp(x) & e.Command.Parameters(x).Value
        '    Next
        '    Console.WriteLine(res)

        'End Sub
        Private Function actualizarLineas(ByVal fac As Factura)
            Dim writer As MySqlDataAdapter
            Try
                'Console.WriteLine(fac.cmd.Parameters(0).Value)
                'dumpDataTable(fac.ds.Tables(1))
                'fac.cmd.Parameters.Clear()
                writer = getDataAdapter(fac.cmd, sqlCabLineasFactura) 'sqlCabLineasFactura
                'Console.WriteLine(fac.ds.Tables(1).GetChanges().Rows.Count)
                'fac.ds.Tables(1).Rows(0)("precio") = 66.3
                'fac.ds.Tables(1).Rows(0)("precio_produccion") = 49.98
                writer.Fill(fac.ds.Tables(1))
                'writer.
                'writer.ContinueUpdateOnError = True
                'writer.AcceptChangesDuringUpdate = True
                'AddHandler writer.RowUpdating, AddressOf OnRowUpdating

                writer.Update(fac.ds.Tables(1))
            Catch ex As DBConcurrencyException
                Console.WriteLine(fac.cmd.CommandText)
                Console.WriteLine(ex.Row.RowError)
                Return False
            Catch ex As Exception
                AgregaInfo("actualizarLineas", ex.Message, -1)
                Return False
            End Try
            Return True
        End Function
        Function actualizaFactura(ByVal fac As Factura, Optional ByVal cambia_estado As Boolean = False)
            '-----------------------------------------------------------------------------------------------------------------------------------------
            ' Añadimos el parametro optional cambia_estado para que el cambio de estado de la factura esté dentro de la misma transacción
            ' Se hizo para evitar el siniestro caso del 29/12/2012 en GC que quedó una factura creada y no actualizada
            ' Javier Nuñez
            ' ENERO 2013
            '------------------------------------------------------------------------------------------------------------------------------------------
            If fac.ds.Tables(1).Select("factura_id=" & fac.factura_id).Length = 0 Then
                'hay ke destruir la factura
                Dim rows As DataRow() = fac.ds.Tables(0).Select("factura_id=" & fac.factura_id)
                fac.factura_id = -1
                If rows.Length > 0 Then
                    Dim row As DataRow = rows(0)
                    row.Delete()
                    Dim writer As MySqlDataAdapter
                    writer = getDataAdapter(fac.cmd, sqlCabAbreFactura)
                    writer.Fill(fac.ds.Tables(0))
                    writer.Update(fac.ds.Tables(0))
                End If
            End If
            If Not actualizarLineas(fac) Then
                fac.errorCode = 1
                AgregaInfo("actualizaFactura", "No puedo asignar lineas de factura a la cabecera:" & fac.factura_id, -fac.errorCode)
            End If
            If fac.excuteTrans Then
                If cambia_estado Then
                    If fac.factura_id <> -1 Then
                        If Not CambiarEstadoFactura(fac.cmd, fac.factura_id, 1, False) Then
                            fac.errorCode = 2
                            AgregaInfo("actualizaFactura", "No puedo cambiar el estado de la factura:" & fac.factura_id, -fac.errorCode)
                        End If
                    End If
                End If

                flushConection(fac.cmd, fac.errorCode)
            End If
            Return True
        End Function
        Shared sqlObtieneDatosContFacturas = "" _
    & " SELECT " _
    & " facturas.Serie_id, " _
    & " hoteles.empresa_id, " _
    & " year(facturas.Fecha_Factura) AS ano " _
    & " FROM " _
    & " facturas " _
    & " Inner Join hoteles ON facturas.hotel_id = hoteles.hotel_id" _
    & " WHERE " _
    & " facturas.Factura_Id =  ?"
        Shared sqlContadores = "SELECT * FROM contadores FOR UPDATE "
        '"update contadores set contador+=0"
        Shared sqlActualizaContadorFactura = "update facturas set numero_factura=?,estado_factura_id=1 where factura_id=? and estado_factura_id=0"
        Shared sqlActualizaPorcentajeLineasFactura = "Update lineas_factura SET porc_impuesto=(SELECT impuestos.porcentaje FROM impuestos WHERE impuestos.impuesto_id=lineas_factura.impuesto_id)  " _
                                                     & "WHERE lineas_factura.factura_id = ? "
        Public Function ObtieneNumeroFactura(ByVal factura_id As Integer) As Integer
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                retVal = ObtieneNumeroFactura(cmd, factura_id)
            Catch ex As Exception
                errorCode = 1
            End Try
            flushConection(cmd, errorCode)
            Return retVal
        End Function

        Private Function ObtieneNumeroFactura(ByVal cmd As MySqlCommand, ByVal factura_id As Integer) As Integer
            Dim contador As Integer = -1
            cmd.Parameters.Clear()
            Dim factura_idParam As New MySqlParameter("@factura_id", factura_id)
            cmd.Parameters.Add(factura_idParam)

            Dim dtr As DataTableReader = getDataTable(cmd, sqlObtieneDatosContFacturas)
            While dtr.Read
                Dim cont As DataSet = Me.getDataSet(cmd, sqlContadores)
                Dim filtro As String = "empresa_id=" & dtr.Item("empresa_id") & " and ano=" & dtr.Item("ano") & " and serie_id=" & dtr.Item("serie_id")
                Dim rows As DataRow() = cont.Tables(0).Select(filtro)
                Dim row As DataRow
                If rows.Length = 1 Then
                    row = rows(0)
                    Dim aux = row.Item("contador")
                    If IsDBNull(aux) Then 'Contador no existe lo compongo de serie_id:aa:00001
                        aux = Right(dtr.Item("ano"), 2) & dtr.Item("serie_id") & "00001"
                        contador = Convert.ToInt32(aux, 16)
                    Else
                        contador = row.Item("contador")
                    End If
                    row.Item("contador") = contador + 1
                Else
                    row = cont.Tables(0).Rows.Add()
                    row.Item("contador") = 2
                    row.Item("empresa_id") = dtr.Item("empresa_id")
                    row.Item("ano") = dtr.Item("ano")
                    row.Item("serie_id") = dtr.Item("serie_id")
                    contador = 1
                End If

                cmd.Parameters.Clear()
                Dim numero_facturaParam As New MySqlParameter("@numero_factura", contador)
                cmd.Parameters.Add(numero_facturaParam)
                cmd.Parameters.Add(factura_idParam)
                If (ExecuteNonQuery(cmd, sqlActualizaContadorFactura) = 1) Then

                    Dim writer As MySqlDataAdapter
                    writer = getDataAdapter(cmd, sqlContadores)
                    writer.Fill(cont.Tables(0))
                    writer.Update(cont.Tables(0))
                    ' Aqui hay una nueva garra de Xavi Nuñez
                    ' Compruebo que todas las lineas de factura tienen el porcentaje de IGIC que corresponde al día de emisión de facturas
                    ' JUNIO 2012 Cambio IGIC
                    ExecuteNonQuery(cmd, sqlActualizaPorcentajeLineasFactura)
                Else
                    contador = -1 'hubo un error
                    AgregaInfo("ObtieneNumeroFactura", "No puedo actualiza contador factura:" & factura_id, -contador)

                End If
            End While
            Return contador
        End Function
        Shared sqlCrearMovimientoCaja = "select * from movimientos_caja where movimiento_id=-1"
        Private Function CrearMovimientoCaja(ByVal cmd As MySqlCommand, ByVal tipo_mov As Integer, ByVal fecha As Date, ByVal caja_id As Integer, ByVal importe As Double, ByVal item As Integer, ByVal forma_pago_id As Integer)
            Return CrearMovimientoCaja(cmd, tipo_mov, fecha, caja_id, importe, item, forma_pago_id, False)
        End Function
        Private Function CrearMovimientoCaja(ByVal cmd As MySqlCommand, ByVal tipo_mov As Integer, ByVal fecha As Date, ByVal caja_id As Integer, ByVal importe As Double, ByVal item As Integer, ByVal forma_pago_id As Integer, ByVal saltaCierre As Boolean)
            'cache estado cajas 
            Dim retVal = False
            If saltaCierre OrElse EstaCajaAbierta(cmd, caja_id, fecha) Then
                Dim datos As DataSet = getDataSet(cmd, sqlCrearMovimientoCaja)
                Dim Row As DataRow = datos.Tables(0).Rows.Add()
                Row.Item("tipo_movimiento_id") = tipo_mov
                Row.Item("fecha") = fecha
                Row.Item("caja_id") = caja_id
                Row.Item("importe") = importe
                Row.Item("item_id") = item
                Row.Item("user_id") = userId
                Row.Item("fecha_modificacion") = Now
                Row.Item("forma_pago_id") = forma_pago_id
                Dim writer As MySqlDataAdapter
                writer = getDataAdapter(cmd, sqlCrearMovimientoCaja)
                writer.Fill(datos.Tables(0))
                writer.Update(datos.Tables(0))
                retVal = True
            End If
            Return retVal
        End Function
        Shared sqlEstadoGasto = "select forma_pago_id,10 as tipo_movimiento_id,fecha,estado_id,caja_id,importe as total from gastos where gasto_id=?"
        Shared sqlCambiaEstadoGasto = "update gastos set estado_id=? where gasto_id=? and estado_id=?"
        Private Function CambiarEstadoGasto(ByVal cmd As MySqlCommand, ByVal gasto_id As Integer, ByVal estado As Integer, ByVal validar As Boolean)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim gasto_idParam As New MySqlParameter("@gasto_id", gasto_id)
            cmd.Parameters.Add(gasto_idParam)
            Dim estado_anterior As Integer = Nothing
            Dim datos As DataTableReader = getDataTable(cmd, sqlEstadoGasto)
            Dim fecha As Date
            Dim caja_id As Integer
            Dim total As Single
            'Dim tipo_cobro_id As Integer
            Dim forma_pago_id As Integer
            Dim tipo_movimiento_id As Integer
            While datos.Read
                estado_anterior = datos.Item("estado_id")
                fecha = datos.Item("fecha")
                caja_id = datos.Item("caja_id")
                total = datos.Item("total")
                'tipo_cobro_id = datos.Item("tipo_cobro_id")
                forma_pago_id = datos.Item("forma_pago_id")
                tipo_movimiento_id = datos.Item("tipo_movimiento_id")
            End While


            Select Case estado_anterior
                Case 0
                    If estado = 1 Then
                        retVal = True
                        If Not validar Then
                            'todo cambiar estado
                            cmd.Parameters.Clear()
                            Dim estadoParam As New MySqlParameter("@estado", estado)
                            Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                            cmd.Parameters.Add(estadoParam)
                            cmd.Parameters.Add(gasto_idParam)
                            cmd.Parameters.Add(estado_anteriorParam)
                            If ExecuteNonQuery(cmd, sqlCambiaEstadoGasto) <> 1 Then
                                'no puedo cambiar estado

                                retVal = False
                            Else
                                'creo movmientos de cobro en caja asignada si la caja esta abierta
                                '10 gasto
                                If CrearMovimientoCaja(cmd, tipo_movimiento_id, fecha, caja_id, total, gasto_id, forma_pago_id) Then
                                Else
                                    'no puedo crear movimiento de caja
                                    'caja ya cerrada para esa fecha
                                    retVal = False
                                End If

                            End If
                        End If
                    End If
                Case 1
                    retVal = False
                    If estado = 2 Then
                        If validar Then
                            retVal = True
                        Else
                            cmd.Parameters.Clear()
                            Dim estadoParam As New MySqlParameter("@estado", estado)
                            Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                            cmd.Parameters.Add(estadoParam)
                            cmd.Parameters.Add(gasto_idParam)
                            cmd.Parameters.Add(estado_anteriorParam)
                            If ExecuteNonQuery(cmd, sqlCambiaEstadoGasto) <> 1 Then
                                'no puedo cambiar estado
                                retVal = False
                            Else
                                retVal = True
                            End If
                        End If
                    End If
            End Select

            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
                AgregaInfo("CambiarEstadoGasto", "No puedo cambiar el estado del gasto:" & gasto_id, -errorCode)
            End If


            Return retVal
        End Function
        Shared sqlEstadoArqueo = "select estado_id from arqueos_caja where arqueo_id=?"
        Shared sqlCambiaEstadoArqueo = "update arqueos_caja set estado_id=? where arqueo_id=? and estado_id=?"
        Private Function CambiarEstadoArqueo(ByVal cmd As MySqlCommand, ByVal arqueo_id As Integer, ByVal estado As Integer, ByVal validar As Boolean)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim arqueo_idParam As New MySqlParameter("@arqueo_id", arqueo_id)
            cmd.Parameters.Add(arqueo_idParam)
            Dim estado_anterior As Integer = Nothing
            Dim datos As DataTableReader = getDataTable(cmd, sqlEstadoArqueo)
            While datos.Read
                estado_anterior = datos.Item("estado_id")
            End While
            Select Case estado_anterior
                Case 0
                    If estado = 1 Then
                        retVal = True
                    End If
                Case 1
                    If estado = 2 Then
                        retVal = True
                    End If
            End Select

            If retVal And Not validar Then
                'todo cambiar estado
                cmd.Parameters.Clear()
                Dim estadoParam As New MySqlParameter("@estado", estado)
                Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                cmd.Parameters.Add(estadoParam)
                cmd.Parameters.Add(arqueo_idParam)
                cmd.Parameters.Add(estado_anteriorParam)
                If ExecuteNonQuery(cmd, sqlCambiaEstadoArqueo) <> 1 Then
                    'no puedo cambiar estado
                    retVal = False
                Else
                    retVal = True
                End If
            End If

            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
                AgregaInfo("CambiarEstadoArqueo", "No puedo cambiar el estado del arqueo:" & arqueo_id, -errorCode)
            End If


            Return retVal
        End Function
        Shared sqlEstadoAnticipo = "select estado_id from anticipos where anticipo_id=?"
        Shared sqlCambiaEstadoAnticipo = "update anticipos set estado_id=? where anticipo_id=? and estado_id=?"
        Private Function CambiarEstadoAnticipo(ByVal cmd As MySqlCommand, ByVal anticipo_id As Integer, ByVal estado As Integer, ByVal validar As Boolean)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim anticipo_idParam As New MySqlParameter("@anticipo_id", anticipo_id)
            cmd.Parameters.Add(anticipo_idParam)
            Dim estado_anterior As Integer = Nothing
            Dim datos As DataTableReader = getDataTable(cmd, sqlEstadoAnticipo)
            While datos.Read
                estado_anterior = datos.Item("estado_id")
            End While
            Select Case estado_anterior
                Case 0
                    If estado = 1 Then
                        retVal = True
                    End If
                Case 1
                    If estado = 2 Then
                        retVal = True
                    End If
            End Select

            If retVal And Not validar Then
                'todo cambiar estado
                cmd.Parameters.Clear()
                Dim estadoParam As New MySqlParameter("@estado", estado)
                Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                cmd.Parameters.Add(estadoParam)
                cmd.Parameters.Add(anticipo_idParam)
                cmd.Parameters.Add(estado_anteriorParam)
                If ExecuteNonQuery(cmd, sqlCambiaEstadoAnticipo) <> 1 Then
                    'no puedo cambiar estado
                    retVal = False
                Else
                    retVal = True
                End If
            End If

            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
                AgregaInfo("CambiarEstadoAnticipo", "No puedo cambiar el estado del anticipo:" & anticipo_id, -errorCode)
            End If


            Return retVal
        End Function
        Shared sqlEstadoDotacion = "SELECT dotaciones.fecha,dotaciones.estado_id,dotaciones.caja_id,dotaciones.importe AS total,tipos_dotacion.tipo_moviemiento_id as tipo_movimiento_id FROM dotaciones Inner Join tipos_dotacion ON dotaciones.tipo_dotacion_id = tipos_dotacion.tipo_dotacion_id where dotaciones.dotacion_id=?"
        Shared sqlCambiaEstadoDotacion = "update dotaciones set estado_id=? where dotacion_id=? and estado_id=?"

        Private Function CambiarEstadoDotacion(ByVal cmd As MySqlCommand, ByVal dotacion_id As Integer, ByVal estado As Integer, ByVal validar As Boolean)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim dotacion_idParam As New MySqlParameter("@dotacion_id", dotacion_id)
            cmd.Parameters.Add(dotacion_idParam)
            Dim estado_anterior As Integer = Nothing
            Dim datos As DataTableReader = getDataTable(cmd, sqlEstadoDotacion)
            Dim fecha As Date
            Dim caja_id As Integer
            Dim total As Single
            'Dim tipo_cobro_id As Integer
            'Dim forma_pago_id As Integer
            Dim tipo_movimiento_id As Integer
            While datos.Read
                estado_anterior = datos.Item("estado_id")
                fecha = datos.Item("fecha")
                caja_id = datos.Item("caja_id")
                total = datos.Item("total")
                'tipo_cobro_id = datos.Item("tipo_cobro_id")
                'forma_pago_id = datos.Item("forma_pago_id")
                tipo_movimiento_id = datos.Item("tipo_movimiento_id")
            End While


            Select Case estado_anterior
                Case 0
                    If estado = 1 Then
                        retVal = True
                        If Not validar Then
                            'todo cambiar estado
                            cmd.Parameters.Clear()
                            Dim estadoParam As New MySqlParameter("@estado", estado)
                            Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                            cmd.Parameters.Add(estadoParam)
                            cmd.Parameters.Add(dotacion_idParam)
                            cmd.Parameters.Add(estado_anteriorParam)
                            If ExecuteNonQuery(cmd, sqlCambiaEstadoDotacion) <> 1 Then
                                'no puedo cambiar estado
                                retVal = False
                            Else
                                'creo movmientos de cobro en caja asignada si la caja esta abierta
                                If CrearMovimientoCaja(cmd, tipo_movimiento_id, fecha, caja_id, total, dotacion_id, 1) Then
                                Else
                                    'no puedo crear movimiento de caja
                                    'caja ya cerrada para esa fecha
                                    retVal = False
                                End If

                            End If
                        End If
                    End If
                Case 1
                    retVal = False
                    If estado = 2 Then
                        If validar Then
                            retVal = True
                        Else
                            cmd.Parameters.Clear()
                            Dim estadoParam As New MySqlParameter("@estado", estado)
                            Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                            cmd.Parameters.Add(estadoParam)
                            cmd.Parameters.Add(dotacion_idParam)
                            cmd.Parameters.Add(estado_anteriorParam)
                            If ExecuteNonQuery(cmd, sqlCambiaEstadoDotacion) <> 1 Then
                                'no puedo cambiar estado
                                retVal = False
                            Else
                                retVal = True
                            End If
                        End If


                    End If
            End Select

            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
                AgregaInfo("CambiarEstadoDotacion", "No puedo cambiar el estado de la dotacion:" & dotacion_id, -errorCode)
            End If


            Return retVal
        End Function
        Function CambiarEstadoDotacion(ByVal dotacion_id, ByVal estado, ByVal validar)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = CambiarEstadoDotacion(cmd, dotacion_id, estado, validar)
            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
            End If
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function

        Function CambiarEstadoGasto(ByVal gasto_id, ByVal estado, ByVal validar)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = CambiarEstadoGasto(cmd, gasto_id, estado, validar)
            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
            End If
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Shared sqlEstadoCobro = "select cobros.hotel_id as hotel_id,Coalesce(fecha,CURDATE()) as fecha,forma_pago_id,cobros.tipo_cobro_id as tipo_cobro_id ,tipos_cobro.tipo_movimiento_id as tipo_movimiento_id,estado_cobro_id,caja_id,(select sum(importe) from lineas_cobro l where l.cobro_id=cobros.cobro_id)*signo as total from cobros inner join tipos_cobro on tipos_cobro.tipo_cobro_id=cobros.tipo_cobro_id where cobro_id=?"
        'Dim sqlEstadoCobroOld = "select forma_pago_id,tipo_cobro_id,(select tipo_movimiento_id from tipos_cobro l where l.tipo_cobro_id=cobros.tipo_cobro_id) as tipo_movimiento_id,fecha,estado_cobro_id,caja_id,(select sum(importe) from lineas_cobro l where l.cobro_id=cobros.cobro_id) as total from cobros where cobro_id=?"
        Shared sqlCambiaEstadoCobro = "update cobros set estado_cobro_id=?,fecha=? where cobro_id=? and estado_cobro_id=?"
        Shared sqlCuentaLineasCobro = "select count(*) from lineas_cobro where cobro_id=?"

        Shared sqlFacturasCambiarEstado = "SELECT distinct lineas_cobro.factura_id FROM lineas_cobro Inner Join facturas ON lineas_cobro.factura_id = facturas.factura_id" _
        & " WHERE lineas_cobro.cobro_id =  ? AND facturas.serie_id =  '5'"
        Shared sqlCambiarFechaEstadoFactura = "update facturas set fecha_factura=?,estado_factura_id=1 where factura_id =?"
        Private Function CambiarEstadoCobro(ByVal cmd As MySqlCommand, ByVal cobro_id As Integer, ByVal estado As Integer, ByVal validar As Boolean, Optional ByVal fecha As Object = Nothing)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0

            cmd.Parameters.Clear()
            Dim cobro_idParam As New MySqlParameter("@cobro_id", cobro_id)
            cmd.Parameters.Add(cobro_idParam)
            Dim estado_anterior As Integer = Nothing
            Dim datos As DataTableReader = getDataTable(cmd, sqlEstadoCobro)
            Dim caja_id As Integer
            Dim total As Single
            Dim tipo_cobro_id As Integer
            Dim forma_pago_id As Integer
            Dim tipo_movimiento_id As Integer
            While datos.Read
                If IsNothing(fecha) Then
                    fecha = datos.Item("fecha")
                End If
                estado_anterior = datos.Item("estado_cobro_id")
                caja_id = datos.Item("caja_id")
                If Not datos.IsDBNull(datos.GetOrdinal("total")) Then
                    total = datos.Item("total")
                End If
                tipo_cobro_id = datos.Item("tipo_cobro_id")
                forma_pago_id = datos.Item("forma_pago_id")
                tipo_movimiento_id = datos.Item("tipo_movimiento_id")
            End While
            Dim fechaParam As New MySqlParameter("@fecha", fecha)


            Select Case estado_anterior
                Case 0
                    If estado = 1 And ExecuteScalar(cmd, sqlCuentaLineasCobro) > 0 Then
                        'todo comprobar que tiene al menos 1 linea
                        'todo comprobar que todas las facturas esten al menos actualizadas.
                        retVal = True
                        If Not validar Then
                            'todo cambiar estado
                            cmd.Parameters.Clear()
                            Dim estadoParam As New MySqlParameter("@estado", estado)
                            Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                            cmd.Parameters.Add(estadoParam)
                            cmd.Parameters.Add(fechaParam)
                            cmd.Parameters.Add(cobro_idParam)
                            cmd.Parameters.Add(estado_anteriorParam)
                            If ExecuteNonQuery(cmd, sqlCambiaEstadoCobro) <> 1 Then
                                'no puedo cambiar estado
                                retVal = False
                            Else
                                'creo movmientos de cobro en caja asignada si la caja esta abierta
                                '1 cobro-2 devolucion,3=8,9
                                'If tipo_cobro_id = 3 Then
                                'tipo_cobro_id = 8 'y 9
                                'End If

                                'todo si tipo mov es 0(anticipos) no hay moviemiento de cajas
                                If tipo_movimiento_id <> 0 Then
                                    If CrearMovimientoCaja(cmd, tipo_movimiento_id, fecha, caja_id, total, cobro_id, forma_pago_id) Then
                                        cmd.Parameters.Clear()
                                        cmd.Parameters.Add(cobro_idParam)
                                        Dim factura_idParam As New MySqlParameter("@fecha", 0)
                                        'pasar a estado 1 cualquier factura de serie 6 que estuviese en estado 2
                                        Dim reader As DataTableReader = getDataTable(cmd, sqlFacturasCambiarEstado)
                                        cmd.Parameters.Clear()
                                        cmd.Parameters.Add(fechaParam)
                                        cmd.Parameters.Add(factura_idParam)
                                        While reader.Read And retVal
                                            factura_idParam.Value = reader("factura_id")
                                            Console.WriteLine(factura_idParam.Value)
                                            'esas facturas se tienen ke cobrar en su totalidad..

                                            If ExecuteNonQuery(cmd, sqlCambiarFechaEstadoFactura) = 1 Then
                                            Else
                                                'retVal = False
                                            End If
                                        End While


                                    Else
                                        'no puedo crear movimiento de caja
                                        'caja ya cerrada para esa fecha
                                        retVal = False
                                    End If
                                End If
                            End If
                        End If
                    End If
                    If estado = 2 Then
                        If validar Then
                            retVal = False
                        Else
                            cmd.Parameters.Clear()
                            Dim estadoParam As New MySqlParameter("@estado", estado)
                            Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                            cmd.Parameters.Add(estadoParam)
                            cmd.Parameters.Add(fechaParam)
                            cmd.Parameters.Add(cobro_idParam)
                            cmd.Parameters.Add(estado_anteriorParam)
                            If ExecuteNonQuery(cmd, sqlCambiaEstadoCobro) = 1 Then
                                retVal = True
                            Else
                                'no puedo cambiar estado
                                retVal = False
                            End If

                        End If
                    End If
                Case 1
                    If estado = 2 Then
                        If validar = True Then
                            retVal = True
                        Else
                            cmd.Parameters.Clear()
                            Dim estadoParam As New MySqlParameter("@estado", estado)
                            Dim estado_anteriorParam As New MySqlParameter("@estado_anterior", estado_anterior)
                            cmd.Parameters.Add(estadoParam)
                            cmd.Parameters.Add(fechaParam)
                            cmd.Parameters.Add(cobro_idParam)
                            cmd.Parameters.Add(estado_anteriorParam)
                            If ExecuteNonQuery(cmd, sqlCambiaEstadoCobro) = 1 Then
                                retVal = True
                            Else
                                'no puedo cambiar estado
                                retVal = False
                            End If

                        End If
                    Else
                        retVal = False
                    End If

            End Select

            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
                AgregaInfo("CambiarEstadoCobro", "No puedo cambiar el estado del cobro:" & cobro_id, -errorCode)
            End If


            Return retVal
        End Function

        Function CambiarEstadoCobro(ByVal cobro_id As Integer, ByVal estado As Integer, ByVal validar As Boolean, Optional ByVal fecha As Object = Nothing)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = CambiarEstadoCobro(cmd, cobro_id, estado, validar, fecha)
            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
            End If
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Shared sqlBorrarMovimientoCaja As String = "delete from movimientos_caja where item_id=? and tipo_movimiento_id=? and caja_id=? and fecha=?"
        Shared sqlBorrarLineasCobro As String = "delete from lineas_cobro where cobro_id=?"
        Shared sqlBorrarCobro As String = "delete from cobros where cobro_id=?"
        Function AnularCobro(ByVal cobro_id As Integer)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try


                cmd.Parameters.Clear()
                Dim cobro_idParam As New MySqlParameter("@cobro_id", cobro_id)
                cmd.Parameters.Add(cobro_idParam)
                Dim datos As DataTableReader = getDataTable(cmd, sqlEstadoCobro)
                While datos.Read
                    'comprobar ke la fecha del cobro sea igual que la fecha del hotel actual
                    Dim fecha_hotel As Date = FechaHotel(cmd, datos("hotel_id"))
                    If fecha_hotel = datos("fecha") Then
                        'comprobar ke la caja no este cerrada
                        If EstaCajaAbierta(cmd, datos("caja_id"), fecha_hotel) Then
                            'borrar el movimiento de caja
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cobro_idParam)
                            Dim tipo_movimiento_idParam As New MySqlParameter("@tipo_movimiento_id", datos("tipo_movimiento_id"))
                            cmd.Parameters.Add(tipo_movimiento_idParam)
                            Dim caja_idParam As New MySqlParameter("@caja_id", datos("caja_id"))
                            cmd.Parameters.Add(caja_idParam)
                            Dim fechaParam As New MySqlParameter("@fecha", fecha_hotel)
                            cmd.Parameters.Add(fechaParam)
                            If ExecuteNonQuery(cmd, sqlBorrarMovimientoCaja) = 1 Then
                                'borrar las lineas del cobro
                                If ExecuteNonQuery(cmd, sqlBorrarLineasCobro) > 0 Then
                                    'borrar la cabecera del cobro
                                    If ExecuteNonQuery(cmd, sqlBorrarCobro) = 1 Then
                                        retVal = True
                                    Else
                                        errorCode = 5   'no se podria hacer la anulacion
                                        AgregaInfo("AnularCobro", "No puedo borrar cabecera del cobro:" & cobro_id, -errorCode)
                                    End If
                                Else
                                    errorCode = 4   'no se podria hacer la anulacion
                                    AgregaInfo("AnularCobro", "No puedo borrar lineas del cobro:" & cobro_id, -errorCode)
                                End If

                            Else
                                errorCode = 3   'no se podria hacer la anulacion
                                AgregaInfo("AnularCobro", "No puedo borrar el mov de caja:" & cobro_id, -errorCode)
                            End If


                        Else
                            errorCode = 2   'no se podria hacer la anulacion
                            AgregaInfo("AnularCobro", "Caja Ya Cerrada..imposible anular cobro:" & cobro_id, -errorCode)
                        End If
                    Else
                        errorCode = 1   'no se podria hacer la anulacion
                        AgregaInfo("AnularCobro", "Fecha del cobro distinto de fecha del hotel:" & cobro_id, -errorCode)
                    End If

                End While
            Catch ex As Exception
                errorCode = 1   'no se podria hacer la anulacion
                AgregaInfo("AnularCobro", "Excepcion:" & cobro_id, -errorCode)
            End Try

            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
            End If
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        '*******************************************************************************************************************************
        ' Funcion que añade un documento de gasto en un cobro.
        ' La cabecera de la factura ya se creó en CCS. Consta de 3 puntos
        '   1.- Update a facturas añadiendo el campo ref2 con la descripción del servicio
        '   2.- Crear una linea de factura con el servicio, impuestos, cantidad y precio
        '   3.- Añadir una linea de cobro al cobro_id
        ' AUTOR : Javier Nuñez
        ' JULIO 2009
        '********************************************************************************************************************************
        Function Actualiza_gasto_en_cobros(ByVal hotel_id As Integer, ByVal cobro_id As Integer, ByVal factura_id As Integer, ByVal servicio_id As Integer, ByVal cantidad As Double, ByVal precio As Double) As String
            Dim ErrorMsg As String = ""
            Dim descripcion As Object = Nothing
            Dim cmd As MySqlCommand = prepareConection()
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim factura_idParam As New MySqlParameter("@factura_id", factura_id)
            Dim servicio_idParam As New MySqlParameter("@servicio_id", servicio_id)
            Dim cobro_idParam As New MySqlParameter("@cobro_id", cobro_id)
            Dim cantidadParam As New MySqlParameter("@cantidad", cantidad)
            Dim precioParam As New MySqlParameter("@precio", precio)
            Dim ImporteParam As New MySqlParameter("@importe", cantidad * precio)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(servicio_idParam)
            Dim sql As String = "SELECT nombre_servicio FROM servicios WHERE servicio_id = ? "
            descripcion = ExecuteScalar(cmd, sql)
            If IsNothing(descripcion) Then
                ErrorMsg = "Error servicio no encontrado"
            End If
            Dim ref2Param As New MySqlParameter("@descripcion", descripcion)
            ' Ponemos Ref2 de la factura la descripcion del servicio en este caso el gasto
            sql = "UPDATE facturas SET " _
            & " ref_fra2 = ? " _
            & " where factura_id = ? "
            cmd.Parameters.Clear()
            cmd.Parameters.Add(ref2Param)
            cmd.Parameters.Add(factura_idParam)
            Dim errorcode = ExecuteNonQuery(cmd, sql)
            If errorcode <> 1 Then
                ErrorMsg = "Error poniendo ref2 en factura=" & sql
                flushConection(cmd, 1)
                Return ErrorMsg
            End If
            ' una vez cambiada la serie, añado las lineas de factura
            ' pero primero buscamos del servicio_id, el impuesto_id y el porc_impuesto
            sql = "SELECT impuestos.impuesto_id,impuestos.porcentaje FROM servicios_hotel " _
            & "Inner Join impuestos ON servicios_hotel.impuesto_id = impuestos.impuesto_id " _
            & "WHERE servicios_hotel.servicio_id =  ? AND servicios_hotel.hotel_id =  ? "
            Dim impuesto_id As Integer
            Dim porcentaje As Double
            cmd.Parameters.Clear()
            cmd.Parameters.Add(servicio_idParam)
            cmd.Parameters.Add(hotel_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            While reader.Read
                impuesto_id = reader.Item("impuesto_id")
                porcentaje = reader.Item("porcentaje")
            End While
            Dim impuesto_idParam As New MySqlParameter("@impuesto_id", impuesto_id)
            Dim porcentajeParam As New MySqlParameter("@porcentaje", porcentaje)
            sql = "INSERT INTO lineas_factura (hotel_id,factura_id,descripcion,cantidad,precio,impuesto_id,porc_impuesto,servicio_id,unidad_calculo_id,tipo_linea_factura,fecha) VALUES (?,?,?,?,?,'1','0',?,'1','A',now())"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(factura_idParam)
            cmd.Parameters.Add(ref2Param)
            cmd.Parameters.Add(cantidadParam)
            cmd.Parameters.Add(precioParam)
            cmd.Parameters.Add(servicio_idParam)
            cmd.Parameters.Add(impuesto_idParam)
            cmd.Parameters.Add(porcentajeParam)
            errorcode = ExecuteNonQuery(cmd, sql)
            If errorcode <> 1 Then
                ErrorMsg = "Error insertando linea de factura sql=" & sql
                flushConection(cmd, 1)
                Return ErrorMsg
            End If
            ' Cambiamos el estado de ambas facturas a 1 para que ponga nº de contador de facturas
            ' Aunque no se necesita para nada
            If Not (CambiarEstadoFactura(cmd, factura_id, 1, False)) Then
                ErrorMsg = "Error cambiando a estado 1 factura =" & CStr(factura_id)
                flushConection(cmd, 1)
                Return ErrorMsg
            End If
            ' Y ahora la pongo como actualizada
            If Not (CambiarEstadoFactura(cmd, factura_id, 2, False)) Then
                ErrorMsg = "Error cambiando a estado 2 factura =" & CStr(factura_id)
                flushConection(cmd, 1)
                Return ErrorMsg
            End If

            ' Finalmente añadimos la factura de la serie 8 al cobro. 
            sql = "INSERT INTO lineas_cobro (cobro_id,factura_id,importe) VALUES (?,?,?)"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(cobro_idParam)
            cmd.Parameters.Add(factura_idParam)
            cmd.Parameters.Add(ImporteParam)
            errorcode = ExecuteNonQuery(cmd, sql)
            If errorcode <> 1 Then
                ErrorMsg = "Error insertando linea de cobro sql=" & sql
                flushConection(cmd, 1)
                Return ErrorMsg
            End If
            flushConection(cmd, 0)
            Return ErrorMsg
        End Function
        '*******************************************************************************************************************************
        '* Funcion que creando con CCS un descuento para un cobro (son dos cabeceras de factura descuento_id y factura_id)             *
        '* Cambia la serie a uno de ellos, crea la linea del descuento para las dos series una con signo cambiado y añade una al cobro *
        '* Javier Nuñez                                                                                                                *
        '* MAYO 2009                                                                                                                   *
        '* Modificacion Septiembre 2009                                                                                                *
        '* Mismo caso que deposito pero con serie_id = 4 y la nueva factura no cambia de serie                                         *
        '*******************************************************************************************************************************
        Function Actualiza_descuento_en_cobros(ByVal hotel_id As Integer, ByVal cobro_id As Integer, ByVal factura_id As Integer, ByVal descuento_id As Integer, ByVal descripcion As String, ByVal cantidad As Double, ByVal precio As Double, ByVal serie_id As Integer) As String
            Dim ErrorMsg As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            Dim factura_idParam As New MySqlParameter("@factura_id", factura_id)
            Dim descuento_idParam As New MySqlParameter("@descuento_id", descuento_id)
            Dim cobro_idParam As New MySqlParameter("@cobro_id", cobro_id)
            Dim descripcionParam As New MySqlParameter("@descripcion", descripcion)
            Dim cantidadParam As New MySqlParameter("@cantidad", cantidad)
            Dim precioParam As New MySqlParameter("@precio", precio)
            Dim ImporteParam As New MySqlParameter("@importe", cantidad * precio)
            Dim serie_idParam As New MySqlParameter("@serie_id", serie_id)
            ' cambio a la serie 6 una de ellas como rectificativa de la anterior
            ' Esta será la que perdurará para otro cobro y a la que habrá que cambiar en la linea de factura el signo a la cantidad
            If serie_id = 7 Then
                serie_idParam.Value = 6
            End If
            Dim sql As String = ""
            sql = "UPDATE facturas SET "
            sql = sql & "serie_id=?,"
            sql = sql & "id_factura_rectificada =? "
            sql = sql & " where factura_id = ? "
            cmd.Parameters.Clear()
            cmd.Parameters.Add(serie_idParam)
            cmd.Parameters.Add(factura_idParam)
            cmd.Parameters.Add(descuento_idParam)
            Dim errorcode = ExecuteNonQuery(cmd, sql)
            If errorcode <> 1 Then
                ErrorMsg = "Error cambiando la factura de serie sql=" & sql
                flushConection(cmd, 1)
                Return ErrorMsg
            End If
            ' una vez cambiada la serie, añado las lineas de factura
            ' pero primero buscamos el servicio_id, el impuesto_id y el porc_impuesto
            sql = "SELECT series.servicio_id AS servicio_id,series.impuesto_id As impuesto_id,impuestos.porcentaje As porcentaje " _
            & "FROM series " _
            & "Inner Join impuestos ON series.impuesto_id = impuestos.impuesto_id " _
            & "WHERE series.serie_id = ? "
            cmd.Parameters.Clear()
            cmd.Parameters.Add(serie_idParam)
            Dim servicio_id As Integer
            Dim impuesto_id As Integer
            Dim porcentaje As Double
            Dim reader As DataTableReader = getDataTable(cmd, sql)

            While reader.Read
                servicio_id = reader.Item("servicio_id")
                impuesto_id = reader.Item("impuesto_id")
                porcentaje = reader.Item("porcentaje")
            End While
            Dim servicio_idParam As New MySqlParameter("@servicio_id", servicio_id)
            Dim impuesto_idParam As New MySqlParameter("@impuesto_id", impuesto_id)
            Dim porcentajeParam As New MySqlParameter("@porcentaje", porcentaje)
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            sql = "INSERT INTO lineas_factura (hotel_id,factura_id,descripcion,cantidad,precio,impuesto_id,porc_impuesto,servicio_id,unidad_calculo_id,tipo_linea_factura,fecha) VALUES (?,?,?,?,?,'1','0',?,'1','A',now())"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(factura_idParam)
            cmd.Parameters.Add(descripcionParam)
            cmd.Parameters.Add(cantidadParam)
            cmd.Parameters.Add(precioParam)
            cmd.Parameters.Add(servicio_idParam)
            cmd.Parameters.Add(impuesto_idParam)
            cmd.Parameters.Add(porcentajeParam)
            errorcode = ExecuteNonQuery(cmd, sql)
            If errorcode <> 1 Then
                ErrorMsg = "Error insertando 1ª linea de factura sql=" & sql
                flushConection(cmd, 1)
                Return ErrorMsg
            End If
            cantidadParam.Value = -cantidad
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(descuento_idParam)
            cmd.Parameters.Add(descripcionParam)
            cmd.Parameters.Add(cantidadParam)
            cmd.Parameters.Add(precioParam)
            cmd.Parameters.Add(servicio_idParam)
            cmd.Parameters.Add(impuesto_idParam)
            cmd.Parameters.Add(porcentajeParam)
            errorcode = ExecuteNonQuery(cmd, sql)
            If errorcode <> 1 Then
                ErrorMsg = "Error insertando 2ª linea de factura sql=" & sql
                flushConection(cmd, 1)
                Return ErrorMsg
            End If
            ' Cambiamos el estado de ambas facturas a 1 para que ponga nº de contador de facturas
            ' Aunque no se necesita para nada
            If Not (CambiarEstadoFactura(cmd, factura_id, 1, False)) Then
                ErrorMsg = "Error cambiando a estado 1 factura =" & CStr(factura_id)
                flushConection(cmd, 1)
                Return ErrorMsg

            End If
            If Not (CambiarEstadoFactura(cmd, descuento_id, 1, False)) Then
                ErrorMsg = "Error cambiando a estado 1 descuento =" & CStr(descuento_id)
                flushConection(cmd, 1)
                Return ErrorMsg
            End If

            ' Ya hora la pongo como actualizada
            If Not (CambiarEstadoFactura(cmd, factura_id, 2, False)) Then
                ErrorMsg = "Error cambiando a estado 2 factura =" & CStr(factura_id)
                flushConection(cmd, 1)
                Return ErrorMsg

            End If
            If Not (CambiarEstadoFactura(cmd, descuento_id, 2, False)) Then
                ErrorMsg = "Error cambiando a estado 2 descuento =" & CStr(descuento_id)
                flushConection(cmd, 1)
                Return ErrorMsg
            End If

            ' Finalmente añadimos la factura de la serie 7 (la invisible) al cobro, quedará pendiente la 6 
            sql = "INSERT INTO lineas_cobro (cobro_id,factura_id,importe) VALUES (?,?,?)"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(cobro_idParam)
            cmd.Parameters.Add(factura_idParam)
            cmd.Parameters.Add(ImporteParam)
            errorcode = ExecuteNonQuery(cmd, sql)
            If errorcode <> 1 Then
                ErrorMsg = "Error insertando linea de cobro sql=" & sql
                flushConection(cmd, 1)
                Return ErrorMsg
            End If
            flushConection(cmd, 0)
            Return ErrorMsg
        End Function


        Shared sqlEstadoFactura = "select estado_factura_id from facturas where factura_id=?"
        Shared sqlCuentaLineasFacturas = "select count(*) from lineas_factura where factura_id=?"
        Shared sqlCambiarEstadoFactura = "update facturas set estado_factura_id=2 where estado_factura_id=1 and factura_id=?"
        Public Function CambiarEstadoFactura(ByVal cmd As MySqlCommand, ByVal factura_id As Integer, ByVal estado As Integer, ByVal validar As Boolean) As Boolean
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            If Not RecalculaFactura(cmd, factura_id) Then
                errorCode = 2
                AgregaInfo("CambiarEstadoFactura", "No puedo recalcular la  factura:" & factura_id, -errorCode)
            End If
            If errorCode = 0 Then

                cmd.Parameters.Clear()
                Dim factura_idParam As New MySqlParameter("@factura_id", factura_id)
                cmd.Parameters.Add(factura_idParam)
                Dim estado_anterior As Integer = Nothing
                estado_anterior = ExecuteScalar(cmd, sqlEstadoFactura)

                Select Case estado_anterior
                    Case 0
                        If estado = 1 And ExecuteScalar(cmd, sqlCuentaLineasFacturas) > 0 Then
                            'todo comprobar que tiene al menos 1 linea
                            retVal = True
                            If Not validar Then
                                'todo obtener numero de factura
                                If ObtieneNumeroFactura(cmd, factura_id) = -1 Then
                                    retVal = False
                                Else
                                    'colocar bavel
                                    retVal = ColocaEstadoBavel(cmd, factura_id)

                                End If
                            End If
                        End If
                    Case 1
                        If estado = 2 Then
                            If validar Then
                                retVal = True
                            Else
                                If ExecuteNonQuery(cmd, sqlCambiarEstadoFactura) = 1 Then
                                    retVal = True
                                Else
                                    retVal = False
                                End If

                            End If

                        End If
                End Select

                If retVal = False Then
                    errorCode = 1   'no se podria hacer el cambio
                    AgregaInfo("CambiarEstadoFactura", "No puedo cambiar el estado de la factura:" & factura_id, -errorCode)
                End If
            End If

            If errorCode <> 0 Then
                retVal = False
            End If
            Return retVal
        End Function
        Function CambiarEstadoFactura(ByVal factura_id, ByVal estado, ByVal validar)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = CambiarEstadoFactura(cmd, factura_id, estado, validar)
            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
            End If
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Shared sqlEstadoReserva = "SELECT estado_reserva_id FROM reservas WHERE reserva_id =  ? "
        'Dim sqlCambiarEstadoReserva = "Update reservas set estado_reserva_id=?,user_id=?,fecha_modificacion=now(),fecha_llegada=fecha_prevista_llegada,fecha_salida=fecha_prevista_salida where reserva_id=? and estado_reserva_id=?"
        'Dim sqlCambiarEstadoReserva = "Update reservas set estado_reserva_id=?,user_id=?,fecha_modificacion=now(),fecha_llegada=null,fecha_salida=null where reserva_id=? and estado_reserva_id=?"
        'Dim sqlCambiarEstadoReserva = "Update reservas set estado_reserva_id=?,user_id=?,fecha_modificacion=now(),fecha_llegada=null where reserva_id=? and estado_reserva_id=?"
        Shared sqlCambiarEstadoReserva = "Update reservas set fecha_salida=case ?<4 when true then null else fecha_salida end,estado_reserva_id=?,user_id=?,fecha_modificacion=now() where reserva_id=? and estado_reserva_id=?"
        Shared sqlCuentaServicios = "SELECT count(*) FROM reservas_servicios WHERE reservas_servicios.reserva_id =  ?"
        Shared sqlCuentaLineasFacturaSinFacturas = "SELECT count(*) FROM lineas_factura Left Join facturas ON lineas_factura.factura_id = facturas.Factura_Id WHERE lineas_factura.reserva_id = ? AND ( facturas.Estado_Factura_Id = 0 or facturas.Estado_Factura_Id is null)"
        '    Dim sqlCuentaServiciosSinContrato = "SELECT count(*)-count(contrato_id) FROM reservas_servicios WHERE reservas_servicios.reserva_id =  ?"
        Shared sqlCuentaLineasFacturaSinFacturasYTipo = "select count(*) from lineas_factura where factura_id is null and lineas_factura.reserva_id=? and tipo_linea_factura=?"
        Shared sqlCuentaLineasFacturaSinFacturasYDistintoTipo = "select count(*) from lineas_factura where factura_id is null and lineas_factura.reserva_id=? and tipo_linea_factura<>?"
        Shared sqlActulizaFechaSalidaLlegadaReserva = "update reservas set fecha_llegada=fecha_prevista_llegada,fecha_salida=? where (permite_devolucion=1 or fecha_prevista_salida=?) and reserva_id=?"
        Shared sqlFacturaAnticipada = "SELECT IF(Coalesce(clientes_hotel.factura_anticipada,0)=1,1,clientes.factura_anticipada) As factura_anticipada " _
        & "FROM clientes LEFT JOIN clientes_hotel ON clientes.cliente_id=clientes_hotel.cliente_id AND clientes_hotel.hotel_id=(SELECT hotel_id FROM reservas WHERE reservas.reserva_id =?) " _
        & "WHERE clientes.cliente_id=(SELECT Coalesce(reservas.cliente_id_factura,reservas.cliente_id) FROM reservas WHERE reservas.reserva_id =?) "
        Shared sqlCuentaHabitaciones = "SELECT count(*) FROM habitaciones_bloqueos WHERE habitaciones_bloqueos.reserva_id = ?"
        Shared sqlCuentaHabitaciones_no_show = "SELECT count(*) FROM habitaciones_bloqueos " _
        & "INNER JOIN habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id " _
        & "INNER JOIN tipos_habitacion ON habitaciones.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id " _
        & "WHERE habitaciones_bloqueos.reserva_id = ? AND tipos_habitacion.no_show = 1"
        Shared sqlObtieneFechaSalidaYHotelReserva = "select Coalesce(fecha_salida,fecha_prevista_salida) as fecha_salida,hotel_id " _
& ",(select (select numero_habitacion from habitaciones_bloqueos h inner join habitaciones on habitaciones.habitacion_id=h.habitacion_id where h.habitacion_bloqueo_id=max(habitaciones_bloqueos.habitacion_bloqueo_id)) from habitaciones_bloqueos where habitaciones_bloqueos.reserva_id=reservas.reserva_id) as numero_habitacion" _
& " FROM reservas WHERE reservas.reserva_id = ? "


        Function CambiarEstadoReserva(ByVal reserva As Integer, ByVal estado As Integer, ByVal validar As Boolean, Optional forzarPrecheckout As Boolean = False, Optional DatosReservaActual As tablaServicios = Nothing) As Boolean
            Dim errorCode As Integer = 0
            Dim retval As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()
            Try
                errorCode = CambiarEstadoReserva(cmd, reserva, estado, validar, forzarPrecheckout, DatosReservaActual)
            Catch ex As Exception
                errorCode = 2
            End Try

            flushConection(cmd, errorCode)
            If errorCode <> 0 Then
                retval = False
            End If
            Return retval
        End Function
        Shared olddatosReservaActual As tablaServicios = Nothing
        Public Function obtieneServiciosReservaCache(ByVal reserva As Integer) As tablaServicios
            Dim datosReservaActual As tablaServicios = Nothing
            If Not IsNothing(olddatosReservaActual) Then
                If olddatosReservaActual.reserva_id = reserva Then
                    datosReservaActual = olddatosReservaActual
                End If
            End If
            If IsNothing(datosReservaActual) Or 1 = 1 Then
                datosReservaActual = obtieneServiciosReserva(reserva)
            End If
            olddatosReservaActual = datosReservaActual
            If Not IsNothing(olddatosReservaActual) Then
                olddatosReservaActual.reserva_id = reserva
            End If
            Return datosReservaActual
        End Function
        Private Function obtieneServiciosReservaCache(ByVal cmd As MySqlCommand, ByVal reserva As Integer) As tablaServicios
            Dim datosReservaActual As tablaServicios = Nothing
            If Not IsNothing(olddatosReservaActual) Then
                If olddatosReservaActual.reserva_id = reserva Then
                    datosReservaActual = olddatosReservaActual
                End If
            End If
            If IsNothing(datosReservaActual) Then
                datosReservaActual = obtieneServiciosReserva(cmd, reserva)
            End If
            olddatosReservaActual = datosReservaActual
            If Not IsNothing(olddatosReservaActual) Then
                olddatosReservaActual.reserva_id = reserva
            End If
            Return datosReservaActual
        End Function
        Public Function generarEfactura(ByVal factura_id As Integer) As Boolean
            Dim retVal As Boolean = True
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try

                Dim cif_empresa As String = "44503094G"
                Dim cif_hotel As String = "44503094G"
                Dim nombre_hotel As String = "Gran Can"
                Dim nombre_cliente As String = "Cayetano"
                Dim hotel_id As Integer = 2
                Dim numero_factura As String = "1111"
                Dim serie_factura As String = "FAC"
                Dim numero_factura_rectificada As String = Nothing
                Dim serie_factura_rectificada As String = Nothing
                Dim fecha_factura As Date = Today
                Dim direccion_hotel As String = "aki"
                Dim direccion_cliente As String = "alli"
                Dim codigopostal_hotel As String = "35460"
                Dim codigopostal_cliente As String = "35460"
                Dim poblacion_hotel As String = "Galdar"
                Dim provincia_hotel As String = "Galdar"
                Dim poblacion_cliente As String = "Galdar"
                Dim provincia_cliente As String = "Galdar"

                cmd.Parameters.Clear()
                Dim factura_idParam As New MySqlParameter("@factura_id", factura_id)
                cmd.Parameters.Add(factura_idParam)

                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneDatosFacturaParaApunte)

                Dim tefa As New FacturaElectronica.Facturae
                Dim header As New FacturaElectronica.FileHeaderType
                Dim batch As New FacturaElectronica.BatchType
                Dim total_factura As New FacturaElectronica.ImporteType
                total_factura.TotalAmount = 1500.55
                header.Modality = FacturaElectronica.ModalityType.I 'una unica factura
                batch.InvoicesCount = 1 'una unica factura
                batch.BatchIdentifier = "000" & numero_factura
                batch.TotalInvoicesAmount = total_factura
                batch.TotalExecutableAmount = total_factura
                batch.TotalOutstandingAmount = total_factura
                batch.InvoiceCurrencyCode = FacturaElectronica.CurrencyCodeType.EUR 'en euros
                'ahora viene seller (nosotros) buyer(ellos)
                Dim seller_centro(1) As FacturaElectronica.AdministrativeCentreType
                Dim seller As New FacturaElectronica.EmpresaType
                'rellenar datos de hotel
                With seller
                    Dim legal As New FacturaElectronica.LegalEntityType
                    Dim direccion As New FacturaElectronica.AddressType
                    .Item = legal
                    legal.CorporateName = nombre_hotel
                    legal.Item = direccion
                    'FacturaE 3.0,cvc-complex-type.2.4.b: The content of element 'LegalEntity' is not complete. One of '{"":TradeName, "":RegistrationData, "":AddressInSpain, "":OverseasAddress}' is expected.
                    'legal.TradeName = "GRUPO HD"

                    direccion.CountryCode = FacturaElectronica.PaisType.ESP
                    direccion.Address = direccion_hotel
                    direccion.PostCode = codigopostal_hotel
                    direccion.Town = poblacion_hotel
                    direccion.Province = provincia_hotel
                    .TaxIdentification = New FacturaElectronica.TaxIdentificationType
                    .TaxIdentification.PersonTypeCode = FacturaElectronica.PersonTypeCodeType.J 'juridica
                    .TaxIdentification.ResidenceTypeCode = FacturaElectronica.ResidenceTypeCodeType.R 'residente
                    .TaxIdentification.TaxIdentificationNumber = "ES" + cif_hotel
                    '.AdministrativeCentres = seller_centro
                    '.AdministrativeCentres(0) = New FacturaElectronica.AdministrativeCentreType
                    '.AdministrativeCentres(0).CentreCode = hotel_id
                    '.AdministrativeCentres(0).RoleTypeCode = FacturaElectronica.RoleTypeCodeType.Item01

                End With

                Dim buyer_centro(1) As FacturaElectronica.AdministrativeCentreType
                Dim buyer As New FacturaElectronica.EmpresaType

                'rellenar datos de empresa
                With buyer
                    Dim legal As New FacturaElectronica.LegalEntityType
                    Dim direccion As New FacturaElectronica.AddressType
                    .Item = legal
                    legal.Item = direccion
                    legal.CorporateName = nombre_cliente
                    '                    legal.TradeName = nombre_cliente
                    direccion.CountryCode = FacturaElectronica.PaisType.ESP
                    direccion.Address = direccion_cliente
                    direccion.PostCode = codigopostal_cliente
                    direccion.Town = poblacion_cliente
                    direccion.Province = provincia_cliente
                    .TaxIdentification = New FacturaElectronica.TaxIdentificationType
                    .TaxIdentification.PersonTypeCode = FacturaElectronica.PersonTypeCodeType.J 'juridica
                    .TaxIdentification.ResidenceTypeCode = FacturaElectronica.ResidenceTypeCodeType.R 'residente
                    .TaxIdentification.TaxIdentificationNumber = "ES" + cif_empresa
                    '.AdministrativeCentres = buyer_centro
                    '.AdministrativeCentres(0) = New FacturaElectronica.AdministrativeCentreType
                    '.AdministrativeCentres(0).CentreCode = hotel_id
                    '.AdministrativeCentres(0).RoleTypeCode = FacturaElectronica.RoleTypeCodeType.Item01
                End With

                tefa.Parties = New FacturaElectronica.PartiesType
                tefa.Parties.SellerParty = seller
                tefa.Parties.BuyerParty = buyer
                'la factura y sus lineas
                Dim invoices(1) As FacturaElectronica.InvoiceType
                tefa.Invoices = invoices
                tefa.Invoices(0) = New FacturaElectronica.InvoiceType
                tefa.Invoices(0).InvoiceHeader = New FacturaElectronica.InvoiceHeaderType
                With tefa.Invoices(0).InvoiceHeader
                    .InvoiceNumber = numero_factura
                    .InvoiceSeriesCode = serie_factura
                    .InvoiceDocumentType = FacturaElectronica.InvoiceDocumentTypeType.FC 'factura completa
                    If IsNothing(numero_factura_rectificada) Then
                        .InvoiceClass = FacturaElectronica.InvoiceClassType.OO
                    Else
                        .InvoiceClass = FacturaElectronica.InvoiceClassType.OR
                        .Corrective = New FacturaElectronica.CorrectiveType
                        .Corrective.InvoiceNumber = numero_factura_rectificada
                        .Corrective.InvoiceSeriesCode = serie_factura_rectificada

                    End If
                End With
                tefa.Invoices(0).InvoiceIssueData = New FacturaElectronica.InvoiceIssueDataType
                With tefa.Invoices(0).InvoiceIssueData
                    .IssueDate = fecha_factura
                    .InvoiceCurrencyCode = FacturaElectronica.CurrencyCodeType.EUR
                    .TaxCurrencyCode = FacturaElectronica.CurrencyCodeType.EUR
                    .InvoicingPeriod = New FacturaElectronica.PeriodDates
                    .InvoicingPeriod.StartDate = fecha_factura
                    .InvoicingPeriod.EndDate = fecha_factura
                End With
                Dim lista_lineas As New ArrayList
                Dim cuota_total As Decimal = 0
                Dim Total As Decimal = 0
                Dim basecci As FicheroContabilidad.BaseCCI = New FicheroContabilidad.BaseCCI(0)

                While reader.Read
                    Dim linea As New FacturaElectronica.InvoiceLineType
                    Dim Base As Decimal
                    Dim cuota As Decimal
                    With reader
                        Base = Math.Round(.Item("Precio_Base") * .Item("Cantidad"), 2, MidpointRounding.AwayFromZero)
                        Total += Base
                        If .IsDBNull(.GetOrdinal("Porc_Igic")) Or .IsDBNull(.GetOrdinal("CTA_IGIC")) Then
                            retVal = False
                        Else

                            cuota = basecci.agregaImpuesto(.Item("Porc_Igic"), Base, .Item("CTA_IGIC"))
                        End If
                    End With
                    With linea
                        Dim taxes(1) As FacturaElectronica.TaxType
                        .TaxesOutputs = taxes
                        taxes(0) = New FacturaElectronica.TaxType
                        Dim efbase As New FacturaElectronica.ImporteType
                        efbase.TotalAmount = Base - cuota
                        Dim efcuota As New FacturaElectronica.ImporteType
                        efcuota.TotalAmount = cuota
                        taxes(0).TaxableBase = efbase
                        taxes(0).TaxAmount = efcuota
                        'taxes(0).TaxRate = "05,00"
                        taxes(0).TaxRate = reader.Item("Porc_Igic")
                        taxes(0).TaxTypeCode = FacturaElectronica.TaxTypeCodeType.Item01
                        .Quantity = reader("cantidad")
                        .UnitPriceWithoutTax = Math.Round((Base - cuota) / reader("cantidad"), 6)
                        .TotalCost = (Base - cuota)
                        .ItemDescription = reader("descripcion")
                        .GrossAmount = .TotalCost
                    End With
                    lista_lineas.Add(linea)
                End While
                Dim lineas(lista_lineas.Count) As FacturaElectronica.InvoiceLineType
                lista_lineas.ToArray.CopyTo(lineas, 0)
                tefa.Invoices(0).Items = lineas

                Dim imp(1) As FacturaElectronica.TaxType
                'TODO por cada tipo de impuesto generar un total
                imp(0) = New FacturaElectronica.TaxType
                Dim baseimp As New FacturaElectronica.ImporteType()
                baseimp.TotalAmount = 40.15
                imp(0).TaxableBase = baseimp
                imp(0).TaxAmount = baseimp
                imp(0).TaxRate = 15.99
                imp(0).TaxTypeCode = FacturaElectronica.TaxTypeCodeType.Item01
                tefa.Invoices(0).TaxesOutputs = imp

                'tefa.Invoices(0).TaxesWithheld = imp
                tefa.Invoices(0).InvoiceTotals = New FacturaElectronica.InvoiceTotalsType
                With tefa.Invoices(0).InvoiceTotals
                    .TotalGrossAmount = 10.15
                    .TotalGrossAmountBeforeTaxes = 10.15
                    .TotalTaxOutputs = 10.15
                    .TotalTaxesWithheld = 10.15
                    .InvoiceTotal = 10.15

                    .TotalOutstandingAmount = 10.15
                    .TotalExecutableAmount = 10.15
                End With

                'lineas facturas
                'generar base por linea
                'acumular base y cuota

                'batch.InvoiceCurrencyCode =

                header.Batch = batch
                tefa.FileHeader = header
                '            Dim efactura As DataSet = New DataSet("Test")
                '            efactura.ReadXml("C:\Proyectos Codecharge\ClasesGesHotel_tano\ClasesGesHotel\Facturae30.xsd")

                'x()
                'obtener datos de factura
                'obtener el xsd
                'popular datos
                'genera xml
                Dim serializer As New XmlSerializer(GetType(FacturaElectronica.Facturae))
                Dim temp As String
                Dim stream As System.IO.MemoryStream = New System.IO.MemoryStream()
                Dim tem = New System.Xml.XmlTextWriter(stream, System.Text.Encoding.UTF8)
                serializer.Serialize(tem, tefa)
                temp = System.Text.Encoding.UTF8.GetString(stream.ToArray())
                Console.WriteLine(temp)
                'certificar normal xml

                'grabar blob en tabla facturas
            Catch ex As Exception
                retVal = False
            Finally
                'retVal = False
                If Not retVal Then
                    errorCode = 1
                End If
                flushConection(cmd, errorCode)
            End Try
            Return retVal

        End Function
        Shared sqlEnviarEmailReserva = "" _
& " SELECT " _
& " reservas.email,case reservas.estado_reserva_id when 2 then 'Anulacion' else 'Confirmacion' end as estado, " _
& " hoteles.email_reservas, " _
& " hoteles.email_ventas, " _
& " hoteles.email_smtp " _
& " FROM " _
& " reservas" _
& " Inner Join hoteles ON reservas.hotel_id = hoteles.hotel_id " _
& " WHERE " _
& " reservas.reserva_id =  ? AND " _
& " reservas.email IS NOT NULL  "
        Public Function readHtmlPage(ByVal url As String) As String
            Dim result As String
            Dim objResponse As Net.WebResponse
            Dim objRequest As Net.WebRequest = System.Net.HttpWebRequest.Create(url)
            objResponse = objRequest.GetResponse()

            Dim sr As IO.StreamReader = New IO.StreamReader(objResponse.GetResponseStream(), System.Text.Encoding.GetEncoding("windows-1252"))
            result = sr.ReadToEnd
            sr.Close()
            Return result
        End Function

        Function regenerarLineasFacturasReserva(ByVal reserva_id As Integer)
            'Return True
            Dim errorCode As Integer = 0
            Dim retVal As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()
            Try
                cmd.Parameters.Clear()
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                cmd.Parameters.Add(reserva_idParam)
                Dim hotel_id As Integer = ExecuteScalar(cmd, sqlObtieneHotelReserva)
                Dim reserva_idParam2 As New MySqlParameter("@reserva_id", reserva_id)

                Dim fecha As Date = FechaHotel(cmd, hotel_id)

                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                cmd.Parameters.Add(reserva_idParam2)

                Dim clientefactura As Boolean
                Dim tmpt = ExecuteScalar(cmd, sqlFacturaAnticipada)
                If IsDBNull(tmpt) Then
                    tmpt = False
                End If
                clientefactura = tmpt
                If clientefactura Then
                    Dim estado_anterior As Integer = Nothing
                    estado_anterior = ExecuteScalar(cmd, sqlEstadoReserva, True)
                    If estado_anterior >= 3 And estado_anterior <= 4 Then
                        olddatosReservaActual = Nothing
                        Dim datosReservaActual As tablaServicios = obtieneServiciosReservaCache(cmd, reserva_id)

                        If datosReservaActual.sumaErrores = 0 Then
                            Dim fechamin As Date = datosReservaActual.servicios.Compute("min(fecha)", "")
                            Dim fechamax As Date = datosReservaActual.servicios.Compute("max(fecha)", "")
                            'fechamax = fechamax.AddDays(-1)
                            If fechamin < fecha Then
                                fechamin = fecha
                            End If

                            While retVal And fechamin <= fechamax
                                retVal = generaAjuste(cmd, reserva_id, datosReservaActual, fechamin)
                                fechamin = fechamin.AddDays(1)
                                olddatosReservaActual = Nothing
                                datosReservaActual = obtieneServiciosReservaCache(cmd, reserva_id)
                            End While
                            If retVal Then
                                retVal = generaAjuste(cmd, reserva_id, datosReservaActual, Nothing, False, False, Nothing, True)
                                'retVal = generaAjuste(cmd, reserva_id, datosReservaActual)
                            End If
                            If retVal Then
                            Else
                                errorCode = 2
                                AgregaInfo("regenerarLineasFacturasReserva", "No puedo generar Ajuste:" & reserva_id, -errorCode)
                            End If
                        Else
                            errorCode = 1
                            AgregaInfo("regenerarLineasFacturasReserva", "Reserva con errores o sin servicios:" & reserva_id, -errorCode)
                        End If
                    End If
                End If
            Catch ex As Exception
                errorCode = 3
                AgregaInfo("regenerarLineasFacturasReserva", "Execpcion:" & reserva_id, -errorCode)
            End Try
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Private Function enviarEmailError(ByVal destinatarios As String, ByVal asunto As String, ByVal cuerpo As String, Optional ByVal html As Boolean = False, Optional sender As String = "dingus@geshotel.com")
            Dim message As Net.Mail.MailMessage = New Net.Mail.MailMessage(sender, destinatarios, asunto, cuerpo)
            message.IsBodyHtml = html
            'message.BodyEncoding = System.Text.Encoding.GetEncoding("windows-1252")
            'message.Bcc.Add(reader("email_reservas"))
            Dim client As Net.Mail.SmtpClient = New Net.Mail.SmtpClient("correo")
            'client.Timeout = client.Timeout * 8
            client.Credentials = System.Net.CredentialCache.DefaultNetworkCredentials
            Dim sent As Boolean = False
            client.Send(message)
            sent = True
            '            client.SendAsync(message, sent)
            Return sent
        End Function
        Shared sqlEnviarEmailReservas = "select reserva_id from reservas where enviar_email=1"
        Shared sqlEnviarEmailActivar = "update reservas set enviar_email=1 where reserva_id=? and enviar_email<>1"
        Shared sqlEnviarEmailDesActivar = "update reservas set enviar_email=0 where reserva_id=? and enviar_email=1"
        Public Function ProcessarEmailBatch()
            Dim errorCode As Integer = 0
            Dim retVal As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()
            Try
                Dim reader As DataTableReader = getDataTable(cmd, sqlEnviarEmailReservas)
                While reader.Read
                    enviarEmailReserva(cmd, reader("reserva_id"), False)
                End While
            Catch ex As Exception
                'errorCode = 2
            End Try

            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Private Function enviarEmailReserva(ByVal cmd As MySqlCommand, ByVal reserva As Integer, ByVal batch As Boolean) As Boolean
            Try
                cmd.Parameters.Clear()
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva)
                cmd.Parameters.Add(reserva_idParam)
                If batch Then
                    ExecuteNonQuery(cmd, sqlEnviarEmailActivar)
                Else
                    Dim reader As DataTableReader = getDataTable(cmd, sqlEnviarEmailReserva)
                    While reader.Read
                        Dim body As String
                        If isProduccion Then
                            body = readHtmlPage("http://srvgeshotel/geshotel/ImpresoReserva.aspx?reserva_id=" & CStr(reserva))
                        Else
                            body = readHtmlPage("http://srvgeshotel/geshotel2/ImpresoReserva.aspx?reserva_id=" & CStr(reserva))

                        End If
                        Dim message As Net.Mail.MailMessage = New Net.Mail.MailMessage(reader("email_ventas"), reader("email"), reader("estado") & " Reserva Nº:" & reserva, body)
                        message.IsBodyHtml = True
                        message.BodyEncoding = System.Text.Encoding.GetEncoding("windows-1252")

                        message.Bcc.Add(reader("email_reservas"))
                        Dim client As Net.Mail.SmtpClient = New Net.Mail.SmtpClient(reader("email_smtp"))
                        'client.Timeout = client.Timeout * 8
                        client.Credentials = System.Net.CredentialCache.DefaultNetworkCredentials
                        client.Send(message)

                    End While
                    ExecuteNonQuery(cmd, sqlEnviarEmailDesActivar)
                End If
            Catch ex As Exception

            End Try
            Return True
        End Function
        Public Function cambia_situacion_habitacion(ByVal reserva_id As Integer, ByVal estado_reserva_id As Integer) As Integer
            Dim Errorcode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Errorcode = cambia_situacion_habitacion(cmd, reserva_id, estado_reserva_id)
            flushConection(cmd, 0)
            Return Errorcode
        End Function
        Private Function cambia_situacion_habitacion(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal estado_reserva_id As Integer) As Integer
            Dim update_situacion As String = "UPDATE habitaciones SET situacion_id =? WHERE habitacion_id =? "
            Dim fechaParam As New MySqlParameter("@fecha", Today)
            Dim fechaParam1 As New MySqlParameter("@fecha", Today)
            Dim hotel_idParam As New MySqlParameter("@hotel_id", 0)
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            Dim situacion_idParam As New MySqlParameter("@situacion_id", 0)
            Dim habitacion_idParam As New MySqlParameter("@habitacion_id", 0)
            Dim retval As Integer = 0

            Try
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                hotel_idParam.Value = ExecuteScalar(cmd, "Select hotel_id From reservas where reserva_id =?")
                ' Con el hotel miro la fecha del hotel
                fechaParam.Value = FechaHotel(hotel_idParam.Value)
                fechaParam1.Value = fechaParam.Value
                cmd.Parameters.Add(fechaParam)
                ' Con la fecha miro la o las habitaciones del hotel de esa reserva
                Dim Reader As DataTableReader = getDataTable(cmd, "Select habitacion_id From habitaciones_bloqueos Where reserva_id = ? And ? BETWEEN fecha_desde AND fecha_hasta")
                While Reader.Read
                    habitacion_idParam.Value = Reader.Item("habitacion_id")
                    Select Case estado_reserva_id
                        Case 3  ' Si pasa a checkin la situacion es ocupada 4 y a tostar
                            situacion_idParam.Value = 4
                        Case 4 ' Pasa a Precheckout la pongo pendiente de salir =2 y a tostar
                            situacion_idParam.Value = 2
                        Case 5 ' este es el caso mas complejo dependiendo de si hay un bloqueo ese día o no

                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(habitacion_idParam)
                            cmd.Parameters.Add(fechaParam)
                            Dim tipo_bloqueo As Object = ExecuteScalar(cmd, "Select Max(tipo_bloqueo_id) FROM habitaciones_bloqueos WHERE habitacion_id =? AND desde =?")
                            If IsNothing(tipo_bloqueo) Then
                                situacion_idParam.Value = 1 ' No hay bloqueos hoy, pasa a libre
                            ElseIf tipo_bloqueo = 1 Then
                                situacion_idParam.Value = 3 ' Hay una entrada, pasa a pendiente de entrar
                            Else
                                situacion_idParam.Value = 5 ' Queda bloqueada
                            End If
                    End Select
                    If situacion_idParam.Value <> 0 Then
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(situacion_idParam)
                        cmd.Parameters.Add(habitacion_idParam)
                        retval = ExecuteNonQuery(cmd, update_situacion)
                    End If
                    retval = 0
                End While

            Catch ex As Exception
                retval = 1
            End Try
            Return retval
        End Function
        Function CambiarEstadoReserva(ByVal cmd As MySqlCommand, ByVal reserva As Integer, ByVal estado As Integer, ByVal validar As Boolean, Optional ByVal forzarprecheckout As Boolean = False, Optional datosReservaActual As tablaServicios = Nothing) As Integer

            Dim errorCode As Integer = 0
            Dim retVal As Boolean = False
            If IsNothing(datosReservaActual) Then 'Lo podemos haber pasado como parámetro y ya no hace falta calcularlo otra vez
                datosReservaActual = obtieneServiciosReservaCache(cmd, reserva)
            End If
            If Not IsNothing(datosReservaActual) Then
                Dim nerrores As Integer = datosReservaActual.sumaErrores()
                cmd.Parameters.Clear()
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva)
                Dim reserva_idParam2 As New MySqlParameter("@reserva_id", reserva)
                cmd.Parameters.Add(reserva_idParam)
                Dim estado_anterior As Integer = Nothing
                estado_anterior = ExecuteScalar(cmd, sqlEstadoReserva)
                'todo leer si es de tipo blokeo.
                Dim bloqueo As Boolean = False
                If IsDBNull(estado_anterior) Then
                    'pend. finalizar
                    estado_anterior = 0
                End If
                If IsDBNull(estado) Then
                    'pend. finalizar
                    estado = 0
                End If

                '2:      Anulada
                '3: 	 checked-in
                '4:      checked-out
                Select Case estado_anterior
                    Case 0
                        If estado = 1 Then
                            '1:      Pendiente entrar
                            'TODO para poder actualizar la reserva no puede tener errores

                            'TODO si es de tipo blokeo..comprobar que todas las lineas de reserva
                            'tienen contrato
                            Dim sersincon As Integer = 0
                            If bloqueo Then
                                'sersincon = Me.ExecuteScalar(cmd, sqlCuentaServiciosSinContrato)
                            End If
                            If nerrores = 0 And sersincon = 0 And ExecuteScalar(cmd, sqlCuentaServicios) > 0 Then
                                'TODO: comprobar que tiene al menos una linea de servicios
                                retVal = True


                            Else
                                AgregaInfo("CambiarEstadoReserva", "Reserva con errores o sin servicios:" & reserva, -1)
                            End If
                        End If
                        If estado = 2 Then
                            '2:      Anulada
                            retVal = True
                        End If
                        If retVal Then
                            ' hacemos una comprobación de overbookin para lanzar alerta posible sobreocupación
                            comprueba_overbooking(cmd, reserva)
                        End If
                    Case 1
                        '1:      Pendiente entrar
                        If estado = 0 Then
                            'pend. finalizar
                            retVal = True
                        End If

                        If estado = 2 Then
                            '2:      Anulada
                            retVal = True


                        End If
                        If estado = 3 Then
                            '3: 	 checked-in
                            If Not bloqueo Then
                                'TODO Regenerar los contratos de los servicios si no es bloqueo
                                'TODO Obtener contrato activo para esa reserva
                            End If
                            'TODO comprobar que todas las lineas de reserva tienen contrato
                            Dim sersincon As Integer = 0
                            'sersincon = Me.ExecuteScalar(cmd, sqlCuentaServiciosSinContrato)
                            If nerrores = 0 And sersincon = 0 And ExecuteScalar(cmd, sqlCuentaServicios) > 0 And ExecuteScalar(cmd, sqlCuentaHabitaciones) > 0 Then
                                'TODO: comprobar que tiene al menos una linea de servicios
                                '                            retVal = True
                                'solo permitir checkin si fecha_prevista_desde es la misma que fecha del hotel
                                Dim clientefactura As Boolean
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(reserva_idParam)
                                cmd.Parameters.Add(reserva_idParam2)

                                Dim tmpt = ExecuteScalar(cmd, sqlFacturaAnticipada)
                                If IsDBNull(tmpt) Then
                                    tmpt = False
                                End If
                                clientefactura = tmpt

                                If ComparaFechaHotel(cmd, reserva) Then
                                    'TODO: si hay facturacion al checking....meter todas las lineas de factura
                                    retVal = True
                                    If Not validar Then
                                        If clientefactura Then

                                            retVal = generaAjuste(cmd, reserva, datosReservaActual, Nothing, True)

                                            If retVal Then

                                                retVal = GeneraFacturasReserva(cmd, reserva)

                                            End If
                                        End If
                                        If Not retVal Then
                                            AgregaInfo("CambiarEstadoReserva", "No puedo facturar al checkin:" & reserva, -1)
                                        Else
                                            'da igual si falla o no
                                            ActivaTelefonosReserva(cmd, reserva, 1)
                                        End If
                                    End If
                                End If

                            Else
                                AgregaInfo("CambiarEstadoReserva", "Reserva con errores, sin servicios o sin Habitaciones:" & reserva, -1)
                            End If

                        End If
                        If estado = 6 Then ' Pasa a No Show 
                            ' Cambiamos la fecha prevista de salida a Mañana                           
                            ' Damos checkin generando factura
                            ' damos checkout pasando a No Show
                            retVal = False
                            Dim sql = "SELECT precio_dingus " _
                            & "FROM reservas " _
                            & "INNER JOIN clientes_hotel ON Coalesce(cliente_id_factura,reservas.cliente_id) = clientes_hotel.cliente_id " _
                            & "WHERE reservas.reserva_id = ?"
                            If ComparaFechaHotel(cmd, reserva) Then
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(reserva_idParam)
                                If ExecuteScalar(cmd, sqlCuentaHabitaciones_no_show) > 0 Then

                                    Dim dingus = ExecuteScalar(cmd, sql)
                                    If dingus <> 1 Then
                                        retVal = True
                                        If Not validar Then
                                            'Primero miro que la fecha de salida no sea mañana es decir un solo día porque entonces el update no funciona
                                            Dim tmp = 0
                                            Dim dsreserva As DataSet = getDataSet(cmd, sqlCabReserva)
                                            If dsreserva.Tables(0).Rows.Count > 0 Then
                                                Dim row As DataRow = dsreserva.Tables(0).Rows(0)
                                                Dim fecha_hotel As Date = FechaHotel(cmd, row("hotel_id"))
                                                If DateAdd(DateInterval.Day, 1, fecha_hotel) = row("fecha_prevista_salida") Then
                                                    tmp = 1
                                                Else
                                                    cmd.Parameters.Clear()
                                                    cmd.Parameters.Add(reserva_idParam)
                                                    tmp = ExecuteNonQuery(cmd, "UPDATE reservas SET fecha_prevista_salida = DATE_ADD(fecha_prevista_llegada, INTERVAL 1 DAY) WHERE reserva_id = ? ")
                                                End If
                                            End If
                                            retVal = False
                                            If tmp = 1 Then ' Por ahora vamos bien
                                                datosReservaActual = New tablaServicios
                                                olddatosReservaActual = New tablaServicios
                                                datosReservaActual = obtieneServiciosReservaCache(cmd, reserva)
                                                'retVal = cambiarFechasLineasFacturas(cmd, reserva)
                                                'If retVal Then
                                                retVal = generaAjuste(cmd, reserva, datosReservaActual, Nothing, True)
                                                'End If

                                                If retVal Then
                                                    retVal = GeneraFacturasReserva(cmd, reserva)
                                                End If
                                                If Not retVal Then
                                                    AgregaInfo("CambiarEstadoReserva", "No puedo facturar al NO SHOW:" & reserva, -1)
                                                End If
                                            Else
                                                AgregaInfo("CambiarEstadoReserva", "No puedo cambiar fecha salida NO SHOW:" & reserva, -1)
                                            End If
                                        End If
                                    End If

                                End If
                            End If
                        End If
                    Case 2
                        '2:      Anulada
                        If estado = 1 Then
                            '1:      Pendiente entrar
                            retVal = True
                        End If
                        If estado = 0 Then
                            'pend. finalizar
                            retVal = True
                        End If
                        'TODO que pasa si esta en checkin y aun no se ha facturado nada?

                    Case 3
                        '3: 	 checked-in
                        If nerrores = 0 And estado = 4 Then
                            '4:      checked-out
                            'TODO: comprobar ke se puede
                            'TODO: cambiar fecha de salida por la fecha del check-out
                            'TODO: generar ajuste 
                            retVal = True
                            If Not validar Then
                                'cambiar fecha salida si se permite devoluciones o fecha prevista salida es igual a fecha hotel
                                'si cliente_id_factura o cliente_id permite factura hacerla
                                retVal = cambiarFechasLineasFacturas(cmd, reserva)
                                'peticion javier
                                'cambiar fecha de lineas superiores a fecha del hotel
                                If retVal Then
                                    retVal = generaAjuste(cmd, reserva, datosReservaActual)
                                End If

                                'da igual si falla o no
                                ActivaTelefonosReserva(cmd, reserva, 0)
                            End If

                        End If
                        If nerrores = 0 And estado = 5 And Not validar Then
                            'estaba en checkin
                            'da igual si falla o no
                            ActivaTelefonosReserva(cmd, reserva, 1)

                            'ajustar y asignar todo a una factura cuyo cliente es cliente_id_factura o cliente_id 
                            retVal = cambiarFechasLineasFacturas(cmd, reserva)
                            If retVal Then
                                retVal = generaAjuste(cmd, reserva, datosReservaActual)
                                If retVal Then
                                    retVal = GeneraFacturasReserva(cmd, reserva)
                                    If retVal Then
                                        If obtieneImportePendienteFacturas(cmd, reserva, True, True) <> 0 Or forzarprecheckout = True Then
                                            estado = 4    'falta por cobrar facturas
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    Case 4
                        '4: 	 checked-out
                        If estado = 3 Then
                            '1:      checkin
                            retVal = True
                        End If
                        If nerrores = 0 And estado = 5 Then
                            '5:      checked-out
                            'comprobar ke existan lineas ke aun no esten en facturas actualizadas
                            If ExecuteScalar(cmd, sqlCuentaLineasFacturaSinFacturas) = 0 Then
                                'comprobar que todas sus facturas de contado este cobradas.
                                If obtieneImportePendienteFacturas(cmd, reserva, True) = 0 Then
                                    'comprobar que no tiene anticipos pendientes
                                    If ObtienePendienteAnticipoReserva(cmd, reserva) = 0 Then
                                        retVal = True
                                        Dim hotel_id As Integer = 0
                                        '--------------------------------------------------- 
                                        'Aqui notifico a la gobernanta la salida
                                        ' --------------------------------------------------
                                        Try

                                            Dim dt As DataTableReader = getDataTable(cmd, sqlObtieneFechaSalidaYHotelReserva)
                                            Dim notificacion As String = "Habitacion "

                                            While dt.Read
                                                hotel_id = dt("hotel_id")
                                                notificacion = "Salida Habitacion " & dt("numero_habitacion")
                                            End While
                                            enviarNotificacion(notificacion, hotel_id, 0)
                                        Catch ex As Exception
                                            enviarNotificacion("Error en Salida Habitacion. Avisa a Javier", hotel_id, 0)
                                        End Try
                                    Else
                                        'se necesita devolver los anticipos pendientes o consumirlos con una factura
                                        AgregaInfo("CambiarEstadoReserva", "Hay anticipos pendientes para esta reserva:" & reserva, -1)
                                    End If
                                Else
                                    AgregaInfo("CambiarEstadoReserva", "Hay facturas no de credito pendientes de cobro para esta reserva:" & reserva, -1)
                                End If

                            Else
                                AgregaInfo("CambiarEstadoReserva", "Existen lineas de factura sin asignar:" & reserva, -1)
                            End If
                        End If
                    Case 5
                        'poner en pre-checkout una reserva facturada con fecha de salida hoy
                        If estado = 4 Then
                            'obtiene fecha hotel
                            'obtiene fecha salida reserva
                            Dim hotel_id As Integer = 0
                            Try
                                Dim dt As DataTableReader = getDataTable(cmd, sqlObtieneFechaSalidaYHotelReserva)
                                Dim notificacion As String = "Habitacion "

                                While dt.Read
                                    hotel_id = dt("hotel_id")
                                    Dim fecha_hotel As Date = FechaHotel(cmd, hotel_id)
                                    Dim fecha_salida_reserva As Date = dt("fecha_salida")
                                    If fecha_hotel = fecha_salida_reserva Then
                                        retVal = True
                                    End If

                                End While

                            Catch
                                AgregaInfo("CambiarEstadoReserva", "Error al Enviar Notificacion", -1)
                            End Try
                        End If
                End Select
                If nerrores <> 0 Then
                    AgregaInfo("CambiarEstadoReserva", "La reserva tiene lineas con errores:" & reserva, 0)
                End If
                If Not validar And retVal Then
                    'procesar el cambio
                    cmd.Parameters.Clear()
                    Dim estadoParam As New MySqlParameter("@estado_id", estado)
                    Dim estadoParam1 As New MySqlParameter("@estado_id1", estado)
                    Dim user_idParam As New MySqlParameter("@user_id", userId)
                    Dim estado_reserva_idParam As New MySqlParameter("@estado_reserva_id", estado_anterior)
                    cmd.Parameters.Add(estadoParam1)
                    cmd.Parameters.Add(estadoParam)
                    cmd.Parameters.Add(user_idParam)
                    cmd.Parameters.Add(reserva_idParam)
                    cmd.Parameters.Add(estado_reserva_idParam)
                    If (ExecuteNonQuery(cmd, sqlCambiarEstadoReserva) = 1) Then
                        cambia_situacion_habitacion(cmd, reserva, estado)
                        If estado = 2 Then
                            ' Si esta anulada, pongo fecha anulacion
                            Try
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(reserva_idParam)
                                ExecuteNonQuery(cmd, "UPDATE reservas SET fecha_anulacion=Now() WHERE reserva_id = ?")
                            Catch ex As Exception

                            End Try
                        Else

                        End If
                    Else
                        errorCode = 2 'no se pudo cambiar el estado fisico
                        AgregaInfo("CambiarEstadoReserva", "No se pudo cambiar el estado de la reserva:" & reserva, -errorCode)
                    End If

                End If
            Else
                retVal = False
            End If

            If retVal = False Then
                errorCode = 1   'no se podria hacer el cambio
            Else
                If Not validar And (estado = 1 Or estado = 2) Then
                    enviarEmailReserva(cmd, reserva, True)
                End If
            End If
            carga_valor_en_reserva(cmd, reserva, datosReservaActual)

            Return errorCode
        End Function
        Public Function GeneraFacturasReserva(ByVal reserva As Integer) As Boolean
            Dim cmd As MySqlCommand = prepareConection()
            Dim retval = GeneraFacturasReserva(cmd, reserva)
            flushConection(cmd, 0)
            Return True
        End Function
        Private Function GeneraFacturasReserva(ByVal cmd As MySqlCommand, ByVal reserva As Integer) As Boolean
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva)
            'obtener forma de pago
            'Me.preparaFactura(cmd, 1, reserva)

            'crear 2 facturas una con los mov manuales al primer huesped
            'y la otra mov auto al cliente_id_factura o cliente_id 

            Dim facm As Factura
            Dim retVal1 As Boolean = True
            Dim retVal2 As Boolean = True
            Dim retVal As Boolean = True
            'cuenta cuantas lineas tipo A existen
            Dim tipoParam As New MySqlParameter("@tipo", 0)
            tipoParam.Value = "A"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            cmd.Parameters.Add(tipoParam)
            If Me.ExecuteScalar(cmd, sqlCuentaLineasFacturaSinFacturasYTipo) > 0 Then
                'TODO: crear tantas facturas como pag_facturas existan
                Dim fac As Factura '= abreFactura(cmd, -1, reserva)
                fac = preparaFactura(cmd, 2, reserva)
                Dim cola As New Queue
                If Not IsNothing(fac) Then
                    cola = obtienePag_Factura(fac, "A")
                End If
                If cola.Count = 0 Then
                    retVal = False
                    AgregaInfo("GeneraFacturasReserva", "Error al extraer las pag_factura de la reserva:" & reserva, -1)
                Else
                    While cola.Count > 0 And retVal = True And retVal1 = True
                        If IsNothing(fac) Then
                            fac = preparaFactura(cmd, 2, reserva)
                        End If

                        If Not IsNothing(fac) Then
                            fac.excuteTrans = False
                            If asignaLineasAFactura(fac, "tipo_linea_factura='A'", cola.Dequeue) > 0 Then
                                actualizaFactura(fac)
                                If fac.factura_id <> -1 Then
                                    retVal1 = CambiarEstadoFactura(cmd, fac.factura_id, 1, False)
                                    'todo cobrar factura si es de contado?
                                End If
                            Else
                                retVal = False
                                AgregaInfo("GeneraFacturasReserva", "Factura Sin lineas:" & reserva, -1)
                            End If
                        Else
                            retVal = False
                            AgregaInfo("GeneraFacturasReserva", "No pudo crear cabecera factura lineas automaticas para la Reserva:" & reserva, -1)
                        End If
                        fac = Nothing
                    End While
                End If
            End If
            tipoParam.Value = "A"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            cmd.Parameters.Add(tipoParam)
            If Me.ExecuteScalar(cmd, sqlCuentaLineasFacturaSinFacturasYDistintoTipo) > 0 Then
                If retVal = True Then
                    facm = preparaFactura(cmd, 1, reserva, True)
                    If Not IsNothing(facm) Then
                        facm.excuteTrans = False
                        If asignaLineasAFactura(facm, "tipo_linea_factura<>'A'") > 0 Then
                            actualizaFactura(facm)
                            If facm.factura_id <> -1 Then
                                retVal2 = CambiarEstadoFactura(cmd, facm.factura_id, 1, False)
                            End If
                        Else
                            retVal = False
                            AgregaInfo("GeneraFacturasReserva", "Factura sin lineas:" & reserva, -1)
                        End If
                    Else
                        retVal = False
                        AgregaInfo("GeneraFacturasReserva", "No pudo crear cabecera factura lineas manuales para la Reserva:" & reserva, -1)

                    End If
                End If
            End If

            If retVal And retVal1 And retVal2 Then
            Else
                retVal = False      'fallo de facturas
                AgregaInfo("GeneraFacturasReserva", "Fallo al crear facturas para la Reserva:" & reserva, -1)

            End If
            Return retVal
        End Function
        Shared sqlObtieneFechaMayorReserva = "select max(fecha) from lineas_factura where lineas_factura.reserva_id=? and lineas_factura.tipo_linea_factura =  'A'"
        Shared sqlObtieneFechaPrevistaSalida = "select Coalesce(fecha_salida,fecha_prevista_salida) as fecha_prevista_salida from reservas where reserva_id=?"
        Shared sqlObtieneTotalPorServicio = "" _
    & "     SELECT lineas_factura.tipo_linea_factura,max(lineas_factura.pag_factura) as pag_factura," _
    & " max(lineas_factura.porc_impuesto) as porc_impuesto ,max(lineas_factura.impuesto_id) as impuesto_id,max(lineas_factura.contrato_id) as contrato_id,max(lineas_factura.descripcion) as descripcion,lineas_factura.servicio_id, " _
    & " lineas_factura.unidad_calculo_id," _
    & " Sum(lineas_factura.cantidad) as cantidad, " _
    & " Sum(cantidad*precio) AS baseimponible, " _
    & " Sum(cantidad*Coalesce(precio_produccion,precio)) AS baseimponible_produccion, " _
    & " max(fecha) AS fecha " _
    & " FROM " _
    & " lineas_factura" _
    & " WHERE " _
    & " (lineas_factura.tipo_linea_factura =  'A' or lineas_factura.tipo_linea_factura =  'D') AND " _
    & " lineas_factura.reserva_id =  ?  and (lineas_factura.fecha=? or ?=1)" _
    & " GROUP BY " _
    & " lineas_factura.servicio_id," _
    & " lineas_factura.unidad_calculo_id,lineas_factura.tipo_linea_factura"
        '    & " AND lineas_factura.factura_id IS NULL " _
        Shared sqlObtieneHotelReserva = "select hotel_id from reservas where reserva_id=?"
        Shared sqlObiteneDevolucionReserva = "select permite_devolucion from reservas where reserva_id=?"
        Public Function NormalizaReserva(ByVal reserva_id As Integer) As Boolean
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            If Not NormalizaReserva(cmd, reserva_id) Then
                errorCode = 1
            End If
            carga_valor_en_reserva(cmd, reserva_id)
            flushConection(cmd, errorCode)
            Return True
        End Function
        Private Function NormalizaReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As Boolean
            'Return True
            Try
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                Dim reserva As New DataSet
                getDataSet(cmd, sqlCabReserva, reserva, "reserva")
                If reserva.Tables("reserva").Rows.Count > 0 Then
                    Dim cab As DataRow = reserva.Tables("reserva").Rows(0)
                    getDataSet(cmd, sqlReservasHabitaciones, reserva, "habitaciones_bloqueos")
                    getDataSet(cmd, sqlCabHuespedes, reserva, "reservas_huespedes")
                    Dim fecha_hotel As Date = FechaHotel(cmd, cab("hotel_id"))

                    'ajusta habitaciones
                    Dim x As Integer
                    Dim rows As DataRowCollection = reserva.Tables("habitaciones_bloqueos").Rows

                    Dim fecha_salida As Date
                    Dim fecha_llegada As Date
                    Dim fect
                    fect = cab("fecha_salida")
                    If IsDBNull(fect) Then
                        fect = cab("fecha_prevista_salida")
                    End If
                    fecha_salida = fect
                    fect = cab("fecha_llegada")
                    If IsDBNull(fect) Then
                        fect = cab("fecha_prevista_llegada")
                    End If
                    fecha_llegada = fect
                    If fecha_salida < fecha_hotel Then
                        fecha_hotel = fecha_salida
                    End If
                    Dim z As Integer = rows.Count - 1
                    If rows.Count >= 0 Then

                        For x = 0 To z
                            If cab("estado_reserva_id") = 2 Then
                                'borrar las habitaciones
                                rows(x).Delete()
                                'Console.WriteLine("B-" & rows.Count & "-" & reserva_id)
                            Else
                                Dim des As Integer
                                Dim desvio As Boolean = False
                                For des = 0 To z 'rows.Count - 1
                                    If des <> x And (rows(des)("fecha_desde") = rows(x)("fecha_hasta") Or rows(x)("fecha_desde") = rows(des)("fecha_hasta")) Then
                                        desvio = True
                                    End If
                                Next
                                Dim fecha_hasta = rows(x)("fecha_hasta")
                                If Not IsDBNull(fecha_hasta) Then
                                    If Not desvio Then
                                        If z > 0 Then
                                            'Console.WriteLine("N-" & rows.Count & "-" & cab("estado_reserva_id") & "-" & fecha_llegada & "-" & fecha_hasta & " -" & reserva_id)
                                        Else
                                            If fecha_salida <> fecha_hasta Then
                                                'fecha salida habitacion superior...cortarla
                                                rows(x)("fecha_hasta") = fecha_salida
                                                'Console.WriteLine("S-" & rows.Count & "-" & cab("estado_reserva_id") & "-" & fecha_salida & "-" & fecha_hasta & " -" & reserva_id)
                                            End If
                                        End If

                                    Else
                                        If rows.Count = 2 Then
                                            If fecha_salida < fecha_hasta And x = 1 Then
                                                rows(x)("fecha_hasta") = fecha_salida
                                                'Console.WriteLine("S-" & rows.Count & "-" & cab("estado_reserva_id") & "-" & fecha_salida & "-" & fecha_hasta & " -" & reserva_id)
                                            End If
                                        End If
                                    End If
                                End If
                                Dim fecha_desde = rows(x)("fecha_desde")
                                If Not IsDBNull(fecha_desde) Then

                                    If Not desvio Then
                                        If z > 0 Then
                                            'Console.WriteLine("N-" & rows.Count & "-" & cab("estado_reserva_id") & "-" & fecha_llegada & "-" & fecha_desde & " -" & reserva_id)
                                        Else
                                            If fecha_llegada <> fecha_desde Then
                                                rows(x)("fecha_desde") = fecha_llegada
                                                'Console.WriteLine("L-" & rows.Count & "-" & cab("estado_reserva_id") & "-" & fecha_llegada & "-" & fecha_desde & " -" & reserva_id)
                                            End If
                                        End If
                                    Else
                                        If z = 1 Then
                                            If fecha_llegada <> fecha_desde And x = 0 Then
                                                rows(x)("fecha_desde") = fecha_llegada
                                                'Console.WriteLine("D-" & rows.Count & "-" & cab("estado_reserva_id") & "-" & fecha_llegada & "-" & fecha_desde & " -" & reserva_id)
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        Next

                        'getDataSet(cmd, sqlReservasHabitaciones, reserva, "habitaciones_bloqueos")
                        'ajusta huespedes

                        rows = reserva.Tables("reservas_huespedes").Rows
                        z = rows.Count - 1
                        If rows.Count >= 0 Then
                            For x = 0 To z
                                If rows(x)("fecha_llegada") < fecha_llegada Then
                                    rows(x)("fecha_llegada") = fecha_llegada
                                End If
                                If rows(x)("fecha_llegada") > fecha_llegada Then
                                    Dim y = reserva.Tables("reservas_huespedes").Compute("count(fecha_llegada)", "fecha_llegada='" & rows(x)("fecha_llegada") & "'")
                                    If IsDBNull(y) Then
                                        y = 0
                                    End If
                                    If y = z + 1 Then
                                        For y = 0 To z
                                            rows(y)("fecha_llegada") = fecha_llegada
                                        Next
                                        'Console.WriteLine("G-" & cab("estado_reserva_id") & "-" & reserva_id)
                                    Else
                                        'Console.WriteLine("F-" & cab("estado_reserva_id") & "-" & reserva_id)

                                    End If
                                End If
                                If Not rows(x).IsNull("fecha_salida") Then
                                    If rows(x)("fecha_salida") > fecha_salida Then
                                        rows(x)("fecha_salida") = fecha_salida
                                    End If
                                End If
                                'If rows(x).IsNull("habitacion_id") Then
                                Dim rrows() As DataRow = reserva.Tables("habitaciones_bloqueos").Select("fecha_desde<='" & fecha_hotel & "' and fecha_hasta>='" & fecha_hotel & "' ")
                                If rrows.Length = 1 Then '>0
                                    If rrows(0)("habitacion_id") > 0 Then
                                        If rows(x).IsNull("habitacion_id") Then
                                            'Console.WriteLine("C-" & rrows.Length & "-" & cab("estado_reserva_id") & "-" & rrows(0)("habitacion_id") & "-" & reserva_id)
                                            rows(x)("habitacion_id") = rrows(0)("habitacion_id")
                                        Else
                                            If rows(x)("habitacion_id") <> rrows(0)("habitacion_id") Then
                                                'Console.WriteLine("C-" & rrows.Length & "-" & cab("estado_reserva_id") & "-" & rrows(0)("habitacion_id") & "-" & rows(x)("habitacion_id") & "-" & reserva_id)
                                                rows(x)("habitacion_id") = rrows(0)("habitacion_id")
                                            End If
                                        End If

                                    End If
                                End If
                                'End If
                            Next
                        End If
                        If reserva.HasChanges Then
                            Dim writer As MySqlDataAdapter
                            If Not IsNothing(reserva.Tables("habitaciones_bloqueos").GetChanges) Then
                                writer = getDataAdapter(cmd, sqlReservasHabitaciones)
                                writer.Fill(reserva.Tables("habitaciones_bloqueos"))
                                writer.Update(reserva.Tables("habitaciones_bloqueos"))
                            End If
                            If Not IsNothing(reserva.Tables("reservas_huespedes").GetChanges) Then
                                writer = getDataAdapter(cmd, sqlCabHuespedes)
                                writer.Fill(reserva.Tables("reservas_huespedes"))
                                writer.Update(reserva.Tables("reservas_huespedes"))
                            End If

                        End If
                    End If
                End If
            Catch ex As Exception
                Return False
            End Try
            Return True
        End Function

        Private Function cambiarFechasLineasFacturas(ByVal cmd As MySqlCommand, ByVal reserva As Integer) As Boolean
            Dim retval As Boolean = False
            Try
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                Dim hotel_id As Integer = ExecuteScalar(cmd, sqlObtieneHotelReserva)
                Dim fecha_hotel As Date = FechaHotel(cmd, hotel_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                Dim datos As DataSet = getDataSet(cmd, sqlCabLineasFactura)
                Dim x As Integer
                Dim dt As DataTable = datos.Tables(0)
                For x = 0 To dt.Rows.Count - 1
                    If dt.Rows(x)("fecha") > fecha_hotel Then
                        dt.Rows(x)("fecha") = fecha_hotel
                    End If
                Next
                Dim writer As MySqlDataAdapter
                writer = getDataAdapter(cmd, sqlCabLineasFactura)
                writer.Fill(datos.Tables(0))
                writer.Update(datos.Tables(0))
                retval = True
            Catch ex As Exception

            End Try
            Return retval
        End Function
        Public Function generaAjuste(ByVal reserva As Integer, ByVal datosnuevos As tablaServicios, Optional ByVal fechaini As String = Nothing, Optional ByVal alcheckin As Boolean = False, Optional ByVal soloAgregar As Boolean = False, Optional ByVal tipo_linea_fac As String = Nothing)
            Dim errorCode As Integer = 1
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado = generaAjuste(cmd, reserva, datosnuevos, fechaini, alcheckin, soloAgregar, tipo_linea_fac)
            If Not flushConection(cmd, errorCode) Then
                resultado = Nothing
            End If
            Return resultado
        End Function
        Private Function generaAjuste(ByVal cmd As MySqlCommand, ByVal reserva As Integer, ByVal datosnuevos As tablaServicios, Optional ByVal fechaini As String = Nothing, Optional ByVal alcheckin As Boolean = False, Optional ByVal soloAgregar As Boolean = False, Optional ByVal tipo_linea_fac As String = Nothing, Optional ByVal regenera As Boolean = False, Optional ByVal reserva_servicio_id As Integer = 1)
            Try
                Dim datos As DataSet = getDataSet(cmd, sqlLineasFacturasPorDiaYHotel)
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva)
                Dim nerrores As Integer = datosnuevos.sumaErrores()
                'cambiar fecha salida si se permite devoluciones o fecha prevista salida es igual a fecha hotel
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                Dim fechamayor As Object = ExecuteScalar(cmd, sqlObtieneFechaMayorReserva)
                Dim fecha_prevista_salida As Object = ExecuteScalar(cmd, sqlObtieneFechaPrevistaSalida)
                Dim hotel_id As Integer = ExecuteScalar(cmd, sqlObtieneHotelReserva)
                Dim devo As Boolean = ExecuteScalar(cmd, sqlObiteneDevolucionReserva)
                Dim fecha As Date = FechaHotel(cmd, hotel_id)
                'todo regeneerar
                'crear todo lo ke le toca desde la fecha hotel hasta fecha prevista salida
                'ajustar al ultimo dia..lo ke faltaria del pasado

                'If regenera Then
                'fechaini = fecha
                'End If
                If alcheckin Then
                    fechaini = fecha
                    'datosnuevos.borrarDeTabla("1=1")
                End If
                'obtener fecha mayor lineas
                If Not IsDBNull(fechamayor) And IsNothing(fechaini) And Not devo Then
                    'si fecha>=fecha del hotel y fecha>fecha prevista salida coger la fecha prevista salida
                    fechamayor = fechamayor.AddDays(1)
                    If (fechamayor >= fecha And fechamayor >= fecha_prevista_salida) Or regenera Then
                        If fecha_prevista_salida >= fecha Then
                            fecha = fecha_prevista_salida
                        End If
                    Else
                        fecha = fechamayor
                    End If
                End If

                'solo si es genera ajuste final
                If IsNothing(fechaini) And Not regenera Then
                    'borrar lineas superiores a la fecha del hotel si soporta devolucion y no estan incluidas en facturas
                    Dim fechaParam As New MySqlParameter("@fecha", fecha)
                    Dim fecha1Param As New MySqlParameter("@fecha1", fecha)
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(fechaParam)
                    cmd.Parameters.Add(fecha1Param)
                    cmd.Parameters.Add(reserva_idParam)
                    If Me.ExecuteNonQuery(cmd, sqlActulizaFechaSalidaLlegadaReserva) = 1 Then
                        'NormalizaReserva(cmd, reserva)
                        datosnuevos = obtieneServiciosReserva(cmd, reserva)
                        If IsNothing(datosnuevos) Then
                            nerrores = 1
                        Else
                            nerrores = datosnuevos.sumaErrores()
                        End If

                    End If
                End If
                'añadir columna virtual cantidad*precio_produccion
                datosnuevos.servicios.Columns.Add("importe_produccion", System.Type.GetType("System.Double"), "cantidad*precio_produccion")

                Dim fechaIniParam As New MySqlParameter("@fechaIni", Now)
                If IsDate(fechaini) Then
                    fechaIniParam.Value = CDate(fechaini)
                End If
                Dim todosParam As New MySqlParameter("@todos", 0)
                If IsNothing(fechaini) Then
                    todosParam.Value = 1
                End If

                'Dim resultado As New tablaServicios
                If nerrores = 0 Then
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(reserva_idParam)

                    cmd.Parameters.Add(fechaIniParam)
                    cmd.Parameters.Add(todosParam)
                    Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneTotalPorServicio)
                    If Not IsNothing(fechaini) And alcheckin = False Then
                        datosnuevos.borrarDeTabla("fecha<>'" & fechaini & "'")
                        fecha = fechaini
                        devo = False
                    End If
                    While reader.Read And Not soloAgregar
                        'TODO borrar de tabla nueva los fechas superiores al dia maximo ya facturado si hay devolucion
                        'TODO nuevo precio_produccion
                        'todo filtrar servicios contrato defecto y contratos normales para no mezclar los ajustes
                        Dim tipocontrato As Integer = 0
                        If reader.Item("tipo_linea_factura") = "A" Then
                            tipocontrato = 0
                        Else
                            tipocontrato = 1
                        End If
                        'For tipocontrato = 0 To 1
                        Dim filtro As String = "defecto=" & tipocontrato & " and servicio_id=" & reader.Item("servicio_id") & "  and ucid=" & reader.Item("unidad_calculo_id")
                        If devo Then
                            datosnuevos.borrarDeTabla(filtro & " and fecha>'" & reader.Item("fecha") & "'")
                        End If
                        Dim numreg As Integer = datosnuevos.servicios.Select(filtro).Length
                        Dim cant As Single = 0
                        Dim baseimponible As Single = 0
                        Dim baseimponible_produccion As Single = 0
                        Dim contrato_id As Integer
                        Dim descripcion As String
                        Dim impuesto_id As Integer
                        Dim porc_impuesto As Single
                        Dim servicio_id As Integer
                        Dim ucid As Integer
                        Dim pag_factura As Integer
                        Dim tipo_linea_factura As String = "A"

                        If numreg = 0 Then
                            If reader.IsDBNull(reader.GetOrdinal("contrato_id")) Then
                                contrato_id = 0
                            Else
                                contrato_id = reader.Item("contrato_id")
                            End If

                            descripcion = reader.Item("descripcion")
                            impuesto_id = reader.Item("impuesto_id")
                            porc_impuesto = reader.Item("porc_impuesto")
                            servicio_id = reader.Item("servicio_id")
                            ucid = reader.Item("unidad_calculo_id")
                            Dim dpag = reader.Item("pag_factura")
                            If IsDBNull(dpag) Then
                                pag_factura = 1
                            Else
                                pag_factura = dpag
                            End If
                            tipo_linea_factura = reader.Item("tipo_linea_factura")
                        Else
                            cant = datosnuevos.servicios.Compute("sum(cantidad)", filtro)
                            baseimponible = datosnuevos.servicios.Compute("sum(importe)", filtro) 'es la misma ke produccion
                            baseimponible_produccion = datosnuevos.servicios.Compute("sum(importe_produccion)", filtro)
                            Dim contrato_idt = datosnuevos.servicios.Compute("max(contrato_id)", filtro)
                            If IsDBNull(contrato_idt) Then
                                contrato_id = 0
                            Else
                                contrato_id = contrato_idt
                            End If

                            descripcion = datosnuevos.servicios.Compute("max(descripcion)", filtro)
                            impuesto_id = datosnuevos.servicios.Compute("max(impuesto_id)", filtro)
                            porc_impuesto = datosnuevos.servicios.Compute("max(porc_impuesto)", filtro)
                            servicio_id = datosnuevos.servicios.Compute("max(servicio_id)", filtro)
                            ucid = datosnuevos.servicios.Compute("max(ucid)", filtro)
                            Dim dpag = datosnuevos.servicios.Compute("max(pag_factura)", filtro)
                            If IsDBNull(dpag) Then
                                pag_factura = 1
                            Else
                                pag_factura = dpag
                            End If

                            Dim defecto As Integer = datosnuevos.servicios.Compute("max(defecto)", filtro)
                            If defecto = 0 Then
                                tipo_linea_factura = "A"
                            Else
                                tipo_linea_factura = "D"
                            End If

                        End If
                        'TODO:que pasa con baseimponible_produccion y ajustes?
                        'If CSng(reader.Item("cantidad")) <> cant Or CSng(reader.Item("baseimponible")) <> baseimponible Then
                        If CSng(reader.Item("cantidad")) <> cant Or CSng(reader.Item("baseimponible")) <> baseimponible Or CSng(reader.Item("baseimponible_produccion")) <> baseimponible_produccion Then
                            Console.WriteLine(reader.Item("cantidad") & "-" & cant)
                            Console.WriteLine(reader.Item("baseimponible") & "-" & baseimponible)
                            Console.WriteLine(reader.Item("baseimponible_produccion") & "-" & baseimponible_produccion)
                            cant = cant - reader.Item("cantidad")
                            'ke pasa si cant es cero
                            'casos
                            'cantidad=0 base igual...precio produccion distinto 
                            'devolver lo anterior y crear linea con lo nuevo?
                            'cantidad=0 base distinta...precio produccion distinto
                            'cantidad=0 base distinta...precio produccion igual

                            Dim Row As DataRow
                            baseimponible = (baseimponible - reader.Item("baseimponible")) '/ cant
                            baseimponible_produccion = (baseimponible_produccion - reader.Item("baseimponible_produccion")) '/ cant

                            If cant <> 0 Then
                            Else
                                cant = -1
                                Row = datos.Tables(0).Rows.Add()
                                Row.Item("hotel_id") = hotel_id
                                Row.Item("unidad_calculo_id") = ucid
                                Row.Item("fecha") = fecha 'todo cambiar por fecha del hotel
                                Row.Item("reserva_id") = reserva
                                Row.Item("contrato_id") = contrato_id
                                'Row.Item("descripcion") = "Ajuste-" & descripcion
                                Row.Item("descripcion") = descripcion
                                'baseimponible_produccion = (baseimponible_produccion - reader.Item("baseimponible_produccion")) / cant
                                Row.Item("cantidad") = cant
                                Row.Item("precio") = 0
                                Row.Item("precio_produccion") = 0
                                Row.Item("impuesto_id") = impuesto_id
                                Row.Item("porc_impuesto") = porc_impuesto
                                Row.Item("tipo_linea_factura") = tipo_linea_factura
                                Row.Item("servicio_id") = servicio_id
                                Row.Item("pag_factura") = pag_factura
                                '************************************************************
                                ' Julio 2017
                                ' Javier Nuñez
                                If reserva_servicio_id <> 1 Then
                                    Row.Item("reserva_servicio_id") = reserva_servicio_id
                                End If
                                '*************************************************************
                                cant = 1
                            End If

                            If Math.Abs(cant) > 1 Or 1 = 1 Then
                                'si la cantidad a ajustar es mayor de 1...para evitar problemas con decimales
                                Dim lcant = cant
                                If cant > 0 Then
                                    cant -= 1
                                Else
                                    cant += 1
                                End If
                                Dim rbaseimponible As Single = 0
                                Dim rbaseimponible_produccion As Single = 0
                                If cant = 0 Then
                                    cant = 0
                                    'rbaseimponible = baseimponible - Math.Truncate(baseimponible)
                                    'rbaseimponible_produccion = baseimponible_produccion - Math.Truncate(baseimponible_produccion)
                                Else
                                    rbaseimponible = baseimponible - (Math.Truncate(baseimponible / cant) * cant)
                                    rbaseimponible_produccion = baseimponible_produccion - (Math.Truncate(baseimponible_produccion / cant) * cant)
                                End If
                                If rbaseimponible <> 0 Or rbaseimponible_produccion <> 0 Then
                                    baseimponible -= rbaseimponible
                                    baseimponible_produccion -= rbaseimponible_produccion
                                    Row = datos.Tables(0).Rows.Add()
                                    Row.Item("hotel_id") = hotel_id
                                    Row.Item("unidad_calculo_id") = ucid
                                    Row.Item("fecha") = fecha 'todo cambiar por fecha del hotel
                                    Row.Item("reserva_id") = reserva
                                    Row.Item("contrato_id") = contrato_id
                                    'Row.Item("descripcion") = "Ajuste-" & descripcion
                                    Row.Item("descripcion") = descripcion
                                    'baseimponible_produccion = (baseimponible_produccion - reader.Item("baseimponible_produccion")) / cant
                                    Row.Item("cantidad") = 1
                                    Row.Item("precio") = rbaseimponible
                                    Row.Item("precio_produccion") = Math.Round(rbaseimponible_produccion, 2, MidpointRounding.AwayFromZero)
                                    Row.Item("impuesto_id") = impuesto_id
                                    Row.Item("porc_impuesto") = porc_impuesto
                                    Row.Item("tipo_linea_factura") = tipo_linea_factura
                                    Row.Item("servicio_id") = servicio_id
                                    Row.Item("pag_factura") = pag_factura
                                    '************************************************************
                                    ' Julio 2017
                                    ' Javier Nuñez
                                    If reserva_servicio_id <> 1 Then
                                        Row.Item("reserva_servicio_id") = reserva_servicio_id
                                    End If
                                    '*************************************************************

                                Else
                                    cant = lcant
                                End If
                            End If
                            If cant <> 0 Then
                                Row = datos.Tables(0).Rows.Add()
                                Row.Item("hotel_id") = hotel_id
                                Row.Item("unidad_calculo_id") = ucid
                                Row.Item("fecha") = fecha 'todo cambiar por fecha del hotel
                                Row.Item("reserva_id") = reserva
                                Row.Item("contrato_id") = contrato_id
                                'Row.Item("descripcion") = "Ajuste-" & descripcion
                                Row.Item("descripcion") = descripcion
                                'baseimponible_produccion = (baseimponible_produccion - reader.Item("baseimponible_produccion")) / cant
                                Row.Item("cantidad") = cant
                                Row.Item("precio") = baseimponible / cant
                                Row.Item("precio_produccion") = Math.Round(baseimponible_produccion / cant, 2, MidpointRounding.AwayFromZero)
                                Row.Item("impuesto_id") = impuesto_id
                                Row.Item("porc_impuesto") = porc_impuesto
                                Row.Item("tipo_linea_factura") = tipo_linea_factura
                                Row.Item("servicio_id") = servicio_id
                                Row.Item("pag_factura") = pag_factura
                                '************************************************************
                                ' Julio 2017
                                ' Javier Nuñez
                                If reserva_servicio_id <> 1 Then
                                    Row.Item("reserva_servicio_id") = reserva_servicio_id
                                End If
                                '*************************************************************

                            End If
                        End If
                        datosnuevos.borrarDeTabla(filtro)
                        'Next
                    End While
                    Dim y
                    For y = 0 To datosnuevos.servicios.Rows.Count - 1
                        'agrupar los registros faltantes y añadir al resultado
                        'si permite devolucion...solo las fechas menores a dia de hoy del hotel
                        If (devo = False Or datosnuevos.servicios.Rows(y)("fecha") <= fecha Or alcheckin) Then
                            Dim Row As DataRow = datos.Tables(0).Rows.Add()
                            Row.Item("hotel_id") = hotel_id
                            Row.Item("unidad_calculo_id") = datosnuevos.servicios.Rows(y)("ucid")
                            If alcheckin Then
                                Row.Item("fecha") = datosnuevos.servicios.Rows(y)("fecha")
                                Row.Item("descripcion") = datosnuevos.servicios.Rows(y)("descripcion")
                            Else
                                Row.Item("fecha") = fecha 'todo cambiar por fecha del hotel
                                'Row.Item("descripcion") = "Ajuste-" & datosnuevos.servicios.Rows(y)("descripcion")
                                Row.Item("descripcion") = datosnuevos.servicios.Rows(y)("descripcion")
                            End If
                            Row.Item("reserva_id") = reserva
                            Row.Item("contrato_id") = datosnuevos.servicios.Rows(y)("contrato_id")
                            Row.Item("cantidad") = datosnuevos.servicios.Rows(y)("cantidad")
                            Row.Item("precio") = datosnuevos.servicios.Rows(y)("precio")
                            Row.Item("precio_produccion") = datosnuevos.servicios.Rows(y)("precio_produccion")
                            Row.Item("impuesto_id") = datosnuevos.servicios.Rows(y)("impuesto_id")
                            Row.Item("porc_impuesto") = datosnuevos.servicios.Rows(y)("porc_impuesto")
                            Dim defecto As Integer = datosnuevos.servicios.Rows(y)("defecto")
                            If defecto = 0 Then
                                Row.Item("tipo_linea_factura") = "A"
                            Else
                                If Not IsNothing(tipo_linea_fac) Then
                                    Row.Item("tipo_linea_factura") = tipo_linea_fac
                                Else
                                    Row.Item("tipo_linea_factura") = "D"
                                End If

                            End If
                            Row.Item("servicio_id") = datosnuevos.servicios.Rows(y)("servicio_id")
                            Row.Item("pag_factura") = datosnuevos.servicios.Rows(y)("pag_factura")
                            '************************************************************
                            ' Julio 2017
                            ' Javier Nuñez
                            If reserva_servicio_id <> 1 Then
                                Row.Item("reserva_servicio_id") = reserva_servicio_id
                            End If
                            '*************************************************************
                        End If
                    Next
                    Dim writer As MySqlDataAdapter
                    writer = getDataAdapter(cmd, sqlLineasFacturasPorDiaYHotel)
                    writer.Fill(datos.Tables(0))
                    'AddHandler writer.RowUpdating, AddressOf OnRowUpdating
                    writer.Update(datos.Tables(0))
                    Return True
                Else
                    AgregaInfo("generaAjuste", "Existen errores en los servicios (al procesar el ajuste):" & reserva, -1)
                    Return False
                End If
            Catch ex As Exception
                AgregaInfo("generaAjuste", "Execption:" & reserva & "-" & ex.Message, -1)
                Return False
            End Try
        End Function
        Shared sqlMaestroOferta = "select * from ofertas where oferta_id=?"
        Shared sqlHijoLineasOfertas = "select * from ofertas_tipos_de_servicio where oferta_id=?"
        Shared sqlPuedoDuplicarOferta = "SELECT count(*) FROM reservas_ofertas WHERE reservas_ofertas.oferta_id =  ?"
        Function preparaDuplicacionOferta(ByVal oferta As Integer) As duplicarTablas
            'iniciar transaccion
            Dim errorCode As Integer = 0
            Dim retval As Boolean = False
            Dim cmd As MySqlCommand = prepareConection()
            Dim ofertaParam As New MySqlParameter("@oferta_id", oferta)
            'todo comprobar que ese dia no haya sido generado
            cmd.Parameters.Clear()
            cmd.Parameters.Add(ofertaParam)
            Dim dt As duplicarTablas = Nothing
            Try
                dt = New duplicarTablas(cmd, Me.userId)
                Dim sqlHijos(0) As String
                sqlHijos(0) = sqlHijoLineasOfertas
                Dim nsqlHijos(0) As String
                nsqlHijos(0) = "ofertas_tipos_de_servicio"
                dt.preparaDuplicacion(sqlMaestroOferta, nsqlHijos, sqlHijos, sqlHijos, sqlPuedoDuplicarOferta, "oferta_id", "oferta_id_original", "oferta_id_siguiente")
                If IsNothing(dt) Then
                    errorCode = 2 'no existe registro duplicacion
                    AgregaInfo("preparaDuplicacionOferta", "No existe registro duplicacion oferta:" & oferta, -errorCode)

                End If
            Catch ex As Exception
                errorCode = 1 'error al preparar el duplicado
                AgregaInfo("preparaDuplicacionOferta", "Error al preparar el duplicado oferta:" & oferta, -errorCode)
            End Try

            'finalizar transaccion

            If errorCode <> 0 Then
                dt = Nothing
                If Not IsNothing(cmd.Transaction) Then
                    cmd.Transaction.Rollback()
                End If
            End If

            Return dt
        End Function
        Shared sqlMaestroContrato = "select * from contratos where contrato_id=?"
        Shared sqlHijoLineasDeContrato = "select * from lineas_de_contrato where contrato_id=?"
        Shared sqlHijoFicherosDeContrato = "select * from ficheros_contrato where contrato_id=?"
        Shared sqlHijoOfertas = "select * from ofertas where contrato_id=?" 'todo falta rejilla
        Shared sqlHijosOfertas_rejillas = "select * from ofertas_rejillas where oferta_id in (select oferta_id from ofertas where contrato_id=?)"
        Shared sqlHijosOfertas_codigos = "select * from ofertas_codigos where oferta_id in (select oferta_id from ofertas where contrato_id=?)"
        Shared sqlHijosOfertas_servicios = "select * from ofertas_servicios where oferta_id in (select oferta_id from ofertas where contrato_id=?)"
        Shared sqlHijosCondiciones_linea_contrato = "select * from condiciones_linea_contrato where linea_contrato_id in (select linea_contrato_id from lineas_de_contrato where contrato_id=?)"
        Shared sqlHijosCondiciones_ofertas = "select * from condiciones_ofertas where oferta_id in (select oferta_id from ofertas where contrato_id=?)"
        Shared sqlHijosEdades = "Select * from contratos_edades where contrato_id=?"
        Shared sqlPuedoDuplicarContrato = "" _
    & "     SELECT " _
    & "    count(contrato_id) " _
    & " FROM " _
    & "    geshotel.reservas_contratos " _
    & "    INNER JOIN geshotel.reservas  " _
    & "        ON (reservas_contratos.reserva_id = reservas.reserva_id) " _
    & " WHERE reservas_contratos.contrato_id=? and " _
    & " (reservas.bloquear_tarifa =1 or reservas.estado_reserva_id >=4) "
        Shared sqlReservasACambiarAlDuplicar = "" _
    & "     SELECT " _
    & "    distinct reservas_contratos.reserva_id " _
    & " FROM " _
    & "    geshotel.reservas_contratos " _
    & "    INNER JOIN geshotel.reservas  " _
    & "        ON (reservas_contratos.reserva_id = reservas.reserva_id) " _
    & " WHERE reservas_contratos.contrato_id=? and " _
    & " (reservas.bloquear_tarifa =0 and reservas.estado_reserva_id <=3) "
        Private Function CambiarContratosReserva(ByVal cmd As MySqlCommand, ByVal contrato_original As Integer, ByVal contrato_duplicado As Integer, ByVal conversionOfertas As DataTable)
            'todo
            'por cada oferta duplicada..llevarse las sub tablas de oferta
            'ofertas_codigos,ofertas_rejillas,ofertas_servicios
            Dim retval As Boolean = False
            Try


                Dim contratoParam As New MySqlParameter("@contrato_id", contrato_original)
                Dim reservaParam As New MySqlParameter("@reserva_id", 0)
                Dim ofertaParam As New MySqlParameter("@oferta_id", 0)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(contratoParam)
                Dim reader As DataTableReader = getDataTable(cmd, sqlReservasACambiarAlDuplicar)
                While reader.Read
                    cmd.Parameters.Clear()
                    reservaParam.Value = reader("reserva_id")
                    cmd.Parameters.Add(reservaParam)
                    Dim datos As DataSet = getDataSet(cmd, sqlObtieneReservasContratos)
                    Dim x As Integer
                    For x = 0 To datos.Tables(0).Rows.Count - 1
                        If datos.Tables(0).Rows(x)("contrato_id") = contrato_original Then
                            'para cada reserva...reemplazar contrato_original por contrato_duplicado en reservas_contratos
                            datos.Tables(0).Rows(x)("contrato_id") = contrato_duplicado
                        End If
                    Next
                    Dim writer As MySqlDataAdapter
                    writer = getDataAdapter(cmd, sqlObtieneReservasContratos)
                    writer.Fill(datos.Tables(0))
                    writer.Update(datos.Tables(0))
                    'y reemplazar en reservas_ofertas las ofertas del contrato_original por las del contrato_duplicado
                    'para mantener la posible activacion/desactivacion...solo de las manuales
                    'problemas...las automaticas deberia borrarse
                    'si la oferta era manual y paso a automatica tambien deberia borrarse
                    datos = getDataSet(cmd, sqlReservasOfertas)
                    For x = 0 To datos.Tables(0).Rows.Count - 1
                        If datos.Tables(0).Rows(x)("tipo") = "A" Then
                            'si es automatico lo borro...ya lo volvera a coger si toka el regenerador
                            datos.Tables(0).Rows(x).Delete()
                        Else
                            If datos.Tables(0).Rows(x)("activa") = 0 Then
                                'si no esta activo lo borro...ya lo volvera a coger si toka el regenerador
                                datos.Tables(0).Rows(x).Delete()
                            Else
                                Dim destino_id As Integer = 0
                                Dim rows() As DataRow = conversionOfertas.Select("origen_id=" & datos.Tables(0).Rows(x)("oferta_id"))
                                If rows.Length > 0 Then
                                    destino_id = rows(0)("destino_id")
                                End If
                                'localizo el destino_id
                                If destino_id > 0 Then
                                    'si esta activo y ahora es automatico..lo borro
                                    cmd.Parameters.Clear()
                                    ofertaParam.Value = destino_id 'reader("destino_id")
                                    cmd.Parameters.Add(ofertaParam)
                                    Dim desds As DataSet = getDataSet(cmd, sqlMaestroOferta, True)
                                    If desds.Tables(0).Rows(0)("aplicable_auto") = 1 Then
                                        datos.Tables(0).Rows(x).Delete()
                                    End If
                                Else
                                    'no existe en el destino..asi ke ya no va..lo borro
                                    datos.Tables(0).Rows(x).Delete()
                                End If


                            End If
                        End If
                    Next
                    writer = getDataAdapter(cmd, sqlReservasOfertas)
                    writer.Fill(datos.Tables(0))
                    writer.Update(datos.Tables(0))
                    'ultimo paso opcional..regenerar la reserva..quitar para velocidad
                    'obtieneServiciosReserva(cmd, CInt(reader("reserva_id")))

                End While
                retval = True
            Catch ex As Exception
                'fallo goldo
                retval = False
            End Try

            Return retval
        End Function
        Private Sub eventoAlDuplicar(ByVal sender As Object)
            Dim dat As Date = Now
            Dim dt As duplicarTablas = sender
            If CambiarContratosReserva(dt.cmd, dt.objd.origen_id, dt.objd.destino_id, dt.objd.THT_DataTables(2)) = True Then
                'todo oks
            Else
                'algun error...hay ke parar todo!!
                dt.lastError = 1
            End If
            'Console.WriteLine("hits-" & cachedHits)
            'Console.WriteLine("misses-" & cachedHitsMisses)
            'Console.WriteLine("del-" & borrarHits)
            'Dim xxl As TimeSpan = (Now - dat)
            'Console.WriteLine(xxl.ToString)
            '
            'xxl = Nothing
        End Sub
        Function preparaDuplicacionContrato(ByVal contrato As Integer) As duplicarTablas
            'iniciar transaccion
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim contratoParam As New MySqlParameter("@contrato_id", contrato)
            'todo comprobar que ese dia no haya sido generado
            cmd.Parameters.Clear()
            cmd.Parameters.Add(contratoParam)
            Dim dt As duplicarTablas = Nothing
            Try
                dt = New duplicarTablas(cmd, Me.userId)
                Dim sqlHijos(8) As String
                sqlHijos(0) = sqlHijoLineasDeContrato
                sqlHijos(1) = sqlHijoFicherosDeContrato
                sqlHijos(2) = sqlHijoOfertas
                sqlHijos(3) = sqlHijosOfertas_rejillas
                sqlHijos(4) = sqlHijosOfertas_codigos
                sqlHijos(5) = sqlHijosOfertas_servicios
                sqlHijos(6) = sqlHijosCondiciones_linea_contrato
                sqlHijos(7) = sqlHijosCondiciones_ofertas
                sqlHijos(8) = sqlHijosEdades
                Dim nsqlHijos(8) As String
                nsqlHijos(0) = "lineas_de_contrato"
                nsqlHijos(1) = "ficheros_contrato"
                nsqlHijos(2) = "ofertas"
                nsqlHijos(3) = "ofertas_rejillas"
                nsqlHijos(4) = "ofertas_codigos"
                nsqlHijos(5) = "ofertas_servicios"
                nsqlHijos(6) = "condiciones_linea_contrato"
                nsqlHijos(7) = "condiciones_ofertas"
                nsqlHijos(8) = "contratos_edades"
                Dim nsqlIdHijos(8) As String
                nsqlIdHijos(0) = "linea_contrato_id"
                nsqlIdHijos(1) = "fichero_id"
                nsqlIdHijos(2) = "oferta_id"
                nsqlIdHijos(3) = "oferta_id"
                nsqlIdHijos(4) = "oferta_id"
                nsqlIdHijos(5) = "oferta_id"
                nsqlIdHijos(6) = "linea_contrato_id"
                nsqlIdHijos(7) = "oferta_id"
                nsqlIdHijos(8) = "contrato_id"
                dt.preparaDuplicacion(sqlMaestroContrato, nsqlHijos, sqlHijos, nsqlIdHijos, sqlPuedoDuplicarContrato, "contrato_id", "contrato_id_original", "contrato_id_siguiente")
                If IsNothing(dt) Then
                    errorCode = 2 'no existe registro duplicacion
                    AgregaInfo("preparaDuplicacionContrato", "No existe registro duplicacion contrato:" & contrato, -errorCode)
                Else
                    AddHandler dt.EndDuplicate, AddressOf eventoAlDuplicar
                End If
            Catch ex As Exception
                errorCode = 1 'error al preparar el duplicado
                AgregaInfo("preparaDuplicacionContrato", "Error al preparar el duplicado contrato:" & contrato, -errorCode)
            End Try

            'finalizar transaccion
            If errorCode <> 0 Then
                dt = Nothing
                If Not IsNothing(cmd.Transaction) Then
                    cmd.Transaction.Rollback()
                End If
            End If

            Return dt
        End Function
        Function cierraDuplicacion(ByVal dt As duplicarTablas)
            Return dt.finalizaDuplicacion()
        End Function
        Shared sqlExisteCierre = "select count(*) from cierres where fecha_cierre=? and hotel_id=?"
        Shared sqlExisteCierreEnTpv = "select count(*) from cierres_tpv where fecha_cierre=? and hotel_id=?"
        Shared sqlExisteCierreTpv = "select fecha_cierre_tpv from cierres where fecha_cierre=? and hotel_id=?"
        Shared sqlCreaCierre = "" _
    & " insert into cierres (fecha_cierre,hotel_id,user_id,fecha_actualizacion) " _
    & " values(?,?,?,now())"

        '    Dim sqlBorrarLineasFacturasAutomaticasPorDia = "" _
        '& " delete from lineas_factura where fecha=? and tipo_linea_factura='A' " _
        '& " and reserva_id in (SELECT reservas.reserva_id FROM reservas WHERE reservas.hotel_id =  ?)"

        'Dim sqlBorrarLineasFacturasAutomaticasPorDia = "delete from lineas_factura where fecha=? and hotel_id=? and tipo_linea_factura='A'"
        Shared sqlObtieneReservasAFacturarPorDia = "" _
    & "     SELECT " _
    & " reservas.reserva_id" _
    & " FROM" _
    & " reservas" _
    & " WHERE" _
    & "    ? BETWEEN  Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada) AND Coalesce(reservas.fecha_salida,fecha_prevista_salida) and reservas.hotel_id =  ? AND" _
    & " reservas.estado_reserva_id =  3"
        Shared sqlLineasFacturasPorDiaYHotel = "select * from lineas_factura where 1=0"
        '   Dim sqlLineasFacturasPorDiaYHotel = "select * from lineas_factura where fecha=? and tipo_linea_factura='A'"
        Private Function ExisteCierreContable(ByVal cmd As MySqlCommand, ByVal hotel As Integer, ByVal fecha As Date, Optional ByVal tpv As Boolean = False) As Boolean
            Dim fechaParam As New MySqlParameter("@fecha", fecha)
            Dim hotelParam As New MySqlParameter("@hotel", hotel)
            'todo comprobar que ese dia no haya sido generado
            cmd.Parameters.Clear()
            cmd.Parameters.Add(fechaParam)
            cmd.Parameters.Add(hotelParam)
            If tpv Then
                If IsDBNull(ExecuteScalar(cmd, sqlExisteCierreTpv)) Then
                    Return False
                Else
                    Return True
                End If
            Else
                If ExecuteScalar(cmd, sqlExisteCierre) = 0 Then
                    Return False
                End If
                Return True
            End If
        End Function
        Private Function ExisteCierreContableTpv(ByVal cmd As MySqlCommand, ByVal hotel As Integer, ByVal fecha As Date) As Boolean
            Dim fechaParam As New MySqlParameter("@fecha", fecha)
            Dim hotelParam As New MySqlParameter("@hotel", hotel)
            'todo comprobar que ese dia no haya sido generado
            cmd.Parameters.Clear()
            cmd.Parameters.Add(fechaParam)
            cmd.Parameters.Add(hotelParam)

            If ExecuteScalar(cmd, sqlExisteCierreEnTpv) = 0 Then
                Return False
            End If
            Return True
        End Function
        Function generaLineasFacturas(ByVal fecha As Date, ByVal hotel As Integer)
            'iniciar transaccion
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            'Dim fechaParam As New MysqlParameter("@fecha", fecha)
            'Dim hotelParam As New MysqlParameter("@hotel", hotel)
            'todo comprobar que ese dia no haya sido generado
            'cmd.Parameters.Clear()
            'cmd.Parameters.Add(fechaParam)
            'cmd.Parameters.Add(hotelParam)

            If Not ExisteCierreContable(cmd, hotel, fecha) Then
                'TODO generar Faltantes o Sobrantes por caja

                GenerarFaltantesOSobrantes(cmd, hotel, fecha)
                'borrar todas las lineas de facturas automaticas para ese dia quitar en futuro

                'cmd.Parameters.Clear()
                'cmd.Parameters.Add(fechaParam)
                'cmd.Parameters.Add(hotelParam)
                'ExecuteNonQuery(cmd, sqlBorrarLineasFacturasAutomaticasPorDia)
                Dim fechaParam As New MySqlParameter("@fecha", fecha)
                Dim hotelParam As New MySqlParameter("@hotel", hotel)

                'obtener lista de reservas activas para ese dia
                cmd.Parameters.Clear()
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(hotelParam)

                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneReservasAFacturarPorDia)

                'Dim resultado As New tablaServicios
                ''Dim writer As MysqlDataAdapter
                If Not IsNothing(reader) Then
                    Dim reserva_id As Integer
                    Try
                        'Dim datos As DataSet = getDataSet(cmd, sqlLineasFacturasPorDiaYHotel)
                        'Dim mea = startMeasure()

                        While errorCode = 0 And reader.Read
                            'generar tabla de lineas de facturas automaticas para ese dia
                            reserva_id = reader("reserva_id")

                            Dim x As tablaServicios = obtieneServiciosReserva(cmd, reserva_id, fecha, fecha)
                            If IsNothing(x) Then
                                errorCode = 5 'existe una reserva con errores
                                AgregaInfo("generaLineasFacturas", "Existe una reserva vacia:" & reader("reserva_id"), -errorCode)
                            Else
                                If x.erroresAntesBorrar > 0 Then
                                    errorCode = 3 'existe una reserva con errores
                                    AgregaInfo("generaLineasFacturas", "Existe una reserva con errores:" & reader("reserva_id"), -errorCode)
                                Else
                                    If Not generaAjuste(cmd, reader("reserva_id"), x, fecha) Then
                                        errorCode = 4
                                        AgregaInfo("generaLineasFacturas", "No puedo realizar Ajustes diarios:" & reader("reserva_id"), -errorCode)
                                    End If

                                End If
                            End If
                        End While
                        'stopMeasure(mea)
                        'TODO: obtener todos los tickets manuales de ese dia 
                        'y crear las lineas de factura

                        '
                        ''writer = getDataAdapter(cmd, sqlLineasFacturasPorDiaYHotel)
                        ''writer.Fill(datos.Tables(0))
                        ''writer.Update(datos.Tables(0))

                        'actualizar fecha de cierre 
                        Dim useridParam As New MySqlParameter("@userid", userId)
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(fechaParam)
                        cmd.Parameters.Add(hotelParam)
                        cmd.Parameters.Add(useridParam)
                        Dim num As Integer = ExecuteNonQuery(cmd, sqlCreaCierre)
                        If num = 1 Then
                            If CrearCierreContable(cmd, fecha, hotel) Then
                            Else
                                errorCode = 4 'no pudo crear el asiento cierre
                                AgregaInfo("generaLineasFacturas", "No puedo Crear el cierre Contable:" & fecha, -errorCode)
                            End If
                        Else
                            errorCode = 3 'no pudo crear el cierre
                            AgregaInfo("generaLineasFacturas", "No se pudo crear el cierre:" & fecha & "-" & hotel, -errorCode)

                        End If

                    Catch ex As Exception
                        errorCode = 1
                        AgregaInfo("generaLineasFacturas", "No se pudo crear el cierre:" & fecha & "-" & hotel & "-" & reserva_id, -errorCode)

                    Finally

                    End Try
                End If
            Else
                errorCode = 2 'ya existia el cierre
                AgregaInfo("generaLineasFacturas", "Ya existia cierre:" & fecha & "-" & hotel, -errorCode)
            End If
            Dim haz_postcierre As Boolean = False
            ' Por defecto el campo postcierre está a 1, esto es no debe hacerlo el proceso externo
            haz_postcierre = False
            If errorCode = 0 Then
                ' No hacemos aqui el poscierre sino que lo dejamos para el proceso automático que se hace cada 15 minutos
                ' Pero lo que hacemos es poner el flag de postcierre a 0 para ese proceso
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel)
                Dim fechaParam As New MySqlParameter("@fecha", fecha)
                ' Hacemos un Update del cierres y le ponemos un 0 en postcierre para lo haga el proceso automatico de madrugada
                Dim sql_update As String = "UPDATE cierres SET postcierre=0 WHERE hotel_id=? AND fecha_cierre = ?"
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fechaParam)
                Dim result = ExecuteNonQuery(cmd, sql_update)
                'End If
            End If

            'errorCode = 1
            'finalizar transaccion
            flushConection(cmd, errorCode)
            flushCache()
            If errorCode = 0 Then
                Try   ' Siempre generamos los precheckout del hotel
                    generarPreCheckoutsHotel(hotel)
                Catch ex As Exception
                    AgregaInfo("generaLineasFacturas", "Fallo al hacer los precheckouts:" & fecha, -1)
                End Try

                If haz_postcierre Then

                    Try
                        If isProduccion Then
                            CrearFicheroPolicia(fecha, hotel)
                        End If
                    Catch ex As Exception
                        AgregaInfo("generaLineasFacturas", "No puedo Crear el fichero policia:" & fecha, -1)
                    End Try
                    Try
                        If isProduccion Then
                            generarFicherosBavelHotel(hotel)
                        End If
                    Catch ex As Exception
                        AgregaInfo("generaLineasFacturas", "Fallo al generar ficheros pendients bavel:" & fecha, -1)
                    End Try
                    Try
                        crearLimpiezas(hotel, fecha)
                    Catch ex As Exception
                        AgregaInfo("generaLineasFacturas", "No puedo generar Limpiezas:" & fecha, -1)
                    End Try
                    Try
                        generarTablasPostCierre(hotel, fecha)
                    Catch ex As Exception
                        AgregaInfo("generaLineasFacturas", "No puedo Geenerar Tablas PostCierre:" & fecha, -1)
                    End Try

                End If
            End If

            Return errorCode
        End Function
        Shared sqlReservasEnCheckingHotelFecha = "" _
& " SELECT " _
& " reservas.reserva_id " _
& " FROM " _
& " reservas" _
& " WHERE " _
& " reservas.estado_reserva_id =  3 AND " _
& " Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida ) =  ? and reservas.hotel_id =  ? "


        Public Function generarPreCheckoutsHotel(ByVal hotel_id As Integer) As Boolean
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                Dim fecha As Date = FechaHotel(cmd, hotel_id)

                Dim fechaParam As New MySqlParameter("@fecha", Format(fecha, "yyyy-MM-dd"))
                Dim hotelParam As New MySqlParameter("@hotel", hotel_id)

                'obtener lista de reservas activas para ese dia
                cmd.Parameters.Clear()
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(hotelParam)
                Dim reader As DataTableReader = getDataTable(cmd, sqlReservasEnCheckingHotelFecha)
                While reader.Read
                    CambiarEstadoReserva(cmd, reader("reserva_id"), 5, False, True)
                End While
            Catch ex As Exception
                errorCode = 1
            End Try
            flushConection(cmd, errorCode)
            Return True
        End Function

        Shared sqlObtieneCajasHotel = "" _
    & "      SELECT " _
    & " Sum(lineas_arqueo.importe_teorico-lineas_arqueo.importe_real) AS total, " _
    & " arqueos_caja.caja_id, " _
    & " arqueos_caja.fecha,lineas_arqueo.forma_pago_id " _
    & " FROM " _
    & " arqueos_caja " _
    & " Inner Join lineas_arqueo ON lineas_arqueo.arqueo_id = arqueos_caja.arqueo_id " _
    & " Inner Join cajas ON arqueos_caja.caja_id = cajas.caja_id  " _
    & " WHERE " _
    & " arqueos_caja.tipo_arqueo_id =  2 AND " _
    & " cajas.hotel_id =  ? AND " _
    & " arqueos_caja.fecha =  ? " _
    & " GROUP BY " _
    & " arqueos_caja.caja_id, " _
    & " arqueos_caja.fecha,lineas_arqueo.forma_pago_id "
        Private Function GenerarFaltantesOSobrantes(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal fecha As Date)
            'todo rellenar logica
            cmd.Parameters.Clear()
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim fechaParam As New MySqlParameter("@fecha", fecha)
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(fechaParam)
            Dim reader As DataTableReader = Me.getDataTable(cmd, sqlObtieneCajasHotel)
            While reader.Read
                'cada caja tiene ke estar cerrada
                'la suma de los movimientos menos el declarado distinto de zero
                Dim ajuste As Single = reader.Item("total")
                If ajuste <> 0 Then
                    Dim tipomov = 6 'Faltante de caja
                    If ajuste < 0 Then
                        ajuste = -ajuste
                        tipomov = 7 'Sobrante de caja
                    End If
                    'crear el movimiento...saltarse caja cerrada
                    CrearMovimientoCaja(cmd, tipomov, fecha, reader.Item("caja_id"), ajuste, Nothing, reader.Item("forma_pago_id"), True)
                End If
            End While

            Return True
        End Function
        Function GenerarFaltantesOSobrantes(ByVal hotel_id As Integer, ByVal fecha As Date)
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado = GenerarFaltantesOSobrantes(cmd, hotel_id, fecha)
            If Not flushConection(cmd, errorCode) Then
                resultado = Nothing
            End If
            Return resultado
        End Function



        Shared sqlServiciosContratos = "SELECT DISTINCT lineas_de_contrato.servicio_id,servicios.nombre_servicio" _
    & " FROM lineas_de_contrato Inner Join servicios ON lineas_de_contrato.servicio_id = servicios.servicio_id " _
    & " WHERE lineas_de_contrato.contrato_id IN  (?) order by servicios.nombre_servicio "
        Shared sqlObtieneDatosReserva = "" _
            & "     SELECT" _
            & " reservas.hotel_id," _
            & " reservas.cliente_id, " _
            & " reservas.fecha_prevista_llegada as fecha_llegada, " _
            & " reservas.fecha_prevista_salida as fecha_salida " _
            & " FROM " _
            & " reservas " _
            & " WHERE " _
            & " reservas.reserva_id =  ? "
        Function obtieneListaServiciosValida(ByVal reserva_id As Integer) As DataTable
            Dim errorCode As Integer = 0
            Dim resultado As DataTable = Nothing
            Dim cmd As MySqlCommand = prepareConection()
            Try
                cmd.Parameters.Clear()
                'Console.WriteLine(Join(contratos.ToArray, ","))
                Dim reservaParam As New MySqlParameter("@reserva_id", reserva_id)
                cmd.Parameters.Add(reservaParam)
                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneDatosReserva)

                While reader.Read
                    resultado = obtieneListaServiciosValida(cmd, reader.Item("hotel_id"), reader.Item("cliente_id"), reader.Item("fecha_llegada"), reader.Item("fecha_salida"))
                End While
                If IsNothing(resultado) Then
                    errorCode = 1
                    AgregaInfo("obtieneListaServiciosValida", "No hay lista de servicios validad:" & reserva_id, -errorCode)
                End If
            Catch ex As Exception
                errorCode = 2
                AgregaInfo("obtieneListaServiciosValida", "No hay lista de servicios validad:" & reserva_id, -errorCode)
            End Try
            If Not flushConection(cmd, errorCode) Then
                resultado = Nothing
            End If
            Return resultado
        End Function
        Function obtieneListaServiciosValida(ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal fecha_ini As Date, ByVal fecha_fin As Date) As DataTable
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado As DataTable = obtieneListaServiciosValida(cmd, hotel_id, cliente_id, fecha_ini, fecha_fin)
            If Not flushConection(cmd, errorCode) Then
                resultado = Nothing
            End If
            Return resultado
        End Function
        Private Function obtieneListaServiciosValida(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal fecha_ini As Date, ByVal fecha_fin As Date) As DataTable
            Dim contratos As ArrayList = obtieneContratoActivosCliente(cmd, hotel_id, cliente_id, fecha_ini, fecha_fin)
            Dim resultado As DataTable = obtieneListaServiciosValida(cmd, contratos)
            Return resultado
        End Function

        Private Function obtieneListaServiciosValida(ByVal cmd As MySqlCommand, ByVal contratos As ArrayList) As DataTable
            'opcion 1
            'todo...deberia sacar la fecha ini y fecha fin de la reserva
            'todo...obtener lista de contratos del cliente
            'todo...obtener todos los servicios distintos de esa lista de contratos
            'obtieneContratoActivosCliente(cmd, reader.Item("hotel_id"), reader.Item("cliente_id"), reader.Item("fecha_prevista_llegada"), reader.Item("fecha_prevista_salida"))
            cmd.Parameters.Clear()
            'Console.WriteLine(Join(contratos.ToArray, ","))
            'Dim contratosParam As New MysqlParameter("@contrato_id", )
            'contratosParam.DbType = DbType.
            'cmd.Parameters.Add(contratosParam)

            Dim reader As DataSet = getDataSet(cmd, Replace(sqlServiciosContratos, "?", Join(contratos.ToArray, ",")))
            Return reader.Tables(0)
        End Function
        Shared sqlTotalFacturasReserva = "" _
& " SELECT " _
& " concat(convert( reservas.estado_reserva_id ,char),'-',convert(Coalesce(sum(lineas_factura.cantidad*lineas_factura.precio),'NULL'),char)) " _
& " FROM " _
& "  reservas left join lineas_factura on reservas.reserva_id=lineas_factura.reserva_id  " _
& " WHERE " _
& " reservas.reserva_id = ? "

        Function obtieneImporteTotalReservaFacturas(ByVal reserva_id As Integer, ByVal def As Decimal) As Decimal
            Dim errorCode As Integer = 0
            Dim resultado As String = 0
            Dim cmd As MySqlCommand = prepareConection()
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            'Dim defParam As New MysqlParameter("@def", def)
            'cmd.Parameters.Add(defParam)
            cmd.Parameters.Add(reserva_idParam)

            Try
                resultado = ExecuteScalar(cmd, sqlTotalFacturasReserva)
                If IsDBNull(resultado) Then
                    resultado = 0
                Else
                    If resultado.Substring(0, 2) = "2-" Or resultado.Substring(0, 2) = "1-" Or resultado.Substring(0, 2) = "0-" Then
                        resultado = def
                    Else
                        resultado = resultado.Substring(2).Replace(".", ",")
                        If resultado = "NULL" Then
                            resultado = 0
                        End If
                    End If

                End If
            Catch ex As Exception
                errorCode = 0

            End Try

            If Not flushConection(cmd, errorCode) Then
                resultado = 0
            End If
            Return resultado
        End Function
        Shared sqlCobradoReserva = "" _
& " select sum(drv.importe) from" _
& " ( " _
& " SELECT distinct  " _
& " lineas_cobro.linea_cobro, " _
& " lineas_cobro.factura_id, " _
& " lineas_cobro.importe " _
& " FROM " _
& " lineas_factura " _
& " Inner Join facturas ON lineas_factura.factura_id = facturas.factura_id " _
& " Inner Join lineas_cobro ON facturas.factura_id = lineas_cobro.factura_id Inner Join clientes ON facturas.cliente_id = clientes.cliente_id" _
& " WHERE " _
& " lineas_factura.reserva_id =  ? and clientes.permite_credito=0" _
& " ) drv "
        Function obtieneImporteTotalCobradoReserva(ByVal reserva_id As Integer) As Decimal
            Dim errorCode As Integer = 0
            Dim resultado = 0
            Dim cmd As MySqlCommand = prepareConection()
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            'Dim defParam As New MysqlParameter("@def", def)
            'cmd.Parameters.Add(defParam)
            cmd.Parameters.Add(reserva_idParam)

            Try
                resultado = ExecuteScalar(cmd, sqlCobradoReserva)
                If IsDBNull(resultado) Then
                    resultado = 0
                Else
                End If
            Catch ex As Exception
                errorCode = 0

            End Try

            If Not flushConection(cmd, errorCode) Then
                resultado = 0
            End If
            Return resultado
        End Function
        Shared sqlImporteManualReserva = "" _
& " SELECT " _
& " sum(lineas_factura.cantidad*lineas_factura.precio) " _
& " FROM " _
& " lineas_factura " _
& " WHERE " _
& " lineas_factura.reserva_id =  ? AND " _
& " lineas_factura.tipo_linea_factura IN  ('M') "
        Function obtieneImporteManualReserva(ByVal reserva_id As Integer) As Decimal
            Dim errorCode As Integer = 0
            Dim resultado = 0
            Dim cmd As MySqlCommand = prepareConection()
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            'Dim defParam As New MysqlParameter("@def", def)
            'cmd.Parameters.Add(defParam)
            cmd.Parameters.Add(reserva_idParam)

            Try
                resultado = ExecuteScalar(cmd, sqlImporteManualReserva)
                If IsDBNull(resultado) Then
                    resultado = 0
                Else
                End If
            Catch ex As Exception
                errorCode = 0

            End Try

            If Not flushConection(cmd, errorCode) Then
                resultado = 0
            End If
            Return resultado
        End Function
        Function ClientePermiteCredito(ByVal cliente_id As Integer) As Boolean
            Dim errorCode As Integer = 0
            Dim resultado = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(cliente_idParam)
            Try
                Dim clientes As DataSet = getDataSet(cmd, sqlCabCliente)
                If clientes.Tables(0).Rows(0)("permite_credito") = 0 Then
                    resultado = False
                Else
                    resultado = True
                End If
            Catch ex As Exception
                errorCode = 0
            End Try
            If Not flushConection(cmd, errorCode) Then
                resultado = False
            End If
            Return resultado
        End Function


        Function obtieneImporteTotalReserva(ByVal reserva_id As Integer, Optional ByVal concobros As Boolean = False) As Decimal
            Dim x As tablaServicios = obtieneServiciosReservaCache(reserva_id)
            'Dim x As tablaServicios = obtieneServiciosReserva(reserva_id)
            If Not IsNothing(x) Then
                If concobros Then
                    Dim total As Single = 0
                    'si el cliente de la reserva permite credito se suma las autos
                    Dim cliente_id As Integer = ObtieneClienteFacturaReserva(reserva_id)
                    If Not ClientePermiteCredito(cliente_id) Then
                        total = x.sumaImporte()
                    End If
                    'total = x.sumaImporte()
                    'resto todo lo cobrado
                    total -= obtieneImporteTotalCobradoReserva(reserva_id)
                    'sumo todo lo manual
                    total += obtieneImporteManualReserva(reserva_id)
                    Return total
                Else
                    Return x.sumaImporte()
                End If

            Else
                Return 0
            End If
        End Function
        Shared sqlObtieneReservasEntreFechas = "" _
    & "     SELECT reserva_id,Coalesce(fecha_llegada,fecha_prevista_llegada) as fecha_prevista_llegada,Coalesce(fecha_salida,fecha_prevista_salida) as fecha_prevista_salida " _
    & " FROM reservas " _
    & " WHERE ? between Coalesce(fecha_llegada,fecha_prevista_llegada) and Coalesce(fecha_salida,fecha_prevista_salida) " _
    & " AND reservas.hotel_id = ? and estado_reserva_id not in (0,2) "
        Shared sqlGenTablaSalidaErrores = "SELECT 1 as reserva_id, now() as fecha_prevista_llegada, now() as fecha_prevista_salida, " _
    & "1 AS estado_factura_id, date_format(now(),'%d/%m/%Y' ) AS Fecha_Factura " _
    & " ,'' AS descripcion, 1 AS errores, 1 AS num "

        Function ObtieneErroresReservasOld(ByVal fecha As Date, ByVal hotel_id As Integer) As DataTable
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado As DataSet = Nothing
            Try
                resultado = getDataSet(cmd, sqlGenTablaSalidaErrores)
                resultado.Tables(0).Rows.Clear()
                cmd.Parameters.Clear()
                Dim fechaParam As New MySqlParameter("@fecha", fecha)
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(hotel_idParam)
                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneReservasEntreFechas)
                Dim max As Integer = 1
                Dim act As Integer = 0
                'ThreadPool.QueueUserWorkItem(
                While reader.Read 'And act < max
                    act += 1
                    Dim reserva_id As Integer = reader.Item("reserva_id")
                    Dim fllegada As Date = reader.Item("fecha_prevista_llegada")
                    Dim fsalida As Date = reader.Item("fecha_prevista_salida")


                    Dim resulreserva As tablaServicios = obtieneServiciosReserva(cmd, reserva_id, fllegada, reader.Item("fecha_prevista_salida"))

                    Dim errores As Integer = 0
                    If IsNothing(resulreserva) Then
                        errores = 1
                    Else
                        errores = resulreserva.sumaErrores()
                    End If
                    If errores > 0 Then
                        'todo insertar registro en tabla de salida
                        Dim dr As DataRow = resultado.Tables(0).Rows.Add()
                        dr.Item("reserva_id") = reader.Item("reserva_id")
                        dr.Item("fecha_prevista_llegada") = reader.Item("fecha_prevista_llegada")
                        dr.Item("fecha_prevista_salida") = reader.Item("fecha_prevista_salida")
                        dr.Item("estado_factura_id") = 1
                        dr.Item("Fecha_Factura") = fecha
                        dr.Item("descripcion") = "con errores"
                        dr.Item("errores") = errores
                        dr.Item("num") = errores
                    End If
                End While
            Catch ex As Exception
                errorCode = 1
                AgregaInfo("ObtieneErroresReservas", "Fallo al obtener los posibles errores de la reservas:" & ex.Message, -errorCode)
            End Try
            If Not flushConection(cmd, errorCode) Then
                resultado = Nothing
            End If

            If IsNothing(resultado) Then
                Return Nothing
            Else
                Return New DataView(resultado.Tables(0)).ToTable
            End If

        End Function
        Private Class errorContador
            Public contador As Integer
        End Class
        Private Class errorReservaClass
            Public reserva_id As Integer
            Public fecha_ini As Date
            Public fecha_fin As Date
            'Public resultado As DataSet
            'Public contador As errorContador
        End Class
        Private Class bloqueReservas
            Public datos As New System.Collections.Queue
            Public resultado As DataSet
            Public contador As errorContador
            Public fecha As Date
        End Class
        Function ObtieneErroresReservas(ByVal fecha As Date, ByVal hotel_id As Integer) As DataTable
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection(IsolationLevel.RepeatableRead)
            Dim resultado As DataSet = getDataSet(cmd, sqlGenTablaSalidaErrores)
            resultado.Tables(0).Rows.Clear()
            cmd.Parameters.Clear()

            Dim fechaParam As New MySqlParameter("@fecha", convertFecha(fecha))
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Add(fechaParam)
            cmd.Parameters.Add(hotel_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneReservasEntreFechas)
            If Not flushConection(cmd, errorCode) Then
                resultado = Nothing
            End If
            Dim max As Integer = 3
            Dim act As New errorContador
            act.contador = 0
            'ThreadPool.QueueUserWorkItem(
            Dim maxt, compt As Integer

            'ThreadPool.SetMaxThreads(max, max)
            'ThreadPool.SetMinThreads(max, max)

            'ThreadPool.GetMaxThreads(maxt, compt)
            ThreadPool.GetAvailableThreads(maxt, compt)
            'Console.WriteLine("MaxTreads:" & maxt & " - " & compt)
            Dim bloque As New bloqueReservas
            bloque.resultado = resultado
            bloque.contador = act
            bloque.fecha = fecha
            While reader.Read 'And act < max
                SyncLock act
                    act.contador += 1
                End SyncLock
                Dim estado As New errorReservaClass
                estado.reserva_id = reader.Item("reserva_id")
                estado.fecha_ini = reader.Item("fecha_prevista_llegada")
                estado.fecha_fin = reader.Item("fecha_prevista_salida")

                bloque.datos.Enqueue(estado)

                'estado.resultado = resultado
                'estado.contador = act
                'ThreadPool.QueueUserWorkItem(AddressOf HiloErroresReservas, estado)
            End While
            Dim x As Integer
            For x = 0 To max
                ThreadPool.QueueUserWorkItem(AddressOf HiloErroresReservas, bloque)
            Next


            While act.contador > 1 And bloque.datos.Count > 0
                HiloErroresReservas(bloque)
                '                Thread.Sleep(100)
            End While
            While act.contador > 0
                'HiloErroresReservas(bloque)
                Thread.Sleep(10)
            End While


            If IsNothing(resultado) Then
                Return Nothing
            Else
                Return New DataView(resultado.Tables(0)).ToTable
            End If

        End Function
        Shared sqlWarningCierreHuespedes = "" _
& " SELECT count(*) " _
& " FROM " _
& " reservas_huespedes left join habitaciones_bloqueos on reservas_huespedes.reserva_id=habitaciones_bloqueos.reserva_id " _
& " WHERE " _
& " Coalesce(reservas_huespedes.habitacion_id,habitaciones_bloqueos.habitacion_id) IS NULL AND " _
& " reservas_huespedes.reserva_id =  ? "
        Shared sqlServiciosTipoHabitacion = "" _
& "SELECT servicios.servicio_id FROM servicios WHERE servicios.concepto_acelerador_reservas_id =  1"
        Private Sub HiloErroresReservas(ByVal blosta As Object)

            Dim bloque As bloqueReservas = blosta
            Dim estado As errorReservaClass
            SyncLock bloque.datos.SyncRoot
                Try
                    estado = bloque.datos.Dequeue

                Catch ex As Exception
                    estado = Nothing
                End Try
            End SyncLock
            If Not estado Is Nothing Then

                Dim z As New GesHotelClase(Me.userId)
                Dim cmd As MySqlCommand = prepareConection(IsolationLevel.RepeatableRead)
                'cmd.Parameters.Clear()
                Dim reserva_idParam As New MySqlParameter("@reserva_id", 0)
                'cmd.Parameters.Add(reserva_idParam)

                Dim serviciosmap As New Hashtable
                Dim reader As DataTableReader = getDataTable(cmd, sqlServiciosTipoHabitacion, True)
                While reader.Read

                    serviciosmap.Add(reader.Item("servicio_id"), 1)
                End While
                'Dim servicios_tipo_habs As DataSet = getDataSet(cmd, sqlServiciosTipoHabitacion, True)

                While Not IsNothing(estado)
                    Try
                        Dim resulreserva As tablaServicios = z.obtieneServiciosReserva(cmd, estado.reserva_id, estado.fecha_ini, estado.fecha_fin, True)
                        Dim errores As Integer = 0
                        Dim tipoError As Integer = 0
                        Dim descrip As String = ""

                        If IsNothing(resulreserva) Then
                            errores = 1
                            tipoError = 1
                            descrip = "Reserva invalida"
                        Else
                            If resulreserva.sumaErrores() > 0 Then
                                errores = 1 'resulreserva.sumaErrores()
                                tipoError = 1
                                descrip = "Reserva con errores por dia"
                            End If
                        End If
                        'todo comprobar que si tiene facturas
                        'la suma de todas de distinto de cero

                        If errores = 0 Then
                            Dim facs As String = z.ObtieneFacturasPendientesReserva(cmd, estado.reserva_id, True)
                            If Not IsNothing(facs) Then
                                If facs <> "" Then
                                    Dim totalfacs As Single = z.obtieneImportePendienteFactura(cmd, facs.Split(","))
                                    If Not IsNothing(totalfacs) Then
                                        If totalfacs = 0 Then
                                            errores = 1
                                            tipoError = 1
                                            descrip = "Reservas con saldo cero"
                                        End If
                                    End If
                                End If
                            End If

                        End If
                        'errores = 1

                        'Console.WriteLine(estado.reserva_id)
                        'If estado.reserva_id = 7017 Then
                        'Dim xx As Integer
                        'xx = 0
                        'End If
                        If errores = 0 Then
                            'warning
                            'le falta habitacion o hay huespedes sin habitacion asignada
                            'numero de habitaciones a facturar no coincide con las asignadas-falta
                            'If estado.reserva_id = 22634 Then
                            'Dim k = 54
                            'k += 1
                            'End If
                            Dim fecha_buscar As Date = bloque.fecha
                            If estado.fecha_fin = bloque.fecha Then
                                fecha_buscar = estado.fecha_fin.AddDays(-1)
                            End If

                            Dim habsusadas As ArrayList = z.ObtieneReservasHabitacion(cmd, 0, fecha_buscar, fecha_buscar, estado.reserva_id)
                            If habsusadas.Count = 0 And estado.fecha_ini <> estado.fecha_fin Then
                                descrip = "Reserva Sin Hab."
                                tipoError = 1
                                errores = 0
                            Else
                                'todo comprobar que para ese dia haya el mismo numero de habs que servicios de habs
                                If Not IsNothing(resulreserva) Then
                                    Dim drs() As DataRow = resulreserva.servicios.Select("fecha='" & convertFecha(fecha_buscar) & "'")
                                    Dim ienu As IEnumerator
                                    ienu = drs.GetEnumerator
                                    Dim dr As DataRow
                                    Dim esservicio As Boolean
                                    Dim nhabs As Integer = 0
                                    While ienu.MoveNext
                                        dr = ienu.Current
                                        'esservicio = servicios_tipo_habs.Tables(0).Select("servicio_id=" & dr("servicio_id")).Length > 0
                                        esservicio = Not IsNothing(serviciosmap(dr("servicio_id")))
                                        If (esservicio) Then
                                            nhabs += dr("cantidad")
                                        End If

                                    End While
                                    If nhabs <> habsusadas.Count Then
                                        descrip = "Reserva con numero hab distintas de asignadas(" & habsusadas.Count & "-" & nhabs & ")"
                                        tipoError = 1
                                        errores = 0

                                    End If

                                    '

                                End If
                                If tipoError = 0 Then
                                    reserva_idParam.Value = estado.reserva_id
                                    cmd.Parameters.Clear()
                                    'Dim reserva_idParam As New MysqlParameter("@reserva_id", 0)
                                    cmd.Parameters.Add(reserva_idParam)
                                    Dim nreg As Integer = ExecuteScalar(cmd, sqlWarningCierreHuespedes)
                                    If nreg > 0 Then
                                        descrip = "Huespedes Sin Hab."
                                        tipoError = 1
                                    End If
                                End If
                            End If
                        End If
                        If errores > 0 Or tipoError > 0 Then
                            'todo insertar registro en tabla de salida
                            Console.WriteLine(estado.reserva_id & "-" & descrip)
                            Dim dr As DataRow
                            SyncLock bloque.resultado
                                dr = bloque.resultado.Tables(0).Rows.Add()
                            End SyncLock
                            dr.Item("reserva_id") = estado.reserva_id
                            dr.Item("fecha_prevista_llegada") = estado.fecha_ini
                            dr.Item("fecha_prevista_salida") = estado.fecha_fin
                            dr.Item("estado_factura_id") = 1
                            dr.Item("Fecha_Factura") = bloque.fecha
                            dr.Item("descripcion") = descrip
                            dr.Item("errores") = errores
                            dr.Item("num") = tipoError

                        End If
                    Catch ex As Exception
                        Console.WriteLine(ex.Message)
                    End Try
                    SyncLock bloque.contador
                        bloque.contador.contador -= 1
                    End SyncLock
                    SyncLock bloque.datos.SyncRoot
                        Try
                            estado = bloque.datos.Dequeue
                        Catch ex As Exception
                            estado = Nothing
                        End Try
                    End SyncLock
                End While
                'Console.WriteLine(estado.contador.contador & "-fin-" & estado.reserva_id)
                'z.conn.Close()
                flushConection(cmd, 1)
            End If

        End Sub
        Shared sqlReservasDescuentosServicios = "" _
        & " SELECT reservas_descuentos.reserva_id, reservas_descuentos.servicio_id, reservas_descuentos.tipo_descuento_id, " _
        & " reservas_descuentos.descuento, " _
        & " servicios_hotel.impuesto_id, impuestos.porcentaje, " _
        & " servicios.nombre_servicio,servicios.tipo_servicio_id" _
        & " FROM reservas_descuentos " _
        & " Inner Join servicios_hotel ON reservas_descuentos.servicio_id = servicios_hotel.servicio_id " _
        & " Inner Join reservas ON reservas_descuentos.reserva_id = reservas.reserva_id AND reservas.hotel_id = servicios_hotel.hotel_id " _
        & " Inner Join impuestos ON servicios_hotel.impuesto_id = impuestos.impuesto_id " _
        & " Inner Join servicios ON servicios_hotel.servicio_id = servicios.servicio_id " _
        & " where reservas_descuentos.reserva_id=?"
        Shared sqlReservasDescuentos = "SELECT * FROM reservas_descuentos where reserva_id=? ORDER BY tipo DESC,servicio_id,tipo_descuento_id"
        Shared sqlReservasServicios = "SELECT * from reservas_servicios where reserva_id=?"
        Shared sqlReservasHabitaciones = "SELECT * from habitaciones_bloqueos where reserva_id=?"
        Shared sqlEquivalencias = "SELECT * from equivalencia_reservas_servicios"
        Shared sqlServicios = "SELECT * from servicios"
        Shared sqlHabitacion_id = "SELECT habitacion_id from habitaciones where hotel_id=? and numero_habitacion=? limit 0,1"
        Private Function ObtieneHabitacion_Id(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal habitacion As Object) As Integer
            Dim habitacion_id As Integer = 0
            Try
                cmd.Parameters.Clear()
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                cmd.Parameters.Add(hotel_idParam)
                Dim habitacionParam As New MySqlParameter("@habitacion", habitacion)
                cmd.Parameters.Add(habitacionParam)
                habitacion_id = ExecuteScalar(cmd, sqlHabitacion_id, True)

            Catch ex As Exception
                AgregaInfo("ObtieneHabitacion_Id", ex.Message, -1)
            End Try

            Return habitacion_id
        End Function
        Private Function convertirCamposDingus(ByVal valor As Object, ByVal campo As String, Optional ByVal totest As Boolean = False, Optional ByVal extra As Object = Nothing, Optional ByVal rcode As String = Nothing) As Object

            If campo = "CustomerCode" Then
                If valor = "EMPRESA" Then
                    valor = 8382
                End If
                valor = CInt(valor)
            End If
            If campo = "RoomCode" Then
                valor = CInt(valor)
            End If
            If campo = "BoardCode" Then
                If valor = "AL" Then 'solo alojamiento
                    valor = 0
                End If
                valor = CInt(valor)
            End If
            If campo = "PaxType" Then
                Dim uc = valor
                Select Case uc
                    Case Dingus.PaxType.ADT
                        valor = 2
                    Case Dingus.PaxType.ENF
                        valor = 5
                    Case Dingus.PaxType.CHD
                        valor = 3
                    Case Else
                        valor = 1
                End Select
            End If
            If campo = "Code" Then
                If Not IsNothing(extra) Then
                    If extra = Dingus.PriceType.CancellationFee Then
                        valor = dingus_cancelacion_reserva_servicio_id   'a fuego
                    End If
                End If
                If valor = dingus_cancelacion_reserva_servicio_id Then
                Else
                    If rcode = "AL" Then
                        rcode = -1
                    End If
                    If rcode <> valor Then
                        'parche hasta ke dingus haga lo ke tiene ke hacer
                        valor = CInt(rcode)
                    Else
                        valor = CInt(valor)
                    End If

                End If
            End If
            Return valor
        End Function
        Dim sqlHotelDingusCode = "SELECT hoteles.hotel_id  FROM hoteles where hoteles.dingus_hotel_code=?"
        Private Function maxString(ByVal str As String, ByVal size As Integer, ByVal toremove As String)
            If str.Length = 0 Then
                Return str
            End If
            If toremove <> "" And str.Contains(toremove) Then
                If InStr(str, toremove) = 1 Then
                    str = str.Remove(0, toremove.Length + 1)
                End If
            End If
            If str.Length > size Then
                str = str.Substring(0, size)
            End If
            Return str
        End Function
        Function decodeStringDingus(ByVal cryptoText As String, ByVal mKey As String, ByVal mSalt As String)
            Dim mCryptoService = New RijndaelManaged()
            mCryptoService.Mode = CipherMode.CBC

            'Convert from base 64 string to bytes
            Dim cryptoByte() As Byte = Convert.FromBase64String(cryptoText)
            ' Dim keyByte() As Byte

            Dim saltb() As Byte = Encoding.ASCII.GetBytes(mSalt)
            If (saltb.Length < 10) Then
                saltb = Encoding.ASCII.GetBytes(mSalt.PadLeft(10))
            End If
            Dim rfc2898 As Rfc2898DeriveBytes = New System.Security.Cryptography.Rfc2898DeriveBytes(mKey, saltb, 1)
            mCryptoService.Key = rfc2898.GetBytes(128 / 8)
            mCryptoService.IV = New Byte() {&HF, &H6F, &H13, &H2E, &H35, &HC2, &HCD, &HF9, &H5, &H46, &H9C, &HEA, &HA8, &H4B, &H73, &HCC}
            'mCryptoService.IV = New Byte() {&HF, &H6F, &H13, &H2E, &H35, &HC2, &HCD, &HF9}
            Dim cryptoTransform As ICryptoTransform = mCryptoService.CreateDecryptor()
            Try

                Dim ms As IO.MemoryStream = New IO.MemoryStream(cryptoByte, 0, cryptoByte.Length)

                Dim cs As CryptoStream = New CryptoStream(ms, cryptoTransform, CryptoStreamMode.Read)

                Dim sr As IO.StreamReader = New IO.StreamReader(cs)
                Return sr.ReadToEnd()

            Catch exc As Exception
                Return exc.Message
            End Try

        End Function
        Private Function ConvierteDingusAMetareserva(ByVal cmd As MySqlCommand, ByVal res As MetaReserva)
            ' Coge el XML de dingus y convierte a Metareserva
            'datos
            'obtener cliente directo del hotel
            'obtener empresa del hotel
            Dim unidades_calculos As DataSet = getDataSet(cmd, sqlUnidadesCalculos)
            Dim cliente_id As Integer = 1
            Dim empresa_id As Integer = 1
            Dim hotel_id As Object

            hotel_id = res.reserva_Dingus.HotelCode

            If Not IsNothing(hotel_id) Then
                '----------------------------------------------------------------------------------
                'Saco empresa_id del hotel_id
                ' GARRA JAVIER JULIO 2012                                             '
                Dim sql_empresa As String = "Select empresa_id From hoteles where hotel_id =?"
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                Try
                    empresa_id = ExecuteScalar(cmd, sql_empresa)
                Catch ex As Exception

                End Try
                ' Fin garra Javier
                ' -------------------------------------------------------------------------------
                res.hotel_id = hotel_id
                'convertirCamposDingus(res.reserva_Dingus.HotelCode, "HotelCode")  'sacar el hotel si se puede de dingus
                res.fecha_reserva = res.reserva_Dingus.DateSale
                res.fecha_prevista_llegada = res.reserva_Dingus.DateFrom
                res.fecha_prevista_salida = res.reserva_Dingus.DateTo
                res.bloquear_tarifa = True
                res.bono_referencia = res.reserva_Dingus.Localizer & "//" & res.reserva_Dingus.RoomReference
                res.valor = res.reserva_Dingus.TotalPrice
                Dim telefono As String = ""
                Dim dni As String = ""
                Dim c As Integer
                For c = 0 To res.reserva_Dingus.BookingData.Length - 1
                    Try
                        Console.WriteLine(res.reserva_Dingus.BookingData(c).Code)
                        If 1 = 1 And res.reserva_Dingus.BookingData(c).IsEnc Then
                            res.reserva_Dingus.BookingData(c).Value = decodeStringDingus(res.reserva_Dingus.BookingData(c).Value, "1GFG7878DEFSCAFCEC", "18") 'falta codigos
                            res.reserva_Dingus.BookingData(c).IsEnc = False
                        End If

                        If Not res.reserva_Dingus.BookingData(c).IsEnc Then

                            'If res.reserva_Dingus.BookingData(c).Code = "From_Time" Or res.reserva_Dingus.BookingData(c).Code = "HORA_IN" Or res.reserva_Dingus.BookingData(c).Code = "ARRIVALDATEARRTIME" Then
                            '    If Len(res.reserva_Dingus.BookingData(c).Value) = 4 Then ' Si la hora viene hhmm sin el punto, se lo ponemos
                            '        res.hora_prevista_llegada = Left(res.reserva_Dingus.BookingData(c).Value, 2) + ":" + Right(res.reserva_Dingus.BookingData(c).Value, 2)
                            '    Else
                            '        res.hora_prevista_llegada = res.reserva_Dingus.BookingData(c).Value
                            '    End If
                            'End If
                            'If res.reserva_Dingus.BookingData(c).Code = "To_Time" Or res.reserva_Dingus.BookingData(c).Code = "HORA_OUT" Or res.reserva_Dingus.BookingData(c).Code = "DEPARTUREDATEDEPTIME" Then
                            '    If Len(res.reserva_Dingus.BookingData(c).Value) = 4 Then ' Si la hora viene hhmm sin el punto, se lo ponemos
                            '        res.hora_prevista_salida = Left(res.reserva_Dingus.BookingData(c).Value, 2) + ":" + Right(res.reserva_Dingus.BookingData(c).Value, 2)
                            '    Else
                            '        res.hora_prevista_salida = res.reserva_Dingus.BookingData(c).Value
                            '    End If
                            'End If
                            If res.reserva_Dingus.BookingData(c).Code = "CLI_FIS" Then
                                res.cliente_id_factura = res.reserva_Dingus.BookingData(c).Value
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "contract_id" Or res.reserva_Dingus.BookingData(c).Code = "contrato_id" Then
                                res.contract_id = res.reserva_Dingus.BookingData(c).Value
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "offer_id" Or res.reserva_Dingus.BookingData(c).Code = "oferta_id" Then
                                res.codigo_oferta = res.reserva_Dingus.BookingData(c).Value
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "CLI_TLF" Then
                                telefono = maxString(res.reserva_Dingus.BookingData(c).Value.Replace("+", "").Replace("-", ""), 20, "")
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "CLI_MAIL" Then
                                res.email = res.reserva_Dingus.BookingData(c).Value
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "CLI_DNI" Then
                                dni = res.reserva_Dingus.BookingData(c).Value
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "HABCOMMENTS" Then
                                res.observaciones = maxString(res.reserva_Dingus.BookingData(c).Value.Trim, 300, "")
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "COMMENTS" Then
                                res.observaciones &= maxString(res.reserva_Dingus.BookingData(c).Value.Trim, 300, "Comentarios Cliente:")
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "CC_TYPE" Then
                                Dim tipo_tarjeta As String = res.reserva_Dingus.BookingData(c).Value
                                If tipo_tarjeta = "VISA" Or tipo_tarjeta = "MasterCard" Then
                                    res.tipo_tarjeta_id = 1
                                Else
                                    res.tipo_tarjeta_id = 2
                                End If
                            End If

                            If res.reserva_Dingus.BookingData(c).Code = "CC_CVC" Then
                                res.cod_seguridad = maxString(res.reserva_Dingus.BookingData(c).Value, 4, "")
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "CC_NUM" Then
                                res.tarjeta_credito = maxString(res.reserva_Dingus.BookingData(c).Value, 16, "")
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "CC_TYP" Then
                                'res.tarjeta_credito = maxString(res.reserva_Dingus.BookingData(c).Value, 16, "")
                            End If
                            If res.reserva_Dingus.BookingData(c).Code = "CC_EXP" Then
                                Dim totest As String = res.reserva_Dingus.BookingData(c).Value  'convertir mm/yyyy a mmyy
                                If totest.Length = 7 And totest.IndexOf("/") > 0 Then
                                    Dim totestmat() As String = totest.Split("/")
                                    If totestmat.Length = 2 Then
                                        If totestmat(1).Length = 4 Then
                                            totestmat(1) = totestmat(1).Substring(2)
                                        End If
                                        totestmat(0) = totestmat(0).Substring(totestmat(0).Length - 2, 2)
                                        totest = totestmat(0) & totestmat(1)
                                    End If
                                End If
                                totest = totest.Replace("/", "")
                                If totest.Length > 4 Then
                                    totest = totest.Substring(totest.Length - 4, 4)
                                End If
                                res.caducidad = totest

                            End If
                        End If
                    Catch ex As Exception
                        Console.WriteLine("error")
                    End Try
                    'res.tarjeta_credito = res.reserva_Dingus.BookingData.
                Next


                res.canal_reserva_id = 1 'usar traslacion?
                res.num_camas_extras = getDingusCamasExtras(res.reserva_Dingus)

                res.cliente_id = convertirCamposDingus(res.reserva_Dingus.CustomerCode, "CustomerCode") 'cliente_id 'clientes directos?
                ' AQUI miramos si el cliente_id es una agencia entonces el campo contract_id nos tendrá que dar el verdadero cliente_id de ttoo
                If res.contract_id <> "" Then
                    res.cliente_id = busca_ttoo(cmd, res)
                End If
                Dim retval() As Object = getDingusHuespedes(cmd, res.reserva_Dingus, unidades_calculos.Tables(0), dni, telefono, res.email, res.cliente_id)

                Dim hues As ArrayList = retval(0)
                Dim unid As Hashtable = retval(1)


                res.huespedes = hues.ToArray(GetType(MetaHuesped))
                Dim toarray(unid.Count - 1) As UCS
                unid.Values.CopyTo(toarray, 0)
                res.unidades_calculos = toarray

                Dim habs As New Hashtable()

                If Not res.reserva_Dingus.Status = Dingus.StatusBookingRS.Cancel Then

                    Dim x
                    Dim dias() As Dingus.Stay = res.reserva_Dingus.Stays
                    For x = 0 To dias.Length - 1
                        If Not habs.ContainsKey(dias(x).RoomCode) Then
                            habs.Add(dias(x).RoomCode, 0)
                        End If
                    Next
                End If
                'ignorar las habs?

                'sacar precios y servicios

                res.habitacion_servicio_id = convertirCamposDingus(res.reserva_Dingus.RoomCode, "RoomCode") 'tipo de habitacion...sacarlo de las lineas me imagino
                res.numero_habitaciones = habs.Count  ' sacar despues de analizar

                res.pension_servicio_id = convertirCamposDingus(res.reserva_Dingus.BoardCode, "BoardCode") 'tipo de pension...sacar despues de analizar o BoardCode
                res.permite_devolucion = False ' a consultar

                'si es una cancelacion

                If res.reserva_Dingus.Status = Dingus.StatusBookingRS.Cancel And res.reserva_Dingus_tipo = 1 Then
                    'quitar todos los servicios
                    res.pension_servicio_id = Nothing
                    res.habitacion_servicio_id = dingus_cancelacion_reserva_servicio_id 'fuego
                    res.numero_habitaciones = 1
                    'añadir servicio compensacion
                End If
            End If
            Return True
        End Function

        Private Sub AddLineaDingus(ByVal ucs As DataTable, ByVal servicios As DataSet, ByVal resultado As DataTable, ByVal servicio_id As Integer, ByVal unidad_calculo_id As Integer, ByVal cantidad As Decimal, ByVal precio As Decimal, ByVal dia As Date, ByVal paxno As Integer)

            Dim fila As DataRow = Nothing

            fila = resultado.NewRow()
            fila("ambito_id") = paxno
            fila("precio") = precio
            fila("importe") = 0
            fila("cantidad") = 0
            fila("error") = 0
            fila("fecha") = dia
            fila("servicio_id") = servicio_id 'traducir?
            fila("defecto") = 0
            Dim sername = "Desconocido"
            Dim ser() As DataRow = servicios.Tables(0).Select("servicio_id=" & servicio_id)
            If ser.Length > 0 Then
                sername = ser(0)("nombre_servicio")
                fila("tipo_servicio_id") = ser(0)("tipo_servicio_id") 'traducir?

                fila("porc_impuesto") = ser(0)("porcentaje") 'sacar del servicio+hotel
                fila("impuesto_id") = ser(0)("impuesto_id") 'sacar del servicio+hotel
            Else
                'no tiene servicio asignado..error?
            End If
            fila("descripcion") = sername
            fila("ucid") = unidad_calculo_id 'sacar de los paxes?
            Dim ucname = "Desconocido"
            Dim uc() As DataRow = ucs.Select("unidad_calculo_id=" & unidad_calculo_id)
            If uc.Length > 0 Then
                ucname = uc(0)("UC")
            End If
            fila("desc_uc_reserva") = ucname
            fila("impuesto_incluido") = 1

            resultado.Rows.Add(fila)

            'End If
            fila("importe") += precio
            fila("cantidad") += cantidad
        End Sub
        Private Function DingusCompactaLineas(ByVal servicios As DataTable) As DataTable
            Dim tmptable As DataTable = servicios.Clone
            While servicios.Rows.Count - 1 >= 0
                Dim lin As DataRow = servicios.Rows(0)
                Dim filas() As DataRow = servicios.Select("ambito_id=" & lin("ambito_id") & " and fecha='" & lin("fecha") & "' and servicio_id=" & lin("servicio_id") & " and ucid=" & lin("ucid"))
                Dim res As DataRow = tmptable.Rows.Add(filas(0).ItemArray)
                filas(0).Delete()
                If filas.Length > 1 Then
                    Dim z As Integer
                    For z = 1 To filas.Length - 1
                        res("importe") += filas(z)("importe")
                        res("precio") += filas(z)("precio")
                        filas(z).Delete()
                    Next
                End If
            End While
            servicios = tmptable

            tmptable = servicios.Clone
            While servicios.Rows.Count - 1 >= 0
                Dim lin As DataRow = servicios.Rows(0)
                Dim precio As Decimal = lin("preciodecimal")
                Dim filas() As DataRow = servicios.Select("preciodecimal='" & precio & "'  and fecha='" & lin("fecha") & "' and servicio_id=" & lin("servicio_id") & " and ucid=" & lin("ucid"))
                Dim res As DataRow = tmptable.Rows.Add(filas(0).ItemArray)
                filas(0).Delete()
                If filas.Length > 1 Then
                    Dim z As Integer
                    For z = 1 To filas.Length - 1
                        res("cantidad") += filas(z)("cantidad")
                        res("importe") += filas(z)("importe")
                        filas(z).Delete()
                    Next
                End If
            End While
            Return tmptable
        End Function
        Private Function sumarPreciosDingus(ByVal lineaprecios As Dingus.Price(), Optional ByVal toadd As Decimal = 0, Optional ByVal fecha As Date = Nothing, Optional ByVal matadd As ArrayList = Nothing, Optional ByVal all As Boolean = False) As Decimal
            Dim x As Integer
            Dim total As Decimal = 0
            Dim y = lineaprecios.Length - 1
            For x = 0 To y
                If lineaprecios(x).PriceLineType = Dingus.PriceLineType.Income Then
                    If fecha.Year = 1 OrElse (fecha = lineaprecios(x).Day And (lineaprecios(x).RoomPrice = False Or all)) Then
                        'lineaprecios(x).Amount += toadd
                        total += lineaprecios(x).Amount + toadd
                        If Not IsNothing(matadd) Then
                            matadd.Add(lineaprecios(x))
                        End If
                    End If

                End If

            Next
            Return total
        End Function
        Private Sub recalculaComisionDingus(ByVal lineaprecios As Dingus.Price(), ByVal comision As Decimal)
            Dim y As Integer = lineaprecios.Length - 1
            Dim x As Integer
            For x = 0 To y
                lineaprecios(x).Amount = lineaprecios(x).Amount * (100D - comision) / 100D
                'lineaprecios(x).Amount = lineaprecios(x).Amount * 100 / (100 - comision)
            Next
        End Sub
        Private Sub recalculaIgicDingus(ByVal lineaprecios As Dingus.Price(), ByVal servicios As DataTable, ByVal equivalencias As DataTable, ByVal RoomCode As Object, ByVal BoardCode As Object)
            Dim y As Integer = lineaprecios.Length - 1
            Dim x As Integer
            Dim IGIC As Decimal = 0
            For x = 0 To y
                Dim code As String = lineaprecios(x).Code
                Dim servicio_id As Integer
                Dim codeextra = code
                If lineaprecios(x).PriceType = Dingus.PriceType.Room Then
                    codeextra = RoomCode
                Else
                    codeextra = BoardCode
                End If
                servicio_id = convertirCamposDingus(code, "Code", False, lineaprecios(x).PriceType, codeextra)
                If servicio_id = -1 Then
                    servicio_id = convertirCamposDingus(RoomCode, "RoomCode", False)
                    Dim rows() As DataRow = equivalencias.Select("servicio_opcion_id=" & servicio_id)
                    If rows.Length > 0 Then
                        servicio_id = rows(0).Item("servicio_id")
                    End If
                End If
                IGIC = 0
                If servicio_id <> -1 Then
                    Dim ser() As DataRow = servicios.Select("servicio_id=" & servicio_id)
                    If ser.Length > 0 Then
                        IGIC = ser(0)("porcentaje") 'sacar del servicio+hotel
                    Else
                        'no tiene servicio asignado..error?
                    End If
                Else
                    Console.WriteLine("sin servicio")
                End If
                'lineaprecios(x).Amount = lineaprecios(x).Amount * 100 / (100 + IGIC)
                lineaprecios(x).Amount = lineaprecios(x).Amount * (100D + IGIC) / 100D

            Next
        End Sub
        Function ClonarObjecto(ByVal obj As Object)
            Dim sx As New XmlSerializer(obj.GetType())
            Dim ms As New IO.MemoryStream
            sx.Serialize(ms, obj)
            ms.Position = 0
            obj = sx.Deserialize(ms)
            Return obj
        End Function
        Shared sqlServiciosHotel As String = "" _
& " SELECT" _
& " servicios_hotel.servicio_id,servicios_hotel.impuesto_id," _
& " impuestos.impuesto," _
& " impuestos.porcentaje," _
& " servicios.nombre_servicio," _
& " servicios.tipo_servicio_id" _
& " FROM " _
& " servicios_hotel " _
& " Inner Join servicios ON servicios_hotel.servicio_id = servicios.servicio_id" _
& " Right Join impuestos ON servicios_hotel.impuesto_id = impuestos.impuesto_id" _
& " where servicios_hotel.hotel_id=?"
        Private Function CreaLineasPreciosDingus(ByVal cmd As MySqlCommand, ByVal datos As DataSet, ByVal reserva_Dingus As Dingus.BookingRS, ByVal impuestos_incluidos As Integer, ByVal comision As Decimal) As Decimal

            Dim resultado As New tablaServicios
            resultado.servicios.Columns.Add("impuesto_id", System.Type.GetType("System.Int16"))
            Dim x As Integer

            cmd.Parameters.Clear()
            Dim hotel_idParam As New MySqlParameter("@hotel_id", reserva_Dingus.HotelCode)
            cmd.Parameters.Add(hotel_idParam)

            Dim servicios As DataSet = getDataSet(cmd, sqlServiciosHotel, True)
            Dim ucs As DataTable = getDataSet(cmd, sqlUnidadesCalculos, True).Tables(0) ' se puede cachear
            'Dim cacheservicios As New Hashtable
            Console.WriteLine(reserva_Dingus.TotalPrice)
            Dim hasroom As Boolean = False
            Dim soloalojamiento = False
            Dim equivalencias As DataSet = getDataSet(cmd, sqlEquivalencias, True)
            Dim cunas As DataTable = resultado.servicios.Clone()
            Dim servicios_extras As DataTable = resultado.servicios.Clone()

            Dim totalreserva As Decimal = reserva_Dingus.TotalPrice
            If IsNothing(reserva_Dingus.ContractPriceDetails) Then
                totalreserva = 0
            Else
                If reserva_Dingus.ContractPriceDetails.Length = 0 Then
                    totalreserva = 0
                End If
            End If

            Dim lineaprecios() As Dingus.Price = reserva_Dingus.PriceDetails
            If Not IsNothing(reserva_Dingus.ContractPriceDetails) Then
                If reserva_Dingus.ContractPriceDetails.Length > 0 Then
                    'todo comprobar precios
                    'y contract_price_datils se le aplicara la comision configurada
                    Dim cp_details() As Dingus.Price = reserva_Dingus.ContractPriceDetails
                    If comision <> 0 Then
                        cp_details = ClonarObjecto(reserva_Dingus.ContractPriceDetails)
                        recalculaComisionDingus(cp_details, comision)
                    End If

                    'pricedetails se le aplicara el IGIC si esta configurao en la bd
                    Dim price_details() As Dingus.Price = reserva_Dingus.PriceDetails
                    If impuestos_incluidos = 0 Then
                        price_details = ClonarObjecto(reserva_Dingus.PriceDetails)
                        recalculaIgicDingus(price_details, servicios.Tables(0), equivalencias.Tables(0), reserva_Dingus.RoomCode, reserva_Dingus.BoardCode)
                    End If

                    Dim totaltour As Decimal = sumarPreciosDingus(price_details)
                    totalreserva = totaltour
                    Dim totalrecalc As Decimal = sumarPreciosDingus(cp_details)
                    If totaltour = totalrecalc Then
                        lineaprecios = cp_details
                    Else
                        totalreserva = totalrecalc
                        'si precios no coinciden generar nueva lineaprecios virtual con una resta
                        Dim lineas As New ArrayList
                        Dim cyc As Integer
                        For cyc = 0 To price_details.Length - 1
                            If price_details(cyc).RoomPrice And price_details(cyc).PriceType = Dingus.PriceType.Room And price_details(cyc).PriceLineType = Dingus.PriceLineType.Income Then
                                Dim nlinea As New Dingus.Price
                                lineas.Add(nlinea)
                                nlinea.Day = price_details(cyc).Day
                                nlinea.Amount = sumarPreciosDingus(price_details, 0, nlinea.Day, Nothing, True) - sumarPreciosDingus(cp_details, 0, nlinea.Day, lineas)
                                nlinea.Code = price_details(cyc).Code
                                nlinea.Guaranteed = price_details(cyc).Guaranteed
                                nlinea.PaxNo = price_details(cyc).PaxNo
                                nlinea.PaxType = price_details(cyc).PaxType
                                nlinea.PriceLineType = price_details(cyc).PriceLineType
                                nlinea.PriceType = price_details(cyc).PriceType
                                nlinea.RateCode = price_details(cyc).RateCode
                                nlinea.RateID = price_details(cyc).RateID
                                nlinea.RateLineID = price_details(cyc).RateLineID
                                nlinea.RoomNo = price_details(cyc).RoomNo
                                nlinea.RoomPrice = price_details(cyc).RoomPrice
                                nlinea.SuplType = price_details(cyc).SuplType
                            End If
                        Next
                        'pasar lineas a lineas de precios
                        lineaprecios = lineas.ToArray(GetType(Dingus.Price))
                    End If

                End If
            End If

            '--------------------------------------------------------------------------------------------
            ' GARRA DE JAVIER JULIO 2012
            ' Preparacion para el price detail
            '--------------------------------------------------------------------------------------------
            Dim sql_empresa As String = "Select empresa_id From hoteles where hotel_id =?"
            Dim cliente_id = convertirCamposDingus(reserva_Dingus.CustomerCode, "CustomerCode")

            Dim sql_edades As String = "SELECT tipos_huesped.uc_id FROM tipos_huesped " _
            & " WHERE tipos_huesped.tipo_huesped_id = " _
            & " (SELECT Coalesce(contratos_edades.tipo_huesped_id,hoteles_edades.tipo_huesped_id) AS tipo_huesped_id " _
            & " FROM hoteles_edades " _
            & "Left Join contratos On contratos.hotel_id=hoteles_edades.hotel_id And contratos.contrato_id =? " _
            & "Left Join contratos_edades ON contratos.contrato_id = contratos_edades.contrato_id " _
            & "WHERE hoteles_edades.hotel_id = ? AND " _
            & "? BETWEEN Coalesce(contratos_edades.edad_minima,hoteles_edades.edad_minima) AND Coalesce(contratos_edades.edad_maxima,hoteles_edades.edad_maxima)LIMIT 0,1)"


            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            Dim empresa_id As Integer = ExecuteScalar(cmd, sql_empresa, True)
            '---------------------------------------------------------------------'
            ' Necesito el contrato_id para el tema de los N1 o N2                 '
            '---------------------------------------------------------------------'
            Dim sql_contrato_id = "SELECT contrato_id FROM contratos Where hotel_id =? AND cliente_id = ? AND ? Between fecha_desde AND fecha_hasta"
            Dim contrato_id As Integer = 0

            Dim fechaParam As New MySqlParameter("@fecha", reserva_Dingus.DateFrom)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Try
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(fechaParam)
                contrato_id = ExecuteScalar(cmd, sql_contrato_id, True)
            Catch ex As Exception

            End Try
            Dim contrato_idParam As New MySqlParameter("@contrato_id", contrato_id)
            ' --------------------------------------------------------------------------------------------------------
            ' FIN GARRA JAVIER JULIO 2012
            ' --------------------------------------------------------------------------------------------------------
            'ContractPriceDetails()
            Dim nk As Integer
            For nk = 0 To reserva_Dingus.Paxes.Length - 1
                If reserva_Dingus.Paxes(nk).PaxAge < 0 Then
                    reserva_Dingus.Paxes(nk).PaxAge = 0
                End If
            Next
            Try
                Array.Sort(reserva_Dingus.Paxes)
            Catch ex As Exception

            End Try
            For x = 0 To lineaprecios.Length - 1
                Dim linea As Dingus.Price = lineaprecios(x)
                If linea.PriceLineType = Dingus.PriceLineType.Income Then

                    'encontrar fila
                    'segun el paxno sacar su uc
                    'buscar fila con servicio,uc,fecha
                    'no existe crear una
                    Dim esalojamiento As Boolean = False
                    Dim esroom As Boolean = False
                    Dim code As String = linea.Code
                    'Dim tkey As String
                    'tkey = linea.Day & "-" & linea.PriceLineType & "-" & linea.PaxType
                    Dim servicio_id As Integer
                    Dim cantidad As Integer = 1
                    Dim codeextra = code
                    If linea.PriceType = Dingus.PriceType.Board Then
                        codeextra = reserva_Dingus.BoardCode
                    Else
                        codeextra = reserva_Dingus.RoomCode
                    End If
                    Dim servicio_unidad As Boolean = False
                    Select Case linea.Code
                        Case "cama extra"
                            servicio_id = 78
                            servicio_unidad = True
                        Case Else
                            servicio_id = convertirCamposDingus(code, "Code", False, linea.PriceType, codeextra)
                    End Select
                    'If linea.Code = "cama extra" Then
                    '    servicio_id = 78
                    'Else
                    '    servicio_id = convertirCamposDingus(code, "Code", False, linea.PriceType, codeextra)
                    'End If

                    If servicio_id = -1 Then
                        esalojamiento = True
                        soloalojamiento = True
                        servicio_id = convertirCamposDingus(reserva_Dingus.RoomCode, "RoomCode", False)
                        Dim rows() As DataRow = equivalencias.Tables(0).Select("servicio_opcion_id=" & servicio_id)
                        If rows.Length > 0 Then
                            servicio_id = rows(0).Item("servicio_id")
                        End If
                    End If
                    If servicio_id <> 0 Then


                        '--------------------------------------------------------------------------------------------------------
                        ' JULIO 2012 GARRA JAVIER
                        ' Llamo a la Rutina ObtienePaxDingus para saber a que persona le toca la linea o servicio 
                        ' Sabemos paxno que nos dice el nº de individuo dentro de los de su clase
                        ' Asi si paxno=2 y PaxType="Dingus.PaxType.CHD quiere decir que estamos ante el segundo de tipo Niño 
                        ' no el segundo huesped
                        '---------------------------------------------------------------------------------------------------------
                        Dim dingus_pax As Dingus.Pax = ObtienePaxDingus(reserva_Dingus.Paxes, linea.PaxType, linea.PaxNo)

                        Dim edadParam As New MySqlParameter("@edad_minima", 0)
                        Dim unidad_calculo_id As Integer = 0
                        ' ----------------------------------------------------------------------------------------------------------------------------------
                        ' Busco la unidad de calculo según paxType
                        ' Antes llamaba a la rutina Dim unidad_calculo_id As Integer = convertirCamposDingus(linea.PaxType, "PaxType", False, dingus_pax)
                        ' Ahora lo hago a huevo aquí porque me ahorro el paso de parametros 
                        ' ----------------------------------------------------------------------------------------------------------------------------------
                        ' Determinar el tipo segun la edad si no viene codificado
                        ' O los tipo Niños que en dingus no vienen separados en N1 y N2
                        ' --------------------------------------------------------------------------

                        Select Case dingus_pax.PaxType
                            Case Dingus.PaxType.ADT ' Adulto no pregunto edad
                                unidad_calculo_id = 2

                            Case Dingus.PaxType.ENF ' Bebe paso de la edad
                                unidad_calculo_id = 5
                            Case Dingus.PaxType.CHD ' Niños hay que preguntar la edad para saber si es N1 o N2
                                unidad_calculo_id = 3  ' Por defecto es N1 50% en caso de que no venga edad 

                                If dingus_pax.PaxAge > 0 Then
                                    cmd.Parameters.Clear()
                                    cmd.Parameters.Add(contrato_idParam)
                                    cmd.Parameters.Add(hotel_idParam)
                                    edadParam.Value = dingus_pax.PaxAge
                                    cmd.Parameters.Add(edadParam)
                                    Dim reader As DataTableReader = getDataTable(cmd, sql_edades, True)
                                    While reader.Read
                                        unidad_calculo_id = reader.Item("uc_id")
                                    End While
                                End If
                        End Select
                        If servicio_unidad Then   ' Cama Extra, babytroll, baby chair, sailor etc entonces a piñón es servicio 
                            unidad_calculo_id = 1
                        End If
                        ' --------------------------------------------------------------------------------------------------------
                        ' FIN GARRA JAVIER JULIO 2012
                        ' --------------------------------------------------------------------------------------------------------
                        If linea.RoomPrice And linea.PriceType = Dingus.PriceType.Room Then
                            hasroom = True
                            unidad_calculo_id = 1 'srv a fuego
                        Else
                            If linea.PriceType <> Dingus.PriceType.Board Then
                                'deberia sacar el alojamiento bla bla
                                Dim rows() As DataRow = equivalencias.Tables(0).Select("servicio_opcion_id=" & servicio_id)
                                If rows.Length > 0 Then
                                    servicio_id = rows(0).Item("servicio_id")
                                End If
                                esroom = True
                            End If
                        End If

                        'If esalojamiento And unidad_calculo_id = 5 Then

                        If Not esroom And unidad_calculo_id = 5 Then

                            Dim uc() As DataRow
                            uc = ucs.Select("unidad_calculo_id=" & unidad_calculo_id)
                            If uc.Length > 0 Then
                                servicio_id = uc(0)("servicio_id")
                            End If

                            AddLineaDingus(ucs, servicios, cunas, servicio_id, 1, cantidad, 0, linea.Day, linea.PaxNo)

                        Else
                            AddLineaDingus(ucs, servicios, resultado.servicios, servicio_id, unidad_calculo_id, cantidad, linea.Amount, linea.Day, linea.PaxNo)
                        End If
                    End If
                End If
            Next
            'compactar lineas
            'si existe mas de una linea igual sumar precio y borrar
            resultado.servicios = DingusCompactaLineas(resultado.servicios)
            cunas = DingusCompactaLineas(cunas)
            'por cada dia meter el tipo servicio habitacion
            If hasroom Then
                'sacar todas las lineas distintas de servicio
                'sacar la linea de servicio por dia
                'por cada adulto,niño,etc crear una alojamiento usando la equivalencia
                If Not soloalojamiento Then
                    ' Aqui Garra Javier JULIO 2012

                    Dim retval() As Object = getDingusHuespedes(cmd, reserva_Dingus, ucs, "", "", "", cliente_id) 'empresa_id a fuego...
                    ' Fin Garra Kavier JULIO 2012
                    'Dim hues As ArrayList = retval(0)
                    Dim unid As Hashtable = retval(1)

                    Dim tmptable As DataTable = resultado.servicios.Clone()
                    Dim alojammiento_servicio_id = 0
                    Dim sername As String = "Desconocido"
                    For x = 0 To resultado.servicios.Rows.Count - 1
                        If resultado.servicios.Rows(x).Item("ucid") = 1 Then

                            Dim rows() As DataRow = equivalencias.Tables(0).Select("servicio_opcion_id=" & resultado.servicios.Rows(x).Item("servicio_id"))
                            If rows.Length > 0 Then
                                If alojammiento_servicio_id <> rows(0).Item("servicio_id") Then
                                    alojammiento_servicio_id = rows(0).Item("servicio_id")
                                    Dim ser() As DataRow = servicios.Tables(0).Select("servicio_id=" & alojammiento_servicio_id)
                                    If ser.Length > 0 Then
                                        sername = ser(0)("nombre_servicio")
                                    End If
                                End If


                            End If
                            rows = resultado.servicios.Select("fecha='" & resultado.servicios.Rows(x).Item("fecha") & "' and ucid<>1")
                            Dim z As Integer = rows.Length - 1
                            Dim y As Integer = 0
                            If z = -1 Then
                                'crear las pensiones
                                rows = resultado.servicios.Select("fecha='" & resultado.servicios.Rows(x).Item("fecha") & "' and ucid=1")
                                y = 0
                                'reserva_Dingus.Paxes.Length

                                z = rows.Length - 1
                                Dim pension_servicio_id As Integer = convertirCamposDingus(reserva_Dingus.BoardCode, "BoardCode")
                                Dim skipaddpensiones As Boolean = False
                                If 1 = 1 Then
                                    If pension_servicio_id = 0 Then
                                        pension_servicio_id = alojammiento_servicio_id
                                        skipaddpensiones = True
                                        'penname = sername
                                        'Dim rows() As DataRow = equivalencias.Tables(0).Select("servicio_opcion_id=" & servicio_id)
                                        'If rows.Length > 0 Then
                                        'pension_servicio_id = rows(0).Item("servicio_id")
                                        'End If
                                    End If
                                End If
                                Dim ser() As DataRow = servicios.Tables(0).Select("servicio_id=" & pension_servicio_id)
                                Dim penname = "Desconocido"
                                If ser.Length > 0 Then
                                    For y = 0 To z
                                        Dim uid As UCS
                                        Dim uiobj As Object
                                        For Each uiobj In unid
                                            uid = uiobj.value
                                            Dim fila As DataRow = tmptable.Rows.Add(rows(y).ItemArray)
                                            fila.Item("ucid") = uid.unidad_calculo_id 'adultos

                                            Dim ucname = "Desconocido"
                                            Dim uc() As DataRow = ucs.Select("unidad_calculo_id=" & uid.unidad_calculo_id)
                                            If uc.Length > 0 Then
                                                ucname = uc(0)("UC")
                                            End If
                                            fila.Item("desc_uc_reserva") = ucname

                                            fila.Item("servicio_id") = pension_servicio_id 'pension
                                            fila.Item("cantidad") = uid.cantidad ' cantidad
                                            fila.Item("tipo_servicio_id") = ser(0)("tipo_servicio_id") 'traducir?

                                            fila.Item("porc_impuesto") = ser(0)("porcentaje") 'sacar del servicio+hotel
                                            fila.Item("impuesto_id") = ser(0)("impuesto_id") ''sacar del servicio+hotel
                                            fila.Item("importe") = 0
                                            fila.Item("descripcion") = ser(0)("nombre_servicio")
                                        Next
                                    Next
                                End If
                                rows = tmptable.Select("fecha='" & resultado.servicios.Rows(x).Item("fecha") & "' and ucid<>1")
                                z = rows.Length - 1
                                If skipaddpensiones Then
                                    z = -1
                                End If
                            End If
                            y = 0
                            For y = 0 To z
                                Dim fila As DataRow = tmptable.Rows.Add(rows(y).ItemArray)
                                fila.Item("servicio_id") = alojammiento_servicio_id
                                fila.Item("importe") = 0
                                fila("descripcion") = sername
                            Next

                            rows = cunas.Select("fecha='" & resultado.servicios.Rows(x).Item("fecha") & "' and ucid=1")
                            For y = 0 To rows.Length - 1
                                Dim fila As DataRow = tmptable.Rows.Add(rows(y).ItemArray)
                                fila.Item("servicio_id") = alojammiento_servicio_id
                                fila.Item("importe") = 0
                                fila.Item("ucid") = 5 'bebes
                                fila("desc_uc_reserva") = "B"
                                fila("descripcion") = sername
                            Next
                        End If

                    Next
                    For x = 0 To tmptable.Rows.Count - 1
                        resultado.servicios.Rows.Add(tmptable.Rows(x).ItemArray)
                    Next
                End If
            Else
                If Not reserva_Dingus.Status = Dingus.StatusBookingRS.Cancel Then
                    For x = 0 To reserva_Dingus.Stays.Length - 1
                        Dim linea As Dingus.Stay = reserva_Dingus.Stays(x)
                        Dim fila As DataRow = Nothing
                        fila = resultado.servicios.NewRow()
                        Dim servicio_id As Integer = convertirCamposDingus(linea.RoomCode, "RoomCode", False, Nothing, reserva_Dingus.RoomCode)
                        Dim unidad_calculo_id As Integer = 1
                        AddLineaDingus(ucs, servicios, resultado.servicios, servicio_id, unidad_calculo_id, 1, 0, linea.Date, 0)
                    Next
                End If
            End If
            '----------------------------------------------------------------------------------------------
            ' AGOSTO 2012
            ' JN Extras de reserva 
            ' Creada la tabla dingus_extras para la traducción de codigos de dingus a geshotel
            ' Campos de la tabla son:
            '           - codigo_extra equivalente al dingus Extracode
            '           - servicio_id
            '           - uc_id
            '           - Tipo (1 LLegada /2 Salida / 3 Todos los días)
            ' Se usa la variable servicios_extras declarada mas arriba de la siguiente manera
            '           Dim servicios_extras As DataTable = resultado.servicios.Clone()
            '----------------------------------------------------------------------------------------------
            Dim Extras() As Dingus.Extra = reserva_Dingus.Extras

            Try
                Dim dingus_extras As DataTable = getDataSet(cmd, "SELECT * FROM dingus_extras", True).Tables(0)
                For x = 0 To Extras.Length - 1
                    Dim tipo As Integer
                    Dim fecha As Date
                    Dim extra As Dingus.Extra = Extras(x)
                    Dim ser() As DataRow = dingus_extras.Select("codigo_extra='" + extra.ExtraCode + "'")
                    If ser.Length > 0 Then
                        tipo = ser(0)("tipo")
                        Select Case tipo
                            Case 1
                                fecha = reserva_Dingus.DateFrom
                                AddLineaDingus(ucs, servicios, servicios_extras, ser(0)("servicio_id"), ser(0)("uc_id"), extra.ExtraQuantity, 0, fecha, extra.NoPax)
                            Case 2
                                fecha = reserva_Dingus.DateTo
                                AddLineaDingus(ucs, servicios, servicios_extras, ser(0)("servicio_id"), ser(0)("uc_id"), extra.ExtraQuantity, 0, fecha, extra.NoPax)
                            Case 3
                                fecha = reserva_Dingus.DateFrom
                                Do While fecha < reserva_Dingus.DateTo
                                    AddLineaDingus(ucs, servicios, servicios_extras, ser(0)("servicio_id"), ser(0)("uc_id"), extra.ExtraQuantity, 0, fecha, extra.NoPax)
                                    fecha = DateAdd(DateInterval.Day, 1, fecha)
                                Loop
                        End Select
                    End If
                Next
            Catch ex As Exception

            End Try
            ' Compactamos
            servicios_extras = DingusCompactaLineas(servicios_extras)
            For x = 0 To servicios_extras.Rows.Count - 1
                resultado.servicios.Rows.Add(servicios_extras.Rows(x).ItemArray)
            Next
            ' ---------------------------
            ' FIN Extras
            ' ---------------------------
            For x = 0 To cunas.Rows.Count - 1
                resultado.servicios.Rows.Add(cunas.Rows(x).ItemArray)
            Next
            resultado.servicios.TableName = "tablaservicios"
            datos.Tables.Add(resultado.servicios)
            Return totalreserva

        End Function
        Shared sqlOfertasTienenCodigo = "SELECT count(*) FROM ofertas_codigos WHERE ofertas_codigos.codigo_oferta =  @codigo AND ofertas_codigos.oferta_id IN  (@ofertas_id)"
        Function obtieneServiciosReserva(ByVal res As MetaReserva, Optional ByVal crear As Boolean = False, Optional ByVal old_reserva_id As Integer = 0) As tablaServicios
            Dim errorCode As Integer = 0
            Dim errorTxt As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado As tablaServicios
            resultado = New tablaServicios
            Dim datos As DataSet = New DataSet
            Try
                If Not IsNothing(res.reserva_Dingus) Then
                    ConvierteDingusAMetareserva(cmd, res)
                End If
                If res.hotel_id > 0 Then
                    'cargar tabla equivalencias
                    Dim equivalencias As DataSet = getDataSet(cmd, sqlEquivalencias)
                    Dim unidades_calculos As DataSet = getDataSet(cmd, sqlUnidadesCalculos)
                    Dim servicios As DataSet = getDataSet(cmd, sqlServicios)
                    Dim totalreserva As Decimal
                    datos = preparaDatasetReserva(cmd, old_reserva_id, res.reserva_Dingus, res.reserva_Dingus_tipo, res.reserva_Dingus_impuestos_incluidos, res.reserva_Dingus_comision, totalreserva)

                    Dim row As DataRow
                    If Not IsNothing(res.habitacion) Then
                        res.habitacion_id = ObtieneHabitacion_Id(cmd, res.hotel_id, res.habitacion)
                        ' ----------------------------------------------------------------------------------------------------
                        ' se Añadió para evitar que el acelerador añada el registro habitaciones_bloqueos con habitacion_id =0
                        ' Febrero 2014
                        '-----------------------------------------------------------------------------------------------------
                        If res.habitacion_id = 0 Then
                            res.habitacion_id = Nothing
                        End If
                        AgregaInfo("obtieneServiciosReserva", res.habitacion & "-" & res.habitacion_id, -errorCode)

                    End If
                    If Not IsNothing(res.habitacion_id) Then
                        row = datos.Tables("reservas_habitaciones").Rows.Add()
                        row.Item("habitacion_id") = res.habitacion_id
                        row.Item("tipo_bloqueo_id") = 1
                        row.Item("fecha_desde") = res.fecha_prevista_llegada
                        row.Item("fecha_hasta") = res.fecha_prevista_salida
                        row.Item("user_id") = userId
                        row.Item("fecha_modificacion") = Now
                        'If Not IsNothing(res.cliente_id_factura) Then
                        '    row.Item("ttoo_id") = res.cliente_id_factura
                        'Else
                        '    row.Item("ttoo_id") = res.cliente_id
                        'End If
                    End If
                    row = datos.Tables("reserva").Rows.Add()
                    row.Item("dingus_impuestos_incluidos") = 1
                    row.Item("dingus_comision") = 0

                    If Not IsNothing(res.reserva_Dingus) Then
                        Dim serializer As New XmlSerializer(GetType(Dingus.BookingRS))
                        Dim stream As System.IO.MemoryStream = New System.IO.MemoryStream()
                        Dim tem = New System.Xml.XmlTextWriter(stream, System.Text.Encoding.UTF8)
                        serializer.Serialize(tem, res.reserva_Dingus)
                        row.Item("dingus_impuestos_incluidos") = res.reserva_Dingus_impuestos_incluidos
                        row.Item("dingus_comision") = res.reserva_Dingus_comision
                        row.Item("reserva_dingus") = System.Text.Encoding.UTF8.GetString(stream.ToArray())
                        row.Item("reserva_dingus_tipo") = res.reserva_Dingus_tipo '0-no dignus,1-dingus,2-dingus pero con precios geshotel
                        If res.reserva_Dingus_tipo = 2 Then
                            res.bloquear_tarifa = False 'no se puede blokear si es precio hotel
                        End If

                        If row.IsNull("valor_validado") And res.reserva_Dingus_tipo <> 2 Then
                            Dim total As Decimal = totalreserva 'sumarPreciosDingus(res.reserva_Dingus.PriceDetails)
                            'If Not IsNothing(res.reserva_Dingus.ContractPriceDetails) Then
                            'If res.reserva_Dingus.ContractPriceDetails.Length > 0 Then
                            'total = sumarPreciosDingus(res.reserva_Dingus.ContractPriceDetails)
                            'End If
                            'End If
                            row("valor_validado") = total 'res.reserva_Dingus.TotalPrice
                            row("fecha_validacion") = Now
                            row("usuario_validacion") = 1
                        End If
                        If res.reserva_Dingus_tipo = 2 And res.reserva_Dingus.TotalPrice <> 0 Then
                            row("valor_validado") = res.reserva_Dingus.TotalPrice
                            row("fecha_validacion") = Now
                            row("usuario_validacion") = 1
                        End If
                        row.Item("user_id") = 1    ' Si es dingus, el usuario siempre es Postmaster
                    Else
                        row.Item("user_id") = userId
                        row.Item("reserva_dingus_tipo") = 0 '0-no dignus,1-dingus,2-dingus pero con precios geshotel
                    End If

                    If res.tipo_tarjeta_id <> 0 Then
                        row.Item("tipo_tarjeta_id") = res.tipo_tarjeta_id
                    End If
                    If res.tarjeta_credito <> "" Then
                        row.Item("tarjeta_credito") = res.tarjeta_credito
                    End If
                    If res.caducidad <> "" Then
                        row.Item("caducidad") = res.caducidad
                    End If
                    If res.cod_seguridad <> "" Then
                        row.Item("cod_seguridad") = res.cod_seguridad
                    End If
                    If res.email <> "" Then
                        row.Item("email") = res.email
                    End If

                    row.Item("reserva_id") = 0
                    row.Item("hotel_id") = res.hotel_id
                    row.Item("estado_reserva_id") = 0
                    If res.canal_reserva_id <> 0 Then
                        row.Item("canal_reserva_id") = res.canal_reserva_id
                    End If
                    row.Item("cliente_id") = res.cliente_id
                    If res.cliente_id_factura <> 0 Then
                        row.Item("cliente_id_factura") = res.cliente_id_factura
                    End If
                    row.Item("fecha_reserva") = res.fecha_reserva
                    row.Item("fecha_prevista_llegada") = res.fecha_prevista_llegada
                    row.Item("fecha_prevista_salida") = res.fecha_prevista_salida
                    Try  ' Garra Javier
                        row.Item("valor") = totalreserva
                    Catch ex As Exception

                    End Try
                    'Try
                    '    row.Item("hora_prevista_llegada") = CDate(res.hora_prevista_llegada).TimeOfDay
                    'Catch ex As Exception

                    'End Try
                    'Try
                    '    row.Item("hora_prevista_salida") = CDate(res.hora_prevista_salida).TimeOfDay
                    'Catch ex As Exception

                    'End Try

                    Try
                        row.Item("codigo_oferta") = res.codigo_oferta
                    Catch ex As Exception

                    End Try
                    Try
                        row.Item("observaciones_llegada") = res.observaciones
                    Catch ex As Exception

                    End Try

                    Try
                        row.Item("paroventas_check") = res.paro_ventas
                    Catch ex As Exception

                    End Try
                    Try
                        row.Item("cupos_check") = res.cupos

                    Catch ex As Exception

                    End Try

                    Try
                        row.Item("release_check") = res.release
                    Catch ex As Exception

                    End Try
                    row.Item("bono_referencia") = res.bono_referencia
                    Try
                        row.Item("bono_online") = res.bono_online
                    Catch ex As Exception

                    End Try

                    row.Item("bloquear_tarifa") = res.bloquear_tarifa
                    row.Item("vip") = res.vip
                    row.Item("permite_devolucion") = res.permite_devolucion
                    row.Item("user_id") = userId
                    row.Item("fecha_modificacion") = Now
                    ' ****************
                    ' Nuevo Geshotel
                    ' ****************
                    row.Item("pension_id") = res.pension_id
                    row.Item("tipo_habitacion_id") = res.tipo_habitacion_id
                    row.Item("adultos") = res.adultos
                    row.Item("child_50") = res.child_50
                    row.Item("child_free") = res.child_free
                    row.Item("bebes") = res.bebes
                    row.Item("fecha_llegada") = FormatDateTime(res.fecha_prevista_llegada, DateFormat.ShortDate)
                    row.Item("fecha_salida") = FormatDateTime(res.fecha_prevista_salida, DateFormat.ShortDate)
                    row.Item("nombre_reserva") = res.nombre_reserva
                    row.Item("ficheros") = res.ficheros
                    Try
                        row.Item("fecha_creacion") = res.fecha_creacion
                    Catch ex As Exception

                    End Try
                    '******************

                    If old_reserva_id <> 0 Then
                        'matar las lineas de reservas_servicios con flag_contrato=1
                        Dim xx As Integer
                        For xx = 0 To datos.Tables("reservas_servicios").Rows.Count - 1
                            If datos.Tables("reservas_servicios").Rows(xx)("flag_contrato") = 1 Then
                                datos.Tables("reservas_servicios").Rows(xx).Delete()
                            End If
                        Next

                        'actualizar campos de la cabecera reserva quitando una lista de campos clave
                        Dim camposaignorar As New Hashtable
                        camposaignorar.Add("reserva_id", 0)
                        camposaignorar.Add("estado_reserva_id", 0)
                        camposaignorar.Add("observaciones_llegada", 0)
                        camposaignorar.Add("observaciones_salida", 0)
                        'camposaignorar.Add("tipo_tarjeta_id", 0)
                        'camposaignorar.Add("tarjeta_credito", 0)
                        'camposaignorar.Add("caducidad", 0)
                        'camposaignorar.Add("cod_seguridad", 0)

                        camposaignorar.Add("email", 0)
                        'camposaignorar.Add("observaciones", 0)
                        camposaignorar.Add("codigo_oferta", 0)
                        camposaignorar.Add("vip", 0)
                        camposaignorar.Add("valor_validado", 0)
                        camposaignorar.Add("enviar_email", 0)
                        camposaignorar.Add("fecha_validacion", 0)
                        camposaignorar.Add("usuario_validacion", 0)

                        camposaignorar.Add("paroventas_check", 0)
                        camposaignorar.Add("cupos_check", 0)
                        camposaignorar.Add("release_check", 0)
                        camposaignorar.Add("idioma_id", 0)
                        camposaignorar.Add("tipo_checkinonline_id", 0)
                        camposaignorar.Add("clave_wifi", 0)
                        camposaignorar.Add("ssid", 0)
                        camposaignorar.Add("fecha_anulacion", 0)
                        camposaignorar.Add("eco_limpieza", 0)


                        Dim colname As String
                        Dim cols As DataColumnCollection = datos.Tables("reserva").Columns
                        Dim colcount As Integer = cols.Count - 1
                        Dim drow As DataRow = datos.Tables("reserva").Rows(0)
                        For xx = 0 To colcount
                            colname = cols(xx).ColumnName
                            If Not camposaignorar.ContainsKey(colname) Then
                                drow(colname) = row(colname)
                            End If

                        Next

                        datos.Tables("reserva").Rows.Remove(row)
                        Dim writer As MySqlDataAdapter
                        writer = getDataAdapter(cmd, sqlCabReserva)
                        writer.Fill(datos.Tables("reserva"))
                        writer.Update(datos.Tables("reserva"))
                    End If

                    'Dim writer As MysqlDataAdapter
                    'writer = getDataAdapter(cmd, sqlCabReserva)
                    'writer.Fill(datos.Tables(0))
                    'writer.Update(datos.Tables(0))
                    Dim reserva_id As Integer = 0 'ExecuteScalar(cmd, "SELECT LAST_INSERT_ID()")
                    'mete lineas reserva
                    'reserva_idParam.Value = reserva_id
                    'cmd.Parameters.Clear()
                    'cmd.Parameters.Add(reserva_idParam)
                    'datos = getDataSet(cmd, sqlReservasServicios)
                    Dim x As Integer
                    'crea la habitacion
                    Dim contador As Integer = 0
                    Dim servs As New ArrayList()

                    Dim rows() As DataRow = equivalencias.Tables(0).Select("servicio_opcion_id=" & res.habitacion_servicio_id)
                    servs.Add(res.habitacion_servicio_id)
                    If rows.Length > 0 Then
                        For x = 0 To rows.Length - 1
                            servs.Add(rows(x).Item("servicio_id"))
                        Next
                    End If

                    If IsNothing(res.pension_servicio_id) OrElse res.pension_servicio_id = 0 Then
                        servs.Add(0)
                    Else
                        servs.Add(res.pension_servicio_id)
                        rows = equivalencias.Tables(0).Select("servicio_opcion_id=" & res.pension_servicio_id)
                        If rows.Length > 0 Then
                            For x = 0 To rows.Length - 1
                                servs.Add(rows(x).Item("servicio_id"))
                            Next
                        End If
                    End If


                    Dim y As Integer
                    For y = 0 To servs.Count - 1
                        Dim tipo = servicios.Tables(0).Compute("max(tipo_unidad_calculo_id)", "servicio_id=" & servs(y))
                        If IsDBNull(tipo) Then
                            tipo = 2
                        End If
                        If Not (IsNothing(tipo)) Then

                            If tipo = 1 Then
                                If res.numero_habitaciones > 0 Then
                                    row = datos.Tables("reservas_servicios").Rows.Add()
                                    row.Item("servicio_reserva_id") = contador
                                    row.Item("reserva_id") = reserva_id

                                    row.Item("servicio_id") = servs(y)
                                    row.Item("unidad_calculo_id") = 1 ' servicio?
                                    row.Item("cantidad") = res.numero_habitaciones
                                    row.Item("flag_contrato") = 1
                                    row.Item("servicio_extra") = 0
                                    contador += 1
                                End If
                            End If
                            If tipo = 2 Then
                                For x = 0 To res.unidades_calculos.Count - 1
                                    If res.unidades_calculos(x).cantidad > 0 Then
                                        Dim servicioAsignar As Integer = servs(y)
                                        Dim ucidAsignar As Integer = res.unidades_calculos(x).unidad_calculo_id
                                        Dim rowsuc() As DataRow = unidades_calculos.Tables(0).Select("unidad_calculo_id=" & res.unidades_calculos(x).unidad_calculo_id)
                                        Dim rowseq() As DataRow = equivalencias.Tables(0).Select("servicio_id=" & servicioAsignar)

                                        If rowsuc.Length > 0 And rowseq.Length = 0 Then
                                            If Not rowsuc(0).IsNull("servicio_id") Then
                                                'todo si uc es bebe y no es alojamiento
                                                'cambiar servicio por el asignado
                                                'y uc por SRV
                                                ucidAsignar = 1 'servicio
                                                servicioAsignar = rowsuc(0).Item("servicio_id")
                                            End If
                                        End If
                                        If servicioAsignar <> 0 Then
                                            row = datos.Tables("reservas_servicios").Rows.Add()
                                            row.Item("servicio_reserva_id") = contador
                                            row.Item("reserva_id") = reserva_id
                                            row.Item("servicio_id") = servicioAsignar
                                            row.Item("unidad_calculo_id") = ucidAsignar
                                            row.Item("cantidad") = res.unidades_calculos(x).cantidad
                                            row.Item("flag_contrato") = 1
                                            row.Item("servicio_extra") = 0
                                            contador += 1
                                        End If
                                    End If
                                Next
                            End If
                        End If

                    Next
                    '----------------------------------------------------------------------------------------------
                    ' AGOSTO 2012
                    ' JN Extras de reserva
                    ' Creada la tabla dingus_extras para la traducción de codigos de dingus a geshotel
                    ' Campos de la tabla son:
                    '           - codigo_extra equivalente al dingus Extracode
                    '           - servicio_id
                    '           - uc_id
                    '           - Tipo (1 LLegada /2 Salida / 3 Todos los días)
                    ' 
                    '----------------------------------------------------------------------------------------------
                    If Not IsNothing(res.reserva_Dingus) Then
                        Dim lineaextras() As Dingus.Extra = res.reserva_Dingus.Extras

                        Dim dingus_extras As DataSet = getDataSet(cmd, "SELECT * FROM dingus_extras", True)
                        Dim codigo_extraParam As New MySqlParameter("@codigo_extra", "")
                        For x = 0 To lineaextras.Length - 1
                            Dim tipo As Integer
                            Dim ser() As DataRow = dingus_extras.Tables(0).Select("codigo_extra='" + lineaextras(x).ExtraCode + "'")
                            If ser.Length > 0 Then
                                row = datos.Tables("reservas_servicios").Rows.Add()
                                row.Item("servicio_reserva_id") = contador
                                row.Item("reserva_id") = reserva_id
                                row.Item("flag_contrato") = 1
                                row.Item("servicio_extra") = 0
                                row.Item("servicio_id") = ser(0)("servicio_id")
                                row.Item("unidad_calculo_id") = ser(0)("uc_id")
                                row.Item("cantidad") = lineaextras(x).ExtraQuantity
                                contador += 1
                                tipo = ser(0)("tipo")
                                Select Case tipo
                                    Case 1
                                        row.Item("fecha_desde") = res.reserva_Dingus.DateFrom
                                        row.Item("fecha_hasta") = DateAdd(DateInterval.Day, 1, res.reserva_Dingus.DateFrom)
                                    Case 2
                                        row.Item("fecha_desde") = DateAdd(DateInterval.Day, -1, res.reserva_Dingus.DateTo)
                                        row.Item("fecha_hasta") = res.reserva_Dingus.DateTo
                                    Case 3
                                        row.Item("fecha_desde") = res.reserva_Dingus.DateFrom
                                        row.Item("fecha_hasta") = res.reserva_Dingus.DateTo
                                End Select
                            End If
                            '---------------------------------------------------------------------------------------------------------
                        Next
                        ' ---------------------------
                        ' FIN Extras
                        ' ---------------------------
                    End If
                    If res.num_camas_extras > 0 Then
                        row = datos.Tables("reservas_servicios").Rows.Add()
                        row.Item("servicio_reserva_id") = contador
                        row.Item("reserva_id") = reserva_id
                        row.Item("servicio_id") = 78
                        row.Item("unidad_calculo_id") = 1
                        row.Item("cantidad") = res.num_camas_extras
                        row.Item("flag_contrato") = 1
                        row.Item("servicio_extra") = 0
                        contador += 1
                    End If
                    'writer = getDataAdapter(cmd, sqlReservasServicios)
                    'writer.Fill(datos.Tables(0))
                    'writer.Update(datos.Tables(0))

                    'si es dingus...generar las lineas directamente de prices.

                    resultado = obtieneServiciosReserva(cmd, datos, Nothing, Nothing)

                    'todo si codigo_oferta no es nulo...comprobar ke exista al menos una oferta para ese contrato
                    'con esa oferta o mostrar error
                    Try
                        If Not IsNothing(res.codigo_oferta) Then
                            If res.codigo_oferta <> "" Then
                                Dim ofertas As DataTable = datos.Tables("reservas_ofertas")
                                Dim ofertas_id As String = ""
                                Dim xx As Integer
                                For xx = 0 To ofertas.Rows.Count - 1
                                    If ofertas_id = "" Then
                                        ofertas_id = ofertas.Rows(xx)("oferta_id")
                                    Else
                                        ofertas_id &= "," & ofertas.Rows(xx)("oferta_id")
                                    End If
                                Next
                                Dim tmp As String = sqlOfertasTienenCodigo.replace("@codigo", "'" & res.codigo_oferta & "'")
                                tmp = tmp.Replace("@ofertas_id", ofertas_id)
                                If ExecuteScalar(cmd, tmp) = 0 Then
                                    'no hay ofertas ke coincidan con el codigo....asi ke error
                                    res.errores = "Codigo Oferta No Existe"
                                    errorTxt = res.errores
                                    resultado = Nothing
                                End If
                            End If
                        End If
                    Catch ex As Exception
                        errorCode = 3
                        errorTxt = "Fallo al comprobar codigos de Oferta"
                        AgregaInfo("obtieneServiciosReserva", "Fallo al comprobar codigos:", -errorCode)
                    End Try
                    'todo por cada oferta manual crear combinaciones
                    'y almacenarlas en distintas versiones por columna combinacion
                    If IsNothing(resultado) Then
                        errorCode = 2
                        AgregaInfo("obtieneServiciosReserva", "No se puede calcular los servicios de la meta-reserva:", -errorCode)
                        errorTxt = "No se puede calcular los servicios de la meta-reserva:"
                    End If
                Else
                    errorCode = 1
                    errorTxt = "Datos de Reserva no válidos"
                    AgregaInfo("obtieneServiciosReserva", "Meta-reserva: invalida", -errorCode)
                End If
            Catch ex As Exception
                errorCode = 3
                errorTxt = ex.Message
                AgregaInfo("obtieneServiciosReserva", ex.Message, -errorCode)
                resultado = New tablaServicios

                res.huespedes = Nothing
            End Try
            If Not IsNothing(resultado) Then
                'dumpResultado(resultado)
                'If Not crear Or resultado.sumaErrores() > 0 Or resultado.servicios.Rows.Count = 0 Or IsNothing(datos) Then
                If Not crear Or resultado.servicios.Rows.Count = 0 Or IsNothing(datos) Then
                    'existen errores..o no hay datos...o simplemente es un preview
                    errorCode = 1
                Else
                    Try

                        Dim resobject = grabaDatasetReserva(cmd, datos, old_reserva_id)
                        If Not IsNothing(resobject) Then
                            resultado.reserva_id = resobject
                            'meter los anticipos
                            'CrearAnticipoReserva(cmd, resultado.reserva_id, 300) 'sacar los anticipios de dingus

                            'asignarle los huespedes a la reserva
                            If Not IsNothing(res.huespedes) Then   ' AQUI GARRA JAVIER Actualizar huespedes si la reserva estado pendiente JULIO 2012
                                ' Si se ha hecho Checkin Online no se actualizan los huespedes SEPTIEMBRE 2013 
                                Dim online As Boolean = False
                                Dim estado_reserva_id As Integer = 1 ' Por defecto Pendiente de entrar
                                Dim reserva_idParam As New MySqlParameter("@reserva_id", old_reserva_id)

                                If old_reserva_id <> 0 Then ' Ya existe reserva, pregunto por su estado, sino, supongo pendiente de entrar
                                    'cmd.Parameters.Clear()
                                    'cmd.Parameters.Add(reserva_idParam)
                                    estado_reserva_id = datos.Tables("reserva").Rows(0)("estado_reserva_id") 'ExecuteScalar(cmd, sqlEstadoReserva, True)
                                    If Not IsDBNull(datos.Tables("reserva").Rows(0)("idioma_id")) Then
                                        online = True
                                    End If

                                End If
                                If res.huespedes.Length > 0 And estado_reserva_id = 1 And Not online Then 'si hay huespes y el estado es pendiente de entrar y no ha hecho checkin online..... cambio los Huespedes 
                                    If Not actualizaHuespedesReserva(cmd, resultado.reserva_id, res.huespedes) Then
                                        'resultado.reserva_id = 0
                                        errorCode = 4
                                        AgregaInfo("obtieneServiciosReserva", "Meta-huespedes: invalidos", -errorCode)
                                    End If
                                End If
                            End If

                        Else
                            errorCode = 6
                            errorTxt = "No graba Reserva"
                            AgregaInfo("obtieneServiciosReserva", "No graba reserva", -errorCode)
                        End If

                    Catch ex As Exception
                        errorCode = 5
                        errorTxt = ex.Message + " No se puede grabar Dataset Reserva"
                        AgregaInfo("obtieneServiciosReserva", "excepcion al grabaDatasetReserva:", -errorCode)
                    End Try

                End If
            Else
                errorCode = 1
            End If
            cmd.Parameters.Clear()
            Dim reserva_Param As New MySqlParameter("@reserva_id", resultado.reserva_id)
            cmd.Parameters.Add(reserva_Param)
            Dim estado_anterior = ExecuteScalar(cmd, sqlEstadoReserva)
            carga_valor_en_reserva(cmd, resultado.reserva_id, resultado)


            If Not flushConection(cmd, errorCode) Then
                '                resultado = Nothing
            End If

            'If errorCode = 0 Then  
            'si reserva es dingus...esta cancelada...y total es 0...se anula
            ' Ahora cancelo aunque no haya servicios caso de Thomson
            Dim skipValidar = False
            If (res.reserva_Dingus_tipo) Then
                If Not IsNothing(res.reserva_Dingus) Then
                    If res.reserva_Dingus.Status = Dingus.StatusBookingRS.Cancel Then
                        If res.reserva_Dingus.TotalPrice = 0 Or res.reserva_Dingus_tipo = 2 Then  ' cambio el estado a anulada si no hay gastos de cancelaciono tipo =2
                            CambiarEstadoReserva(old_reserva_id, 0, False)
                            CambiarEstadoReserva(old_reserva_id, 2, False)
                        End If
                        skipValidar = True
                    End If
                End If
            End If
            If Not skipValidar Then
                If estado_anterior = 0 And resultado.sumaErrores = 0 Then  ' si hay cambio de estado GARRA JAVIER ABRIL 2017
                    If Not CambiarEstadoReserva(resultado.reserva_id, 1, False, False, resultado) Then
                        errorCode = 7
                        errorTxt = "No se puedo cambiar a Estado Reserva Pendiente"
                        AgregaInfo("obtieneServiciosReserva", "No pudo cambiar estado", -errorCode)
                    End If
                End If
                If estado_anterior = 1 And resultado.sumaErrores > 0 Then  ' Si está pendiente de entrar con errores, paso la reserva a estado con errores JUKIO 2017
                    If Not Not CambiarEstadoReserva(resultado.reserva_id, 0, False, False, resultado) Then
                        errorCode = 7
                        errorTxt = "No se puedo cambiar a Estado Reserva Pendiente"
                        AgregaInfo("obtieneServiciosReserva", "No pudo cambiar estado", -errorCode)
                    End If
                End If

            End If
            'End If
            If errorCode <> 0 Then
                resultado.errortxt = errorTxt
                resultado.errornum = errorCode
            End If
            olddatosReservaActual = resultado
            Return resultado

        End Function
        Function obtieneServiciosReserva(ByVal cmd As MySqlCommand, ByVal res As MetaReserva, Optional ByVal crear As Boolean = False) As tablaServicios
            Dim errorCode As Integer = 0
            'Dim cmd As MysqlCommand = prepareConection()
            Dim resultado As tablaServicios
            resultado = New tablaServicios
            Dim datos As DataSet = Nothing
            Try
                'validar res
                If res.hotel_id > 0 Then
                    'cargar tabla equivalencias
                    Dim equivalencias As DataSet = getDataSet(cmd, sqlEquivalencias)
                    Dim unidades_calculos As DataSet = getDataSet(cmd, sqlUnidadesCalculos)
                    Dim servicios As DataSet = getDataSet(cmd, sqlServicios)
                    datos = preparaDatasetReserva(cmd, 0)
                    'cmd.Parameters.Clear()
                    'Dim reserva_idParam As New MysqlParameter("@reserva_id", 0)
                    'cmd.Parameters.Add(reserva_idParam)
                    'ExecuteNonQuery(cmd, "delete from reservas where reserva_id=?")
                    'Dim datos As DataSet = getDataSet(cmd, sqlCabReserva)
                    Dim row As DataRow
                    If Not IsNothing(res.habitacion) Then
                        res.habitacion_id = ObtieneHabitacion_Id(cmd, res.hotel_id, res.habitacion)
                        AgregaInfo("obtieneServiciosReserva", res.habitacion & "-" & res.habitacion_id, -errorCode)

                    End If
                    If Not IsNothing(res.habitacion_id) Then
                        row = datos.Tables("reservas_habitaciones").Rows.Add()
                        row.Item("habitacion_id") = res.habitacion_id
                        row.Item("tipo_bloqueo_id") = 1
                        row.Item("fecha_desde") = res.fecha_prevista_llegada
                        row.Item("fecha_hasta") = res.fecha_prevista_salida
                        row.Item("user_id") = userId
                        row.Item("fecha_modificacion") = Now
                    End If
                    row = datos.Tables("reserva").Rows.Add()

                    row.Item("reserva_id") = 0
                    row.Item("hotel_id") = res.hotel_id
                    row.Item("estado_reserva_id") = 1
                    If res.canal_reserva_id > 0 Then
                        row.Item("canal_reserva_id") = res.canal_reserva_id
                    End If
                    row.Item("cliente_id") = res.cliente_id
                    'row.Item("ttoo_id") = res.cliente_id
                    If res.cliente_id_factura <> 0 Then
                        row.Item("cliente_id_factura") = res.cliente_id_factura
                        'row.Item("ttoo_id") = res.cliente_id_factura
                    End If
                    row.Item("fecha_reserva") = res.fecha_reserva
                    row.Item("fecha_prevista_llegada") = res.fecha_prevista_llegada
                    row.Item("fecha_prevista_salida") = res.fecha_prevista_salida
                    'Try
                    '    row.Item("hora_prevista_llegada") = CDate(res.hora_prevista_llegada).TimeOfDay
                    'Catch ex As Exception

                    'End Try
                    'Try
                    '    row.Item("hora_prevista_salida") = CDate(res.hora_prevista_salida).TimeOfDay
                    'Catch ex As Exception

                    'End Try
                    Try
                        row.Item("observaciones_llegada") = res.observaciones
                    Catch ex As Exception

                    End Try

                    row.Item("bono_referencia") = res.bono_referencia
                    Try
                        row.Item("bono_online") = res.bono_online
                    Catch ex As Exception

                    End Try
                    row.Item("bloquear_tarifa") = res.bloquear_tarifa
                    row.Item("permite_devolucion") = res.permite_devolucion
                    row.Item("user_id") = userId
                    row.Item("fecha_modificacion") = Now

                    'Dim writer As MysqlDataAdapter
                    'writer = getDataAdapter(cmd, sqlCabReserva)
                    'writer.Fill(datos.Tables(0))
                    'writer.Update(datos.Tables(0))
                    Dim reserva_id As Integer = 0 'ExecuteScalar(cmd, "SELECT LAST_INSERT_ID()")
                    'mete lineas reserva
                    'reserva_idParam.Value = reserva_id
                    'cmd.Parameters.Clear()
                    'cmd.Parameters.Add(reserva_idParam)
                    'datos = getDataSet(cmd, sqlReservasServicios)
                    Dim x As Integer
                    'crea la habitacion
                    Dim contador As Integer = 0
                    Dim servs As New ArrayList()

                    Dim rows() As DataRow = equivalencias.Tables(0).Select("servicio_opcion_id=" & res.habitacion_servicio_id)
                    servs.Add(res.habitacion_servicio_id)
                    If rows.Length > 0 Then
                        For x = 0 To rows.Length - 1
                            servs.Add(rows(x).Item("servicio_id"))
                        Next
                    End If

                    If IsNothing(res.pension_servicio_id) OrElse res.pension_servicio_id = 0 Then
                        servs.Add(0)
                    Else
                        servs.Add(res.pension_servicio_id)
                        rows = equivalencias.Tables(0).Select("servicio_opcion_id=" & res.pension_servicio_id)
                        If rows.Length > 0 Then
                            For x = 0 To rows.Length - 1
                                servs.Add(rows(x).Item("servicio_id"))
                            Next
                        End If
                    End If

                    Dim y As Integer
                    For y = 0 To servs.Count - 1
                        Dim tipo = servicios.Tables(0).Compute("max(tipo_unidad_calculo_id)", "servicio_id=" & servs(y))
                        If IsDBNull(tipo) Then
                            tipo = 2
                        End If
                        If IsNothing(tipo) Then
                        Else
                            If tipo = 1 Then
                                If res.numero_habitaciones > 0 Then
                                    row = datos.Tables("reservas_servicios").Rows.Add()
                                    row.Item("servicio_reserva_id") = contador
                                    row.Item("reserva_id") = reserva_id

                                    row.Item("servicio_id") = servs(y)
                                    row.Item("unidad_calculo_id") = 1 ' servicio?
                                    row.Item("cantidad") = res.numero_habitaciones
                                    row.Item("flag_contrato") = 1
                                    contador += 1
                                End If
                            End If
                            If tipo = 2 Then
                                For x = 0 To res.unidades_calculos.Count - 1
                                    If res.unidades_calculos(x).cantidad > 0 Then
                                        Dim servicioAsignar As Integer = servs(y)
                                        Dim ucidAsignar As Integer = res.unidades_calculos(x).unidad_calculo_id
                                        Dim rowsuc() As DataRow = unidades_calculos.Tables(0).Select("unidad_calculo_id=" & res.unidades_calculos(x).unidad_calculo_id)
                                        Dim rowseq() As DataRow = equivalencias.Tables(0).Select("servicio_id=" & servicioAsignar)

                                        If rowsuc.Length > 0 And rowseq.Length = 0 Then
                                            If Not rowsuc(0).IsNull("servicio_id") Then
                                                'todo si uc es bebe y no es alojamiento
                                                'cambiar servicio por el asignado
                                                'y uc por SRV
                                                ucidAsignar = 1 'servicio
                                                servicioAsignar = rowsuc(0).Item("servicio_id")
                                            End If
                                        End If
                                        If servicioAsignar <> 0 Then
                                            row = datos.Tables("reservas_servicios").Rows.Add()
                                            row.Item("servicio_reserva_id") = contador
                                            row.Item("reserva_id") = reserva_id
                                            row.Item("servicio_id") = servicioAsignar
                                            row.Item("unidad_calculo_id") = ucidAsignar
                                            row.Item("cantidad") = res.unidades_calculos(x).cantidad
                                            row.Item("flag_contrato") = 1
                                            contador += 1
                                        End If
                                    End If
                                Next
                            End If
                        End If

                    Next

                    'writer = getDataAdapter(cmd, sqlReservasServicios)
                    'writer.Fill(datos.Tables(0))
                    'writer.Update(datos.Tables(0))

                    resultado = obtieneServiciosReserva(cmd, datos, Nothing, Nothing)

                        'todo por cada oferta manual crear combinaciones
                        'y almacenarlas en distintas versiones por columna combinacion
                        If IsNothing(resultado) Then
                            errorCode = 2
                            AgregaInfo("obtieneServiciosReserva", "No se puede calcular los servicios de la meta-reserva:", -errorCode)
                        End If
                    Else
                        errorCode = 1
                    AgregaInfo("obtieneServiciosReserva", "Meta-reserva: invalida", -errorCode)
                End If
            Catch ex As Exception
                errorCode = 3
                AgregaInfo("obtieneServiciosReserva", ex.Message, -errorCode)
                resultado = New tablaServicios
            End Try
            If Not IsNothing(resultado) Then
                'dumpResultado(resultado)

                If Not crear Or resultado.sumaErrores() > 0 Or resultado.servicios.Rows.Count = 0 Or IsNothing(datos) Then
                    'existen errores..o no hay datos...o simplemente es un preview
                    errorCode = 1
                Else
                    Try
                        Dim resobject As Object = grabaDatasetReserva(cmd, datos, 0)
                        If Not IsNothing(resobject) Then
                            resultado.reserva_id = resobject
                            'asignarle los huespedes a la reserva
                            If Not IsNothing(res.huespedes) Then
                                If res.huespedes.Length > 0 Then
                                    If Not actualizaHuespedesReserva(cmd, resultado.reserva_id, res.huespedes) Then
                                        errorCode = 4
                                        AgregaInfo("obtieneServiciosReserva", "Meta-huespedes: invalidos", -errorCode)
                                    End If
                                End If
                            End If
                        Else
                            errorCode = 6
                            AgregaInfo("obtieneServiciosReserva", "no graba datos res:", -errorCode)
                        End If
                    Catch ex As Exception
                        errorCode = 5
                        AgregaInfo("obtieneServiciosReserva", "excepcion al grabaDatasetReserva:", -errorCode)
                    End Try

                End If
            Else
                errorCode = 1
            End If


            'If Not flushConection(cmd, errorCode) Then
            '                resultado = Nothing
            'End If

            If errorCode <> 0 Then
                Return Nothing
            Else
                ' Garra made in Javier Junio 2017
                olddatosReservaActual = resultado
                ' Fin de Garra
                Return resultado
            End If

        End Function
        Function obtieneServiciosReserva(ByVal reserva_id As Integer) As tablaServicios
            Return obtieneServiciosReserva(reserva_id, Nothing, Nothing)
        End Function
        Private Function obtieneServiciosReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As tablaServicios
            Return obtieneServiciosReserva(cmd, reserva_id, Nothing, Nothing)
        End Function
        Shared sqlTablaReservasOld = "" _
        & " Select * from reservas_servicios" _
        & " where reserva_id=?"

        Function obtieneServiciosReserva(ByVal reserva_id As Integer, ByVal fecha_ini As Object, ByVal fecha_fin As Object) As tablaServicios
            'Dim dt As Date = Now
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado As tablaServicios = Nothing
            Try
                resultado = obtieneServiciosReserva(cmd, reserva_id, fecha_ini, fecha_fin)
                If IsNothing(resultado) Then
                    errorCode = 1
                    AgregaInfo("obtieneServiciosReserva", "No se puede calcular los servicios de la reserva:" & reserva_id, -errorCode)
                End If
            Catch ex As Exception
                errorCode = 2
                AgregaInfo("obtieneServiciosReserva", ex.Message, -errorCode)
            End Try
            'Console.Write((Now - dt))
            'Console.WriteLine("-")
            If Not flushConection(cmd, errorCode) Then
                resultado = Nothing
            End If
            'Console.Write((Now - dt))
            'Console.WriteLine("-")
            Return resultado
        End Function
        Shared sqlUCReservasOld = "" _
    & "    SELECT " _
    & " reservas_servicios.unidad_calculo_id, " _
    & " Max(reservas_servicios.cantidad) as cantidad " _
    & " FROM " _
    & " reservas_servicios " _
    & " WHERE " _
    & " reservas_servicios.reserva_id =  ? " _
    & " GROUP BY " _
    & " reservas_servicios.unidad_calculo_id "
        Shared sqlUCReservas = "" _
    & " select unidad_calculo_id_padre as unidad_calculo_id,sum(cantidad) as cantidad from" _
    & " (SELECT " _
    & " unidades_calculo_detalladas.unidad_calculo_id_padre, " _
    & " unidades_calculo_detalladas.unidad_calculo_id_hijo, " _
    & " Max(Coalesce(reservas_servicios.cantidad,0)) as cantidad " _
    & " FROM (" _
    & "     SELECT " _
    & " unidades_calculo.unidad_calculo_id AS unidad_calculo_id_padre, " _
    & " Coalesce(unidades_calculo_agrupados.unidad_calculo_hijo_id,unidades_calculo.unidad_calculo_id) AS unidad_calculo_id_hijo " _
    & " FROM " _
    & " unidades_calculo " _
    & " Left Join unidades_calculo_agrupados ON unidades_calculo.unidad_calculo_id = unidades_calculo_agrupados.unidad_calculo_padre_id " _
    & " ) unidades_calculo_detalladas " _
    & " Left Join reservas_servicios ON unidades_calculo_detalladas.unidad_calculo_id_hijo = reservas_servicios.unidad_calculo_id " _
    & " WHERE " _
    & " reservas_servicios.reserva_id = ? or " _
    & " reservas_servicios.reserva_id IS NULL " _
    & " GROUP BY " _
    & " unidades_calculo_detalladas.unidad_calculo_id_padre, " _
    & " unidades_calculo_detalladas.unidad_calculo_id_hijo " _
    & " ) drv group by unidad_calculo_id_padre "
        Shared sqlUnidadesCalculoDetalladas = "" _
    & "SELECT " _
    & " unidades_calculo.unidad_calculo_id AS unidad_calculo_id_padre, " _
    & " Coalesce(unidades_calculo_agrupados.unidad_calculo_hijo_id,unidades_calculo.unidad_calculo_id) AS unidad_calculo_id_hijo " _
    & " FROM " _
    & " unidades_calculo " _
    & " Left Join unidades_calculo_agrupados ON unidades_calculo.unidad_calculo_id = unidades_calculo_agrupados.unidad_calculo_padre_id "
        Shared sqlResultadoUC = "select 1 as unidad_calculo_id,0.0 as cantidad from hoteles where 1=0"
        Private Function obtieneUCSReserva(ByVal cmd As MySqlCommand, ByVal ds As DataSet) As DataSet
            cmd.Parameters.Clear()
            Dim datos As DataTableReader = getDataTable(cmd, sqlUnidadesCalculoDetalladas, True)
            Dim destino As DataSet = getDataSet(cmd, sqlResultadoUC, True)
            Dim destable As DataTable = destino.Tables(0)
            'Dim destable As DataTable = Me.readerToTable(getDataTable(cmd, sqlResultadoUC, True))
            Dim origen As DataTable = ds.Tables("reservas_servicios")
            Dim cant As Object
            Dim rows() As DataRow
            Dim row As DataRow
            While datos.Read
                cant = origen.Compute("max (cantidad)", "unidad_calculo_id=" & datos.Item("unidad_calculo_id_hijo"))
                If IsDBNull(cant) Then
                    cant = 0
                End If
                rows = destable.Select("unidad_calculo_id=" & datos.Item("unidad_calculo_id_padre"))
                If rows.Length > 0 Then
                    row = rows(0)
                Else
                    row = destable.Rows.Add()
                End If
                row.Item("unidad_calculo_id") = datos.Item("unidad_calculo_id_padre")
                If row.IsNull("cantidad") Then
                    row.Item("cantidad") = cant
                Else
                    row.Item("cantidad") += cant
                End If
            End While
            Return destino
        End Function
        Private Function obtieneUCSReserva(ByVal cmd As MySqlCommand, ByVal reserva As Integer) As DataSet
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva)
            cmd.Parameters.Add(reserva_idParam)
            Return getDataSet(cmd, sqlUCReservas)
        End Function
        Shared sqlUCHijas = "" _
    & "SELECT " _
    & " unidades_calculo.unidad_calculo_id AS unidad_calculo_id_padre, " _
    & " Coalesce(unidades_calculo_agrupados.unidad_calculo_hijo_id,unidades_calculo.unidad_calculo_id) AS unidad_calculo_id_hijo " _
    & " FROM " _
    & " unidades_calculo " _
    & " Left Join unidades_calculo_agrupados ON unidades_calculo.unidad_calculo_id = unidades_calculo_agrupados.unidad_calculo_padre_id "
        'Private cachedUCHijas As DataSet
        Private Function obtieneUCHijas(ByVal cmd As MySqlCommand) As DataSet
            Return getDataSet(cmd, sqlUCHijas, True)
        End Function
        Private Function obtieneUCHijas(ByVal cmd As MySqlCommand, ByVal ucidPadre As Integer) As ArrayList
            Dim dr As DataRow() = obtieneUCHijas(cmd).Tables(0).Select("unidad_calculo_id_padre=" & ucidPadre)
            Dim ar As New ArrayList()
            Dim x As DataRow
            For Each x In dr
                ar.Add(x.Item("unidad_calculo_id_hijo"))
            Next
            Return ar
        End Function
        Private Function perteneceUC(ByVal ucds As DataSet, ByVal ucidPadre As Integer, ByVal ucidHijo As Integer) As Boolean
            Return ((ucds.Tables(0).Compute("count(unidad_calculo_id_padre)", "unidad_calculo_id_padre=" & ucidPadre & " and unidad_calculo_id_hijo=" & ucidHijo)) > 0)
            'Dim num As Integer = 
            'If num > 0 Then
            'Return True
            'Else
            'Return False
            'End If
        End Function
        Shared sqlCondiciones = "select * from condiciones_linea_contrato where linea_contrato_id=?"
        Shared sqlCondicionesContratos = "select condiciones_linea_contrato.* from lineas_de_contrato inner join condiciones_linea_contrato on lineas_de_contrato.linea_contrato_id=condiciones_linea_contrato.linea_contrato_id where lineas_de_contrato.contrato_id=?"
        Shared sqlCondicionesOfertas = "select * from condiciones_ofertas where oferta_id=?"
        Shared sqlCondicionesOfertasContratos = "select condiciones_ofertas.* from ofertas inner join condiciones_ofertas on ofertas.oferta_id=condiciones_ofertas.oferta_id where ofertas.contrato_id in (?)"
        Private Function cumpleCondicionesOfertas(ByVal cmd As MySqlCommand, ByVal oferta_id As Integer, ByVal ucsTable As DataSet)
            Return cumpleCondiciones(cmd, sqlCondicionesOfertas, oferta_id, ucsTable)
        End Function
        'Private Function cumpleCondicionesLineaContrato(ByVal cmd As MysqlCommand, ByVal linea_contrato_id As Integer, ByVal ucsTable As DataSet)
        '    Return cumpleCondiciones(cmd, sqlCondiciones, linea_contrato_id, ucsTable)
        'End Function
        Private Function cumpleCondiciones(ByVal cond As DataTableReader, ByVal ucsTable As DataSet)
            If IsNothing(ucsTable) Then
                Return True
            End If
            Dim ucs As DataTable = ucsTable.Tables(0)
            Dim cumple As Boolean = True
            While cumple And cond.Read
                Dim uc = cond.Item("unidad_calculo_id")
                Dim rows As DataRow() = ucs.Select("unidad_calculo_id=" & uc)
                Dim cant = Nothing
                If rows.Length > 0 Then
                    cant = rows(0).Item("cantidad")
                Else
                    cumple = False
                End If
                If Not IsNothing(cant) Then
                    Dim ocant = cond.Item("cantidad")
                    Select Case cond.Item("tipo_condicion_id")
                        Case 1 '1	=
                            If Not (cant = ocant) Then
                                cumple = False
                            End If
                        Case 2 '2	>
                            If Not (cant > ocant) Then
                                cumple = False
                            End If
                        Case 3 '3	>=
                            If Not (cant >= ocant) Then
                                cumple = False
                            End If
                        Case 4 '4	<
                            If Not (cant < ocant) Then
                                cumple = False
                            End If
                        Case 5 '5	<=
                            If Not (cant <= ocant) Then
                                cumple = False
                            End If
                    End Select
                End If
            End While
            Return cumple
        End Function

        Private Function cumpleCondiciones(ByVal cmd As MySqlCommand, ByVal query As String, ByVal id As Integer, ByVal ucsTable As DataSet)
            If IsNothing(ucsTable) Then
                Return True
            End If
            cmd.Parameters.Clear()
            Dim idParam As New MySqlParameter("@id", id)
            cmd.Parameters.Add(idParam)
            Dim cond As DataTableReader = getDataTable(cmd, query, True)
            Return cumpleCondiciones(cond, ucsTable)
        End Function

        Shared sqlTablaReservas = "" _
    & "     SELECT 0.0 as precio_servicio," _
    & " reservas_servicios.flag_contrato,reservas_servicios.servicio_reserva_id," _
    & " reservas_servicios.reserva_id," _
    & " reservas_servicios.servicio_id," _
    & " reservas_servicios.unidad_calculo_id," _
    & " Coalesce(reservas_servicios.fecha_desde,reservas.fecha_prevista_llegada) as fecha_desde," _
    & " Coalesce(reservas_servicios.fecha_hasta,reservas.fecha_prevista_salida) as fecha_hasta," _
    & " reservas_servicios.cantidad," _
    & " servicios_hotel.impuesto_id," _
    & " impuestos.porcentaje," _
    & " reservas.hotel_id,reservas.estado_reserva_id,reservas.bloquear_tarifa," _
    & " reservas.cliente_id, " _
    & " datediff(Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida),Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada)) as dias_estancia, " _
    & " datediff(Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada),Coalesce(fecha_reserva,'01/01/2001')) as dias_antelacion, " _
    & " reservas.fecha_reserva," _
    & " reservas.fecha_llegada," _
    & " reservas.fecha_salida," _
    & " reservas.fecha_prevista_llegada," _
    & " reservas.fecha_prevista_salida,unidades_calculo.tipo_unidad_calculo_id,servicios.abreviatura,servicios.tipo_servicio_id,unidades_calculo.UC,servicios.concepto_acelerador_reservas_id" _
    & " FROM" _
    & " reservas_servicios" _
    & " Inner Join reservas ON reservas_servicios.reserva_id = reservas.reserva_id" _
    & " Inner Join servicios_hotel ON reservas.hotel_id = servicios_hotel.hotel_id AND reservas_servicios.servicio_id = servicios_hotel.servicio_id" _
    & " Inner Join impuestos ON servicios_hotel.impuesto_id = impuestos.impuesto_id" _
    & " Inner Join servicios ON servicios_hotel.servicio_id = servicios.servicio_id" _
    & " Inner Join unidades_calculo ON reservas_servicios.unidad_calculo_id = unidades_calculo.unidad_calculo_id" _
    & " WHERE" _
    & " reservas.reserva_id in (?)"
        Shared sqlObtieneReservasContratos = "select * from reservas_contratos where reserva_id=?"
        'Dim sqlBorrarReservasContratos = "delete from reservas_contratos where reserva_id=?"
        'Dim sqlInsertaReservaContrato = "insert into reservas_contratos(reserva_id,contrato_id) values(?,?)"
        '& " reservas_servicios.contrato_id," _
        Private Function preProcesaServiciosOldOLd(ByVal reader As DataTableReader) As DataTableReader
            'todo agrupar por fecha/servicio/uc
            'si dos servicios tienen misma fecha,servicio/uc..sumar cantidades
            'y borrar excendentes

            Dim resultado As New ArrayList  'lista donde se marcan los ya procesados
            Dim tmpTable As New DataTable
            tmpTable.Load(reader)
            tmpTable.Columns.Item("fecha_desde").ReadOnly = False
            tmpTable.Columns.Item("fecha_hasta").ReadOnly = False
            reader = tmpTable.CreateDataReader()
            'Console.WriteLine(tmpTable.Rows.Count)
            Dim id_fecha_desde As Integer = reader.GetOrdinal("fecha_desde")
            Dim id_fecha_hasta As Integer = reader.GetOrdinal("fecha_hasta")
            Dim id_cantidad As Integer = reader.GetOrdinal("cantidad")
            While reader.Read
                Dim key As String = "servicio_id=" & reader.Item("servicio_id") & " and unidad_calculo_id=" & reader.Item("unidad_calculo_id")
                If Not resultado.Contains(key) Then
                    resultado.Add(key)
                    Dim rescan As Boolean = True
                    While rescan = True
                        rescan = False
                        'tmpTable.AcceptChanges()
                        Dim subTable() As DataRow = tmpTable.Select(key, "fecha_desde asc,fecha_hasta asc")
                        If subTable.Length > 1 Then
                            'agrupar
                            Dim x As Integer
                            'For x = 0 To subTable.Length - 1
                            '    Console.WriteLine(subTable(x).Item("fecha_desde") & " -" & subTable(x).Item("fecha_hasta") & "-" & subTable(x).Item("cantidad"))
                            'Next
                            'Console.WriteLine("****")
                            For x = 0 To subTable.Length - 1 And rescan = False
                                Dim y As Integer
                                For y = x + 1 To subTable.Length - 1 And rescan = False
                                    If subTable(x).Item(id_fecha_desde) = subTable(y).Item(id_fecha_desde) And subTable(x).Item("fecha_hasta") = subTable(y).Item(id_fecha_hasta) Then
                                        'sus fechas coinciden..se suman y se borra la ultima linea
                                        subTable(x).Item(id_cantidad) += subTable(y).Item(id_cantidad)
                                        subTable(y).Delete()
                                        rescan = True
                                    Else
                                        'caso 2
                                        'fecha desde,hasta dentro del primero
                                        If subTable(y).Item(id_fecha_desde) >= subTable(x).Item(id_fecha_desde) And subTable(y).Item(id_fecha_desde) < subTable(x).Item(id_fecha_hasta) Then 'And subTable(y).Item("fecha_hasta") >= subTable(x).Item("fecha_desde") And subTable(y).Item("fecha_hasta") <= subTable(x).Item("fecha_hasta") Then
                                            'If subTable(y).Item("fecha_desde") >= subTable(x).Item("fecha_desde") And subTable(y).Item("fecha_hasta") <= subTable(x).Item("fecha_hasta") Then
                                            Dim dostage As Boolean = True
                                            If Not (subTable(y).Item(id_fecha_hasta) = subTable(x).Item(id_fecha_hasta) Or subTable(y).Item(id_fecha_desde) = subTable(x).Item(id_fecha_desde)) Then

                                                If subTable(y).Item(id_fecha_hasta) < subTable(x).Item(id_fecha_hasta) Then
                                                    Dim row As DataRow = tmpTable.Rows.Add(subTable(x).ItemArray)
                                                    row.Item(id_fecha_desde) = subTable(y).Item(id_fecha_hasta)
                                                    row.Item(id_fecha_hasta) = subTable(x).Item(id_fecha_hasta)
                                                Else
                                                    Dim row As DataRow = tmpTable.Rows.Add(subTable(y).ItemArray)
                                                    row.Item(id_fecha_hasta) = subTable(y).Item(id_fecha_hasta)
                                                    row.Item(id_fecha_desde) = subTable(x).Item(id_fecha_hasta)
                                                    subTable(x).Item(id_fecha_hasta) = subTable(y).Item(id_fecha_desde)
                                                    subTable(y).Item(id_fecha_hasta) = row.Item(id_fecha_desde)
                                                    subTable(y).Item(id_cantidad) += subTable(x).Item(id_cantidad)
                                                    dostage = False
                                                End If

                                            End If
                                            If dostage Then
                                                If subTable(y).Item(id_fecha_desde) = subTable(x).Item(id_fecha_desde) Then
                                                    subTable(x).Item(id_cantidad) += subTable(y).Item(id_cantidad)
                                                    subTable(y).Item(id_fecha_desde) = subTable(x).Item(id_fecha_hasta) '.AddDays(1)
                                                Else
                                                    subTable(y).Item(id_cantidad) += subTable(x).Item(id_cantidad)
                                                    subTable(x).Item(id_fecha_hasta) = subTable(y).Item(id_fecha_desde)
                                                End If
                                            End If
                                            'subTable(x).Item("fecha_hasta") = subTable(y).Item("fecha_desde")
                                            rescan = True
                                            'fecha hasta 1=fecha desde 2
                                            'fecha desde 3=fecha hasta 2
                                            'fecha hasta 3=fecha hasta 1
                                        Else
                                            'caso 3
                                            'fecha desde dentro del primero
                                            'fecha hasta 1=fecha desde 2
                                            'fecha hasta 2=fecha hasta 1
                                            'fecha desde 3=fecha hasta 1
                                            'fecha hasta 3=fecha hasta 2

                                            'caso 4
                                            'fechas no colisioanan
                                        End If

                                    End If
                                Next
                            Next
                            'Console.WriteLine(subTable(0).Item("fecha_desde"))
                        End If
                    End While
                End If
            End While
            'tmpTable()
            'Console.WriteLine(tmpTable.Rows.Count)
            tmpTable.AcceptChanges()
            'reader = tmpTable.CreateDataReader()
            'While reader.Read
            'Console.WriteLine(reader.Item("servicio_id") & "-" & reader.Item("fecha_desde") & " - " & reader.Item("fecha_hasta") & "-" & reader.Item("cantidad"))
            'End While
            'Console.WriteLine(tmpTable.Rows.Count)
            reader = tmpTable.CreateDataReader()
            Return reader
        End Function
        Private Function preProcesaServicios(ByVal reader As DataTableReader) As DataTableReader
            Dim tmpTable As New DataTable
            tmpTable.Load(reader)
            Return preProcesaServicios(tmpTable)
        End Function
        Private Function preProcesaServiciosOld(ByVal reader As DataTableReader) As DataTableReader
            'todo agrupar por fecha/servicio/uc
            'si dos servicios tienen misma fecha,servicio/uc..sumar cantidades
            'y borrar excendentes
            Dim values(reader.FieldCount - 1) As Object

            Dim resultado As New ArrayList  'lista donde se marcan los ya procesados
            Dim tmpTable As New DataTable
            'tmpTable.Rows.Add(reader.Item.
            tmpTable.Load(reader)
            'ordena por id iria mas rapido?
            'tmpTable = New DataView(tmpTable, "", "reserva_id", DataViewRowState.CurrentRows).ToTable
            tmpTable.Columns.Item("fecha_desde").ReadOnly = False
            tmpTable.Columns.Item("fecha_hasta").ReadOnly = False
            reader = tmpTable.CreateDataReader()
            Dim tmpTable1 As DataTable = tmpTable.Clone

            'Console.WriteLine(tmpTable.Rows.Count)
            Dim id_fecha_desde As Integer = reader.GetOrdinal("fecha_desde")
            Dim id_fecha_hasta As Integer = reader.GetOrdinal("fecha_hasta")
            Dim id_cantidad As Integer = reader.GetOrdinal("cantidad")
            Dim key As String
            Dim fmax As Date
            Dim fmin As Date
            Dim fstart As Date
            Dim canto
            Dim cantidad As Object
            Dim ncantidad As Object
            Dim filtro As String
            Dim row As DataRow
            While reader.Read

                key = "flag_contrato=" & reader.Item("flag_contrato") & " and reserva_id=" & reader.Item("reserva_id") & " and servicio_id=" & reader.Item("servicio_id") & " and unidad_calculo_id=" & reader.Item("unidad_calculo_id")
                If Not resultado.Contains(key) Then
                    resultado.Add(key)
                    'obtiene fecha mayor


                    fmax = tmpTable.Compute("max(fecha_hasta)", key)
                    'obtiene fecha menor
                    fmin = tmpTable.Compute("min(fecha_desde)", key)
                    fstart = fmin
                    cantidad = Nothing
                    ncantidad = Nothing
                    'optimizar...si solo hay un tramo pa ke koño recorrerme todos...
                    'en realidad...obtener cada tramo y generar los x tramos fmin,fmax
                    If tmpTable.Select(key).Length = 1 Then
                        fmin = fmax
                        filtro = key & " and '" & fmin & "' >=fecha_desde and '" & fmin & "' <=fecha_hasta"
                        cantidad = tmpTable.Compute("sum(cantidad)", filtro)
                        If IsDBNull(cantidad) Then
                            cantidad = 0
                        End If
                    End If

                    While fmin <= fmax
                        filtro = key & " and '" & fmin & "' >=fecha_desde and '" & fmin & "' <=fecha_hasta"
                        canto = tmpTable.Compute("sum(cantidad)", filtro)
                        If IsDBNull(canto) Then
                            ncantidad = 0
                        Else
                            ncantidad = canto
                        End If

                        If IsNothing(cantidad) Then
                            cantidad = ncantidad
                            fstart = fmin
                        Else
                            If cantidad <> ncantidad Then
                                'crear registro con grupo de cantidades
                                If cantidad = 0 Then
                                Else
                                    reader.GetValues(values)
                                    row = tmpTable1.Rows.Add(values)
                                    row.Item("cantidad") = cantidad
                                    row.Item("fecha_desde") = fstart
                                    row.Item("fecha_hasta") = fmin
                                End If
                                fstart = fmin
                                cantidad = ncantidad
                            End If
                        End If
                        fmin = fmin.AddDays(1)
                    End While
                    If cantidad = 0 Then
                    Else
                        reader.GetValues(values)
                        row = tmpTable1.Rows.Add(values)
                        row.Item("cantidad") = cantidad
                        row.Item("fecha_desde") = fstart
                        row.Item("fecha_hasta") = fmin.AddDays(-1)
                    End If
                End If
            End While
            tmpTable1.AcceptChanges()
            reader = tmpTable1.CreateDataReader()
            Return reader
        End Function
        Private Function preProcesaServicios(ByVal tmpTable As DataTable) As DataTableReader
            'todo agrupar por fecha/servicio/uc
            'si dos servicios tienen misma fecha,servicio/uc..sumar cantidades
            'y borrar excendentes

            Dim values(tmpTable.Columns.Count - 1) As Object

            Dim resultado As New ArrayList  'lista donde se marcan los ya procesados
            'Dim tmpTable As New DataTable
            Dim reader As DataTableReader
            'tmpTable.Rows.Add(reader.Item.
            'tmpTable.Load(reader)
            'ordena por id iria mas rapido?
            'tmpTable = New DataView(tmpTable, "", "reserva_id", DataViewRowState.CurrentRows).ToTable
            tmpTable.Columns.Item("fecha_desde").ReadOnly = False
            tmpTable.Columns.Item("fecha_hasta").ReadOnly = False
            reader = tmpTable.CreateDataReader()
            Dim tmpTable1 As DataTable = tmpTable.Clone

            'Console.WriteLine(tmpTable.Rows.Count)
            Dim id_fecha_desde As Integer = reader.GetOrdinal("fecha_desde")
            Dim id_fecha_hasta As Integer = reader.GetOrdinal("fecha_hasta")
            Dim id_cantidad As Integer = reader.GetOrdinal("cantidad")
            Dim key As String
            Dim fmax As Date
            Dim fmin As Date
            Dim fstart As Date
            Dim canto
            Dim cantidad As Object
            Dim ncantidad As Object
            Dim filtro As String
            Dim row As DataRow
            While reader.Read

                key = "flag_contrato=" & reader.Item("flag_contrato") & " and reserva_id=" & reader.Item("reserva_id") & " and servicio_id=" & reader.Item("servicio_id") & " and unidad_calculo_id=" & reader.Item("unidad_calculo_id")
                If Not resultado.Contains(key) Then
                    resultado.Add(key)
                    'obtiene fecha mayor
                    'Dim dv As DataTable = (New DataView(tmpTable, key, "", DataViewRowState.CurrentRows)).ToTable

                    cantidad = Nothing
                    ncantidad = Nothing
                    'optimizar...si solo hay un tramo pa ke koño recorrerme todos...
                    'en realidad...obtener cada tramo y generar los x tramos fmin,fmax
                    Dim rows() As DataRow = tmpTable.Select(key)
                    Dim z As Integer = rows.Length
                    If z = 1 Then
                        fmax = rows(0)("fecha_hasta")
                        fstart = rows(0)("fecha_desde")
                        'fmin = fmax
                        'filtro = key & " and '" & fmin & "' >=fecha_desde and '" & fmin & "' <=fecha_hasta"
                        'cantidad = tmpTable.Compute("sum(cantidad)", filtro)
                        cantidad = rows(0)("cantidad")
                        fmin = fmax.AddDays(1)
                        If IsDBNull(cantidad) Then
                            cantidad = 0
                        End If
                    Else
                        'Console.WriteLine(rows.Length)
                        Dim x As Integer
                        fmax = New Date(1900, 1, 1)
                        fmin = New Date(2900, 1, 1)
                        For x = 0 To z - 1
                            If rows(x)("fecha_hasta") > fmax Then
                                fmax = rows(x)("fecha_hasta")
                            End If
                            If rows(x)("fecha_desde") < fmin Then
                                fmin = rows(x)("fecha_desde")
                            End If
                        Next

                        'fmax = tmpTable.Compute("max(fecha_hasta)", key)
                        'obtiene fecha menor
                        'fmin = tmpTable.Compute("min(fecha_desde)", key)
                        fstart = fmin
                    End If

                    While fmin <= fmax
                        filtro = key & " and '" & fmin & "' >=fecha_desde and '" & fmin & "' <=fecha_hasta"
                        canto = tmpTable.Compute("sum(cantidad)", filtro)
                        If IsDBNull(canto) Then
                            ncantidad = 0
                        Else
                            ncantidad = canto
                        End If

                        If IsNothing(cantidad) Then
                            cantidad = ncantidad
                            fstart = fmin
                        Else
                            If cantidad <> ncantidad Then
                                'crear registro con grupo de cantidades
                                If cantidad = 0 Then
                                Else
                                    reader.GetValues(values)
                                    row = tmpTable1.Rows.Add(values)
                                    row.Item("cantidad") = cantidad
                                    row.Item("fecha_desde") = fstart
                                    row.Item("fecha_hasta") = fmin
                                End If
                                fstart = fmin
                                cantidad = ncantidad
                            End If
                        End If
                        fmin = fmin.AddDays(1)
                    End While
                    If cantidad = 0 Then
                    Else
                        reader.GetValues(values)
                        row = tmpTable1.Rows.Add(values)
                        row.Item("cantidad") = cantidad
                        row.Item("fecha_desde") = fstart
                        row.Item("fecha_hasta") = fmin.AddDays(-1)
                    End If
                End If
            End While
            tmpTable1.AcceptChanges()
            reader = tmpTable1.CreateDataReader()
            Return reader
        End Function

        Private Function preparaDatasetReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, Optional ByVal reserva_dingus As Dingus.BookingRS = Nothing, Optional ByVal resdingustipo As Integer = 0, Optional ByVal impuestos_incluidos As Integer = 1, Optional ByVal comision As Decimal = 0, Optional ByRef totalreserva As Decimal = Nothing) As DataSet
            Dim ds As New DataSet
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Add(reserva_idParam)

            getDataSet(cmd, sqlCabReserva, ds, "reserva")
            getDataSet(cmd, sqlReservasHabitaciones, ds, "reservas_habitaciones")
            If IsNothing(reserva_dingus) And ds.Tables("reserva").Rows.Count > 0 Then
                If Not ds.Tables("reserva").Rows(0).IsNull("reserva_dingus") Then
                    'deserializar
                    Dim serializer As New XmlSerializer(GetType(Dingus.BookingRS))
                    Dim datos As String = ds.Tables("reserva").Rows(0)("reserva_dingus")
                    Dim stream As System.IO.MemoryStream = New System.IO.MemoryStream(System.Text.Encoding.UTF8.GetBytes(datos))
                    reserva_dingus = serializer.Deserialize(stream)
                    resdingustipo = ds.Tables("reserva").Rows(0)("reserva_dingus_tipo")
                    comision = ds.Tables("reserva").Rows(0)("dingus_comision")
                    impuestos_incluidos = ds.Tables("reserva").Rows(0)("dingus_impuestos_incluidos")
                End If
            End If

            getDataSet(cmd, sqlReservasServicios, ds, "reservas_servicios")
            getDataSet(cmd, sqlObtieneReservasContratos, ds, "reservas_contratos")
            getDataSet(cmd, sqlReservasOfertas, ds, "reservas_ofertas")
            Dim clone As DataTable = ds.Tables("reservas_ofertas").Copy()
            clone.TableName = "reservas_ofertas_subclone"
            clone.AcceptChanges()
            ds.Tables.Add(clone)
            getDataSet(cmd, sqlReservasDescuentos, ds, "reservas_descuentos")
            ' Clonamos la tabla para ver si ha habido modificaciones o no y evitar accesos a la BD innecesarios
            Dim clone1 As DataTable = ds.Tables("reservas_descuentos").Copy()
            clone1.TableName = "reservas_descuentos_subclone"
            clone1.AcceptChanges()
            ds.Tables.Add(clone1)
            If Not IsNothing(reserva_dingus) And (resdingustipo = 1) Then 'ojo kitar ese or..o la kagamos

                'Si entra aquí es que la reserva es de precios dingus y no del contrato de Geshotel

                'And ds.Tables("reserva").Rows.Count > 0 Then
                'If ds.Tables("reserva").Rows(0)("reserva_dingus_tipo") = 1 Then
                Dim tot As Decimal = CreaLineasPreciosDingus(cmd, ds, reserva_dingus, impuestos_incluidos, comision)
                If Not IsNothing(totalreserva) Then
                    totalreserva = tot
                End If
                'todo si no tiene precio validado se mete
                'totalreserva = sumarPreciosDingus(reserva_dingus.ContractPriceDetails)

                'End If
            End If
            Return ds
        End Function
        Private Function grabaDatasetReserva(ByVal cmd As MySqlCommand, ByVal ds As DataSet, Optional ByVal reserva_id As Integer = 0) As Object
            'actualizar todas las tablas y cambiar reserva_id por la nueva si la hubiese
            Try
                If Not IsNothing(ds.Tables("reservas_descuentos_subclone")) And Not IsNothing(ds.Tables("reservas_descuentos").GetChanges) Then
                    'comparar con su clone
                    Dim dtori As DataTable = ds.Tables("reservas_descuentos_subclone") ' La original
                    Dim dtdes As DataTable = ds.Tables("reservas_descuentos") ' Despues de pasar por la rutina crea_descuento_en_reserva

                    Dim iguales As Boolean = True      ' Inicialmente las datatables las considero iguales
                    If IsNothing(dtori) Then ' Si originariamente no había nada entonces no son iguales
                        iguales = False
                    End If
                    'comprobar fila a fila
                    Dim n_rows_ori As Integer = dtori.Rows.Count - 1
                    Dim n_rows_des As Integer = dtdes.Rows.Count - 1
                    Dim max_rows As Integer = n_rows_ori
                    If n_rows_des > n_rows_ori Then
                        max_rows = n_rows_des
                    End If
                    Dim posicion_ori As Integer = 0
                    Dim posicion_des As Integer = 0
                    Dim aquitar As Boolean = False

                    While iguales And posicion_ori <= n_rows_ori And posicion_des <= n_rows_des
                        If dtdes.Rows(posicion_des).RowState = DataRowState.Deleted Then ' Primero hay que quitar de la comparación los posibles descuentos borrados de la destino. La original no tiene borradas
                            posicion_des += 1
                        Else
                            ' Comparamos la fila de la origen con la de destino
                            If dtori.Rows(posicion_ori)("servicio_id") = dtdes.Rows(posicion_des)("servicio_id") And dtori.Rows(posicion_ori)("tipo_descuento_id") = dtdes.Rows(posicion_des)("tipo_descuento_id") And dtori.Rows(posicion_ori)("descuento") = dtdes.Rows(posicion_des)("descuento") Then
                                ' Si son iguales entonces sumamos 1 a la posicion de dtori y de dtdes
                                posicion_ori += 1
                                posicion_des += 1

                            Else
                                iguales = False
                            End If
                        End If
                    End While
                    If iguales And posicion_ori = n_rows_ori And posicion_des = n_rows_des Then 'No hace falta grabar reservas_descuentos porque son iguales
                        ds.Tables.Remove(dtdes)
                        dtori.TableName = "Reservas_descuentos"
                    End If

                End If
                If Not IsNothing(ds.Tables("reservas_ofertas_subclone")) And Not IsNothing(ds.Tables("reservas_ofertas").GetChanges) Then
                    'comparar con su clone


                    Dim dtori As DataTable = ds.Tables("reservas_ofertas")
                    Dim dtdes As DataTable = ds.Tables("reservas_ofertas_subclone")
                    If dtori.Rows.Count = dtdes.Rows.Count Then
                        'comprobar fila a fila
                        Dim x As Integer
                        Dim z As Integer = dtori.Rows.Count - 1
                        Dim aquitar As Boolean = False
                        For x = 0 To z
                            If dtori.Rows(x).RowState = DataRowState.Deleted Then
                                aquitar = True
                                x = z
                            Else
                                If dtori.Rows(x)("oferta_id") <> dtdes.Rows(x)("oferta_id") Or dtori.Rows(x)("tipo") <> dtdes.Rows(x)("tipo") Or dtori.Rows(x)("activa") <> dtdes.Rows(x)("activa") Or Not dtori.Rows(x)("oferta_usada").Equals(dtdes.Rows(x)("oferta_usada")) Then
                                    aquitar = True
                                    x = z
                                End If
                            End If

                        Next
                        If Not aquitar Then
                            ds.Tables.Remove(dtori)
                            dtdes.TableName = "reservas_ofertas"
                        End If

                    End If

                End If
                If (ds.HasChanges Or reserva_id = 0) And reserva_id <> -1 Then
                    'TODO actualizar si ha cambiado
                    Console.WriteLine(reserva_id)
                    Dim writer As MySqlDataAdapter

                    Dim filas As DataRowCollection
                    Dim x As Integer
                    cmd.Parameters.Clear()
                    Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                    cmd.Parameters.Add(reserva_idParam)
                    If reserva_id = 0 Then
                        writer = getDataAdapter(cmd, sqlCabReserva)
                        writer.Fill(ds.Tables("reserva"))
                        writer.Update(ds.Tables("reserva"))
                        reserva_id = Obtiene_ultima_id(cmd)
                    End If
                    reserva_idParam.Value = reserva_id
                    'todo...grabar siempre reservas servicios..
                    filas = ds.Tables("reservas_servicios").Rows
                    Dim fcount As Integer = filas.Count - 1
                    For x = 0 To fcount
                        If Not filas(x).RowState = DataRowState.Deleted Then
                            ' Grabo user_id y fecha de modificacion
                            ' GARRA ABRIL 2017
                            '
                            filas(x)("fecha_modificacion") = Now
                            filas(x)("user_id") = userId
                            If filas(x)("reserva_id") <> reserva_id Then
                                filas(x)("reserva_id") = reserva_id
                            End If

                        End If
                    Next
                    If Not IsNothing(ds.Tables("reservas_servicios").GetChanges) Then

                        writer = getDataAdapter(cmd, sqlReservasServicios)

                        writer.Fill(ds.Tables("reservas_servicios"))
                        writer.Update(ds.Tables("reservas_servicios"))
                    End If

                    filas = ds.Tables("reservas_contratos").Rows

                    For x = 0 To filas.Count - 1
                        If Not filas(x).RowState = DataRowState.Deleted Then
                            filas(x)("reserva_id") = reserva_id
                        End If
                    Next
                    filas = ds.Tables("reservas_ofertas").Rows
                    For x = 0 To filas.Count - 1
                        If Not filas(x).RowState = DataRowState.Deleted Then
                            filas(x)("reserva_id") = reserva_id
                        End If
                    Next
                    filas = ds.Tables("reservas_habitaciones").Rows
                    For x = 0 To filas.Count - 1
                        If Not filas(x).RowState = DataRowState.Deleted Then
                            filas(x)("reserva_id") = reserva_id
                        End If
                    Next
                    filas = ds.Tables("reservas_descuentos").Rows
                    For x = 0 To filas.Count - 1
                        If Not filas(x).RowState = DataRowState.Deleted Then
                            filas(x)("reserva_id") = reserva_id
                        End If
                    Next
                    writer = getDataAdapter(cmd, sqlObtieneReservasContratos)
                    writer.Fill(ds.Tables("reservas_contratos"))
                    writer.Update(ds.Tables("reservas_contratos"))
                    writer = getDataAdapter(cmd, sqlReservasOfertas)
                    writer.Fill(ds.Tables("reservas_ofertas"))
                    writer.Update(ds.Tables("reservas_ofertas"))
                    writer = getDataAdapter(cmd, sqlReservasHabitaciones)
                    writer.Fill(ds.Tables("reservas_habitaciones"))
                    writer.Update(ds.Tables("reservas_habitaciones"))
                    writer = getDataAdapter(cmd, sqlReservasDescuentos)
                    writer.Fill(ds.Tables("reservas_descuentos"))
                    writer.Update(ds.Tables("reservas_descuentos"))
                    'o añado my funcion aki... crea_descuento_en_reserva(cmd,reserva_id)
                End If
                Return reserva_id
            Catch ex As Exception
                Return Nothing
            End Try
        End Function
        Private Function obtieneServiciosReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal fecha_ini As Object, ByVal fecha_fin As Object, Optional ByVal noupdate As Boolean = False) As tablaServicios
            'AgregaInfo("obtieneServiciosReserva", reserva_id & "_" & New System.Diagnostics.StackTrace(True).ToString(), -1)
            Dim resultado As tablaServicios
            Try
                If Not noupdate Then
                    NormalizaReserva(cmd, reserva_id)
                End If
                Dim ds As DataSet = preparaDatasetReserva(cmd, reserva_id)
                resultado = obtieneServiciosReserva(cmd, ds, fecha_ini, fecha_fin)
                If Not noupdate Then
                    Dim resobject As Object = grabaDatasetReserva(cmd, ds, reserva_id)
                    If IsNothing(resobject) Then
                        resultado = Nothing
                    End If
                End If
            Catch ex As Exception
                resultado = Nothing
            End Try

            Return resultado
        End Function
        Shared sqlServiciosHoteles = "" _
& " SELECT servicios.servicio_id as servicio_id," _
& " servicios_hotel.impuesto_id, " _
& " impuestos.porcentaje, " _
& " servicios.tipo_servicio_id, " _
& " servicios.abreviatura " _
& " FROM" _
& " servicios_hotel " _
& " Inner Join servicios ON servicios_hotel.servicio_id = servicios.servicio_id " _
& " Inner Join impuestos ON servicios_hotel.impuesto_id = impuestos.impuesto_id " _
& " WHERE " _
& " servicios_hotel.hotel_id =  ? "
        Shared sqlUnidadesCalculos = "select * from unidades_calculo"
        Private Function convierteReservasServicios(ByVal cmd As MySqlCommand, ByVal ds As DataSet, Optional ByVal paso As Integer = 0) As DataTable
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", 0)
            cmd.Parameters.Add(reserva_idParam)

            'getDataTable(cmd, sqlTablaReservas, True)
            'datos.add(New DataView(getDataTable(cmd, sqlTablaReservas, True)))
            Dim datos As DataSet = getDataSet(cmd, sqlTablaReservas, True)
            If ds.Tables("reserva").Rows.Count > 0 Then

                Dim ucs As DataTable = getDataSet(cmd, sqlUnidadesCalculos, True).Tables(0) ' se puede cachear
                'Dim ucs As DataTable = readerToTable(Me.getDataTable(cmd, sqlUnidadesCalculos, True)) ' se puede cachear
                Dim dcucs(0) As DataColumn
                dcucs(0) = ucs.Columns("unidad_calculo_id")
                ucs.PrimaryKey = dcucs

                Dim cabres As DataRow = ds.Tables("reserva").Rows(0)
                cmd.Parameters.Clear()
                Dim hotel_idParam As New MySqlParameter("@hotel_id", cabres("hotel_id"))
                cmd.Parameters.Add(hotel_idParam)
                Dim servhoteles As DataTable = getDataSet(cmd, sqlServiciosHoteles, True).Tables(0) ' se puede cachear
                'Dim servhoteles As DataTable = readerToTable(Me.getDataTable(cmd, sqlServiciosHoteles, True)) ' se puede cachear

                Dim dc(0) As DataColumn
                dc(0) = servhoteles.Columns("servicio_id")
                servhoteles.PrimaryKey = dc

                Dim reader As DataTableReader = ds.Tables("reservas_servicios").CreateDataReader
                Dim dias_estancia As Integer = 0
                Dim dias_antelacion As Integer = 0
                'datediff(Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida),Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada))
                Dim fechaini As Date
                If cabres.IsNull("fecha_salida") Then
                    fechaini = cabres("fecha_prevista_salida")
                Else
                    fechaini = cabres("fecha_salida")
                End If
                Dim fechafin As Date
                If cabres.IsNull("fecha_llegada") Then
                    fechafin = cabres("fecha_prevista_llegada")
                Else
                    fechafin = cabres("fecha_llegada")
                End If
                dias_estancia = DateDiff(DateInterval.DayOfYear, fechafin, fechaini)
                dias_antelacion = DateDiff(DateInterval.DayOfYear, cabres("fecha_reserva"), fechafin)
                'datediff(Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada),Coalesce(fecha_reserva,'01/01/2001'))
                Dim row As DataRow
                'Dim filas() As DataRow
                Dim servicio_extra As Integer
                Dim rowl As DataRow
                While reader.Read
                    If reader.IsDBNull(reader.GetOrdinal("servicio_extra")) Then
                        servicio_extra = 0
                    Else
                        servicio_extra = reader("servicio_extra")
                    End If
                    If paso >= 0 And ((paso = 0 And servicio_extra = 1) Or (paso = 1 And servicio_extra <> 1) Or reader("flag_contrato") = 0) Then
                        'no recalculo si era un servicio extra o es de cliente directo
                    Else
                        row = datos.Tables(0).Rows.Add()
                        'servicio_reserva_id,reserva_id,servicio_id,unidad_calculo_id,fecha_desde,fecha_hasta,cantidad
                        ',impuesto_id,porcentaje,hotel_id,estado_reserva_id,bloquear_tarifa,cliente_id,dias_estancia,dias_antelacion,
                        'fecha_reserva,fecha_llegada,fecha_salida,fecha_prevista_llegada,fecha_prevista_salida,fecha_prevista_salida,tipo_servicio_id
                        'UC,abreviatura
                        'tabla reservas_servicios
                        'row("contrato_id_fijo") = reader("contrato_id_fijo")
                        row("servicio_reserva_id") = reader("servicio_reserva_id")
                        row("reserva_id") = reader("reserva_id")
                        row("servicio_id") = reader("servicio_id")
                        row("unidad_calculo_id") = reader("unidad_calculo_id")
                        row("cantidad") = reader("cantidad")
                        If reader.IsDBNull(reader.GetOrdinal("fecha_desde")) Then
                            row("fecha_desde") = fechafin
                        Else
                            row("fecha_desde") = reader("fecha_desde")
                        End If

                        If reader.IsDBNull(reader.GetOrdinal("fecha_hasta")) Then
                            row("fecha_hasta") = fechaini
                        Else
                            row("fecha_hasta") = reader("fecha_hasta")
                        End If
                        Try
                            row("flag_contrato") = reader("flag_contrato")
                        Catch ex As Exception
                            row("flag_contrato") = 1
                        End Try
                        row("precio_servicio") = reader("precio_servicio")


                        'tabla servicios_hotel
                        rowl = servhoteles.Rows.Find(reader("servicio_id"))
                        'filas = servhoteles.Select("servicio_id=" & reader("servicio_id"))
                        'If filas.Length > 0 Then
                        If Not IsNothing(rowl) Then
                            'rowl = filas(0)
                            row("impuesto_id") = rowl("impuesto_id")
                            row("porcentaje") = rowl("porcentaje")
                            row("tipo_servicio_id") = rowl("tipo_servicio_id")
                            row("abreviatura") = rowl("abreviatura")
                        End If

                        'cab reserva
                        row("hotel_id") = cabres("hotel_id")
                        row("estado_reserva_id") = cabres("estado_reserva_id")
                        row("bloquear_tarifa") = cabres("bloquear_tarifa")
                        row("cliente_id") = cabres("cliente_id")
                        row("dias_estancia") = dias_estancia
                        'If Not IsDBNull(cabres("cliente_id_factura")) Then
                        '    row("ttoo_id") = cabres("cliente_id_factura")
                        'Else
                        '    row("ttoo_id") = cabres("cliente_id")
                        'End If
                        row("dias_antelacion") = dias_antelacion
                        row("fecha_reserva") = cabres("fecha_reserva")
                        row("fecha_llegada") = cabres("fecha_llegada")
                        row("fecha_salida") = cabres("fecha_salida")
                        row("fecha_prevista_llegada") = cabres("fecha_prevista_llegada")
                        row("fecha_prevista_salida") = cabres("fecha_prevista_salida")
                        'unidades calculo
                        'filas = ucs.Select("unidad_calculo_id=" & reader("unidad_calculo_id"))
                        rowl = ucs.Rows.Find(reader("unidad_calculo_id"))
                        If Not IsNothing(rowl) Then
                            row("UC") = rowl("UC")
                        End If
                    End If
                End While
            End If
            Return datos.Tables(0) '.CreateDataReader
        End Function
        Private Function obtieneServiciosReserva(ByVal cmd As MySqlCommand, ByVal ds As DataSet, ByVal fecha_ini As Object, ByVal fecha_fin As Object, Optional ByVal paso As Integer = 0, Optional ByVal forzarPaso As Boolean = False, Optional ByVal esManual As String = "A") As tablaServicios

            Dim errorCode As Integer = 0
            'Dim reserva_id As Integer = 0 'quitar
            'TODO:cambiar leer las ucs y cantidades directamente del dataset lineas_reserva
            '//x
            Dim resultado As New tablaServicios

            Dim contrato_id As Integer

            'aki se enchufa precios dingus
            If ds.Tables.Contains("tablaservicios") Then
                'resultado = New tablaServicios
                resultado.servicios = ds.Tables("tablaservicios")
            Else

                Dim ucs As DataSet = obtieneUCSReserva(cmd, ds)
                Dim ucHijas As DataSet = obtieneUCHijas(cmd)
                resultado.servicios.Columns.Add("impuesto_id", System.Type.GetType("System.Int16"))
                resultado.servicios.Columns.Add("dias_estancia", System.Type.GetType("System.Int16"))
                ' Javier FEBRERO 2013
                'resultado.servicios.Columns.Add("ttoo_id", System.Type.GetType("System.Int32"))
                resultado.servicios.Columns.Add("dias_antelacion", System.Type.GetType("System.Int16"))
                'resultado.servicios.Columns.Add("porc_impuesto", System.Type.GetType("System.Decimal"))
                resultado.servicios.Columns.Add("fecha_reserva", System.Type.GetType("System.DateTime"))
                resultado.servicios.Columns.Add("fecha_llegada", System.Type.GetType("System.DateTime"))
                resultado.servicios.Columns.Add("fecha_salida", System.Type.GetType("System.DateTime"))

                'TODO:no usar query y usar el dataset
                'todo:convierte reservas_servicios a formato preprocesa
                Dim rpaso As Integer = paso
                If forzarPaso Then
                    rpaso = -1
                End If
                Dim reader As DataTableReader
                'Dim reader As DataTableReader = getDataTable(cmd, sqlTablaReservas)
                reader = preProcesaServicios(convierteReservasServicios(cmd, ds, rpaso))

                Dim bloqueo As Boolean = False
                Dim estado_reserva_id As Integer
                'todo cargar blokeo
                Try
                    Using reader
                        Dim contrareader As DataTableReader = Nothing
                        Dim fllegada As Date
                        Dim fsalida As Date
                        Dim fdesde As Date '= fllegada
                        Dim fhasta As Date '= fsalida
                        'Dim ttoo_id As Integer
                        Dim flag_contrato As Boolean
                        Dim flag_directo As Boolean
                        Dim dv As DataView = Nothing
                        Dim ultimodvcontrato_id As Integer
                        While reader.Read And errorCode = 0
                            '
                            'TODO si no hay blokeo y no esta en checkin-checkout 
                            'obtener el contrato_id activo para ese cliente
                            estado_reserva_id = reader.Item("estado_reserva_id")
                            bloqueo = reader.Item("bloquear_tarifa")
                            fllegada = CDate(reader.Item("fecha_prevista_llegada")).ToString("dd/MM/yyyy")
                            fsalida = CDate(reader.Item("fecha_prevista_salida")).ToString("dd/MM/yyyy")
                            Dim hotel_id = reader.Item("hotel_id")
                            Dim cliente_id = reader.Item("cliente_id")
                            If estado_reserva_id = 0 Or estado_reserva_id = 2 Or (estado_reserva_id = 1 And Not bloqueo) Or (estado_reserva_id = 3 And Not bloqueo) Then
                                contrareader = obtieneContratoActivosCliente(cmd, hotel_id, cliente_id, fllegada, fsalida, 1)
                            Else
                                contrareader = ds.Tables("reservas_contratos").CreateDataReader
                            End If

                            'todo ejecutar funcion por todos los contratos.
                            'Dim ienu As IEnumerator = ncontratoid.GetEnumerator

                            Dim contrato_idParam As New MySqlParameter("@contrato_id", 0)
                            While contrareader.Read() And errorCode = 0

                                'todo agregar solo si el servicio es para el touroperador y este es el contrato tour
                                'o si no es para touroperador y el contrato no es de touroperador

                                If Not reader.IsDBNull(reader.GetOrdinal("flag_contrato")) Then
                                    flag_contrato = reader.Item("flag_contrato")
                                Else
                                    flag_contrato = True
                                End If
                                flag_directo = False
                                If IsNumeric(contrareader("directo")) Then
                                    If contrareader("directo") = 1 Then
                                        flag_directo = True
                                    End If
                                End If


                                If flag_contrato And flag_directo = False Or (Not flag_contrato And flag_directo = True) Then
                                    If ultimodvcontrato_id <> contrareader("contrato_id") Then
                                        'calcTime("sub1", True)
                                        ultimodvcontrato_id = contrareader("contrato_id")
                                        cmd.Parameters.Clear()
                                        contrato_idParam.Value = contrareader("contrato_id")
                                        cmd.Parameters.Add(contrato_idParam)
                                        'dv = getDataView(cmd, sqlTablaServicioContrato, True)
                                        'dv = New DataView(getDataSet(cmd, sqlTablaServicioContrato, True).Tables(0), "", "", DataViewRowState.CurrentRows)
                                        'dv = New DataView(getTable(cmd, sqlTablaServicioContrato, True), "", "", DataViewRowState.CurrentRows)
                                        dv = New DataView(getTable(cmd, sqlTablaServicioContrato, True))
                                        'calcTime("sub1", False)
                                    End If

                                    If IsDBNull(reader.Item("fecha_llegada")) Then
                                        fllegada = CDate(reader.Item("fecha_prevista_llegada")).ToString("dd/MM/yyyy")
                                    Else
                                        fllegada = CDate(reader.Item("fecha_llegada")).ToString("dd/MM/yyyy")
                                    End If

                                    If IsDBNull(reader.Item("fecha_salida")) Then
                                        fsalida = CDate(reader.Item("fecha_prevista_salida")).ToString("dd/MM/yyyy")
                                    Else
                                        fsalida = CDate(reader.Item("fecha_salida")).ToString("dd/MM/yyyy")
                                    End If


                                    'If Not reader.IsDBNull(reader.GetOrdinal("fecha_desde")) Then
                                    fdesde = CDate(reader.Item("fecha_desde")).ToString("dd/MM/yyyy")
                                    'End If
                                    'If Not reader.IsDBNull(reader.GetOrdinal("fecha_hasta")) Then
                                    fhasta = CDate(reader.Item("fecha_hasta")).ToString("dd/MM/yyyy")
                                    'End If

                                    If fdesde < fllegada OrElse fdesde > fsalida Then
                                        fdesde = fllegada
                                    End If
                                    If fhasta > fsalida OrElse fhasta < fllegada Then
                                        fhasta = fsalida
                                    End If
                                    'Console.WriteLine(reader.Item("cantidad"))


                                    Dim x As tablaServicios = Nothing
                                    If Not reader.IsDBNull(reader.GetOrdinal("porcentaje")) Then
                                        'calcTime("obtieneTablaServicioContrato", True)
                                        x = obtieneTablaServicioContrato(cmd, ucHijas, contrareader("contrato_id"), reader.Item("servicio_id"), reader.Item("unidad_calculo_id"), reader.Item("UC"), reader.Item("cantidad"), fdesde, fhasta, reader.Item("servicio_reserva_id"), ucs, reader.Item("porcentaje"), flag_directo, reader.Item("precio_servicio"), dv)
                                        'calcTime("obtieneTablaServicioContrato", False)
                                    Else
                                        errorCode = 2 'servicio sin % de impuesto
                                        AgregaInfo("obtieneServiciosReserva", "servicio sin % de impuesto:" & reader.Item("servicio_id"), -errorCode)
                                    End If
                                    'paralelizar
                                    If Not IsNothing(x) Then
                                        Try
                                            x.borrarDeTabla("cantidad=0 and importe=0 and error=0")
                                            x.agregaCampo("dias_estancia", System.Type.GetType("System.Int16"), reader.Item("dias_estancia"))
                                            'x.agregaCampo("ttoo_id", System.Type.GetType("System.Int32"), reader.Item("ttoo_id"))
                                            x.agregaCampo("dias_antelacion", System.Type.GetType("System.Int16"), reader.Item("dias_antelacion"))
                                            x.agregaCampo("impuesto_id", System.Type.GetType("System.Int16"), reader.Item("impuesto_id"))
                                            x.agregaCampo("fecha_reserva", System.Type.GetType("System.DateTime"), "'" & reader.Item("fecha_reserva") & "'")
                                            x.agregaCampo("fecha_llegada", System.Type.GetType("System.DateTime"), "'" & fllegada & "'")
                                            x.agregaCampo("fecha_salida", System.Type.GetType("System.DateTime"), "'" & fsalida & "'")
                                            resultado.agregaTabla(x, True)
                                        Catch ex As Exception

                                        End Try

                                    Else
                                        errorCode = 1 'devuelve tabla servicios null
                                        AgregaInfo("obtieneServiciosReserva", "devuelve tabla servicios null:", -errorCode)
                                    End If
                                End If
                            End While
                        End While
                    End Using

                    Dim al As ArrayList = resultado.obtieneDistintos("contrato_id_defecto")

                    'si al y ncontratoid son distintos
                    'falta comparar con base de datos


                    Dim cambio As Boolean = False
                    'If estado_reserva_id < 2 And Not bloqueo Then
                    If estado_reserva_id = 0 Or estado_reserva_id = 2 Or (estado_reserva_id = 1 And Not bloqueo) Or (estado_reserva_id = 3 And Not bloqueo) Then
                        cambio = True
                    End If

                    'todo:insertar o borrar datos del dataset y no de la bd de reservas_contratos
                    If cambio Then
                        'si no esta blokeado vaciar reservas_contratos
                        'optimizar...si lo ke vas a meter es igual a lo ke estaba metido...no se toka
                        Dim rows As DataRowCollection = ds.Tables("reservas_contratos").Rows
                        Dim ienual As IEnumerator = al.GetEnumerator
                        Dim hacambiado As Boolean = False
                        If errorCode = 0 And rows.Count = al.Count Then

                            While hacambiado = False And ienual.MoveNext

                                Dim defecto As Boolean
                                contrato_id = CInt(CStr(ienual.Current).Split("_")(0))
                                defecto = CBool(CStr(ienual.Current).Split("_")(1))
                                Dim cont As Integer = 0
                                Dim subcont As Integer = 0
                                For cont = 0 To rows.Count - 1
                                    Dim row As DataRow = rows(cont)
                                    If row("contrato_id") = contrato_id And row("directo") = defecto Then
                                        subcont = 1
                                    End If
                                Next
                                If subcont = 0 Then
                                    hacambiado = True
                                End If
                            End While
                        Else
                            hacambiado = True
                        End If
                        If hacambiado Then
                            Dim x As Integer
                            For x = 0 To rows.Count - 1
                                rows(x).Delete()
                            Next
                            ienual = al.GetEnumerator
                            While errorCode = 0 And ienual.MoveNext

                                Dim defecto As Boolean
                                contrato_id = CInt(CStr(ienual.Current).Split("_")(0))
                                defecto = CBool(CStr(ienual.Current).Split("_")(1))
                                Dim row As DataRow = rows.Add()
                                row("reserva_id") = 0
                                row("contrato_id") = contrato_id
                                row("directo") = defecto
                            End While
                        End If
                    End If
                    al = resultado.obtieneDistintos("contrato_id")
                    'todo:asegurarse ke ofertas usa el dataset y no accesos a BD
                    'si tiene oferta validad...aplicarla sobre el resultado total
                    'se cambian tipo y oferta,tipo imputacion deberia ser diario
                    obtieneOfertasReserva(cmd, ds, al, resultado, ucs, paso)
                Catch ex As Exception
                    Dim ii As Integer = 1
                Finally
                End Try
            End If

            If paso <= 0 Then
                If errorCode <> 0 Then
                    resultado = Nothing
                Else

                    resultado.servicios = resultado.servicios.Copy()
                    resultado.borrarDeTabla("cantidad=0")
                    'TODO: calcular la media por servicio/uc y asignarla dia
                    resultado.redondear(2, metaresid, metaresidhash)
                    Dim tmptab As DataTable = resultado.ObtieneMediaServiciosUc()
                    resultado.ActualizarMediaServiciosUC(tmptab)
                    'todo añadir descuentos
                    If ds.Tables.Contains("reservas_descuentos") Then
                        'la nueva funcion ke mete los descuentos automaticos
                        'AQUIIIIIIIIIIIIIIIII
                        If esManual = "A" And ds.Tables("reserva").Rows.Count <> 0 Then
                            crea_descuento_en_reserva(cmd, ds)
                        End If
                        Dim rows As DataRowCollection = ds.Tables("reservas_descuentos").Rows
                        Dim x As Integer
                        If resultado.servicios.Rows.Count > 0 Then
                            For x = 0 To rows.Count - 1
                                If rows(x).RowState <> DataRowState.Deleted Then


                                    Dim imp As Single
                                    ' Tengo que averiguar "nombre_servicio, impuesto_id, porcentaje impuesto para la linea
                                    ' teniendo el servicio_id de reservas_descuentos
                                    Dim sql_servicio = "SELECT servicios.nombre_servicio,servicios_hotel.impuesto_id,servicios.tipo_servicio_id,impuestos.porcentaje " _
                                    & "FROM servicios_hotel " _
                                    & "Inner Join servicios ON servicios_hotel.servicio_id = servicios.servicio_id " _
                                    & "Inner Join impuestos ON servicios_hotel.impuesto_id = impuestos.impuesto_id " _
                                    & "WHERE servicios_hotel.hotel_id = ? AND " _
                                    & "servicios_hotel.servicio_id = ? "

                                    Dim hotel_idParam As New MySqlParameter("@reserva_id", ds.Tables("reserva").Rows(0).Item("hotel_id"))

                                    Dim contrato_idParam As New MySqlParameter("@contrato_id", contrato_id)
                                    Dim servicio_id_idParam As New MySqlParameter("@contrato_id", rows(x)("servicio_id"))
                                    cmd.Parameters.Clear()
                                    cmd.Parameters.Add(hotel_idParam)
                                    cmd.Parameters.Add(servicio_id_idParam)
                                    Dim tipo_servicio_id As Integer = 0
                                    Dim nombre_servicio As String = ""
                                    Dim impuesto_id As Integer = 0
                                    Dim porcentaje As Double = 0
                                    Try
                                        Dim Reader As DataTableReader = getDataTable(cmd, sql_servicio, True)
                                        While Reader.Read
                                            tipo_servicio_id = Reader.Item("tipo_servicio_id")
                                            nombre_servicio = Reader.Item("nombre_servicio")
                                            impuesto_id = Reader.Item("impuesto_id")
                                            porcentaje = Reader.Item("porcentaje")
                                        End While
                                    Catch ex As Exception

                                    End Try
                                    If rows(x)("tipo_descuento_id") = 2 Or rows(x)("tipo_descuento_id") = 1 Then
                                        Dim filtro_servicios As String = ""

                                        If rows(x)("tipo") = "A" Then
                                            'filtro_servicios = "tipo='A' AND "
                                        End If
                                        If rows(x)("tipo_descuento_id") = 2 Then
                                            imp = rows(x)("descuento")
                                        Else
                                            'suma todos los servicios con tipo_servicio_id igual
                                            'si descuento es a filtrar lineas de tipo a
                                            Dim impt = resultado.servicios.Compute("sum(importe)", filtro_servicios & "tipo_servicio_id=" & tipo_servicio_id)
                                            If IsDBNull(impt) Then
                                                impt = 0
                                            End If
                                            imp = impt * rows(x)("descuento") / 100
                                        End If

                                        Dim row As DataRow = resultado.servicios.Rows.Add(resultado.servicios.Rows(0).ItemArray)
                                        'row("tipo") = rows(x)("tipo") 'a/M
                                        row("tipo_servicio_id") = tipo_servicio_id
                                        row("descripcion") = nombre_servicio
                                        row("impuesto_id") = impuesto_id
                                        row("porc_impuesto") = porcentaje
                                        row("contrato_id") = DBNull.Value
                                        row("servicio_id") = rows(x)("servicio_id")
                                        row("ucid") = 1 ' servicio 
                                        row("cantidad") = 1 ' cantidad 
                                        row("defecto") = 0 'defecto
                                        'row("fecha") = fecha_ini
                                        row("precio_produccion") = -imp
                                        row("importe") = -imp
                                        row("precio") = -imp '-(imp - (imp * rows(x)("porcentaje") / 100))
                                        '***************************************************************************
                                        ' tano pag_factura
                                        ' GARRA JAVIER 13/3/2012
                                        ' En principio ponemos que vaya a la factura 1
                                        ' Luego pregunto si ese servicio esta en el contrato y que página pone
                                        ' Si es distinto de nulo entonces lo añado
                                        '****************************************************************************
                                        row("pag_factura") = 1
                                        Try
                                            Dim ssql = "SELECT PAG_FACTURA from lineas_de_contrato where contrato_id= ? AND servicio_id= ? Limit 0,1"
                                            cmd.Parameters.Clear()
                                            cmd.Parameters.Add(contrato_idParam)
                                            cmd.Parameters.Add(servicio_id_idParam)
                                            Dim pagina = ExecuteScalar(cmd, ssql)
                                            If IsNumeric(pagina) Then
                                                row("pag_factura") = pagina
                                            End If
                                        Catch ex As Exception
                                            row("pag_factura") = 1
                                        End Try
                                    End If
                                End If
                            Next
                        End If

                    End If
                    'dumpDataTable(resultado.servicios)
                    '                dumpDataTable(tmptab)
                    If Not IsNothing(fecha_ini) And Not IsNothing(fecha_fin) Then
                        resultado.erroresAntesBorrar = resultado.sumaErrores()
                        Dim fini As Date = fecha_ini
                        Dim ffin As Date = fecha_fin
                        resultado.borrarDeTabla("not (fecha>= '" & fini & "' and fecha <='" & ffin & "')")
                        'resultado.borrarDeTabla("fecha BETWEEN '" & fini & "' and '" & ffin & "'")
                    End If

                End If

            End If

            Return resultado
        End Function

        Shared sqlContratoHotelClienteFechaOld = "" _
                & " SELECT distinct" _
                & " contratos.contrato_id,clientes.cliente_defecto as directo" _
                & " FROM " _
                & " contratos left join clientes on contratos.cliente_id=clientes.cliente_id " _
                & " WHERE " _
                & " contratos.hotel_id =  ? AND " _
                & " (contratos.cliente_id =  ? or contratos.cliente_id in (SELECT c.cliente_id FROM clientes AS c Inner Join hoteles AS h ON h.empresa_id = c.empresa_id  WHERE c.cliente_defecto = 1 and h.hotel_id=contratos.hotel_id)) " _
                & " and contrato_id_siguiente is null AND " _
                & " (" _
                & " ? between contratos.fecha_desde and contratos.fecha_hasta " _
                & " or " _
                & " ? between contratos.fecha_desde and contratos.fecha_hasta " _
                & " )" _
                & " order by contratos.fecha_desde"

        Shared sqlContratoHotelClienteFecha = "select drvk.contrato_id,min(drvk.directo) as directo from (" _
        & " SELECT distinct" _
        & " contratos.contrato_id,0 as directo" _
        & " FROM " _
        & " contratos left join clientes on contratos.cliente_id=clientes.cliente_id " _
        & " WHERE " _
        & " contratos.hotel_id =  ? AND " _
        & " contratos.cliente_id =  ?" _
        & " and contrato_id_siguiente is null AND " _
        & " (" _
        & " ? between contratos.fecha_desde and contratos.fecha_hasta " _
        & " or " _
        & " ? between contratos.fecha_desde and contratos.fecha_hasta " _
        & " )" _
        & " union all SELECT distinct" _
        & " contratos.contrato_id,clientes.cliente_defecto as directo" _
        & " FROM " _
        & " contratos left join clientes on contratos.cliente_id=clientes.cliente_id " _
        & " WHERE " _
        & " contratos.hotel_id =  ? AND " _
        & " clientes.cliente_defecto =  1" _
        & " and contrato_id_siguiente is null AND " _
        & " (" _
        & " ? between contratos.fecha_desde and contratos.fecha_hasta " _
        & " or " _
        & " ? between contratos.fecha_desde and contratos.fecha_hasta " _
        & " )" _
        & " ) drvk group by drvk.contrato_id order by 2 desc,1"
        '    & " ?>=contratos.fecha_desde AND  ?<=contratos.fecha_hasta " _
        Private Function obtieneContratoActivosCliente(ByVal cmd As MySqlCommand, ByVal hotel As Integer, ByVal cliente As Integer, ByVal fechaini As Date, ByVal fechafin As Date, Optional ByVal tipo As Integer = 0) As Object
            cmd.Parameters.Clear()
            ' Create a SqlParameter for each parameter in the stored procedure.
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel)
            Dim hotel_id1Param As New MySqlParameter("@hotel_id1", hotel)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente)
            Dim fechainiParam As New MySqlParameter("@fechaini", fechaini)
            Dim fechafinParam As New MySqlParameter("@fechafin", fechafin)
            Dim fechaini1Param As New MySqlParameter("@fechaini1", fechaini)
            Dim fechafin1Param As New MySqlParameter("@fechafin1", fechafin)
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(cliente_idParam)
            cmd.Parameters.Add(fechainiParam)
            cmd.Parameters.Add(fechafinParam)

            cmd.Parameters.Add(hotel_id1Param)
            cmd.Parameters.Add(fechaini1Param)
            cmd.Parameters.Add(fechafin1Param)
            ' En esta query tengo un problema 
            Dim dtr As DataTableReader = getDataTable(cmd, sqlContratoHotelClienteFecha, True)
            If tipo = 0 Then
                Dim x As New ArrayList()
                While dtr.Read()
                    x.Add(dtr.Item("contrato_id"))
                End While
                Return x
            Else
                Return dtr
            End If

        End Function

        Private Function obtieneContratoActivoCliente(ByVal cmd As MySqlCommand, ByVal hotel As Integer, ByVal cliente As Integer, ByVal fechaini As Date, ByVal fechafin As Date)
            Dim dtr As ArrayList = obtieneContratoActivosCliente(cmd, hotel, cliente, fechaini, fechafin)
            Dim contrato_id = 0
            If dtr.Count > 0 Then
                contrato_id = dtr.Item(dtr.Count - 1)
            End If
            Return contrato_id
        End Function
        Shared sqlLineasTickets = "" _
        & " SELECT" _
     & " tickets.cliente_id AS cliente_id_ticket," _
     & "  tickets.cliente_id_contrato, " _
     & " tickets.hotel_id, " _
     & " tickets.fecha, " _
     & " reservas.cliente_id AS cliente_id_reserva, " _
     & " lineas_ticket.servicio_id, " _
     & " lineas_ticket.unidad_calculo_id, " _
     & " lineas_ticket.cantidad,lineas_ticket.linea_ticket_id, " _
     & " servicios_hotel.impuesto_id,impuestos.porcentaje" _
     & " FROM " _
     & " tickets" _
     & " Left Join reservas ON tickets.reserva_id = reservas.reserva_id " _
     & " Inner Join lineas_ticket ON tickets.ticket_id = lineas_ticket.ticket_id" _
     & " Inner Join servicios_hotel ON tickets.hotel_id = servicios_hotel.hotel_id AND lineas_ticket.servicio_id = servicios_hotel.servicio_id" _
     & " Inner Join impuestos ON servicios_hotel.impuesto_id = impuestos.impuesto_id " _
     & " WHERE " _
     & " tickets.ticket_id =  ?"
        Shared sqlActualizaLineaTickets = "" _
    & " update lineas_ticket set" _
    & " contrato_id=?" _
    & " ,descripcion=?" _
    & " ,impuesto_id=?" _
    & " ,porc_impuesto=?" _
    & " ,precio=?" _
    & " WHERE" _
    & " linea_ticket_id =  ?"
        Shared sqlLimpiaLineaTickets = "" _
    & " update lineas_ticket set" _
    & " contrato_id=null" _
    & " ,descripcion=null" _
    & " ,impuesto_id=null" _
    & " ,porc_impuesto=null" _
    & " ,precio=null" _
    & " WHERE" _
    & " ticket_id =  ?"


        Function generaCamposLineasTickets(ByVal ticket As Integer)
            Dim errorCode As Integer = 0


            Dim cmd As MySqlCommand = prepareConection()


            cmd.Parameters.Clear()
            Dim ticketParam As New MySqlParameter("@ticket_id", ticket)
            cmd.Parameters.Add(ticketParam)
            'limpia campos
            ExecuteNonQuery(cmd, sqlLimpiaLineaTickets)
            'Transaccion.Commit()

            'Transaccion = conn.BeginTransaction(IsolationLevel.Serializable)
            'cmd.CommandType = CommandType.Text
            'cmd.Connection = conn
            'cmd.Transaction = Transaccion

            'cmd.Parameters.Clear()
            ''Dim ticketParam As New MysqlParameter("@ticket_id", ticket)
            'cmd.Parameters.Add(ticketParam)
            'limpia campos
            'ExecuteNonQuery(cmd, sqlLimpiaLineaTickets)
            Dim reader As DataTableReader = getDataTable(cmd, sqlLineasTickets)
            Dim contrato_id = Nothing
            Dim cliente = Nothing
            While reader.Read And errorCode = 0
                If IsNothing(contrato_id) Then
                    'todo logica otros clientes
                    cliente = reader.Item("cliente_id_ticket")
                    If Not reader.IsDBNull(reader.GetOrdinal("cliente_id_contrato")) Then
                        cliente = reader.Item("cliente_id_contrato")
                    End If

                    contrato_id = obtieneContratoActivoCliente(cmd, reader.Item("hotel_id"), cliente, reader.Item("fecha"), reader.Item("fecha"))
                End If
                Dim x As tablaServicios = obtieneServicioPorDia(cmd, contrato_id, reader.Item("servicio_id"), reader.Item("unidad_calculo_id"), reader.Item("cantidad"), reader.Item("fecha"), reader.Item("porcentaje"))
                Dim linea_contrato_id = Nothing
                Dim descripcion = Nothing
                Dim precio = Nothing
                Dim impuesto_id = Nothing 'reader.Item("impuesto_id")
                Dim porcentaje = Nothing 'reader.Item("porcentaje")
                'Dim importeConIgic = Nothing 'reader.Item("porcentaje")
                Dim linea_ticket_id = reader.Item("linea_ticket_id")
                'Dim servicio_id = Nothing
                Dim graba As Boolean = False
                If Not IsNothing(x) Then
                    'todo update servicio
                    If x.servicios.Rows.Count > 0 Then
                        linea_contrato_id = x.servicios.Rows(0).Item("grupo")
                        descripcion = x.servicios.Rows(0).Item("descripcion")
                        precio = x.servicios.Rows(0).Item("precio")
                        impuesto_id = reader.Item("impuesto_id")
                        porcentaje = reader.Item("porcentaje")
                        'importeConIgic = x.servicios.Rows(0).Item("importeConIgic")
                        'servicio_id = reader.Item("servicio_id")
                        graba = True
                        'linea_ticket_id= reader.Item("linea_ticket_id")
                    End If
                End If
                If graba Then
                    Dim contrato_idParam As New MySqlParameter("@contrato_id", contrato_id)
                    Dim descripcionParam As New MySqlParameter("@descripcion", descripcion)
                    Dim precioParam As New MySqlParameter("@precio", precio)
                    Dim impuesto_idParam As New MySqlParameter("@impuesto_id", impuesto_id)
                    Dim porc_impuestoParam As New MySqlParameter("@porc_impuesto", porcentaje)
                    Dim linea_ticket_idParam As New MySqlParameter("@linea_ticket_id", linea_ticket_id)
                    'Dim importeConIgicParam As New MysqlParameter("@importeConIgic", importeConIgic)

                    If IsNothing(linea_contrato_id) Then
                        contrato_idParam.Value = Nothing
                    End If
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(contrato_idParam)
                    cmd.Parameters.Add(descripcionParam)
                    cmd.Parameters.Add(impuesto_idParam)
                    cmd.Parameters.Add(porc_impuestoParam)
                    cmd.Parameters.Add(precioParam)
                    'cmd.Parameters.Add(importeConIgicParam)
                    cmd.Parameters.Add(linea_ticket_idParam)
                    Dim num = ExecuteNonQuery(cmd, sqlActualizaLineaTickets)
                    If num = 1 Then
                    Else
                        errorCode = 1 'no puede actualizar registro
                        AgregaInfo("generaCamposLineasTickets", "No pudo actualizar la linea del ticket:" & linea_ticket_id, -errorCode)

                    End If
                End If
            End While
            flushConection(cmd, errorCode)
            Return errorCode
        End Function
        Shared sqlBorrarOferta = "delete  from ofertas where oferta_id=? and (select count(*) from reservas_ofertas r where r.oferta_id=ofertas.oferta_id and r.activa=1)=0 "
        Public Function BorrarOferta(ByVal oferta_id As Integer)
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                cmd.Parameters.Clear()
                Dim oferta_idParam As New MySqlParameter("@oferta_id", oferta_id)
                cmd.Parameters.Add(oferta_idParam)
                Me.ExecuteNonQuery(cmd, sqlBorrarOferta)
            Catch ex As Exception
                errorCode = 1
            End Try
            flushConection(cmd, errorCode)
            Return errorCode
        End Function

        Public Class menormayor
            Implements IComparer

            ' Calls CaseInsensitiveComparer.Compare with the parameters reversed.
            Public Function Compare(ByVal x As Object, ByVal y As Object) As Integer Implements IComparer.Compare
                If x.valor = y.valor Then
                    Return 0
                End If
                If x.valor > y.valor Then
                    Return -1
                Else
                    Return 1
                End If
            End Function 'IComparer.Compare

        End Class 'menormayor
        Public Class mayormenor
            Implements IComparer

            ' Calls CaseInsensitiveComparer.Compare with the parameters reversed.
            Public Function Compare(ByVal x As Object, ByVal y As Object) As Integer Implements IComparer.Compare
                If x.valor = y.valor Then
                    Return 0
                End If
                If x.valor < y.valor Then
                    Return -1
                Else
                    Return 1
                End If

            End Function 'IComparer.Compare

        End Class 'menormayor
        Private Class keyvalor
            Public key As String
            Public valor As Single
        End Class
        Public Function cobrarFactura(ByVal arrfac() As String, ByVal cobro_id As Integer, Optional ByVal tipo_cobro_id As Integer = 1, Optional ByVal parcial As Boolean = False, Optional ByRef importe As Single = Nothing)
            Dim retVal As Boolean = True
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                'Dim arrfac() As String = facturas.Split(",")
                Dim x As Integer
                Dim total As Single
                Dim facposneg As New ArrayList()

                'Dim facnegpos As New SortedList
                While retVal And x < arrfac.Length
                    Dim factura_id As Integer = arrfac(x)
                    Dim tmpi As Single = obtieneImportePendienteFactura(cmd, factura_id, tipo_cobro_id)
                    'tmpi = 0
                    Dim xk As New keyvalor
                    xk.key = "" & factura_id
                    xk.valor = tmpi
                    facposneg.Add(xk)
                    total += tmpi
                    x += 1
                End While
                If total = importe Then
                    parcial = False
                Else
                    parcial = True
                End If
                If total < 0 Then
                    facposneg.Sort(New menormayor)
                    'facnegpos.CopyTo(arrfac)
                Else
                    facposneg.Sort(New mayormenor)
                    'facposneg.CopyTo(arrfac)
                End If

                If retVal Then
                    x = 0
                    While retVal And x < facposneg.Count
                        Dim factura_id As Integer = facposneg(x).key
                        retVal = cobrarFactura(cmd, factura_id, cobro_id, tipo_cobro_id, parcial, importe)
                        x += 1
                    End While
                End If
            Catch ex As Exception
                retVal = False
                errorCode = 1
            End Try
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Public Function cobrarFactura(ByVal factura_id As Integer, ByVal cobro_id As Integer, Optional ByVal tipo_cobro_id As Integer = 1, Optional ByVal parcial As Boolean = False, Optional ByRef importe As Single = Nothing)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = cobrarFactura(cmd, factura_id, cobro_id, tipo_cobro_id, parcial, importe)
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Shared sqlCobros = "select * from cobros where 1=0"
        Shared sqlLineasCobros = "select * from lineas_cobro where 1=0"

        Private Function cobrarFactura(ByVal cmd As MySqlCommand, ByVal factura_id As Integer, ByVal cobro_id As Integer, Optional ByVal tipo_cobro_id As Integer = 1, Optional ByVal parcial As Boolean = False, Optional ByRef importe As Single = Nothing)
            'todo obtiene importe facturas
            'todo obtiene lo ya cobrado

            'todo si importe=0 fallo gordo
            Dim tmpi As Single = obtieneImportePendienteFactura(cmd, factura_id, tipo_cobro_id)
            If IsNothing(importe) Then
                importe = tmpi
            End If
            If parcial Then
                'que pasa si neg.
                If tmpi < 0 Then
                    If importe > 0 Then
                    Else
                        If tmpi < importe Or importe = 0 Then
                            tmpi = importe
                        End If
                    End If
                Else
                    If tmpi > importe And importe >= 0 Then
                        tmpi = importe
                    End If
                End If
            End If
            importe -= tmpi
            'If tmpi <> 0 Then
            Dim datosCobros As DataSet = getDataSet(cmd, sqlLineasCobros)
            Dim rowLin As DataRow = datosCobros.Tables(0).Rows.Add()
            rowLin.Item("cobro_id") = cobro_id
            rowLin.Item("factura_id") = factura_id
            rowLin.Item("importe") = tmpi
            Dim writer As MySqlDataAdapter
            writer = getDataAdapter(cmd, sqlLineasCobros)
            writer.Fill(datosCobros.Tables(0))
            writer.Update(datosCobros)
            'End If
            Return True
        End Function
        Shared sqlCreaCobroDeFactura = "insert into cobros(fecha,tipo_cobro_id,hotel_id,caja_id,forma_pago_id,fecha_contabilizacion,observaciones,Estado_Cobro_Id,user_id,fecha_modificacion)" _
    & "    SELECT " _
    & "facturas.Fecha_Factura AS fecha, " _
    & "     ? AS tipo_cobro_id, " _
    & " facturas.hotel_id, " _
    & "     ? AS caja_id, " _
    & " facturas.Forma_Pago_Id, " _
    & "     null AS fecha_contabilizacion, " _
    & "     null AS observaciones, " _
    & "     '0' AS estado_cobro_id, " _
    & "     ? AS user_id, " _
    & "     ? AS fecha_modificacion " _
    & " FROM" _
    & " facturas " _
    & " WHERE " _
    & " facturas.Factura_Id =  ?"
        Shared sqlCrearLineasCobro = "insert into lineas_cobro(cobro_id,factura_id,importe) values (?,?,?)"
        Shared sqlCrearCobroAnticipo = "insert into cobros(fecha,tipo_cobro_id,hotel_id,caja_id,forma_pago_id,fecha_contabilizacion,observaciones,estado_cobro_id,user_id,fecha_modificacion)" _
    & " SELECT  " _
    & "         ? AS fecha," _
    & "         ? AS tipo_cobro_id,  " _
    & " anticipos.hotel_id AS hotel_id," _
    & " anticipos.caja_id AS caja_id, " _
    & " anticipos.forma_pago_id AS forma_pago_id, " _
    & "        null AS fecha_contabilizacion, " _
    & "        null AS observaciones, " _
    & "         0 AS estado_cobro_id, " _
    & "         ? AS user_id, " _
    & " now() AS fecha_modificacion " _
    & " FROM " _
    & " anticipos" _
    & " WHERE " _
    & " anticipos.anticipo_id =  ? "
        Shared sqlCrearLineasCobroAnticipo = "insert into lineas_cobro(cobro_id,factura_id,importe)" _
    & "         SELECT" _
    & "         ? AS cobro_id, " _
    & " lineas_anticipo.Factura_Id AS factura_id, " _
    & " lineas_anticipo.Importe AS importe " _
    & " FROM " _
    & " lineas_anticipo " _
    & " WHERE " _
    & " lineas_anticipo.Anticipo_Id =  ? AND " _
    & " lineas_anticipo.Fecha_Contabilizacion IS NULL "
        Shared sqlActualizaLineasAnticipo = "update lineas_anticipo set fecha_contabilizacion=now() where anticipo_id=? and Fecha_Contabilizacion IS NULL "
        Shared sqlObtieneHotelAnticipo = "select hotel_id from anticipos where anticipo_id=?"
        Shared sqlCuentaLineasAnticiposPendientes = "select count(*) from lineas_anticipo where anticipo_id=? and Fecha_Contabilizacion IS NULL "
        Private Function CrearCobro(ByVal cmd As MySqlCommand, ByVal Anticipo_id As Integer)
            Dim retVal As Integer = 0
            Dim anticipo_idParam As New MySqlParameter("@anticipo_id", Anticipo_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(anticipo_idParam)
            Dim nant As Integer = ExecuteScalar(cmd, sqlCuentaLineasAnticiposPendientes)
            If nant > 0 Then
                Dim hotel_id As Integer = ExecuteScalar(cmd, sqlObtieneHotelAnticipo)
                Dim fecha As Date = FechaHotel(cmd, hotel_id)
                cmd.Parameters.Clear()
                Dim fechaParam As New MySqlParameter("@fecha", fecha)
                Dim tipo_cobro_idParam As New MySqlParameter("@tipo_cobro_id", 5)
                Dim userIdParam As New MySqlParameter("@userId", userId)
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(tipo_cobro_idParam)
                cmd.Parameters.Add(userIdParam)
                cmd.Parameters.Add(anticipo_idParam)
                'creo cabecera cobro
                If Me.ExecuteNonQuery(cmd, sqlCrearCobroAnticipo) = 1 Then
                    retVal = Obtiene_ultima_id(cmd)
                    Dim cobro_idParam As New MySqlParameter("@cobro_id", retVal)
                    'meto lineas del cobro
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(cobro_idParam)
                    cmd.Parameters.Add(anticipo_idParam)
                    If Me.ExecuteNonQuery(cmd, sqlCrearLineasCobroAnticipo) = nant Then
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(anticipo_idParam)
                        If Me.ExecuteNonQuery(cmd, sqlActualizaLineasAnticipo) = nant Then
                        Else
                            'no coinciden las lineas
                            retVal = -3
                            AgregaInfo("CrearCobro", "no coinciden las lineas del anticipo:" & Anticipo_id, retVal)

                        End If
                    Else
                        'no coinciden las lineas
                        retVal = -3
                        AgregaInfo("CrearCobro", "no coinciden las lineas del anticipo:" & Anticipo_id, retVal)

                    End If
                Else
                    'no pudo crear cabecera de cobros
                    retVal = -2
                    AgregaInfo("CrearCobro", "no pudo crear cabecera de cobros del anticipo:" & Anticipo_id, retVal)

                End If
            Else
                'no hay lineas pendientes
                retVal = -1
                AgregaInfo("CrearCobro", "no hay lineas pendientes de anticipo:" & Anticipo_id, retVal)

            End If
            Return retVal
        End Function

        Private Function CrearCobro(ByVal cmd As MySqlCommand, ByVal tipo_cobro_id As Integer, ByVal factura_id As Integer, ByVal caja_id As Integer) As Integer
            'TODO Cambiar fecha?
            Dim retVal As Integer = 0
            cmd.Parameters.Clear()
            Dim tipo_cobro_idParam As New MySqlParameter("@tipo_cobro_id", tipo_cobro_id)
            Dim caja_idParam As New MySqlParameter("@caja_id", caja_id)
            Dim user_idParam As New MySqlParameter("@user_id", userId)
            Dim fecha_modificacionParam As New MySqlParameter("@fecha_modificacion", Now)
            Dim Factura_IdParam As New MySqlParameter("@factura_id", factura_id)
            cmd.Parameters.Add(tipo_cobro_idParam)
            cmd.Parameters.Add(caja_idParam)
            cmd.Parameters.Add(user_idParam)
            cmd.Parameters.Add(fecha_modificacionParam)
            cmd.Parameters.Add(Factura_IdParam)
            If ExecuteNonQuery(cmd, sqlCreaCobroDeFactura) > 0 Then
                retVal = Obtiene_ultima_id(cmd)
                Dim importe As Single = obtieneImportePendienteFactura(cmd, factura_id)
                cmd.Parameters.Clear()
                Dim cobro_idParam As New MySqlParameter("@cobro_id", retVal)
                Dim importeParam As New MySqlParameter("@importe", importe)
                cmd.Parameters.Add(cobro_idParam)
                cmd.Parameters.Add(Factura_IdParam)
                cmd.Parameters.Add(importeParam)
                If ExecuteNonQuery(cmd, sqlCrearLineasCobro) = 0 Then
                    retVal = 0 'no pudo crear las lineas de cobro
                    AgregaInfo("CrearCobro", "no pudo crear las lineas de cobro de factura:" & factura_id, retVal)
                End If
            End If
            Return retVal
        End Function
        'Dim sqlTObtieneFacturasReserva = "select distinct l.factura_id from lineas_factura l where l.reserva_id=? and not l.factura_id is null"
        Public Function obtieneImportePendienteFacturas(ByVal reserva_id As String, ByVal sincredito As Boolean, Optional ByVal absoluto As Boolean = True)
            Dim retval As Single = 0
            Dim errorCode As Integer = 0
            Dim reserva As Integer = 0
            Try
                reserva = reserva_id
            Catch ex As Exception
            End Try
            Dim cmd As MySqlCommand = prepareConection()
            Try
                retval = obtieneImportePendienteFacturas(cmd, reserva, sincredito, absoluto)
            Catch ex As Exception
                errorCode = 0
            End Try
            flushConection(cmd, errorCode)
            Return retval
        End Function

        Private Function obtieneImportePendienteFacturas(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal sincredito As Boolean, Optional ByVal absoluto As Boolean = True)
            Dim retval As Single = 0
            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Add(reserva_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneFacturasReserva)
            Dim contar As Boolean
            While reader.Read
                If sincredito And reader.Item("credito") Then
                    'solo facturacs ke no sean de credito
                    contar = False
                Else
                    contar = True
                End If
                If contar Then
                    If absoluto Then
                        'Console.WriteLine(reader.Item("factura_id"))
                        retval += Math.Abs(obtieneImportePendienteFactura(cmd, CInt(reader.Item("factura_id"))))
                    Else
                        retval += obtieneImportePendienteFactura(cmd, CInt(reader.Item("factura_id")))
                    End If

                End If
            End While
            Return retval
        End Function
        'Shared sqlImportePendienteFacturaO = "select sum(cantidad*precio*?)-(select Coalesce(sum(importe),0) from lineas_cobro l where l.factura_id=lineas_factura.factura_id) from lineas_factura where lineas_factura.factura_id=?"
        'Shared sqlImportePendienteFactura = "select sum(cantidad*precio*?)-sum(Coalesce(lineas_cobro.importe,0)) from lineas_factura left join lineas_cobro on lineas_factura.factura_id=lineas_cobro.factura_id where lineas_factura.factura_id=?"
        '        Shared sqlImporteFactura = "select Coalesce(sum(round(cantidad*precio,2)),0) from lineas_factura where lineas_factura.factura_id=?"
        Shared sqlImporteFactura = "select importe_total from facturas where factura_id=?"
        Shared SqlCobradoFactura = "select Coalesce(sum(lineas_cobro.importe),0) from  lineas_cobro where lineas_cobro.factura_id=?"
        Private Function obtieneImportePendienteFactura(ByVal cmd As MySqlCommand, ByVal arrfac() As String, Optional ByVal tipo_cobro_id As Integer = 1) As Single
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Try
                'Dim arrfac() As String = facturas.Split(",")
                Dim x As Integer
                While x < arrfac.Length
                    Dim factura_id As Integer = arrfac(x)
                    retVal += obtieneImportePendienteFactura(cmd, factura_id, tipo_cobro_id)
                    x += 1
                End While
            Catch ex As Exception
                retVal = Nothing
                errorCode = -1
            End Try
            Return retVal
        End Function

        Public Function obtieneImportePendienteFactura(ByVal arrfac() As String, Optional ByVal tipo_cobro_id As Integer = 1) As Single
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = obtieneImportePendienteFactura(cmd, arrfac, tipo_cobro_id)
            If IsNothing(retVal) Then
                retVal = 0
                errorCode = -1
            End If
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Public Function obtieneImportePendienteFactura(ByVal factura_id As Integer, Optional ByVal tipo_cobro_id As Integer = 1) As Single
            Dim retVal As Single
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = obtieneImportePendienteFactura(cmd, factura_id, tipo_cobro_id)
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function

        Private Function obtieneImportePendienteFactura(ByVal cmd As MySqlCommand, ByVal factura_id As Integer, Optional ByVal tipo_cobro_id As Integer = 1) As Single

            Dim retVal As Single = 0
            cmd.Parameters.Clear()
            Dim Factura_IdParam As New MySqlParameter("@factura_id", factura_id)
            cmd.Parameters.Add(Factura_IdParam)

            'Dim multiParam As New MysqlParameter("@multi", 1)
            If tipo_cobro_id > 1 Then
                'multiParam.Value = 0
            Else
                retVal += Math.Round(ExecuteScalar(cmd, sqlImporteFactura), 2, MidpointRounding.AwayFromZero)
            End If
            'cmd.Parameters.Add(multiParam)


            retVal = Math.Round(retVal - ExecuteScalar(cmd, SqlCobradoFactura), 2, MidpointRounding.AwayFromZero)
            Return retVal

        End Function
        Shared sqlCabeceraTicket = "select * from tickets where ticket_id=? and fecha_contabilizacion is null"
        Shared sqlListaLineasTickets = "select * from lineas_ticket where lineas_ticket.ticket_id =  ?"
        Shared sqlLineasTicketInvalidas = "" _
    & " SELECT count(*) " _
    & " FROM " _
    & " lineas_ticket " _
    & " WHERE " _
    & " (lineas_ticket.contrato_id IS NULL  or lineas_ticket.precio is null)  " _
    & " and lineas_ticket.ticket_id =  ? "

        Public Function contabilizarTicket(ByVal ticket_id As Integer, ByVal validar As Boolean)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            cmd.Parameters.Clear()
            Dim ticket_idParam As New MySqlParameter("@ticket_id", ticket_id)
            cmd.Parameters.Add(ticket_idParam)
            Try
                Dim ninvalidas As Integer = ExecuteScalar(cmd, sqlLineasTicketInvalidas)
                Dim dlin As DataTableReader = getDataTable(cmd, sqlListaLineasTickets)
                If ninvalidas = 0 And dlin.HasRows Then
                    'todas las lineas del ticket tienen precio y hay almenos una linea en el ticket
                    Dim datos As DataSet = getDataSet(cmd, sqlCabeceraTicket)

                    If datos.Tables(0).Rows.Count = 1 Then

                        Dim reserva_id = datos.Tables(0).Rows(0).Item("reserva_id")
                        Dim crearfac As Boolean = datos.Tables(0).Rows(0).Item("serie_id") = 4 Or Not IsDBNull(datos.Tables(0).Rows(0).Item("forma_pago_id"))
                        If (crearfac) Or (Not crearfac And Not IsDBNull(reserva_id)) Then
                            If Not validar Then
                                'TODO crear cabecera factura si no se paga por reserva

                                Dim fac As Factura
                                If Not crearfac Then
                                    'se paga por reserva
                                    'todo crear lineas de factura contra la reserva
                                    fac = abreFactura(cmd, -1, reserva_id)
                                    fac.factura_id = Nothing
                                Else
                                    Dim fpagoid As Integer = 1
                                    If Not datos.Tables(0).Rows(0).IsNull("forma_pago_id") Then
                                        fpagoid = datos.Tables(0).Rows(0)("forma_pago_id")
                                    End If
                                    fac = preparaFactura(cmd, -1, datos.Tables(0).Rows(0).Item("cliente_id"), fpagoid, datos.Tables(0).Rows(0).Item("fecha"), datos.Tables(0).Rows(0).Item("hotel_id"), datos.Tables(0).Rows(0).Item("serie_id"))
                                End If
                                'TODO crear lineas de facturas
                                Dim tipolinea As String = "M"
                                Dim tipocobro As Integer = 1
                                Dim empieza As Integer = 1
                                If datos.Tables(0).Rows(0).Item("serie_id") = 4 Then
                                    tipolinea = "D"
                                    tipocobro = 3
                                    'empieza es zero si tipo cobro es deposito y es contra reserva
                                    If Not IsDBNull(reserva_id) Then
                                        empieza = 0
                                    End If

                                End If
                                While dlin.Read
                                    Dim x As Integer
                                    Dim num As Integer = 0
                                    For x = empieza To 1
                                        Dim row As DataRow = agregaLineaFactura(fac)
                                        row.Item("fecha") = datos.Tables(0).Rows(0).Item("fecha")
                                        row.Item("reserva_id") = reserva_id
                                        If fac.factura_id = 0 Or num = 1 Then
                                            row.Item("factura_id") = System.DBNull.Value
                                        Else
                                            row.Item("factura_id") = fac.factura_id
                                        End If
                                        row.Item("contrato_id") = dlin.Item("contrato_id")
                                        row.Item("descripcion") = dlin.Item("descripcion")
                                        If num = 1 Then
                                            row.Item("cantidad") = -dlin.Item("cantidad")
                                        Else
                                            row.Item("cantidad") = dlin.Item("cantidad")
                                        End If
                                        row.Item("hotel_id") = datos.Tables(0).Rows(0).Item("hotel_id")
                                        row.Item("precio") = dlin.Item("precio")
                                        row.Item("precio_produccion") = dlin.Item("precio")
                                        row.Item("impuesto_id") = dlin.Item("impuesto_id")
                                        row.Item("porc_impuesto") = dlin.Item("porc_impuesto")
                                        row.Item("servicio_id") = dlin.Item("servicio_id")
                                        row.Item("unidad_calculo_id") = dlin.Item("unidad_calculo_id")
                                        row.Item("tipo_linea_factura") = tipolinea 'M o D
                                        num += 1
                                    Next
                                End While
                                actualizarLineas(fac)
                                'todo actualizar factura
                                Dim pudoactualizar As Boolean = False
                                Dim pudoactualizarcobro As Boolean = False
                                If crearfac Then
                                    pudoactualizar = CambiarEstadoFactura(cmd, fac.factura_id, 1, False)
                                    If pudoactualizar Then
                                        'todo cobrar factura
                                        Dim cobro_id As Integer = CrearCobro(cmd, tipocobro, fac.factura_id, datos.Tables(0).Rows(0).Item("caja_id"))
                                        If cobro_id > 0 Then
                                            pudoactualizarcobro = CambiarEstadoCobro(cmd, cobro_id, 1, False)
                                            If pudoactualizarcobro Then
                                                'todo correcto
                                            Else
                                                'no se pudo actualizar el cobro
                                                AgregaInfo("ContabilizarTicket", "No se puede actualizar el cobro para el ticket:" & ticket_id, -1)
                                            End If
                                        Else
                                            'no se pudo crear cobro
                                            AgregaInfo("ContabilizarTicket", "No se puede crear cobro para el ticket:" & ticket_id, -1)
                                        End If
                                    Else
                                        'no se pudo actualizar la factura
                                        AgregaInfo("ContabilizarTicket", "No se puede actualizar la facutura para el ticket:" & ticket_id, -1)
                                    End If
                                Else
                                    pudoactualizar = True
                                    pudoactualizarcobro = True
                                End If
                                If pudoactualizar And pudoactualizarcobro Then
                                    If fac.factura_id = 0 Then
                                        datos.Tables(0).Rows(0).Item("factura_id") = System.DBNull.Value
                                    Else
                                        datos.Tables(0).Rows(0).Item("factura_id") = fac.factura_id
                                    End If

                                    datos.Tables(0).Rows(0).Item("fecha_contabilizacion") = Now
                                    datos.Tables(0).Rows(0).Item("user_id") = userId
                                    datos.Tables(0).Rows(0).Item("fecha_actualizacion") = Now
                                    datos.Tables(0).Rows(0).Item("estado_ticket_id") = 2
                                    Dim writer As MySqlDataAdapter
                                    writer = getDataAdapter(cmd, sqlCabeceraTicket)
                                    writer.Fill(datos.Tables(0))
                                    writer.Update(datos.Tables(0))
                                    retVal = True
                                End If
                            Else
                                'TODO comprobar que caja no esta cerrada solo si forma de pago distinto a reserva
                                If Not IsDBNull(datos.Tables(0).Rows(0).Item("forma_pago_id")) Then
                                    If EstaCajaAbierta(cmd, datos.Tables(0).Rows(0).Item("caja_id"), datos.Tables(0).Rows(0).Item("fecha")) Then
                                        retVal = True
                                    Else
                                        retVal = False
                                        AgregaInfo("ContabilizarTicket", "La caja del ticket esta cerrada:" & ticket_id, -1)
                                        'caja esta cerrada
                                    End If
                                Else
                                    'todo comprobar ke tenga una reserv
                                    If IsDBNull(reserva_id) Then
                                        retVal = False
                                        AgregaInfo("ContabilizarTicket", "Se necesita una reserva valida en el ticket:" & ticket_id, -1)
                                    Else
                                        'comprobar que reserva sea valida para asignarle el ticket
                                        If CambiarEstadoReserva(cmd, reserva_id, 4, True) = 0 Then
                                            retVal = True
                                        Else
                                            retVal = False
                                            AgregaInfo("ContabilizarTicket", "Se necesita una reserva valida en el ticket:" & ticket_id, -1)
                                        End If
                                    End If

                                End If
                            End If
                        Else
                            'falta reserva_id?
                        End If
                    End If
                Else
                    retVal = False  'por ke?
                End If
            Catch
                errorCode = 1
                AgregaInfo("ContabilizarTicket", "Error al contablizar el ticket:" & ticket_id, -1)

            End Try
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If

            Return retVal
        End Function
        Public Function crearLineasFacturas(ByVal reserva_id As Integer, ByVal servicio_id As Integer, ByVal unidad_calculo_id As Integer, ByVal cantidad As Single, Optional ByVal fecha_desde As Object = Nothing, Optional ByVal fecha_hasta As Object = Nothing, Optional ByVal reserva_servicio_id As Integer = 1)

            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado As tablaServicios = Nothing
            Try
                'obtiene datos de la reserva
                Dim ds As DataSet = preparaDatasetReserva(cmd, reserva_id)
                'vacio lineas antiguas

                ds.Tables("reservas_servicios").Clear()
                ds.Tables("reservas_contratos").Clear()
                ds.Tables("reservas_ofertas").Clear()
                ds.Tables("reservas_ofertas_subclone").Clear()
                ds.Tables("reservas_descuentos").Clear()
                ds.Tables("reservas_descuentos_subclone").Clear()

                'Dim rows() As DataRow = ds.Tables("reservas_descuentos_subclone").Select("tipo='A'")
                'Dim x As Integer
                'For x = 0 To rows.Length - 1
                'rows(x).Delete()
                'Next

                If ds.Tables.Contains("tablaservicios") Then
                    ds.Tables.Remove("tablaservicios")
                End If
                Dim dr As DataRow = ds.Tables("reservas_servicios").Rows.Add
                dr("servicio_reserva_id") = reserva_servicio_id
                dr("reserva_id") = reserva_id
                dr("servicio_id") = servicio_id
                dr("unidad_calculo_id") = unidad_calculo_id
                dr("cantidad") = cantidad
                If IsNothing(fecha_desde) Then
                    fecha_desde = ds.Tables("reserva").Rows(0)("fecha_prevista_llegada")
                End If
                Dim fh As Date = FechaHotel(cmd, ds.Tables("reserva").Rows(0)("hotel_id"))
                If fecha_desde < fh Then
                    fecha_desde = fh
                End If
                If IsNothing(fecha_hasta) Then
                    fecha_hasta = ds.Tables("reserva").Rows(0)("fecha_prevista_salida")
                End If
                If fecha_hasta > ds.Tables("reserva").Rows(0)("fecha_prevista_salida") Then
                    'Console.Write(DateDiff(DateInterval.Day, ds.Tables("reserva").Rows(0)("fecha_prevista_salida"), fecha_hasta))
                    If fecha_desde <> fh Or DateDiff(DateInterval.Day, ds.Tables("reserva").Rows(0)("fecha_prevista_salida"), fecha_hasta) > 1 Then
                        fecha_hasta = ds.Tables("reserva").Rows(0)("fecha_prevista_salida")
                    End If

                End If
                ds.Tables("reserva").Rows(0)("fecha_prevista_salida") = fecha_hasta
                ds.Tables("reserva").Rows(0)("fecha_salida") = fecha_hasta
                dr("fecha_desde") = fecha_desde
                dr("fecha_hasta") = fecha_hasta
                dr("flag_contrato") = 0
                dr("servicio_extra") = 1

                'todo asignar en reservas_servicios la linea

                ds.Tables("reserva").Rows(0)("estado_reserva_id") = 0 'desbloquea reserva
                ds.Tables("reservas_contratos").Clear() 'limppia contratos
                ds.Tables("reservas_ofertas").Clear() 'limppia reservas
                ds.Tables("reservas_ofertas_subclone").Clear()
                'meto linea ficticia
                'obtengo precios
                resultado = obtieneServiciosReserva(cmd, ds, fecha_desde, fecha_hasta, -1, False, "M")

                'todo lo ke sea menor a la fecha de trabajo hotel..se mueve a fecha trabajo hotel
                'dumpResultado(resultado)
                'inserto lineas
                'cambiar tipo de D a M
                If Not IsNothing(resultado) Then
                    If resultado.servicios.Rows.Count > 0 Then
                        Dim writer As MySqlDataAdapter
                        Dim dt As DataTable = ds.Tables("reservas_servicios")
                        Dim xx As Integer
                        dt.AcceptChanges()
                        For xx = 0 To dt.Rows.Count - 1
                            dt.Rows(xx).SetAdded()
                        Next

                        If Not IsNothing(ds.Tables("reservas_servicios").GetChanges) And reserva_servicio_id = 1 Then
                            cmd.Parameters.Clear()
                            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                            cmd.Parameters.Add(reserva_idParam)
                            writer = getDataAdapter(cmd, sqlReservasServicios)
                            writer.Fill(ds.Tables("reservas_servicios"))
                            writer.Update(ds.Tables("reservas_servicios"))
                        End If
                        generaAjuste(cmd, reserva_id, resultado, fecha_desde, True, True, "M", False, reserva_servicio_id)
                    Else
                        errorCode = 3
                        AgregaInfo("crearLineasFacturas", "No hay lineas que generar:" & reserva_id, -errorCode)
                    End If
                Else
                    errorCode = 2
                    AgregaInfo("crearLineasFacturas", "No hay nada que generar:" & reserva_id, -errorCode)
                End If

            Catch ex As Exception
                errorCode = 1
                AgregaInfo("crearLineasFacturas", "No se puede calcular los servicios de la reserva:" & reserva_id, -errorCode)

            End Try
            If Not flushConection(cmd, errorCode) Then
                resultado = Nothing
            End If
            Return resultado


        End Function
        Private Function obtieneServicioPorDia(ByVal cmd As MySqlCommand, ByVal contrato_id As Integer, ByVal servicio As Integer, ByVal unidad_calculo_id As Integer, ByVal cantidad As Integer, ByVal fecha As Date, ByVal porcimpuesto As Decimal) As tablaServicios
            Dim errorCode As Integer = 0
            Dim resultado As tablaServicios = Nothing

            If Not IsDBNull(contrato_id) Then
                'TODO obtiene las lineas ke genera esa reserva
                Dim ucHijas As DataSet = obtieneUCHijas(cmd)
                resultado = obtieneTablaServicioContrato(cmd, ucHijas, contrato_id, servicio, unidad_calculo_id, "", cantidad, fecha, fecha.AddDays(1), 0, Nothing, porcimpuesto)
                If Not IsNothing(resultado) Then
                    If resultado.servicios.Rows.Count > 1 Then
                        'TODO agrupa y suma si hay mas de una fila
                    End If
                    '                Console.WriteLine(x.servicios.Rows(0).Item("descripcion"))
                End If

            Else
                errorCode = 1 'no hay contrato activo
                AgregaInfo("obtieneServicioPorDia", "No hay contrato activo:" & contrato_id, -errorCode)
            End If



            If errorCode <> 0 Then
                resultado = Nothing
            Else
            End If

            Return resultado

        End Function
        Shared sqlComprobarOfertas = "" _
& " SELECT DISTINCT reservas_ofertas.reserva_id,reservas.estado_reserva_id,contratos.cliente_id,clientes.razon " _
& " /* " _
& " group_concat(DISTINCT " _
& " convert (reservas_ofertas.reserva_id, char)) " _
& " */ " _
& " FROM reservas Inner Join reservas_ofertas ON reservas_ofertas.reserva_id = reservas.reserva_id " _
& " Inner Join ofertas ON reservas_ofertas.oferta_id = ofertas.oferta_id " _
& " Inner Join contratos ON ofertas.contrato_id = contratos.contrato_id " _
& " inner join clientes on clientes.cliente_id=contratos.cliente_id" _
& " WHERE " _
& " reservas.estado_reserva_id IN  (1,3,4,5) AND " _
& " ofertas.tipo_oferta_id IN  (14, 15) AND " _
& " reservas_ofertas.activa =  '1' "

        Public Function PruebaOfertas() As Integer
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim reader As DataTableReader = Me.getDataTable(cmd, sqlComprobarOfertas)
            While reader.Read
                'If reader("reserva_id") = 5126 Then
                'sqlOfertasContratos = sqlOfertasContratosOld
                'End If

                sqlOfertasContratos = sqlOfertasContratosOld

                Dim ds As DataSet = preparaDatasetReserva(cmd, reader("reserva_id"))
                Dim imp As Single = obtieneServiciosReserva(cmd, ds, Nothing, Nothing).sumaImporte()

                'Dim imp As Single = obtieneImporteTotalReserva(reader("reserva_id"))
                flushCache()

                sqlOfertasContratos = sqlOfertasContratosNew
                Dim dsn As DataSet = preparaDatasetReserva(cmd, reader("reserva_id"))
                Dim impnew As Single = obtieneServiciosReserva(cmd, dsn, Nothing, Nothing).sumaImporte()

                'Dim impnew As Single = obtieneImporteTotalReserva(reader("reserva_id"))
                If imp <> impnew Then
                    Console.WriteLine(reader("razon") & "-" & reader("reserva_id") & "-" & reader("estado_reserva_id") & "-" & imp & "-" & impnew & "-")
                End If
                flushCache()
            End While
            flushConection(cmd, errorCode)
            Return errorCode
        End Function
        Shared sqlReservasOfertas = "select * from reservas_ofertas where reserva_id=?"
        'Dim sqlOfertasContratos = "select * from ofertas where  contrato_id in (?)"
        Shared sqlOfertaCodigos = "select ofertas_codigos.* from ofertas inner join ofertas_codigos on ofertas.oferta_id=ofertas_codigos.oferta_id where ofertas.contrato_id in (?)"

        Shared sqlOfertasContratos = "" _
    & " SELECT ofertas.*,Coalesce(ofertas.orden_aplicacion,tipos_de_oferta.orden_aplicacion) as super_orden_aplicacion FROM ofertas " _
    & " Inner Join tipos_de_oferta ON ofertas.tipo_oferta_id = tipos_de_oferta.tipo_oferta_id " _
    & " where  contrato_id in (?) " _
    & " order by super_orden_aplicacion asc,ofertas.oferta_id "

        Public sqlOfertasContratosOld = "" _
    & " SELECT ofertas.* FROM ofertas " _
    & " Inner Join tipos_de_oferta ON ofertas.tipo_oferta_id = tipos_de_oferta.tipo_oferta_id " _
    & " where  contrato_id in (?) " _
    & " order by tipos_de_oferta.orden_aplicacion asc "

        Public sqlOfertasContratosNew = "" _
    & " SELECT ofertas.* FROM ofertas " _
    & " Inner Join tipos_de_oferta ON ofertas.tipo_oferta_id = tipos_de_oferta.tipo_oferta_id " _
    & " where  contrato_id in (?) " _
    & " order by tipos_de_oferta.orden_aplicacion asc,ofertas.oferta_id "

        Shared sqlOfertasRejilla = "select * from ofertas_rejillas where oferta_id=?"
        Shared sqlOfertasRejillaContratos = "select ofertas_rejillas.* from ofertas inner join ofertas_rejillas on ofertas.oferta_id=ofertas_rejillas.oferta_id where ofertas.contrato_id in (?)"
        Shared sqlOfertasServiciosAdicionalesContratos = "select ofertas_servicios.* from ofertas inner join ofertas_servicios on ofertas.oferta_id=ofertas_servicios.oferta_id where ofertas.contrato_id in (?)"
        Shared sqlOfertasServiciosAdicionales = "select * from ofertas_servicios where oferta_id=?"
        Shared sqlCuentaOfertas = "" _
    & " SELECT distinct reservas.reserva_id" _
    & " FROM " _
    & " reservas_ofertas " _
    & " Inner Join reservas ON reservas_ofertas.reserva_id = reservas.reserva_id " _
    & " WHERE " _
    & " reservas.estado_reserva_id in (1,3) AND " _
    & " reservas_ofertas.activa =  1 AND " _
    & " reservas_ofertas.oferta_id =  ? "

        'aplicable_auto=1 and
        Private Function compactarServicios(ByVal servicios_adicionales As DataTable, ByVal paso As Integer)
            Dim rows() As DataRow
            Dim x As Integer
            Dim y As Integer



            rows = servicios_adicionales.Select("", "servicio_id,unidad_calculo_id,cantidad,fecha_desde")
            Dim toinc As New Hashtable
            For x = 0 To rows.Length - 1
                If Not rows(x).RowState = DataRowState.Detached Then
                    For y = x + 1 To rows.Length - 1
                        If Not rows(y).RowState = DataRowState.Detached Then
                            If rows(y)("precio_servicio").Equals(rows(x)("precio_servicio")) And rows(y)("cantidad") = rows(x)("cantidad") And rows(y)("unidad_calculo_id") = rows(x)("unidad_calculo_id") And rows(y)("servicio_id") = rows(x)("servicio_id") Then
                                If Not rows(y).IsNull("fecha_desde") And Not rows(x).IsNull("fecha_hasta") Then
                                    If rows(y)("fecha_desde") = CDate(rows(x)("fecha_hasta")).AddDays(1) Then
                                        rows(x)("fecha_hasta") = rows(y)("fecha_hasta")
                                        rows(y).Delete()
                                        toinc(x) = rows(x)
                                    End If
                                End If
                            End If
                        End If
                    Next
                End If
            Next
            If paso < 0 Then
                Dim iter As IEnumerator = toinc.Values.GetEnumerator
                While iter.MoveNext
                    Dim row As DataRow = iter.Current
                    row("fecha_hasta") = CDate(row("fecha_hasta")).AddDays(1)
                End While
            End If
            servicios_adicionales.AcceptChanges()
            'sumar servicios iguales
            rows = servicios_adicionales.Select("", "servicio_id,unidad_calculo_id,cantidad,fecha_desde")
            For x = 0 To rows.Length - 1
                If Not rows(x).RowState = DataRowState.Detached Then
                    For y = x + 1 To rows.Length - 1
                        If Not rows(y).RowState = DataRowState.Detached Then
                            If rows(y)("precio_servicio").Equals(rows(x)("precio_servicio")) And rows(y)("unidad_calculo_id") = rows(x)("unidad_calculo_id") And rows(y)("servicio_id") = rows(x)("servicio_id") Then
                                If rows(y).IsNull("fecha_desde") And rows(x).IsNull("fecha_desde") And rows(y).IsNull("fecha_hasta") And rows(x).IsNull("fecha_hasta") Then
                                    rows(x)("cantidad") += rows(y)("cantidad")
                                    rows(y).Delete()
                                End If
                            End If
                        End If
                    Next
                End If
            Next
            'servicios fecha desde=fecha hasta
            'incrementar un dia la fecha hasta
            servicios_adicionales.AcceptChanges()
            'sumar servicios iguales
            rows = servicios_adicionales.Select("", "servicio_id,unidad_calculo_id,cantidad,fecha_desde")
            For x = 0 To rows.Length - 1
                If Not rows(x).RowState = DataRowState.Detached Then
                    If Not rows(x).IsNull("fecha_desde") And Not rows(x).IsNull("fecha_hasta") Then
                        If rows(x)("fecha_desde") = rows(x)("fecha_hasta") Then
                            rows(x)("fecha_hasta") = rows(x)("fecha_hasta").addDays(1)
                        End If
                    End If
                End If
            Next
            servicios_adicionales.AcceptChanges()
            Return True
        End Function
        Shared sqlOfertaTieneCodigo = "select oferta_id from ofertas_codigos where oferta_id=? and codigo_oferta=?"
        Private Function obtieneOfertasReserva(ByVal cmd As MySqlCommand, ByVal ds As DataSet, ByVal contratos As ArrayList, ByVal resultado As tablaServicios, Optional ByVal ucs As DataSet = Nothing, Optional ByVal paso As Integer = 0) As DataTable
            Dim datos As DataTable = ds.Tables("reservas_ofertas")  'getDataSet(cmd, sqlReservasOfertas)
            Dim quitardatos As Boolean = False
            'TODO filtrar solo las ofertas que se podrian aplicar
            Dim ofertasUsadas As Hashtable
            If IsNothing(resultado.ofertasUsadas) Then
                resultado.ofertasUsadas = New Hashtable
            End If
            ofertasUsadas = resultado.ofertasUsadas
            Dim clon_reservas_servicios As DataTable = Nothing
            If contratos.Count <> 0 Then
                clon_reservas_servicios = ds.Tables("reservas_servicios").Clone()
                clon_reservas_servicios.Clear()

                Dim ucHijas As DataSet = ucs
                If ucHijas Is Nothing Then
                    ucHijas = obtieneUCSReserva(cmd, ds)
                End If
                Dim fecha_hotel As Date = FechaHotel(cmd, ds.Tables("reserva").Rows(0)("hotel_id"))
                'cmd.Parameters.Clear()
                'Dim reserva_idParam As New MysqlParameter("@reserva_id", reserva_id)
                'cmd.Parameters.Add(reserva_idParam)
                Dim servicios As DataTable = resultado.servicios
                servicios.Columns("ambito_id").ColumnName = "ambito_id1"
                servicios.Columns("tipo").ColumnName = "tipo1"
                servicios.Columns("grupo").ColumnName = "grupo1"
                servicios.Columns("uc").ColumnName = "uc1"
                servicios.Columns("ucid").ColumnName = "ucid1"
                servicios.Columns("tipo_oferta_id").ColumnName = "tipo_oferta_id1"
                servicios.Columns("n").ColumnName = "n1"
                servicios.Columns("m").ColumnName = "m1"
                servicios.Columns("impuesto_incluido").ColumnName = "impuesto_incluido1"

                servicios.Columns.Add("ambito_id", System.Type.GetType("System.Int32"), "")
                servicios.Columns.Add("tipo", System.Type.GetType("System.Int32"), "")
                'servicios.Columns.Add("grupo", System.Type.GetType("System.Int32"), "")
                servicios.Columns.Add("grupo", System.Type.GetType("System.String"), "")
                servicios.Columns.Add("uc", System.Type.GetType("System.Int32"), "")
                servicios.Columns.Add("ucid", System.Type.GetType("System.Int32"), "")
                servicios.Columns.Add("tipo_oferta_id", System.Type.GetType("System.Int32"), "")
                servicios.Columns.Add("n", System.Type.GetType("System.Double"), "")
                servicios.Columns.Add("m", System.Type.GetType("System.Double"), "")
                servicios.Columns.Add("impuesto_incluido", System.Type.GetType("System.Int32"), "")

                'TODO obtener las ofertas automaticas posibles
                cmd.Parameters.Clear()
                'Console.WriteLine(Join(contratos.ToArray, ","))
                'Dim contratosParam As New MysqlParameter("@contrato_id", Join(contratos.ToArray, ","))
                'cmd.Parameters.Add(contratosParam)

                'Dim ofertas As DataTableReader = getDataTable(cmd, sqlOfertasContratos, True)
                Dim ofertas As DataTableReader = getDataTable(cmd, Replace(sqlOfertasContratos, "?", Join(contratos.ToArray, ",")), True)
                Dim ofertas_codigos As DataTable = getDataSet(cmd, Replace(sqlOfertaCodigos, "?", Join(contratos.ToArray, ",")), True).tables(0)
                Dim dvcondofertas As DataView = New DataView(getDataSet(cmd, Replace(sqlCondicionesOfertasContratos, "?", Join(contratos.ToArray, ",")), True).tables(0))
                Dim dvconofertascodigos As DataView = New DataView(getDataSet(cmd, Replace(sqlOfertasServiciosAdicionalesContratos, "?", Join(contratos.ToArray, ",")), True).tables(0))
                Dim dvconofertasrejilla As DataView = New DataView(getDataSet(cmd, Replace(sqlOfertasRejillaContratos, "?", Join(contratos.ToArray, ",")), True).tables(0))
                'sqlOfertasRejillaContratos
                Dim fecha_salida As Date
                fecha_salida = ds.Tables("reserva").Rows(0)("fecha_prevista_salida")
                If Not ds.Tables("reserva").Rows(0).IsNull("fecha_salida") Then
                    fecha_salida = ds.Tables("reserva").Rows(0)("fecha_salida")
                End If
                If paso >= 0 Then
                    fecha_salida = fecha_salida.AddDays(-1)
                End If
                Dim fecha_llegada As Date
                fecha_llegada = ds.Tables("reserva").Rows(0)("fecha_prevista_llegada")
                If Not ds.Tables("reserva").Rows(0).IsNull("fecha_llegada") Then
                    fecha_llegada = ds.Tables("reserva").Rows(0)("fecha_llegada")
                End If
                Dim ttoo_id As Integer = ds.Tables("reserva").Rows(0).Item("cliente_id")
                If Not ds.Tables("reserva").Rows(0).IsNull("cliente_id_factura") Then
                    ttoo_id = ds.Tables("reserva").Rows(0).Item("cliente_id_factura")
                End If

                Try

                    While ofertas.Read
                        'todo leer la rejilla de esa oferta
                        cmd.Parameters.Clear()
                        'If ofertas.Item("oferta_id") = 126 Then
                        'Dim x = 0
                        'End If
                        'Console.WriteLine(Join(contratos.ToArray, ","))
                        'Dim oferta_idParam As New MysqlParameter("@oferta_id", ofertas.Item("oferta_id"))
                        'cmd.Parameters.Add(oferta_idParam)

                        dvconofertasrejilla.RowFilter = "oferta_id=" & ofertas.Item("oferta_id")
                        Dim rejilla As DataTable
                        rejilla = dvconofertasrejilla.ToTable()
                        'dvconofertasrejilla
                        'rejilla = getTable(cmd, sqlOfertasRejilla, True)
                        dvconofertascodigos.RowFilter = "oferta_id=" & ofertas.Item("oferta_id")
                        Dim servicios_adicionales As DataTable
                        servicios_adicionales = dvconofertascodigos.ToTable()
                        'servicios_adicionales = getTable(cmd, sqlOfertasServiciosAdicionales, True)

                        'cuenta lineas
                        Dim filtro As String = "1=1" ' GARRA JAVIER FEBRERO SE ME DABA PIÑO AL IMPORTAR RESERVAS PORQUE HABIA UN AND antes del operador

                        'todo si oferta es de un contrato tourpoperador..solo aplicar a los no directos
                        'Console.Write(ofertas.Item("contrato_id"))
                        Dim def As Object = resultado.servicios.Compute("min(defecto)", "contrato_id=" & ofertas.Item("contrato_id"))
                        If Not IsDBNull(def) Then
                            If def = 0 Then
                                def = 0
                            End If
                            filtro &= " and defecto=" & def
                        End If


                        'javier.nunez.casanovas:  días de antelación es número de días entre fecha de llegada y fecha de reserva
                        ' y oferta si es de un ttoo_id especial
                        ' Garra Javier Abril 2017 ttoo_id no está en la tabla de ofertas
                        'If Not IsDBNull(ofertas.Item("ttoo_id")) Then
                        '    filtro &= " and " & ttoo_id & "=" & ofertas.Item("ttoo_id")
                        'End If
                        If Not IsDBNull(ofertas.Item("dias_de_antelacion")) Then
                            filtro &= " and dias_antelacion>=" & ofertas.Item("dias_de_antelacion")
                        End If
                        'todo dias minimos estancia
                        If Not IsDBNull(ofertas.Item("estancia_minima_dias")) Then
                            filtro &= " and dias_estancia>=" & ofertas.Item("estancia_minima_dias")
                        End If
                        'todo dias maximo estancia
                        If Not IsDBNull(ofertas.Item("estancia_maxima_dias")) Then
                            filtro &= " and dias_estancia<=" & ofertas.Item("estancia_maxima_dias")
                        End If
                        'todo añadir fechas en el filtro
                        'fecha_reserva
                        If Not IsDBNull(ofertas.Item("fecha_reserva_desde")) Then
                            filtro &= " and fecha_reserva>='" & ofertas.Item("fecha_reserva_desde") & "'"
                        End If
                        If Not IsDBNull(ofertas.Item("fecha_reserva_hasta")) Then
                            filtro &= " and fecha_reserva<='" & ofertas.Item("fecha_reserva_hasta") & "'"
                        End If
                        Dim campofecha As String = "fecha"
                        If ofertas.Item("tipo_aplicacion_oferta_id") = "L" Then
                            campofecha = "fecha_llegada"
                        End If
                        If Not IsDBNull(ofertas.Item("fecha_desde")) Then
                            filtro &= " and " & campofecha & ">='" & ofertas.Item("fecha_desde") & "'"
                        End If
                        If Not IsDBNull(ofertas.Item("fecha_hasta")) Then
                            filtro &= " and " & campofecha & "<='" & ofertas.Item("fecha_hasta") & "'"
                        End If
                        If Not IsDBNull(ofertas.Item("unidad_calculo_id")) Then
                            'si es un uc que contiene..subdividir
                            'de donde leo? cachedUCHijas
                            Dim z As String
                            z = Join(obtieneUCHijas(cmd, ofertas.Item("unidad_calculo_id")).ToArray, ",")
                            filtro &= " and ucid1 in (" & z & " )"
                        End If
                        If Not IsDBNull(ofertas.Item("servicio_id")) Then
                            filtro &= " and servicio_id=" & ofertas.Item("servicio_id")
                        End If
                        If Not IsDBNull(ofertas.Item("tipo_servicio_id")) Then
                            filtro &= " and tipo_servicio_id=" & ofertas.Item("tipo_servicio_id")
                        End If
                        'todo por tipo de contrato?
                        Dim filasACambiar As DataRow()
                        'todo obtener filas que podrian cambiar con esta oferta en vez del numero
                        'Console.Write(filtro & "-")
                        If Not IsDBNull(ofertas.Item("servicio_ligado_id")) Then
                            'obtener numero servicios ke koincidan
                            Dim nregs As Object
                            If Not IsNothing(ds.Tables("reservas_servicios_parent")) Then
                                nregs = ds.Tables("reservas_servicios_parent").Compute("count(servicio_id)", "servicio_id=" & ofertas.Item("servicio_ligado_id"))
                            Else
                                nregs = resultado.servicios.Compute("count(servicio_id)", "servicio_id=" & ofertas.Item("servicio_ligado_id"))
                            End If
                            If IsDBNull(nregs) Then
                                nregs = 0
                            End If
                            If nregs = 0 Then
                                filtro &= " and 1=0"
                            End If
                        End If
                        ' AQUI se ostiaba ?
                        filasACambiar = resultado.servicios.Select(filtro)

                        'Console.WriteLine(filtro)
                        Dim filaOferta As DataRow() = datos.Select("oferta_id=" & ofertas.Item("oferta_id"))
                        Dim tiene_codigo As Boolean
                        Dim sin_codigos As Boolean
                        tiene_codigo = ofertas_codigos.Select("oferta_id=" & ofertas.Item("oferta_id") & " and codigo_oferta='" & ds.Tables("reserva").Rows(0)("codigo_oferta") & "'").Length > 0
                        sin_codigos = ofertas_codigos.Select("oferta_id=" & ofertas.Item("oferta_id")).Length = 0

                        If filasACambiar.Length > 0 Then
                            'existen servicios con esas combinaciones
                            Dim nueva = False
                            Dim encupo As Boolean = False
                            If Not IsDBNull(ofertas.Item("cupo_oferta")) Then
                                'TODO:si tiene cupo,contar cuantas veces esta esa oferta activa
                                'en reservas checkin ...solo si reserva entra en fecha_hotel?
                                Dim oferta_idParam As New MySqlParameter("@oferta_id", ofertas.Item("oferta_id"))
                                cmd.Parameters.Add(oferta_idParam)

                                Dim cupo As Integer = ofertas.Item("cupo_oferta")
                                Dim ofertasds As DataSet = getDataSet(cmd, sqlCuentaOfertas)

                                Dim nofertas = ofertasds.Tables(0).Compute("count(reserva_id)", "reserva_id not in (" & ds.Tables("reserva").Rows(0)("reserva_id") & ")")
                                If IsNothing(nofertas) Then
                                    nofertas = 0
                                End If
                                If nofertas >= cupo Or ds.Tables("reserva").Rows(0)("fecha_prevista_llegada") <> fecha_hotel Then
                                    'If filaOferta.Length = 1 Then
                                    'Dim row As DataRow = filaOferta(0)
                                    'row.Item("tipo") = "M"
                                    'row.Item("activa") = 0
                                    'End If
                                    encupo = False
                                Else
                                    If filaOferta.Length = 1 Then
                                        Dim row As DataRow = filaOferta(0)
                                        row.Item("tipo") = "A"
                                        row.Item("activa") = 1
                                    End If
                                    encupo = True
                                End If
                            End If

                            If filaOferta.Length = 0 Then
                                'no existe asi ke creamos la fila
                                'siempre que la reserva no este blokeada
                                Dim row As DataRow = datos.Rows.Add()
                                row.Item("oferta_id") = ofertas.Item("oferta_id")
                                row.Item("reserva_id") = ds.Tables("reserva").Rows(0)("reserva_id")
                                If ofertas.Item("aplicable_auto") = 1 Or encupo Then
                                    row.Item("tipo") = "A"
                                    row.Item("activa") = 1
                                Else
                                    row.Item("tipo") = "M"
                                    row.Item("activa") = 0
                                End If
                                'si oferta tiene ese codigo...auto activarla
                                If tiene_codigo Then
                                    row.Item("activa") = 1
                                End If

                                nueva = True
                            Else
                                'auto activar las filas cuyo codigo coincida
                                If tiene_codigo Then
                                    Dim x As Integer
                                    Dim z As Integer = filaOferta.Length - 1
                                    For x = 0 To z
                                        filaOferta(x)("activa") = 1
                                    Next
                                End If
                                filaOferta(0)("oferta_usada") = 0
                            End If
                            ofertasUsadas(ofertas.Item("oferta_id")) = ofertas.Item("oferta_id")
                        Else
                            'no existe...borrar si existia en reservas_ofertas
                            'siempre que la reserva no este blokeada
                            If filaOferta.Length <> 0 Then
                                filaOferta(0).Delete()
                            Else
                                'ofertasUsadas(ofertas.Item("oferta_id")) = ofertas.Item("oferta_id")
                            End If
                        End If
                        filaOferta = datos.Select("activa=1 and oferta_id=" & ofertas.Item("oferta_id"))
                        'todo comprobar que cumple las condiciones
                        Dim cumple As Boolean
                        'cumple = cumpleCondicionesOfertas(cmd, ofertas.Item("oferta_id"), ucHijas)
                        dvcondofertas.RowFilter = "oferta_id=" & ofertas.Item("oferta_id")
                        cumple = cumpleCondiciones(dvcondofertas.ToTable.CreateDataReader, ucHijas)
                        '//x
                        If cumple And filaOferta.Length > 0 Then
                            ofertasUsadas(ofertas.Item("oferta_id")) = ofertas.Item("oferta_id")
                            filaOferta(0)("oferta_usada") = 0
                            If sin_codigos Or tiene_codigo Then


                                'TODO aplicar oferta a todas esas filas
                                'siempre que exista en reservas_ofertas

                                'cambio estructura tabla
                                'chapu cambiar por parametro a la llamada funcion

                                'resetear todas las filas
                                'todo cambiar a al otro loop
                                Dim enu As IEnumerator
                                enu = servicios.Rows.GetEnumerator()
                                While enu.MoveNext
                                    Dim row As DataRow = enu.Current
                                    With row
                                        .Item("tipo") = DBNull.Value
                                        .Item("grupo") = DBNull.Value
                                        .Item("uc") = DBNull.Value
                                        .Item("ucid") = DBNull.Value
                                        .Item("tipo_oferta_id") = DBNull.Value
                                        .Item("n") = DBNull.Value
                                        .Item("m") = DBNull.Value
                                        .Item("impuesto_incluido") = DBNull.Value
                                    End With
                                End While
                                enu = filasACambiar.GetEnumerator()
                                Dim impuesto_incluido As Boolean = ofertas.Item("impuesto_incluido")
                                While enu.MoveNext
                                    'todo solo elegir fechas que esten dentro de la oferta
                                    Dim row As DataRow = enu.Current
                                    If paso <= 0 And servicios_adicionales.Rows.Count > 0 Then
                                        Dim clon_x As Integer
                                        For clon_x = 0 To servicios_adicionales.Rows.Count - 1
                                            Dim servicio_comp = servicios_adicionales.Rows(clon_x)("servico_id_existe")
                                            If IsDBNull(servicio_comp) Then
                                                servicio_comp = 0
                                            End If
                                            If servicio_comp = 0 Or servicio_comp = row("servicio_id") Then
                                                'Console.WriteLine(servicio_comp & "-" & row("servicio_id"))
                                                Dim clon_row As DataRow = clon_reservas_servicios.Rows.Add
                                                clon_row("servicio_id") = servicios_adicionales.Rows(clon_x)("servicio_id")
                                                If paso < 0 Then
                                                    clon_row("flag_contrato") = 0
                                                Else
                                                    clon_row("flag_contrato") = 1
                                                End If

                                                clon_row("reserva_id") = ds.Tables("reserva").Rows(0)("reserva_id")
                                                clon_row("servicio_reserva_id") = clon_x + 1
                                                clon_row("unidad_calculo_id") = row("ucid1")
                                                clon_row("cantidad") = row("cantidad")
                                                If paso >= 0 And row("fecha") = fecha_llegada Then
                                                    clon_row("fecha_desde") = fecha_llegada
                                                Else
                                                    clon_row("fecha_desde") = row("fecha")
                                                End If
                                                If paso >= 0 And row("fecha") = fecha_salida Then
                                                    clon_row("fecha_hasta") = fecha_salida
                                                Else
                                                    'If paso < 0 Then
                                                    'clon_row("fecha_hasta") = CDate(row("fecha")).AddDays(1)
                                                    'Else
                                                    clon_row("fecha_hasta") = row("fecha") 'CDate(row("fecha")).AddDays(1)
                                                    'End If
                                                End If
                                                If Not servicios_adicionales.Rows(clon_x).IsNull("precio") Then
                                                    clon_row("precio_servicio") = servicios_adicionales.Rows(clon_x)("precio")
                                                End If
                                                clon_row("servicio_extra") = 1
                                                If Not servicios_adicionales.Rows(clon_x).IsNull("unidad_calculo_id") Then
                                                    clon_row("unidad_calculo_id") = servicios_adicionales.Rows(clon_x)("unidad_calculo_id")
                                                End If
                                                If Not servicios_adicionales.Rows(clon_x).IsNull("cantidad") Then
                                                    clon_row("cantidad") = servicios_adicionales.Rows(clon_x)("cantidad")
                                                End If
                                            End If
                                        Next


                                    End If

                                    If Not IsDBNull(ofertas.Item("precio")) Then
                                        'posible problema con tipos distinto de diario!
                                        row.Item("precio") = ofertas.Item("precio")
                                        row.Item("importe") = row.Item("cantidad") * row.Item("precio")
                                    End If
                                    row.Item("tipo") = ofertas.Item("tipo_imputacion_id") 'todo leer tipos de oferta 0-diario,1-llegada,2-salida
                                    'todo crear un grupo ke coincida con esa linea
                                    row.Item("grupo") = row.Item("mgrupo")
                                    'todo revisar
                                    If ofertas.Item("ambito_oferta_id") = 1 Then
                                        row.Item("ambito_id") = 1
                                    Else
                                        row.Item("ambito_id") = 2
                                    End If
                                    row.Item("ucid") = ofertas.Item("unidad_calculo_id")
                                    row.Item("tipo_oferta_id") = ofertas.Item("tipo_oferta_id")
                                    row.Item("n") = ofertas.Item("n")
                                    'si m es euros.y si tiene impuestos incluidos recalcular m
                                    row.Item("m") = ofertas.Item("m")
                                    row.Item("impuesto_incluido") = impuesto_incluido
                                    'todo meter rejilla ofertas
                                    row.Item("rejilla") = rejilla
                                    'row.Item("servicios_adicionales") = servicios_adicionales
                                End While

                                resultado.servicios.AcceptChanges()
                                resultado.recalculaImportePorGrupo()
                                'si tiene cambios es ke la oferta se aplico de algun modo
                                If Not IsNothing(resultado.servicios.GetChanges()) Then
                                    filaOferta(0)("oferta_usada") = 1
                                Else
                                    filaOferta(0)("oferta_usada") = 0
                                End If
                                resultado.servicios.AcceptChanges()
                                'todo agrupar por ucid,fecha,servicio en cada ciclo de ofertas
                                'servicios.AcceptChanges()
                            End If
                        End If
                    End While
                Catch ex As Exception
                    AgregaInfo("obtieneOfertasReserva", "[fallo en oferta=" & ofertas.Item("oferta_id") & "]", -1)

                    Throw New Exception("[fallo en oferta=" & ofertas.Item("oferta_id") & "]", ex)

                End Try

                servicios.Columns.Remove("ambito_id")
                servicios.Columns.Remove("tipo")
                servicios.Columns.Remove("grupo")
                servicios.Columns.Remove("uc")
                servicios.Columns.Remove("ucid")
                servicios.Columns.Remove("tipo_oferta_id")
                servicios.Columns.Remove("n")
                servicios.Columns.Remove("m")

                servicios.Columns("ambito_id1").ColumnName = "ambito_id"
                servicios.Columns("tipo1").ColumnName = "tipo"
                servicios.Columns("grupo1").ColumnName = "grupo"
                servicios.Columns("uc1").ColumnName = "uc"
                servicios.Columns("ucid1").ColumnName = "ucid"
                servicios.Columns("tipo_oferta_id1").ColumnName = "tipo_oferta_id"
                servicios.Columns("n1").ColumnName = "n"
                servicios.Columns("m1").ColumnName = "m"
            Else
                quitardatos = True
            End If
            'si hay servicios adicionales
            Dim tmptable As DataTable = ds.Tables("reservas_servicios")
            If paso <= 0 Then
                If Not IsNothing(clon_reservas_servicios) Then
                    compactarServicios(clon_reservas_servicios, paso)
                End If

                'sincroniza los servicios extras con reservas_servicios

                Dim filtroextras As String
                If paso < 0 Then
                    filtroextras = "servicio_extra=1" ' and flag_contrato=0"
                Else
                    filtroextras = "servicio_extra=1 and flag_contrato=1"
                End If

                Dim rows() As DataRow = tmptable.Select(filtroextras)
                Dim count_clon As Integer = 0
                If Not IsNothing(clon_reservas_servicios) Then
                    count_clon = clon_reservas_servicios.Rows.Count

                End If
                If paso >= 0 Then
                    While rows.Length > count_clon
                        rows(0).Delete()
                        'tmptable.AcceptChanges()
                        rows = tmptable.Select(filtroextras)
                    End While
                End If
                If count_clon > 0 Then
                    Dim posrow As Integer = 0
                    If paso < 0 Then
                        posrow = rows.Length
                        count_clon += rows.Length
                    End If
                    While rows.Length < count_clon
                        tmptable.Rows.Add(clon_reservas_servicios.Rows(0).ItemArray)
                        'tmptable.AcceptChanges()
                        rows = tmptable.Select(filtroextras)
                    End While
                    Dim xrows As Integer
                    For xrows = 0 To count_clon - 1 - posrow
                        Dim xcolumns As Integer
                        For xcolumns = 0 To tmptable.Columns.Count - 1
                            If tmptable.Columns(xcolumns).ColumnName <> "servicio_reserva_id" Then
                                rows(xrows + posrow)(xcolumns) = clon_reservas_servicios.Rows(xrows)(xcolumns)
                            End If
                        Next
                    Next
                End If
            End If
            If Not IsNothing(clon_reservas_servicios) Then
                clon_reservas_servicios.AcceptChanges()
                'todo...agregar servicios a reservas_servicios con flag servicio_extra a 1



                If clon_reservas_servicios.Rows.Count > 0 Then
                    Dim fmin As Object = clon_reservas_servicios.Compute("min(fecha_desde)", "")
                    Dim fmax As Object = clon_reservas_servicios.Compute("max(fecha_hasta)", "")
                    'If paso < 0 And Not IsDBNull(fmax) Then
                    'fmax = CDate(fmax).AddDays(1)
                    'End If
                    'cambio para servicios ligados...en vez de borrar..renombrar
                    If IsNothing(ds.Tables("reservas_servicios_parent")) Then
                        tmptable.TableName = "reservas_servicios_parent"
                    Else
                        ds.Tables.Remove(tmptable)
                    End If
                    ds.Tables.Add(clon_reservas_servicios)
                    'ds.Tables("reservas_servicios") = clon_reservas_servicios

                    Dim tmptableofertas As DataTable = ds.Tables("reservas_ofertas")
                    Dim clon_reservas_oferta As DataTable = tmptableofertas.Copy()
                    ds.Tables.Remove(tmptableofertas)
                    ds.Tables.Add(clon_reservas_oferta)
                    Dim forzar As Boolean = False
                    If paso = -1 Then
                        forzar = True

                    End If

                    Dim neoser As tablaServicios = obtieneServiciosReserva(cmd, ds, fmin, fmax, 1, forzar)
                    ds.Tables.Remove(clon_reservas_oferta)
                    ds.Tables.Add(tmptableofertas)
                    ds.Tables.Remove(clon_reservas_servicios)
                    If Not IsNothing(ds.Tables("reservas_servicios_parent")) Then
                        tmptable.TableName = "reservas_servicios"
                    Else
                        ds.Tables.Add(tmptable)
                    End If

                    If Not IsNothing(neoser) Then
                        'neoser.ofertasUsadas
                        Dim ienu As IEnumerator = neoser.ofertasUsadas.Keys.GetEnumerator()
                        While ienu.MoveNext
                            ofertasUsadas(ienu.Current) = neoser.ofertasUsadas(ienu.Current)
                        End While
                        Dim rowadded() As DataRow = clon_reservas_oferta.Select("", "", DataViewRowState.Added)
                        Dim x As Integer
                        For x = 0 To rowadded.Length - 1
                            If tmptableofertas.Select("oferta_id=" & rowadded(x)("oferta_id"), "").Length = 0 Then
                                'si fue borrada en paso 0...obtener la configuracion en akel momento
                                Dim rowsdel() As DataRow = tmptableofertas.Select("oferta_id=" & rowadded(x)("oferta_id"), "", DataViewRowState.Deleted)
                                If rowsdel.Length > 0 Then
                                    Dim xx As Integer
                                    For xx = 0 To rowsdel.Length - 1
                                        rowsdel(xx).RejectChanges()
                                        'rowsdel(xx)("precio") = rowadded(x)("precio")
                                        'rowsdel(x).SetModified()
                                    Next
                                Else
                                    tmptableofertas.Rows.Add(rowadded(x).ItemArray)
                                End If

                            End If
                        Next
                        Dim dt As DataTable = resultado.servicios.Copy()
                        dt.Merge(neoser.servicios)
                        resultado.servicios = dt
                    End If

                End If
            End If
            'volver a procesar esos servicios contra las ofertas existentes
            'y añadir al resultado global

            Dim arrofertas As String = Join(New ArrayList(ofertasUsadas.Keys).ToArray, ",")
            If IsNothing(arrofertas) Then
                arrofertas = "0"
            End If
            If 1 = 1 Then
                Dim filaOferta As DataRow() = datos.Select(" not oferta_id  in (" & arrofertas & ")")
                If filaOferta.Length > 0 Then
                    Dim x As Integer
                    For x = 0 To filaOferta.Length - 1
                        filaOferta(x).Delete()
                    Next
                End If
            End If



            If quitardatos Then
                Return Nothing
            Else
                Return datos
            End If

        End Function
        Private Function obtieneOfertasReservaOld(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal contratos As ArrayList, ByVal resultado As tablaServicios, Optional ByVal ucs As DataSet = Nothing) As DataTable
            If contratos.Count = 0 Then
                Return Nothing
            End If


            Dim ucHijas As DataSet = ucs
            If ucHijas Is Nothing Then
                ucHijas = obtieneUCSReserva(cmd, reserva_id)
            End If

            cmd.Parameters.Clear()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Add(reserva_idParam)


            Dim datos As DataSet = getDataSet(cmd, sqlReservasOfertas)

            Dim servicios As DataTable = resultado.servicios
            servicios.Columns("ambito_id").ColumnName = "ambito_id1"
            servicios.Columns("tipo").ColumnName = "tipo1"
            servicios.Columns("grupo").ColumnName = "grupo1"
            servicios.Columns("uc").ColumnName = "uc1"
            servicios.Columns("ucid").ColumnName = "ucid1"
            servicios.Columns("tipo_oferta_id").ColumnName = "tipo_oferta_id1"
            servicios.Columns("n").ColumnName = "n1"
            servicios.Columns("m").ColumnName = "m1"
            servicios.Columns("impuesto_incluido").ColumnName = "impuesto_incluido1"

            servicios.Columns.Add("ambito_id", System.Type.GetType("System.Int32"), "")
            servicios.Columns.Add("tipo", System.Type.GetType("System.Int32"), "")
            'servicios.Columns.Add("grupo", System.Type.GetType("System.Int32"), "")
            servicios.Columns.Add("grupo", System.Type.GetType("System.String"), "")
            servicios.Columns.Add("uc", System.Type.GetType("System.Int32"), "")
            servicios.Columns.Add("ucid", System.Type.GetType("System.Int32"), "")
            servicios.Columns.Add("tipo_oferta_id", System.Type.GetType("System.Int32"), "")
            servicios.Columns.Add("n", System.Type.GetType("System.Double"), "")
            servicios.Columns.Add("m", System.Type.GetType("System.Double"), "")
            servicios.Columns.Add("impuesto_incluido", System.Type.GetType("System.Int32"), "")

            'TODO obtener las ofertas automaticas posibles
            cmd.Parameters.Clear()
            'Console.WriteLine(Join(contratos.ToArray, ","))
            Dim contratosParam As New MySqlParameter("@contrato_id", Join(contratos.ToArray, ","))
            cmd.Parameters.Add(contratosParam)

            Dim ofertas As DataTableReader = getDataTable(cmd, sqlOfertasContratos, True)

            'TODO filtrar solo las ofertas que se podrian aplicar


            While ofertas.Read
                'todo leer la rejilla de esa oferta
                cmd.Parameters.Clear()
                'Console.WriteLine(Join(contratos.ToArray, ","))
                Dim oferta_idParam As New MySqlParameter("@oferta_id", ofertas.Item("oferta_id"))
                cmd.Parameters.Add(oferta_idParam)

                Dim rejilla As DataTable = getTable(cmd, sqlOfertasRejilla, True)

                'cuenta lineas
                Dim filtro As String = "1=1"
                'javier.nunez.casanovas:  días de antelación es número de días entre fecha de llegada y fecha de reserva
                'If Not IsDBNull(ofertas.Item("ttoo_id")) Then
                '    filtro &= " and " & ttoo_id & "=" & ofertas.Item("ttoo_id")
                'End If
                If Not IsDBNull(ofertas.Item("dias_de_antelacion")) Then
                    filtro &= " and dias_antelacion>=" & ofertas.Item("dias_de_antelacion")
                End If
                'todo dias minimos estancia
                If Not IsDBNull(ofertas.Item("estancia_minima_dias")) Then
                    filtro &= " and dias_estancia>=" & ofertas.Item("estancia_minima_dias")
                End If
                'todo dias maximo estancia
                If Not IsDBNull(ofertas.Item("estancia_maxima_dias")) Then
                    filtro &= " and dias_estancia<=" & ofertas.Item("estancia_maxima_dias")
                End If
                'todo añadir fechas en el filtro
                'fecha_reserva
                If Not IsDBNull(ofertas.Item("fecha_reserva_desde")) Then
                    filtro &= " and fecha_reserva>='" & ofertas.Item("fecha_reserva_desde") & " '"
                End If
                If Not IsDBNull(ofertas.Item("fecha_reserva_hasta")) Then
                    filtro &= " and fecha_reserva<='" & ofertas.Item("fecha_reserva_hasta") & " '"
                End If
                Dim campofecha As String = "fecha"
                If ofertas.Item("tipo_aplicacion_oferta_id") = "L" Then
                    campofecha = "fecha_llegada"
                End If
                If Not IsDBNull(ofertas.Item("fecha_desde")) Then
                    filtro &= " and " & campofecha & ">='" & ofertas.Item("fecha_desde") & " '"
                End If
                If Not IsDBNull(ofertas.Item("fecha_hasta")) Then
                    filtro &= " and " & campofecha & "<='" & ofertas.Item("fecha_hasta") & " '"
                End If
                If Not IsDBNull(ofertas.Item("unidad_calculo_id")) Then
                    'si es un uc que contiene..subdividir
                    'de donde leo? cachedUCHijas
                    Dim z As String
                    z = Join(obtieneUCHijas(cmd, ofertas.Item("unidad_calculo_id")).ToArray, ",")
                    filtro &= " and ucid1 in (" & z & " )"
                End If
                If Not IsDBNull(ofertas.Item("servicio_id")) Then
                    filtro &= " and servicio_id=" & ofertas.Item("servicio_id")
                End If
                If Not IsDBNull(ofertas.Item("tipo_servicio_id")) Then
                    filtro &= " and tipo_servicio_id=" & ofertas.Item("tipo_servicio_id")
                End If
                Dim filasACambiar As DataRow()
                'todo obtener filas que podrian cambiar con esta oferta en vez del numero
                'Console.Write(filtro & "-")
                filasACambiar = resultado.servicios.Select(filtro)
                'Console.WriteLine(filasACambiar.Length)
                Dim filaOferta As DataRow() = datos.Tables(0).Select("oferta_id=" & ofertas.Item("oferta_id"))
                If filasACambiar.Length > 0 Then
                    'existen servicios con esas combinaciones
                    Dim nueva = False
                    If filaOferta.Length = 0 Then
                        'no existe asi ke creamos la fila
                        'siempre que la reserva no este blokeada
                        Dim row As DataRow = datos.Tables(0).Rows.Add()
                        row.Item("oferta_id") = ofertas.Item("oferta_id")
                        row.Item("reserva_id") = reserva_id
                        If ofertas.Item("aplicable_auto") = 1 Then
                            row.Item("tipo") = "A"
                            row.Item("activa") = 1
                        Else
                            row.Item("tipo") = "M"
                            row.Item("activa") = 0
                        End If
                        nueva = True
                    End If
                Else
                    'no existe...borrar si existia en reservas_ofertas
                    'siempre que la reserva no este blokeada
                    If filaOferta.Length <> 0 Then
                        filaOferta(0).Delete()
                    End If
                End If
                filaOferta = datos.Tables(0).Select("activa=1 and oferta_id=" & ofertas.Item("oferta_id"))
                'todo comprobar que cumple las condiciones
                Dim cumple As Boolean = cumpleCondicionesOfertas(cmd, ofertas.Item("oferta_id"), ucHijas)
                If cumple And filaOferta.Length > 0 Then
                    'TODO aplicar oferta a todas esas filas
                    'siempre que exista en reservas_ofertas

                    'cambio estructura tabla
                    'chapu cambiar por parametro a la llamada funcion

                    'resetear todas las filas
                    'todo cambiar a al otro loop
                    Dim enu As IEnumerator
                    enu = servicios.Rows.GetEnumerator()
                    While enu.MoveNext
                        Dim row As DataRow = enu.Current
                        row.Item("tipo") = DBNull.Value
                        row.Item("grupo") = DBNull.Value
                        row.Item("uc") = DBNull.Value
                        row.Item("ucid") = DBNull.Value
                        row.Item("tipo_oferta_id") = DBNull.Value
                        row.Item("n") = DBNull.Value
                        row.Item("m") = DBNull.Value
                        row.Item("impuesto_incluido") = DBNull.Value
                    End While



                    '                filasACambiar = servicios.Select(filtro)
                    enu = filasACambiar.GetEnumerator()
                    Dim impuesto_incluido As Boolean = ofertas.Item("impuesto_incluido")
                    While enu.MoveNext
                        'todo solo elegir fechas que esten dentro de la oferta
                        Dim row As DataRow = enu.Current
                        If Not IsDBNull(ofertas.Item("precio")) Then
                            row.Item("precio") = ofertas.Item("precio")
                            row.Item("importe") = row.Item("cantidad") * row.Item("precio")
                        End If
                        row.Item("tipo") = 0
                        'todo crear un grupo ke coincida con esa linea
                        row.Item("grupo") = row.Item("mgrupo")
                        'todo revisar
                        If ofertas.Item("ambito_oferta_id") = 1 Then
                            row.Item("ambito_id") = 1
                        Else
                            row.Item("ambito_id") = 2
                        End If
                        row.Item("ucid") = ofertas.Item("unidad_calculo_id")
                        row.Item("tipo_oferta_id") = ofertas.Item("tipo_oferta_id")
                        row.Item("n") = ofertas.Item("n")
                        'si m es euros.y si tiene impuestos incluidos recalcular m
                        row.Item("m") = ofertas.Item("m")
                        row.Item("impuesto_incluido") = impuesto_incluido
                        'todo meter rejilla ofertas
                        row.Item("rejilla") = rejilla
                    End While
                    resultado.recalculaImportePorGrupo()
                    'todo agrupar por ucid,fecha,servicio en cada ciclo de ofertas
                    'servicios.AcceptChanges()
                End If
            End While


            If datos.HasChanges Then
                'TODO actualizar si ha cambiado
                Dim writer As MySqlDataAdapter
                writer = getDataAdapter(cmd, sqlReservasOfertas)
                writer.Fill(datos.Tables(0))
                writer.Update(datos.Tables(0))
            End If
            servicios.Columns.Remove("ambito_id")
            servicios.Columns.Remove("tipo")
            servicios.Columns.Remove("grupo")
            servicios.Columns.Remove("uc")
            servicios.Columns.Remove("ucid")
            servicios.Columns.Remove("tipo_oferta_id")
            servicios.Columns.Remove("n")
            servicios.Columns.Remove("m")

            servicios.Columns("ambito_id1").ColumnName = "ambito_id"
            servicios.Columns("tipo1").ColumnName = "tipo"
            servicios.Columns("grupo1").ColumnName = "grupo"
            servicios.Columns("uc1").ColumnName = "uc"
            servicios.Columns("ucid1").ColumnName = "ucid"
            servicios.Columns("tipo_oferta_id1").ColumnName = "tipo_oferta_id"
            servicios.Columns("n1").ColumnName = "n"
            servicios.Columns("m1").ColumnName = "m"
            Return datos.Tables(0)
        End Function
        Shared sqlObtieneImpuestoIncluido = "select impuesto_incluido from contratos where contrato_id=?"
        Shared sqlTablaServicioContrato = "" _
    & " SELECT" _
    & " lineas_de_contrato.*, " _
    & " servicios.nombre_servicio, " _
    & " servicios.tipo_servicio_id," _
    & " tipos_de_oferta.Oferta, " _
    & " unidades_calculo.descripcion_unidad_calculo, " _
    & " frecuencia_facturacion.descripcion as descripcion_frecuencia_id, " _
    & " tipos_de_imputacion.imputacion " _
    & " FROM lineas_de_contrato " _
    & " Left Join servicios ON servicios.servicio_id = lineas_de_contrato.servicio_id " _
    & " Left Join tipos_de_oferta ON lineas_de_contrato.tipo_oferta_id = tipos_de_oferta.tipo_oferta_id " _
    & " Left Join unidades_calculo ON lineas_de_contrato.unidad_calculo_id = unidades_calculo.unidad_calculo_id " _
    & " Left Join frecuencia_facturacion ON lineas_de_contrato.frecuencia_id = frecuencia_facturacion.frecuencia_id " _
    & " Left Join tipos_de_imputacion ON lineas_de_contrato.tipo_imputacion_id = tipos_de_imputacion.tipo_imputacion_id " _
    & " WHERE lineas_de_contrato.contrato_id =?"

        Shared sqlTablaServicioContratoOld = "" _
    & " SELECT" _
    & " lineas_de_contrato.*, " _
    & " servicios.nombre_servicio, " _
    & " servicios.tipo_servicio_id," _
    & " tipos_de_oferta.Oferta, " _
    & " unidades_calculo.descripcion_unidad_calculo, " _
    & " frecuencia_facturacion.descripcion as descripcion_frecuencia_id, " _
    & " tipos_de_imputacion.imputacion " _
    & " FROM " _
    & " servicios " _
    & " Left Join lineas_de_contrato ON servicios.servicio_id = lineas_de_contrato.servicio_id and lineas_de_contrato.contrato_id =?" _
    & " Left Join tipos_de_oferta ON lineas_de_contrato.tipo_oferta_id = tipos_de_oferta.tipo_oferta_id " _
    & " Left Join unidades_calculo ON lineas_de_contrato.unidad_calculo_id = unidades_calculo.unidad_calculo_id " _
    & " Left Join frecuencia_facturacion ON lineas_de_contrato.frecuencia_id = frecuencia_facturacion.frecuencia_id " _
    & " Left Join tipos_de_imputacion ON lineas_de_contrato.tipo_imputacion_id = tipos_de_imputacion.tipo_imputacion_id " _
    & "  WHERE " _
    & " servicios.servicio_id  =  ? "
        Shared camposDias() As String = {"Domingo", "Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado"}


        Private Function obtieneTablaServicioContrato(ByVal cmd As MySqlCommand, ByVal ucHijas As DataSet, ByVal contrato_id As Integer, ByVal servicio_id As Integer, ByVal unidad_calculo_id As Integer, ByVal UCServicio As String, ByVal cantidad As Single, ByVal fecha_ini As Date, ByVal fecha_fin As Date, ByVal grupo As Integer, ByVal ucs As DataSet, ByVal porcimpuesto As Decimal, Optional ByVal defecto As Boolean = False, Optional ByVal precio_servicio As Object = Nothing, Optional ByVal dvcontrato As DataView = Nothing) As tablaServicios
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim contrato_idParam As New MySqlParameter("@contrato_id", contrato_id)
            cmd.Parameters.Add(contrato_idParam)
            Dim impuesto_incluido As Boolean = ExecuteScalar(cmd, sqlObtieneImpuestoIncluido, True)
            Dim reader As DataTableReader
            Dim resultado As New tablaServicios
            resultado.servicios.BeginLoadData()
            Try
                If IsNothing(dvcontrato) Then
                    Dim subds As DataSet = getDataSet(cmd, sqlTablaServicioContrato, True)
                    Dim dv As DataView = New DataView(subds.Tables(0), "servicio_id=" & servicio_id, "", DataViewRowState.CurrentRows)
                    reader = dv.ToTable.CreateDataReader()
                Else
                    dvcontrato.RowFilter = "servicio_id=" & servicio_id
                    'dvcontrato.GetEnumerator()
                    reader = dvcontrato.ToTable.CreateDataReader()
                End If
                Dim dsCondContratos As DataView = Nothing
                Try
                    Dim tmpcheckcond As DataTable = getDataSet(cmd, sqlCondicionesContratos, True).tables(0)
                    If tmpcheckcond.Rows.Count > 0 Then
                        dsCondContratos = New DataView(tmpcheckcond)
                    End If
                Catch ex As Exception
                    ' No existe condiciones_linea_contrato, me la suda no sirve de nada
                End Try

                'reader = getDataTable(cmd, sqlTablaServicioContrato, True) 'cmd.ExecuteReader()
                Dim desdecol As Integer = reader.GetOrdinal("desde")
                Dim hastacol As Integer = reader.GetOrdinal("hasta")
                Dim tipoimpucol As Integer = reader.GetOrdinal("tipo_imputacion_id")
                Dim frecol As Integer = reader.GetOrdinal("frecuencia_id")
                Dim tipoofertacol As Integer = reader.GetOrdinal("tipo_oferta_id")
                Dim o_linea_contrato_id As Integer = reader.GetOrdinal("linea_contrato_id")
                Dim o_unidad_calculo_id As Integer = reader.GetOrdinal("unidad_calculo_id")

                Using reader
                    Dim ttabla As New tablaServicios
                    Dim fini As Date
                    Dim ffin As Date
                    Dim tipo As Integer
                    Dim uc As Integer
                    Dim descripcion As String
                    Dim tipo_oferta_id As Integer
                    Dim noreg As Boolean
                    Dim desc_oferta As String
                    ttabla.servicios.BeginLoadData()
                    Dim contareader As Integer = 0
                    Dim tenialineas As Boolean = reader.HasRows
                    'si no tiene lineas crear una ficticia ke dara error siempre
                    If Not tenialineas Then
                        Dim dt As DataTable = dvcontrato.ToTable()
                        dt.Clear()
                        dt.Rows.Add(dvcontrato.Table.Rows(0).ItemArray)
                        'dt.Columns.Item("desde").AllowDBNull = True
                        'dt.Columns.Item("hasta").AllowDBNull = True
                        Dim x As Integer
                        For x = 0 To dt.Rows(0).ItemArray.Length - 1
                            Try
                                dt.Columns(x).AllowDBNull = True
                                dt.Rows(0).Item(x) = System.DBNull.Value
                                'dt.Rows(0).Item(x) = 0
                            Catch ex As Exception
                                Dim xxxxx As Integer = 0
                            End Try

                        Next
                        cmd.Parameters.Clear()
                        Dim servicio_idParam As New MySqlParameter("@servicio_id", servicio_id)
                        cmd.Parameters.Add(servicio_idParam)
                        Dim sql As String = "SELECT nombre_servicio FROM servicios WHERE servicio_id = ? "
                        dt.Rows(0).Item("nombre_servicio") = "No Existe Servicio"
                        Try
                            dt.Rows(0).Item("nombre_servicio") = ExecuteScalar(cmd, sql, True)
                        Catch ex As Exception

                        End Try


                        dt.AcceptChanges()

                        reader = New DataTableReader(dt)
                    End If

                    While reader.Read

                        'todo comprobar condiciones si las hubiese
                        Dim cumple As Boolean = True
                        Dim pertenece As Boolean = True

                        If Not IsNothing(dsCondContratos) And Not IsDBNull(reader.Item(o_linea_contrato_id)) Then
                            'cumple = cumpleCondicionesLineaContrato(cmd, reader.Item(o_linea_contrato_id), ucs)
                            dsCondContratos.RowFilter = "linea_contrato_id=" & reader.Item(o_linea_contrato_id)
                            cumple = cumpleCondiciones(dsCondContratos.ToTable.CreateDataReader, ucs)
                        End If
                        If cumple And Not IsDBNull(reader.Item(o_unidad_calculo_id)) Then
                            pertenece = perteneceUC(ucHijas, reader.Item(o_unidad_calculo_id), unidad_calculo_id)
                        End If


                        fini = fecha_ini
                        ffin = fecha_fin
                        If Not reader.IsDBNull(tipoimpucol) Then
                            tipo = reader.Item(tipoimpucol)
                        Else
                            tipo = 0
                        End If
                        If Not reader.IsDBNull(frecol) Then
                            uc = reader.Item(frecol)
                        Else
                            uc = 2 'diario
                        End If
                        If reader.IsDBNull(tipoofertacol) Then
                            tipo_oferta_id = 0
                        Else
                            tipo_oferta_id = reader.Item(tipoofertacol)
                        End If

                        Select Case uc
                            Case 1
                                'si uc es una vez
                                If tipo = 2 Then
                                    'si se imputa a la salida
                                    'que pasara si la fecha fini =fecha fin?
                                    'fini = fecha_fin.AddDays(-1)
                                Else
                                    'si se imputa a la llegada o prorrateado (seria error)
                                    'ffin = fini.AddDays(1)
                                End If
                            Case 2
                                'si uc es diario
                                tipo = 0
                        End Select

                        descripcion = reader.Item("nombre_servicio")
                        desc_oferta = reader.Item("Oferta") & "(" & reader.Item("n") & "," & reader.Item("m") & ")"
                        Dim noregori As Boolean
                        'comprobar que exista entrada en lineas de contrato
                        noregori = (reader.IsDBNull(desdecol) Or reader.IsDBNull(hastacol))
                        If noregori = False Then
                            'comprobar que el dia de la semana esta activo
                            If reader.Item(camposDias(fini.DayOfWeek)) = 0 Then
                                noregori = True
                            End If
                        End If
                        'comprobar que esta entre las fechas

                        'Dim count As Integer = 0
                        Dim precio As Decimal = 0
                        'todo precio_servicio
                        If Not IsNothing(precio_servicio) And Not IsDBNull(precio_servicio) Then
                            precio = precio_servicio
                        Else
                            If reader.IsDBNull(reader.GetOrdinal("importe")) Then
                                precio = 0
                            Else
                                precio = reader.Item("importe")
                            End If
                        End If


                        Dim Row As DataRow = Nothing
                        While fini < ffin
                            'todo llevar un contador de cuantas veces voy ejecutando un servicio
                            If Row Is Nothing Then
                                Row = ttabla.servicios.Rows.Add()
                                With Row
                                    .Item("contrato_id_defecto") = contrato_id & "_" & defecto
                                    .Item("defecto") = defecto
                                    .Item("tipo_servicio_id") = reader.Item("tipo_servicio_id")
                                    .Item("contrato_id") = contrato_id
                                    .Item("desc_oferta") = desc_oferta
                                    .Item("desc_uc") = reader.Item("descripcion_unidad_calculo") 'esta desc esta mal
                                    .Item("desc_uc_reserva") = UCServicio
                                    .Item("desc_frecuencia") = reader.Item("descripcion_frecuencia_id")
                                    .Item("desc_tipo") = reader.Item("imputacion")
                                    .Item("servicio_id") = servicio_id
                                    .Item("cantidad") = cantidad
                                    .Item("grupo") = reader.Item("linea_contrato_id")
                                    .Item("pag_factura") = reader.Item("pag_factura")
                                    .Item("mgrupo") = grupo
                                    .Item("tipo") = tipo
                                    .Item("uc") = uc
                                    .Item("ucid") = unidad_calculo_id 'que hacer?
                                    .Item("ambito_id") = reader.Item("ambito_oferta_id")
                                    .Item("impuesto_incluido") = impuesto_incluido
                                    .Item("porc_impuesto") = porcimpuesto
                                End With
                            Else
                                Row = ttabla.servicios.Rows.Add(Row.ItemArray)
                            End If
                            With Row
                                .Item("fecha") = fini
                                noreg = noregori
                                If noreg = False Then
                                    'comprobar que esta entre las fechas
                                    If Not (fini >= reader.Item("desde") And fini <= reader.Item("hasta")) Then
                                        noreg = True
                                    End If
                                End If
                                If noreg = False And cumple And pertenece Then
                                    .Item("precio") = precio
                                    .Item("tipo_oferta_id") = tipo_oferta_id
                                    .Item("n") = reader.Item("n")
                                    .Item("m") = reader.Item("m")
                                    .Item("importe") = precio * cantidad
                                    .Item("descripcion") = descripcion
                                    .Item("error") = 0
                                Else
                                    .Item("importe") = 0
                                    .Item("descripcion") = "Error-" & descripcion
                                    .Item("error") = 1
                                End If
                            End With
                            fini = fini.AddDays(1)
                        End While

                        If ttabla.servicios.Rows.Count > 0 Then
                            ttabla.recalculaImportePorGrupo()
                            resultado.sumaTabla(ttabla)
                            'resultado.agregaTabla(ttabla, True)
                            ttabla.limpiar()
                        End If
                        'End If
                    End While

                    ttabla.servicios.EndLoadData()
                End Using
            Catch ex As Exception
                errorCode = -1
                AgregaInfo("obtieneTableServicioContrato", "Excepcion:" & ex.Message, -errorCode)

            Finally

            End Try
            resultado.servicios.EndLoadData()
            If errorCode = 0 Then
            Else
                resultado = Nothing
            End If

            Return resultado
        End Function
        'Shared sqlObtieneCuposClienteDia = "" _
        '& " select cupos.cliente_id,sum(cupos.cupo) as habitaciones_disponibles,sum(cupo*tipos_habitacion.numero_personas) as CapacidadHotel,sum(cupos.cupo*cupos.garantia/100) as garantia from  " _
        '& " ( select max(cupo_id) as cupo_id from " _
        '& " ( SELECT cupos.cliente_id,cupos.cupo_id,cupos.tipo_habitacion_id FROM cupos WHERE cupos.hotel_id =  ? AND (cupos.cliente_id =  ? or ?=0) and (tipo_habitacion_id=? or 0=? ) AND  ? between cupos.fecha_desde and cupos.fecha_hasta " _
        '& " ) drv group by drv.cliente_id,drv.tipo_habitacion_id" _
        '& " ) drv2 inner join  cupos on drv2.cupo_id=cupos.cupo_id inner join tipos_habitacion on cupos.tipo_habitacion_id=tipos_habitacion.tipo_habitacion_id group by cupos.cliente_id"
        Shared sqlObtieneCuposClienteDia = "SELECT cupos.cliente_id,sum(cupos.cupo)AS habitaciones_disponibles,sum(cupo*tipos_habitacion.numero_personas) AS CapacidadHotel,sum(cupos.cupo*cupos.garantia/100) AS garantia " _
        & "FROM cupos INNER JOIN tipos_habitacion ON cupos.tipo_habitacion_id=tipos_habitacion.tipo_habitacion_id " _
        & "WHERE cupos.hotel_id =  ? AND (cupos.cliente_id =  ? or ?=0) AND (cupos.tipo_habitacion_id=? or 0=? ) AND  ? BETWEEN cupos.fecha_desde AND cupos.fecha_hasta " _
        & "GROUP BY  cupos.cliente_id "

        Private Function ObtieneCupoClienteDia(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal fecha As Date, Optional ByVal tipo_habitacion_id As Integer = 0)
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0

            cmd.Parameters.Clear()
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim cliente_id1Param As New MySqlParameter("@cliente_id1", cliente_id)
            Dim fechaParam As New MySqlParameter("@fecha", convertFecha(fecha))
            Dim tipo_habitacion_idParam As New MySqlParameter("@tipo_habitacion_id", tipo_habitacion_id)
            Dim tipo_habitacion_id1Param As New MySqlParameter("@tipo_habitacion_id1", tipo_habitacion_id)
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(cliente_idParam)
            cmd.Parameters.Add(cliente_id1Param)
            cmd.Parameters.Add(tipo_habitacion_idParam)
            cmd.Parameters.Add(tipo_habitacion_id1Param)
            cmd.Parameters.Add(fechaParam)
            'Return Me.ExecuteScalar(cmd, sqlObtieneCuposClienteDia)
            Dim datos As DataTableReader = Me.getDataTable(cmd, sqlObtieneCuposClienteDia)
            If cliente_id <> 0 Then


                Dim dev(1) As Integer
                dev(0) = 0
                dev(1) = 0
                While datos.Read
                    'Return Me.ExecuteScalar(cmd, sqlObtienetHabitacionesDisponibles)
                    dev(0) += datos.Item("habitaciones_disponibles")
                    Try
                        dev(1) += datos.Item("CapacidadHotel")
                    Catch ex As Exception

                    End Try

                End While
                Return dev
            Else
                Return Me.readerToTable(datos)

            End If
        End Function
        Shared sqlPlanningMensual = "" _
& " select tipos_habitacion.tipo_habitacion_id AS tipo_habitacion_id,tipos_habitacion.desc_corta AS TIPO_HABITACION,0 AS AGENCIA,'' AS NOMBRE_AGENCIA,hoteles.hotel AS Nombre_Hotel," _
& "  0 as DISPONIBLES_1, 0 as DISPONIBLES_2, 0 as DISPONIBLES_3, 0 as DISPONIBLES_4, 0 as DISPONIBLES_5, 0 as DISPONIBLES_6, 0 as DISPONIBLES_7, 0 as DISPONIBLES_8, 0 as DISPONIBLES_9, 0 as DISPONIBLES_10, 0 as DISPONIBLES_11, 0 as DISPONIBLES_12, 0 as DISPONIBLES_13, 0 as DISPONIBLES_14, 0 as DISPONIBLES_15, 0 as DISPONIBLES_16, 0 as DISPONIBLES_17, 0 as DISPONIBLES_18, 0 as DISPONIBLES_19, 0 as DISPONIBLES_20, 0 as DISPONIBLES_21, 0 as DISPONIBLES_22, 0 as DISPONIBLES_23, 0 as DISPONIBLES_24, 0 as DISPONIBLES_25, 0 as DISPONIBLES_26, 0 as DISPONIBLES_27, 0 as DISPONIBLES_28, 0 as DISPONIBLES_29, 0 as DISPONIBLES_30, 0 as DISPONIBLES_31," _
& "  0 as RESERVAS_1, 0 as RESERVAS_2, 0 as RESERVAS_3, 0 as RESERVAS_4, 0 as RESERVAS_5, 0 as RESERVAS_6, 0 as RESERVAS_7, 0 as RESERVAS_8, 0 as RESERVAS_9, 0 as RESERVAS_10, 0 as RESERVAS_11, 0 as RESERVAS_12, 0 as RESERVAS_13, 0 as RESERVAS_14, 0 as RESERVAS_15, 0 as RESERVAS_16, 0 as RESERVAS_17, 0 as RESERVAS_18, 0 as RESERVAS_19, 0 as RESERVAS_20, 0 as RESERVAS_21, 0 as RESERVAS_22, 0 as RESERVAS_23, 0 as RESERVAS_24, 0 as RESERVAS_25, 0 as RESERVAS_26, 0 as RESERVAS_27, 0 as RESERVAS_28, 0 as RESERVAS_29, 0 as RESERVAS_30, 0 as RESERVAS_31 ," _
& "  0 as LIBRES_1, 0 as LIBRES_2, 0 as LIBRES_3, 0 as LIBRES_4, 0 as LIBRES_5, 0 as LIBRES_6, 0 as LIBRES_7, 0 as LIBRES_8, 0 as LIBRES_9, 0 as LIBRES_10, 0 as LIBRES_11, 0 as LIBRES_12, 0 as LIBRES_13, 0 as LIBRES_14, 0 as LIBRES_15, 0 as LIBRES_16, 0 as LIBRES_17, 0 as LIBRES_18, 0 as LIBRES_19, 0 as LIBRES_20, 0 as LIBRES_21, 0 as LIBRES_22, 0 as LIBRES_23, 0 as LIBRES_24, 0 as LIBRES_25, 0 as LIBRES_26, 0 as LIBRES_27, 0 as LIBRES_28, 0 as LIBRES_29, 0 as LIBRES_30, 0 as LIBRES_31" _
& "," _
& " 0 as VDISPONIBLES_1, 0 as VDISPONIBLES_2, 0 as VDISPONIBLES_3, 0 as VDISPONIBLES_4, 0 as VDISPONIBLES_5, 0 as VDISPONIBLES_6, 0 as VDISPONIBLES_7, 0 as VDISPONIBLES_8, 0 as VDISPONIBLES_9, 0 as VDISPONIBLES_10, 0 as VDISPONIBLES_11, 0 as VDISPONIBLES_12, 0 as VDISPONIBLES_13, 0 as VDISPONIBLES_14, 0 as VDISPONIBLES_15, 0 as VDISPONIBLES_16, 0 as VDISPONIBLES_17, 0 as VDISPONIBLES_18, 0 as VDISPONIBLES_19, 0 as VDISPONIBLES_20, 0 as VDISPONIBLES_21, 0 as VDISPONIBLES_22, 0 as VDISPONIBLES_23, 0 as VDISPONIBLES_24, 0 as VDISPONIBLES_25, 0 as VDISPONIBLES_26, 0 as VDISPONIBLES_27, 0 as VDISPONIBLES_28, 0 as VDISPONIBLES_29, 0 as VDISPONIBLES_30, 0 as VDISPONIBLES_31, " _
& " 0 as VRESERVAS_1, 0 as VRESERVAS_2, 0 as VRESERVAS_3, 0 as VRESERVAS_4, 0 as VRESERVAS_5, 0 as VRESERVAS_6, 0 as VRESERVAS_7, 0 as VRESERVAS_8, 0 as VRESERVAS_9, 0 as VRESERVAS_10, 0 as VRESERVAS_11, 0 as VRESERVAS_12, 0 as VRESERVAS_13, 0 as VRESERVAS_14, 0 as VRESERVAS_15, 0 as VRESERVAS_16, 0 as VRESERVAS_17, 0 as VRESERVAS_18, 0 as VRESERVAS_19, 0 as VRESERVAS_20, 0 as VRESERVAS_21, 0 as VRESERVAS_22, 0 as VRESERVAS_23, 0 as VRESERVAS_24, 0 as VRESERVAS_25, 0 as VRESERVAS_26, 0 as VRESERVAS_27, 0 as VRESERVAS_28, 0 as VRESERVAS_29, 0 as VRESERVAS_30, 0 as VRESERVAS_31 , " _
& " 0 as VLIBRES_1, 0 as VLIBRES_2, 0 as VLIBRES_3, 0 as VLIBRES_4, 0 as VLIBRES_5, 0 as VLIBRES_6, 0 as VLIBRES_7, 0 as VLIBRES_8, 0 as VLIBRES_9, 0 as VLIBRES_10, 0 as VLIBRES_11, 0 as VLIBRES_12, 0 as VLIBRES_13, 0 as VLIBRES_14, 0 as VLIBRES_15, 0 as VLIBRES_16, 0 as VLIBRES_17, 0 as VLIBRES_18, 0 as VLIBRES_19, 0 as VLIBRES_20, 0 as VLIBRES_21, 0 as VLIBRES_22, 0 as VLIBRES_23, 0 as VLIBRES_24, 0 as VLIBRES_25, 0 as VLIBRES_26, 0 as VLIBRES_27, 0 as VLIBRES_28, 0 as VLIBRES_29, 0 as VLIBRES_30, 0 as VLIBRES_31 " _
& " FROM hoteles Inner Join tipos_habitacion_hotel ON hoteles.hotel_id = tipos_habitacion_hotel.hotel_id Inner Join tipos_habitacion ON tipos_habitacion_hotel.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id where hoteles.hotel_id=?"
        Private Sub HiloPlanningGeneral(ByVal blosta As Object)

            Dim estado() As Object
            SyncLock blosta.syncroot
                Try
                    estado = blosta.Dequeue
                Catch ex As Exception
                    estado = Nothing
                    Return
                End Try
            End SyncLock
            If IsNothing(estado) Then
                Return
            End If
            Dim z As New GesHotelClase(Me.userId)
            Dim limpiar As Boolean = False
            Dim cmd As MySqlCommand = Nothing
            If IsNothing(cmd) Then
                cmd = prepareConection(IsolationLevel.RepeatableRead)
                limpiar = True
            End If



            While Not estado Is Nothing
                Try
                    estado(1) = ObtienePlanningDiario(cmd, estado(2), estado(3), estado(4), estado(5), estado(6), estado(7), estado(8), False, estado(10)).Tables(0).CreateDataReader()
                    'estado(1) = ObtienePlanningDiario(cmd, estado(2), estado(3), estado(4), estado(5), estado(6), estado(7), estado(8)).Tables(0).CreateDataReader()
                Catch ex As Exception
                    Console.WriteLine("jare!")
                End Try
                estado(9).Enqueue(estado)
                SyncLock blosta.syncroot
                    Try
                        estado = blosta.Dequeue
                    Catch ex As Exception
                        estado = Nothing
                    End Try
                End SyncLock
            End While
            If limpiar Then
                flushConection(cmd, 1)
            End If

        End Sub
        Public Function ObtienePlanningMensual(ByVal hotel_id As Integer, ByVal ano As Integer, ByVal mes As Integer, Optional ByVal cliente_id As Integer = 0, Optional ByVal garantia As Integer = 0) As DataSet
            Dim fini As Date = New Date(ano, mes, 1)
            Dim ffin As Date = fini.AddMonths(1)
            Return ObtienePlanningMensual(fini, ffin, hotel_id, cliente_id, garantia)
        End Function
        Public Function ObtienePlanningMensual(ByVal fini As Date, ByVal ffin As Date, ByVal hotel_id As Integer, Optional ByVal cliente_id As Integer = 0, Optional ByVal garantia As Integer = 0, Optional ByVal afecha As Date = Nothing) As DataSet
            'ThreadPool.SetMaxThreads(8, 8)
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection(IsolationLevel.RepeatableRead)
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            Dim datos As DataSet = getDataSet(cmd, sqlPlanningMensual)

            'Dim datosTiposHab As DataTableReader = getDataSet(cmd, sqlTipoHabitacionServicioHotel).Tables(0).CreateDataReader
            Dim tabla As DataTable = datos.Tables(0)
            Dim x As Integer
            Dim caches As New Hashtable
            Dim restab As New Queue
            Dim fintab As New Queue
            Dim reader As DataTableReader
            'Dim fini As Date = New Date(ano, mes, 1)
            'Dim ffin As Date = fini.AddMonths(1)
            Dim contador As Integer = tabla.Rows.Count

            For x = 0 To tabla.Rows.Count - 1
                'While datosTiposHab.Read
                Dim row As DataRow = tabla.Rows(x)
                Console.WriteLine(row.Item("tipo_habitacion_id"))
                Dim mato(11) As Object
                mato(0) = row
                mato(2) = hotel_id
                mato(3) = fini
                mato(4) = ffin
                mato(5) = garantia
                mato(6) = cliente_id
                mato(7) = row.Item("tipo_habitacion_id")
                mato(8) = caches
                mato(9) = fintab
                mato(10) = afecha
                restab.Enqueue(mato)
                If x = 0 Or 0 = 1 Then
                    HiloPlanningGeneral(restab)
                    'reader = ObtienePlanningDiario(cmd, hotel_id, fini, ffin, garantia, cliente_id, row.Item("tipo_habitacion_id"), caches).Tables(0).CreateDataReader()
                    ' = reader
                End If
            Next
            Dim maxthreads As Integer = 3
            While maxthreads > 0
                maxthreads -= 1
                ThreadPool.QueueUserWorkItem(AddressOf HiloPlanningGeneral, restab)
            End While

            'End While
            Dim mat(11) As Object
            mat = fintab.Dequeue()
            While Not IsNothing(mat)
                Dim row As DataRow
                row = mat(0)
                reader = mat(1)
                Dim dia As Integer
                While reader.Read
                    dia = DateDiff(DateInterval.DayOfYear, fini, CDate(reader.Item("fecha"))) + 1
                    'dia = CDate(reader.Item("fecha")).Day
                    Dim desvio = ExecuteScalar(cmd, "SELECT desvios FROM tipos_habitacion WHERE desc_corta='" & reader.Item("TIPO_HABITACION") & "'")
                    If desvio = 0 Then 'cambiar por un flag cambiado 24/12/14 anterior If reader.Item("TIPO_HABITACION") <> "DES" Then
                        row("DISPONIBLES_" & dia) = reader.Item("disponibles")
                        row("RESERVAS_" & dia) = reader.Item("ocupadas")
                        row("LIBRES_" & dia) = reader.Item("libres")
                    Else
                        row("DISPONIBLES_" & dia) = 0
                        row("RESERVAS_" & dia) = 0
                        row("LIBRES_" & dia) = 0
                    End If

                    row("VDISPONIBLES_" & dia) = reader.Item("disponibles")
                    row("VRESERVAS_" & dia) = reader.Item("ocupadas")
                    row("VLIBRES_" & dia) = reader.Item("libres")
                End While
                contador -= 1
                mat = Nothing
                While contador > 0 And IsNothing(mat)
                    Try
                        mat = fintab.Dequeue()
                    Catch ex As Exception
                        'todo sleep
                        HiloPlanningGeneral(restab)
                        If fintab.Count = 0 Then
                            Thread.Sleep(100)
                        End If
                    End Try
                End While
            End While
            flushConection(cmd, 0)
            tabla.AcceptChanges()
            Return datos

        End Function
        Public Function ObtienePlanningMensualOld(ByVal hotel_id As Integer, ByVal ano As Integer, ByVal mes As Integer, Optional ByVal cliente_id As Integer = 0, Optional ByVal garantia As Integer = 0) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            Dim datos As DataSet = getDataSet(cmd, sqlPlanningMensual)
            'Dim datosTiposHab As DataTableReader = getDataSet(cmd, sqlTipoHabitacionServicioHotel).Tables(0).CreateDataReader
            Dim tabla As DataTable = datos.Tables(0)
            Dim x As Integer
            Dim caches As New Hashtable
            For x = 0 To tabla.Rows.Count - 1
                'While datosTiposHab.Read
                Dim row As DataRow = tabla.Rows(x)
                Dim fini As Date = New Date(ano, mes, 1)
                Dim ffin As Date = fini.AddMonths(1)
                Console.WriteLine(row.Item("tipo_habitacion_id"))
                Dim reader As DataTableReader = ObtienePlanningDiario(cmd, hotel_id, fini, ffin, garantia, cliente_id, row.Item("tipo_habitacion_id"), caches).Tables(0).CreateDataReader()
                'pivotar tabla
                'tabla.Clear()

                'Dim rows() As DataRow
                'row = tabla.Rows.Add()
                Dim dia As Integer
                While reader.Read
                    'Dim fecha As Date = 
                    dia = CDate(reader.Item("fecha")).Day
                    'rows = tabla.Select("TIPO_HABITACION='" & reader.Item("TIPO_HABITACION") & "'")
                    'If rows.Length > 0 Then
                    'row = rows(0)
                    row("DISPONIBLES_" & dia) = reader.Item("disponibles")
                    row("RESERVAS_" & dia) = reader.Item("ocupadas")
                    row("LIBRES_" & dia) = reader.Item("libres")
                    'End If
                End While
            Next
            'End While
            flushConection(cmd, errorCode)
            tabla.AcceptChanges()
            Return datos

        End Function

        Shared sqlPlaningDiario = "" _
& " select 'H1' as TIPO_HABITACION,'2008-01-01' as fecha, " _
& " 0 as libres, " _
& " 0 as disponibles, " _
& " 0 as ocupadas,0 as ocupadas1,0 as garantia, " _
& " 0.1 as PorHab, " _
& " 0 as Llegadas, " _
& " 0 as Salidas, " _
& " 0 as TPax,0 as Adultos,0.1 as PorOcup, " _
& " 0 as Bebes, " _
& " 0 as Ninos, " _
& " 0 as Ninos2, " _
& " 0 as SS_A,0 as SS_N1,0 as SS_N2,0 as SS_B," _
& " 0 as HD_A,0 as HD_N1,0 as HD_N2,0 as HD_B, " _
& " 0 as MP_A,0 as MP_N1,0 as MP_N2,0 as MP_B, " _
& " 0 as PC_A,0 as PC_N1,0 as PC_N2,0 as PC_B, " _
& " 0 as TI_A,0 as TI_N1,0 as TI_N2,0 as TI_B, " _
& " 0 as SS, " _
& " 0 as HD, " _
& " 0 as MP, " _
& " 0 as PC," _
& " 0 as TI," _
& " 0 as DE," _
& " 0 as AL," _
& " 0 as CE," _
& " 0 as llegadas_SS,0 as llegadas_HD, 0 as llegadas_MP, 0 as llegadas_PC, 0 as llegadas_TI," _
& " 0 as salidas_SS,0 as salidas_HD, 0 as salidas_MP, 0 as salidas_PC, 0 as salidas_TI " _
& "from hoteles where 1=0"
        Shared sqlObtieneReservasValidasEntreFechas = "" _
& " SELECT " _
& " reservas.reserva_id " _
& " FROM " _
& " reservas " _
& " WHERE " _
& " reservas.estado_reserva_id not in (0,2) and  " _
& " reservas.hotel_id=? and (?=0 or reservas.cliente_id=? ) and ( " _
& " Coalesce(reservas.fecha_llegada,fecha_prevista_llegada) between ? and ?  " _
& " or Coalesce(reservas.fecha_salida,fecha_prevista_salida) between ? and ?" _
& " or ? between Coalesce(reservas.fecha_llegada,fecha_prevista_llegada)  and Coalesce(reservas.fecha_salida,fecha_prevista_salida)" _
& " or ? between Coalesce(reservas.fecha_llegada,fecha_prevista_llegada)  and Coalesce(reservas.fecha_salida,fecha_prevista_salida)" _
& " )" _
& " and (?=0 or reservas.fecha_reserva<=?)"
        Shared sqlObtieneHabitacionesDispHotelEntreFechas = "" _
& " SELECT " _
& " habitaciones.habitacion_id,habitaciones.numero_habitacion,habitaciones.fecha_inicio, " _
& " habitaciones_bloqueos.fecha_desde, " _
& " habitaciones_bloqueos.fecha_hasta, " _
& " habitaciones_bloqueos.tipo_bloqueo_id,habitaciones_bloqueos.reserva_id " _
& " FROM " _
& " habitaciones " _
& " Left Join habitaciones_bloqueos ON habitaciones.habitacion_id = habitaciones_bloqueos.habitacion_id and  (" _
& " ( " _
& "         ?  between habitaciones_bloqueos.fecha_desde and habitaciones_bloqueos.fecha_hasta " _
& " or  ? between habitaciones_bloqueos.fecha_desde and habitaciones_bloqueos.fecha_hasta " _
& " or habitaciones_bloqueos.fecha_desde between ? and ? " _
& " or habitaciones_bloqueos.fecha_hasta between ? and ? " _
& " ) or true=?) " _
& " WHERE " _
& " habitaciones.hotel_id =  ? order by habitaciones.numero_habitacion"
        Shared sqlObtieneHabitacionesHotel = "SELECT habitaciones.habitacion_id,habitaciones.numero_habitacion,habitaciones.fecha_inicio FROM habitaciones WHERE habitaciones.hotel_id = ? order by habitaciones.numero_habitacion"
        Shared sqlTipoHabitacionServicioHotel = "" _
& " SELECT tipos_habitacion.desc_corta,tipos_habitacion.tipo_habitacion_id,tipos_habitacion_hotel.servicio_id " _
& " FROM " _
& " tipos_habitacion_hotel Inner Join tipos_habitacion ON tipos_habitacion_hotel.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id " _
& " WHERE tipos_habitacion_hotel.hotel_id =  ? and (tipos_habitacion.desvios=0 or 1=?)"
        Shared sqlListadoSalidas = "Select 999 As SS,999 AS HD,999 As MP,999 AS PC, 999 AS TI,'' As Hab, 'B1' As tipo_hab, 1 As cant_hab,'Cliente' AS cliente, 'SS' As Regimen,99999 As Reserva,999 As pax, 99 As N1, 99 As N2, 99 As B,'touroperador' As touroperador,'hh:mm' As hora_llegada,'hh:mm' As hora_salida, '31/01/2009' As fecha_llegada,'31/01/2009' As fecha_salida,999 As dias, 'observaciones entrada' As observaciones_llegada,'observaciones salida' As observaciones_salida,'observaciones' As observaciones from hoteles where 1=0"
        Shared sqlListadoSalidasReservasFSal = "select clientes.razon as touroperador,reservas_primer_huesped.razon as huesped,reservas_primer_huesped.numero_habitacion,reservas.reserva_id,datediff(Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida),Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada)) as dias,Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada) as fecha_llegada,Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida) as fecha_salida," _
& " reservas.observaciones,reservas.observaciones_llegada,reservas.observaciones_salida,reservas.hora_prevista_salida as hora_salida,reservas.hora_prevista_llegada as hora_llegada " _
& " from reservas left join clientes on reservas.cliente_id=clientes.cliente_id left join reservas_primer_huesped on reservas.reserva_id=reservas_primer_huesped.reserva_id " _
& " where reservas.hotel_id=? " _
& " and Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida)=? " _
& " and reservas.estado_reserva_id not in (0,2) and (reservas.cliente_id=? or ?=0) order by reservas.cliente_id"
        Shared sqlListadoSalidasReservasFLleg = "select clientes.razon as touroperador,reservas_primer_huesped.razon as huesped,reservas_primer_huesped.numero_habitacion,reservas.reserva_id,datediff(Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida),Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada)) as dias,Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada) as fecha_llegada,Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida) as fecha_salida," _
& " reservas.observaciones,reservas.observaciones_llegada,reservas.observaciones_salida,reservas.hora_prevista_salida as hora_salida,reservas.hora_prevista_llegada as hora_llegada " _
& " from reservas left join clientes on reservas.cliente_id=clientes.cliente_id left join reservas_primer_huesped on reservas.reserva_id=reservas_primer_huesped.reserva_id " _
& " where reservas.hotel_id=? " _
& " and Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada)=? " _
& " and reservas.estado_reserva_id not in (0,2) and (reservas.cliente_id=? or ?=0) order by reservas.cliente_id"

        'Dim sqlListadoReservas = "Select 1 As Hab, 'B1' As tipo_hab, 'Cliente' AS cliente, 99999 As Reserva,999 As pax, 999 As SS,999 AS Des,999 As MP,999 AS PC, 999 AS TI,'touroperador' As touroperador,'hh:mm' As hora_salida, '31/01/2009' As fecha_salida, 'observaciones entrada' As observaciones"
        Shared sqlListadoReservasActivas = "select clientes.razon as touroperador,reservas_primer_huesped.razon as huesped,reservas_primer_huesped.numero_habitacion,reservas.reserva_id,datediff(Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida),Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada)) as dias,Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada) as fecha_llegada,Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida) as fecha_salida," _
& " reservas.observaciones,reservas.observaciones_llegada,reservas.observaciones_salida,reservas.hora_prevista_salida as hora_salida,reservas.hora_prevista_llegada as hora_llegada " _
& " from reservas left join clientes on reservas.cliente_id=clientes.cliente_id left join reservas_primer_huesped on reservas.reserva_id=reservas_primer_huesped.reserva_id " _
& " where reservas.hotel_id=? " _
& " and Coalesce(reservas.fecha_llegada,reservas.fecha_prevista_llegada)<=? and Coalesce(reservas.fecha_salida,reservas.fecha_prevista_salida)>? " _
& " and reservas.estado_reserva_id not in (0,2) and (reservas.cliente_id=? or ?=0) order by reservas.cliente_id"

        Public Function ObtieneListadoReservas(ByVal hotel_id As Integer, ByVal fechaini As Date, Optional ByVal cliente_id As Integer = 0, Optional ByVal orderby As Integer = 0) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim datos As DataSet = getDataSet(cmd, sqlListadoSalidas)
            Try
                cmd.Parameters.Clear()
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
                Dim cliente_id1Param As New MySqlParameter("@cliente_id1", cliente_id)
                Dim fechainiParam As New MySqlParameter("@fechaini", convertFecha(fechaini))
                Dim fechaini1Param As New MySqlParameter("@fechaini1", convertFecha(fechaini))
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fechainiParam)
                cmd.Parameters.Add(fechaini1Param)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(cliente_id1Param)
                Dim reader As DataTableReader = getDataTable(cmd, sqlListadoReservasActivas)
                procesarDatosListado(cmd, reader, datos, fechaini)
                datos.Tables(0).Columns.Add("HabNum", System.Type.GetType("System.Int32"), "1000+Hab")
                Dim dt As DataTable = New DataView(datos.Tables(0), "", "HabNum", DataViewRowState.CurrentRows).ToTable
                datos = New DataSet
                datos.Merge(dt)


            Catch ex As Exception
                datos = getDataSet(cmd, sqlListadoSalidas)
                errorCode = 1
            End Try
            flushConection(cmd, errorCode)
            Return datos
        End Function
        Public Function ObtieneListadoLlegadas(ByVal hotel_id As Integer, ByVal fechaini As Date, Optional ByVal cliente_id As Integer = 0) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim datos As DataSet = getDataSet(cmd, sqlListadoSalidas)
            Try
                cmd.Parameters.Clear()
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
                Dim cliente_id1Param As New MySqlParameter("@cliente_id1", cliente_id)
                Dim fechainiParam As New MySqlParameter("@fechaini", convertFecha(fechaini))
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fechainiParam)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(cliente_id1Param)
                Dim reader As DataTableReader = getDataTable(cmd, sqlListadoSalidasReservasFLleg)
                procesarDatosListado(cmd, reader, datos)
            Catch ex As Exception
                datos = getDataSet(cmd, sqlListadoSalidas)
                errorCode = 1
            End Try
            flushConection(cmd, errorCode)
            Return datos
        End Function


        Public Function ObtieneListadoSalidas(ByVal hotel_id As Integer, ByVal fechaini As Date, Optional ByVal cliente_id As Integer = 0) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim datos As DataSet = getDataSet(cmd, sqlListadoSalidas)
            Try
                cmd.Parameters.Clear()
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
                Dim cliente_id1Param As New MySqlParameter("@cliente_id1", cliente_id)

                Dim fechainiParam As New MySqlParameter("@fechaini", convertFecha(fechaini))
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fechainiParam)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(cliente_id1Param)

                Dim reader As DataTableReader = getDataTable(cmd, sqlListadoSalidasReservasFSal)
                procesarDatosListado(cmd, reader, datos)
            Catch ex As Exception
                datos = getDataSet(cmd, sqlListadoSalidas)
                errorCode = 1
            End Try
            flushConection(cmd, errorCode)
            Return datos
        End Function
        Shared sqlObtieneOfertasReserva = "" _
& " SELECT" _
& " group_concat(ofertas.texto) " _
& " FROM " _
& " reservas_ofertas " _
& " Inner Join ofertas ON reservas_ofertas.oferta_id = ofertas.oferta_id " _
& " WHERE " _
& " reservas_ofertas.reserva_id =  ? AND " _
& " reservas_ofertas.activa =  1 " _
& " group by reservas_ofertas.reserva_id "
        Private Sub procesarDatosListado(ByVal cmd As MySqlCommand, ByVal reader As DataTableReader, ByVal datos As DataSet, Optional ByVal fecha As Object = Nothing)
            While reader.Read
                'If reader.Item("reserva_id") = 2168 Then
                'Dim zk = 0
                'End If
                Dim dr As DatosReserva = obtieneReservaDatosListados(cmd, reader.Item("reserva_id"), fecha)
                cmd.Parameters.Clear()
                'Dim reserva_idParam As New MysqlParameter("@reserva_id", 570)

                Dim reserva_idParam As New MySqlParameter("@reserva_id", reader.Item("reserva_id"))
                cmd.Parameters.Add(reserva_idParam)
                Dim ofe As Object = ExecuteScalar(cmd, sqlObtieneOfertasReserva)
                If IsNothing(ofe) Then
                    ofe = ""
                End If
                Dim row As DataRow = datos.Tables(0).Rows.Add()
                row.Item("Hab") = reader.Item("numero_habitacion")
                row.Item("tipo_hab") = dr.tipo_hab
                row.Item("cant_hab") = dr.cant_hab
                row.Item("cliente") = reader.Item("huesped")
                row.Item("Regimen") = dr.regimen
                row.Item("reserva") = reader.Item("reserva_id")
                row.Item("SS") = dr.SS
                row.Item("HD") = dr.HD
                row.Item("MP") = dr.MP
                row.Item("PC") = dr.PC
                row.Item("TI") = dr.TI

                row.Item("pax") = dr.pax
                row.Item("n1") = dr.n1
                row.Item("n2") = dr.n2
                row.Item("b") = dr.b
                row.Item("touroperador") = reader.Item("touroperador")
                row.Item("hora_salida") = reader.Item("hora_salida")
                row.Item("hora_llegada") = reader.Item("hora_llegada")
                row.Item("fecha_llegada") = CDate(reader.Item("fecha_llegada")).ToShortDateString
                row.Item("fecha_salida") = CDate(reader.Item("fecha_salida")).ToShortDateString
                row.Item("dias") = reader.Item("dias")
                row.Item("observaciones") = reader.Item("observaciones")
                row.Item("observaciones_salida") = reader.Item("observaciones_salida")
                row.Item("observaciones_llegada") = reader.Item("observaciones_llegada") & " " & ofe
                'Dim res As DataTableReader = 
            End While
        End Sub
        Class DatosReserva
            Public SS As Integer
            Public HD As Integer
            Public MP As Integer
            Public PC As Integer
            Public TI As Integer
            Public pax As Integer
            Public a As Integer
            Public n1 As Integer
            Public n2 As Integer
            Public b As Integer
            Public tipo_hab As String
            Public cant_hab As Integer
            Public regimen As String
            Public ofertas As String
            Public bono As String
            Public fecha_desde As Date
            Public fecha_hasta As Date
            Public primer_huesped As String
            Public habitacion As String
        End Class
        Public Function obtieneReservaDatosListados(ByVal reserva_id As Integer) As DatosReserva
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim datos As DatosReserva
            Try
                datos = obtieneReservaDatosListados(cmd, reserva_id)
            Catch ex As Exception
                errorCode = 1
                datos = New DatosReserva
            End Try
            flushConection(cmd, errorCode)
            Return datos
        End Function
        Shared sqlReservaPrimerHuesped As String = "select * from reservas_primer_huesped where reserva_id=?"
        Shared sqlReservaPrimerCliente As String = "" _
& " SELECT clientes.razon, " _
& " ( " _
& " SELECT " _
& " habitaciones.numero_habitacion " _
& " FROM " _
& " (select max(habitaciones_bloqueos.habitacion_bloqueo_id) AS habitacion_bloqueo_id from habitaciones_bloqueos where habitaciones_bloqueos.reserva_id=? )  " _
& " as reserva_ultimo_bloqueo_habitacion " _
& " Inner Join habitaciones_bloqueos ON reserva_ultimo_bloqueo_habitacion.habitacion_bloqueo_id = habitaciones_bloqueos.habitacion_bloqueo_id " _
& " Inner Join habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id " _
& " ) as numero_habitacion  " _
& " FROM reservas_huespedes Inner Join clientes ON reservas_huespedes.cliente_id = clientes.cliente_id WHERE reservas_huespedes.reserva_id =  ? LIMIT 1 "

        Private Function obtieneReservaDatosListados(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, Optional ByVal fecha As Object = Nothing) As DatosReserva
            Dim cabres As DataSet = getDataSet(cmd, Replace(sqlCabReserva, "?", reserva_id))
            'Dim respri As DataSet = getDataSet(cmd, Replace(sqlReservaPrimerHuesped, "?", reserva_id))
            Dim respri As DataSet = getDataSet(cmd, Replace(sqlReservaPrimerCliente, "?", reserva_id))
            Dim corders As DataTable = New DataTable("dt_tmp")
            corders.Load(preProcesaServicios(getDataTable(cmd, Replace(sqlTablaReservas, "?", reserva_id))))
            'si tiene fecha
            'seleccionar los que caen en esa fecha
            Dim filtro As String = ""
            If Not IsNothing(fecha) Then
                filtro = "fecha_desde<='" & fecha & "' and fecha_hasta>'" & fecha & "' "
            End If
            corders = New DataView(corders, filtro, "", DataViewRowState.CurrentRows).ToTable
            'obtener el mayor por servicio,uc
            Dim x As Integer
            Dim neworders As New Hashtable
            Dim xc As Integer = corders.Rows.Count - 1
            Dim key
            For x = 0 To xc
                key = corders.Rows(x).Item("servicio_id") & "_" & corders.Rows(x).Item("unidad_calculo_id")
                If Not neworders.ContainsKey(key) Then
                    neworders(key) = corders.Rows(x)
                Else
                    If corders.Rows(x).Item("cantidad") > neworders(key).item("cantidad") Then
                        neworders(key) = corders.Rows(x)
                    End If
                End If
            Next
            Dim filas(neworders.Count - 1) As DataRow
            neworders.Values.CopyTo(filas, 0)

            Dim dr As New DatosReserva
            dr.pax = 0
            dr.a = 0
            dr.n1 = 0
            dr.n2 = 0
            dr.b = 0
            Try
                If Not cabres.Tables(0).Rows(0).IsNull("bono_referencia") Then
                    dr.bono = cabres.Tables(0).Rows(0)("bono_referencia")
                End If
                dr.fecha_desde = cabres.Tables(0).Rows(0)("fecha_prevista_llegada")
                dr.fecha_hasta = cabres.Tables(0).Rows(0)("fecha_prevista_salida")
                dr.habitacion = " "
                dr.primer_huesped = " "
                If respri.Tables(0).Rows.Count > 0 Then
                    If Not IsDBNull(respri.Tables(0).Rows(0)("numero_habitacion")) Then
                        dr.habitacion = respri.Tables(0).Rows(0)("numero_habitacion")
                    End If
                    If Not IsDBNull(respri.Tables(0).Rows(0)("razon")) Then
                        dr.primer_huesped = respri.Tables(0).Rows(0)("razon")
                    End If
                End If

            Catch ex As Exception
                Console.Write(ex.Message)
            End Try
            Dim abrv As New Hashtable
            xc = filas.Length - 1
            For x = 0 To xc
                With filas(x)
                    abrv(.Item("abreviatura")) += .Item("cantidad")
                    If .Item("tipo_servicio_id") = 1 And .Item("tipo_unidad_calculo_id") = 1 Then
                        dr.tipo_hab = .Item("abreviatura")
                        dr.cant_hab = .Item("cantidad")
                    End If
                    If .Item("tipo_servicio_id") = 2 Or .Item("abreviatura") = "A1" Or .Item("abreviatura") = "A2" Then
                        If dr.regimen = "" OrElse dr.regimen = "A1" OrElse dr.regimen = "A2" Then
                            dr.regimen = .Item("abreviatura")
                        End If
                    End If
                    If .Item("UC") = "A" Then
                        If .Item("cantidad") > dr.a Then
                            dr.a = .Item("cantidad")
                        End If
                    End If
                    If .Item("UC") = "N1" Then
                        If .Item("cantidad") > dr.n1 Then
                            dr.n1 = .Item("cantidad")
                        End If
                    End If
                    If .Item("UC") = "N2" Then
                        If .Item("cantidad") > dr.n2 Then
                            dr.n2 = .Item("cantidad")
                        End If
                    End If
                    If .Item("UC") = "B" Then
                        If .Item("cantidad") > dr.b Then
                            dr.b = .Item("cantidad")
                        End If
                    End If
                End With
            Next
            dr.pax = dr.a + dr.n1 + dr.n2
            dr.SS = dr.pax - abrv("HD") - abrv("MP") - abrv("PC") - abrv("TI")
            dr.HD = abrv("HD")
            dr.MP = abrv("MP")
            dr.PC = abrv("PC")
            dr.TI = abrv("TI")
            Return dr
        End Function
        Public Function ObtienePlanningDiario(ByVal hotel_id As Integer, ByVal fechaini As Date, ByVal fechafin As Date, ByVal garantia As Integer, Optional ByVal cliente_id As Integer = 0, Optional ByVal tipo_habitacion_id As Integer = 0, Optional ByVal afecha As Date = Nothing) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim datos As DataSet = Nothing
            Try
                datos = ObtienePlanningDiario(cmd, hotel_id, fechaini, fechafin, garantia, cliente_id, tipo_habitacion_id, Nothing, True, afecha)
            Catch ex As Exception
                errorCode = 1
            End Try

            flushConection(cmd, errorCode)
            Return datos
        End Function
        Shared sqlDesglosePensionAgencia = "" _
& " select 0 as cliente_id,'Agencia' as Agencia," _
& " 0 as SS_A,0 as SS_N1,0 as SS_N2,0 as SS_B, " _
& " 0 as HD_A,0 as HD_N1,0 as HD_N2,0 as HD_B, " _
& " 0 as MP_A,0 as MP_N1,0 as MP_N2,0 as MP_B, " _
& " 0 as PC_A,0 as PC_N1,0 as PC_N2,0 as PC_B, " _
& " 0 as TI_A,0 as TI_N1,0 as TI_N2,0 as TI_B from hoteles where 1=0"
        Shared OldsqlClientesConContratosHotel = "" _
& " SELECT distinct clientes.cliente_id,clientes.razon " _
& " FROM clientes " _
& " Inner Join contratos ON contratos.cliente_id = clientes.cliente_id " _
& " where  contratos.hotel_id=? " _
& " order by clientes.razon "
        Shared sqlClientesConContratosHotel = "" _
        & "         SELECT distinct clientes.cliente_id,clientes.razon" _
& " FROM clientes  " _
& " where clientes.grupo_cliente_id in (2) or clientes.cliente_defecto=1 " _
& "  order by clientes.razon "

        Private Class agenciaDesglose
            Public hotel_id As Integer
            Public cliente_id As Integer
            Public fechaini As Date
            Public fechafin As Date
            Public resultado As DataSet
            Public row As DataRow
            Public datos As System.Collections.Queue
            Public procesando As System.Collections.Queue
        End Class
        Private Sub HiloDesgloseAgencia(ByVal blosta As Object)
            Dim z As New GesHotelClase(Me.userId)
            Dim cmd As MySqlCommand = prepareConection()

            Dim bloque As System.Collections.Queue = blosta
            Dim estado As agenciaDesglose
            Do
                SyncLock bloque.SyncRoot
                    Try
                        estado = bloque.Dequeue
                        If Not estado Is Nothing Then
                            estado.procesando.Enqueue(estado)
                        End If
                    Catch ex As Exception
                        estado = Nothing
                    End Try
                End SyncLock
                If Not estado Is Nothing Then

                    Dim datos As DataSet = ObtienePlanningDiario(cmd, estado.hotel_id, estado.fechaini, estado.fechafin, 0, estado.cliente_id)
                    estado.resultado = datos
                    SyncLock bloque.SyncRoot
                        Try
                            estado.datos.Enqueue(estado)
                            estado.procesando.Dequeue()
                        Catch ex As Exception
                        End Try
                    End SyncLock

                End If
            Loop While Not estado Is Nothing

            flushConection(cmd, 1)
        End Sub
        Public Function ObtieneDesglosePensionAgencia(ByVal hotel_id As Integer, ByVal fechaini As Date, ByVal fechafin As Date) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado As DataSet = getDataSet(cmd, sqlDesglosePensionAgencia)

            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            'todo obtiene todas las agencias con contrato para ese hotel
            Dim reader As DataTableReader = getDataTable(cmd, sqlClientesConContratosHotel)
            'Dim caches As New Hashtable
            Dim batch As New BatchTasks
            batch.maxThreads = 5
            Dim filastable As New Hashtable
            While reader.Read
                'por cada agencia obtener su planning diario
                Dim row As DataRow = resultado.Tables(0).Rows.Add
                row("cliente_id") = reader("cliente_id")
                row("agencia") = reader("razon")
                Dim fec As Date = "#12:00:00 AM#"
                Dim obj() = {hotel_id, fechaini, fechafin, 0, reader("cliente_id"), 0, fec}
                batch.addTask(Me, "ObtienePlanningDiario", reader("cliente_id"), obj)
                filastable(reader("cliente_id")) = row
            End While

            flushConection(cmd, errorCode)
            batch.waitForCompletition()
            'Dim colaDatos As Queue = batch.getResultQueue()
            Dim colad As Hashtable = batch.getResultHashTable()
            Dim ienu As IEnumerator = colad.Keys.GetEnumerator
            While ienu.MoveNext
                Dim tabla As DataTable = colad(ienu.Current).Tables(0)
                Dim row As DataRow = filastable(ienu.Current)

                If tabla.Rows.Count > 0 Then

                    row("SS_A") = tabla.Compute("sum(SS_A)", "")
                    row("SS_N1") = tabla.Compute("sum(SS_N1)", "")
                    row("SS_N2") = tabla.Compute("sum(SS_N2)", "")
                    row("SS_B") = tabla.Compute("sum(SS_B)", "")
                    row("HD_A") = tabla.Compute("sum(HD_A)", "")
                    row("HD_N1") = tabla.Compute("sum(HD_N1)", "")
                    row("HD_N2") = tabla.Compute("sum(HD_N2)", "")
                    row("HD_B") = tabla.Compute("sum(HD_B)", "")
                    row("MP_A") = tabla.Compute("sum(MP_A)", "")
                    row("MP_N1") = tabla.Compute("sum(MP_N1)", "")
                    row("MP_N2") = tabla.Compute("sum(MP_N2)", "")
                    row("MP_B") = tabla.Compute("sum(MP_B)", "")
                    row("PC_A") = tabla.Compute("sum(PC_A)", "")
                    row("PC_N1") = tabla.Compute("sum(PC_N1)", "")
                    row("PC_N2") = tabla.Compute("sum(PC_N2)", "")
                    row("PC_B") = tabla.Compute("sum(PC_B)", "")
                    row("TI_A") = tabla.Compute("sum(TI_A)", "")
                    row("TI_N1") = tabla.Compute("sum(TI_N1)", "")
                    row("TI_N2") = tabla.Compute("sum(TI_N2)", "")
                    row("TI_B") = tabla.Compute("sum(TI_B)", "")
                End If


            End While


            Return resultado
        End Function
        Public Function ObtieneDesglosePensionAgenciaNew(ByVal hotel_id As Integer, ByVal fechaini As Date, ByVal fechafin As Date) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado As DataSet = getDataSet(cmd, sqlDesglosePensionAgencia)

            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            'todo obtiene todas las agencias con contrato para ese hotel
            Dim reader As DataTableReader = getDataTable(cmd, sqlClientesConContratosHotel)
            'Dim caches As New Hashtable

            Dim colaentrada As New System.Collections.Queue
            Dim colasalida As New System.Collections.Queue
            Dim colaprocesando As New System.Collections.Queue
            While reader.Read

                'por cada agencia obtener su planning diario
                Dim row As DataRow = resultado.Tables(0).Rows.Add
                row("cliente_id") = reader("cliente_id")
                row("agencia") = reader("razon")
                Dim objdes As New agenciaDesglose
                objdes.hotel_id = hotel_id
                objdes.fechaini = fechaini
                objdes.fechafin = fechafin
                objdes.cliente_id = reader("cliente_id")
                objdes.row = row
                objdes.datos = colasalida
                objdes.procesando = colaprocesando
                colaentrada.Enqueue(objdes)
            End While
            flushConection(cmd, errorCode)

            Dim x As Integer
            For x = 0 To 5

                ThreadPool.QueueUserWorkItem(AddressOf HiloDesgloseAgencia, colaentrada)
            Next

            While colaentrada.Count + colaprocesando.Count + colasalida.Count > 0

                While colasalida.Count > 0
                    Dim estado As agenciaDesglose
                    SyncLock colaentrada.SyncRoot
                        Try
                            estado = colasalida.Dequeue
                        Catch ex As Exception
                            estado = Nothing
                        End Try
                    End SyncLock
                    If Not estado Is Nothing Then
                        Dim row As DataRow = estado.row
                        Dim tabla As DataTable = estado.resultado.Tables(0)

                        If tabla.Rows.Count > 0 And 1 = 0 Then

                            row("SS_A") = tabla.Compute("sum(SS_A)", "")
                            row("SS_N1") = tabla.Compute("sum(SS_N1)", "")
                            row("SS_N2") = tabla.Compute("sum(SS_N2)", "")
                            row("SS_B") = tabla.Compute("sum(SS_B)", "")
                            row("HD_A") = tabla.Compute("sum(HD_A)", "")
                            row("HD_N1") = tabla.Compute("sum(HD_N1)", "")
                            row("HD_N2") = tabla.Compute("sum(HD_N2)", "")
                            row("HD_B") = tabla.Compute("sum(HD_B)", "")
                            row("MP_A") = tabla.Compute("sum(MP_A)", "")
                            row("MP_N1") = tabla.Compute("sum(MP_N1)", "")
                            row("MP_N2") = tabla.Compute("sum(MP_N2)", "")
                            row("MP_B") = tabla.Compute("sum(MP_B)", "")
                            row("PC_A") = tabla.Compute("sum(PC_A)", "")
                            row("PC_N1") = tabla.Compute("sum(PC_N1)", "")
                            row("PC_N2") = tabla.Compute("sum(PC_N2)", "")
                            row("PC_B") = tabla.Compute("sum(PC_B)", "")
                            row("TI_A") = tabla.Compute("sum(TI_A)", "")
                            row("TI_N1") = tabla.Compute("sum(TI_N1)", "")
                            row("TI_N2") = tabla.Compute("sum(TI_N2)", "")
                            row("TI_B") = tabla.Compute("sum(TI_B)", "")
                        End If
                        'agrupar por pension
                    End If

                End While
                Thread.Sleep(20)
                'If colaentrada.Count > 0 Then
                'HiloDesgloseAgencia(colaentrada)
                'End If

            End While


            Return resultado
        End Function
        Public Function ObtieneDesglosePensionAgenciaOld(ByVal hotel_id As Integer, ByVal fechaini As Date, ByVal fechafin As Date) As DataSet
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim resultado As DataSet = getDataSet(cmd, sqlDesglosePensionAgencia)

            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            'todo obtiene todas las agencias con contrato para ese hotel
            Dim reader As DataTableReader = getDataTable(cmd, sqlClientesConContratosHotel)
            Dim caches As New Hashtable


            While reader.Read

                'por cada agencia obtener su planning diario
                Dim row As DataRow = resultado.Tables(0).Rows.Add
                row("cliente_id") = reader("cliente_id")
                row("agencia") = reader("razon")
                'If row("cliente_id") = 5090 Then
                'row("agencia") = reader("razon")
                'End If

                Dim datos As DataSet = ObtienePlanningDiario(cmd, hotel_id, fechaini, fechafin, 0, reader("cliente_id"))


                Dim tabla As DataTable = datos.Tables(0)
                If tabla.Rows.Count > 0 Then
                    row("SS_A") = tabla.Compute("sum(SS_A)", "")
                    row("SS_N1") = tabla.Compute("sum(SS_N1)", "")
                    row("SS_N2") = tabla.Compute("sum(SS_N2)", "")
                    row("SS_B") = tabla.Compute("sum(SS_B)", "")
                    row("HD_A") = tabla.Compute("sum(HD_A)", "")
                    row("HD_N1") = tabla.Compute("sum(HD_N1)", "")
                    row("HD_N2") = tabla.Compute("sum(HD_N2)", "")
                    row("HD_B") = tabla.Compute("sum(HD_B)", "")
                    row("MP_A") = tabla.Compute("sum(MP_A)", "")
                    row("MP_N1") = tabla.Compute("sum(MP_N1)", "")
                    row("MP_N2") = tabla.Compute("sum(MP_N2)", "")
                    row("MP_B") = tabla.Compute("sum(MP_B)", "")
                    row("PC_A") = tabla.Compute("sum(PC_A)", "")
                    row("PC_N1") = tabla.Compute("sum(PC_N1)", "")
                    row("PC_N2") = tabla.Compute("sum(PC_N2)", "")
                    row("PC_B") = tabla.Compute("sum(PC_B)", "")
                    row("TI_A") = tabla.Compute("sum(TI_A)", "")
                    row("TI_N1") = tabla.Compute("sum(TI_N1)", "")
                    row("TI_N2") = tabla.Compute("sum(TI_N2)", "")
                    row("TI_B") = tabla.Compute("sum(TI_B)", "")
                End If
                'agrupar por pension

            End While

            flushConection(cmd, errorCode)
            Return resultado
        End Function

        Shared BORRAR_sqlHabitacionesBloqueadas As String = "" _
        & " SELECT  count(distinct(habitaciones_bloqueos.habitacion_id))" _
& " FROM reservas Inner Join habitaciones_bloqueos ON habitaciones_bloqueos.reserva_id = reservas.reserva_id " _
& " WHERE reservas.hotel_id = ? AND reservas.estado_reserva_id NOT IN  (0,2) and habitaciones_bloqueos.habitacion_id!=0 " _
& " AND ? BETWEEN  habitaciones_bloqueos.fecha_desde AND DATE_ADD(habitaciones_bloqueos.fecha_hasta, INTERVAL -1 DAY) " _
& " AND (reservas.cliente_id =  ? or ?=0)"
        Shared BORRAR_sqlHabitacionesBloqueadasNueva As String = "" _
        & " SELECT  GROUP_CONCAT(convert(reservas.reserva_id,char)) as reservas" _
& " FROM reservas Inner Join habitaciones_bloqueos ON habitaciones_bloqueos.reserva_id = reservas.reserva_id " _
& " WHERE reservas.hotel_id = ? AND reservas.estado_reserva_id NOT IN  (0,2) and habitaciones_bloqueos.habitacion_id!=0" _
& " AND ? BETWEEN  habitaciones_bloqueos.fecha_desde AND DATE_ADD(habitaciones_bloqueos.fecha_hasta, INTERVAL -1 DAY) " _
& " AND (reservas.cliente_id =  ? or ?=0)"
        Shared BORRAR_sqlHabitacionesBloqueadasNuevaO As String = "" _
        & " SELECT  reservas.reserva_id,habitaciones_bloqueos.habitacion_id" _
& " FROM reservas Inner Join habitaciones_bloqueos ON habitaciones_bloqueos.reserva_id = reservas.reserva_id " _
& " WHERE reservas.hotel_id = ? AND reservas.estado_reserva_id NOT IN  (0,2) and habitaciones_bloqueos.habitacion_id!=0" _
& " AND ? BETWEEN  habitaciones_bloqueos.fecha_desde AND DATE_ADD(habitaciones_bloqueos.fecha_hasta, INTERVAL -1 DAY) " _
& " AND (reservas.cliente_id =  ? or ?=0)"
        Shared sqlHabitacionesBloqueadasRango As String = "" _
        & " SELECT  tipos_habitacion.desvios as desviado,reservas.cliente_id,reservas.reserva_id,reservas.fecha_prevista_llegada,reservas.fecha_prevista_salida,habitaciones.tipo_habitacion_id,habitaciones_bloqueos.habitacion_bloqueo_id," _
& " habitaciones.habitacion_id,habitaciones_bloqueos.fecha_desde,habitaciones_bloqueos.fecha_hasta" _
& " FROM habitaciones inner join tipos_habitacion on tipos_habitacion.tipo_habitacion_id=habitaciones.tipo_habitacion_id Inner Join habitaciones_bloqueos ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id Inner Join reservas ON habitaciones_bloqueos.reserva_id = reservas.reserva_id  " _
& " WHERE reservas.hotel_id = ? AND reservas.estado_reserva_id NOT IN  (0,2) " _
& " AND (reservas.cliente_id =  ? or ?=0 or 1=1) and " _
& " (habitaciones_bloqueos.fecha_desde BETWEEN ? and ? " _
& " or habitaciones_bloqueos.fecha_hasta  BETWEEN ? and ?" _
& " or habitaciones_bloqueos.fecha_desde<=? and habitaciones_bloqueos.fecha_hasta>=?) " _
& " and (?=0 or reservas.fecha_reserva<=?)"
        Shared sqlHabitacionesBloqueadasRangoOld As String = "" _
& " SELECT  reservas.*,habitaciones_bloqueos.*,habitaciones.*" _
& " FROM habitaciones Inner Join habitaciones_bloqueos ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id Inner Join reservas ON habitaciones_bloqueos.reserva_id = reservas.reserva_id  " _
& " WHERE reservas.hotel_id = ? AND reservas.estado_reserva_id NOT IN  (0,2) " _
& " AND (reservas.cliente_id =  ? or ?=0 or 1=1) and " _
& " (habitaciones_bloqueos.fecha_desde BETWEEN ? and ? " _
& " or habitaciones_bloqueos.fecha_hasta  BETWEEN ? and ?" _
& " or habitaciones_bloqueos.fecha_desde<=? and habitaciones_bloqueos.fecha_hasta>=?) "
        Private Function contarDistintasEn(ByVal campo As String, ByVal origen() As DataRow, ByVal destino() As DataRow) As Integer


            Dim arr As New Hashtable
            Dim x As Integer
            Dim quitar As Integer = 0
            Dim xl As Integer = destino.Length - 1
            For x = 0 To xl
                arr((destino(x)(campo))) = 1
            Next
            xl = origen.Length - 1
            Dim key
            For x = 0 To xl
                key = origen(x)(campo)
                If arr.ContainsKey(key) Then
                    quitar += 1
                Else
                    arr(key) = 1
                End If
            Next
            Return quitar
        End Function
        Private Function CalculaCruze(ByVal campo As String, ByVal campovalor As String, ByVal origen As DataTable, ByVal destino() As DataRow, ByVal filtroadvan() As String, datosTiposHab As DataTable) As String()
            Dim arr As New Hashtable
            Dim x As Integer
            Dim xl As Integer = origen.Rows.Count - 1
            'Dim destino() As DataRow
            'destino = dest.Select(filtro2, columna3)
            If filtroadvan(0) <> "" Then
                If filtroadvan(2) <> "" Then
                    Dim tmpdat As New Hashtable
                    For x = 0 To destino.Length - 1
                        tmpdat(destino(x).Item(campo)) = obtieneValorColumna(datosTiposHab, "servicio_id", "tipo_habitacion_id=" & destino(x).Item(filtroadvan(2)), "0")
                    Next
                    For x = 0 To xl
                        If origen.Rows(x)(filtroadvan(0)) = tmpdat(origen.Rows(x)(campo)) Then
                            arr((origen.Rows(x)(campo))) += origen.Rows(x)(campovalor)
                        Else
                            'Console.WriteLine(origen.Rows(x)(campo) & "-" & origen.Rows(x)(filtroadvan(0)) & "-" & tmpdat(origen.Rows(x)(campo)))
                        End If
                    Next
                Else
                    For x = 0 To xl
                        If origen.Rows(x)(filtroadvan(0)) = filtroadvan(1) Then
                            arr((origen.Rows(x)(campo))) += origen.Rows(x)(campovalor)
                        End If
                    Next
                End If

            Else
                For x = 0 To xl
                    'If origen.Rows(x)(filtroadvan(0)) = filtroadvan(1) Then
                    arr((origen.Rows(x)(campo))) += origen.Rows(x)(campovalor)
                    'End If
                Next
            End If

            xl = destino.Length - 1
            For x = 0 To xl
                If arr.ContainsKey(destino(x)(campo)) Then
                    arr((destino(x)(campo))) -= 1
                Else
                    If destino(x)("tipo_habitacion_id") = 10 Then
                        'arr((destino(x)(campo))) += 1
                    End If
                End If
            Next
            Dim enu As IEnumerator = arr.Keys.GetEnumerator


            Dim val As Integer
            Dim cant As Integer
            Dim tmp As String = ""
            While enu.MoveNext
                tmp &= enu.Current & ","
                val = arr(enu.Current)
                If val > 0 Then
                    cant += val
                End If
            End While
            If tmp <> "" Then
                tmp = tmp.Substring(0, tmp.Length - 1)
            End If
            Dim retval(2) As String
            retval(0) = cant
            retval(1) = tmp
            Return retval
        End Function
        Private Sub filtraDesvios(ByVal orders As DataTable, ByVal bloqueos As DataSet)
            'encontrar el tipo desvio..a fuego 10
            'filtrar solo los servicios tipos de hab
            'encontrar si tiene alguna habitacion desviada
            'si el desvio es completo cambiar tipo de hab
            'si el desvio es parcial cambiar tipo de hab y crear nueva linea con el resto
            Dim filtroHab As String = "0=0 " '"servicio_id<>0 and unidad_calculo_id=1 and tipo_servicio_id=1 "
            Dim dvb As DataView = New DataView(bloqueos.Tables(0), "desviado=1", "reserva_id", DataViewRowState.CurrentRows)
            If dvb.Count > 0 Then
                'encontrar si tiene alguna habitacion desviada
                'Console.WriteLine(dvb.Count)
                Dim y As Integer
                For y = 0 To dvb.Count - 1
                    Dim rows() As DataRow = orders.Select(filtroHab & " and reserva_id=" & dvb(y).Row("reserva_id"))

                    Dim x As Integer
                    If rows.Length <> 0 Then
                        For x = 0 To rows.Length - 1
                            If rows(x)("fecha_desde") = dvb(y).Row("fecha_desde") And rows(x)("fecha_hasta") = dvb(y).Row("fecha_hasta") Then
                                'si el desvio es completo cambiar tipo de hab
                                rows(x)("cantidad") = 0
                            Else
                                If rows(x)("fecha_desde") <= dvb(y).Row("fecha_desde") And rows(x)("fecha_hasta") >= dvb(y).Row("fecha_hasta") Then
                                    'si el desvio es parcial cambiar tipo de hab y crear nueva linea con el resto
                                    Dim row As DataRow = orders.Rows.Add(rows(x).ItemArray)
                                    row("cantidad") = 0
                                    row("fecha_desde") = dvb(y).Row("fecha_desde")
                                    row("fecha_hasta") = dvb(y).Row("fecha_hasta")

                                    If rows(x)("fecha_desde") = dvb(y).Row("fecha_desde") Or rows(x)("fecha_hasta") = dvb(y).Row("fecha_hasta") Then
                                        'si estan en los bordes 2 tramos
                                        If rows(x)("fecha_desde") = dvb(y).Row("fecha_desde") Then
                                            rows(x)("fecha_desde") = dvb(y).Row("fecha_hasta") '+1?
                                        Else
                                            rows(x)("fecha_hasta") = dvb(y).Row("fecha_desde") '-1?
                                        End If
                                    Else
                                        'si no estan en los bordes 3 tramos
                                        row = orders.Rows.Add(rows(x).ItemArray)
                                        rows(x)("fecha_hasta") = dvb(y).Row("fecha_desde") '-1?
                                        row("fecha_desde") = dvb(y).Row("fecha_hasta") '+1?
                                    End If
                                End If

                            End If
                        Next

                    Else

                    End If

                Next

            End If

        End Sub
        Public Function ObtieneEcolimpiezas(ByVal hotel_id As Integer, ByVal fechaini As Date, ByVal fechafin As Date, ByVal cliente_id As Integer) As DataSet
            Dim cmd As MySqlCommand = prepareConection()
            Dim datos As DataSet = ObtieneEcolimpiezas(cmd, hotel_id, fechaini, fechafin, cliente_id)
            flushConection(cmd, 0)
            Return datos
        End Function
        Private Function ObtieneEcolimpiezas(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal fechaini As Date, ByVal fechafin As Date, ByVal cliente_id As Integer) As DataSet
            Dim ds As DataSet = getDataSet(cmd, "Select now() as fecha,0 As llegadas, 0 As eco, 0 as porc")
            Dim fecha As Date = fechaini
            Dim fechaParam As New MySqlParameter("@fecha", convertFecha(fecha))
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim llegadas As Object
            Dim eco As Object
            Dim porc As Double
            Dim sql As String = "SELECT COUNT(*) FROM reservas INNER JOIN clientes ON reservas.cliente_id = clientes.cliente_id WHERE hotel_id = ? AND fecha_prevista_llegada = ? AND estado_reserva_id>2 "
            If cliente_id <> 0 Then
                sql &= "AND clientes.agencia_id =? "
            End If
            Dim row As DataRow
            While fecha <= fechafin
                row = ds.Tables(0).Rows.Add()
                row.Item("fecha") = fecha
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                fechaParam.Value = convertFecha(fecha)
                cmd.Parameters.Add(fechaParam)
                If cliente_id <> 0 Then
                    cmd.Parameters.Add(cliente_idParam)
                End If
                llegadas = ExecuteScalar(cmd, sql)
                If Not IsNumeric(llegadas) Then
                    llegadas = 0
                End If
                row.Item("llegadas") = llegadas
                eco = ExecuteScalar(cmd, sql & " And (ISNULL(eco_limpieza) Or eco_limpieza =0)")
                If Not IsNumeric(eco) Then
                    eco = 0
                End If
                row.Item("eco") = eco
                If llegadas = 0 Then
                    porc = 0
                Else
                    If eco <> 0 Then
                        porc = eco * 100 / llegadas
                    End If

                End If

                row.Item("porc") = porc
                fecha = DateAdd(DateInterval.Day, 1, fecha)
            End While
            ds.Tables(0).Rows(0).Delete()
            ds.Tables(0).AcceptChanges()

            'Dim dvk As New DataView(ds.Tables(0), "", "fecha ASC", DataViewRowState.CurrentRows)
            'ds = New DataSet()
            'ds.Tables.Add(dvk.ToTable())
            Return ds
        End Function
        Private Function ObtienePlanningDiario(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal fechaini As Date, ByVal fechafin As Date, ByVal garantia As Integer, Optional ByVal cliente_id As Integer = 0, Optional ByVal tipo_habitacion_id As Integer = 0, Optional ByVal cachedHash As Hashtable = Nothing, Optional ByVal sindesvios As Boolean = False, Optional ByVal afecha As Date = Nothing) As DataSet
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim datos As DataSet = getDataSet(cmd, sqlPlaningDiario, True)

            If fechaini > fechafin Then
                Dim ft As Date = fechaini
                fechaini = fechafin
                fechafin = ft
            End If
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim cliente_id1Param As New MySqlParameter("@cliente_id1", cliente_id)
            Dim fechainiParam As New MySqlParameter("@fechaini", convertFecha(fechaini))
            Dim fechafinParam As New MySqlParameter("@fechafin", convertFecha(fechafin))
            Dim fechaini1Param As New MySqlParameter("@fechaini1", convertFecha(fechaini))
            Dim fechafin1Param As New MySqlParameter("@fechafin1", convertFecha(fechafin))
            Dim fechaini2Param As New MySqlParameter("@fechaini2", convertFecha(fechaini))
            Dim fechafin2Param As New MySqlParameter("@fechafin2", convertFecha(fechafin))
            Dim conafecha As Integer = 0
            If IsNothing(afecha) OrElse afecha.Year = 1 Then
                afecha = Now
            Else
                conafecha = 1
            End If
            Dim conafechaParam As New MySqlParameter("@conafecha", conafecha)
            Dim afechaParam As New MySqlParameter("@afecha", convertFecha(afecha))

            cmd.Parameters.Add(hotel_idParam)
            Dim todosParam As New MySqlParameter("@todos", 0)
            If sindesvios Then
                todosParam.Value = 0
            Else
                todosParam.Value = 1
            End If
            cmd.Parameters.Add(todosParam)

            Dim datosTiposHab As DataTable = getDataSet(cmd, sqlTipoHabitacionServicioHotel, True).Tables(0)


            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(cliente_idParam)
            cmd.Parameters.Add(cliente_id1Param)
            cmd.Parameters.Add(fechainiParam)
            cmd.Parameters.Add(fechafinParam)
            cmd.Parameters.Add(fechaini1Param)
            cmd.Parameters.Add(fechafin1Param)
            cmd.Parameters.Add(fechaini2Param)
            cmd.Parameters.Add(fechafin2Param)

            cmd.Parameters.Add(todosParam)


            'Dim mea = startMeasure()
            Dim cacheKey As String = hotel_idParam.Value & "_" & cliente_idParam.Value & "_" & fechainiParam.Value & "_" & fechafinParam.Value
            Dim bloqueos As DataSet = Nothing
            'Dim lectorD As DataTable
            Dim orderstotal As DataTable = Nothing
            If Not IsNothing(cachedHash) Then
                If cachedHash.Count > 0 Then
                    bloqueos = cachedHash("bloqueos")
                    'lectorD = cachedHash("lectorD")
                    orderstotal = cachedHash("orders")
                End If
            End If
            If IsNothing(bloqueos) Then
                Dim dt As Date = Now


                Dim tmpc As Integer = cliente_idParam.Value
                Dim tmpc1 As Integer = cliente_id1Param.Value
                cliente_idParam.Value = 0
                cliente_id1Param.Value = 0

                cmd.Parameters.Remove(todosParam)
                cmd.Parameters.Add(conafechaParam)
                cmd.Parameters.Add(afechaParam)
                bloqueos = getDataSet(cmd, sqlHabitacionesBloqueadasRango, True)
                cliente_idParam.Value = tmpc
                cliente_id1Param.Value = tmpc1



                Dim lector As DataSet = getDataSet(cmd, sqlObtieneReservasValidasEntreFechas)
                'Console.WriteLine(lector.Tables(0).Rows.Count)


                'lectorD = lector.Tables(0)
                'todo por cada reserva obtener su combinacion de servicios por dia
                'Dim reader As DataTableReader = lectorD.CreateDataReader
                Dim reader As DataTableReader = lector.Tables(0).CreateDataReader


                cmd.Parameters.Clear()
                Dim reserva_idParam As New MySqlParameter("@reserva_id", 0)
                cmd.Parameters.Add(reserva_idParam)
                orderstotal = New DataTable("dt_tmp")
                Dim matresid As String = ConcatenarCampo(reader, "reserva_id", "0")

                Dim ko As String = Replace(sqlTablaReservas, "?", matresid)

                Dim dtr As DataTableReader = getDataTable(cmd, ko)


                orderstotal.Load(preProcesaServicios(dtr))
                filtraDesvios(orderstotal, bloqueos)

                'If orders.Rows.Count > 0 Or 1 = 1 Then
                orderstotal.Columns.Add("ucidabre", System.Type.GetType("System.String"), "reserva_id+'-'+unidad_calculo_id+abreviatura")
                orderstotal.Columns.Add("sumador", System.Type.GetType("System.Int32"), 1)
                'End If
                'grabar orders
                'grabar lectorD
                'grabar bloqueos
                If Not IsNothing(cachedHash) Then
                    cachedHash.Add("orders", orderstotal)
                    'cachedHash.Add("lectorD", lectorD)
                    cachedHash.Add("bloqueos", bloqueos)
                End If
                Dim xxl As TimeSpan = (Now - dt)
                Console.WriteLine(xxl.ToString)
            End If
            'Dim filtroHab As String = "unidad_calculo_id=1 and tipo_servicio_id=1 " 'que forma para kitar upgrades!
            Dim filtroHab As String = " concepto_acelerador_reservas_id=1 " 'que forma para kitar upgrades!
            Dim filtroHabSinTipo As String = filtroHab
            Dim filtipohab As String = ""
            Dim filtroadvan(3) As String
            filtroadvan(0) = ""
            filtroadvan(1) = ""
            filtroadvan(2) = ""
            If tipo_habitacion_id <> 0 Then
                filtroadvan(0) = "servicio_id"
                filtroadvan(1) = obtieneValorColumna(datosTiposHab, "servicio_id", "tipo_habitacion_id=" & tipo_habitacion_id, "0")
                filtroHab = filtroHab & " and " & filtroadvan(0) & "=" & filtroadvan(1)
                'filtroHabitaciones &= " and "
                filtipohab = "tipo_habitacion_id=" & tipo_habitacion_id & " and "
            Else

                'filtroadvan(0) = "servicio_id"
                'filtroadvan(1) = "servicio_id"
                'filtroadvan(2) = "tipo_habitacion_id"
            End If

            Dim filtroAdultos As String
            Dim filtroPensiones As String
            Dim filtroHabitaciones As String
            Dim filtroHabitacionesSinTipo As String
            Dim filtroHabitacionesLLegadas As String
            Dim filtroHabitacionesSalidas As String
            Dim row As DataRow
            Dim pre_tipo_hab = obtieneValorColumna(datosTiposHab, "desc_corta", "tipo_habitacion_id=" & tipo_habitacion_id, "00")
            Dim dtbig As Date = Now

            'acelerar todo
            Dim sql1 As String = "SELECT" _
& "            habitaciones.habitacion_id,Coalesce(habitaciones.fecha_inicio,str_to_date('01/01/2000', '%d/%m/%Y')) as fecha_inicio," _
 & "            tipos_habitacion.numero_personas," _
& "             tipos_habitacion.desvios" _
& "             FROM" _
& "             habitaciones" _
& " INNER JOIN tipos_habitacion ON habitaciones.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id" _
& "             WHERE" _
 & "            habitaciones.hotel_id = ? and (0=? or habitaciones.tipo_habitacion_id=?)"
            Dim tipo_habitacion_idParam As New MySqlParameter("@tipo_habitacion_id", tipo_habitacion_id)
            Dim tipo_habitacion_id1Param As New MySqlParameter("@tipo_habitacion_id1", tipo_habitacion_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(tipo_habitacion_idParam)
            cmd.Parameters.Add(tipo_habitacion_id1Param)
            Dim habitaciones As DataTable = getDataSet(cmd, sql1, True).tables(0)
            sql1 = " SELECT" _
& " habitaciones_bloqueos.habitacion_id," _
& " habitaciones_bloqueos.fecha_desde," _
& " habitaciones_bloqueos.fecha_hasta" _
& " FROM" _
& " habitaciones_bloqueos" _
& " WHERE" _
& " habitaciones_bloqueos.reserva_id is null" _
& " and " _
& " (" _
& " habitaciones_bloqueos.fecha_desde is NULL" _
& " OR" _
& " (" _
& " (habitaciones_bloqueos.fecha_desde between ? and ?" _
& " or" _
& " habitaciones_bloqueos.fecha_hasta between ? and ? " _
& " OR ? between habitaciones_bloqueos.fecha_desde and habitaciones_bloqueos.fecha_hasta OR " _
& " ? between  habitaciones_bloqueos.fecha_desde and habitaciones_bloqueos.fecha_hasta " _
& " )" _
& " )" _
& " )"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(fechainiParam)
            cmd.Parameters.Add(fechafinParam)
            cmd.Parameters.Add(fechaini1Param)
            cmd.Parameters.Add(fechafin1Param)
            cmd.Parameters.Add(fechaini2Param)
            cmd.Parameters.Add(fechafin2Param)
            Dim bloq_habitaciones As DataTable = getDataSet(cmd, sql1, True).tables(0)
            Dim orders As DataTable = orderstotal
            While fechaini < fechafin
                filtroAdultos = "(fecha_desde <='" & fechaini & "' and fecha_hasta >'" & fechaini & "')"

                'orders = New DataView(orderstotal, filtroAdultos, "reserva_id", DataViewRowState.CurrentRows).ToTable

                'filtroAdultos = "1=1"

                'filtroPensiones = "tipo_servicio_id=2 and (fecha_desde <='" & fechaini & "' and fecha_hasta >'" & fechaini & "')"
                filtroPensiones = "tipo_servicio_id=2 and " & filtroAdultos
                'usar el 99 ese
                'filtroHabitaciones = filtroHab & " and (fecha_desde <='" & fechaini & "' and fecha_hasta >'" & fechaini & "')"
                filtroHabitaciones = filtroHab & " and " & filtroAdultos
                'filtroHabitacionesSinTipo = filtroHabSinTipo & " and (fecha_desde <='" & fechaini & "' and fecha_hasta >'" & fechaini & "')"
                filtroHabitacionesSinTipo = filtroHabSinTipo & " and " & filtroAdultos
                filtroHabitacionesLLegadas = filtroHab & " and (fecha_desde ='" & fechaini & "' )"
                filtroHabitacionesSalidas = filtroHab & " and (fecha_hasta ='" & fechaini & "' )"
                row = datos.Tables(0).Rows.Add()
                row.Item("SS_A") = 0
                row.Item("SS_N1") = 0
                row.Item("SS_N2") = 0
                row.Item("SS_B") = 0

                row.Item("HD_A") = 0
                row.Item("HD_N1") = 0
                row.Item("HD_N2") = 0
                row.Item("HD_B") = 0

                row.Item("MP_A") = 0
                row.Item("MP_N1") = 0
                row.Item("MP_N2") = 0
                row.Item("MP_B") = 0

                row.Item("PC_A") = 0
                row.Item("PC_N1") = 0
                row.Item("PC_N2") = 0
                row.Item("PC_B") = 0

                row.Item("TI_A") = 0
                row.Item("TI_N1") = 0
                row.Item("TI_N2") = 0
                row.Item("TI_B") = 0

                row.Item("llegadas_SS") = 0
                row.Item("llegadas_HD") = 0
                row.Item("llegadas_MP") = 0
                row.Item("llegadas_PC") = 0
                row.Item("llegadas_TI") = 0

                row.Item("salidas_SS") = 0
                row.Item("salidas_HD") = 0
                row.Item("salidas_MP") = 0
                row.Item("salidas_PC") = 0
                row.Item("salidas_TI") = 0

                row.Item("DE") = 0
                row.Item("AL") = 0
                row.Item("CE") = 0

                'row.Item("llegadas") = lectorD.Compute("count(reserva_id)", filtroLlegadas)
                'row.Item("salidas") = lectorD.Compute("count(reserva_id)", filtroSalidas)
                row.Item("fecha") = fechaini.ToString("dd/MM/yyyy") 'fechaini.ToString("dd-MM-yyyy")
                '                row.Item("disponibles") = lectorDisp.Compute("count(habitacion_id)", filtroDisponibles)
                'cambiar por las disponibles a una fecha y no las libres
                'row.Item("disponibles") = ObtieneHabitacionesLibresHotel(cmd, hotel_id, fechaini, fechaini).Tables(0).Rows.Count
                row.Item("PorOcup") = 0
                row.Item("Garantia") = 0


                If cliente_id = 0 Then
                    'fast way
                    Dim filtrdev = "(fecha_inicio<='" & fechaini & "' or fecha_inicio is null ) "
                    If sindesvios Then
                        filtrdev &= " and desvios=0"
                    End If
                    'encontrar hab blokedas para esa fecha
                    Dim rows() As DataRow = bloq_habitaciones.Select(filtroAdultos)
                    If rows.Length > 0 Then
                        Dim xt As Integer
                        For xt = 0 To rows.Length - 1
                            filtrdev = filtrdev & " and habitacion_id<>" & rows(xt).Item("habitacion_id")
                        Next
                    End If
                    row.Item("PorOcup") = habitaciones.Compute("sum(numero_personas)", filtrdev)
                    row.Item("disponibles") = habitaciones.Compute("count(habitacion_id)", filtrdev)
                    If row.IsNull("PorOcup") Then
                        row.Item("PorOcup") = 0
                    End If
                    If row.IsNull("disponibles") Then
                        row.Item("disponibles") = 0
                    End If
                    'Dim datmat() As Integer = ObtieneHabitacionesDisponiblesHotelDia(cmd, hotel_id, fechaini, tipo_habitacion_id, sindesvios)
                    'row.Item("disponibles") = datmat(0)
                    'row.Item("PorOcup") = datmat(1)

                    'row.Item("disponibles") = 0
                    'row.Item("PorOcup") = 0
                Else
                    Dim datmat() As Integer = ObtieneCupoClienteDia(cmd, hotel_id, cliente_id, fechaini, tipo_habitacion_id)
                    row.Item("disponibles") = datmat(0)
                    row.Item("PorOcup") = datmat(1)
                End If

                'obtener por dia y 
                Dim matucs As Hashtable
                Dim matpen As Hashtable
                Dim matpenLlegadas As Hashtable
                Dim matpenSalidas As Hashtable
                'If orders.Rows.Count > 0 Or 1 = 1 Then
                If 1 = 1 Then
                    ''Dim rowtodump() As DataRow = orders.Select(filtroHabitaciones) 'numero de servicios tipo habitacion y uc servicio por dia
                    'Dim xt As Integer
                    'For xt = 0 To rowtodump.Length - 1
                    'Console.WriteLine(rowtodump(xt).Item("cantidad") & "- " & rowtodump(xt).Item("reserva_id") & "- " & rowtodump(xt).Item("fecha_hasta"))
                    'Next
                    Dim totc As Integer = 0
                    Dim rows() As DataRow
                    Dim rowsLlegadas() As DataRow
                    Dim rowsSalidas() As DataRow
                    If garantia = 1 Then

                        rows = orders.Select(filtroHabitaciones, "cliente_id")
                        Dim matcli As Hashtable = AgruparRowsPor(rows, "reserva_id", "cliente_id", "sumador")
                        'Dim arrk(matcli.Values.Count)
                        'matcli.Values.CopyTo(arrk, 0)
                        Dim matcli1 As DataTable = ObtieneCupoClienteDia(cmd, hotel_id, 0, fechaini, tipo_habitacion_id)
                        Dim matcli1Rows() As DataRow
                        If cliente_id <> 0 Then
                            matcli1Rows = matcli1.Select("cliente_id=" & cliente_id)
                        Else
                            matcli1Rows = matcli1.Select("")
                        End If
                        Dim xx As Integer
                        Dim drow As DataRow
                        Dim xxlen As Integer = matcli1Rows.Length - 1
                        Dim cmatcli As Integer
                        For xx = 0 To xxlen
                            drow = matcli1Rows(xx)
                            cmatcli = matcli("" & drow.Item("cliente_id"))
                            If drow.Item("garantia") > cmatcli Then
                                totc += drow.Item("garantia") - cmatcli
                            End If
                            'totc += arrk(xx)
                            'Console.WriteLine(arrk(xx))
                        Next
                    End If
                    row.Item("Garantia") = totc
                    Dim cantc
                    Dim cantc1 = Nothing

                    'todo buscar registros
                    Dim cantlleg = 0
                    Dim cantsalidas = 0
                    cantlleg = orders.Compute("sum(cantidad)", filtroHabitacionesLLegadas)
                    If IsDBNull(cantlleg) Then
                        cantlleg = 0
                    End If
                    Dim filasllegadas() As DataRow = bloqueos.Tables(0).Select(filtipohab & " desviado=0 and fecha_prevista_llegada='" & fechaini & "'")
                    ' Dim fl As Integer
                    'todo contar habitaciones repetidas?
                    Dim compkit As Integer = 0

                    Dim akitar As Integer = contarDistintasEn("habitacion_id", filasllegadas, bloqueos.Tables(0).Select(filtipohab & " fecha_desde<'" & fechaini & "' and fecha_hasta>'" & fechaini & "'"))
                    If akitar <> compkit Then
                    End If
                    cantlleg -= akitar

                    cantsalidas = orders.Compute("sum(cantidad)", filtroHabitacionesSalidas)
                    If IsDBNull(cantsalidas) Then
                        cantsalidas = 0
                    End If

                    Dim filassalidas() As DataRow = bloqueos.Tables(0).Select(filtipohab & " desviado=0 and fecha_prevista_salida='" & fechaini & "'")
                    akitar = contarDistintasEn("habitacion_id", filassalidas, bloqueos.Tables(0).Select(filtipohab & " fecha_desde<'" & fechaini & "' and fecha_hasta>'" & fechaini & "'"))
                    cantsalidas -= akitar


                    row.Item("llegadas") = cantlleg
                    row.Item("salidas") = cantsalidas
                    'filtroHabitacionesSalidas


                    'falta tipo hab

                    Dim rowres() As DataRow
                    'Dim rowrest() As DataRow

                    Dim filblo As String = ""
                    If cliente_id <> 0 Then
                        filblo = "(cliente_id=" & cliente_id & " or " & cliente_id & "=0) and "
                    End If



                    Dim resmat As String = ""

                    If 1 = 1 Then
                        'If 1 = 1 And tipo_habitacion_id <> 0 Then
                        rowres = bloqueos.Tables(0).Select(filtroAdultos, "habitacion_id")
                        'nueva funcion de cruze-asignacion hab
                        Dim cruzhab As DataTable = New DataView(orders, filtroHabitacionesSinTipo, "reserva_id", DataViewRowState.CurrentRows).ToTable
                        'cruzhab.Columns.Add("sumador", System.Type.GetType("System.Int32"), 1)
                        Dim matcalcu() As String = CalculaCruze("reserva_id", "cantidad", cruzhab, rowres, filtroadvan, datosTiposHab)

                        'If matcalcu(0) <> cantc1 Then
                        cantc1 = matcalcu(0)
                        resmat = matcalcu(1)
                        'End If

                        'cantc1 = cruzhab.Compute("sum(cantidad)", filtroHabitaciones)
                    End If

                    If tipo_habitacion_id = 10 Then
                        filblo &= filtipohab & filtroAdultos
                        rowres = bloqueos.Tables(0).Select(filblo, "habitacion_id")
                        cantc = AgruparRowsPor(rowres, "habitacion_id", "reserva_id", "reserva_id").Count
                    Else
                        filblo &= "desviado=0 and " & filtipohab & filtroAdultos
                        rowres = bloqueos.Tables(0).Select(filblo, "habitacion_id")
                        cantc = AgruparRowsPor(rowres, "habitacion_id", "habitacion_id", "reserva_id").Count
                    End If


                    If IsNothing(cantc) Or IsDBNull(cantc) Then
                        cantc = 0
                    End If
                    If IsNothing(cantc1) Or IsDBNull(cantc1) Then
                        cantc1 = 0
                    End If
                    'row.Item("disponibles") += cantc1
                    cantc += cantc1

                    row.Item("ocupadas1") = totc + cantc1
                    row.Item("ocupadas") = totc + cantc
                    'filtrar reservas ke tengan tipo de habitacion
                    Dim filtraReservasPorHab As String = ""
                    If tipo_habitacion_id <> 0 Then
                        Dim rowHabs() As DataRow = orders.Select(filtroHabitaciones)
                        Dim enur As IEnumerator = rowHabs.GetEnumerator
                        Dim dr As DataRow
                        While enur.MoveNext
                            dr = enur.Current
                            filtraReservasPorHab &= dr("reserva_id") & ","
                            'If filtraReservasPorHab = "" Then
                            'filtraReservasPorHab = dr("reserva_id")
                            'Else
                            'filtraReservasPorHab = filtraReservasPorHab & "," & dr("reserva_id")
                            'End If
                        End While
                        If filtraReservasPorHab <> "" Then
                            filtraReservasPorHab = filtraReservasPorHab.Substring(0, filtraReservasPorHab.Length - 1)
                        Else
                            filtraReservasPorHab = "0"
                        End If
                        filtraReservasPorHab = "reserva_id in (" & filtraReservasPorHab & ") and "
                        If resmat <> "" Then
                            filtraReservasPorHab = " reserva_id in (" & resmat & ") and "
                        End If
                    End If
                    rows = orders.Select(filtraReservasPorHab & filtroAdultos, "reserva_id,unidad_calculo_id")
                    matucs = AgruparRowsPor(rows, "reserva_id", "unidad_calculo_id", "cantidad")
                    Dim enuc As IEnumerator = matucs.Keys.GetEnumerator

                    Dim keytot As String = ""
                    Dim keyto As String
                    While enuc.MoveNext
                        keyto = ""
                        Select Case enuc.Current
                            Case 2
                                keyto = "A"
                            Case 3
                                keyto = "N1"
                            Case 4
                                keyto = "N2"
                            Case 5
                                keyto = ""
                        End Select

                        If keyto <> "" Then
                            Dim kk = matucs(enuc.Current)
                            rows = orders.Select(filtraReservasPorHab & filtroPensiones & " and unidad_calculo_id=" & enuc.Current, "reserva_id,ucidabre")
                            matpen = AgruparRowsPor(rows, "reserva_id", "ucidabre", "cantidad", 3)

                            Dim enug As IEnumerator = matpen.Keys.GetEnumerator
                            While enug.MoveNext
                                Try
                                    Dim k = matpen(enug.Current)
                                    kk -= k
                                    row.Item(enug.Current & "_" & keyto) += k
                                Catch ex As Exception

                                End Try

                            End While
                            row.Item("SS_" & keyto) += kk

                        End If

                    End While
                    row.Item("SS_B") = 0    'bebes en solo alojamiento cuenta como zero

                    rows = orders.Select(filtraReservasPorHab & filtroPensiones, "reserva_id,ucidabre")
                    matpen = AgruparRowsPor(rows, "reserva_id", "ucidabre", "cantidad", 3)

                    'DESIC Calculo de llegadas para quitar de los desayunos
                    rowsLlegadas = orders.Select(filtraReservasPorHab & " tipo_servicio_id = 2 and fecha_desde = '" & fechaini & "'", "reserva_id,ucidabre")
                    matpenLlegadas = AgruparRowsPor(rowsLlegadas, "reserva_id", "ucidabre", "cantidad", 3)

                    Dim enugLlegadas As IEnumerator = matpenLlegadas.Keys.GetEnumerator
                    While enugLlegadas.MoveNext
                        Try
                            Dim k = matpenLlegadas(enugLlegadas.Current)
                            row.Item("llegadas" & "_" & enugLlegadas.Current) += k
                        Catch ex As Exception

                        End Try
                    End While
                    'FIN DESIC

                    'DESIC Calculo de salidas para añadir de los desayunos
                    rowsSalidas = orders.Select(filtraReservasPorHab & " tipo_servicio_id = 2 and fecha_hasta = '" & fechaini & "'", "reserva_id,ucidabre")
                    matpenSalidas = AgruparRowsPor(rowsSalidas, "reserva_id", "ucidabre", "cantidad", 3)

                    Dim enugSalidas As IEnumerator = matpenSalidas.Keys.GetEnumerator
                    While enugSalidas.MoveNext
                        Try
                            Dim k = matpenSalidas(enugSalidas.Current)
                            row.Item("salidas" & "_" & enugSalidas.Current) += k
                        Catch ex As Exception

                        End Try
                    End While
                    'FIN DESIC

                    'por cada ucs obtener las pensiones

                Else
                    matpen = New Hashtable
                    matpenLlegadas = New Hashtable
                    matpenSalidas = New Hashtable
                    matucs = New Hashtable
                End If
                matpen("SS") += 0
                matpen("HD") += 0
                matpen("MP") += 0
                matpen("PC") += 0
                matpen("TI") += 0

                'matpen("SS") = matpen("A1") + matpen("A2")
                matucs("5") += 0
                matucs("2") += 0
                matucs("3") += 0
                matucs("4") += 0
                matucs("7") += 0

                row.Item("TPax") = matucs("2") + matucs("3") + matucs("4") 'adultos
                row.Item("Adultos") = matucs("2")
                row.Item("Bebes") = matucs("5") 'bebes
                row.Item("Ninos") = matucs("3")  'niños
                row.Item("Ninos2") = matucs("4") 'niños2
                If row.Item("PorOcup") = 0 Then
                    row.Item("PorOcup") = 0
                Else
                    row.Item("PorOcup") = (row.Item("TPax") / row.Item("PorOcup")) * 100
                End If


                matpen("SS") = row.Item("TPax") - matpen("HD") - matpen("MP") - matpen("PC") - matpen("TI")
                Dim x As IEnumerator = matpen.Keys.GetEnumerator()
                While x.MoveNext
                    Try
                        row.Item(x.Current) = matpen(x.Current)
                    Catch ex As Exception

                    End Try

                End While

                Dim llegadasRestarDesayuno As Integer = row.Item("llegadas_HD") + row.Item("llegadas_MP") + row.Item("llegadas_PC") + row.Item("llegadas_TI")
                Dim salidasSumarDesayuno As Integer = row.Item("salidas_HD") + row.Item("salidas_MP") + row.Item("salidas_PC") + row.Item("salidas_TI")
                row.Item("DE") = row.Item("HD") + row.Item("MP") + row.Item("PC") + row.Item("TI") - llegadasRestarDesayuno + salidasSumarDesayuno
                row.Item("AL") = row.Item("PC") + row.Item("TI")
                row.Item("CE") = row.Item("MP") + row.Item("PC") + row.Item("TI")

                If row.IsNull("ocupadas") Then
                    row.Item("ocupadas") = 0
                End If
                If row.IsNull("disponibles") Then
                    row.Item("disponibles") = 0
                End If
                'row.Item("ocupadas") -= row.Item("salidas")
                'row.Item("disponibles") += row.Item("ocupadas")
                row.Item("libres") = row.Item("disponibles") - row.Item("ocupadas")
                If row("disponibles") = 0 Then
                    row.Item("PorHab") = 0
                Else
                    row.Item("PorHab") = Math.Round((row.Item("ocupadas") / row.Item("disponibles")) * 100, 2)
                End If
                'row.Item("TIPO_HABITACION") = obtieneValorColumna(datosTiposHab, "desc_corta", "tipo_habitacion_id=" & tipo_habitacion_id, "00")

                row.Item("TIPO_HABITACION") = pre_tipo_hab
                fechaini = fechaini.AddDays(1)
            End While
            Dim xxl1 As TimeSpan = (Now - dtbig)
            Console.WriteLine(xxl1.ToString)

            'mea = stopMeasure(mea)

            Return datos
        End Function
        Private Function obtieneValorColumna(ByVal origen As DataTable, ByVal columna As String, ByVal filtro As String, ByVal defecto As String)
            Dim retvalue As String = defecto
            Dim filas() As DataRow = origen.Select(filtro)
            If filas.Length > 0 Then
                If Not filas(0).IsNull(columna) Then
                    retvalue = filas(0).Item(columna)
                End If
            End If
            Return retvalue
        End Function
        Private Function AgruparRowsPor(ByVal rows() As DataRow, ByVal campo1 As String, ByVal campo2 As String, ByVal campo3 As String, Optional ByVal tam As Integer = 0) As Hashtable
            Dim x As Integer
            Dim lid As String = -1
            Dim ucid As String = "-1"
            Dim ucidcant As Single = 0
            Dim matucs As New Hashtable
            Dim acucid As String
            Dim z As Integer = rows.Length - 1
            Dim tcampo1
            For x = 0 To z
                tcampo1 = rows(x).Item(campo1)
                acucid = rows(x).Item(campo2)
                If ucid = "-1" Then
                    ucid = acucid
                    lid = tcampo1
                    ucidcant = 0
                End If
                If ucid = acucid And lid = tcampo1 And rows(x).Item(campo3) > ucidcant Then
                    ucidcant = rows(x).Item(campo3)
                End If
                If (lid <> tcampo1 Or ucid <> acucid) Then
                    If tam > 0 Then
                        matucs(ucid.Substring(ucid.Length - 2)) += ucidcant
                    Else
                        matucs(ucid) += ucidcant
                    End If
                    ucid = "-1"
                    lid = -1
                    x -= 1
                End If
            Next
            If ucid <> "-1" Then
                If tam > 0 Then
                    matucs(ucid.Substring(ucid.Length - 2)) += ucidcant
                Else
                    matucs(ucid) += ucidcant
                End If
            End If

            Return (matucs)
        End Function
        Public Sub dumpDataTable(ByVal tabla As DataRow(), Optional ByVal campos As ArrayList = Nothing)
            Dim y As Integer
            Dim x As Integer
            If IsNothing(campos) Then
                For y = 0 To tabla.Length - 1
                    For x = 0 To tabla(0).Table.Columns.Count - 1
                        If tabla(y).IsNull(x) Then
                            Console.Write("null ,")
                        Else
                            Try
                                Console.Write(tabla(y).Item(x))
                                Console.Write(" ,")
                            Catch ex As Exception

                            End Try

                        End If

                    Next
                    Console.WriteLine()
                Next
            Else
                For y = 0 To tabla.Length - 1
                    For x = 0 To campos.Count - 1
                        If tabla(y).IsNull(campos(x)) Then
                            Console.Write("null ,")
                        Else
                            Try
                                Console.Write(tabla(y).Item(campos(x)))
                                Console.Write(" ,")
                            Catch ex As Exception

                            End Try

                        End If

                    Next
                    Console.WriteLine()
                Next
            End If


        End Sub
        Public Sub dumpDataTable(ByVal tabla As DataTable)
            Dim readerd As DataTableReader = tabla.CreateDataReader
            Dim x
            While readerd.Read
                For x = 0 To tabla.Columns.Count - 1
                    If readerd.IsDBNull(x) Then
                        Console.Write("null ,")
                    Else
                        Try
                            Console.Write(readerd.Item(x) & " ,")
                        Catch ex As Exception

                        End Try

                    End If

                Next
                Console.WriteLine()
            End While
        End Sub
        Public Function dumpResultado(ByVal resultado As tablaServicios)

            Dim readerd As DataTableReader = resultado.ordenarPor("fecha").ToTable.CreateDataReader
            While readerd.Read
                Console.WriteLine(readerd.Item("fecha_llegada") & "-" & readerd.Item("fecha") & "-" & readerd.Item("descripcion") & "-" & readerd.Item("cantidad") & "-" & readerd.Item("servicio_id") & "-" & readerd.Item("precio") & "-" & readerd.Item("importe") & "-" & readerd.Item("impuesto_id") & "-" & readerd.Item("porc_impuesto"))
            End While
            Return True
        End Function
        Public Function TestDB()
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim x = ExecuteScalar(cmd, "select count(*) from aplicaciones")
            Console.Write("Aplicaciones:" & x)
            flushConection(cmd, errorCode)
            Return errorCode
        End Function

        Public Sub New(ByVal uid As Integer)
            userId = uid
        End Sub

        Public Class BaseCCI
            Private TotalesImpuestos As Hashtable = New Hashtable()
            Private TotalesBases As Hashtable = New Hashtable()
            Public Total As Decimal
            Function agregaImpuesto(ByVal porcentaje As Decimal, ByVal base As Decimal)
                'todo round
                Dim antbase As Decimal = TotalesBases.Item(porcentaje)
                antbase += base
                Total += base
                TotalesBases.Item(porcentaje) = antbase
                Dim cuota As Decimal
                'cuota = Decimal.Round(((porcentaje * base) / 100), 2, MidpointRounding.AwayFromZero)
                cuota = ((porcentaje * base) / 100)
                Total += cuota
                cuota = Decimal.Round(cuota, 2, MidpointRounding.AwayFromZero)
                Dim ant As Decimal = TotalesImpuestos.Item(porcentaje)
                ant += cuota
                'Total += cuota
                TotalesImpuestos.Item(porcentaje) = ant
                Return cuota
            End Function
            Function obtieneImpuestos()
                Dim ar As New ArrayList
                Dim enu As IEnumerator = TotalesBases.Keys.GetEnumerator
                While enu.MoveNext
                    Dim ar1 As New ArrayList
                    ar1.Add(TotalesBases.Item(enu.Current))
                    ar1.Add(enu.Current)
                    ar1.Add(TotalesImpuestos.Item(enu.Current))
                    ar.Add(ar1)
                End While

                Return ar
            End Function
        End Class
        Shared sqlObtieneCierreFechaHotel = "select * from cierres where hotel_id=? and fecha_cierre=?"
        Shared sqlObtieneEmpresaHotel = "select empresa_contable from hoteles,empresas where empresas.empresa_id=hoteles.empresa_id and hotel_id=?"
        Function CrearCierreContable(ByVal fecha As Date, ByVal hotel_id As Integer)
            'comprobar que no se haya generado el cierre contable anteriormente
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = CrearCierreContable(cmd, fecha, hotel_id)
            If Not retVal Then
                errorCode = 1
            End If
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Shared sqlDatosFicheroPolicia As String = "SELECT hoteles.hotel,hoteles.ruta_fichero_policia,hoteles.contador_fichero_policia,hoteles.identificador_fichero_policia FROM hoteles WHERE hoteles.hotel_id = ?"
        Shared sqlLineasFicheroPolicia As String = "" _
& " SELECT distinct clientes.nif,clientes.tipo_documento_id AS tipo,clientes.fecha_documento,clientes.razon,clientes.sexo_id,clientes.fecha_nacimiento,reservas_huespedes.fecha_llegada,naciones.nacion " _
& " FROM reservas_huespedes Inner Join clientes ON reservas_huespedes.cliente_id = clientes.cliente_id " _
& " Inner Join reservas ON reservas.reserva_id = reservas_huespedes.reserva_id " _
& " Inner Join naciones ON clientes.nacion_id = naciones.nacion_id " _
& " WHERE reservas.estado_reserva_id >=3 AND reservas.hotel_id =  ? AND reservas_huespedes.fecha_llegada =  ? AND fecha_documento IS NOT NULL AND fecha_nacimiento IS NOT NULL AND nif IS NOT NULL"
        Shared sqlIncrementaContadorFicheroPolicia = "UPDATE hoteles SET contador_fichero_policia=Coalesce(contador_fichero_policia,0)+1 WHERE hoteles.hotel_id = ?"
        Function CrearFicheroPolicia(ByVal fecha As Date, ByVal hotel_id As Integer)
            'comprobar que no se haya generado el cierre contable anteriormente
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = CrearFicheroPolicia(cmd, fecha, hotel_id)
            If Not retVal Then
                errorCode = 1
            End If
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function
        Private Function CrearFicheroPolicia(ByVal cmd As MySqlCommand, ByVal fecha As Date, ByVal hotel_id As Integer) As Boolean
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Try
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim fechaParam As New MySqlParameter("@fecha", fecha)
                cmd.Parameters.Add(hotel_idParam)
                'obtiene parametros fichero policia del hotel
                Dim reader As DataTableReader = getDataTable(cmd, sqlDatosFicheroPolicia)
                cmd.Parameters.Add(fechaParam)
                Dim cierre As DataSet = Me.getDataSet(cmd, sqlObtieneCierreFechaHotel)
                If cierre.Tables(0).Rows.Count > 0 Then

                    While reader.Read
                        'obtiene llegadas de ese dia
                        Dim lineas As DataTableReader = getDataTable(cmd, sqlLineasFicheroPolicia)
                        '-------------------------------------------------------------------------------------------
                        ' Solo si hay llegadas genero el fichero de policia, sino ni incremento el contador
                        ' Modificacion 13/12/2013 Javier Nuñez
                        ' Requerimiento por los dias sin llegada de PCTF
                        '-------------------------------------------------------------------------------------------
                        If lineas.HasRows Then
                            ExecuteScalar(cmd, sqlIncrementaContadorFicheroPolicia)
                            Dim fp As New FicheroPolicia
                            fp.FicheroPolicia(reader.Item("identificador_fichero_policia"), reader.Item("ruta_fichero_policia"), reader.Item("hotel"), reader.Item("contador_fichero_policia"))
                            While lineas.Read
                                Try
                                    Dim razon As String = lineas.Item("razon")
                                    Dim matnom() As String = razon.Split(" ")
                                    Dim ape1 As String = ""
                                    Dim ape2 As String = ""
                                    Dim nombre As String = ""
                                    If matnom.Length = 1 Then
                                        ape1 = matnom(0)
                                    End If
                                    If matnom.Length = 2 Then
                                        ape1 = matnom(0)
                                        nombre = matnom(1)
                                    End If
                                    If matnom.Length = 3 Then
                                        ape1 = matnom(0)
                                        ape2 = matnom(1)
                                        nombre = matnom(2)
                                    End If
                                    If matnom.Length > 3 Then
                                        ape1 = matnom(0)
                                        ape2 = matnom(1)
                                        nombre = matnom(matnom.Length - 1)
                                    End If

                                    fp.agregaLinea(lineas.Item("nif"), lineas.Item("tipo"), lineas.Item("fecha_documento"), ape1, ape2, nombre, lineas.Item("sexo_id"), lineas.Item("fecha_nacimiento"), lineas.Item("nacion"), lineas.Item("fecha_llegada"))

                                Catch ex As Exception
                                    Return False
                                End Try
                            End While
                            fp.generarFichero()
                            cierre.Tables(0).Rows(0).Item("fichero_policia") = fp.rutas(0)
                            Dim writer As MySqlDataAdapter
                            writer = getDataAdapter(cmd, sqlObtieneCierreFechaHotel)
                            writer.Fill(cierre.Tables(0))
                            writer.Update(cierre.Tables(0))
                        End If
                    End While
                End If

                retVal = True
            Catch ex As Exception
                Return False
            End Try
            Return retVal
        End Function

        Function CrearCierreContable(ByVal cmd As MySqlCommand, ByVal fecha As Date, ByVal hotel_id As Integer)
            'comprobar que no se haya generado el cierre contable anteriormente
            Dim retVal As Boolean = False
            Dim errorCode As Integer = 0
            cmd.Parameters.Clear()
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim fechaParam As New MySqlParameter("@fecha", fecha)
            cmd.Parameters.Add(hotel_idParam)
            Dim emp As String = ExecuteScalar(cmd, sqlObtieneEmpresaHotel)
            cmd.Parameters.Add(fechaParam)

            If Not emp Is Nothing Then

                Dim empano As String = emp.Substring(0, 3) & fecha.Year

                Dim cierre As DataSet = Me.getDataSet(cmd, sqlObtieneCierreFechaHotel)

                If cierre.Tables(0).Rows.Count > 0 Then
                    'se podria cerrar
                    'prepara fichero contable
                    If cierre.Tables(0).Rows(0).IsNull("fecha_contabilizacion") Then 'quitar

                        Dim fc As FicheroContabilidad = ObtieneFicheroConta(cmd, fecha, hotel_id, "Gestion Hotelera") '001 empresa '06 año                       
                        If GeneraAsientosProduccion(cmd, fc) Then
                            If GeneraAsientosFacturas(cmd, fc, "RECEP2") Then
                                'fc.generaImpuestos("RECEP2")
                                If GeneraAsientosMovimientosCaja(cmd, fc, "RECEP3") Then
                                    If GeneraAsientosMovimientosCaja(cmd, fc, "RECEP5") Then
                                        If GeneraAsientosFacturas(cmd, fc, "RECEP4") Then
                                            If fc.generarFichero() Then
                                                'todo actualizar cierre
                                                cierre.Tables(0).Rows(0).Item("fichero_cierre") = fc.rutas(1)
                                                cierre.Tables(0).Rows(0).Item("fecha_contabilizacion") = Now
                                                retVal = True
                                            Else
                                                errorCode = 3 'no pude crear el fichero de cierre
                                                AgregaInfo("CrearCierreContable", "No pude crear el fichero de cierre:" & fecha, -errorCode)
                                            End If
                                        Else
                                            errorCode = 8 'fallo al crear asiento facturas recep4
                                            AgregaInfo("CrearCierreContable", "Fallo al crear asiento facturas recep4:" & fecha, -errorCode)
                                        End If
                                    Else
                                        errorCode = 9 'fallo al crear asiento cajas recep5
                                        AgregaInfo("CrearCierreContable", "Fallo al crear asiento cajas recep5:" & fecha, -errorCode)
                                    End If
                                Else
                                    errorCode = 7 'fallo al crear asiento cajas
                                    AgregaInfo("CrearCierreContable", "Fallo al crear asiento cajas recep3:" & fecha, -errorCode)
                                End If
                            Else
                                errorCode = 6 'fallo al crear asiento facturas
                                AgregaInfo("CrearCierreContable", "Fallo al crear asiento facturas:" & fecha, -errorCode)
                            End If
                        Else
                            errorCode = 5 'fallo al crear asiento produccion
                            AgregaInfo("CrearCierreContable", "Fallo al crear asiento produccion:" & fecha, -errorCode)
                        End If
                    Else
                        errorCode = 2 'ya estaba cerrado
                        AgregaInfo("CrearCierreContable", "Ya estaba cerrado:" & fecha, -errorCode)
                    End If
                Else
                    errorCode = 1 'no hay cierre del hotel
                    AgregaInfo("CrearCierreContable", "No hay cierre del hotel:" & fecha, -errorCode)
                End If
                If errorCode = 0 Then
                    Dim writer As MySqlDataAdapter
                    writer = getDataAdapter(cmd, sqlObtieneCierreFechaHotel)
                    writer.Fill(cierre.Tables(0))
                    writer.Update(cierre.Tables(0))
                End If
            Else
                errorCode = 4 'empresa no tiene asignado centro contable
                AgregaInfo("CrearCierreContable", "Empresa no tiene asignado centro contable:" & fecha, -errorCode)
            End If

            'Generar Asientos de Produccion
            'Generar Asientos de Facturas
            'Generar Asientos de Movimientos de Caja

            Return retVal

        End Function
        Shared sqlDatosContablesHotelOld = "select cta_manocorriente,dpto_contable,(select c.cta_contable_anticipo from clientes c where c.empresa_id=hoteles.empresa_id and c.cliente_defecto=1 limit 0,1) as cta_contable_anticipo_defecto,(select c.cta_contable from clientes c where c.empresa_id=hoteles.empresa_id and c.cliente_defecto=1 limit 0,1) as cta_contable_defecto,(select c.dpto_contable from clientes c where c.empresa_id=hoteles.empresa_id and c.cliente_defecto=1 limit 0,1) as dpto_contable_defecto from hoteles where hotel_id=?"
        Shared sqlDatosContablesHotel = "" _
        & " select cta_manocorriente,dpto_contable," _
& " Coalesce((select ch.cta_depositos from clientes c inner join clientes_hotel ch on c.cliente_id=ch.cliente_id  where length(ch.cta_depositos)<>0 and ch.hotel_id=hoteles.hotel_id and c.cliente_defecto=1 limit 0,1) ,(select c.cta_depositos from clientes c  where c.empresa_id=hoteles.empresa_id and c.cliente_defecto=1 limit 0,1)) as cta_deposito_defecto, " _
& " Coalesce((select ch.cta_anticipos from clientes c inner join clientes_hotel ch on c.cliente_id=ch.cliente_id  where length(ch.cta_anticipos)<>0 and ch.hotel_id=hoteles.hotel_id and c.cliente_defecto=1 limit 0,1) ,(select c.cta_contable_anticipo from clientes c  where c.empresa_id=hoteles.empresa_id and c.cliente_defecto=1 limit 0,1)) as cta_contable_anticipo_defecto, " _
& " Coalesce((select ch.cta_contable from clientes c inner join clientes_hotel ch on c.cliente_id=ch.cliente_id  where length(ch.cta_contable)<>0 and ch.hotel_id=hoteles.hotel_id and c.cliente_defecto=1 limit 0,1) ,(select c.cta_contable from clientes c  where c.empresa_id=hoteles.empresa_id and c.cliente_defecto=1 limit 0,1)) as cta_contable_defecto, " _
& " Coalesce((select ch.dpto_contable from clientes c inner join clientes_hotel ch on c.cliente_id=ch.cliente_id  where length(ch.dpto_contable)<>0 and ch.hotel_id=hoteles.hotel_id and c.cliente_defecto=1 limit 0,1) ,(select c.dpto_contable from clientes c  where c.empresa_id=hoteles.empresa_id and c.cliente_defecto=1 limit 0,1)) as dpto_contable_defecto " _
& " from hoteles where hotel_id=? "


        Shared sqlApuntesProduccion = "" _
    & "     SELECT" _
    & " lineas_factura.fecha, " _
    & " servicios_hotel.cta_contable," _
    & " servicios_hotel.dpto_contable, " _
    & " round(Sum((lineas_factura.cantidad*Coalesce(lineas_factura.precio_produccion,lineas_factura.precio))*100/(100+lineas_factura.porc_impuesto)),2) AS total, " _
    & " lineas_factura.servicio_id " _
    & " FROM " _
    & " lineas_factura " _
    & " Inner Join servicios_hotel ON lineas_factura.hotel_id = servicios_hotel.hotel_id AND lineas_factura.servicio_id = servicios_hotel.servicio_id" _
    & " WHERE  " _
    & " lineas_factura.hotel_id =  ?  and lineas_factura.fecha = ?" _
    & " GROUP BY " _
    & " lineas_factura.servicio_id"
        '   & " Sum(round((lineas_factura.cantidad*Coalesce(lineas_factura.precio_produccion,lineas_factura.precio))*100/(100+lineas_factura.porc_impuesto),2)) AS total, " _

        Private Function GeneraAsientosProduccion(ByVal cmd As MySqlCommand, ByVal fc As FicheroContabilidad)
            'fc.agregarApunte("ANTICI", signoc, .Item("Fecha_Anticipo"), "", "", .Item("Cta_Cliente_Anticipo"), descriptivoCliente, multiplicador * .Item("Importe"))
            'todo filtrar por sw_produccion

            Dim retValue As Boolean = True
            Dim readerHotel As DataTableReader = getDataTable(cmd, sqlDatosContablesHotel)
            Dim reader As DataTableReader = getDataTable(cmd, sqlApuntesProduccion)
            'Dim reader As DataTableReader = Me.getDataSet(cmd, sqlApuntesProduccion).CreateDataReader
            Dim total As Single = 0
            Dim counter As Integer
            Dim fecha As Date
            While reader.Read And retValue
                counter += 1
                total += reader.Item("total")
                fecha = reader.Item("fecha")

                If reader.IsDBNull(reader.GetOrdinal("dpto_contable")) Or reader.IsDBNull(reader.GetOrdinal("cta_contable")) Then
                    'servicio no tiene los datos contables para ese hotel
                    retValue = False
                Else
                    If reader.Item("total") <> 0 Then
                        fc.agregarApunte("RECEP1", "H", reader.Item("fecha"), "", reader.Item("dpto_contable"), reader.Item("cta_contable"), "PRODUCCION DEL DIA", reader.Item("total"))
                    End If
                End If
            End While
            If counter > 0 And retValue Then
                If readerHotel.Read() Then
                    If readerHotel.IsDBNull(readerHotel.GetOrdinal("dpto_contable")) Or readerHotel.IsDBNull(readerHotel.GetOrdinal("cta_manocorriente")) Then
                        retValue = False
                        'los datos contables estan incompletos
                    Else
                        'redondeo ya que al sumar los singles..pueden salir 3 decimales.
                        total = Math.Round(total, 2, MidpointRounding.AwayFromZero)
                        fc.agregarApunte("RECEP1", "D", fecha, "", readerHotel.Item("dpto_contable"), readerHotel.Item("cta_manocorriente"), "PRODUCCION CREDITO DIA", total)
                    End If
                Else
                    retValue = False
                    'no existen datos contables del hotel
                End If
            End If
            Return retValue
        End Function

        Shared sqlApuntesMovimientosCajaCobros = "" _
    & " SELECT" _
    & " facturas.serie_id, " _
    & " series.abreviatura,facturas.numero_factura, " _
    & " Coalesce(facturas.ref_fra2,' ') as ref_fra2, " _
    & " cobros.cobro_id, " _
    & " cobros.hotel_id, " _
    & " cobros.fecha, " _
    & " cobros.tipo_cobro_id, " _
    & " clientes.razon As razon, clientes.nif, " _
    & " Sum(lineas_cobro.importe) AS total, " _
    & " Coalesce(clientes_hotel.cta_anticipos,clientes.cta_contable_anticipo) AS cta_contable_cliente_anticipo, " _
    & " Coalesce(clientes_hotel.cta_depositos,clientes.cta_depositos) AS cta_contable_depositos, " _
    & " Coalesce(clientes_hotel.cta_contable,clientes.cta_contable) AS cta_contable_cliente, " _
    & " Coalesce(cuentas_bancarias.cta_contable,formas_pago_hotel.cta_contable) As cta_contable, " _
    & " Coalesce(clientes_hotel.dpto_contable,clientes.dpto_contable) AS dpto_contable_cliente, " _
    & " formas_pago_hotel.cta_contable, " _
    & " formas_pago_hotel.dpto_contable, " _
    & " tipos_cobro.descripcion AS descriptivo, " _
    & " (SELECT servicios_hotel.cta_contable FROM lineas_factura Inner Join servicios_hotel ON lineas_factura.servicio_id = servicios_hotel.servicio_id AND lineas_factura.hotel_id = servicios_hotel.hotel_id where facturas.serie_id=8 and lineas_factura.factura_id=facturas.factura_id LIMIT 1) as cta_contable_serie, " _
    & " (SELECT servicios_hotel.dpto_contable FROM lineas_factura Inner Join servicios_hotel ON lineas_factura.servicio_id = servicios_hotel.servicio_id AND lineas_factura.hotel_id = servicios_hotel.hotel_id where facturas.serie_id=8 and lineas_factura.factura_id=facturas.factura_id LIMIT 1) as dpto_contable_serie, " _
    & " (select cierre_dia from cajas where cajas.caja_id=cobros.caja_id) as cierre_dia " _
    & " FROM " _
    & " cobros " _
    & " Left Join tipos_cobro ON cobros.tipo_cobro_id = tipos_cobro.tipo_cobro_id " _
    & " Left Join lineas_cobro ON lineas_cobro.cobro_id = cobros.cobro_id " _
    & " Left Join facturas ON lineas_cobro.factura_id = facturas.factura_id " _
    & " Left Join clientes_hotel ON clientes_hotel.hotel_id = facturas.hotel_id and clientes_hotel.cliente_id=facturas.cliente_id " _
    & " Left Join clientes ON facturas.cliente_id = clientes.cliente_id " _
    & " Left Join cuentas_bancarias ON cobros.cta_bancaria_id = cuentas_bancarias.cta_bancaria_id " _
    & " Left Join formas_pago_hotel ON cobros.hotel_id = formas_pago_hotel.hotel_id AND cobros.forma_pago_id = formas_pago_hotel.forma_pago_id " _
    & " Inner Join series ON facturas.serie_id = series.serie_id " _
    & " WHERE " _
    & "      cobros.hotel_id =  ? AND " _
    & "      cobros.fecha =  ? " _
    & " GROUP BY" _
    & "      cobros.hotel_id, " _
    & "      cobros.fecha, " _
    & "      cobros.tipo_cobro_id, " _
    & "      cobros.cobro_id, " _
    & "     lineas_cobro.factura_id " _
    & " order by" _
    & " cierre_dia,hotel_id,fecha,tipo_cobro_id,cobro_id,lineas_cobro.factura_id"

        Shared sqlApuntesMovimientosCajaAnticipos = "" _
    & " SELECT      anticipos.anticipo_id, " _
    & "      anticipos.hotel_id, " _
    & "     anticipos.fecha, " _
    & "     anticipos.tipo_anticipo_id, " _
    & "      anticipos.importe AS total, " _
    & "      clientes.cta_contable_anticipo AS cta_contable_cliente_anticipo, clientes.nif, " _
    & "      clientes.cta_contable AS cta_contable_cliente, " _
    & "      clientes.dpto_contable AS dpto_contable_cliente, " _
    & "      formas_pago_hotel.cta_contable, " _
    & "      formas_pago_hotel.dpto_contable " _
    & " FROM " _
    & " anticipos " _
    & " Left Join formas_pago_hotel ON anticipos.hotel_id = formas_pago_hotel.hotel_id AND anticipos.forma_pago_id = formas_pago_hotel.forma_pago_id" _
    & " Left Join clientes ON anticipos.cliente_id = clientes.cliente_id " _
    & " WHERE " _
    & "      anticipos.hotel_id =  ? AND " _
    & "      anticipos.fecha =  ? " _
    & " GROUP BY " _
    & "      anticipos.hotel_id, " _
    & "      anticipos.fecha, " _
    & "      anticipos.tipo_anticipo_id, " _
    & "      anticipos.anticipo_id "
        Shared sqlApuntesMovimientosCajaFalSob = "" _
    & " SELECT" _
    & " arqueos_caja.arqueo_id, " _
    & " cajas.hotel_id, " _
    & " arqueos_caja.fecha, " _
    & " lineas_arqueo.importe_teorico-lineas_arqueo.importe_real AS total, " _
    & " Coalesce(cajas.cta_contable,hoteles.cta_contable_cajas) AS cta_contable_cliente," _
    & " Coalesce(cajas.dpto_contable,hoteles.dpto_contable) AS dpto_contable_cliente, " _
    & " formas_pago_hotel.cta_contable, " _
    & " formas_pago_hotel.dpto_contable,cajas.nombre_caja as descriptivo " _
    & " FROM " _
    & " arqueos_caja " _
    & " Left Join cajas ON arqueos_caja.caja_id = cajas.caja_id " _
    & " Left Join lineas_arqueo ON arqueos_caja.arqueo_id = lineas_arqueo.arqueo_id " _
    & " Left Join formas_pago_hotel ON cajas.hotel_id = formas_pago_hotel.hotel_id AND lineas_arqueo.forma_pago_id = formas_pago_hotel.forma_pago_id" _
    & " Left join hoteles on cajas.hotel_id=hoteles.hotel_id" _
    & " WHERE " _
    & "           cajas.hotel_id =  ? AND  " _
    & "           arqueos_caja.fecha=  ? " _
    & " and arqueos_caja.tipo_arqueo_id=2 " _
    & " GROUP BY  " _
    & " cajas.hotel_id, " _
    & " arqueos_caja.fecha, lineas_arqueo.forma_pago_id," _
    & " arqueos_caja.arqueo_id order by arqueos_caja.arqueo_id"
        Shared sqlApuntesMovimientosCajaDotRet = "" _
    & " SELECT " _
    & " dotaciones.dotacion_id, " _
    & " dotaciones.hotel_id, " _
    & " dotaciones.fecha, " _
    & " dotaciones.tipo_dotacion_id, " _
    & " dotaciones.importe AS total, " _
    & " hoteles.cta_contable_banco AS cta_contable_cliente," _
    & " hoteles.dpto_contable AS dpto_contable_cliente, " _
    & " formas_pago_hotel.cta_contable, " _
    & " formas_pago_hotel.dpto_contable, " _
    & " dotaciones.caja_id,cajas.nombre_caja as descriptivo" _
    & " FROM " _
    & " dotaciones Left Join cajas ON dotaciones.caja_id = cajas.caja_id left Join hoteles ON dotaciones.hotel_id = hoteles.hotel_id  " _
    & " ,formas_pago_hotel " _
    & " WHERE  " _
    & "           dotaciones.hotel_id =  ? AND  " _
    & "           dotaciones.fecha =  ? and formas_pago_hotel.forma_pago_id=1 and formas_pago_hotel.hotel_id=dotaciones.hotel_id" _
    & " GROUP BY  " _
    & "           dotaciones.hotel_id,  " _
    & "          dotaciones.fecha,  " _
    & "           dotaciones.tipo_dotacion_id,  " _
    & "           dotaciones.dotacion_id "
        '   & " left Join formas_pago_empresa ON hoteles.empresa_id = formas_pago_empresa.empresa_id  " _
        Shared sqlApuntesMovimientosCajaGastos = "" _
    & " SELECT " _
    & " gastos.gasto_id, " _
    & " gastos.hotel_id, " _
    & " gastos.fecha, " _
    & " gastos.tipo_gasto_id, " _
    & " gastos.importe AS total, " _
    & " tipos_gasto.cta_contable AS cta_contable_cliente, " _
    & " tipos_gasto.dpto_contable AS dpto_contable_cliente, " _
    & " formas_pago_hotel.cta_contable, " _
    & " formas_pago_hotel.dpto_contable, " _
    & " gastos.caja_id, " _
    & " cajas.nombre_caja AS descriptivo, " _
    & " impuestos.porcentaje, " _
    & " impuestos.cta_contable as imp_cta_contable, " _
    & " impuestos.dpto_contable as imp_dpto_contable " _
    & " FROM " _
    & " gastos " _
    & " Left Join tipos_gasto ON tipos_gasto.tipo_gasto_id = gastos.tipo_gasto_id " _
    & " Left Join cajas ON gastos.caja_id = cajas.caja_id " _
    & " Left Join formas_pago_hotel ON gastos.hotel_id = formas_pago_hotel.hotel_id AND gastos.forma_pago_id = formas_pago_hotel.forma_pago_id" _
    & " left Join impuestos ON gastos.impuesto_id = impuestos.impuesto_id " _
    & " WHERE   " _
    & "                gastos.hotel_id =  ? AND   " _
    & "                gastos.fecha = ? " _
    & " GROUP BY   " _
    & " gastos.hotel_id, " _
    & " gastos.fecha, " _
    & " gastos.tipo_gasto_id, " _
    & " gastos.gasto_id "

        Private Class matrizContable
            Public tipoH As String
            Public tipoD As String
            Public mul As Single
        End Class
        Private Function obtieneMatrizSignoContable(ByVal valor As Single) As matrizContable
            Dim x As New matrizContable
            x.tipoH = "H"
            x.tipoD = "D"
            x.mul = 1
            If valor < 0 Then
                x.tipoH = "D"
                x.tipoD = "H"
                x.mul = -1
            End If
            Return x
        End Function
        Private Function GeneraAsientosMovimientosCaja(ByVal cmd As MySqlCommand, ByVal fc As FicheroContabilidad, ByVal apunteDesc As String)
            'todo cambiar
            'cobros
            'todo comprobar cuentas.
            'Dim  apunteDesc= "RECEP3"
            Dim cpparam(cmd.Parameters.Count - 1) As MySqlParameter
            cmd.Parameters.CopyTo(cpparam, 0)

            Dim readerHotel As DataTableReader = getDataTable(cmd, sqlDatosContablesHotel)
            readerHotel.Read()
            Dim cta_contable_anticipo_defecto As String = readerHotel.Item("cta_contable_anticipo_defecto")
            Dim cta_contable_defecto As String = readerHotel.Item("cta_contable_defecto")
            Dim dpto_contable_defecto As String = readerHotel.Item("dpto_contable_defecto")
            Dim cta_depositos_defecto As String = readerHotel.Item("cta_deposito_defecto")
            Dim retval As Boolean = True
            Dim errroCode As Integer = 0

            Dim reader As DataTableReader

            If retval Then
                'cobros/devolucion--depositios/dev.depo--cobros anticipos.
                reader = getDataTable(cmd, sqlApuntesMovimientosCajaCobros)
                Dim cobros As New Hashtable
                Dim lcobro_id As Integer = -1
                Dim cta_contable_cliente As String = ""
                Dim dpto_contable_cliente As String = ""
                Dim dpto_contable As String = ""
                Dim cta_contable As String = ""
                Dim campocuenta As String = ""
                Dim fecha As Date = Nothing
                Dim razon As String = ""
                Dim Nif As String = ""
                'Dim matcont As matrizContable
                Dim descrip As String
                If apunteDesc = "RECEP5" Then
                    apunteDesc = "RECEP5"
                End If
                While reader.Read And retval
                    Try
                        Dim cierre_dia As Integer = reader("cierre_dia")
                        If (apunteDesc = "RECEP3" And cierre_dia = 0) Or (apunteDesc <> "RECEP3" And cierre_dia = 1) Then
                            'no toka en este pase
                        Else
                            If Not cobros.ContainsKey(reader.Item("cobro_id")) Then
                                If lcobro_id <> -1 Then
                                    '    matcont = obtieneMatrizSignoContable(cobros(lcobro_id))
                                    '   fc.agregarApunte(apunteDesc, matcont.tipoD, fecha, "", dpto_contable, cta_contable, "Cobro " & lcobro_id, cobros(lcobro_id) * matcont.mul, 0, False)
                                    'matcont = obtieneMatrizSignoContable(cobros(lcobro_id))
                                    'Garra de Javier se pone el nombre del cliente
                                    'razon = reader.Item("razon")
                                    If IsDBNull(reader.Item("nif")) Then
                                        Nif = "99999999R"
                                    Else
                                        Nif = reader.Item("nif")
                                    End If
                                    Nif = "" ' SAP No quiere NIF en cobros
                                    fc.agregarApunte(apunteDesc, "D", fecha, "", dpto_contable, cta_contable, "Cobro " & lcobro_id & " " & razon, cobros(lcobro_id), 0, False, Nif, reader.Item("serie_id"))
                                    'fc.agregarApunte(apunteDesc, "D", fecha, "", dpto_contable, cta_contable, "Cobro " & lcobro_id, cobros(lcobro_id), 0, False)
                                End If
                                retval = CambiarEstadoCobro(cmd, reader.Item("cobro_id"), 2, False)
                                If retval Then
                                    cobros(reader.Item("cobro_id")) = 0.0
                                End If
                            End If
                            If retval Then
                                cta_contable_cliente = cta_contable_defecto
                                dpto_contable_cliente = dpto_contable_defecto
                                dpto_contable = reader("dpto_contable")
                                cta_contable = reader("cta_contable")
                                campocuenta = "cta_contable_cliente"
                                fecha = reader.Item("fecha")

                                If Not reader.IsDBNull(reader.GetOrdinal(campocuenta)) Then
                                    cta_contable_cliente = reader.Item(campocuenta)
                                    If Not reader.IsDBNull(reader.GetOrdinal("dpto_contable_cliente")) Then
                                        dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                                    End If
                                End If
                                If Not reader.IsDBNull(reader.GetOrdinal("cta_contable_serie")) Then
                                    cta_contable_cliente = reader.Item("cta_contable_serie")
                                    If Not reader.IsDBNull(reader.GetOrdinal("dpto_contable_serie")) Then
                                        dpto_contable_cliente = reader.Item("dpto_contable_serie")
                                    End If
                                End If
                                ' Garra de Javier
                                If reader.Item("serie_id") = 4 Then
                                    'no existe ese campo
                                    If Not reader.IsDBNull(reader.GetOrdinal("cta_contable_depositos")) Then
                                        cta_contable_cliente = reader.Item("cta_contable_depositos")
                                    Else
                                        cta_contable_cliente = cta_depositos_defecto
                                    End If
                                    If Len(cta_contable_cliente) < 6 Then
                                        cta_contable_cliente = cta_depositos_defecto
                                    End If
                                    If Len(cta_contable_cliente) < 6 Then
                                        cta_contable_cliente = cta_contable_defecto
                                    End If
                                End If

                                If IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                                    retval = False
                                    errroCode = 1   'faltan datos contables
                                Else
                                    'todo agrupar por cobro_id
                                    'meter los cobros en un hash
                                    'actualizar todos los cobros
                                    ' Garra de Javier .....En el cobro salga en el nº de documento el nº de factura
                                    ' Si es un anticipo o deposito - que será reader.item("numero_factura")-1
                                    lcobro_id = reader.Item("cobro_id")
                                    cobros(reader.Item("cobro_id")) += reader.Item("total")
                                    Dim numero_factura As String
                                    If Not reader.IsDBNull(reader.GetOrdinal("numero_factura")) Then
                                        numero_factura = reader.Item("numero_factura")
                                    Else
                                        numero_factura = 0
                                    End If

                                    If reader.Item("serie_id") = 5 Or reader.Item("serie_id") = 4 Then 'anticipos o depositos
                                        descrip = reader.Item("ref_fra2")
                                        If reader.Item("total") < 0 Then
                                            'devolucion del cobro resto 1 a l numero de factura
                                            numero_factura = CInt(numero_factura) - 1
                                        End If
                                    Else
                                        descrip = reader.Item("abreviatura") & " " & numero_factura & " " & reader.Item("ref_fra2")
                                    End If
                                    ' Quieren en el descriptivo el nombre del cliente. Añado por la cara la serie
                                    ' Garra de Javier
                                    If IsDBNull(reader.Item("abreviatura")) Then
                                        descrip = "SIN ABREV" & " " & reader.Item("razon")
                                    Else
                                        descrip = reader.Item("abreviatura") & " " & reader.Item("razon")
                                    End If

                                    'matcont = obtieneMatrizSignoContable(reader.Item("total"))
                                    'fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, reader.Item("total") * matcont.mul, 0, True)
                                    'matcont = obtieneMatrizSignoContable(reader.Item("total"))
                                    'Añado el numero de factura al apunte
                                    If IsDBNull(reader.Item("nif")) Then
                                        Nif = "99999999R"
                                    Else
                                        Nif = reader.Item("nif")
                                    End If
                                    If reader.Item("serie_id") = 8 Then
                                        fc.agregarApunte(apunteDesc, "D", reader.Item("fecha"), CStr(numero_factura), dpto_contable_cliente, cta_contable_cliente, descrip, -reader.Item("total"), 0, True, Nif, reader.Item("serie_id"))
                                    Else
                                        fc.agregarApunte(apunteDesc, "H", reader.Item("fecha"), CStr(numero_factura), dpto_contable_cliente, cta_contable_cliente, descrip, reader.Item("total"), 0, True, Nif, reader.Item("serie_id"))
                                    End If
                                    razon = reader.Item("razon")
                                    'todo actualizar estado cobro(s)
                                End If
                            End If
                        End If
                    Catch ex As Exception
                        Console.WriteLine(ex.Message)
                    End Try

                End While
                If retval Then
                    If lcobro_id <> -1 Then
                        'matcont = obtieneMatrizSignoContable(cobros(lcobro_id))
                        'fc.agregarApunte(apunteDesc, matcont.tipoD, fecha, "", dpto_contable, cta_contable, "Cobro " & lcobro_id, cobros(lcobro_id) * matcont.mul, 0, False)
                        'matcont = obtieneMatrizSignoContable(cobros(lcobro_id))
                        Nif = ""  ' Sap No quiere Nif en cobros
                        fc.agregarApunte(apunteDesc, "D", fecha, "", dpto_contable, cta_contable, "Cobro " & lcobro_id & " " & razon, cobros(lcobro_id), 0, False, Nif, 0)
                    End If
                End If
                cmd.Parameters.Clear()
                cmd.Parameters.AddRange(cpparam)
            End If
            If apunteDesc = "RECEP3" Then

                If retval Then
                    'faltantes/sobrantes cajas
                    reader = getDataTable(cmd, sqlApuntesMovimientosCajaFalSob)
                    Dim larqueo As Integer = -1
                    Dim narqueo As Integer = -1
                    While reader.Read And retval
                        narqueo = reader.Item("arqueo_id")
                        Dim tot As Single = 0
                        If Not reader.IsDBNull(reader.GetOrdinal("total")) Then
                            tot = reader.Item("total")
                        End If

                        If tot <> 0 Then
                            Dim cta_contable_cliente As String = Nothing
                            Dim dpto_contable_cliente As String = Nothing
                            Dim dpto_contable As String = Nothing
                            If Not reader.IsDBNull(reader.GetOrdinal("dpto_contable")) Then
                                dpto_contable = reader.Item("dpto_contable")
                            End If
                            Dim cta_contable As String = Nothing
                            If Not reader.IsDBNull(reader.GetOrdinal("cta_contable")) Then
                                cta_contable = reader.Item("cta_contable")
                            End If
                            If Not reader.IsDBNull(reader.GetOrdinal("cta_contable_cliente")) Then
                                cta_contable_cliente = reader.Item("cta_contable_cliente")
                            End If
                            If Not reader.IsDBNull(reader.GetOrdinal("dpto_contable_cliente")) Then
                                dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                            End If

                            If Not retval Or IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                                retval = False
                                errroCode = 1   'faltan datos contables
                            Else
                                Dim descrip As String = "SOB "
                                If tot < 0 Then
                                    descrip = "FAL "
                                End If
                                descrip += reader.Item("descriptivo") 'y forma de pago?
                                Dim matcont As matrizContable = obtieneMatrizSignoContable(tot)
                                fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", dpto_contable, cta_contable, descrip, tot * matcont.mul)
                                fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, tot * matcont.mul)
                                'todo actualizar estado anticipo(s)
                            End If
                        End If
                        If retval And larqueo <> narqueo Then
                            larqueo = narqueo
                            retval = CambiarEstadoArqueo(cmd, narqueo, 1, False)
                            retval = CambiarEstadoArqueo(cmd, narqueo, 2, False)
                        End If
                    End While
                    If retval And larqueo <> narqueo And narqueo <> -1 Then
                        larqueo = narqueo
                        retval = CambiarEstadoArqueo(cmd, narqueo, 1, False)
                        retval = CambiarEstadoArqueo(cmd, narqueo, 2, False)
                    End If
                    cmd.Parameters.Clear()
                    cmd.Parameters.AddRange(cpparam)
                End If


                If retval Then
                    'dotaciones/retiradas fondos
                    reader = getDataTable(cmd, sqlApuntesMovimientosCajaDotRet)
                    While reader.Read And retval
                        Dim cta_contable_cliente As String = Nothing '= cta_contable_defecto
                        Dim dpto_contable_cliente As String = Nothing '= dpto_contable_defecto
                        Dim dpto_contable As String = reader("dpto_contable")
                        Dim cta_contable As String = reader("cta_contable")

                        Dim campocuenta As String = "cta_contable_cliente"
                        If Not reader.IsDBNull(reader.GetOrdinal(campocuenta)) Then
                            cta_contable_cliente = reader.Item(campocuenta)
                            dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                        End If
                        If IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                            retval = False
                            errroCode = 1   'faltan datos contables
                        Else
                            Dim descrip As String = "DOTACION "
                            Dim tot = reader.Item("total")
                            If reader.Item("tipo_dotacion_id") = 2 Then 'dev anti
                                tot = -tot
                                descrip = "RETIRADA "
                            End If
                            descrip += reader.Item("descriptivo")
                            Dim matcont As matrizContable = obtieneMatrizSignoContable(tot)
                            fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", dpto_contable, cta_contable, descrip, tot * matcont.mul)
                            fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, tot * matcont.mul)
                            'todo actualizar estado arqueo(s) una vez
                            retval = CambiarEstadoDotacion(cmd, reader.Item("dotacion_id"), 2, False)

                        End If
                    End While
                    cmd.Parameters.Clear()
                    cmd.Parameters.AddRange(cpparam)
                End If


                If retval Then
                    'gastos
                    reader = getDataTable(cmd, sqlApuntesMovimientosCajaGastos)
                    While reader.Read And retval
                        Dim cta_contable_cliente As String = Nothing '= cta_contable_defecto
                        Dim dpto_contable_cliente As String = Nothing '= dpto_contable_defecto
                        Dim dpto_contable As String = reader("dpto_contable")
                        Dim cta_contable As String = reader("cta_contable")

                        Dim campocuenta As String = "cta_contable_cliente"
                        If Not reader.IsDBNull(reader.GetOrdinal(campocuenta)) Then
                            cta_contable_cliente = reader.Item(campocuenta)
                            dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                        End If
                        If IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                            retval = False
                            errroCode = 1   'faltan datos contables
                        Else
                            Dim descrip As String = "GASTOS "
                            Dim tot = reader.Item("total")
                            Dim base As BaseCCI = New BaseCCI


                            'If reader.Item("tipo_dotacion_id") = 2 Then 'dev anti
                            'tot = -tot
                            'descrip = "RETIRADA "
                            'End If
                            descrip += reader.Item("descriptivo")
                            Dim cuota As Single = 0
                            Dim matcont As matrizContable = obtieneMatrizSignoContable(tot)
                            If reader.IsDBNull(reader.GetOrdinal("porcentaje")) Or reader.IsDBNull(reader.GetOrdinal("imp_cta_contable")) Or reader.IsDBNull(reader.GetOrdinal("imp_dpto_contable")) Then
                            Else
                                cuota = base.agregaImpuesto(reader.Item("porcentaje"), tot)
                                fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", reader.Item("imp_cta_contable"), reader.Item("imp_dpto_contable"), descrip, cuota * matcont.mul)
                            End If
                            fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, (tot - cuota) * matcont.mul)
                            fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable, cta_contable, descrip, tot * matcont.mul)
                            'todo actualizar estado gasto(s) una vez
                            retval = CambiarEstadoGasto(cmd, reader.Item("gasto_id"), 2, False)

                        End If
                    End While
                    cmd.Parameters.Clear()
                    cmd.Parameters.AddRange(cpparam)
                End If
            End If
            Return retval
        End Function

        Private Function GeneraAsientosMovimientosCajaOld(ByVal cmd As MySqlCommand, ByVal fc As FicheroContabilidad)
            'todo cambiar
            'cobros
            'todo comprobar cuentas.
            Dim apunteDesc = "RECEP3"
            Dim cpparam(cmd.Parameters.Count - 1) As MySqlParameter
            cmd.Parameters.CopyTo(cpparam, 0)

            Dim readerHotel As DataTableReader = getDataTable(cmd, sqlDatosContablesHotel)
            readerHotel.Read()
            Dim cta_contable_anticipo_defecto As String = readerHotel.Item("cta_contable_anticipo_defecto")
            Dim cta_contable_defecto As String = readerHotel.Item("cta_contable_defecto")
            Dim dpto_contable_defecto As String = readerHotel.Item("dpto_contable_defecto")
            Dim retval As Boolean = True
            Dim errroCode As Integer = 0

            Dim reader As DataTableReader

            If retval Then
                'cobros/devolucion--depositios/dev.depo--cobros anticipos.
                reader = getDataTable(cmd, sqlApuntesMovimientosCajaCobros)
                While reader.Read And retval
                    Dim cta_contable_cliente As String = cta_contable_defecto
                    Dim dpto_contable_cliente As String = dpto_contable_defecto
                    Dim dpto_contable As String = reader("dpto_contable")
                    Dim cta_contable As String = reader("cta_contable")

                    Dim campocuenta As String = "cta_contable_cliente"
                    'If reader.Item("tipo_cobro_id") = 5 Then 'anticipo
                    '    'usar cta_contable_anticipo
                    '    'campocuenta = "cta_contable_cliente_anticipo"

                    '    If reader.IsDBNull(reader.GetOrdinal("cta_contable_cliente_anticipo")) Then
                    '        cta_contable = cta_contable_anticipo_defecto
                    '        dpto_contable = dpto_contable_defecto
                    '    Else
                    '        cta_contable = reader.Item("cta_contable_cliente_anticipo")
                    '        dpto_contable = reader.Item("dpto_contable_cliente")
                    '    End If

                    'End If

                    If Not reader.IsDBNull(reader.GetOrdinal(campocuenta)) Then
                        cta_contable_cliente = reader.Item(campocuenta)
                        If Not reader.IsDBNull(reader.GetOrdinal("dpto_contable_cliente")) Then
                            dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                        End If

                    End If


                    If IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                        retval = False
                        errroCode = 1   'faltan datos contables
                    Else
                        Dim descrip As String = reader.Item("descriptivo")
                        Dim matcont As matrizContable = obtieneMatrizSignoContable(reader.Item("total"))

                        fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", dpto_contable, cta_contable, descrip, reader.Item("total") * matcont.mul)
                        fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, reader.Item("total") * matcont.mul)
                        'todo actualizar estado cobro(s)
                        retval = CambiarEstadoCobro(cmd, reader.Item("cobro_id"), 2, False)
                    End If
                End While
                cmd.Parameters.Clear()
                cmd.Parameters.AddRange(cpparam)
            End If

            If retval And 1 = 0 Then  'deshabilitado...los anticipos ya no se generan asi
                'anticipos/dev anticipos
                reader = getDataTable(cmd, sqlApuntesMovimientosCajaAnticipos)
                While reader.Read And retval
                    Dim cta_contable_cliente As String = cta_contable_defecto
                    Dim dpto_contable_cliente As String = dpto_contable_defecto
                    Dim dpto_contable As String = reader("dpto_contable")
                    Dim cta_contable As String = reader("cta_contable")

                    '                    Dim campocuenta As String = "cta_contable_cliente"
                    Dim campocuenta As String = "cta_contable_cliente_anticipo"

                    If reader.IsDBNull(reader.GetOrdinal(campocuenta)) Then
                        cta_contable = cta_contable_anticipo_defecto
                        dpto_contable = dpto_contable_defecto
                    Else
                        cta_contable = reader.Item(campocuenta)
                        dpto_contable = reader.Item("dpto_contable_cliente")
                    End If

                    '                    If Not reader.IsDBNull(reader.GetOrdinal(campocuenta)) Then
                    'cta_contable_cliente = reader.Item(campocuenta)
                    'dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                    'End If
                    If IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                        retval = False
                        errroCode = 1   'faltan datos contables
                    Else
                        Dim descrip As String = "ANTICIPO "
                        Dim tot = reader.Item("total")
                        If reader.Item("tipo_anticipo_id") = 2 Then 'dev anti
                            tot = -tot
                            descrip = "DEV.ANTI "
                        End If
                        Dim matcont As matrizContable = obtieneMatrizSignoContable(tot)
                        fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", dpto_contable, cta_contable, descrip, tot * matcont.mul)
                        fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, tot * matcont.mul)
                        'todo actualizar estado arqueo(s) una vez
                        retval = CambiarEstadoAnticipo(cmd, reader.Item("anticipo_id"), 1, False)
                        retval = CambiarEstadoAnticipo(cmd, reader.Item("anticipo_id"), 2, False)
                    End If
                End While
                cmd.Parameters.Clear()
                cmd.Parameters.AddRange(cpparam)
            End If

            If retval Then
                'faltantes/sobrantes cajas
                reader = getDataTable(cmd, sqlApuntesMovimientosCajaFalSob)
                Dim larqueo As Integer = -1
                Dim narqueo As Integer = -1
                While reader.Read And retval
                    narqueo = reader.Item("arqueo_id")
                    Dim tot As Single = 0
                    If Not reader.IsDBNull(reader.GetOrdinal("total")) Then
                        tot = reader.Item("total")
                    End If

                    If tot <> 0 Then
                        Dim cta_contable_cliente As String = Nothing
                        Dim dpto_contable_cliente As String = Nothing
                        Dim dpto_contable As String = Nothing
                        If Not reader.IsDBNull(reader.GetOrdinal("dpto_contable")) Then
                            dpto_contable = reader.Item("dpto_contable")
                        End If
                        Dim cta_contable As String = Nothing
                        If Not reader.IsDBNull(reader.GetOrdinal("cta_contable")) Then
                            cta_contable = reader.Item("cta_contable")
                        End If
                        If Not reader.IsDBNull(reader.GetOrdinal("cta_contable_cliente")) Then
                            cta_contable_cliente = reader.Item("cta_contable_cliente")
                        End If
                        If Not reader.IsDBNull(reader.GetOrdinal("dpto_contable_cliente")) Then
                            dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                        End If

                        If Not retval Or IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                            retval = False
                            errroCode = 1   'faltan datos contables
                        Else
                            Dim descrip As String = "SOB "
                            If tot < 0 Then
                                descrip = "FAL "
                            End If
                            descrip += reader.Item("descriptivo") 'y forma de pago?
                            Dim matcont As matrizContable = obtieneMatrizSignoContable(tot)
                            fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", dpto_contable, cta_contable, descrip, tot * matcont.mul)
                            fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, tot * matcont.mul)
                            'todo actualizar estado anticipo(s)
                        End If
                    End If
                    If retval And larqueo <> narqueo Then
                        larqueo = narqueo
                        retval = CambiarEstadoArqueo(cmd, narqueo, 1, False)
                        retval = CambiarEstadoArqueo(cmd, narqueo, 2, False)
                    End If
                End While
                If retval And larqueo <> narqueo And narqueo <> -1 Then
                    larqueo = narqueo
                    retval = CambiarEstadoArqueo(cmd, narqueo, 1, False)
                    retval = CambiarEstadoArqueo(cmd, narqueo, 2, False)
                End If
                cmd.Parameters.Clear()
                cmd.Parameters.AddRange(cpparam)
            End If


            If retval Then
                'dotaciones/retiradas fondos
                reader = getDataTable(cmd, sqlApuntesMovimientosCajaDotRet)
                While reader.Read And retval
                    Dim cta_contable_cliente As String = Nothing '= cta_contable_defecto
                    Dim dpto_contable_cliente As String = Nothing '= dpto_contable_defecto
                    Dim dpto_contable As String = reader("dpto_contable")
                    Dim cta_contable As String = reader("cta_contable")

                    Dim campocuenta As String = "cta_contable_cliente"
                    If Not reader.IsDBNull(reader.GetOrdinal(campocuenta)) Then
                        cta_contable_cliente = reader.Item(campocuenta)
                        dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                    End If
                    If IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                        retval = False
                        errroCode = 1   'faltan datos contables
                    Else
                        Dim descrip As String = "DOTACION "
                        Dim tot = reader.Item("total")
                        If reader.Item("tipo_dotacion_id") = 2 Then 'dev anti
                            tot = -tot
                            descrip = "RETIRADA "
                        End If
                        descrip += reader.Item("descriptivo")
                        Dim matcont As matrizContable = obtieneMatrizSignoContable(tot)
                        fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", dpto_contable, cta_contable, descrip, tot * matcont.mul)
                        fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, tot * matcont.mul)
                        'todo actualizar estado arqueo(s) una vez
                        retval = CambiarEstadoDotacion(cmd, reader.Item("dotacion_id"), 2, False)

                    End If
                End While
                cmd.Parameters.Clear()
                cmd.Parameters.AddRange(cpparam)
            End If


            If retval Then
                'gastos
                reader = getDataTable(cmd, sqlApuntesMovimientosCajaGastos)
                While reader.Read And retval
                    Dim cta_contable_cliente As String = Nothing '= cta_contable_defecto
                    Dim dpto_contable_cliente As String = Nothing '= dpto_contable_defecto
                    Dim dpto_contable As String = reader("dpto_contable")
                    Dim cta_contable As String = reader("cta_contable")

                    Dim campocuenta As String = "cta_contable_cliente"
                    If Not reader.IsDBNull(reader.GetOrdinal(campocuenta)) Then
                        cta_contable_cliente = reader.Item(campocuenta)
                        dpto_contable_cliente = reader.Item("dpto_contable_cliente")
                    End If
                    If IsNothing(cta_contable_cliente) Or IsNothing(dpto_contable_cliente) Or IsNothing(dpto_contable) Or IsNothing(cta_contable) Then
                        retval = False
                        errroCode = 1   'faltan datos contables
                    Else
                        Dim descrip As String = "GASTOS "
                        Dim tot = reader.Item("total")
                        Dim base As BaseCCI = New BaseCCI


                        'If reader.Item("tipo_dotacion_id") = 2 Then 'dev anti
                        'tot = -tot
                        'descrip = "RETIRADA "
                        'End If
                        descrip += reader.Item("descriptivo")
                        Dim cuota As Single = 0
                        Dim matcont As matrizContable = obtieneMatrizSignoContable(tot)
                        If reader.IsDBNull(reader.GetOrdinal("porcentaje")) Or reader.IsDBNull(reader.GetOrdinal("imp_cta_contable")) Or reader.IsDBNull(reader.GetOrdinal("imp_dpto_contable")) Then
                        Else
                            cuota = base.agregaImpuesto(reader.Item("porcentaje"), tot)
                            fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", reader.Item("imp_cta_contable"), reader.Item("imp_dpto_contable"), descrip, cuota * matcont.mul)
                        End If
                        fc.agregarApunte(apunteDesc, matcont.tipoD, reader.Item("fecha"), "", dpto_contable_cliente, cta_contable_cliente, descrip, (tot - cuota) * matcont.mul)
                        fc.agregarApunte(apunteDesc, matcont.tipoH, reader.Item("fecha"), "", dpto_contable, cta_contable, descrip, tot * matcont.mul)
                        'todo actualizar estado gasto(s) una vez
                        retval = CambiarEstadoGasto(cmd, reader.Item("gasto_id"), 2, False)

                    End If
                End While
                cmd.Parameters.Clear()
                cmd.Parameters.AddRange(cpparam)
            End If
            Return retval
        End Function
        'prepara fichero
        'Dim fc As FicheroContabilidad = ObtieneFicheroConta(cmd, "00106") '001 empresa '06 año

        'fc.agregarApunte("ANTICI", signoc, .Item("Fecha_Anticipo"), "", "", .Item("Cta_Cliente_Anticipo"), descriptivoCliente, multiplicador * .Item("Importe"))
        'fc.agregarApunte("ANTICI", signob, fecha, "", "", cbanco, descriptivoBanco, total, 1)

        'genera y cierra fichero
        'If errorCode = 0 And fc.NumeroLineas > 1 Then
        'TODO genera lineas de bancos
        'If fc.generarFichero() Then
        'Else
        'no pude crear el fichero plano
        'errorCode = 2
        'End If
        'End If
        Shared sqlApuntesFacturas = "" _
    & " SELECT series.manocorriente,facturas.Factura_Id,facturas.serie_id,facturas.Importe_Total," _
    & " Coalesce((select clientes_hotel.cta_anticipos from clientes_hotel where clientes_hotel.cliente_id=facturas.cliente_id and clientes_hotel.hotel_id=facturas.hotel_id and length(clientes_hotel.cta_anticipos)<>0) ,(select clientes.cta_contable_anticipo from clientes where clientes.cliente_id=facturas.cliente_id) ) as cta_contable_anticipo,  " _
    & " Coalesce((select clientes_hotel.cta_depositos from clientes_hotel where clientes_hotel.cliente_id=facturas.cliente_id and clientes_hotel.hotel_id=facturas.hotel_id and length(clientes_hotel.cta_depositos)<>0) ,(select clientes.cta_depositos from clientes where clientes.cliente_id=facturas.cliente_id) ) as cta_deposito  " _
    & " FROM facturas INNER JOIN series ON facturas.serie_id=series.serie_id " _
    & " WHERE facturas.hotel_id =  ? AND " _
    & " facturas.Fecha_Factura =  ? and facturas.estado_factura_id=1 And facturas.Importe_Total<>0"
        Private Function GeneraAsientosFacturas(ByVal cmd As MySqlCommand, ByVal fc As FicheroContabilidad, ByVal asiento As String)
            'todo cambiar
            'todo si asiento=recep4...
            Dim retValue As Boolean = True
            Dim errorCode As Integer = 0
            Dim readerHotel As DataTableReader = getDataTable(cmd, sqlDatosContablesHotel)
            readerHotel.Read()

            If readerHotel.IsDBNull(readerHotel.GetOrdinal("cta_contable_defecto")) Or readerHotel.IsDBNull(readerHotel.GetOrdinal("cta_manocorriente")) Or readerHotel.IsDBNull(readerHotel.GetOrdinal("dpto_contable")) Then
                errorCode = 1 'datos del hotel incompletos
                retValue = False
            Else
                Dim cta_manocorriente As String = readerHotel.Item("cta_manocorriente")
                Dim dpto_contable As String = readerHotel.Item("dpto_contable")
                Dim cta_contable_defecto As String = readerHotel.Item("cta_contable_defecto")
                Dim reader As DataTableReader = getDataTable(cmd, sqlApuntesFacturas)
                Dim hotel_id As Integer = cmd.Parameters(0).Value

                While retValue And reader.Read
                    cmd.Parameters(0).Value = reader.Item("factura_id")
                    If asiento = "RECEP4" And reader.Item("serie_id") = 5 Then  'Anticipo
                        cta_manocorriente = readerHotel.Item("cta_contable_anticipo_defecto")
                        If Not reader.IsDBNull(reader.GetOrdinal("cta_contable_anticipo")) Then
                            cta_manocorriente = reader("cta_contable_anticipo")
                        End If
                    End If
                    If asiento = "RECEP4" And reader.Item("serie_id") = 4 Then  'Depositos
                        cta_manocorriente = readerHotel.Item("cta_deposito_defecto")
                        If Not reader.IsDBNull(reader.GetOrdinal("cta_deposito")) Then
                            cta_manocorriente = reader("cta_deposito")
                        End If
                        If Len(cta_manocorriente) = 0 Then  ' No han metido depósitos por ningún lado
                            cta_manocorriente = readerHotel.Item("cta_contable_anticipo_defecto")
                        End If
                    End If
                    ' comprobar que factura es valida
                    ' Cambio Javier Nuñez 4/12/2012 para que la serie 9 vaya a RECEP2 en vez de RECEP 4.
                    ' Se controlará por el campo manocorriente de la tabla series
                    ' Se cambio la query sqlApuntesFacturas para leer el campo manocorriente
                    If (asiento = "RECEP4" And reader.Item("manocorriente") <> 1) Or (asiento <> "RECEP4" And reader.Item("manocorriente")) Then
                        'If (asiento = "RECEP4" And reader.Item("serie_id") >= 4) Or (asiento <> "RECEP4" And reader.Item("serie_id") < 4) Then
                        retValue = AgregaApunteDeFactura(cmd, fc, asiento, cta_manocorriente, dpto_contable, cta_contable_defecto)
                        If retValue Then
                            'guardar los parametros

                            fc.generaImpuestos(asiento)
                            fc.CuentasImpuestos.Clear()
                            Dim cpparam(cmd.Parameters.Count - 1) As MySqlParameter
                            cmd.Parameters.CopyTo(cpparam, 0)
                            'Console.WriteLine(reader.Item("factura_id"))
                            retValue = CambiarEstadoFactura(cmd, reader.Item("factura_id"), 2, False)
                            'If Not retValue Then
                            'Console.WriteLine(reader.Item("factura_id"))
                            'End If
                            cmd.Parameters.Clear()
                            cmd.Parameters.AddRange(cpparam)
                            'poner los parametros otra vez
                        Else
                            'cmd.Parameters(0).Value = reader.Item("factura_id")
                            'AgregaApunteDeFactura(cmd, fc, asiento, cta_manocorriente, dpto_contable, cta_contable_defecto)
                            AgregaInfo("GeneraAsientosFacturas", "Problema Factura_id:" & reader.Item("factura_id"), -1)
                            Console.WriteLine("apunte jodido")

                        End If
                    End If
                End While

                cmd.Parameters(0).Value = hotel_id
            End If

            Return retValue
        End Function
        ' SQL Modificada para SAP Se añade desc_corta y la tabla reservas y bono y fecha_prevista_LLegada y Salida
        Shared sqlObtieneDatosFacturaParaApunte = " SELECT facturas.Numero_Factura, " _
    & " Coalesce(facturas.reserva_id,lineas_factura.reserva_id) AS reserva_id, " _
    & " lineas_factura.precio AS Precio_Base, " _
    & " lineas_factura.cantidad,lineas_factura.pag_factura As pag_factura, " _
    & " lineas_factura.porc_impuesto AS Porc_Igic, " _
    & " facturas.Fecha_Factura, " _
    & " facturas.Ref_Fra2, " _
    & " Coalesce(clientes_hotel.cta_contable,clientes.cta_contable) AS Cta_Contable_Factura, " _
    & " series.factura AS tipo_factura, " _
    & " series.Abreviatura AS serie, " _
    & " clientes.razon AS Razon_Social, clientes.grupo_cliente_id, " _
    & " clientes.nif, clientes.desc_corta, " _
    & " impuestos.dpto_contable AS Departamento_Contable, " _
    & " impuestos.cta_contable AS CTA_IGIC, " _
    & " facturas.Ref_Fra2 AS Concepto,'NADA' AS Cta_Contable_Concepto,lineas_factura.descripcion,lineas_factura.unidad_calculo_id,lineas_factura.servicio_id,lineas_factura.fecha as fecha_linea, " _
    & " bono_referencia, fecha_prevista_llegada, fecha_prevista_salida " _
    & " FROM facturas " _
    & " LEFT JOIN reservas ON facturas.reserva_id = reservas.reserva_id " _
    & " left Join clientes_hotel ON clientes_hotel.cliente_Id = facturas.cliente_id and clientes_hotel.hotel_id=facturas.hotel_id" _
    & " left Join lineas_factura ON lineas_factura.factura_id = facturas.Factura_Id " _
    & " left Join impuestos ON lineas_factura.impuesto_id = impuestos.impuesto_id " _
    & " left Join hoteles ON hoteles.empresa_id = impuestos.empresa_id AND hoteles.hotel_id = facturas.hotel_id " _
    & " left Join clientes ON facturas.Cliente_Id = clientes.cliente_id " _
    & " left Join series ON facturas.Serie_id = series.Serie_Id " _
    & " WHERE facturas.Factura_Id =  ? "
        Shared sqldatosclienteExtraContado = "SELECT MIN(cliente_id),desc_corta,razon,nif " _
        & "FROM clientes WHERE cliente_defecto=1 "
        Private Function AgregaApunteDeFactura(ByVal cmd As MySqlCommand, ByVal fc As FicheroContabilidad, ByVal asiento As String, ByVal cta_manocorriente As String, ByVal dpto_contable As String, ByVal cta_contable_defecto As String)
            Dim retValue As Boolean = True
            Dim errorCode = 0
            Dim cont As Boolean = False
            cmd.CommandText = sqlObtieneDatosFacturaParaApunte
            Dim reader As DataTableReader
            Dim previousConnectionState As ConnectionState = cmd.Connection.State
            Try
                If cmd.Connection.State = ConnectionState.Closed Then
                    cmd.Connection.Open()
                End If
                Dim basecci As FicheroContabilidad.BaseCCI = fc.preparaBases(1)
                'Me.getDataSet()
                'reader = getDataSet(cmd, sqlObtieneDatosFacturaParaApunte).CreateDataReader()
                reader = readerToDataTable(cmd.ExecuteReader())
                Dim Total As Decimal = 0
                Dim TotalBases As Decimal = 0
                With reader
                    While .Read And retValue
                        ' BI=Precio/(1+(IGIC/100))
                        Dim Base As Double = Math.Round(.Item("Precio_Base") * .Item("Cantidad"), 2, MidpointRounding.AwayFromZero)
                        Total += Base
                        TotalBases += Base
                        'todo idenficar base al D o al H

                        If .IsDBNull(.GetOrdinal("Porc_Igic")) Or .IsDBNull(.GetOrdinal("CTA_IGIC")) Then
                            'falta cuenta igic en esta linea
                            errorCode = 3
                            retValue = False
                        Else
                            fc.agregarBases(basecci, Base, .Item("Porc_Igic"), .Item("CTA_IGIC"))
                        End If
                    End While
                End With
                If retValue Then
                    reader = readerToDataTable(cmd.ExecuteReader())
                    Dim REF2 As String = ""
                    With reader
                        If .Read Then
                            If cont = False Then
                                If .IsDBNull(.GetOrdinal("Ref_Fra2")) Then
                                    REF2 = ""
                                Else
                                    REF2 = .Item("Ref_Fra2")
                                End If

                                If REF2 = "***" Then
                                    REF2 = "*** Num. " + .Item("Numero_Factura")
                                End If
                                Dim descriptivoCliente As String = .Item("Serie") + REF2
                                '.GetOrdinal("serie")
                                ' Modificacion de Javier para que salga ref2 en el asiento de los Anticipos
                                ' Si la serie es No es una factura. En teoría depositos no genera ==> solo anticipos
                                If .Item("tipo_factura") = 0 And Not .IsDBNull(.GetOrdinal("ref_Fra2")) Then ' No es una factura propiamente dicha sino un deposito o anticipo
                                    REF2 = .Item("Ref_Fra2")
                                    If REF2 <> "" Then
                                        descriptivoCliente = REF2
                                    End If
                                End If
                                Dim Cta_Contable_Factura As String = cta_contable_defecto
                                If Not .IsDBNull(.GetOrdinal("Cta_Contable_Factura")) Then
                                    Cta_Contable_Factura = .Item("Cta_Contable_Factura")
                                End If
                                If .IsDBNull(.GetOrdinal("Numero_Factura")) Or Cta_Contable_Factura Is Nothing Or .IsDBNull(.GetOrdinal("serie")) Then
                                    errorCode = 4 'datos de factura incompletos
                                Else
                                    Dim numero_factura As Integer = .Item("Numero_Factura")
                                    ' GAZAPO POSIBLE
                                    If .Item("tipo_factura") = 0 And Total < 0 And asiento <> "RECEP2" Then  'Deposito o anticipo
                                        numero_factura -= 1
                                    End If
                                    fc.agregarApunte(asiento, "D", .Item("Fecha_Factura"), CStr(numero_factura), "", Cta_Contable_Factura, descriptivoCliente, Total)
                                    Dim nif As String = ""
                                    If Not IsDBNull(.Item("NIF")) Then
                                        nif = .Item("NIF")
                                    End If
                                    Dim desc_corta As String = ""
                                    If Not IsDBNull(.Item("desc_corta")) Then
                                        desc_corta = .Item("desc_corta")
                                    End If
                                    ' -----------------------------------------------------------------------------
                                    ' AQUI Añado los campos específicos para SAP y los añado al agregarFactura
                                    ' Si el grupo_cliente_id es > 2 entonces lo pongo como extras contado
                                    ' -----------------------------------------------------------------------------
                                    If .Item("grupo_cliente_id") > 2 Then
                                        Dim Reader2 As DataTableReader = getDataTable(cmd, sqldatosclienteExtraContado)
                                        While Reader2.Read
                                            nif = Reader2.Item("Nif")
                                            desc_corta = Reader2.Item("desc_corta")
                                        End While

                                    End If
                                    Dim Bono As String = ""
                                    If Not IsDBNull(.Item("Bono_referencia")) Then
                                        Bono = .Item("bono_referencia")
                                    End If
                                    Dim llegada As Date = "01/01/2000"
                                    If Not IsDBNull(.Item("fecha_prevista_llegada")) Then
                                        llegada = .Item("fecha_prevista_llegada")
                                    End If
                                    Dim salida As Date = "01/01/2000"
                                    If Not IsDBNull(.Item("fecha_prevista_salida")) Then
                                        salida = .Item("fecha_prevista_salida")
                                    End If
                                    Dim pag_factura As Integer = 1
                                    If Not IsDBNull(.Item("pag_factura")) Then
                                        pag_factura = .Item("pag_factura")
                                    End If
                                    fc.agregarFactura(.Item("Fecha_Factura"), .Item("serie"), .Item("Numero_Factura"), .Item("Razon_Social"), nif, Cta_Contable_Factura, desc_corta, Bono, llegada, salida, pag_factura)
                                    fc.agregaBase(basecci)
                                    cont = True
                                End If
                            End If
                            If cont Then
                                'Base Imponible
                                Dim concepto As String
                                If Not .IsDBNull(.GetOrdinal("Concepto")) Then
                                    concepto = .Item("Concepto")
                                Else
                                    'concepto = "FACTURA NUM "
                                    concepto = ""
                                End If
                                fc.agregarApunte(asiento, "H", .Item("Fecha_Factura"), .Item("Numero_Factura"), dpto_contable, cta_manocorriente, concepto, basecci.sumaBases)
                            End If

                        End If
                    End With

                    If cont = False Then
                        'no tiene lineas de factura
                        errorCode = 2
                    End If
                End If
            Catch
                errorCode = 1   'error de calculos
            Finally
                If previousConnectionState = ConnectionState.Closed Then
                    cmd.Connection.Close()
                End If
            End Try
            If errorCode = 0 Then
                Return True
            Else
                Return False
            End If
        End Function
        'enlaze contable

        Private Function ObtieneFicheroConta(ByVal cmd As MySqlCommand, ByVal fecha As Date, ByVal hotel_id As Integer, programa As String)
            ' ----------------------------------------------------------------------------
            ' AQUI Modificacion SAP grabamos el dataset para hacer las transformaciones
            ' y lo agregamos como parametro a FicheroContabilidad
            ' ----------------------------------------------------------------------------
            Dim datos_sap As New DataSet
            getDataSet(cmd, "SELECT * FROM sap_cuentas", datos_sap, "sap_cuentas")
            getDataSet(cmd, "SELECT * FROM sap_hoteles", datos_sap, "sap_hoteles")
            getDataSet(cmd, "SELECT * FROM sap_departamentos", datos_sap, "sap_departamentos")

            Dim Empresa As String = "001"
            Dim Ano As String = fecha.Year.ToString
            Dim fc As New FicheroContabilidad
            'todo elegir clase dependiendo de configuracion contable
            'fc.FicheroContabilidad(cargaParametros(cmd, "RUTA_FICHEROS_CONTABLES"), cargaParametros(cmd, "RUTA_BACKUPFICHEROS_CONTABLES"), Empresa, Ano)
            'leer ruta de la tabla empresas
            If Not isProduccion Then
                fc.FicheroContabilidad("c:/temp_prueba/", "c:/temp_prueba/", Empresa, fecha, hotel_id, programa, datos_sap)
            Else
                fc.FicheroContabilidad("c:/temp/", "c:/temp/", Empresa, fecha, hotel_id, programa, datos_sap)
            End If

            Return fc
        End Function
        Dim sqlLLamadasParametros = "" _
& " SELECT" _
& " llamadas_porcentaje_incremento.hotel_id," _
& " llamadas_porcentaje_incremento.porcentaje_incremento_llamadas, " _
& " llamadas_porcentaje_incremento.ruta_entrada, " _
& " llamadas_porcentaje_incremento.ruta_salida, " _
& " llamadas_porcentaje_incremento.servicio_id, " _
& " impuestos.porcentaje as porc_impuesto, " _
& " impuestos.impuesto_id " _
& " FROM " _
& " llamadas_porcentaje_incremento " _
& " Inner Join servicios_hotel ON llamadas_porcentaje_incremento.hotel_id = servicios_hotel.hotel_id AND llamadas_porcentaje_incremento.servicio_id = servicios_hotel.servicio_id " _
& " Inner Join impuestos ON servicios_hotel.impuesto_id = impuestos.impuesto_id " _
& " where llamadas_porcentaje_incremento.hotel_id=? "

        Dim sqlLLamadas = "select * from llamadas where llamada_id=0"
        Dim sqlObtieneHabitacionPorExtension = "" _
& "        SELECT" _
& " habitaciones.habitacion_id " _
& " FROM " _
& " habitaciones " _
& " WHERE " _
& " habitaciones.hotel_id =  ? AND " _
& " habitaciones.extension =  ? "
        Dim sqlExisteLLamada = "" _
& " SELECT " _
& " llamadas.llamada_id " _
& " FROM " _
& " llamadas " _
& " WHERE " _
& " llamadas.hotel_id =  ? AND " _
& " llamadas.extension =  ? AND " _
& " llamadas.fecha_hora =  ? "

        Function ObtieneLLamadasHotel(ByVal hotel_id As Integer)
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim numReg As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try


                Dim fechamin As Date = FechaHotel(cmd, hotel_id)
                'retVal = ObtienePendienteAnticipoReserva(cmd, reserva_id)
                'If retVal > 0 Then
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim extensionParam As New MySqlParameter("@extension", "")
                Dim habitacion_idParam As New MySqlParameter("@extension", "")
                Dim fecha_horaParam As New MySqlParameter("@fecha_hora", Now())
                Dim fechaParam As New MySqlParameter("@fecha_hotel", Today.Date)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                Dim readerParametros As DataTableReader = getDataTable(cmd, sqlLLamadasParametros)
                Dim ds As DataSet = getDataSet(cmd, sqlLLamadas)
                Dim sql_graba_fecha_limpieza As String = "UPDATE limpiezas SET hora_limpieza=? WHERE habitacion_id = ? AND fecha = ?"
                Dim sql_graba_fecha_validacion As String = "UPDATE limpiezas SET hora_validacion=? WHERE habitacion_id = ? AND fecha = ?"
                Dim sql_inserta_limpieza As String = "INSERT INTO limpiezas (item_limpieza_id,hora_limpieza,habitacion_id,fecha) VALUES (8,?,?,?)"
                Dim sql_inserta_validacion As String = "INSERT INTO limpiezas (item_limpieza_id,hora_validacion,habitacion_id,fecha) VALUES (8,?,?,?)"
                Dim sql_selec_habitacion_id = "SELECT MIN(habitacion_id) FROM habitaciones WHERE hotel_id =? AND extension = ?"

                'Dim fecha As Date
                'Dim fechaset As Boolean = False
                While readerParametros.Read And errorCode = 0
                    Dim ruta As String = readerParametros.Item("ruta_entrada")
                    'imp quitar
                    If Not isProduccion Then
                        ruta = "C:/LLAMADAS.DAT"
                    End If
                    Dim cenclase = New Centralita()
                    Dim cenlla As Centralita.Llamada() = cenclase.procesFicheroLlamadas(ruta)
                    Dim x As Integer
                    Try

                        For x = 0 To cenlla.Length - 1

                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(hotel_idParam)
                            cmd.Parameters.Add(extensionParam)
                            cmd.Parameters.Add(fecha_horaParam)
                            extensionParam.Value = cenlla(x).extension
                            fecha_horaParam.Value = cenlla(x).fecha_hora
                            If cenlla(x).tipo = 1 Then  ' llamada normal
                                Dim lla_id = Me.ExecuteScalar(cmd, sqlExisteLLamada)
                                If IsNothing(lla_id) Or IsDBNull(lla_id) Then
                                    lla_id = 0
                                End If
                                'comprueba si existe linea
                                If lla_id = 0 Then
                                    Dim row As DataRow = ds.Tables(0).Rows.Add
                                    'row("llamada_id") = 1
                                    row("hotel_id") = readerParametros("hotel_id")
                                    row("extension") = cenlla(x).extension
                                    row("fecha_hora") = cenlla(x).fecha_hora
                                    row("duracion") = cenlla(x).duracion
                                    row("numero") = cenlla(x).numero
                                    row("coste") = cenlla(x).coste + (cenlla(x).coste * readerParametros("porcentaje_incremento_llamadas") / 100)
                                    row("porcentaje_incremento") = readerParametros("porcentaje_incremento_llamadas")
                                    Dim hab_id = Me.ExecuteScalar(cmd, sqlObtieneHabitacionPorExtension) 'encontrar la habitacion para esa extension
                                    If Not IsNothing(hab_id) Then
                                        row("habitacion_id") = hab_id
                                        Dim fecha_res As Date = cenlla(x).fecha_hora
                                        If fecha_res < fechamin Then
                                            fecha_res = New Date(fechamin.Year, fechamin.Month, fechamin.Day, fecha_res.Hour, fecha_res.Minute, fecha_res.Second)
                                        End If
                                        Dim res_id As ArrayList = ObtieneReservasHabitacion(cmd, row("habitacion_id"), fecha_res.ToShortDateString, fecha_res.ToShortDateString)
                                        If Not IsNothing(res_id) Then
                                            'primera reserva cuyo estado no sea 0 or 2
                                            'reserva cuyo estado sea checkin?
                                            If res_id.Count > 0 Then
                                                row("reserva_id") = res_id(0)

                                                Try
                                                    Dim dsr As DataSet = preparaDatasetReserva(cmd, row("reserva_id"))
                                                    'todo crear reserva_servicio
                                                    Dim dr As DataRow = ds.Tables("reservas_servicios").Rows.Add
                                                    dr("servicio_reserva_id") = 1
                                                    dr("reserva_id") = row("reserva_id")
                                                    dr("servicio_id") = readerParametros("servicio_id")
                                                    dr("unidad_calculo_id") = 1
                                                    dr("cantidad") = 1
                                                    dr("fecha_desde") = fecha_res
                                                    dr("fecha_hasta") = CDate(fecha_res).AddDays(1)
                                                    dr("flag_contrato") = 0
                                                    dr("servicio_extra") = 1
                                                    dr("precio_servicio") = row("coste")
                                                    grabaDatasetReserva(cmd, dsr, row("reserva_id"))
                                                Catch ex As Exception
                                                    'si da error ignorarlo..
                                                End Try
                                                Dim fac As Factura
                                                fac = abreFactura(cmd, -1, row("reserva_id"))
                                                fac.factura_id = Nothing


                                                Dim rowlineas As DataRow = agregaLineaFactura(fac)
                                                rowlineas.Item("fecha") = fecha_res ' datos.Tables(0).Rows(0).Item("fecha")
                                                rowlineas.Item("reserva_id") = row("reserva_id")
                                                rowlineas.Item("factura_id") = System.DBNull.Value
                                                rowlineas.Item("contrato_id") = System.DBNull.Value 'dlin.Item("contrato_id")

                                                rowlineas.Item("descripcion") = "Ll. " & row("numero") & " " & convertTime(row("fecha_hora")) & " D:" & convertTime(row("duracion")) ' dlin.Item("descripcion")
                                                rowlineas.Item("cantidad") = 1

                                                rowlineas.Item("hotel_id") = hotel_id
                                                rowlineas.Item("precio") = row("coste") 'quitar posible impuesto
                                                rowlineas.Item("precio_produccion") = rowlineas.Item("precio")
                                                rowlineas.Item("impuesto_id") = readerParametros("impuesto_id")
                                                rowlineas.Item("porc_impuesto") = readerParametros("porc_impuesto")
                                                rowlineas.Item("servicio_id") = readerParametros("servicio_id")
                                                rowlineas.Item("unidad_calculo_id") = 1 'servicio dlin.Item("unidad_calculo_id")
                                                rowlineas.Item("tipo_linea_factura") = "M" 'M o D
                                                rowlineas.Item("pag_factura") = 1
                                                actualizarLineas(fac)
                                                Dim linea_factura_id As Integer = Obtiene_ultima_id(cmd)
                                                row("linea_factura_id") = linea_factura_id
                                                'crear linea de factura sobre esa reserva
                                            End If
                                        End If
                                    End If

                                    'row("linea_factura_id") = 0 'encontrar la habitacion para esa extension
                                    'row("reserva_id") = 0 'encontrar la habitacion para esa extension

                                    Dim writer As MySqlDataAdapter
                                    writer = getDataAdapter(cmd, sqlLLamadas)
                                    writer.Fill(ds.Tables(0))
                                    writer.Update(ds.Tables(0))
                                    Dim llamada_id As Integer = Obtiene_ultima_id(cmd)
                                    If llamada_id <> 0 Then
                                        If Not IsNothing(row("habitacion_id")) And Not IsDBNull(row("habitacion_id")) Then
                                            'errorCode = ActualizarAnticipo(cmd, anticipo_id)
                                            'AgregaInfo("ObtieneLLamadasHotel", "Actualizando llamada:" & llamada_id, -errorCode)
                                        End If
                                    Else
                                        errorCode = 10 'no inserto el registro
                                        AgregaInfo("ObtieneLLamadasHotel", "No pudo crear la llamada:" & llamada_id, -errorCode)
                                    End If
                                End If
                            Else   ' Limpieza o cualquier otra cosa del servicio de hotel JAVIER NUÑEZ JULIO 2013
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(hotel_idParam)
                                cmd.Parameters.Add(extensionParam)
                                habitacion_idParam.Value = ExecuteScalar(cmd, sql_selec_habitacion_id)
                                Dim numero_habitacion = ExecuteScalar(cmd, "SELECT MIN(numero_habitacion) FROM habitaciones WHERE hotel_id =? AND extension = ?")
                                If IsNumeric(habitacion_idParam.Value) Then
                                    ' Tengo la habitacion_id, la fecha de la limpieza que es hoy y la fecha y hora de limpieza
                                    ' Hago un Update de todas las limpiezas de esa habitacion
                                    fecha_horaParam.Value = cenlla(x).fecha_hora
                                    cmd.Parameters.Clear()
                                    cmd.Parameters.Add(fecha_horaParam)
                                    cmd.Parameters.Add(habitacion_idParam)
                                    cmd.Parameters.Add(fechaParam)
                                    If cenlla(x).numero = 1 Then
                                        Try
                                            enviarNotificacion("Habitacion " & numero_habitacion & " limpia", hotel_id, 0)
                                        Catch ex As Exception

                                        End Try

                                        numReg = ExecuteNonQuery(cmd, sql_graba_fecha_limpieza)
                                        ' Tano mandar notificación a Gobernanta
                                        '-----------------------------------------------------------
                                        ' Inserta tu codigo AQUI
                                        '------------------------------------------------------------
                                        If numReg = 0 Then ' Se ha limpiado la habitación pero en teoría no estaba programada. Es un extra
                                            ' Hacemos un insert en la BD con un tipo limpieza extra
                                            numReg = ExecuteNonQuery(cmd, sql_inserta_limpieza)

                                        End If
                                    End If
                                    If cenlla(x).numero = 2 Then
                                        Try
                                            enviarNotificacion("Habitacion " & numero_habitacion & " Repasada", hotel_id, 0)
                                        Catch ex As Exception

                                        End Try

                                        numReg = ExecuteNonQuery(cmd, sql_graba_fecha_validacion)
                                        If numReg = 0 Then ' Se ha limpiado la habitación pero en teoría no estaba programada. Es un extra
                                            ' Hacemos un insert en la BD con un tipo limpieza extra
                                            numReg = ExecuteNonQuery(cmd, sql_inserta_validacion)
                                        End If
                                    End If
                                End If
                            End If
                        Next
                    Catch ex As Exception
                        errorCode = 2 'fallo en las lineas de llamadas
                        AgregaInfo("ObtieneLLamadasHotel", "No pudo crear las lineas del hotel:" & hotel_id, -errorCode)
                    End Try
                    If errorCode = 0 Then
                        If Not cenclase.FinalizaProcesoLLamadas() Then
                            errorCode = 1 'fallo al borrar ficheros llamadas
                        End If
                    End If
                End While
                'End If
            Catch ex As Exception
                'si pones un errorcode..se va a cancelar todo lo ke se hizo..
                errorCode = 3
                AgregaInfo("ObtieneLLamadasHotel", "Error gordo en proceso de llamadas:" & hotel_id, -errorCode)
            Finally
                flushConection(cmd, errorCode)
            End Try
            Return retVal
        End Function
        Dim sqlObtienePrimerHuespededReserva = "SELECT clientes.razon FROM reservas_huespedes Inner Join clientes ON reservas_huespedes.cliente_id = clientes.cliente_id WHERE reservas_huespedes.reserva_id = ? LIMIT 1"
        Private Function RefrescaTelefonoHabitacion(ByVal cmd As MySqlCommand, ByVal habitacion_id As Integer, Optional ByVal cenclaseExterna As Centralita = Nothing) As Boolean

            Dim retVal As Boolean = False
            Try
                Dim errorCode As Integer = 0
                Dim habitacion_idParam As New MySqlParameter("@habitacion_id", habitacion_id)
                'Dim habitacion_id_oldParam As New MysqlParameter("@habitacion_id_old", habitacion_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(habitacion_idParam)
                Dim readerHabitacion As DataTableReader = getDataTable(cmd, sqlObtineDatosHabitacion)
                While readerHabitacion.Read
                    Dim hotel_idParam As New MySqlParameter("@hotel_id", readerHabitacion("hotel_id"))
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(hotel_idParam)
                    Dim readerParametros As DataTableReader = getDataTable(cmd, sqlLLamadasParametros, True)
                    'obtiene fecha del hotel
                    Dim fecha_hotel As Date = FechaHotel(cmd, readerHabitacion("hotel_id"))
                    'comprobar si esta en una reserva para la fecha del hotel sqlHabitacionEstaBlokeada
                    Dim reservas As ArrayList = ObtieneReservasHabitacion(cmd, habitacion_id, fecha_hotel, fecha_hotel)
                    'todo encontrar la primera reserva en checkin
                    Dim reserva_id As Integer = 0
                    If reservas.Count > 0 Then
                        reserva_id = reservas(0)
                    End If
                    Dim razon = ""
                    If reserva_id <> 0 Then
                        'obtiene el primer huespede reserva
                        Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                        'Dim reserva_id_oldParam As New MysqlParameter("@reserva_id", 0)
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(reserva_idParam)
                        'cmd.Parameters.Add(reserva_id_oldParam)
                        razon = ExecuteScalar(cmd, sqlObtienePrimerHuespededReserva)
                        If IsNothing(razon) Then
                            razon = ""
                        End If
                    End If
                    While readerParametros.Read
                        Dim cenclase As Centralita
                        If IsNothing(cenclaseExterna) Then
                            cenclase = New Centralita()
                            'cenclase.preparaComandosTelefonos(readerParametros.Item("ruta_salida"))
                        Else
                            cenclase = cenclaseExterna
                        End If

                        Dim estado As Char = "O"
                        If readerHabitacion.IsDBNull(readerHabitacion.GetOrdinal("estado_telefono")) Then
                        Else
                            If readerHabitacion("estado_telefono") = 1 Then
                                estado = "I"
                            End If
                        End If
                        If Not readerHabitacion.IsDBNull(readerHabitacion.GetOrdinal("extension")) Then
                            cenclase.agregaComandosTelefonos(readerParametros.Item("ruta_salida"), estado, readerHabitacion("extension"), razon, "20000000")
                        End If
                        If IsNothing(cenclaseExterna) Then
                            cenclase.finalizaComandosTelefonos()
                        End If

                    End While
                    'End If
                End While
                retVal = True
            Catch ex As Exception
                'Console.WriteLine(ex.Message)

            End Try
            Return retVal
        End Function
        Function RefrescaTelefonoHabitacion(ByVal habitacion_id As Integer, Optional ByVal cenclaseExterna As Centralita = Nothing) As Boolean
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = RefrescaTelefonoHabitacion(cmd, habitacion_id, cenclaseExterna)
            If Not retVal Then
                errorCode = 1
            End If
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Dim sqlHabitacionesPendientesProcesar = "" _
& " SELECT " _
& " * " _
& " FROM " _
& " habitaciones " _
& " WHERE " _
& " habitaciones.estado_procesado IS NULL  OR " _
& " habitaciones.estado_procesado =  0 "

        Function RefrescaTelefonosHabitaciones()
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim cenclase As Centralita = New Centralita()
            Try
                Dim dshab As DataSet = getDataSet(cmd, sqlHabitacionesPendientesProcesar)
                Dim filas As DataRowCollection = dshab.Tables(0).Rows
                Dim x As Integer
                For x = 0 To filas.Count - 1
                    'Console.WriteLine(x)
                    retVal = RefrescaTelefonoHabitacion(cmd, filas(x)("habitacion_id"), cenclase)
                    If retVal Then
                        filas(x)("estado_procesado") = 1
                    End If

                Next
                Dim writer As MySqlDataAdapter
                writer = getDataAdapter(cmd, sqlHabitacionesPendientesProcesar)
                writer.Fill(dshab.Tables(0))
                writer.Update(dshab.Tables(0))
            Catch ex As Exception
                errorCode = 2
            End Try
            If errorCode = 0 Then
                cenclase.finalizaComandosTelefonos()
            End If

            'If Not retVal Then
            'errorCode = 1
            'End If
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Public Function CambiaEstadoTelefonoHabitacion(ByVal habitacion_id As Integer, ByVal estado As Integer) As Boolean
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = CambiaEstadoTelefonoHabitacion(cmd, habitacion_id, estado)
            If Not retVal Then
                errorCode = 1
            End If
            flushConection(cmd, errorCode)
            Return retVal
        End Function

        Private Function CambiaEstadoTelefonoHabitacion(ByVal cmd As MySqlCommand, ByVal habitacion_id As Integer, ByVal estado As Integer) As Boolean
            Try
                Dim habitacion_idParam As New MySqlParameter("@habitacion_id", habitacion_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(habitacion_idParam)
                'habitacion_idParam.Value = habs(x)
                Dim dshab As DataSet = getDataSet(cmd, sqlObtineDatosHabitacion)
                dshab.Tables(0).Rows(0)("estado_procesado") = 0
                dshab.Tables(0).Rows(0)("estado_telefono") = estado
                Dim writer As MySqlDataAdapter
                writer = getDataAdapter(cmd, sqlObtineDatosHabitacion)
                writer.Fill(dshab.Tables(0))
                writer.Update(dshab.Tables(0))
                Return True
            Catch ex As Exception
                Return False
            End Try
        End Function
        Public Function ActivaTelefonosReserva(ByVal reserva_id As Integer, ByVal estado As Integer) As Boolean
            Dim retVal As Single = 0
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            retVal = ActivaTelefonosReserva(cmd, reserva_id, estado)
            If Not retVal Then
                errorCode = 1
            End If
            flushConection(cmd, errorCode)
            Return retVal
        End Function

        Private Function ActivaTelefonosReserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, ByVal estado As Integer) As Boolean
            Try
                Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                'Dim habitacion_idParam As New MysqlParameter("@habitacion_id", 0)
                'Dim reserva_id_oldParam As New MysqlParameter("@reserva_id", 0)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                'cmd.Parameters.Add(reserva_id_oldParam)

                Dim reserva As DataSet = getDataSet(cmd, sqlCabReserva)
                If reserva.Tables(0).Rows.Count > 0 Then
                    Dim readerReserva As DataRow = reserva.Tables(0).Rows(0)
                    'cambiar fechas por fecha del hotel?
                    Dim habs As ArrayList = ObtieneReservasHabitacion(cmd, 0, readerReserva("fecha_prevista_llegada"), readerReserva("fecha_prevista_llegada"), reserva_id)
                    Dim x As Integer
                    For x = 0 To habs.Count - 1
                        If habs(x) <> 0 Then
                            If Not CambiaEstadoTelefonoHabitacion(cmd, habs(x), estado) Then
                                Return False
                            End If
                        End If
                    Next
                End If



            Catch ex As Exception
                Return False
            End Try
            Return True
        End Function

        Function recalculaFactura(ByVal factura_id As Integer) As Boolean
            Dim cmd As MySqlCommand = prepareConection()
            RecalculaFactura(cmd, factura_id)
            flushConection(cmd, 0)
            Return False
        End Function
        Private Function RecalculaFactura(ByVal cmd As MySqlCommand, ByVal factura_id As Integer) As Boolean
            Dim retVal As Boolean = True
            Dim cuota As Decimal = 0
            Dim Total As Decimal = 0
            Try
                cmd.Parameters.Clear()
                Dim factura_idParam As New MySqlParameter("@factura_id", factura_id)
                cmd.Parameters.Add(factura_idParam)

                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneDatosFacturaParaApunte)
                Dim basecci As FicheroContabilidad.BaseCCI = New FicheroContabilidad.BaseCCI(1)
                '                Dim TotalBases As Decimal = 0
                Dim reserva_id As Object = System.DBNull.Value
                Dim tiene_lineas As Boolean = False
                With reader
                    While .Read And retVal
                        ' BI=Precio/(1+(IGIC/100))
                        If Not .IsDBNull(.GetOrdinal("precio_base")) Then
                            tiene_lineas = True
                            If Not .IsDBNull(.GetOrdinal("reserva_id")) Then
                                reserva_id = .Item("reserva_id")
                            End If
                            Dim Base As Decimal = Math.Round(.Item("Precio_Base") * .Item("Cantidad"), 2, MidpointRounding.AwayFromZero)
                            Total += Base
                            If .IsDBNull(.GetOrdinal("Porc_Igic")) Or .IsDBNull(.GetOrdinal("CTA_IGIC")) Then
                                'falta cuenta igic en esta linea
                                'errorCode = 3
                                retVal = False
                            Else
                                basecci.agregaImpuesto(.Item("Porc_Igic"), Base, .Item("CTA_IGIC"))
                                'fc.agregarBases(BaseCCI, Base, .Item("Porc_Igic"), .Item("CTA_IGIC"))
                            End If
                        End If
                    End While
                End With

                'Dim bases As Decimal = 0
                Dim ar As ArrayList = basecci.obtieneImpuestos()
                Dim enu As IEnumerator = ar.GetEnumerator
                While enu.MoveNext
                    ar = enu.Current
                    cuota += ar(2)
                End While


                'Dim enu As IEnumerator = basecci.CuentasImpuestos.Keys.GetEnumerator
                'While enu.MoveNext
                'cuota += basecci.sumaCuotas(enu.Current)
                'End While
                'cortar decimales
                'Total = Decimal.Truncate(Total * 100) / 100
                cuota = Decimal.Truncate(cuota * 100) / 100
                'cuota = Total - cuota
                'calcula el total de la factura
                'calcula su cuota
                'calcula el total producido de esa factura
                'grabar en la cabecera de factura

                Dim ds As DataSet = getDataSet(cmd, sqlCabAbreFactura)
                If tiene_lineas Then
                    ds.Tables(0).Rows(0).Item("Importe_total") = Total
                    ds.Tables(0).Rows(0).Item("Cuota") = cuota
                    ds.Tables(0).Rows(0).Item("reserva_id") = reserva_id
                Else
                    ds.Tables(0).Rows(0).Item("Importe_total") = System.DBNull.Value
                    ds.Tables(0).Rows(0).Item("Cuota") = System.DBNull.Value
                    ds.Tables(0).Rows(0).Item("reserva_id") = System.DBNull.Value

                End If
                Dim writer As MySqlDataAdapter
                writer = getDataAdapter(cmd, sqlCabAbreFactura)
                writer.Fill(ds.Tables(0))
                writer.Update(ds.Tables(0))
            Catch ex As Exception
                retVal = False
                Return retVal
            End Try
            Return retVal
        End Function
        '        Shared sqlObtieneFacturasNoPendientes = "SELECT distinct facturas.factura_id FROM facturas inner join lineas_factura on facturas.factura_id=lineas_factura.factura_id WHERE facturas.estado_factura_id <> 0"
        Shared sqlObtieneFacturasNoPendientes = "SELECT facturas.factura_id FROM facturas "
        Public Function RecalculaFacturas() As Boolean
            Dim retVal As Boolean = True
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                cmd.Parameters.Clear()
                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneFacturasNoPendientes)
                Dim cont As Integer = 0
                While retVal And reader.Read
                    Dim factura_id As Integer = reader("factura_id")
                    retVal = RecalculaFactura(cmd, factura_id)
                    cont += 1
                    If cont Mod 1000 = 0 Then
                        Console.WriteLine(cont)
                    End If

                End While
            Catch ex As Exception
                retVal = False
            Finally
                If Not retVal Then
                    errorCode = 1
                End If
                flushConection(cmd, errorCode)
            End Try
            Return retVal
        End Function
        'Shared sqlObtieneFacturasConDescuadres = "SELECT facturas.hotel_id,(SELECT min(cajas.caja_id) FROM cajas WHERE cajas.hotel_id=facturas.hotel_id and cajas.cierre_dia = 0) as caja_id,facturas.cliente_id,facturas.factura_id,facturas.Importe_Total,(select sum(l.importe) from lineas_cobro l where l.factura_id=facturas.factura_id) as cobrado,round(sum(lineas_factura.cantidad*lineas_factura.precio),2) totalviejo,facturas.Importe_Total-round(sum(lineas_factura.cantidad*lineas_factura.precio),2) as dif FROM facturas Inner Join lineas_factura ON facturas.factura_id = lineas_factura.factura_id where facturas.Importe_Total<>(select sum(l.importe) from lineas_cobro l where l.factura_id=facturas.factura_id) group by facturas.hotel_id,facturas.cliente_id,facturas.factura_id having Importe_Total<>totalviejo and abs(round(importe_total,2)-round(cobrado,2))>0 and abs(round(importe_total,2)-round(cobrado,2))<1"
        Shared sqlObtieneFacturasConDescuadres = "select facturas.hotel_id,(SELECT min(cajas.caja_id) FROM cajas WHERE cajas.hotel_id=facturas.hotel_id and cajas.cierre_dia = 0) as caja_id,facturas.cliente_id,facturas.factura_id,Coalesce(importe_total,0) as total ,round((select sum(importe) from lineas_cobro where lineas_cobro.factura_id=facturas.factura_id),2) as cobrado,Coalesce(importe_total,0) -round((select sum(importe) from lineas_cobro where lineas_cobro.factura_id=facturas.factura_id),2) as dif from facturas group by facturas.hotel_id,facturas.cliente_id,facturas.factura_id having  not cobrado is null and  total-cobrado<>0 and abs(total-cobrado)>0 and abs(total-cobrado)<1"
        Public Function ArreglaCobrosFacturas()
            Dim retVal As Boolean = True
            Dim errorCode As Integer = 0
            Dim lhotel_id As Integer = -1
            Dim lcaja_id As Integer = -1
            Dim lcliente_id As Integer = -1
            Dim cobro_id As Integer = -1
            Dim cmd As MySqlCommand = prepareConection()
            Try
                cmd.Parameters.Clear()
                Dim reader As DataTableReader = getDataTable(cmd, sqlObtieneFacturasConDescuadres)
                Dim cont As Integer = 0
                Dim fecha As Date
                While retVal And reader.Read
                    Dim factura_id As Integer = reader("factura_id")
                    fecha = FechaHotel(cmd, reader("hotel_id"))
                    If EstaCajaAbierta(cmd, reader("caja_id"), fecha) Then
                        If reader("hotel_id") <> lhotel_id Or reader("caja_id") <> lcaja_id Or reader("cliente_id") <> lcliente_id Then
                            If cobro_id <> -1 Then
                                'actualizar a 2 el cobro
                                If Not CambiarEstadoCobro(cmd, cobro_id, 2, False, fecha.AddDays(-1)) Then
                                    retVal = False
                                End If
                                cobro_id = -1
                            End If
                            lhotel_id = reader("hotel_id")
                            lcaja_id = reader("caja_id")
                            lcliente_id = reader("cliente_id")
                        End If
                        If cobro_id = -1 Then
                            cobro_id = CrearCobro(cmd, 1, factura_id, reader("caja_id"))
                        Else
                            cobrarFactura(cmd, factura_id, cobro_id, 1, False)
                        End If
                        cont += 1
                        If cont Mod 1000 = 0 Then
                            Console.WriteLine(cont)
                        End If
                    End If
                End While
                If retVal And cobro_id <> -1 Then
                    'actualizar a 2 el cobro
                    If Not CambiarEstadoCobro(cmd, cobro_id, 2, False, fecha.AddDays(-1)) Then
                        retVal = False
                    End If
                    cobro_id = -1
                End If
            Catch ex As Exception
                retVal = False
            Finally
                'retVal = False
                If Not retVal Then
                    errorCode = 1
                End If
                flushConection(cmd, errorCode)
            End Try
            Return retVal

        End Function
        Shared sqlObtieneLineasFacturasTPV = "select * from tickets_hoteles where hotel_id=? and fecha=? order by caja_hotel_id,caja_id"
        Public Function ImportarTpvExternos(ByVal hotel_id As Integer, ByVal fecha As Date)
            Dim retVal As Boolean = True
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Try
                'comprobar que no exista cierre contable
                If Not ExisteCierreContable(cmd, hotel_id, fecha) Then
                    'comprobar que exista cierre del tpv
                    If Not ExisteCierreContable(cmd, hotel_id, fecha, True) Then
                        'comprobar que los tpv externos ya esten cerrados
                        If Not ExisteCierreContableTpv(cmd, hotel_id, fecha) Then
                            Dim lineasreader As DataTableReader = getDataTable(cmd, sqlObtieneLineasFacturasTPV)
                            Dim facturaPorCaja As New Hashtable
                            While lineasreader.Read And errorCode = 0
                                'crear 1 factura por caja tpv y por caja del hotel
                                'cobrar la factura con todas las formas de pago (comprobar caja abierta)
                                'comprobar que no queda importe pendiente en las facturas creadas
                                'marcar importacion de datos tpv para ese hotel y fecha
                            End While

                        Else
                            errorCode = 4
                            AgregaInfo("ImportarTpvExternos", "Los tpv externos no estan cerrados:" & hotel_id, -errorCode)
                        End If

                    Else
                        errorCode = 3
                        AgregaInfo("ImportarTpvExternos", "Ya se han importado los tpv externos:" & hotel_id, -errorCode)
                    End If

                Else
                    errorCode = 2
                    AgregaInfo("ImportarTpvExternos", "Ya esta cerrado el hotel:" & hotel_id, -errorCode)
                End If
            Catch ex As Exception
                retVal = False
            End Try

            If Not retVal Then
                errorCode = 1
            End If
            flushConection(cmd, errorCode)
            Return retVal
        End Function
        Shared sqlCrearReserva = "select * from reservas where reserva_id=?"
        Shared sqlCrearLineasReserva = "select * from reservas_servicios where reserva_id=?"
        Function CrearReservas(ByVal reserva_id As Integer, ByVal numero As Integer)
            'crear reserva
            'darle checkin
            'hacer checkout automatico de reservas con errores
            'cerrar todos los checkout
            'todo utilizar una reserva como plantilla y solo cambiar cantidades
            'cantidades entre 1 y 4
            'fechas entre 5 y 15 dias
            'hotel 4
            Dim cmd As MySqlCommand = prepareConection()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Add(reserva_idParam)
            Dim dscab As DataSet = Me.getDataSet(cmd, sqlCrearReserva)
            Dim dslin As DataSet = Me.getDataSet(cmd, sqlCrearLineasReserva)
            Dim rowcab As DataRow = dscab.Tables(0).Rows(0)
            Dim rowlin As DataRow
            Dim x As Integer
            Dim fini As Date
            Dim ffin As Date
            Dim nfil As Integer = dslin.Tables(0).Rows.Count - 1
            Dim randObj As Random = New Random(0)
            Dim oldcants As New Hashtable
            For x = 0 To numero

                fini = New Date(2008, 1 + (Rnd() * 11), 1 + (Rnd() * 26))
                ffin = fini.AddDays(Rnd() * 15 + 5)
                ffin = New Date(ffin.Year, ffin.Month, ffin.Day)
                If ffin.Year = 2009 Then
                    ffin = New Date(2008, 12, 31)
                End If
                Dim dt As DataTable = ObtieneHabitacionesLibresHotel(cmd, rowcab("hotel_id"), fini, ffin).Tables(0)
                If dt.Rows.Count > 0 Then
                    Console.WriteLine(x)
                    rowcab.BeginEdit()
                    rowcab("fecha_prevista_llegada") = fini
                    rowcab("fecha_prevista_salida") = ffin

                    rowcab.SetAdded()
                    rowcab.EndEdit()
                    Dim writer As MySqlDataAdapter
                    writer = getDataAdapter(cmd, sqlCrearReserva)
                    writer.Fill(dscab.Tables(0))
                    writer.Update(dscab.Tables(0))
                    reserva_id = Obtiene_ultima_id(cmd)
                    'actualizar todos los servicios
                    Dim y As Integer
                    For y = 0 To nfil
                        rowlin = dslin.Tables(0).Rows(y)
                        rowlin.BeginEdit()
                        'rowlin("servicio_reserva_id") = System.DBNull.Value
                        If oldcants(rowlin("servicio_reserva_id")) Then
                            rowlin("cantidad") = oldcants(rowlin("servicio_reserva_id"))
                        Else
                            oldcants(rowlin("servicio_reserva_id")) = rowlin("cantidad")
                        End If
                        rowlin("reserva_id") = reserva_id
                        rowlin("cantidad") = randObj.Next(1, rowlin("cantidad"))
                        'mas tarde cambio cantidades
                        rowlin.SetAdded()
                        rowlin.EndEdit()
                    Next
                    writer = getDataAdapter(cmd, sqlCrearLineasReserva)
                    writer.Fill(dslin.Tables(0))
                    writer.Update(dslin.Tables(0))
                    'asignarle una habitacion a la reserva


                    Dim err = 0
                    Dim cycle As Integer = 0
                    While err = 0 And dt.Rows.Count > 0
                        Dim hab As Integer = dt.Rows(0).Item("habitacion_id")
                        dt.Rows.Remove(dt.Rows(0))
                        err = bloqueaHabitacion(cmd, hab, fini, ffin, False, reserva_id)
                        cycle += 1
                    End While
                    If cycle > 1 Then
                        MsgBox("har")
                    End If
                    If err = 0 Then
                        x = numero
                    End If
                Else
                    x -= 1
                End If

                'darle al checkin de esa reserva
                'CambiarEstadoReserva(cmd, reserva_id, 3, False)
            Next
            flushConection(cmd, 0)
            Return True
        End Function
        Shared sqlcrearcierresquery = "SELECT reserva_id FROM reservas WHERE hotel_id =  ? AND fecha_prevista_salida =  ?"
        Shared sqlcrearcierresquery1 = "SELECT reserva_id FROM reservas WHERE hotel_id =  ? AND fecha_prevista_llegada =  ?"

        Sub CrearCierres(ByVal hotel_id As Integer, ByVal ano As Integer)
            Dim fini As Date = New Date(ano, 5, 20)
            Dim fec As Integer
            Dim fecha As Date
            For fec = 0 To 31
                'obtiene reservas ke acaban este dia
                'y se hace checkout automatico
                'gesclase.CambiarEstadoReserva(resid, 5, False)

                flushCache()
                fecha = fini.AddDays(fec)
                Dim cmd As MySqlCommand = prepareConection()
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim fechaParam As New MySqlParameter("@fecha", fecha)
                Dim reserva_idParam As New MySqlParameter("@fecha", 0)
                Dim salidas As Integer = 0
                Dim llegadas As Integer = 0
                Dim facturas As Integer = 0
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fechaParam)
                Dim reader As DataTableReader = getDataTable(cmd, sqlcrearcierresquery)
                While reader.Read
                    CambiarEstadoReserva(cmd, reader("reserva_id"), 5, False)
                    CambiarEstadoReserva(cmd, reader("reserva_id"), 5, False)
                    'todo obtener las facturas de esa reserva y cobrarlas
                    cmd.Parameters.Clear()
                    reserva_idParam.Value = reader("reserva_id")
                    cmd.Parameters.Add(reserva_idParam)
                    Dim readerfac As DataTableReader = getDataTable(cmd, sqlObtieneFacturasReserva)
                    While readerfac.Read
                        'Dim cobro_id As Integer = CrearCobro(cmd, 1, readerfac("factura_id"), 6)
                        'CambiarEstadoCobro(cmd, cobro_id, 1, False)
                        facturas += 1
                    End While

                    salidas += 1
                End While
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fechaParam)
                reader = getDataTable(cmd, sqlcrearcierresquery1)

                While reader.Read
                    CambiarEstadoReserva(cmd, reader("reserva_id"), 3, False)
                    llegadas += 1
                End While

                flushConection(cmd, 0)
                Dim mea = startMeasure()
                generaLineasFacturas(fecha, hotel_id)
                Console.Write("dia:" & fecha & ": llegadas: " & llegadas & "- salidas:" & salidas)
                stopMeasure(mea)
            Next
        End Sub
        Public Shared Function ConvertToHtmlFile(ByVal targetTable As DataTable) As String
            Dim myHtmlFile As String = ""

            If (targetTable Is Nothing) Then
                Throw New System.ArgumentNullException("targetTable")
            Else
                'Continue.
            End If

            'Get a worker object.
            Dim myBuilder As System.Text.StringBuilder = New System.Text.StringBuilder()

            'Open tags and write the top portion.

            myBuilder.Append("<table border='1px' cellpadding='5' cellspacing='0' ")
            myBuilder.Append("style='border: solid 1px Silver; ffont-size: x-small;'>")

            'Add the headings row.
            myBuilder.Append("<th align='left' valign='top'>" & targetTable.TableName & "<th>")
            myBuilder.Append("<tr align='left' valign='top'>")

            For Each myColumn As DataColumn In targetTable.Columns
                myBuilder.Append("<td align='left' valign='top'>")
                myBuilder.Append(myColumn.ColumnName)
                myBuilder.Append("</td>")
            Next myColumn

            myBuilder.Append("</tr>")


            'Add the data rows.
            For Each myRow As DataRow In targetTable.Rows
                myBuilder.Append("<tr align='left' valign='top'>")

                For Each myColumn As DataColumn In targetTable.Columns
                    myBuilder.Append("<td align='left' valign='top'>")
                    myBuilder.Append(myRow(myColumn.ColumnName).ToString())
                    myBuilder.Append("</td>")
                Next myColumn


                myBuilder.Append("</tr>")
            Next myRow

            'Close tags.
            myBuilder.Append("</table>")
            'Get the string for return.
            myHtmlFile = myBuilder.ToString()

            Return myHtmlFile
        End Function

        Shared sqlISTACabecera As String = "select empresas.empresa as RAZON_SOCIAL," _
& " cabecera.hotel as NOMBRE_ESTABLECIMIENTO, " _
& " replace(empresas.cif,'-','') as CIF_NIF," _
& " cabecera.numero_registro_ista as NUMERO_REGISTRO, " _
& " cabecera.direccion as DIRECCION, " _
& " cabecera.zip as CODIGO_POSTAL, " _
& " cabecera.poblacion as LOCALIDAD, " _
& " cabecera.municipio_ista as MUNICIPIO, " _
& " provincias.provincia as PROVINCIA, " _
& " replace(replace(replace(cabecera.telefono,')',''),'(',''),' ','') as TELEFONO_1, " _
& " replace(replace(replace(cabecera.telefono,')',''),'(',''),' ','') as TELEFONO_2, " _
& " replace(replace(replace(cabecera.fax,')',''),'(',''),' ','') as FAX_1, " _
& " replace(replace(replace(cabecera.fax,')',''),'(',''),' ','') as FAX_2, " _
& " 'Hoteles' as TIPO, " _
& " 'H4' as CATEGORIA, " _
& " 0 as HABITACIONES, " _
& " 0 as PLAZAS_DISPONIBLES_SIN_SUPLETORIAS, " _
& " 'http://www.hdhotels.com/' as URL " _
& " from empresas inner join hoteles as cabecera on empresas.empresa_id=cabecera.empresa_id left join provincias on provincias.provincia_id=cabecera.provincia_id where cabecera.hotel_id=?"
        Shared sqlISTAAlojamiento As String = "select " _
        & " '000' as ID_PAIS," _
        & " '00000' as ID_PROVINCIA_ISLA," _
        & " 1 as N_DIA," _
        & " 0 as ENTRADAS," _
        & " 0 as SALIDAS," _
        & " 0 as PERNOCTACIONES" _
        & " from hoteles as ALOJAMIENTO where hotel_id=0"

        Shared sqlISTAHabitaciones As String = "select " _
& " 1 as HABITACIONES_N_DIA," _
& " 0 as PLAZAS_SUPLETORIAS," _
& " 0 as HABITACIONES_DOBLES_USO_DOBLE," _
& " 0 as HABITACIONES_DOBLES_USO_INDIVIDUA," _
& " 0 as HABITACIONES_OTRAS" _
& " from hoteles as HABITACIONES where hotel_id=0"

        Shared sqlISTAPrecios As String = "select " _
& " 1000.99 as REVPAR_MENSUAL," _
& " 1000.99 as ADR_MENSUAL," _
& " 1000.99 as ADR_TOUROPERADOR_TRADICIONAL," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_TRADICIONAL," _
& " 1000.99 as ADR_TOUROPERADOR_ONLINE," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_ONLINE," _
& " 1000.99 as ADR_EMPRESAS," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_EMPRESAS," _
& " 1000.99 as ADR_AGENCIA_DE_VIAJE_TRADICIONAL," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_AGENCIA_TRADICIONAL," _
& " 1000.99 as ADR_AGENCIA_DE_VIAJE_ONLINE," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_AGENCIA_ONLINE," _
& " 1000.99 as ADR_PARTICULARES," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_PARTICULARES," _
& " 1000.99 as ADR_GRUPOS," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_GRUPOS," _
& " 1000.99 as ADR_INTERNET," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_INTERNET," _
& " 1000.99 as ADR_OTROS," _
& " 99.99 as PCTN_HABITACIONES_OCUPADAS_OTROS" _
& " from hoteles as PRECIOS where hotel_id=0"
        Shared sqlISTAPERSONAL_OCUPADO = "select " _
& " 1000.99 as PERSONAL_NO_REMUNERADO," _
& " 1000.99 as PERSONAL_REMUNERADO_FIJO," _
& " 1000.99 as PERSONAL_REMUNERADO_EVENTUAL " _
        & " from hoteles where hotel_id=0"
        Shared sqlISTALlegadasSalidasPernoctaciones = "" _
& " SELECT" _
& " reservas_huespedes.fecha_llegada, " _
& " Coalesce(reservas_huespedes.fecha_salida,Coalesce(reservas.fecha_salida,fecha_prevista_salida)) as fecha_salida, " _
& " concat(Coalesce(naciones.pais_ista,'ESP'),'-',case Coalesce(naciones.pais_ista,'ESP') when 'ESP' then Coalesce(provincias.provincia_ista,pd.provincia_ista) else 0 end) as nacion_id,  " _
& " count(*) as cantidad " _
& " FROM " _
& " reservas_huespedes " _
& " Inner Join reservas ON reservas_huespedes.reserva_id = reservas.reserva_id " _
& " Inner Join clientes ON reservas_huespedes.cliente_id = clientes.cliente_id " _
& " left Join naciones ON clientes.nacion_id = naciones.nacion_id " _
& " left Join provincias ON provincias.provincia_id = clientes.provincia_id " _
& " left Join provincias pd ON pd.defecto_ista = 1 " _
& " WHERE " _
& " reservas.hotel_id=? and reservas.estado_reserva_id NOT IN  (0,1,2) " _
& " and  " _
& " (reservas_huespedes.fecha_llegada between  ? and  ? " _
& " or  Coalesce(reservas_huespedes.fecha_salida,Coalesce(reservas.fecha_salida,fecha_prevista_salida)) between  ? and  ? " _
& " ) " _
& " group by reservas_huespedes.fecha_llegada, Coalesce(reservas_huespedes.fecha_salida,Coalesce(reservas.fecha_salida,fecha_prevista_salida)),naciones.pais_ista,Coalesce(provincias.provincia_ista,0) "
        Shared sqlISTAHabitacionesOcupadasPorDiaTipo = "" _
& " SELECT distinct" _
& " habitaciones.habitacion_id, " _
& " habitaciones.tipo_habitacion_id " _
& " FROM " _
& " habitaciones_bloqueos " _
& " Inner Join habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id " _
& " Inner Join reservas ON habitaciones_bloqueos.reserva_id = reservas.reserva_id " _
& " Inner Join tipos_habitacion ON habitaciones.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id " _
& " WHERE " _
& " tipos_habitacion.desvios=0 and  " _
& " reservas.estado_reserva_id IN  (3,4,5) AND " _
& " habitaciones.hotel_id =  ? AND " _
& " habitaciones_bloqueos.fecha_desde <>  habitaciones_bloqueos.fecha_hasta " _
& " and habitaciones_bloqueos.fecha_hasta<>?" _
& " and " _
& "         ?  between habitaciones_bloqueos.fecha_desde and habitaciones_bloqueos.fecha_hasta "
        Shared sqlISTAEnvios = "select * from envios_ista where hotel_id=? and ano=? and mes=?"
        Shared sqlISTAPreciosPor = "" _
& " SELECT clientes.permite_credito,lineas_factura.fecha, " _
& " Sum(lineas_factura.cantidad*lineas_factura.precio) AS precio, " _
& " Sum(case lineas_factura.unidad_calculo_id=1 when 1 then lineas_factura.cantidad else 0 end) AS nhab, " _
& " Sum(lineas_factura.cantidad*lineas_factura.precio) /Sum(case lineas_factura.unidad_calculo_id=1 when 1 then lineas_factura.cantidad else 0 end) as pvp_medio " _
& " FROM  lineas_factura " _
& " Inner Join reservas ON lineas_factura.reserva_id = reservas.reserva_id " _
& " Inner Join servicios ON lineas_factura.servicio_id = servicios.servicio_id " _
& " Left Join clientes ON reservas.cliente_id = clientes.cliente_id " _
& " WHERE lineas_factura.hotel_id =  ? AND " _
& " reservas.estado_reserva_id IN  (3, 4,5) AND " _
& " lineas_factura.fecha between  ? and ? " _
& " and servicios.tipo_servicio_id=1 " _
& " group by clientes.permite_credito,lineas_factura.fecha "

        Private Sub CargarColumnasIsta(ByVal rowo As DataRow, ByVal row As DataRow)
            Dim x As Integer
            For x = 0 To row.Table.Columns.Count - 1
                'Console.WriteLine(row.Table.Columns(x).ColumnName)
                Try
                    If rowo.IsNull(row.Table.Columns(x).ColumnName) Then
                    End If
                Catch ex As Exception
                    Console.WriteLine(row.Table.Columns(x).ColumnName)
                End Try
            Next

            For x = 0 To rowo.Table.Columns.Count - 1
                row(rowo.Table.Columns(x).ColumnName) = rowo(rowo.Table.Columns(x).ColumnName)
            Next
        End Sub

        Public Function obtieneDatosISTA(ByVal hotel_id As Integer, ByVal ano As Integer, ByVal mes As Integer)
            'Dim istads As New DataSet
            'Dim Report As StiReport = New StiReport()
            Dim istads As DataSet = New DataSet("Test")
            '            istads.ReadXmlSchema("C:\Proyectos Codecharge\ClasesGesHotel_tano\ClasesGesHotel\ista.xsd")
            istads.ReadXml("C:\Proyectos Codecharge\ClasesGesHotel_tano\ClasesGesHotel\ista.xsd")
            'crear encuesta
            Dim encuesta_id As Integer
            Dim cmd As MySqlCommand = prepareConection()
            Dim sql_habitaciones_hotel As String = "SELECT count(habitacion_id)" _
            & " FROM habitaciones " _
            & " INNER JOIN tipos_habitacion ON habitaciones.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id " _
            & " WHERE habitaciones.hotel_id = ? And tipos_habitacion.desvios <> 1"

            Try


                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim anoParam As New MySqlParameter("@ano", ano)
                Dim mesParam As New MySqlParameter("@mes", mes)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                Dim total_habitaciones As Integer = ExecuteScalar(cmd, sql_habitaciones_hotel)

                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(anoParam)
                cmd.Parameters.Add(mesParam)

                Dim dsenvios As DataSet = getDataSet(cmd, sqlISTAEnvios)

                For encuesta_id = 1 To 1
                    Dim row As DataRow = istads.Tables("ENCUESTA").NewRow   'crear ENCUESTA
                    row("ENCUESTA_Id") = encuesta_id
                    istads.Tables("ENCUESTA").Rows.Add(row)
                    'campos a rellenar en row
                    Dim cabecera_id As Integer
                    Dim residencia_id As Integer = 1
                    Dim x As Date
                    Dim fecha_desde As New Date(ano, mes, 1)
                    Dim fecha_hasta As New Date(ano, mes, 1)
                    fecha_hasta = fecha_hasta.AddMonths(1).AddDays(-1)
                    Dim mathab() As Integer = ObtieneHabitacionesDisponiblesHotelDia(cmd, hotel_id, fecha_desde, 0, True)
                    For cabecera_id = 1 To 1

                        'Dim residencia_id As Integer = 1
                        'Dim x As Date
                        'Dim fecha_desde As New Date(ano, mes, 1)
                        'Dim fecha_hasta As New Date(ano, mes, 1)
                        'fecha_hasta = fecha_hasta.AddMonths(1).AddDays(-1)
                        'Dim mathab() As Integer = ObtieneHabitacionesDisponiblesHotelDia(cmd, hotel_id, fecha_desde, 0, True)

                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(hotel_idParam)
                        Dim ds As DataSet = getDataSet(cmd, sqlISTACabecera)



                        row = istads.Tables("CABECERA").NewRow    'crear CABECERA
                        CargarColumnasIsta(ds.Tables(0).Rows(0), row)
                        'deberia sacar la media de todo el mes o con el primer dia del mes me vale?
                        Dim rowcab As DataRow = row
                        Dim npec As Integer = 0
                        rowcab("DIAS_ABIERTO_MES_REFERENCIA") = npec.ToString("00")
                        row("HABITACIONES") = total_habitaciones
                        row("PLAZAS_DISPONIBLES_SIN_SUPLETORIAS") = mathab(1)

                        'enganchar la encuesta_id?
                        row("ENCUESTA_Id") = encuesta_id
                        row("CABECERA_Id") = cabecera_id
                        istads.Tables("CABECERA").Rows.Add(rowcab)

                        row = istads.Tables("FECHA_REFERENCIA").NewRow    'crear FECHA_REFERENCIA
                        row("MES") = mes.ToString("00")
                        row("ANYO") = ano.ToString("0000")
                        row("CABECERA_Id") = cabecera_id
                        istads.Tables("FECHA_REFERENCIA").Rows.Add(row)


                        row = istads.Tables("ALOJAMIENTO").NewRow    'crear  ALOJAMIENTO
                        Dim alojamiento_id As Integer = 1
                        row("ALOJAMIENTO_Id") = alojamiento_id
                        row("ENCUESTA_Id") = encuesta_id

                        istads.Tables("ALOJAMIENTO").Rows.Add(row)



                        Dim fecha_desdeParam As New MySqlParameter("@fecha_desde", convertFecha(fecha_desde))
                        Dim fecha_hastaParam As New MySqlParameter("@fecha_hasta", convertFecha(fecha_hasta))
                        Dim fecha_desde1Param As New MySqlParameter("@fecha_desde1", convertFecha(fecha_desde))
                        Dim fecha_hasta1Param As New MySqlParameter("@fecha_hasta1", convertFecha(fecha_hasta))

                        cmd.Parameters.Add(fecha_desdeParam)
                        cmd.Parameters.Add(fecha_hastaParam)
                        cmd.Parameters.Add(fecha_desde1Param)
                        cmd.Parameters.Add(fecha_hasta1Param)

                        Dim dshuespedes As DataSet = getDataSet(cmd, sqlISTALlegadasSalidasPernoctaciones)
                        Dim dsprecios As DataSet = getDataSet(cmd, sqlISTAPreciosPor)
                        'sacar los paises distintos
                        Dim naciones As Hashtable = AgruparRowsPor(dshuespedes.Tables(0).Select("", "nacion_id"), "nacion_id", "nacion_id", "cantidad")
                        Dim naci As String
                        For Each naci In naciones.Keys
                            'por cada residencia pais/provincia
                            row = istads.Tables("RESIDENCIA").NewRow    'crear  RESIDENCIA
                            row("ALOJAMIENTO_Id") = alojamiento_id
                            'residencia_id = naci
                            row("RESIDENCIA_Id") = residencia_id
                            Dim nacp() As String = naci.Split("-")
                            If nacp(1) <> "0" Then
                                row("ID_PROVINCIA_ISLA") = nacp(1)
                                row.Table.Columns("ID_PAIS").AllowDBNull = True
                                row("ID_PAIS") = Nothing
                            Else
                                row("ID_PAIS") = nacp(0)
                                row.Table.Columns("ID_PROVINCIA_ISLA").AllowDBNull = True
                                row("ID_PROVINCIA_ISLA") = Nothing
                            End If

                            istads.Tables("RESIDENCIA").Rows.Add(row)
                            Dim dv As DataTable = New DataView(dshuespedes.Tables(0), "nacion_id='" & naci & "'", "fecha_llegada", DataViewRowState.CurrentRows).ToTable
                            'por dia

                            x = fecha_desde

                            While x <= fecha_hasta
                                row = istads.Tables("MOVIMIENTO").NewRow    'crear  RESIDENCIA
                                'row("ALOJAMIENTO_ID") = mes
                                row("RESIDENCIA_Id") = residencia_id
                                row("N_DIA") = x.Day.ToString("00")

                                row("ENTRADAS") = dv.Compute("sum(cantidad)", "fecha_llegada='" & convertFecha(x) & "'")
                                row("SALIDAS") = dv.Compute("sum(cantidad)", "fecha_salida='" & convertFecha(x) & "'")
                                row("PERNOCTACIONES") = dv.Compute("sum(cantidad)", "fecha_llegada<='" & convertFecha(x) & "' and fecha_salida>'" & convertFecha(x) & "'")
                                If row.IsNull("ENTRADAS") Then
                                    row("ENTRADAS") = 0
                                End If
                                If row.IsNull("SALIDAS") Then
                                    row("SALIDAS") = 0
                                End If
                                If row.IsNull("PERNOCTACIONES") Then
                                    row("PERNOCTACIONES") = 0
                                End If

                                'row("ID_PROVINCIA_ISLA") = ""

                                istads.Tables("MOVIMIENTO").Rows.Add(row)
                                x = x.AddDays(1)
                            End While
                            residencia_id += 1
                        Next

                        x = fecha_desde
                        Dim habitacion_id As Integer = 1
                        row = istads.Tables("HABITACIONES").NewRow    'crear  RESIDENCIA
                        row("ENCUESTA_Id") = encuesta_id
                        row("HABITACIONES_id") = habitacion_id
                        istads.Tables("HABITACIONES").Rows.Add(row)
                        Dim habitaciones_ocupadas_mes As Integer = 0

                        While x <= fecha_hasta
                            'por dia

                            row = istads.Tables("HABITACIONES_MOVIMIENTO").NewRow    'crear  RESIDENCIA
                            row("HABITACIONES_id") = habitacion_id
                            row("HABITACIONES_N_DIA") = x.Day.ToString("00")
                            row("PLAZAS_SUPLETORIAS") = 0
                            fecha_desdeParam.Value = convertFecha(x)
                            fecha_hastaParam.Value = convertFecha(x)
                            Dim dshabitaciones As DataSet = getDataSet(cmd, sqlISTAHabitacionesOcupadasPorDiaTipo)
                            Dim nhabs As Object = 0
                            nhabs = dshabitaciones.Tables(0).Rows.Count

                            If IsDBNull(nhabs) Then
                                nhabs = 0
                            Else
                                If nhabs > 0 Then
                                    npec += 1
                                End If
                            End If
                            habitaciones_ocupadas_mes += nhabs
                            row("HABITACIONES_DOBLES_USO_DOBLE") = nhabs
                            row("HABITACIONES_DOBLES_USO_INDIVIDUAL") = 0
                            row("HABITACIONES_OTRAS") = 0
                            istads.Tables("HABITACIONES_MOVIMIENTO").Rows.Add(row)
                            x = x.AddDays(1)
                        End While
                        rowcab("DIAS_ABIERTO_MES_REFERENCIA") = npec.ToString("00")
                        row = istads.Tables("PRECIOS").NewRow    'crear  PRECIOS
                        row("ENCUESTA_Id") = encuesta_id
                        row("REVPAR_MENSUAL") = 0
                        row("ADR_MENSUAL") = 0
                        row("ADR_TOUROPERADOR_TRADICIONAL") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_TRADICIONAL") = 0
                        row("ADR_TOUROPERADOR_ONLINE") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_ONLINE") = 0
                        row("ADR_EMPRESAS") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_EMPRESAS") = 0
                        row("ADR_AGENCIA_DE_VIAJE_TRADICIONAL") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_AGENCIA_TRADICIONAL") = 0
                        row("ADR_AGENCIA_DE_VIAJE_ONLINE") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_AGENCIA_ONLINE") = 0
                        row("ADR_PARTICULARES") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_PARTICULARES") = 0
                        row("ADR_GRUPOS") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_GRUPOS") = 0
                        row("ADR_INTERNET") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_INTERNET") = 0
                        row("ADR_OTROS") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_OTROS") = 0
                        Dim tothab As Object = dsprecios.Tables(0).Compute("sum(nhab)", "")
                        If IsDBNull(tothab) Then
                            tothab = 0
                        End If
                        Dim totREVPAR As Object = dsprecios.Tables(0).Compute("sum(pvp_medio)", "")
                        If IsDBNull(totREVPAR) Then
                            totREVPAR = 0
                        End If
                        Dim totmen As Object = dsprecios.Tables(0).Compute("avg(pvp_medio)", "")
                        If IsDBNull(totmen) Then
                            totmen = 0
                        End If
                        Dim tottour As Object = dsprecios.Tables(0).Compute("avg(pvp_medio)", "permite_credito=1")
                        If IsDBNull(tottour) Then
                            tottour = 0
                        End If
                        Dim totdire As Object = dsprecios.Tables(0).Compute("avg(pvp_medio)", "permite_credito<>1")
                        If IsDBNull(totdire) Then
                            totdire = 0
                        End If
                        Dim tottourhab As Object = dsprecios.Tables(0).Compute("sum(nhab)", "permite_credito=1")
                        If IsDBNull(tottourhab) Then
                            tottourhab = 0
                        End If
                        Dim totdirehab As Object = dsprecios.Tables(0).Compute("sum(nhab)", "permite_credito<>1")
                        If IsDBNull(totdirehab) Then
                            totdirehab = 0
                        End If

                        row("ADR_TOUROPERADOR_TRADICIONAL") = Math.Round(tottour, 2, MidpointRounding.AwayFromZero)
                        row("PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_TRADICIONAL") = Math.Round(tottourhab / tothab * 100, 2, MidpointRounding.AwayFromZero)
                        row("ADR_PARTICULARES") = Math.Round(totdire, 2, MidpointRounding.AwayFromZero)
                        row("PCTN_HABITACIONES_OCUPADAS_PARTICULARES") = Math.Round(totdirehab / tothab * 100, 2, MidpointRounding.AwayFromZero)
                        row("ADR_MENSUAL") = Math.Round(row("ADR_TOUROPERADOR_TRADICIONAL") * row("PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_TRADICIONAL") / 100 + row("ADR_PARTICULARES") * row("PCTN_HABITACIONES_OCUPADAS_PARTICULARES") / 100, 2, MidpointRounding.AwayFromZero)
                        'row("REVPAR_MENSUAL") = Math.Round(totREVPAR, 2, MidpointRounding.AwayFromZero)
                        row("REVPAR_MENSUAL") = Math.Round((habitaciones_ocupadas_mes * row("ADR_MENSUAL")) / (npec * total_habitaciones), 2, MidpointRounding.AwayFromZero)
                        istads.Tables("PRECIOS").Rows.Add(row)
                    Next


                    row = istads.Tables("PERSONAL_OCUPADO").NewRow    'crear  PERSONAL_OCUPADO
                    row("ENCUESTA_ID") = encuesta_id
                    row("PERSONAL_NO_REMUNERADO") = 0
                    row("PERSONAL_REMUNERADO_FIJO") = 0
                    row("PERSONAL_REMUNERADO_EVENTUAL") = 0
                    If dsenvios.Tables(0).Rows.Count > 0 Then
                        row("PERSONAL_NO_REMUNERADO") = dsenvios.Tables(0).Rows(0)("PERSONAL_NO_REMUNERADO")
                        row("PERSONAL_REMUNERADO_FIJO") = dsenvios.Tables(0).Rows(0)("PERSONAL_REMUNERADO_FIJO")
                        row("PERSONAL_REMUNERADO_EVENTUAL") = dsenvios.Tables(0).Rows(0)("PERSONAL_REMUNERADO_EVENTUAL")

                    End If
                    'row("ID_PROVINCIA_ISLA") = ""

                    istads.Tables("PERSONAL_OCUPADO").Rows.Add(row)

                Next
            Catch ex As Exception
                istads.Tables.Clear()
            End Try
            'Me.dumpDataTable(row.Table)
            flushConection(cmd, 0)

            Validate("C:\Proyectos Codecharge\ClasesGesHotel_tano\ClasesGesHotel\ista.xsd", New IO.MemoryStream(System.Text.Encoding.ASCII.GetBytes(obtieneXMLdeDataset(istads))))
            Return istads
        End Function
        Public Function obtieneDatosINE(ByVal hotel_id As Integer, ByVal ano As Integer, ByVal mes As Integer)
            ' Es exactamente igual al ISTAC al menos de salida
            'Dim Report As StiReport = New StiReport()
            Dim istads As DataSet = New DataSet("Test")
            istads.ReadXml("C:\Proyectos Codecharge\ClasesGesHotel_tano\ClasesGesHotel\ine.xsd")
            'crear encuesta
            Dim encuesta_id As Integer
            Dim cmd As MySqlCommand = prepareConection()
            Dim sql_habitaciones_hotel As String = "SELECT count(habitacion_id)" _
            & " FROM habitaciones " _
            & " INNER JOIN tipos_habitacion ON habitaciones.tipo_habitacion_id = tipos_habitacion.tipo_habitacion_id " _
            & " WHERE habitaciones.hotel_id = ? And tipos_habitacion.desvios <> 1"
            Try
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim anoParam As New MySqlParameter("@ano", ano)
                Dim mesParam As New MySqlParameter("@mes", mes)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                Dim total_habitaciones As Integer = ExecuteScalar(cmd, sql_habitaciones_hotel)

                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(anoParam)
                cmd.Parameters.Add(mesParam)

                Dim dsenvios As DataSet = getDataSet(cmd, sqlISTAEnvios)

                For encuesta_id = 1 To 1
                    Dim row As DataRow = istads.Tables("ENCUESTA").NewRow   'crear ENCUESTA
                    row("ENCUESTA_Id") = encuesta_id
                    istads.Tables("ENCUESTA").Rows.Add(row)
                    'campos a rellenar en row
                    Dim cabecera_id As Integer
                    Dim residencia_id As Integer = 1
                    Dim x As Date
                    Dim fecha_desde As New Date(ano, mes, 1)
                    Dim fecha_hasta As New Date(ano, mes, 1)
                    fecha_hasta = fecha_hasta.AddMonths(1).AddDays(-1)
                    Dim mathab() As Integer = ObtieneHabitacionesDisponiblesHotelDia(cmd, hotel_id, fecha_desde, 0, True)
                    For cabecera_id = 1 To 1

                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(hotel_idParam)
                        Dim ds As DataSet = getDataSet(cmd, sqlISTACabecera)

                        row = istads.Tables("CABECERA").NewRow    'crear CABECERA
                        CargarColumnasIsta(ds.Tables(0).Rows(0), row)
                        'deberia sacar la media de todo el mes o con el primer dia del mes me vale?
                        Dim rowcab As DataRow = row
                        Dim npec As Integer = 0
                        rowcab("DIAS_ABIERTO_MES_REFERENCIA") = npec.ToString("00")
                        row("HABITACIONES") = total_habitaciones
                        row("PLAZAS_DISPONIBLES_SIN_SUPLETORIAS") = mathab(1)

                        'enganchar la encuesta_id?
                        row("ENCUESTA_Id") = encuesta_id
                        row("CABECERA_Id") = cabecera_id
                        istads.Tables("CABECERA").Rows.Add(rowcab)

                        row = istads.Tables("FECHA_REFERENCIA").NewRow    'crear FECHA_REFERENCIA
                        row("MES") = mes.ToString("00")
                        row("ANYO") = ano.ToString("0000")
                        row("CABECERA_Id") = cabecera_id
                        istads.Tables("FECHA_REFERENCIA").Rows.Add(row)


                        row = istads.Tables("ALOJAMIENTO").NewRow    'crear  ALOJAMIENTO
                        Dim alojamiento_id As Integer = 1
                        row("ALOJAMIENTO_Id") = alojamiento_id
                        row("ENCUESTA_Id") = encuesta_id

                        istads.Tables("ALOJAMIENTO").Rows.Add(row)



                        Dim fecha_desdeParam As New MySqlParameter("@fecha_desde", convertFecha(fecha_desde))
                        Dim fecha_hastaParam As New MySqlParameter("@fecha_hasta", convertFecha(fecha_hasta))
                        Dim fecha_desde1Param As New MySqlParameter("@fecha_desde1", convertFecha(fecha_desde))
                        Dim fecha_hasta1Param As New MySqlParameter("@fecha_hasta1", convertFecha(fecha_hasta))

                        cmd.Parameters.Add(fecha_desdeParam)
                        cmd.Parameters.Add(fecha_hastaParam)
                        cmd.Parameters.Add(fecha_desde1Param)
                        cmd.Parameters.Add(fecha_hasta1Param)

                        Dim dshuespedes As DataSet = getDataSet(cmd, sqlISTALlegadasSalidasPernoctaciones)
                        Dim dsprecios As DataSet = getDataSet(cmd, sqlISTAPreciosPor)
                        'sacar los paises distintos
                        Dim naciones As Hashtable = AgruparRowsPor(dshuespedes.Tables(0).Select("", "nacion_id"), "nacion_id", "nacion_id", "cantidad")
                        Dim naci As String
                        For Each naci In naciones.Keys
                            'por cada residencia pais/provincia
                            row = istads.Tables("RESIDENCIA").NewRow    'crear  RESIDENCIA
                            row("ALOJAMIENTO_Id") = alojamiento_id
                            'residencia_id = naci
                            row("RESIDENCIA_Id") = residencia_id
                            Dim nacp() As String = naci.Split("-")
                            If nacp(1) <> "0" Then
                                row("ID_PROVINCIA_ISLA") = nacp(1)
                                row.Table.Columns("ID_PAIS").AllowDBNull = True
                                row("ID_PAIS") = Nothing
                            Else
                                row("ID_PAIS") = nacp(0)
                                row.Table.Columns("ID_PROVINCIA_ISLA").AllowDBNull = True
                                row("ID_PROVINCIA_ISLA") = Nothing
                            End If

                            istads.Tables("RESIDENCIA").Rows.Add(row)
                            Dim dv As DataTable = New DataView(dshuespedes.Tables(0), "nacion_id='" & naci & "'", "fecha_llegada", DataViewRowState.CurrentRows).ToTable
                            'por dia

                            x = fecha_desde

                            While x <= fecha_hasta
                                row = istads.Tables("MOVIMIENTO").NewRow    'crear  RESIDENCIA
                                'row("ALOJAMIENTO_ID") = mes
                                row("RESIDENCIA_Id") = residencia_id
                                row("N_DIA") = x.Day.ToString("00")

                                row("ENTRADAS") = dv.Compute("sum(cantidad)", "fecha_llegada='" & convertFecha(x) & "'")
                                row("SALIDAS") = dv.Compute("sum(cantidad)", "fecha_salida='" & convertFecha(x) & "'")
                                row("PERNOCTACIONES") = dv.Compute("sum(cantidad)", "fecha_llegada<='" & convertFecha(x) & "' and fecha_salida>'" & convertFecha(x) & "'")
                                If row.IsNull("ENTRADAS") Then
                                    row("ENTRADAS") = 0
                                End If
                                If row.IsNull("SALIDAS") Then
                                    row("SALIDAS") = 0
                                End If
                                If row.IsNull("PERNOCTACIONES") Then
                                    row("PERNOCTACIONES") = 0
                                End If

                                'row("ID_PROVINCIA_ISLA") = ""

                                istads.Tables("MOVIMIENTO").Rows.Add(row)
                                x = x.AddDays(1)
                            End While
                            residencia_id += 1
                        Next

                        x = fecha_desde
                        Dim habitacion_id As Integer = 1
                        row = istads.Tables("HABITACIONES").NewRow    'crear  RESIDENCIA
                        row("ENCUESTA_Id") = encuesta_id
                        row("HABITACIONES_id") = habitacion_id
                        istads.Tables("HABITACIONES").Rows.Add(row)
                        Dim habitaciones_ocupadas_mes As Integer = 0

                        While x <= fecha_hasta
                            'por dia

                            row = istads.Tables("HABITACIONES_MOVIMIENTO").NewRow    'crear  RESIDENCIA
                            row("HABITACIONES_id") = habitacion_id
                            row("HABITACIONES_N_DIA") = x.Day.ToString("00")
                            row("PLAZAS_SUPLETORIAS") = 0
                            fecha_desdeParam.Value = convertFecha(x)
                            fecha_hastaParam.Value = convertFecha(x)
                            Dim dshabitaciones As DataSet = getDataSet(cmd, sqlISTAHabitacionesOcupadasPorDiaTipo)
                            Dim nhabs As Object = 0
                            nhabs = dshabitaciones.Tables(0).Rows.Count

                            If IsDBNull(nhabs) Then
                                nhabs = 0
                            Else
                                If nhabs > 0 Then
                                    npec += 1
                                End If
                            End If
                            habitaciones_ocupadas_mes += nhabs
                            row("HABITACIONES_DOBLES_USO_DOBLE") = nhabs
                            row("HABITACIONES_DOBLES_USO_INDIVIDUAL") = 0
                            row("HABITACIONES_OTRAS") = 0
                            istads.Tables("HABITACIONES_MOVIMIENTO").Rows.Add(row)
                            x = x.AddDays(1)
                        End While
                        rowcab("DIAS_ABIERTO_MES_REFERENCIA") = npec.ToString("00")
                        row = istads.Tables("PRECIOS").NewRow    'crear  PRECIOS
                        row("ENCUESTA_Id") = encuesta_id
                        row("REVPAR_MENSUAL") = 0
                        row("ADR_MENSUAL") = 0
                        row("ADR_TOUROPERADOR_TRADICIONAL") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_TRADICIONAL") = 0
                        row("ADR_TOUROPERADOR_ONLINE") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_ONLINE") = 0
                        row("ADR_EMPRESAS") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_EMPRESAS") = 0
                        row("ADR_AGENCIA_DE_VIAJE_TRADICIONAL") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_AGENCIA_TRADICIONAL") = 0
                        row("ADR_AGENCIA_DE_VIAJE_ONLINE") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_AGENCIA_ONLINE") = 0
                        row("ADR_PARTICULARES") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_PARTICULARES") = 0
                        row("ADR_GRUPOS") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_GRUPOS") = 0
                        row("ADR_INTERNET") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_INTERNET") = 0
                        row("ADR_OTROS") = 0
                        row("PCTN_HABITACIONES_OCUPADAS_OTROS") = 0
                        Dim tothab As Object = dsprecios.Tables(0).Compute("sum(nhab)", "")
                        If IsDBNull(tothab) Then
                            tothab = 0
                        End If
                        Dim totREVPAR As Object = dsprecios.Tables(0).Compute("sum(pvp_medio)", "")
                        If IsDBNull(totREVPAR) Then
                            totREVPAR = 0
                        End If
                        Dim totmen As Object = dsprecios.Tables(0).Compute("avg(pvp_medio)", "")
                        If IsDBNull(totmen) Then
                            totmen = 0
                        End If
                        Dim tottour As Object = dsprecios.Tables(0).Compute("avg(pvp_medio)", "permite_credito=1")
                        If IsDBNull(tottour) Then
                            tottour = 0
                        End If
                        Dim totdire As Object = dsprecios.Tables(0).Compute("avg(pvp_medio)", "permite_credito<>1")
                        If IsDBNull(totdire) Then
                            totdire = 0
                        End If
                        Dim tottourhab As Object = dsprecios.Tables(0).Compute("sum(nhab)", "permite_credito=1")
                        If IsDBNull(tottourhab) Then
                            tottourhab = 0
                        End If
                        Dim totdirehab As Object = dsprecios.Tables(0).Compute("sum(nhab)", "permite_credito<>1")
                        If IsDBNull(totdirehab) Then
                            totdirehab = 0
                        End If

                        row("ADR_TOUROPERADOR_TRADICIONAL") = Math.Round(tottour, 2, MidpointRounding.AwayFromZero)
                        row("PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_TRADICIONAL") = Math.Round(tottourhab / tothab * 100, 2, MidpointRounding.AwayFromZero)
                        row("ADR_PARTICULARES") = Math.Round(totdire, 2, MidpointRounding.AwayFromZero)
                        row("PCTN_HABITACIONES_OCUPADAS_PARTICULARES") = Math.Round(totdirehab / tothab * 100, 2, MidpointRounding.AwayFromZero)
                        row("ADR_MENSUAL") = Math.Round(row("ADR_TOUROPERADOR_TRADICIONAL") * row("PCTN_HABITACIONES_OCUPADAS_TOUROPERADOR_TRADICIONAL") / 100 + row("ADR_PARTICULARES") * row("PCTN_HABITACIONES_OCUPADAS_PARTICULARES") / 100, 2, MidpointRounding.AwayFromZero)
                        'row("REVPAR_MENSUAL") = Math.Round(totREVPAR, 2, MidpointRounding.AwayFromZero)
                        row("REVPAR_MENSUAL") = Math.Round((habitaciones_ocupadas_mes * row("ADR_MENSUAL")) / (npec * total_habitaciones), 2, MidpointRounding.AwayFromZero)
                        istads.Tables("PRECIOS").Rows.Add(row)
                    Next


                    row = istads.Tables("PERSONAL_OCUPADO").NewRow    'crear  PERSONAL_OCUPADO
                    row("ENCUESTA_ID") = encuesta_id
                    row("PERSONAL_NO_REMUNERADO") = 0
                    row("PERSONAL_REMUNERADO_FIJO") = 0
                    row("PERSONAL_REMUNERADO_EVENTUAL") = 0
                    If dsenvios.Tables(0).Rows.Count > 0 Then
                        row("PERSONAL_NO_REMUNERADO") = dsenvios.Tables(0).Rows(0)("PERSONAL_NO_REMUNERADO")
                        row("PERSONAL_REMUNERADO_FIJO") = dsenvios.Tables(0).Rows(0)("PERSONAL_REMUNERADO_FIJO")
                        row("PERSONAL_REMUNERADO_EVENTUAL") = dsenvios.Tables(0).Rows(0)("PERSONAL_REMUNERADO_EVENTUAL")

                    End If
                    istads.Tables("PERSONAL_OCUPADO").Rows.Add(row)
                Next
            Catch ex As Exception
                istads.Tables.Clear()
            End Try
            'Me.dumpDataTable(row.Table)
            flushConection(cmd, 0)
            Validate("C:\Proyectos Codecharge\ClasesGesHotel_tano\ClasesGesHotel\ine.xsd", New IO.MemoryStream(System.Text.Encoding.ASCII.GetBytes(obtieneXMLdeDataset(istads))))
            Return istads
        End Function

        Public Function obtieneXMLdeDataset(ByVal istads As DataSet) As String
            Dim xml As String = istads.GetXml
            Dim header As String = "<?xml version='1.0' encoding='ISO-8859-1'?>"
            header = header.Replace("'", Chr(34)) ' reemplazamos la comilla simple por la doble que no le gusta el INE
            xml = header + xml.Replace("<NewDataSet>", "").Replace("</NewDataSet>", "")
            '            Return xml
            Dim tmp As New IO.StringWriter
            istads.Tables("ENCUESTA").WriteXml(tmp, False)
            xml = tmp.ToString
            xml = header + xml.Replace("<NewDataSet>", "").Replace("</NewDataSet>", "")
            'cambiar fecha_referencia de sitio
            Dim fech As String = xml.Substring(xml.IndexOf("<FECHA_REFERENCIA>"), "</FECHA_REFERENCIA>".Length + xml.IndexOf("</FECHA_REFERENCIA>") - xml.IndexOf("<FECHA_REFERENCIA>"))
            xml = xml.Remove(xml.IndexOf(fech), fech.Length)
            xml = xml.Insert(xml.IndexOf("<CABECERA>") + "<CABECERA>".Length, fech)
            Return xml
        End Function

        Public Shared mErrorsList As New ArrayList
        Shared Function Validate(ByVal Schema As String, ByVal XMLDoc As IO.Stream) As ArrayList

            Dim objWorkingXML As New System.Xml.XmlDocument
            Dim objValidateXML As System.Xml.XmlValidatingReader
            Dim objSchemasColl As New System.Xml.Schema.XmlSchemaCollection
            mErrorsList.Clear()
            objSchemasColl.Add("", Schema)

            'This loads XML string
            objValidateXML = New System.Xml.XmlValidatingReader(New System.Xml.XmlTextReader(XMLDoc))

            objValidateXML.Schemas.Add(objSchemasColl)

            'This is how you CATCH the errors (with a handler function)
            AddHandler objValidateXML.ValidationEventHandler, AddressOf ValidationCallBack

            'This is WHERE the validation occurs.. WHEN the XML Document READS throughthe validating reader
            Try
                objWorkingXML.Load(objValidateXML)

            Catch ex As Exception
                mErrorsList.Add(ex.Message)
            Finally

                objValidateXML.Close()
            End Try
            Return mErrorsList

        End Function

        Shared Sub ValidationCallBack(ByVal sender As Object, ByVal e As System.Xml.Schema.ValidationEventArgs)
            'mErrorsList.Add(e.Message)
            Console.WriteLine(e.Message)
        End Sub

        Public Function obtieneDatosISTAOld(ByVal hotel_id As Integer, ByVal ano As Integer, ByVal mes As Integer)
            'Dim istads As New DataSet
            'Dim Report As StiReport = New StiReport()
            Dim istads As DataSet = New DataSet("Test")
            istads.ReadXmlSchema("C:\Proyectos Codecharge\ClasesGesHotel_tano\ClasesGesHotel\ista.xsd")
            'crear encuesta
            Dim row As DataRow = istads.Tables("ENCUESTA").Rows.Add()   'crear una encuesta
            'campos a rellenar en row

            row = istads.Tables("CABECERA").Rows.Add()   'crear una encuesta

            Dim cmd As MySqlCommand = prepareConection()
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            Dim ds As DataSet = getDataSet(cmd, sqlISTACabecera)
            ds.DataSetName = "ENCUESTA"
            ds.Tables(0).TableName = "CABECERA"
            getDataSet(cmd, sqlISTAAlojamiento, ds, "ALOJAMIENTO")
            getDataSet(cmd, sqlISTAHabitaciones, ds, "HABITACIONES")
            getDataSet(cmd, sqlISTAPrecios, ds, "PRECIOS")
            getDataSet(cmd, sqlISTAPERSONAL_OCUPADO, ds, "PERSONAL_OCUPADO")
            ds.Tables("ALOJAMIENTO").Rows.Add()
            ds.Tables("HABITACIONES").Rows.Add()
            ds.Tables("PRECIOS").Rows.Add()
            ds.Tables("PERSONAL_OCUPADO").Rows.Add()
            Dim tmp As New IO.StringWriter
            ds.WriteXml(tmp)

            Console.Write(tmp.ToString())
            flushConection(cmd, 0)
            Return 0
        End Function

        Sub pruebaBatch()
            Dim cmd As MySqlCommand = prepareConectionOnlyRead()
            Dim ds As DataSet = getDataSet(cmd, "select reserva_id as reservas_reserva_id,0 as valor from reservas where reserva_id between 18000 and 18100")
            Dim x As Object = Me
            Dim tableIndex As Integer = 0
            flushConection(cmd, 0)
            Dim batch As New BatchTasks
            batch.maxThreads = 0
            Dim tdr As DataRowCollection = ds.Tables(tableIndex).Rows
            Dim ti As Integer
            For ti = 0 To tdr.Count - 1
                Dim param() = {tdr(ti)("reservas_reserva_id"), False}
                batch.addTask(x, "obtieneImporteTotalReserva", ti, param, tdr(ti), "valor")
            Next
            batch.waitForCompletition()

        End Sub
        Function ejecutaSql(ByVal tmp As String) As Object
            Dim cmd As MySqlCommand = prepareConectionOnlyRead()
            Dim res As Object = Me.ExecuteScalar(cmd, tmp)

            flushConection(cmd, 0)
            Return res
        End Function
        Public Function comprueba_paro_ventas(ByVal reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            retorno_valor = comprueba_paro_ventas(cmd, reserva_id)
            flushConection(cmd, 0)
            Return retorno_valor
        End Function
        Private Function comprueba_release(ByVal cmd As MySqlCommand, reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim sql As String = "Select fecha_prevista_llegada,fecha_reserva,hotel_id,cliente_id " _
            & "FROM reservas " _
            & "WHERE reserva_id = ?"
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)

            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            Dim cliente_id As Integer

            Dim hotel_id As Integer

            Dim fecha_reserva As Date
            Dim fecha_llegada As Date
            While reader.Read
                cliente_id = reader.Item("cliente_id")
                fecha_llegada = reader.Item("fecha_prevista_llegada")
                fecha_reserva = reader.Item("fecha_reserva")
                hotel_id = reader.Item("hotel_id")
            End While
            Return comprueba_release(cmd, hotel_id, cliente_id, fecha_reserva, fecha_llegada)
        End Function
        Private Function comprueba_release(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal fecha_reserva As Date, ByVal fecha_llegada As Date) As String
            Dim retorno_valor As String = ""
            Try
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
                Dim fecha_Param As New MySqlParameter("@fecha_reserva", fecha_reserva)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(fecha_Param)
                Dim dias As Integer = DateDiff(DateInterval.Day, fecha_reserva, fecha_llegada)
                Dim sql As String = "SELECT dias FROM releases " _
                & "WHERE hotel_id = ? AND cliente_id = ? AND ? BETWEEN fecha_desde AND fecha_hasta"
                Dim release As Object = ExecuteScalar(cmd, sql)
                If Not IsDBNull(release) Then ' hay release
                    If Not IsNothing(release) Then
                        If dias < release Then  ' Se están saltando el release
                            retorno_valor = "!! ATENCION !! Reserva con fecha menor al Release :"
                            retorno_valor += ", Dias hasta llegada " + CStr(dias) + " release " + CStr(release)
                        End If
                    End If
                End If
            Catch ex As Exception
                retorno_valor = ex.Message + "-fres:" + fecha_reserva + "-flle:" + fecha_llegada
            End Try
            Return retorno_valor
        End Function
        Private Function comprueba_paro_ventas(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal tipo_habitacion_id As Integer, ByVal fecha_desde As Date, ByVal Fecha_hasta As Date) As String
            Dim retorno_valor As String = ""
            Dim sql As String = "SELECT paro_ventas.paro_ventas_id,paro_ventas.desde,paro_ventas.hasta " _
            & "FROM paro_ventas Inner Join lineas_paro_ventas ON lineas_paro_ventas.paro_ventas_id = paro_ventas.paro_ventas_id " _
            & "WHERE paro_ventas.hotel_id = ? " _
            & "AND (paro_ventas.tipo_habitacion_id = ? OR ISNULL(paro_ventas.tipo_habitacion_id)) " _
            & "AND lineas_paro_ventas.cliente_id = ? " _
            & "AND ( ? BETWEEN paro_ventas.desde AND paro_ventas.hasta " _
            & "OR ? BETWEEN paro_ventas.desde AND paro_ventas.hasta ) "

            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim fecha1_Param As New MySqlParameter("@fecha_desde", fecha_desde)
            Dim fecha2_Param As New MySqlParameter("@fecha_hasta", Fecha_hasta)
            Dim fecha3_Param As New MySqlParameter("@fecha_desde", fecha_desde)
            Dim fecha4_Param As New MySqlParameter("@fecha_hasta", Fecha_hasta)
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim tipo_habitacion_idParam As New MySqlParameter("@tipo_habitacion_id", tipo_habitacion_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(tipo_habitacion_idParam)
            cmd.Parameters.Add(cliente_idParam)
            cmd.Parameters.Add(fecha1_Param)
            cmd.Parameters.Add(fecha2_Param)
            'cmd.Parameters.Add(fecha3_Param)
            'cmd.Parameters.Add(fecha4_Param)
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            Dim desde As Date
            Dim hasta As Date
            While reader.Read
                If Not reader.IsDBNull(reader.GetOrdinal("paro_ventas_id")) Then
                    desde = reader.Item("desde")
                    hasta = reader.Item("Hasta")
                    If retorno_valor = "" Then
                        retorno_valor = "!! ATENCION !! Parada de Ventas para este Touroperador:"
                    End If
                    retorno_valor += ", Desde " + CStr(desde) + " Hasta " + CStr(hasta)
                End If
            End While
            Return retorno_valor
        End Function
        Private Function comprueba_paro_ventas(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim sql As String = "Select fecha_prevista_llegada,fecha_prevista_salida,reservas.hotel_id,cliente_id,tipos_habitacion_hotel.tipo_habitacion_id " _
            & "FROM reservas " _
            & "Inner Join reservas_tipo_habitacion ON reservas.reserva_id = reservas_tipo_habitacion.reserva_id " _
            & "Inner Join tipos_habitacion_hotel ON reservas_tipo_habitacion.servicio_id = tipos_habitacion_hotel.servicio_id AND reservas.hotel_id = tipos_habitacion_hotel.hotel_id " _
            & "WHERE reservas.reserva_id = ?"
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)

            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            Dim cliente_id As Integer


            Dim hotel_id As Integer
            Dim tipo_habitacion_id As New Integer
            Dim servicio_id As New MySqlParameter("@servicio_id", 1)
            Dim fecha_desde As Date
            Dim fecha_hasta As Date
            While reader.Read
                cliente_id = reader.Item("cliente_id")
                fecha_desde = reader.Item("fecha_prevista_llegada")
                fecha_hasta = reader.Item("fecha_prevista_salida")
                hotel_id = reader.Item("hotel_id")
                tipo_habitacion_id = reader.Item("tipo_habitacion_id")
            End While
            retorno_valor = comprueba_paro_ventas(cmd, hotel_id, cliente_id, tipo_habitacion_id, fecha_desde, fecha_hasta)
            Return retorno_valor
        End Function
        Public Function dame_cupo(ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal tipo_habitacion_id As Integer, ByVal fecha As Date) As Integer
            Dim retorno_valor As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            retorno_valor = dame_cupo(cmd, hotel_id, cliente_id, tipo_habitacion_id, fecha)
            flushConection(cmd, 0)
            Return retorno_valor
        End Function
        Public Function dame_reservas(ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal tipo_habitacion_id As Integer, ByVal fecha As Date) As Integer
            Dim retorno_valor As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            retorno_valor = dame_reservas(cmd, hotel_id, cliente_id, tipo_habitacion_id, fecha)
            flushConection(cmd, 0)
            Return retorno_valor
        End Function
        Public Function dame_reservas(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal tipo_habitacion_id As Integer, ByVal fecha As Date) As Integer
            Dim retorno_valor As Integer = 0
            Dim sql_servicio_id As String = "SELECT tipos_habitacion_hotel.servicio_id " _
            & "FROM tipos_habitacion_hotel " _
            & "WHERE tipos_habitacion_hotel.hotel_id = ? AND " _
            & "tipos_habitacion_hotel.tipo_habitacion_id = ?"
            Dim sql_cuenta_reservas As String = "SELECT SUM(cantidad) FROM reservas_tipo_habitacion " _
            & "Inner Join reservas ON reservas.reserva_id=reservas_tipo_habitacion.reserva_id " _
            & "Inner Join reservas_contratos ON reservas_contratos.reserva_id = reservas.reserva_id " _
            & "Inner Join contratos ON reservas_contratos.contrato_id = contratos.contrato_id " _
            & "WHERE reservas.hotel_id = ? AND " _
            & "reservas.estado_reserva_id <> 2 AND " _
            & "reservas.fecha_prevista_llegada <= ? AND " _
            & "reservas.fecha_prevista_salida > ? AND " _
            & "(reservas.cliente_id = ? OR contratos.cliente_id_padre = ?) AND " _
            & "reservas_tipo_habitacion.servicio_id = ? "
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim clientePadre_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim hotel_idParam As New MySqlParameter("@hotel_id_id", hotel_id)
            Dim tipo_habitacion_idParam As New MySqlParameter("@tipo_habitacion_id", tipo_habitacion_id)
            Dim fecha1_Param As New MySqlParameter("@fecha_desde", fecha)
            Dim fecha2_Param As New MySqlParameter("@fecha_desde", fecha)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(tipo_habitacion_idParam)
            Try
                Dim servicio_id As Integer = ExecuteScalar(cmd, sql_servicio_id)
                Dim servicio_idParam As New MySqlParameter("@servicio_id", servicio_id)
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fecha1_Param)
                cmd.Parameters.Add(fecha2_Param)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(clientePadre_idParam)
                cmd.Parameters.Add(servicio_idParam)
                Dim reservas As Object = ExecuteScalar(cmd, sql_cuenta_reservas)
                If IsNumeric(reservas) Then
                    retorno_valor = reservas
                End If
            Catch

            End Try
            Return True
        End Function
        Public Function dame_cupo(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal tipo_habitacion_id As Integer, ByVal fecha As Date) As Integer
            Dim retorno_valor As Integer = 0
            Dim sql_cliente As String = "Select Coalesce(cliente_id_padre,cliente_id) As cliente_contrato from contratos where hotel_id = ? And cliente_id = ? And fecha_desde<= ? And fecha_hasta> ?"
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim hotel_idParam As New MySqlParameter("@hotel_id_id", hotel_id)
            Dim tipo_habitacion_idParam As New MySqlParameter("@tipo_habitacion_id", tipo_habitacion_id)
            Dim fecha1_Param As New MySqlParameter("@fecha_desde", fecha)
            Dim fecha2_Param As New MySqlParameter("@fecha_desde", fecha)
            'Dim sql_cupo As String = "SELECT cupo FROM cupos WHERE hotel_id = ? AND cliente_id = ? AND fecha_desde <= ? AND fecha_hasta > ? AND tipo_habitacion_id = ?"
            Dim sql_cupo As String = "SELECT SUM(cupo) FROM cupos WHERE hotel_id = ? AND cliente_id = ? AND fecha_desde <= ? AND fecha_hasta > ? AND tipo_habitacion_id = ?"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(cliente_idParam)
            cmd.Parameters.Add(fecha1_Param)
            cmd.Parameters.Add(fecha2_Param)
            cmd.Parameters.Add(tipo_habitacion_idParam)


            Dim cupo As Object = ExecuteScalar(cmd, sql_cupo)
            If Not IsDBNull(cupo) Then ' hay cupo
                If IsNumeric(cupo) Then
                    retorno_valor = cupo
                End If
            End If
            Return retorno_valor
        End Function

        Public Function comprueba_cupos(ByVal reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            retorno_valor = comprueba_cupos(cmd, reserva_id)
            flushConection(cmd, 0)
            Return retorno_valor
        End Function
        Private Function comprueba_cupos(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByRef tipo_habitacion_id As Integer, ByVal fecha_desde As Date, ByVal Fecha_hasta As Date, ByVal servicio_id As Integer, ByVal cantidad As Integer) As String
            Dim retorno_valor As String = ""
            Dim fecha As Date = fecha_desde
            Dim sql_cliente As String = "Select Coalesce(cliente_id_padre,cliente_id) As cliente_contrato from contratos where hotel_id = ? And cliente_id = ? And fecha_desde<= ? And fecha_hasta> ?"
            Dim sql_cupo As String = "SELECT SUM(cupo) FROM cupos WHERE hotel_id = ? AND cliente_id = ? AND fecha_desde <= ? AND fecha_hasta > ? AND tipo_habitacion_id = ?"
            Dim sql_cuenta_reservas As String = "SELECT SUM(cantidad) FROM reservas_tipo_habitacion " _
            & "Inner Join reservas ON reservas.reserva_id=reservas_tipo_habitacion.reserva_id " _
            & "Inner Join reservas_contratos ON reservas_contratos.reserva_id = reservas.reserva_id " _
            & "Inner Join contratos ON reservas_contratos.contrato_id = contratos.contrato_id " _
            & "WHERE reservas.hotel_id = ? AND " _
            & "reservas.estado_reserva_id <> 2 AND " _
            & "reservas.fecha_prevista_llegada <= ? AND " _
            & "reservas.fecha_prevista_salida > ? AND " _
            & "contratos.cliente_id IN (?,?) AND " _
            & "reservas_tipo_habitacion.servicio_id = ? "
            Dim sql_tipo_habitacion_id As String = "SELECT tipo_habitacion_id FROM tipos_habitacion_hotel WHERE tipos_habitacion_hotel.hotel_id = ? AND tipos_habitacion_hotel.servicio_id = ?"
            Dim cliente_padre_id As New MySqlParameter("@cliente_id", 1)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim hotel_idParam As New MySqlParameter("@hotel_id_id", hotel_id)
            Dim fecha1_Param As New MySqlParameter("@fecha_desde", Now)
            Dim fecha2_Param As New MySqlParameter("@fecha_hasta", Now)
            Dim servicio_idParam As New MySqlParameter("@servicio_id", servicio_id)
            Dim tipo_habitacion_idParam As New MySqlParameter("@tipo_habitacion_id", 0)

            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(servicio_idParam)
            tipo_habitacion_idParam.Value = ExecuteScalar(cmd, sql_tipo_habitacion_id)

            Try
                Dim cupo As Object
                Dim numero_habitaciones As Object
                Dim cliente_padre As Object
                While fecha < Fecha_hasta
                    fecha1_Param.Value = fecha
                    fecha2_Param.Value = fecha
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(hotel_idParam)
                    cmd.Parameters.Add(cliente_idParam)
                    cmd.Parameters.Add(fecha1_Param)
                    cmd.Parameters.Add(fecha2_Param)
                    cliente_padre = ExecuteScalar(cmd, sql_cliente)
                    If IsNumeric(cliente_padre) Then
                        cliente_padre_id.Value = cliente_padre
                    Else
                        cliente_padre_id.Value = cliente_id
                    End If
                    'Una vez que tengo el cliente del contrato con los cupos, miro a ver si hay algún cupo en esa fecha
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(hotel_idParam)
                    cmd.Parameters.Add(cliente_padre_id)
                    cmd.Parameters.Add(fecha1_Param)
                    cmd.Parameters.Add(fecha2_Param)
                    cmd.Parameters.Add(tipo_habitacion_idParam)

                    cupo = ExecuteScalar(cmd, sql_cupo)

                    'retorno_valor += "Tipo_hab=" & tipo_habitacion_id & " Cliente_id=" & cliente_padre_id.Value & " Fecha=" & fecha & " Cupo= " & cupo & " cantidad =" & cantidad & ","

                    If IsNumeric(cupo) Then   ' hay cupo
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(hotel_idParam)
                        cmd.Parameters.Add(fecha1_Param)
                        cmd.Parameters.Add(fecha2_Param)
                        cmd.Parameters.Add(cliente_idParam)
                        cmd.Parameters.Add(cliente_padre_id)
                        cmd.Parameters.Add(servicio_idParam)
                        numero_habitaciones = ExecuteScalar(cmd, sql_cuenta_reservas)
                        If IsNumeric(numero_habitaciones) Then
                            'retorno_valor += "numero_habitaciones = " & numero_habitaciones
                            If numero_habitaciones + cantidad > cupo Then
                                If retorno_valor = "" Then
                                    retorno_valor = "!! ATENCION !! Exceso de cupo los dias:"
                                End If
                                retorno_valor += ", " + CStr(fecha) + " Cupo=" + CStr(cupo) + " Nº Reservadas=" + CStr(numero_habitaciones)
                            End If
                        End If
                    End If

                    fecha = DateAdd(DateInterval.Day, 1, fecha)
                End While
            Catch E As Exception
                retorno_valor = "!!! Oh cielos que ERROR !!! " & E.Message
            End Try
            Return retorno_valor
        End Function
        Private Function comprueba_cupos(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim sql As String = "Select fecha_prevista_llegada,fecha_prevista_salida,reservas.hotel_id,cliente_id,tipos_habitacion_hotel.tipo_habitacion_id,reservas_tipo_habitacion.servicio_id,reservas_tipo_habitacion.cantidad " _
            & "FROM reservas " _
            & "Inner Join reservas_tipo_habitacion ON reservas.reserva_id = reservas_tipo_habitacion.reserva_id " _
            & "Inner Join tipos_habitacion_hotel ON reservas_tipo_habitacion.servicio_id = tipos_habitacion_hotel.servicio_id AND reservas.hotel_id = tipos_habitacion_hotel.hotel_id " _
            & "WHERE reservas.reserva_id = ?"
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)

            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            Dim cliente_id As Integer
            Dim hotel_id As Integer
            Dim tipo_habitacion_id As Integer
            Dim servicio_id As Integer
            Dim fecha_desde As Date
            Dim fecha_hasta As Date
            Dim cantidad As Integer
            While reader.Read
                cliente_id = reader.Item("cliente_id")
                fecha_desde = reader.Item("fecha_prevista_llegada")
                fecha_hasta = reader.Item("fecha_prevista_salida")
                hotel_id = reader.Item("hotel_id")
                tipo_habitacion_id = reader.Item("tipo_habitacion_id")
                servicio_id = reader.Item("servicio_id")
                cantidad = reader.Item("cantidad")
            End While
            retorno_valor = comprueba_cupos(cmd, hotel_id, cliente_id, tipo_habitacion_id, fecha_desde, fecha_hasta, servicio_id, 0)
            Return retorno_valor
        End Function
        Private Function comprueba_reserva_dingus(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim aux As String = ""
            retorno_valor = comprueba_cupos(cmd, reserva_id)
            aux = comprueba_paro_ventas(cmd, reserva_id)
            If aux <> "" Then
                If retorno_valor <> "" Then
                    retorno_valor += ","
                End If
                retorno_valor += aux
            End If
            aux = comprueba_release(cmd, reserva_id)
            Return retorno_valor
        End Function
        Private Function comprueba_reserva_dingus(ByVal reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            retorno_valor = comprueba_reserva_dingus(cmd, reserva_id)
            flushConection(cmd, 0)
            Return retorno_valor
        End Function
        Function comprueba_bono(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal bono As String) As String
            Dim retorno_valor As String = ""
            ' Si hay alguna reserva no anulada con el mismo bono y mismo cliente, da los toques
            Dim sql As String = "SELECT reserva_id FROM reservas " _
            & "WHERE estado_reserva_id<>'2' AND bono_referencia = ? AND hotel_id = ? AND cliente_id = ?"
            Dim BonoParam As New MySqlParameter("@bono_referencia", bono)
            Dim Hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim Cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(BonoParam)
            cmd.Parameters.Add(Hotel_idParam)
            cmd.Parameters.Add(Cliente_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            Dim reserva_id As Integer
            Dim contador As Integer = 0
            While reader.Read
                reserva_id = reader.Item("reserva_id")
                If retorno_valor = "" Then
                    retorno_valor = "!! ATENCION !! Ya hay otras reservas de este cliente con el mismo BONO:"
                    retorno_valor += ", Reserva " + CStr(reserva_id) + " con Bono " + bono
                End If
                contador += 1
            End While
            If contador > 1 Then
                retorno_valor += ", Nº Reservas con Bono " + bono + " = " + CStr(contador)
            End If
            Return retorno_valor
        End Function
        Function reserva_check(ByVal cmd As MySqlCommand, ByRef reserva As MetaReserva) As String
            Dim retorno_valor As String = ""
            Try
                Dim aux As String = ""
                ' Check Fecha Salida sea mayor que fecha Llegada
                If reserva.fecha_reserva > FechaHotel(cmd, reserva.hotel_id) Then
                    If reserva.errores <> "" Then
                        reserva.errores += ","
                    End If
                    reserva.errores = "!! ATENCION !! Error de fecha:"
                    reserva.errores += ", Fecha Reserva " + CStr(reserva.fecha_reserva) + " es posterior a la fecha de hoy"
                End If
                If reserva.fecha_prevista_salida <= reserva.fecha_prevista_llegada Then
                    If reserva.errores <> "" Then
                        reserva.errores += ","
                    End If
                    reserva.errores = "!! ATENCION !! Error de fechas:"
                    reserva.errores += ", Fecha Salida " + CStr(reserva.fecha_prevista_salida) + " ha de ser mayor que fecha de Llegada " + CStr(reserva.fecha_prevista_llegada)
                End If
                ' Check de que no puedan poner reservas con llegada anterior a la fecha de hoy

                If reserva.fecha_prevista_llegada < FechaHotel(cmd, reserva.hotel_id) Then
                    If reserva.errores <> "" Then
                        reserva.errores += ","
                    End If
                    reserva.errores += "!! ATENCION !! Error de fechas:"
                    reserva.errores += ", Fecha Llegada " + CStr(reserva.fecha_prevista_llegada) + " es anterior a la fecha de hoy"
                End If
                ' Check Warning de que no sobrepase el cupo
                'retorno_valor = "habitacion_id " & reserva.habitacion & " fecha_llegada=" & reserva.fecha_prevista_llegada & " Salida=" & reserva.fecha_prevista_salida & ","
                'retorno_valor += "Servicio_id=" & reserva.habitacion_servicio_id & " num_hab=" & reserva.numero_habitaciones
                aux = comprueba_cupos(cmd, reserva.hotel_id, reserva.cliente_id, reserva.habitacion, reserva.fecha_prevista_llegada, reserva.fecha_prevista_salida, reserva.habitacion_servicio_id, reserva.numero_habitaciones)
                If aux <> "" Then
                    reserva.cupos = aux
                    If retorno_valor <> "" Then
                        retorno_valor += ","
                    End If
                    retorno_valor += aux
                End If
                ' Check Warning de que no haya reserva duplicada con el mismo bono y touroperador
                aux = comprueba_bono(cmd, reserva.hotel_id, reserva.cliente_id, reserva.bono_referencia)
                If aux <> "" Then
                    If retorno_valor <> "" Then
                        retorno_valor += ","
                    End If
                    retorno_valor += aux
                End If
                ' Check Warning de que no haya paro de ventas
                aux = comprueba_paro_ventas(cmd, reserva.hotel_id, reserva.cliente_id, reserva.habitacion_id, reserva.fecha_prevista_llegada, reserva.fecha_prevista_salida)
                If aux <> "" Then
                    reserva.paro_ventas = True
                End If
                If aux <> "" Then
                    If retorno_valor <> "" Then
                        retorno_valor += ","
                    End If
                    retorno_valor += aux
                End If
                ' Check de que no sobrepase el release
                aux = comprueba_release(cmd, reserva.hotel_id, reserva.cliente_id, reserva.fecha_reserva, reserva.fecha_prevista_llegada)
                If aux <> "" Then
                    reserva.release = True
                    If retorno_valor <> "" Then
                        retorno_valor += ","
                    End If
                    retorno_valor += aux
                End If
            Catch ex As Exception
                If reserva.errores <> "" Then
                    reserva.errores += ","
                End If
                reserva.errores += ex.Message
            End Try
            Return retorno_valor

        End Function
        Function reserva_check(ByRef reserva As MetaReserva) As String
            Dim retorno_valor As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            retorno_valor = reserva_check(cmd, reserva)
            flushConection(cmd, 0)
            Return retorno_valor
        End Function
        Function reserva_check(ByVal reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            Dim sql As String = "Select fecha_prevista_llegada,fecha_prevista_salida,reservas.hotel_id,cliente_id,tipos_habitacion_hotel.tipo_habitacion_id,reservas_tipo_habitacion.servicio_id,bono_referencia,reservas_tipo_habitacion.cantidad " _
            & "FROM reservas " _
            & "Inner Join reservas_tipo_habitacion ON reservas.reserva_id = reservas_tipo_habitacion.reserva_id " _
            & "Inner Join tipos_habitacion_hotel ON reservas_tipo_habitacion.servicio_id = tipos_habitacion_hotel.servicio_id AND reservas.hotel_id = tipos_habitacion_hotel.hotel_id " _
            & "WHERE reservas.reserva_id = ?"
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)

            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            Dim cliente_id As Integer
            Dim hotel_id As Integer
            Dim tipo_habitacion_id As Integer
            Dim servicio_id As Integer
            Dim fecha_desde As Date
            Dim fecha_hasta As Date
            Dim bono As String = ""
            Dim num_hab As Integer
            While reader.Read
                cliente_id = reader.Item("cliente_id")
                fecha_desde = reader.Item("fecha_prevista_llegada")
                fecha_hasta = reader.Item("fecha_prevista_salida")
                hotel_id = reader.Item("hotel_id")
                tipo_habitacion_id = reader.Item("tipo_habitacion_id")
                servicio_id = reader.Item("servicio_id")
                bono = reader.Item("Bono_referencia")
                num_hab = reader.Item("cantidad")
            End While
            Dim reserva As New MetaReserva
            reserva.hotel_id = hotel_id
            reserva.cliente_id = cliente_id
            reserva.habitacion_id = tipo_habitacion_id
            reserva.fecha_prevista_llegada = fecha_desde
            reserva.fecha_prevista_salida = fecha_hasta
            reserva.habitacion_servicio_id = servicio_id
            reserva.bono_referencia = bono
            reserva.numero_habitaciones = 0

            retorno_valor = reserva_check(cmd, reserva)
            flushConection(cmd, 0)
            Return retorno_valor
        End Function

        Function verifyScan()
            Dim sqlfotos = "SELECT clientes.foto1,clientes.foto2 FROM clientes WHERE clientes.foto1 IS NOT NULL OR clientes.foto2 IS not NULL"
            Dim sqlficheros = "SELECT ficheros_reserva.url_fichero FROM ficheros_reserva where ficheros_reserva.url_fichero like '..%'" _
 & " union ALL select ficheros_contrato.url_fichero from ficheros_contrato where ficheros_contrato.url_fichero like '..%' "
            Dim errorCode As Integer = 0
            Dim retVal As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()
            Try
                Dim reader As DataTableReader = getDataTable(cmd, sqlfotos)
                While reader.Read
                    If Not reader.IsDBNull(reader.GetOrdinal("foto1")) Then
                        Console.WriteLine(reader("foto1"))
                        readHtmlPage("http://srvgeshotel/geshotel/" & reader("foto1"))
                    End If
                    If Not reader.IsDBNull(reader.GetOrdinal("foto2")) Then
                        Console.WriteLine(reader("foto1"))
                        readHtmlPage("http://srvgeshotel/geshotel/" & reader("foto2"))
                    End If

                End While
                reader = getDataTable(cmd, sqlficheros)
                While reader.Read
                    If Not reader.IsDBNull(reader.GetOrdinal("url_fichero")) Then
                        Console.WriteLine(reader("url_fichero"))
                        readHtmlPage("http://srvgeshotel/geshotel/" & reader("url_fichero"))
                    End If
                End While

            Catch ex As Exception
                errorCode = 2
            End Try

            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return retVal
        End Function

        Private Function ConcatenarCampo(ByVal reader As DataTableReader, ByVal campo As String, ByVal defecto As String) As String
            If reader.Read Then
                Dim NewStringBuilder As New System.Text.StringBuilder
                NewStringBuilder.Append(reader.Item(campo))
                While reader.Read
                    NewStringBuilder.Append(",")
                    NewStringBuilder.Append(reader.Item(campo))
                End While
                Return NewStringBuilder.ToString
            Else
                Return defecto
            End If
        End Function
        Shared sqlExisteReservaDingus = "select reserva_id from reservas where not reserva_dingus is null and bono_referencia=? limit 0,1"
        Shared sqlExisteReservaDingusEnGeshotel = "select reserva_id from reservas where reserva_dingus is null and bono_referencia=? and hotel_id=? and reservas.estado_reserva_id<>2 limit 0,1"
        Shared sqlDatosDingusHotel = "select email_reservas,dingus_url,dingus_usuario,dingus_password,dingus_hotel_code,dingus_traductor from hoteles where hotel_id=?"
        Shared sqlTipoClienteDingus = "SELECT clientes_hotel.precio_dingus,clientes_hotel.impuestos_incluidos,clientes_hotel.comision,clientes.razon " _
                                      & "FROM clientes_hotel Inner Join clientes ON clientes_hotel.cliente_id = clientes.cliente_id " _
                                      & " WHERE clientes_hotel.cliente_id = ? AND clientes_hotel.hotel_id = ?"

        Public Function ImportarReservasDingus(ByVal hotel_id As Integer) As Integer
            Dim errorCode As Integer = 0
            Dim retVal As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()
            Try
                cmd.Parameters.Clear()
                Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
                cmd.Parameters.Add(hotel_idParam)
                Dim reader As DataTableReader = getDataTable(cmd, sqlDatosDingusHotel, True)
                Dim emailcontrol = "jnunez@grupohd.com"
                While reader.Read
                    Dim BookingService As New Dingus.ConvertedBookingService
                    BookingService.Url = reader("dingus_url")
                    'leer credenciales/datos hotel de la bd
                    Dim usuario As New Dingus.Credentials
                    usuario.UserName = reader("dingus_usuario")
                    usuario.Password = reader("dingus_password")
                    Dim email_reservas As String = reader("email_reservas")
                    'email_reservas = "intexk@hotmail.com"
                    If Not isProduccion Then
                        email_reservas = "javier.nunez.casanovas@gmail.com"
                    End If
                    Dim customerCode As String = "" ' "EMPRESA" 'todos
                    Dim hotelCode As String = reader("dingus_hotel_code") 'hotel_id 
                    Dim key As String = reader("dingus_traductor")

                    Dim reservas As Dingus.GetBookinsRS = BookingService.GetBookings(usuario, customerCode, hotelCode, "2014-01-01", "2099-01-01", key, True)
                    If reservas.Success Then
                        Dim x As Integer
                        Dim procesadas As New Hashtable
                        Dim errores As Integer = 0
                        Dim errorList As New ArrayList
                        Dim msgList As New ArrayList

                        For x = 0 To reservas.Bookins.Length - 1

                            Dim reserva As Dingus.BookingRS = reservas.Bookins(x)
                            'If 1 = 0 Then
                            '    'meter un prepago
                            '    Dim cha As New Dingus.Charge
                            '    cha.ChargeAmount = 15
                            '    cha.ChargeDate = Today
                            '    cha.ChargeID = 1
                            '    cha.ChargePaid = False
                            '    Dim chalist(0) As Dingus.Charge
                            '    chalist(0) = cha
                            '    reserva.Charges = chalist
                            'End If
                            Dim procesada As Boolean = False
                            If Not reserva.Error Then
                                flushConection(cmd, errorCode)
                                cmd = prepareConection()
                                cmd.Parameters.Clear()
                                'If reserva.CustomerCode = 4391 Then
                                '    errorCode = 0
                                'End If

                                Dim pservicios As tablaServicios = Nothing
                                'es cliente dingus para ese hotel
                                hotel_idParam = New MySqlParameter("@hotel_id", hotel_id)
                                Dim cliente_idParam As New MySqlParameter("@reserva_dingus_id", reserva.CustomerCode)
                                cmd.Parameters.Add(cliente_idParam)
                                cmd.Parameters.Add(hotel_idParam)
                                Dim impuestos_incluidos As Integer = 1
                                Dim comision As Decimal = 0D
                                Dim tipoclientedingus As Integer = 0

                                Dim razon As String = ""
                                Dim msgError As String = "localizador dingus:" & reserva.Localizer & "//" & reserva.RoomReference & "- Cliente " & reserva.CustomerCode & " " & razon & " no es dingus."
                                Try
                                    Dim readcli As DataTableReader = getDataTable(cmd, sqlTipoClienteDingus)
                                    While readcli.Read
                                        Try
                                            tipoclientedingus = readcli.Item("precio_dingus")
                                            impuestos_incluidos = readcli.Item("impuestos_incluidos")
                                            comision = readcli.Item("comision")
                                            razon = readcli.Item("razon")
                                        Catch ex As Exception
                                            errorCode = 1
                                        End Try
                                    End While
                                    If reserva.Localizer = "14191788" Then
                                        errorCode = 0
                                    End If
                                Catch ex As Exception
                                    msgError = "localizador dingus:" & reserva.Localizer & "//" & reserva.RoomReference & "- Cliente " & reserva.CustomerCode & " " & razon & " no es dingus. ERROR FATAL"
                                    errorCode = 1
                                End Try
                                If IsNothing(tipoclientedingus) Then
                                    tipoclientedingus = 0
                                End If
                                Dim existeengeshotel As Boolean = False
                                If tipoclientedingus > 0 Then
                                    'es dingus o tiene precio pms

                                    cmd.Parameters.Clear()
                                    Dim reserva_dingus_idgeshotelParam As New MySqlParameter("@reserva_dingus_id", reserva.Localizer)
                                    cmd.Parameters.Add(reserva_dingus_idgeshotelParam)
                                    cmd.Parameters.Add(hotel_idParam)
                                    Dim reserva_idgeshotel As Integer = ExecuteScalar(cmd, sqlExisteReservaDingusEnGeshotel)
                                    If reserva_idgeshotel = 0 Then
                                        existeengeshotel = False
                                    Else
                                        existeengeshotel = True
                                    End If

                                    cmd.Parameters.Clear()
                                    Dim reserva_dingus_idParam As New MySqlParameter("@reserva_dingus_id", reserva.Localizer & "//" & reserva.RoomReference)
                                    cmd.Parameters.Add(reserva_dingus_idParam)
                                    Dim existe As Boolean = True
                                    Dim reserva_id As Integer = ExecuteScalar(cmd, sqlExisteReservaDingus)
                                    If reserva_id = 0 Then
                                        cmd.Parameters.Clear()
                                        reserva_dingus_idParam.Value = reserva.Localizer & "-" & reserva.RoomReference
                                        cmd.Parameters.Add(reserva_dingus_idParam)
                                        reserva_id = ExecuteScalar(cmd, sqlExisteReservaDingus)
                                    End If
                                    Dim estado_anterior As Integer = 0
                                    If reserva_id = 0 Then
                                        existe = False
                                    Else
                                        'si reserva esta en facturado o anulada
                                        'es un error...
                                        cmd.Parameters.Clear()
                                        Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                                        cmd.Parameters.Add(reserva_idParam)
                                        estado_anterior = ExecuteScalar(cmd, sqlEstadoReserva, True)
                                        If IsDBNull(estado_anterior) Then
                                            'pend. finalizar
                                            estado_anterior = 0
                                        End If

                                    End If
                                    msgError = "Error Desconocido Reserva:" & reserva_id & " localizador dingus:" & reserva.Localizer & "//" & reserva.RoomReference & " TTOO :" & reserva.CustomerCode & " " & razon
                                    If Not existeengeshotel Then  ' Si no existe en Geshotel Manualmente
                                        If estado_anterior < 4 And estado_anterior <> 2 Then  'Miramos que no esté  facturada ni anulada
                                            If reserva.Status = Dingus.StatusBookingRS.Rejected And reserva_id = 0 Then
                                                procesada = True
                                            End If
                                            If reserva.Status = Dingus.StatusBookingRS.Rejected And reserva_id <> 0 Then
                                                reserva.Status = Dingus.StatusBookingRS.Cancel
                                            End If
                                            If reserva.Status = Dingus.StatusBookingRS.New Or (reserva.Status = Dingus.StatusBookingRS.Modify And reserva_id = 0) Or (reserva.Status = Dingus.StatusBookingRS.Cancel And reserva_id = 0) Then
                                                'warning si localizador ya existe? o codigo dingus?

                                                If Not existe Then 'Esta es una nueva reserva
                                                    cmd.Parameters.Clear()
                                                    cmd.Parameters.Add(cliente_idParam)
                                                    Dim tmp = ExecuteScalar(cmd, "SELECT dingus_extras FROM clientes WHERE cliente_id = ?")
                                                    If Not IsDBNull(tmp) Then
                                                        ' ---------------------------------------------------------------------
                                                        ' Ñapa TUI Nordic. Leer Comentario e insertarlo en el xml de extras
                                                        ' JN Diciembre 2012. Falta añadir el de TUI-UK
                                                        '----------------------------------------------------------------------
                                                        cargaExtrasdeComentariosDingus(reserva)
                                                    End If

                                                    'se crea una nueva reserva a partir del xml
                                                    Dim metares As New MetaReserva
                                                    'aki para los extras
                                                    metares.reserva_Dingus = reserva
                                                    metares.reserva_Dingus_tipo = tipoclientedingus
                                                    metares.reserva_Dingus_impuestos_incluidos = impuestos_incluidos
                                                    metares.reserva_Dingus_comision = comision
                                                    pservicios = obtieneServiciosReserva(metares, True)
                                                    If Not IsNothing(pservicios) Then
                                                        'se valida la reserva dentro del sistema
                                                        If pservicios.reserva_id <> 0 And pservicios.sumaErrores() = 0 And pservicios.reserva_id <> 0 Then
                                                            procesada = True
                                                            msgList.Add("Reserva Geshotel:" & pservicios.reserva_id & " localizador dingus:" & reserva.Localizer & "//" & reserva.RoomReference & " TTOO :" & reserva.CustomerCode & " " & razon & " .Creada satisfactoriamente.")
                                                            carga_valor_en_reserva(pservicios.reserva_id)
                                                            Dim tarjeta_valida As String = Comprueba_tarjeta(pservicios.reserva_id)
                                                            enviarEmailCreacionReserva(pservicios.reserva_id)
                                                            If tarjeta_valida <> "" Then
                                                                msgList.Add(tarjeta_valida)
                                                            End If
                                                            Dim retorno_cupo As String = comprueba_reserva_dingus(pservicios.reserva_id)
                                                            If retorno_cupo <> "" Then
                                                                Dim words As String() = retorno_cupo.Split(New Char() {","c})
                                                                Dim word As String
                                                                For Each word In words
                                                                    msgList.Add(word)
                                                                Next
                                                            End If
                                                            comprueba_overbooking(cmd, pservicios.reserva_id)
                                                        End If
                                                    End If
                                                Else 'Ya existe en dingus le pongo en estatus modificacion
                                                    reserva.Status = Dingus.StatusBookingRS.Modify
                                                End If
                                            End If
                                            If reserva.Status = Dingus.StatusBookingRS.Modify Then
                                                If reserva_id <> 0 Then  ' Aquí tengo numero de reserva
                                                    '*******************************************************************************************
                                                    ' Primero borro los huespedes de la reserva si estado_anterior es =1 (pendiente de entrar)
                                                    ' GARRA JAVIER JULIO 2012
                                                    ' SEPTIEMBRE 2013 No borro los huespedes si se ha hecho checkin online
                                                    '*******************************************************************************************
                                                    cmd.Parameters.Clear()
                                                    Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
                                                    cmd.Parameters.Add(reserva_idParam)
                                                    Dim online As Object = ExecuteScalar(cmd, "SELECT idioma_id FROM reservas WHERE reserva_id=?", True)
                                                    If estado_anterior = 1 And IsDBNull(online) Then

                                                        Dim num = ExecuteNonQuery(cmd, "DELETE FROM reservas_huespedes Where reserva_id =?")
                                                        flushConection(cmd, errorCode)
                                                        cmd = prepareConection()
                                                        cmd.Parameters.Clear()
                                                    End If

                                                    'se mete el xml dentro de la reserva
                                                    Dim metares As New MetaReserva
                                                    cmd.Parameters.Clear()
                                                    cmd.Parameters.Add(cliente_idParam)
                                                    Dim tmp = ExecuteScalar(cmd, "SELECT dingus_extras FROM clientes WHERE cliente_id = ?")
                                                    If Not IsDBNull(tmp) Then
                                                        ' ---------------------------------------------------------------------
                                                        ' Ñapa TUI Nordic. Leer Comentario e insertarlo en el xml de extras
                                                        ' JN Diciembre 2012. Falta añadir el de TUI-UK
                                                        '----------------------------------------------------------------------
                                                        cargaExtrasdeComentariosDingus(reserva)
                                                    End If
                                                    metares.reserva_Dingus = reserva
                                                    metares.reserva_Dingus_tipo = tipoclientedingus
                                                    metares.reserva_Dingus_impuestos_incluidos = impuestos_incluidos
                                                    metares.reserva_Dingus_comision = comision
                                                    pservicios = obtieneServiciosReserva(metares, True, reserva_id)
                                                    If Not IsNothing(pservicios) Then
                                                        'se valida la reserva dentro del sistema
                                                        If pservicios.reserva_id <> 0 And pservicios.sumaErrores() = 0 Then
                                                            procesada = True
                                                            msgList.Add("Reserva Geshotel:" & pservicios.reserva_id & " localizador dingus:" & reserva.Localizer & "//" & reserva.RoomReference & " TTOO :" & reserva.CustomerCode & " " & razon & " .Modificada satisfactoriamente.")
                                                            carga_valor_en_reserva(pservicios.reserva_id)
                                                            Dim tarjeta_valida As String = Comprueba_tarjeta(pservicios.reserva_id)
                                                            If tarjeta_valida <> "" Then
                                                                msgList.Add(tarjeta_valida)
                                                            End If
                                                        End If
                                                    End If
                                                End If
                                            End If
                                            If reserva.Status = Dingus.StatusBookingRS.Cancel Then
                                                'se busca la reserva
                                                'se mete el xml dentro de la reserva
                                                'se anula la reserva.
                                                If reserva_id <> 0 Then
                                                    'se mete el xml dentro de la reserva
                                                    Dim metares As New MetaReserva
                                                    metares.reserva_Dingus = reserva
                                                    metares.reserva_Dingus_tipo = tipoclientedingus
                                                    metares.reserva_Dingus_impuestos_incluidos = impuestos_incluidos
                                                    metares.reserva_Dingus_comision = comision
                                                    If tipoclientedingus = 2 Then
                                                        errorCode = CambiarEstadoReserva(reserva_id, 2, False)
                                                    Else
                                                        pservicios = obtieneServiciosReserva(metares, True, reserva_id)
                                                    End If

                                                    If Not IsNothing(pservicios) Or tipoclientedingus = 2 Then
                                                        'se valida la reserva dentro del sistema
                                                        If tipoclientedingus = 2 OrElse (pservicios.sumaErrores() = 0 And pservicios.reserva_id <> 0) Then
                                                            procesada = True
                                                            msgList.Add("Reserva Geshotel:" & reserva_id & " localizador dingus:" & reserva.Localizer & "//" & reserva.RoomReference & " " & razon & " .Anulada satisfactoriamente.")
                                                            carga_valor_en_reserva(reserva_id)
                                                        End If
                                                    End If
                                                End If
                                            End If
                                        Else
                                            msgList.Add("Reserva " & reserva_id & " con localizador dingus:" & reserva.Localizer & "//" & reserva.RoomReference & " " & razon & " esta anulada o facturada y no se puede cargar de dingus.")
                                            existeengeshotel = True
                                            procesada = True
                                        End If
                                    Else
                                        msgList.Add("Reserva localizador dingus:" & reserva.Localizer & "//" & reserva.RoomReference & " ya estaba introducida manualmente en geshotel, Reserva " & reserva_idgeshotel)
                                        procesada = True
                                    End If
                                End If

                                If procesada Then
                                    'comprobar precios
                                    If Not IsNothing(pservicios) Then
                                        If tipoclientedingus = 2 Or pservicios.sumaImporte() = reserva.TotalPrice Or 1 = 1 Then 'me salto la comprobacion de precios por contractpricedetails
                                            Dim pro As ArrayList
                                            If Not procesadas.ContainsKey(reservas.Bookins(x).CustomerCode) Then
                                                pro = New ArrayList
                                                procesadas(reservas.Bookins(x).CustomerCode) = pro
                                            Else
                                                pro = procesadas(reservas.Bookins(x).CustomerCode)
                                            End If
                                            pro.Add(reserva.Localizer)
                                            customerCode = reservas.Bookins(x).CustomerCode

                                        Else
                                            'no coincide los precios....algo paso
                                            procesada = False
                                        End If

                                    Else
                                        If existeengeshotel And procesada Then
                                            Dim pro As ArrayList
                                            If Not procesadas.ContainsKey(reservas.Bookins(x).CustomerCode) Then
                                                pro = New ArrayList
                                                procesadas(reservas.Bookins(x).CustomerCode) = pro
                                            Else
                                                pro = procesadas(reserva.CustomerCode)
                                            End If
                                            pro.Add(reserva.Localizer)
                                            customerCode = reservas.Bookins(x).CustomerCode
                                        End If
                                    End If
                                End If
                                If Not procesada Then
                                    'todo enviar email con posibles errores
                                    errorList.Add(msgError)
                                    errores = errores + 1
                                End If
                            Else
                                'esta reserva tenia un error...pasar de ella de momento.
                                'enviar email interno para ver si es un problema de conexion.
                                Dim contenido As String = "Imposible Parsear Reserva"
                                errorList.Add(contenido)
                                If 0 = 0 Then
                                    Try
                                        Dim serializer As New XmlSerializer(GetType(Dingus.BookingRS))
                                        Dim stream As System.IO.MemoryStream = New System.IO.MemoryStream()
                                        Dim tem = New System.Xml.XmlTextWriter(stream, System.Text.Encoding.UTF8)
                                        serializer.Serialize(tem, reserva)
                                        contenido = System.Text.Encoding.UTF8.GetString(stream.ToArray())
                                    Catch ex As Exception
                                        errorCode = 1
                                    End Try
                                    Try
                                        enviarEmailError(emailcontrol, "Reserva Dingus Erronea Hotel:" & hotel_id, contenido)
                                    Catch ex As Exception
                                        errorCode = 1
                                    End Try
                                End If

                            End If
                            '' Ñapa para eliminar de dingus la que van bien
                            '' Quitarrrrrr
                            'Dim syncro As Dingus.SyncroRS = Nothing
                            'customerCode = reservas.Bookins(x).CustomerCode

                            'Dim listaprocesadas() As String = procesadas(customerCode).ToArray(GetType(String))
                            'Dim tsyncro As New Dingus.SyncroRS
                            'tsyncro.Success = True
                            ''If ConnectionString = "DSN=geshotel" Or customerCode = 23746 Then
                            'If ConnectionString = "DSN=geshotel" Then
                            '    tsyncro = BookingService.MarkBookingsAsReceived(usuario, customerCode, hotelCode, listaprocesadas, key)
                            'End If
                            'If Not tsyncro.Success Then
                            '    syncro = tsyncro
                            'Else
                            '    If IsNothing(syncro) Then
                            '        syncro = tsyncro
                            '    End If
                            'End If

                        Next
                        If procesadas.Count > 0 Then
                            'todo mandar email...procesadas y con algun tipo de error
                            Dim syncro As Dingus.SyncroRS = Nothing
                            For Each customerCode In procesadas.Keys
                                Dim listaprocesadas() As String = procesadas(customerCode).ToArray(GetType(String))
                                Dim tsyncro As New Dingus.SyncroRS
                                tsyncro.Success = True
                                'If ConnectionString = "DSN=geshotel" Or customerCode = 23746 Then
                                If isProduccion Then
                                    tsyncro = BookingService.MarkBookingsAsReceived(usuario, customerCode, hotelCode, listaprocesadas, key)
                                End If
                                If Not tsyncro.Success Then
                                    syncro = tsyncro
                                Else
                                    If IsNothing(syncro) Then
                                        syncro = tsyncro
                                    End If
                                End If
                            Next
                            If Not syncro.Success Then
                                errorCode = -3 'no puedo desmarcar las reservas
                            End If
                            Dim contenido As String = "Resumen Importaciones de Dingus:" & Date.Today.ToLongDateString & "<br>"
                            For Each str As String In msgList
                                contenido += str & "<br>"
                            Next
                            enviarEmailError(email_reservas & "," & emailcontrol, "Reserva(s) Dingus Importada(s) Hotel:" & hotel_id, contenido, True)
                        End If
                        If errorList.Count > 0 Then
                            Dim contenido As String = "Errores Importacion Dingus:" & Date.Today.ToLongDateString & "<br>"
                            For Each str As String In errorList
                                contenido += str & "<br>"
                            Next

                            enviarEmailError(email_reservas & "," & emailcontrol, "Reserva(s) Dingus Erronea(s) Hotel:" & hotel_id, contenido, True)
                        End If
                    Else
                        errorCode = -1 'no puedo contactar con servicio dingus
                    End If
                End While
            Catch ex As Exception
                errorCode = -2 'excepcion grave
            End Try
            If Not flushConection(cmd, errorCode) Then
                retVal = False
            End If
            Return True
        End Function

        Private Function getDingusHuespedes(ByVal cmd As MySqlCommand, ByVal reserva_Dingus As Dingus.BookingRS, ByVal unidades_calculos As DataTable, ByVal dni As String, ByVal telefono As String, ByVal email As String, ByVal cliente_id As Integer)
            Dim hues As New ArrayList()
            Dim unid As New Hashtable
            Dim x As Integer
            Dim paxes() As Dingus.Pax = reserva_Dingus.Paxes
            '--------------------------------------------------------------------------------------------
            ' Saco empresa_id del hotel_id. En la versión de Tano estaba empresa_id a 1 a piñon
            ' GARRA JAVIER JULIO 2012 
            ' Es necesario para poder obtener contrato_id ya que allí están parametrizadas las edades
            '--------------------------------------------------------------------------------------------
            Dim hotel_id As Integer = reserva_Dingus.HotelCode
            Dim sql_empresa As String = "Select empresa_id From hoteles where hotel_id =?"
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            ' Dim cliente_id = convertirCamposDingus(reserva_Dingus.CustomerCode, "CustomerCode")
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            Dim empresa_id As Integer = ExecuteScalar(cmd, sql_empresa, True)
            '---------------------------------------------------------------------
            ' GARRA JAVIER JULIO 2012                                             '
            ' Necesito el contrato_id para el tema de los N1 o N2        '
            '--------------------------------------------------------------------

            Dim sql_contrato_id = "SELECT MAX(contrato_id) FROM contratos Where hotel_id =? AND cliente_id = ? AND ? Between fecha_desde AND fecha_hasta"
            Dim contrato_id As Integer = 0

            Dim fechaParam As New MySqlParameter("@fecha", reserva_Dingus.DateFrom)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Try
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(fechaParam)
                contrato_id = ExecuteScalar(cmd, sql_contrato_id, True)
            Catch ex As Exception

            End Try

            Dim sql_edades As String = "SELECT tipos_huesped.tipo_huesped_id, tipos_huesped.Desc_corta,tipos_huesped.uc_id FROM tipos_huesped " _
            & " WHERE tipos_huesped.tipo_huesped_id = " _
            & " (SELECT Coalesce(contratos_edades.tipo_huesped_id,hoteles_edades.tipo_huesped_id) AS tipo_huesped_id " _
            & " FROM hoteles_edades " _
            & "Left Join contratos On contratos.hotel_id=hoteles_edades.hotel_id And contratos.contrato_id =? " _
            & "Left Join contratos_edades ON contratos.contrato_id = contratos_edades.contrato_id " _
            & "WHERE hoteles_edades.hotel_id = ? AND " _
            & "? BETWEEN Coalesce(contratos_edades.edad_minima,hoteles_edades.edad_minima) AND Coalesce(contratos_edades.edad_maxima,hoteles_edades.edad_maxima)LIMIT 0,1)"

            Dim contrato_idParam As New MySqlParameter("@contrato_id", contrato_id)
            Dim edadParam As New MySqlParameter("@edad_minima", 0)
            ' --------------------------------------------
            ' FIN GARRA JAVIER JULIO 2012
            ' --------------------------------------------
            For x = 0 To paxes.Length - 1
                Dim huesped As New MetaHuesped

                huesped.empresa_id = empresa_id
                huesped.razon = paxes(x).PaxName
                'paxes(x).PaxTypeCode = 0 'edad o tipo?
                Dim tipounidadcalculo = ""
                Dim tipo_huesped_id As Integer = 0

                ' -------------------------------------------------------------------------
                ' GARRA JAVIER JULIO 2012
                ' Determinar el tipo segun la edad si no viene codificado
                ' O los tipo Niños que en dingus no vienen separados en N1 y N2
                ' --------------------------------------------------------------------------
                Select Case paxes(x).PaxType
                    Case Dingus.PaxType.ADT ' Adulto no pregunto edad
                        tipounidadcalculo = "A"
                        tipo_huesped_id = 1
                    Case Dingus.PaxType.ENF ' Bebe paso de la edad
                        tipounidadcalculo = "B"
                        tipo_huesped_id = 4
                    Case Dingus.PaxType.CHD ' Niños hay que preguntar la edad para saber si es N1 o N2
                        tipounidadcalculo = "N1"  ' Por defecto es N1 en caso de que no venga edad Cambiar?
                        tipo_huesped_id = 2
                        If paxes(x).PaxAge > 0 Then
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(contrato_idParam)
                            cmd.Parameters.Add(hotel_idParam)
                            edadParam.Value = paxes(x).PaxAge
                            cmd.Parameters.Add(edadParam)
                            Dim reader As DataTableReader = getDataTable(cmd, sql_edades, True)
                            While reader.Read
                                tipounidadcalculo = reader.Item("Desc_corta")
                                tipo_huesped_id = reader.Item("tipo_huesped_id")
                            End While
                        End If
                End Select
                ' -------------------------------------------------------------------------
                ' FIN GARRA JAVIER JULIO 2012
                ' -------------------------------------------------------------------------
                'todo obtener codigo unidad_calculo_id
                huesped.tipo_huesped_id = tipo_huesped_id
                huesped.nif = dni
                huesped.email = email
                huesped.telefono = telefono
                dni = ""    'solo para el primero
                email = ""
                telefono = ""
                Dim rowuc() = unidades_calculos.Select("UC='" & tipounidadcalculo & "'")
                Dim uc As UCS
                If rowuc.Length > 0 Then
                    uc = unid(rowuc(0)("unidad_calculo_id"))

                    If IsNothing(uc) Then
                        uc = New UCS
                        unid(rowuc(0)("unidad_calculo_id")) = uc
                        uc.unidad_calculo_id = rowuc(0)("unidad_calculo_id")
                    End If
                    If reserva_Dingus.Status = Dingus.StatusBookingRS.Cancel Then
                        uc.cantidad = 0
                    Else
                        uc.cantidad += 1
                    End If

                    hues.Add(huesped)
                End If
            Next
            'eliminar duplicados de huespedes.A peticion Javier Nuñez 28-03-12
            Dim huessal As New Hashtable
            For x = 0 To hues.Count - 1
                If Not huessal.ContainsKey(hues(x).razon) Then
                    huessal.Add(hues(x).razon, hues(x))
                End If
            Next
            hues = New ArrayList
            hues.InsertRange(0, huessal.Values)


            'hasta aki
            Dim retval(1) As Object
            retval(0) = hues
            retval(1) = unid
            Return retval
        End Function
        Shared sql_inserta_descuento As String = "INSERT INTO reservas_descuentos (reserva_id,servicio_id,tipo_descuento_id,descuento,user_id,fecha_modificacion,tipo) " _
            & " VALUES (?,?,?,?,1,now(),'A')"
        Shared borra_descuento = "Delete reservas_descuentos Where reserva_id = ? And servicio_id = ?"
        Function crea_descuento_en_reserva(ByVal cmd As MySqlCommand, ByVal ds As DataSet) As Integer
            Dim errorCode As Integer = 0
            ' Primero tengo que mirar si para ese cliente y las fechas de la reserva, tenemos descuento
            ' Borro todos los descuentos automaticos
            Dim xx As Integer
            For xx = 0 To ds.Tables("reservas_descuentos").Rows.Count - 1
                If ds.Tables("reservas_descuentos").Rows(xx)("tipo") = "A" Then
                    ds.Tables("reservas_descuentos").Rows(xx).Delete()
                End If
            Next
            Try
                Dim sql_hay_descuento As String = "SELECT servicio_id, tipo_descuento_id, descuento " _
                & "FROM descuentos WHERE hotel_id = ? AND cliente_id = ? AND ? BETWEEN desde AND hasta ORDER BY servicio_id, tipo_descuento_id"
                Dim cliente_idParam As New MySqlParameter("@cliente_id", 0)
                Dim hotel_idParam As New MySqlParameter("@hotel_id", 0)
                Dim desdeParam As New MySqlParameter("@desde", Now)
                If ds.Tables("reserva").Rows(0).IsNull("cliente_id_factura") Then
                    If ds.Tables("reserva").Rows(0).IsNull("cliente_id") Then
                        Return 0
                    End If
                    cliente_idParam.Value = ds.Tables("reserva").Rows(0).Item("cliente_id")
                End If
                hotel_idParam.Value = ds.Tables("reserva").Rows(0).Item("hotel_id")
                desdeParam.Value = ds.Tables("reserva").Rows(0).Item("fecha_prevista_llegada")
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(desdeParam)
                Dim Reader As DataTableReader = getDataTable(cmd, sql_hay_descuento)
                Dim row As DataRow
                While Reader.Read  ' Si no entra es que no hay descuentos
                    Dim dfrows() As DataRow = ds.Tables("reservas_descuentos").Select("(tipo='M' or tipo='A') and servicio_id=" & Reader.Item("servicio_id") & "and tipo_descuento_id=" & Reader.Item("tipo_descuento_id"))
                    If dfrows.Length = 0 Then


                        row = ds.Tables("reservas_descuentos").Rows.Add()
                        row.Item("servicio_id") = Reader.Item("servicio_id")
                        row.Item("tipo_descuento_id") = Reader.Item("tipo_descuento_id")
                        row.Item("descuento") = Reader.Item("descuento")
                        row.Item("tipo") = "A"
                        row.Item("reserva_id") = ds.Tables("reserva").Rows(0).Item("reserva_id")
                        row.Item("user_id") = Me.userId
                        row.Item("fecha_modificacion") = Now
                    End If
                End While
            Catch ex As Exception

            End Try
            Return True
        End Function
        Function crea_descuento_en_reserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As Integer
            Dim errorCode As Integer = 0
            ' Primero tengo que mirar si para ese cliente y las fechas de la reserva, tenemos descuento
            Dim sql_hay_descuento As String = "SELECT servicio_id, tipo_descuento_id, descuento " _
            & "FROM descuentos WHERE hotel_id = ? AND cliente_id = ? AND ? BETWEEN desde AND hasta"
            Dim sql_reserva As String = "SELECT Coalesce(cliente_id_factura,cliente_id)As cliente_id, hotel_id, fecha_prevista_llegada " _
            & "FROM reservas WHERE reservas.reserva_id = ? "
            Dim sql_dto_reserva As String = "SELECT descuento " _
            & "FROM reservas_descuentos " _
            & "WHERE reserva_id = ? AND servicio_id = ? AND tipo_descuento_id = ? "
            Dim cliente_idParam As New MySqlParameter("@cliente_id", 0)
            Dim servicio_idParam As New MySqlParameter("@servicio_id", 0)
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            Dim tipo_descuento_idParam As New MySqlParameter("@tipo_descuento_id", 0)
            Dim descuentoParam As New MySqlParameter("@descuento", 0)
            Dim hotel_idParam As New MySqlParameter("@hotel_id", 0)
            Dim desdeParam As New MySqlParameter("@desde", Now)
            Dim hastaParam As New MySqlParameter("@desde", Now)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Dim Reader As DataTableReader = getDataTable(cmd, sql_reserva)
            While Reader.Read
                cliente_idParam.Value = Reader.Item("cliente_id")
                hotel_idParam.Value = Reader.Item("hotel_id")
                desdeParam.Value = Reader.Item("fecha_prevista_llegada")
            End While
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(cliente_idParam)
            cmd.Parameters.Add(desdeParam)
            Reader = getDataTable(cmd, sql_hay_descuento)
            While Reader.Read  ' Si no entra es que no hay descuentos
                servicio_idParam.Value = Reader.Item("servicio_id")
                tipo_descuento_idParam.Value = Reader.Item("tipo_descuento_id")
                descuentoParam.Value = Reader.Item("descuento")
                ' Tenemos todos los valores y entonces tendremos que comprobar si el descuento ya está aplicado, no hacemos nada y sino, borramos el posible habido y ponemos el nuevo
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                cmd.Parameters.Add(servicio_idParam)
                cmd.Parameters.Add(tipo_descuento_idParam)
                Dim descuento As Object = ExecuteScalar(cmd, sql_dto_reserva)
                Dim insertar As Boolean = False
                If IsDBNull(descuento) Then
                    insertar = True
                Else
                    If descuentoParam.Value <> descuento Then ' Si el descuento es distinto borro e inserto
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(reserva_idParam)
                        cmd.Parameters.Add(servicio_idParam)
                        errorCode = ExecuteNonQuery(cmd, borra_descuento)
                        insertar = True
                    End If
                End If
                If insertar Then
                    ' Inserto el descuento en la reserva
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(reserva_idParam)
                    cmd.Parameters.Add(servicio_idParam)
                    cmd.Parameters.Add(tipo_descuento_idParam)
                    cmd.Parameters.Add(descuentoParam)
                    errorCode = ExecuteNonQuery(cmd, sql_inserta_descuento)
                    ' Cargo el nuevo valor de la reserva
                    errorCode = carga_valor_en_reserva(cmd, reserva_idParam.Value)
                End If
            End While
            Return errorCode
        End Function
        Public Function crea_descuento_en_reserva(ByVal reserva_id As Integer) As Integer
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            crea_descuento_en_reserva(cmd, reserva_id)
            flushConection(cmd, 0)
            Return 0
        End Function

        Public Function crea_descuento_en_reservas_ttoo(ByVal cliente_id As Integer) As Integer
            Dim errorCode As Integer = 0
            Dim cmd As MySqlCommand = prepareConection()
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim servicio_idParam As New MySqlParameter("@servicio_id", 0)
            Dim reserva_idParam As New MySqlParameter("@reserva_id", 0)
            Dim tipo_descuento_idParam As New MySqlParameter("@tipo_descuento_id", 0)
            Dim descuentoParam As New MySqlParameter("@descuento", 0)
            Dim hotel_idParam As New MySqlParameter("@hotel_id", 0)
            Dim desdeParam As New MySqlParameter("@desde", Now)
            Dim hastaParam As New MySqlParameter("@desde", Now)
            Dim select_reservas As String = "SELECT reservas.reserva_id, reservas_descuentos.descuento FROM reservas " _
            & "Left Join reservas_descuentos ON reservas.reserva_id = reservas_descuentos.reserva_id And reservas_descuentos.servicio_id = ? AND reservas_descuentos.tipo_descuento_id = ? " _
            & "WHERE reservas.hotel_id = ? AND reservas.cliente_id = ? AND reservas.estado_reserva_id IN (1, 3) AND " _
            & "reservas.fecha_prevista_llegada BETWEEN ? AND ? And Coalesce(reservas_descuentos.descuento,0)<> ?  "

            Dim sql_dtos = "Select * From descuentos Where cliente_id = ? And hasta >now()"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(cliente_idParam)
            Dim reader_dtos As DataTableReader = getDataTable(cmd, sql_dtos)

            While reader_dtos.Read
                servicio_idParam.Value = reader_dtos.Item("servicio_id")
                hotel_idParam.Value = reader_dtos.Item("hotel_id")
                tipo_descuento_idParam.Value = reader_dtos.Item("tipo_descuento_id")
                descuentoParam.Value = reader_dtos.Item("descuento")
                desdeParam.Value = reader_dtos.Item("desde")
                hastaParam.Value = reader_dtos.Item("hasta")
                ' Selecciono las reservas que puedan llevar ese descuento
                cmd.Parameters.Clear()
                cmd.Parameters.Add(servicio_idParam)
                cmd.Parameters.Add(tipo_descuento_idParam)
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(cliente_idParam)
                cmd.Parameters.Add(desdeParam)
                cmd.Parameters.Add(hastaParam)
                cmd.Parameters.Add(descuentoParam)
                Dim reader As DataTableReader = getDataTable(cmd, select_reservas)
                Try
                    While reader.Read
                        reserva_idParam.Value = reader.Item("reserva_id")
                        If Not IsDBNull(reader.Item("descuento")) Then ' Borro el descuento anterior
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(reserva_idParam)
                            cmd.Parameters.Add(servicio_idParam)
                            errorCode = ExecuteNonQuery(cmd, borra_descuento)
                        End If
                        ' Inserto el descuento en la reserva
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(reserva_idParam)
                        cmd.Parameters.Add(servicio_idParam)
                        cmd.Parameters.Add(tipo_descuento_idParam)
                        cmd.Parameters.Add(descuentoParam)
                        errorCode = ExecuteNonQuery(cmd, sql_inserta_descuento)
                        ' Cargo el nuevo valor de la reserva
                        'errorCode = carga_valor_en_reserva(cmd, reserva_idParam.Value)
                    End While
                Catch ex As Exception
                End Try
            End While
            flushConection(cmd, 0)
            Return True
        End Function
        Public Function crea_descuento_tui_nordic() As Integer
            Dim errorCode As Integer = 0
            Dim retVal As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()
            Dim sql_dtos = "Select * From descuentos Where hasta >now()"
            Dim sql = "Select reserva_id FROM reservas WHERE reservas.hotel_id = 3 AND reservas.cliente_id = 14744 AND reservas.estado_reserva_id IN (1, 3) "   ' Reservas Tui Nordic hasta 24/04/20012
            Dim sql_check_reserva = "Select SUM(descuento) FROM reservas_descuentos WHERE reserva_id= ? AND servicio_id=177"
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            Dim sql_insert As String = "INSERT INTO reservas_descuentos (reserva_id,servicio_id,tipo_descuento_id,descuento,user_id,fecha_modificacion,tipo) " _
            & " VALUES (?,177,1,1,79,now(),'A')"
            Dim reserva_idParam As New MySqlParameter("@reserva_id", 0)
            While reader.Read
                reserva_idParam.Value = reader.Item("reserva_id")
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                If IsDBNull(ExecuteScalar(cmd, sql_check_reserva)) Then
                    errorCode = ExecuteNonQuery(cmd, sql_insert)
                    If errorCode <> 0 Then
                        errorCode = carga_valor_en_reserva(cmd, reserva_idParam.Value)
                    End If
                End If
            End While
            flushConection(cmd, errorCode)
            Return errorCode
        End Function
        Function carga_valor_en_reserva(ByVal reserva_id As Integer) As Integer
            Dim cmd As MySqlCommand = prepareConection()
            carga_valor_en_reserva(cmd, reserva_id)
            flushConection(cmd, 0)
            Return True
        End Function
        Function carga_valor_en_reserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer, x As tablaServicios) As Integer
            Dim sql_update As String = "Update reservas SET valor=? WHERE reserva_id = ?"
            Dim valor As Double = x.sumaImporte()
            Dim valorParam As New MySqlParameter("@valor", valor)
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(valorParam)
            cmd.Parameters.Add(reserva_idParam)
            Return ExecuteNonQuery(cmd, sql_update)
        End Function
        Function carga_valor_en_reserva(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As Integer
            Dim sql_update As String = "Update reservas SET valor=? WHERE reserva_id = ?"
            Dim valorParam As New MySqlParameter("@valor", 0)
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            valorParam.Value = obtieneImporteTotalReserva(reserva_idParam.Value)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(valorParam)
            cmd.Parameters.Add(reserva_idParam)
            Return ExecuteNonQuery(cmd, sql_update)
        End Function
        Public Function carga_valor_en_reservas(ByVal Hotel_id As Integer) As Integer
            Dim cmd As MySqlCommand = prepareConection()
            Dim errorcode As Integer
            Dim sql As String = "Select reserva_id From reservas Where hotel_id=? And estado_reserva_id=1 and (valor Is Null or valor=0) Limit 5000"
            Dim hotel_idParam As New MySqlParameter("@hotel_id", Hotel_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            Try
                Dim reader As DataTableReader = getDataTable(cmd, sql)
                Dim cont As Integer = 0
                While reader.Read
                    cont += 1
                    errorcode = carga_valor_en_reserva(cmd, reader.Item("reserva_id"))
                    'If errorcode <> 1 Then
                    'flushConection(cmd, 0)
                    'Return 1
                    'End If
                    If cont Mod 100 = 0 Then
                        Console.WriteLine("cargando valor en reservas=" & cont)
                    End If
                End While
            Catch
                flushConection(cmd, 1)
                Return 1
            End Try
            flushConection(cmd, 0)
            Return 0
        End Function

        Function comprueba_cliente_duplicado(ByVal cmd As MySqlCommand, ByRef huesped() As MetaHuesped, ByVal x As Integer, ByVal reserva_id As Integer) As Boolean
            '-----------------------------------------------------------------------------------------------------------------------------
            ' Miro si ya existe un cliente con esos datos. Para ello mirare los campos Razon, Pais, Nº de documento, fecha de nacimiento
            ' Deberian coincidir 3 de ellos. Fecha de nacimiento ha de ser igual o nula, nacion igual, nombre o dni igual
            ' Si coincide entonces pongo el campo
            '-----------------------------------------------------------------------------------------------------------------------------
            Dim cliente_idParam As New MySqlParameter("@cliente_id", huesped(x).cliente_id)
            Dim nifParam As New MySqlParameter("@nif", huesped(x).nif)
            Dim razonParam As New MySqlParameter("@razon", huesped(x).razon)
            Dim fecha_nac As Object = huesped(x).fecha_nacimiento
            Dim cliente2Param As New MySqlParameter("@cliente_id", 1)
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            Dim sql As String = ""
            Dim Reader As DataTableReader
            Dim cliente_id As Integer
            If Trim(huesped(x).razon) = "" Then ' No hay nombre ==> paso del cliente
                Return False
            End If

            If (IsNothing(huesped(x).nif) OrElse nifParam.Value = "") And IsNothing(fecha_nac) Then
                ' Si no hay ni nif ni fecha de nacimiento entonces es otro cliente
                Return False
            End If
            If (IsNothing(huesped(x).nif) OrElse nifParam.Value = "") And IsNothing(fecha_nac) Then
                ' Si es una modificacion de reserva y el cliente está en esta reserva ya, entonces cliente_id ya existe
                sql = "Select reservas_huespedes.cliente_id From reservas_huespedes Inner Join clientes On reservas_huespedes.cliente_id=clientes.cliente_id " _
                & "WHERE reservas_huespedes.reserva_id=? AND clientes.razon=? "
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                cmd.Parameters.Add(razonParam)
                Reader = getDataTable(cmd, sql)
                While Reader.Read
                    If Not IsDBNull(Reader.Item("cliente_id")) Then
                        huesped(x).cliente_id = Reader.Item("cliente_id") ' Este es el cliente_id
                        Return True
                    End If
                End While
                ' Si sale del End While es que no está en la reserva, por lo tanto no encontrado
                Return False
            End If
            sql = "Select cliente_id,razon,nif,fecha_nacimiento,nacion_id from clientes where (razon= ? Or nif= ?) And grupo_cliente_id='5' And cliente_id<> ?"
            cmd.Parameters.Clear()
            cmd.Parameters.Add(razonParam)
            cmd.Parameters.Add(nifParam)
            cmd.Parameters.Add(cliente_idParam)
            Reader = getDataTable(cmd, sql)

            Dim razon As String
            Dim fecha_nacimiento As Object
            Dim Nif As Object
            Dim nacion_id As Object
            Dim encontrado As Boolean = False
            Try
                While Reader.Read And Not encontrado
                    cliente_id = Reader.Item("cliente_id")
                    razon = Reader.Item("razon")
                    fecha_nacimiento = Reader.Item("fecha_nacimiento")
                    nacion_id = Reader.Item("nacion_id")
                    Nif = Reader.Item("Nif")
                    If Not IsDBNull(Nif) Then
                        If Nif = nifParam.Value And StrComp(razon, huesped(x).razon, CompareMethod.Text) = 0 Then
                            encontrado = True
                        ElseIf Nif = nifParam.Value And Not IsDBNull(nacion_id) And nacion_id = huesped(x).nacion_id Then
                            encontrado = True
                        End If

                    End If
                    If Not IsDBNull(fecha_nacimiento) And Not IsDBNull(nacion_id) And Not encontrado Then
                        If fecha_nacimiento = huesped(x).fecha_nacimiento And StrComp(razon, huesped(x).razon, CompareMethod.Text) = 0 And nacion_id = razon = huesped(x).nacion_id Then ' Coincide la nacionalidad, el nombre y la fecha de nacimiento
                            encontrado = True
                        End If
                    End If

                End While
                If encontrado Then   ' !!! EUREKA lo Encontre !!!!
                    ' Considero que en la variable cliente_id tengo al anterior huesped, hago un merge de los campos y borro cliente anterior
                    AgregaInfo("actualizaHuespedesReserva", "Cliente Repetidor:" & cliente_id & " Cliente_id a Borrar es: " & huesped(x).cliente_id, -2)
                    sql = "select * From clientes where cliente_id = ?"
                    cmd.Parameters.Clear()
                    cliente_idParam.Value = cliente_id
                    cmd.Parameters.Add(cliente_idParam)
                    Reader = getDataTable(cmd, sql)
                    While Reader.Read
                        Dim cliente_id_old = huesped(x).cliente_id
                        huesped(x).cliente_id = cliente_id
                        '*****************************************************************************************************************
                        ' Voy campo a campo y si ahora está vacío y tenía datos, los relleno con los de antes.
                        ' En el caso de que ahora tenga un valor, sobreescribirá el anterior
                        '*****************************************************************************************************************

                        If (IsNothing(huesped(x).nif) OrElse huesped(x).nif = "") And Not IsDBNull(Reader.Item("nif")) Then
                            huesped(x).nif = Reader.Item("nif")
                        End If


                        If (IsNothing(huesped(x).poblacion) OrElse huesped(x).poblacion = "") And Not IsDBNull(Reader.Item("poblacion")) Then
                            huesped(x).poblacion = Reader.Item("poblacion")
                        End If
                        If (IsNothing(huesped(x).direccion) OrElse huesped(x).direccion = "") And Not IsDBNull(Reader.Item("direccion")) Then
                            huesped(x).direccion = Reader.Item("direccion")
                        End If
                        If (IsNothing(huesped(x).provincia_id) OrElse huesped(x).provincia_id = 0) And Not IsDBNull(Reader.Item("provincia_id")) Then
                            huesped(x).provincia_id = Reader.Item("provincia_id")
                        End If
                        If (IsNothing(huesped(x).sexo_id) Or huesped(x).sexo_id = "") And Not IsDBNull(Reader.Item("sexo_id")) Then
                            huesped(x).sexo_id = Reader.Item("sexo_id")
                        End If
                        Try
                            If (IsNothing(huesped(x).fecha_documento)) And Not IsDBNull(Reader.Item("fecha_documento")) Then
                                huesped(x).fecha_documento = Reader.Item("fecha_documento")
                            End If
                            If IsNothing(huesped(x).acepta_lopd) And Not IsDBNull(Reader.Item("acepta_lopd")) Then
                                huesped(x).acepta_lopd = Reader.Item("acepta_lopd")
                            End If
                        Catch ex As Exception

                        End Try



                        '**********************************************************
                        ' Una vez hecho el merge, borro el cliente si cliente<>0
                        '**********************************************************
                        Dim errorCode As Integer = 0
                        If cliente_id_old <> 0 Then
                            cliente2Param.Value = cliente_id_old
                            cliente_idParam.Value = cliente_id
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente_idParam)
                            cmd.Parameters.Add(cliente2Param)
                            errorCode = ExecuteNonQuery(cmd, "Update IGNORE reservas_huespedes Set cliente_id = ? Where cliente_id = ?")
                            If errorCode = 0 Then
                                AgregaInfo("actualizaHuespedesReserva", "Update reservas_huespedes mal:" & cliente_id & " Old=" & cliente_id_old, -errorCode)
                                ' Podria ser que el cliente estuviera en la misma reserva y diera error de update
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(cliente2Param)
                                errorCode = ExecuteNonQuery(cmd, "Delete from reservas_huespedes Where cliente_id = ?")
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(cliente_idParam)
                                cmd.Parameters.Add(cliente2Param)
                            End If
                            errorCode = ExecuteNonQuery(cmd, "Update IGNORE facturas set cliente_id = ? Where cliente_id = ?")
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente2Param)
                            errorCode = ExecuteNonQuery(cmd, "Delete From clientes where cliente_id = ?")
                            AgregaInfo("actualizaHuespedesReserva", "Borrado cliente:" & cliente_id_old, -errorCode)
                        End If
                    End While
                    Return True
                End If
            Catch ex As Exception
                AgregaInfo("Comprueba_cliente_duplicado", "excepcion " & ex.Message, 1)
                Return False
            End Try
            Return True
        End Function
        Public Function elimina_clientes_duplicados() As Boolean
            Dim errorCode As Integer = 0
            Dim retVal As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()
            'Dim sql As String = "Select clientes.cliente_id,c.cliente_id As cliente2,clientes.razon As razon, c.razon As razon1,clientes.nif " _
            '& "From clientes, clientes as c " _
            '& "Where clientes.razon=c.razon AND clientes.nif=c.nif AND clientes.grupo_cliente_id=5 AND c.grupo_cliente_id=5 AND clientes.cliente_id<>c.cliente_id And LENGTH(clientes.nif)<>0 LIMIT 0,1"

            Dim sql As String = "Select clientes.cliente_id,c.cliente_id As cliente2,clientes.razon As razon, c.razon As razon1,clientes.nif " _
            & "From clientes, clientes as c " _
            & "Where clientes.razon=c.razon AND clientes.nif=c.nif AND clientes.grupo_cliente_id=5 AND c.grupo_cliente_id=5 AND clientes.cliente_id<>c.cliente_id LIMIT 0,1"

            'Seleccionamos los clientes con igual razon, nif y nacion_id
            'Dim sql As String = "SELECT razon,nif, count(*) As contador FROM clientes WHERE grupo_cliente_id='5' AND nif IS NOT NULL AND nif <> '' group by nif,razon having count(*)>1"
            'Dim sql As String = "SELECT razon,nif, count(*) As contador FROM clientes WHERE grupo_cliente_id='5' group by nif,razon having count(*)>1"
            Dim reader As DataTableReader

            Dim cliente1Param As New MySqlParameter("@cliente_id", 1)
            Dim cliente2Param As New MySqlParameter("@cliente_id", 1)
            Dim nifParam As New MySqlParameter("@nif", "nif")
            Dim razonParam As New MySqlParameter("@razon", "razon")
            Dim sql1 As String = "Update IGNORE reservas_huespedes Set cliente_id = ? Where cliente_id = ?"
            Dim sql2 As String = "Update IGNORE facturas set cliente_id = ? Where cliente_id = ?"
            Dim sql_delete As String = "Delete From clientes where cliente_id = ?"
            Dim sql_delete_2 As String = "Delete from reservas_huespedes Where cliente_id = ?"
            Dim sql_select As String = "Select cliente_id From clientes Where ISNULL(Nif) And razon = ? And grupo_cliente_id='5'"
            Dim cont As Integer = 0
            Dim contador As Integer = 0
            Dim i As Integer

            For cont = 1 To 1000
                reader = getDataTable(cmd, sql)
                Try
                    While reader.Read
                        razonParam.Value = reader.Item("razon")
                        nifParam.Value = reader.Item("nif")
                        i = 0
                        Dim contmal = 0
                        cliente1Param.Value = reader.Item("cliente_id")
                        cliente2Param.Value = reader.Item("cliente2")
                        Console.WriteLine("Eliminando...=" & reader.Item("cliente2"))
                        i += 1
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(cliente1Param)
                        cmd.Parameters.Add(cliente2Param)
                        errorCode = ExecuteNonQuery(cmd, sql1)
                        If errorCode = 0 Then
                            ' Podria ser que el cliente estuviera en la misma reserva y diera error de update

                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente2Param)
                            errorCode = ExecuteNonQuery(cmd, sql_delete_2)
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente1Param)
                            cmd.Parameters.Add(cliente2Param)
                        End If
                        errorCode = ExecuteNonQuery(cmd, sql2)
                        cmd.Parameters.Clear()
                        cmd.Parameters.Add(cliente2Param)
                        errorCode = ExecuteNonQuery(cmd, sql_delete)
                        If errorCode = 0 Then
                            ' Aqui ha pasado algo siniestro y no se ha podido borrar
                            contmal += 1
                        End If
                        cont += 1
                        'Console.WriteLine("Eliminado...=" & cliente2)

                    End While
                    If cont Mod 100 = 0 Then
                        Console.WriteLine("Eliminando...=" & cont)
                    End If
                Catch ex As Exception
                    errorCode = 1
                    Return errorCode
                End Try
            Next
            flushConection(cmd, 0)
            Return retVal
        End Function
        Public Function elimina_clientes_duplicados_paso2() As Boolean
            Dim errorCode As Integer = 0
            Dim retVal As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()

            'Seleccionamos los clientes con igual razon, nif y nacion_id
            Dim sql As String = "SELECT razon,nif, count(*) As contador FROM clientes WHERE grupo_cliente_id='5' AND nif IS NOT NULL AND nif <> '' group by nif,razon having count(*)>1"
            'Dim sql As String = "SELECT razon,nif, count(*) As contador FROM clientes WHERE grupo_cliente_id='5' group by nif,razon having count(*)>1"
            Dim reader As DataTableReader = getDataTable(cmd, sql)
            Dim cliente1Param As New MySqlParameter("@cliente_id", 1)
            Dim cliente2Param As New MySqlParameter("@cliente_id", 1)
            Dim nifParam As New MySqlParameter("@nif", "nif")
            Dim razonParam As New MySqlParameter("@razon", "razon")
            Dim sql1 As String = "Update IGNORE reservas_huespedes Set cliente_id = ? Where cliente_id = ?"
            Dim sql2 As String = "Update IGNORE facturas set cliente_id = ? Where cliente_id = ?"
            Dim sql_delete As String = "Delete From clientes where cliente_id = ?"
            Dim sql_select As String = "Select cliente_id From clientes Where ISNULL(Nif) And razon = ? And grupo_cliente_id='5'"
            Dim cont As Integer = 0

            Dim i As Integer
            Dim contador As Integer
            Dim reader2 As DataTableReader
            Try
                While reader.Read
                    razonParam.Value = reader.Item("razon")
                    nifParam.Value = reader.Item("nif")
                    contador = reader.Item("contador")   ' de todos ellos, el que dejamos es el primero y haremos un merge de los otros campos

                    cmd.Parameters.Clear()
                    'cmd.Parameters.Add(nifParam)
                    cmd.Parameters.Add(razonParam)
                    reader2 = getDataTable(cmd, sql_select)
                    i = 0
                    Dim contmal = 0
                    While reader2.Read
                        i += 1
                        If i = 1 Then
                            cliente1Param.Value = reader2.Item("cliente_id")
                        Else
                            cliente2Param.Value = reader2.Item("cliente_id")
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente1Param)
                            cmd.Parameters.Add(cliente2Param)
                            errorCode = ExecuteNonQuery(cmd, sql1)
                            If errorCode = 0 Then
                                ' Podria ser que el cliente estuviera en la misma reserva y diera error de update
                                sql = "Delete from reservas_huespedes Where cliente_id = ?"
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(cliente2Param)
                                errorCode = ExecuteNonQuery(cmd, sql)
                                cmd.Parameters.Clear()
                                cmd.Parameters.Add(cliente1Param)
                                cmd.Parameters.Add(cliente2Param)
                            End If
                            errorCode = ExecuteNonQuery(cmd, sql2)
                            cmd.Parameters.Clear()
                            cmd.Parameters.Add(cliente2Param)
                            errorCode = ExecuteNonQuery(cmd, sql_delete)
                            If errorCode = 0 Then
                                ' Aqui ha pasado algo siniestro y no se ha podido borrar
                                contmal += 1
                            End If
                        End If
                    End While
                    cont += 1
                    'Console.WriteLine("Eliminado...=" & cliente2)
                    If cont Mod 100 = 0 Then
                        Console.WriteLine("Eliminando...=" & cont)
                    End If
                End While
                ' Ahora me cargo los clientes con descripcion ""
                sql = "select cliente_id FROM clientes where TRIM(razon)='' And clientes.grupo_cliente_id='5'"
                reader = getDataTable(cmd, sql)
                sql1 = "Select count(*)  from facturas where cliente_id = ?"
                sql2 = "Delete From reservas_huespedes where cliente_id = ?"
                While reader.Read
                    cliente1Param.Value = reader.Item("cliente_id")
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(cliente1Param)
                    ' Compruebo que no haya facturas......
                    contador = ExecuteScalar(cmd, sql1)
                    If contador = 0 Then
                        errorCode = ExecuteNonQuery(cmd, sql2)
                        errorCode = ExecuteNonQuery(cmd, sql_delete)
                    End If
                End While
            Catch ex As Exception
                errorCode = 1
                Return errorCode
            End Try
            flushConection(cmd, 0)
            Return retVal
        End Function

        Private Function dame_precio_fijo(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal cliente_id As Integer, ByVal fecha As Date, ByVal servicio_id As Integer, ByVal uc_id As Integer) As Double
            '****************************************************************************************************************************
            ' Con los parametros dados conseguimos el precio fijo de un servicio. Especial para dingus.
            ' Va a leer a las tablas precios_fijo_cliente y precios_fijo_hotel
            ' Javier Nuñez
            ' Marzo 2012
            '***************************************************************************************************************************

            Dim sql As String = "Select precio FROM precios_fijo_cliente WHERE hotel_id = ? AND cliente_id= ? AND servicio_id = ? AND uc_id = ? AND ? BETWEEN desde AND hasta "
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim fechaParam As New MySqlParameter("@fecha", fecha)
            Dim cliente_idParam As New MySqlParameter("@cliente_id", cliente_id)
            Dim servicio_idParam As New MySqlParameter("@servicio_id", servicio_id)
            Dim uc_idParam As New MySqlParameter("@uc_id", uc_id)
            Dim precio As Object

            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(cliente_idParam)
            cmd.Parameters.Add(servicio_idParam)
            cmd.Parameters.Add(uc_idParam)
            cmd.Parameters.Add(fechaParam)

            precio = ExecuteScalar(cmd, sql)
            If IsDBNull(precio) Then
                sql = "Select precio FROM precios_fijo_hotel Where hotel_id = ? AND servicio_id = ? AND uc_id = ? AND ? BETWEEN desde AND hasta "
                cmd.Parameters.Clear()
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(servicio_idParam)
                cmd.Parameters.Add(uc_idParam)
                cmd.Parameters.Add(fechaParam)
                precio = ExecuteScalar(cmd, sql)
            End If
            If IsNumeric(precio) Then
                Return precio
            Else
                Return 0
            End If

        End Function
        '--------------------------------------------------------------------------------------------------------
        ' JULIO 2012 GARRA JAVIER
        ' Rutina ObtienePaxDingus Devuelve la Pax que indica el paxType y paxno 
        ' Sabemos paxno que nos dice el nº de individuo dentro de los de su clase
        ' Asi si paxno=2 y PaxType="Dingus.PaxType.CHD quiere decir que estamos ante el segundo de tipo Niño 
        ' no el segundo huesped
        '---------------------------------------------------------------------------------------------------------
        Private Function ObtienePaxDingus(ByVal pax As Dingus.Pax(), ByVal paxType As Dingus.PaxType, ByVal paxno As Integer) As Dingus.Pax
            Dim x As Integer
            Dim encontrado As Integer = 0
            For x = 0 To pax.Length - 1
                If pax(x).PaxType = paxType Then
                    encontrado += 1
                    If encontrado = paxno Then  'Este es el pax que toca
                        Return pax(x)
                    End If
                End If
            Next
            Return pax(0)  ' No he encontrado al individuo lo cual es muy siniestro devuelvo el primero que horror
        End Function

        Private Function getDingusCamasExtras(ByVal reserva_Dingus As Dingus.BookingRS) As Integer
            Dim x As Integer
            Dim lineaprecios() As Dingus.Price = reserva_Dingus.PriceDetails
            For x = 0 To lineaprecios.Length - 1
                If lineaprecios(x).Code = "cama extra" Then
                    Return 1
                End If
            Next
            Return 0
        End Function

        Private Function busca_ttoo(ByVal cmd As MySqlCommand, ByVal res As MetaReserva) As Integer
            Dim hotel_idParam As New MySqlParameter("@hotel_id", res.hotel_id)
            Dim agencia_idParam As New MySqlParameter("@agencia_id", res.cliente_id)
            Dim fechaParam As New MySqlParameter("@fecha", res.fecha_prevista_llegada)
            Dim contrato_clienteParam As New MySqlParameter("@numero_contrato_cliente", res.contract_id)
            Try
                ' -------------------------------------------------------------------------------------------------------
                ' Primero compruebo que el cliente es una agencia. Si es ttoo entonces paso de lo que diga contract_id
                '--------------------------------------------------------------------------------------------------------
                Dim sql As String = "SELECT grupo_cliente_id FROM clientes WHERE cliente_id = ?"
                cmd.Parameters.Clear()
                cmd.Parameters.Add(agencia_idParam)
                Dim tipo_cliente As Integer = ExecuteScalar(cmd, sql, True)
                If tipo_cliente <> 1 Then ' Si no es agencia paso de todo porque se ha recibido algo chungo
                    Return res.cliente_id
                End If
                '----------------------------------------------------------------------
                ' Ahora busco el ttoo cuyo numero_contato_cliente sea = contract_id
                '----------------------------------------------------------------------
                Dim sql_busca_ttoo As String = "SELECT contratos.cliente_id " _
                & "FROM clientes Inner Join contratos ON contratos.cliente_id = clientes.cliente_id " _
                & "WHERE clientes.agencia_id = ? AND contratos.hotel_id = ? AND ? BETWEEN contratos.fecha_desde AND contratos.fecha_hasta AND " _
                & "contratos.contrato_id_siguiente IS NULL AND " _
                & "contratos.numero_contrato_cliente = ?"
                cmd.Parameters.Clear()
                cmd.Parameters.Add(agencia_idParam)
                cmd.Parameters.Add(hotel_idParam)
                cmd.Parameters.Add(fechaParam)
                cmd.Parameters.Add(contrato_clienteParam)
                Dim result = ExecuteScalar(cmd, sql_busca_ttoo, True)
                If IsDBNull(result) Then
                    Return 0
                End If
                Return result
            Catch ex As Exception    ' Si se produce un error de programa devulevo lo que habia por si las flys
                Return res.cliente_id
            End Try
        End Function


        Private Function cuantos(ByVal cadena As String, ByVal caracter As String) As Integer
            ' Cuenta nº de veces que aparece caracter dentro de cadena
            Dim i As Integer
            Dim num As Integer = 0
            For i = 1 To Len(cadena)
                If Mid(cadena, i, 1) = caracter Then num = num + 1
            Next
            Return num
        End Function
        Private Sub cargaExtrasdeComentariosDingus(ByVal reserva As Dingus.BookingRS)


            Dim observaciones As String = ""
            Dim i As Integer
            For i = 0 To reserva.BookingData.Length - 1
                'If reserva.BookingData(i).Code = "HABCOMMENTS" Then                  ' Desecho HANCOMMENTS porque ahí no viene lo que busco
                'observaciones &= maxString(reserva.BookingData(i).Value.Trim, 300, "")
                'End If
                If reserva.BookingData(i).Code = "COMMENTS" Then  ' Los trolley y Baby chair vienen dentro de COMMENTS 
                    observaciones &= maxString(reserva.BookingData(i).Value.Trim, 300, "Comentarios Cliente:")
                End If
            Next
            ' Aqui tengo los dos campos de Observaciones cojonudos
            ' Empiezo a filtrar que contenga lo de baby Chair
            Dim strBusqueda As String = "TROLLEY"
            Dim pos = observaciones.IndexOf(strBusqueda)
            If pos <> -1 Then ' Encontrado
                ReDim Preserve reserva.Extras(reserva.Extras.Length)    'Redimensiona el array con un elemento nuevo
                Dim Extra As New Dingus.Extra
                Dim frase As String = Trim(observaciones)
                frase = Mid(frase, pos + 1, 19)
                Dim turron As String = frase.Split(" ")(2)              'Busco y separo el siguiente espacio en blanco con lo que me quedo con "NNJJ"
                Dim cantidad As Integer = cuantos(turron, "J")          'Cuento las J que me darán la cantidad de trolleys
                Extra.ExtraCode = "TRO"
                Extra.ExtraQuantity = cantidad
                Extra.DateFrom = reserva.DateFrom
                Extra.DateTo = reserva.DateTo
                Extra.NoPax = 1
                reserva.Extras(reserva.Extras.Length - 1) = Extra
            End If
            strBusqueda = "BABY CHAIR"
            pos = observaciones.IndexOf(strBusqueda)
            If pos <> -1 Then ' Encontrado
                ReDim Preserve reserva.Extras(reserva.Extras.Length)    'Redimensiona el array con un elemento nuevo
                Dim Extra As New Dingus.Extra
                Dim frase As String = Trim(observaciones)
                frase = Mid(frase, pos + 1, 19)
                Dim turron As String = frase.Split(" ")(3)              'Busco y separo el siguiente espacio en blanco con lo que me quedo con "NNJJ"
                Dim cantidad As Integer = cuantos(turron, "J")          'Cuento las J que me darán la cantidad de Sillitas
                Extra.ExtraCode = "CHAIR"
                Extra.ExtraQuantity = cantidad
                Extra.DateFrom = reserva.DateFrom
                Extra.DateTo = reserva.DateTo
                Extra.NoPax = 1
                reserva.Extras(reserva.Extras.Length - 1) = Extra
            End If
            strBusqueda = "SAILOR"
            pos = observaciones.IndexOf(strBusqueda)
            If pos <> -1 Then ' Encontrado
                ReDim Preserve reserva.Extras(reserva.Extras.Length)    'Redimensiona el array con un elemento nuevo
                Dim Extra As New Dingus.Extra
                'SAILOR SUITE cantidad es siempre 1
                Dim cantidad As Integer = reserva.Paxes.Length
                Extra.ExtraCode = "SAILOR"
                Extra.ExtraQuantity = 1
                If reserva.CustomerCode = 4390 Then ' El caso del Hotel Beds internacional es por pax GRRRR el resto por Bungalow
                    Extra.ExtraQuantity = cantidad
                End If
                Extra.DateFrom = reserva.DateFrom
                Extra.DateTo = reserva.DateTo
                Extra.NoPax = 1
                reserva.Extras(reserva.Extras.Length - 1) = Extra
            End If

        End Sub
        Public Function conformaFactura(ByVal factura_id As Integer) As Boolean
            Dim retVal As Boolean = True
            Dim cmd As MySqlCommand = prepareConection()
            retVal = conformaFactura(cmd, factura_id)
            If retVal Then
                flushConection(cmd, 0)
            Else
                flushConection(cmd, 1)
            End If
            Return retVal
        End Function
        Private Function conformaFactura(ByVal cmd As MySqlCommand, ByVal factura_id As Integer) As Boolean
            Dim retVal As Boolean = True
            Dim sql As String = "Select conforme FROM facturas WHERE factura_id =?"
            Dim factura_idParam As New MySqlParameter("@factura_id", factura_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(factura_idParam)
            Dim conforme As Object = ExecuteScalar(cmd, sql)
            If IsDBNull(conforme) Then ' Conformamos
                sql = "UPDATE facturas SET conforme=now() WHERE factura_id = ?"
            Else
                sql = "UPDATE facturas SET conforme=NULL WHERE factura_id = ?"
            End If
            ExecuteNonQuery(cmd, sql)
            Return retVal
        End Function
        Function EsCCValido(sTarjeta As String) As Boolean
            Dim iPeso As Integer
            Dim iDigito As Integer
            Dim iSuma As Integer
            Dim iContador As Integer
            Dim sNuevaTarjeta As String = ""
            Dim cCaracter As String

            iPeso = 0
            iDigito = 0
            iSuma = 0

            'Reemplazar cualquier no digito por una cadena vacía
            For iContador = 1 To Len(sTarjeta)
                cCaracter = Mid(sTarjeta, iContador, 1)
                If IsNumeric(cCaracter) Then
                    sNuevaTarjeta = sNuevaTarjeta & cCaracter
                End If
            Next iContador

            ' Si es 0 devolver Falso
            If sNuevaTarjeta = 0 Then
                EsCCValido = False
                Exit Function
            End If

            ' Si el número de dígitos es par el primer peso es 2, de lo
            ' contrario es 1
            If (Len(sNuevaTarjeta) Mod 2) = 0 Then
                iPeso = 2
            Else
                iPeso = 1
            End If

            For iContador = 1 To Len(sNuevaTarjeta)
                iDigito = Mid(sNuevaTarjeta, iContador, 1) * iPeso
                If iDigito > 9 Then iDigito = iDigito - 9
                iSuma = iSuma + iDigito
                ' Cambiar peso para el siguiente dígito
                If iPeso = 2 Then
                    iPeso = 1
                Else
                    iPeso = 2
                End If
            Next iContador

            ' Devolver verdadero si la suma es divisible por 10
            If (iSuma Mod 10) = 0 Then
                EsCCValido = True
            Else
                EsCCValido = False
            End If

        End Function
        Public Function enviarEmailCreacionReserva(ByVal reserva_id As Integer) As Integer
            Dim cmd As MySqlCommand = prepareConection()
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            Try
                cmd.Parameters.Clear()
                cmd.Parameters.Add(reserva_idParam)
                Dim email As Object = ExecuteScalar(cmd, "Select email From reservas Where reserva_id = ?")
                flushConection(cmd, 0)
                If Not IsDBNull(email) Then
                    EnviarEmailInternoCheckinonline(1, reserva_id)
                End If
            Catch ex As Exception
                flushConection(cmd, 0)
            End Try
            Return 1
        End Function
        Public Function Comprueba_tarjeta(ByVal reserva_id As Integer) As String
            Dim retorno_valor As String = ""
            Dim cmd As MySqlCommand = prepareConection()
            Dim sql As String = "SELECT reserva_dingus_tipo,tarjeta_credito,cod_seguridad,caducidad FROM reservas WHERE reserva_id =?"
            Dim reserva_idParam As New MySqlParameter("@reserva_id", reserva_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Try
                Dim reader As DataTableReader = getDataTable(cmd, sql)
                While reader.Read
                    If reader.Item("reserva_dingus_tipo") <> 1 Then  ' No necesita tarjeta de credito
                        flushConection(cmd, 0)
                        Return retorno_valor
                    End If
                    If IsDBNull(reader.Item("tarjeta_credito")) Then ' Si no hay tarjeta entonces lo consideramos error
                        flushConection(cmd, 0)
                        retorno_valor = "ATENCION Reserva " & reserva_id & " No tiene tarjeta de credito"
                        Return retorno_valor
                    End If
                    If IsDBNull(reader.Item("cod_seguridad")) Then
                        flushConection(cmd, 0)
                        retorno_valor = "ATENCION tarjeta de credito de Reserva " & reserva_id & " No tiene codigo de seguridad"
                        Return retorno_valor
                    End If
                    If IsDBNull(reader.Item("caducidad")) Then
                        flushConection(cmd, 0)
                        retorno_valor = "ATENCION tarjeta de credito de Reserva " & reserva_id & " No tiene fecha de caducidad"
                        Return retorno_valor
                    End If
                    Try
                        If Not EsCCValido(reader.Item("tarjeta_credito")) Then
                            flushConection(cmd, 0)
                            retorno_valor = "ATENCION tarjeta de credito de Reserva " & reserva_id & " NO VALIDA"
                            Return retorno_valor
                        End If
                    Catch ex As Exception
                        flushConection(cmd, 0)
                        retorno_valor = "ATENCION tarjeta de credito de Reserva " & reserva_id & " NO VALIDA"
                        Return retorno_valor
                    End Try

                End While
            Catch ex As Exception

            End Try
            flushConection(cmd, 0)
            Return retorno_valor
        End Function
        Sub carga_xml_de_reserva(ByVal reserva_id As Integer)
            ' --------------------------------------------------------------------------------------------------
            ' Rutina que coge el xml de una reserva de dingus, la mete en una variable Metareserva
            ' Y la manda procesar para ver como se comporta una simulación de la carga de esa reserva.
            ' Muy util para depurar la ejecucion de importar_reservas_dingus
            ' Enero 2014
            ' Tano y Javier
            ' --------------------------------------------------------------------------------------------------
            Dim meta As New MetaReserva
            Dim cmd As MySqlCommand
            cmd = prepareConection()
            Dim ds As DataSet = preparaDatasetReserva(cmd, reserva_id)
            Dim xml = ds.Tables("reserva").Rows(0).Item("reserva_dingus")
            Dim serializer As New XmlSerializer(GetType(Dingus.BookingRS))
            Dim datos As String = ds.Tables("reserva").Rows(0)("reserva_dingus")
            Dim stream As System.IO.MemoryStream = New System.IO.MemoryStream(System.Text.Encoding.UTF8.GetBytes(datos))
            Dim reserva_dingus As Dingus.BookingRS = serializer.Deserialize(stream)
            meta.reserva_Dingus = reserva_dingus
            'x.obtieneServiciosReserva(115286)
            obtieneServiciosReserva(meta, False)
            flushConection(cmd, 0)
        End Sub
        Private Function loadPageRemote(ByVal url As String) As Boolean
            Dim dt As Date = Now

            If (1 = 1) Then
                Dim objResponse As Net.WebResponse
                Dim objRequest As Net.WebRequest = System.Net.HttpWebRequest.Create(url)
                objResponse = objRequest.GetResponse()
                Dim sr As IO.StreamReader = New IO.StreamReader(objResponse.GetResponseStream())
                sr.ReadToEnd()
                sr.Close()
            End If
            Dim xxl As TimeSpan = (Now - dt)
            If xxl.TotalSeconds > 20 Then
                Console.WriteLine(url)
            End If
            Console.WriteLine("dt:" & (xxl.TotalMilliseconds))
            Return True
        End Function
        Sub importaFotosHotel(hotel_id As Integer, numero As Integer)
            'abro conexion
            Dim dt As Date = Now
            Dim cmd As MySqlCommand = prepareConection()
            Dim sql As String = "SELECT DISTINCT clientes.foto1,clientes.foto2 FROM reservas INNER JOIN reservas_huespedes ON reservas.reserva_id = reservas_huespedes.reserva_id INNER JOIN clientes ON reservas_huespedes.cliente_id = clientes.cliente_id WHERE reservas.hotel_id = ? and (not clientes.foto1 is null or not clientes.foto1 is null)"
            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            Try
                Dim reader As DataTableReader = getDataTable(cmd, sql)
                While numero > 0 And reader.Read
                    If Not reader.IsDBNull(0) Then
                        loadPageRemote("http://srvgeshotel/geshotel2/" & reader.Item(0) & "&v=1")
                        numero = numero - 1
                    End If
                    If Not reader.IsDBNull(1) Then
                        loadPageRemote("http://srvgeshotel/geshotel2/" & reader.Item(1) & "&v=1")
                        numero = numero - 1
                    End If
                End While
            Catch ex As Exception
                Console.WriteLine(ex.Message)

            End Try
            'cierro conexion
            flushConection(cmd, 0)
            Dim xxl As TimeSpan = (Now - dt)
            Console.WriteLine("total:" & (xxl.ToString))
        End Sub
        Public Sub carga_notificaciones_telegram(ByVal hotel_id As Integer, ByVal tipo_mensaje_id As Integer, ByVal mensaje As String)
            Dim cmd As MySqlCommand
            cmd = prepareConection()
            carga_notificaciones_telegram(cmd, hotel_id, tipo_mensaje_id, mensaje)
            flushConection(cmd, 0)

        End Sub
        Private Sub carga_notificaciones_telegram(ByVal cmd As MySqlCommand, ByVal hotel_id As Integer, ByVal tipo_mensaje_id As Integer, ByVal mensaje As String)

            ' Primero compruebo que no haya ningun mensaje del mismo tipo pendiente de enviar o enviado en las últimas 4 horas
            ' Para no repetir posibles mensajes y saturar al receptor
            ' *****************************************************************************************************************************
            Dim sql As String = "SELECT COUNT(*) FROM notificaciones_telegram WHERE hotel_id=? AND tipo_id=? AND (estado_id=1 OR DATE_ADD(fecha_hora,INTERVAL 1 hour)>now())"

            Dim hotel_idParam As New MySqlParameter("@hotel_id", hotel_id)
            Dim tipo_mensaje_idParam As New MySqlParameter("@tipo_mensaje_id", tipo_mensaje_id)
            Dim mensajeParam As New MySqlParameter("@mensaje", mensaje)
            Dim contactoParam As New MySqlParameter("@mensaje", "")
            cmd.Parameters.Clear()
            cmd.Parameters.Add(hotel_idParam)
            cmd.Parameters.Add(tipo_mensaje_idParam)

            Try
                Dim contador = ExecuteScalar(cmd, sql)
                'If contador > 0 Then Return ' Si ya ha habido otra notificacion entonces ya no mando mas
                sql = "SELECT contacto FROM telegram_contactos WHERE hotel_id =? AND tipo_telegram_id=?"
                Dim reader As DataTableReader = getDataTable(cmd, sql)
                Dim sql_insert As String = "INSERT INTO notificaciones_telegram (estado_id,fecha_hora,contacto,mensaje,hotel_id,tipo_id) VALUES(1,CURRENT_TIMESTAMP(),?,?,?,?)"
                While reader.Read  ' Para cada contacto, inserto un registro en la tabla notificaciones_telegram
                    contactoParam.Value = reader.Item("contacto")
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(contactoParam)
                    cmd.Parameters.Add(mensajeParam)
                    cmd.Parameters.Add(hotel_idParam)
                    cmd.Parameters.Add(tipo_mensaje_idParam)
                    Dim x = ExecuteNonQuery(cmd, sql_insert)
                End While
            Catch

            End Try

        End Sub
        Public Function comprueba_overbooking(ByVal reserva_id As Integer) As Boolean
            Dim cmd As MySqlCommand
            cmd = prepareConection()
            comprueba_overbooking(cmd, reserva_id)
            flushConection(cmd, 0)
            Return True
        End Function
        Private Function comprueba_overbooking(ByVal cmd As MySqlCommand, ByVal reserva_id As Integer) As Boolean
            Dim sql As String = "SELECT reservas.hotel_id,reservas.fecha_prevista_llegada,reservas.fecha_prevista_salida, " _
            & "reservas_tipo_habitacion.servicio_id, tipos_habitacion_hotel.tipo_habitacion_id, reservas_tipo_habitacion.tipo_habitacion " _
            & "FROM reservas " _
            & "INNER JOIN reservas_tipo_habitacion ON reservas.reserva_id = reservas_tipo_habitacion.reserva_id " _
            & "INNER JOIN tipos_habitacion_hotel ON reservas.hotel_id = tipos_habitacion_hotel.hotel_id AND reservas_tipo_habitacion.servicio_id = tipos_habitacion_hotel.servicio_id " _
            & "WHERE reservas.reserva_id = ? "
            Dim reserva_idParam As New MySqlParameter("reserva_id", reserva_id)
            cmd.Parameters.Clear()
            cmd.Parameters.Add(reserva_idParam)
            Dim mensaje As String = ""
            Dim tipo_mensaje_id As Integer = 1
            Dim salto_linea = "a3f4g52"  ' Como telegram no gestiona el salto de linea con crlf o lf me creo un salto de linea raro para luego leerlo en la shell linux y separar lineas

            Try
                Dim Reader As DataTableReader = getDataTable(cmd, sql)
                While Reader.Read
                    Dim fecha As Date = Reader.Item("fecha_prevista_llegada")
                    Dim servicio_idParam As New MySqlParameter("reserva_id", Reader.Item("servicio_id"))
                    Dim servicio_idParam1 As New MySqlParameter("reserva_id", Reader.Item("servicio_id"))
                    Dim hotel_idParam As New MySqlParameter("reserva_id", Reader.Item("hotel_id"))
                    Dim tipo_habitacion_idParam As New MySqlParameter("reserva_id", Reader.Item("tipo_habitacion_id"))
                    Dim tipo_habitacion_idParam1 As New MySqlParameter("reserva_id", Reader.Item("tipo_habitacion_id"))
                    ' Miro cuantas habitaciones de ese tipo hay en el hotel
                    If IsDBNull(tipo_habitacion_idParam.Value) Then ' No hay habitacion paso de todo
                        Return True
                    End If
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(hotel_idParam)
                    Dim limite = ExecuteScalar(cmd, "SELECT overbooking_limit FROM hoteles WHERE hotel_id=?")
                    Dim hotel = ExecuteScalar(cmd, "SELECT hotel FROM hoteles WHERE hotel_id=?")
                    If IsDBNull(limite) Then
                        limite = 90
                    End If
                    cmd.Parameters.Clear()
                    cmd.Parameters.Add(hotel_idParam)
                    cmd.Parameters.Add(tipo_habitacion_idParam)
                    Dim total_habitaciones As Integer = ExecuteScalar(cmd, "SELECT COUNT(*) FROM habitaciones WHERE hotel_id = ? AND tipo_habitacion_id = ?")
                    sql = "SELECT SUM(cantidad) FROM reservas " _
                    & "INNER JOIN reservas_servicios ON reservas_servicios.reserva_id = reservas.reserva_id " _
                    & "INNER JOIN servicios ON reservas_servicios.servicio_id = servicios.servicio_id " _
                    & "LEFT JOIN habitaciones_bloqueos ON reservas.reserva_id = habitaciones_bloqueos.reserva_id " _
                    & "LEFT JOIN habitaciones ON habitaciones_bloqueos.habitacion_id = habitaciones.habitacion_id " _
                    & "WHERE reservas.hotel_id = ? AND reservas.estado_reserva_id<>2  AND " _
                    & "reservas.reserva_id <> ? AND " _
                    & "? BETWEEN fecha_prevista_llegada AND fecha_prevista_salida AND " _
                    & "reservas.fecha_prevista_salida <> ? AND " _
                    & "(" _
                    & "(reservas_servicios.servicio_id = ? And (habitaciones.tipo_habitacion_id = ? Or habitaciones.tipo_habitacion_id Is NULL)) " _
                    & "OR (reservas_servicios.servicio_id<>? AND habitaciones.tipo_habitacion_id = ? AND servicios.concepto_acelerador_reservas_id=1)" _
                    & ")"
                    While fecha < Reader.Item("fecha_prevista_salida")
                        Dim fechaParam As New MySqlParameter("@fecha_llegada", fecha)
                        Dim fechaParam1 As New MySqlParameter("@fecha_salida", fecha)
                        cmd.Parameters.Clear()

                        cmd.Parameters.Add(hotel_idParam)
                        cmd.Parameters.Add(reserva_idParam)
                        cmd.Parameters.Add(fechaParam)
                        cmd.Parameters.Add(fechaParam1)
                        cmd.Parameters.Add(servicio_idParam)
                        cmd.Parameters.Add(tipo_habitacion_idParam)
                        cmd.Parameters.Add(servicio_idParam1)
                        cmd.Parameters.Add(tipo_habitacion_idParam1)
                        Dim habitaciones_ocupadas = ExecuteScalar(cmd, sql)
                        If Not IsDBNull(habitaciones_ocupadas) Then
                            habitaciones_ocupadas += 1 ' le sumo la reserva en cuestion
                            Dim porc_ocupacion As Double = Math.Round((habitaciones_ocupadas * 100) / total_habitaciones, 1, MidpointRounding.AwayFromZero)
                            If porc_ocupacion >= limite Then
                                If mensaje = "" Then
                                    mensaje = "Atención posible Overbookin " & salto_linea & hotel & salto_linea & Reader.Item("tipo_habitacion")
                                End If
                                mensaje &= salto_linea & "Dia " & fecha & " Hab Ocupadas " & habitaciones_ocupadas & " de " & total_habitaciones
                            End If
                        End If
                        fecha = DateAdd(DateInterval.Day, 1, fecha)
                    End While
                    If mensaje <> "" Then
                        ' enviar notificación
                        carga_notificaciones_telegram(cmd, hotel_idParam.Value, tipo_mensaje_id, mensaje)
                    End If
                End While
            Catch ex As Exception
                Return False
            End Try
            Return True
        End Function

    End Class
End Namespace